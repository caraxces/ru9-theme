<style>
  /* New styles for header layout */
  @keyframes bundle-spin {
    to { transform: rotate(360deg); }
  }
  .add-item-btn .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(0,0,0,0.2);
    border-radius: 50%;
    border-top-color: #1C2C58;
    animation: bundle-spin 1s ease-in-out infinite;
  }
  .add-item-btn.is-loading {
    pointer-events: none;
  }
  .pb-block {
    border: 1px solid #E0E0E0;
    border-radius: 5px;
    overflow: hidden;
  }
  p.bundle-title {
    background: #F5F9FF;
    padding: 18px 15px;
    margin: 0;
    position: relative;
    min-height: 24px;
  }

  .product-bundle-list {
    --color-base-text: #1b2a57;
  }

  .product-bundle-list:not(.flickity-enabled) {
    display: flex;
    overflow: hidden;
  }

  .product-bundle-list .flickity-prev-next-button {
    width: 36px;
    height: 36px;
    top: -45px;
    transform: none;
  }

  .product-bundle-list .flickity-button:disabled {
    display: none;
  }

  .product-bundle-list .flickity-previous {
    left: 350px;
    right: 59px; /* 15px margin + 36px button + 8px gap */
  }

  .product-bundle-list .flickity-next {
    right: 15px;
    background: #234085;
  }

  .bundled_product {
    width: 100%;
    margin-right: 10px;
  }

  .bundled_product .bundled_product_images {
    aspect-ratio: 1 / 1;
  }

  .hidden-label {
    display: none;
  }

  .bundled_product {
    display: grid;
    width: 100%;
    grid-template-columns: 200px 1fr;
    grid-column-gap: 20px;
    padding: 16px;
  }
  .bundled_item_images_col {
    grid-row: 1 / 4;
  }
  .bundled_product_info_wrapper {
    align-self: start;
  }
  .variants {
    align-self: center;
  }
  .action_block {
    align-self: end;
  }

  .bundled_product .variant-input-wrap .variant__button-label {
    margin-bottom: 0;
  }

  .bundled_product-item .price__container {
    display: flex;
    align-items: center;
    column-gap: calc(var(--grid-desktop-vertical-spacing) * 0.5);
  }

  .bundled_product-item .price {
    margin-bottom: calc(var(--grid-desktop-horizontal-spacing) * 0.5);
  }

  .bundled_product_title {
    margin-bottom: calc(var(--grid-desktop-horizontal-spacing) * 1 / 6);
  }

  .bundled_product-item .price--on-sale .price__container .price__regular {
    display: none;
  }

  .bundled_product-item .variants .size-dropdown {
    font-size: 16px;
    padding: 4px 5px 4px 0;
    border-radius: calc(var(--buttonRadius) * 0.5);
    background: #F5F5F5;
    border-color: #d1d5db;
    width: 100%;
    height: 41px;
    flex-shrink: 0;
    color: #000;
    font-family: "Be Vietnam Pro", sans-serif;
    font-style: normal;
    font-weight: 400;
    line-height: 150%;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='17' height='9' viewBox='0 0 17 9' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2 1.5L8.5 7.5L15 1.5' stroke='black' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 20px center;
    padding-left: 20px;
  }

  @media (min-width: 95rem) and (max-width: 1440px) {
    .bundled_product-item .variants .size-dropdown {
      width: 100%;
    }
  }

  .bundled_product-item .variants .color_title {
    display: none;
  }

  .bundled_item_details_col {
    justify-content: space-between;
    position: relative;
  }

  .bundled_product .price--on-sale .price-item.price-item--regular {
    margin: 0;
  }

  .bundled_product-item .price__container .price-item--sale {
    display: none;
  }

  .bundled_product-item .price--on-sale .price__container .price-item--sale {
    display: inline-block;
  }

  .bundled_product-item .price__container .price-item--sale,
  .bundled_product .price__regular .price-item.price-item--regular {
    color: #1C2C58;
    font-weight: 400;
  }
  .bundled_product .price-item.price-item--sale.price-item--last {
    font-size: 18px;
  }
  .bundled_product .price--on-sale .price-item--regular {
    font-size: 16px;
  }

  .bundled_product .price__sale .price-item.price-item--regular {
    color: #888;
    font-size: 18px;
  }

  .bundled_product_images img {
    object-fit: cover;

    object-position: top;

    height: 100%;

    border-radius: 8px;
  }

  .bundled_product_title_inner a {
    text-decoration: none;
    font-weight: normal;
    color: var(--color-base-accent-1);
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: 27px;
    font-style: normal;
    font-weight: 600;
    line-height: 150%;
  }

  .add-item-btn {
    background: transparent;
    border: none;
    color: #4b5563;
    position: relative;
    transition: all 0.2s ease-in;
    font-size: calc(var(--typeBaseSize) * 0.875);
    padding: 12px 35px;
    border-radius: calc(var(--buttonRadius) * 0.5);
    background: #FCE390;
    font-weight: 600;
    display: flex;
    width: 100%;
    height: 41px;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }

  .action_block  .stock {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    background: white;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #f3f4f6;
    border: 1px solid black;
  }

  .add-item-btn.outstock {
    pointer-events: none;
    opacity: 0.5;
  }

  .bundled_item_col_left {
    flex: 1;
  }

  .bundled_item_col_right {
    margin-top: 12px;
  }

  @media (min-width: 95rem) and (max-width: 1199px) {
    .bundled_product {
      grid-template-columns: 1fr 1fr;
    }
  }

  @media screen and (max-width: 768px) {
      .bundled_product {
          display: flex;
          flex-wrap: wrap;
          grid-template-columns: none; /* Unset grid */
          grid-row: auto;
          grid-column: auto;
          gap: 16px;
          padding: 16px;
      }
      .bundled_item_images_col, .bundled_product_info_wrapper, .variants, .action_block {
        grid-row: auto; /* Unset grid */
        grid-column: auto; /* Unset grid */
      }
      .bundled_item_images_col {
          width: 100px;
          flex-shrink: 0;
      }
      .bundled_product_info_wrapper {
          flex: 1;
          align-self: stretch;
          display: flex;
          flex-direction: column;
      }
      .variants, .action_block {
          flex-basis: 100%;
      }
      .bundled_product_title_inner a {
          color: #1C2C58;
          font-family: "Be Vietnam Pro", sans-serif;
          font-size: 16px;
          font-style: normal;
          font-weight: 500;
          line-height: 150%;
      }
      .bundled_product .price-item--last {
          color: #1C2C58;
          font-family: "Be Vietnam Pro", sans-serif;
          font-size: 16px;
          font-style: normal;
          font-weight: 500;
          line-height: 150%;
      }
      .bundled_product .price--on-sale .price-item--regular {
          color: #888;
          font-family: "Be Vietnam Pro", sans-serif;
          font-size: 14px;
          font-style: normal;
          font-weight: 400;
          line-height: 150%;
          text-decoration-line: line-through;
      }
      .bundled_product .price--on-sale .price__sale {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
      }
  }
  @media screen and (max-width: 480px) {
    .bundled_product {
      padding-bottom: 16px;
    }
    .bundled_item_details_col {
      position: static;
    }
    .bundled_product-item .variants .size-dropdown {
      width: 100%;
    }
    .bundled_item_col_right {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 16px;
    }
  }

  .bundled_item_col_right .price {
    margin-right: 8px;
  }

  .bundled_product .variant-wrapper + .variant-wrapper {
    margin-top: 0;
  }

  .variant-input {
    display: inline-block;
    margin: 0 5px;
  }
  .is-color .variant-input {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
  }

  .variants {
    display: flex;
    flex-direction: column;
    gap: calc(var(--grid-desktop-horizontal-spacing) * 0.5);
  }

  .bundled_product .is-color .variant-input-wrap .variant__button-label {
    padding: 2px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid #ddd;
    display: block;
    cursor: pointer;
    text-indent: -9999px;
    overflow: hidden;
  }

  .bundled_product .is-color .variant-input-wrap .variant__button-label::before {
    content: '';
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: var(--color-swatch-fallback);
    background-image: var(--color-swatch-image);
    background-size: cover;
    background-position: center;
  }

  .variant-input-wrap input:checked + .variant__button-label.color-swatch {
    border-color: #1C2C58;
    border-width: 2px;
    padding: 1px;
  }


  .template-product
    .page-content--product
    .product-single__meta
    .product-block
    .product-bundle-list
    .variant-wrapper
    .variant-input-wrap
    .variant-input {
    margin: 0;

    display: inherit;
  }

  .template-product
    .page-content--product
    .product-single__meta
    .product-block
    .product-bundle-list
    .variant-wrapper.js {
    order: 1;
  }

  fieldset.variant-input-wrap {
    display: flex;

    border: 0;

    padding: 0;

    margin: 0;

    position: relative;

    /* grid-template-columns: 40px 1fr; */

    flex-wrap: wrap;

    grid-gap: 5px 10px;
  }

  .variant-input-wrap input {
    clip: rect(0, 0, 0, 0);

    overflow: hidden;

    position: absolute;

    height: 1px;

    width: 1px;
  }

  .variant-wrapper--dropdown {
    order: -1;
  }

  .variant-wrapper--dropdown select {
    border: none;

    -webkit-appearance: none;

    -moz-appearance: none;

    appearance: none;

    font-size: clamp(1.2rem, 1.2vw, 2rem);

    color: rgba(var(--color-base-text), 0.5);
  }

  .add-item-btn.added {
    background: var(--colorBtnSecondary);
    color: var(--colorBtnSecondaryText);
    box-shadow: rgba(99, 99, 99, 0.5) 6px 6px 8px 0px;
  }

  .bundled_item_col_right .price--on-sale .price__sale {
    flex-direction: column-reverse;
    display: flex;
  }

  .bundle-title .badge {
    font-weight: 500;
    padding: 2px 8px 3px;
    margin-left: calc(var(--grid-desktop-vertical-spacing) * 0.5);
  }

  @media (max-width: 749px) {
    .bundled_product_title {
      margin-top: 0;
      margin-bottom: 0;
    }

    .bundled_item_col_right .price__container {
      margin: 0;
    }

    .bundled_product .price {
      text-align: left;
    }

    .template-product
      .page-content--product
      .product-single__meta
      .product-block
      .product-bundle-list
      .variant-wrapper
      .variant-input-wrap
      label.color_title {
      margin: 0;
    }

    .product-bundle-list::-webkit-scrollbar-thumb {
      background-color: transparent;

      display: none;

      outline: 0 solid transparent;
    }
  }
</style>
    <div class="pb-block">
{% assign pr_size = 0 %}
{% for pro in bundleProduct %}
  {% assign pr_size = pr_size | plus: 1 %}
{% endfor %}
{% if pr_size > 0 %}
  {%- if title != blank or label_sale != blank -%}
    <p class="bundle-title">
        {%- if title != blank -%}
        <span class="f-smb">{{ title }}</span>
      {%- endif -%}
            {%- if label_sale != blank -%}
              <span class="badge">{{ label_sale }}</span>
            {%- endif -%}
          </p>
        {%- endif -%}
  <product-bundle-list id="product-bundle-list" data-block-id="{{ block.id }}" data-section-type="product-bunble-block">
    <div class="product-bundle-list" data-slideshow id="ProductBundle-{{ block.id }}">
      {% for pro in bundleProduct -%}
        {% if pro.available and pro.id != product.id -%}
          <product-bundle
            class="bundled_product-item bundled_product bundled_product_summary product has_qty_input"
            data-id="{{pro.id}}"
          >
            <div class="bundled_item_images_col">
              <a href="{{ pro.url }}" class="bundled_product_images images">
                <img
                  loading="lazy"
                  width="300"
                  height="300"
                  src="{{ pro.media[0].preview_image | img_url: 'large' }}"
                  alt="{{ pro.title }}"
                  title=""
                />
              </a>
            </div>

            <div class="bundled_product_info_wrapper">
              <div class="details">
                <p class="bundled_product_title product_title">
                  <span class="bundled_product_title_inner">
                    <a class="bundled_product_permalink" href="{{ pro.url | within: collection }}" target="_blank">
                      <span class="item_title">{{ pro.title }}</span>
                    </a>
                  </span>
                </p>
              </div>
              {% render 'price', product: pro, price_class: '' %}
            </div>

            <div class="variants">
                          {%- unless pro.has_only_default_variant -%}
                    {%- for option in product.options_with_values -%}
                      {%- liquid
                        assign is_size = false
                        assign size_trigger = 'products.general.size_trigger' | t | downcase
                        assign downcased_option = option.name | downcase

                        if downcased_option contains size_trigger
                          assign is_size = true
                        endif
                      -%}

                      {% if is_size %}
                        {% assign current_size = option.selected_value %}
                      {% endif %}
                    {% endfor -%}
                        {%- for option in pro.options_with_values -%}
                          {%- liquid
                            assign is_color = false
                            assign color_option_index = 0
                            assign swatch_trigger = 'products.general.color_swatch_trigger' | t | downcase
                            assign color_option_index = forloop.index0
                            assign downcased_option = option.name | downcase
                            if downcased_option contains swatch_trigger
                              assign is_color = true
                            elsif swatch_trigger == 'color' and downcased_option contains 'colour'
                              assign is_color = true
                            endif
                          -%}
                      {% if is_color -%}
                        {%- render 'variant--button',
                          block: block,
                          product: pro,
                          form_id: form_id,
                          section_id: section_id,
                          option: option,
                          forloop: forloop,
                          variant_labels: block.settings.variant_labels,
                          is_color: is_color,
                          color_option_index: color_option_index
                        -%}
                      {% else %}
                        {%- render 'variant--dropdown',
                          block: block,
                          product: pro,
                          form_id: form_id,
                          section_id: section_id,
                          option: option,
                          forloop: forloop,
                          variant_labels: block.settings.variant_labels,
                          is_color: is_color,
                          color_option_index: color_option_index,
                          current_size: current_size
                        -%}
                      {% endif -%}
                        {%- endfor -%}
                {%- endunless -%}
                <script type="application/json">
                  {{ pro.variants | json }}
                </script>
              </div>

            <div class="action_block t-center w-full">
              <div class="add-item-btn btn btn--static w-full">
                  {{ 'products.bundle.add_to_cart' | t }}
              </div>
              <span class="stock hidden">{{ 'products.product.sold_out' | t }}</span>
            </div>
          </product-bundle>
        {% endif -%}
      {% endfor %}
    </div>
  </product-bundle-list>
{% endif %}
</div>
<script>
  window.cartBox = [];
  window.cartBoxTotal = 0;
  window.cartBoxTotalItem = 0;
  const currentSize = '{{current_size-}}';
  const currentProduct = '{{product.handle}}';
  class ProductBundleItem extends HTMLElement {
    constructor() {
      super();
      this.discountPrice = 0;
      this.productId = this.getAttribute('data-id');
      this.addEventListener('change', this.onVariantChange);
      this.onVariantChange();
      this.querySelector('.add-item-btn').addEventListener('click', this.addItem.bind(this));
      Array.from(this.querySelectorAll('input[checked]')).forEach((radio) => {
        radio.checked = radio.checked || true;
      });
    }
    addItem() {
      const addButton = this.querySelector('.add-item-btn');
      if (addButton.classList.contains('is-loading')) {
          return;
      }

      const variantId = this.currentVariant.id;
      if (!variantId) {
          console.error('Variant not found for product bundle item');
          return;
      }

      addButton.classList.add('is-loading');
      
      const originalContent = addButton.innerHTML;
      addButton.innerHTML = '<div class="spinner"></div>';

      const formData = {
          'items': [{
              'id': variantId,
              'quantity': 1
          }]
      };

      fetch('/cart/add.js', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
          if (data.status >= 400) {
            throw new Error(data.description || 'Error adding item.');
          }
          addButton.classList.remove('is-loading');
          addButton.classList.add('added');
          addButton.innerHTML = 'Đã thêm ✓';
          
          document.dispatchEvent(new CustomEvent('cart:updated', { bubbles: true, detail: data }));

          setTimeout(() => {
              addButton.classList.remove('added');
              addButton.innerHTML = originalContent;
          }, 2000);
      })
      .catch((error) => {
          console.error('Error adding item to cart:', error);
          addButton.classList.remove('is-loading');
          addButton.innerHTML = 'Lỗi!';
          setTimeout(() => {
              addButton.innerHTML = originalContent;
          }, 2000);
      });
    }
    onVariantChange() {
      this.updateOptions();
      this.updateMasterId();
      this.toggleAddButton(true, '', false);
      if (!this.currentVariant) {
        this.toggleAddButton(true, '', true);
      } else {
        this.toggleAddButton(false, '', true);
        this.renderProductInfo();
      }
    }
    // updateSize(currentSize) {
    //   let sizes = this.querySelectorAll('.size-dropdown');
    //   sizes.forEach((size) => {
    //     let options = size.querySelectorAll('option');
    //     options.forEach((option) => {
    //       if (option && option.value.split('-')[0] == currentSize) {
    //         option.selected = true;
    //         size.value = option.value;
    //         this.onVariantChange();
    //       }
    //     });
    //   });
    // }
    updateOptions() {
      const fieldsets = Array.from(this.querySelectorAll('fieldset'));
      const radioOption = fieldsets.map((fieldset) => {
        if (Array.from(fieldset.querySelectorAll('input')).find((radio) => radio.checked)) {
          return Array.from(fieldset.querySelectorAll('input')).find((radio) => radio.checked).value;
        }
      });
      const selectOption = Array.from(this.querySelectorAll('select'), (select) => select.value);
      this.options = [...selectOption, ...radioOption];
      if (radioOption.length && typeof initGalery == 'function') {
        // initGalery()
      }
    }
    updateMasterId() {
      this.currentVariant = this.getVariantData().find((variant) => {
        return !variant.options
          .map((option, index) => {
          return this.options[index] === option;
          })
          .includes(false);
      });
    }
    getVariantData() {
      this.variantData = this.variantData || JSON.parse(this.querySelector('[type="application/json"]').textContent);
      return this.variantData;
    }
    toggleAddButton(disable = true, text, modifyClass = true) {
      const addButton = this.querySelector('.add-item-btn');
      if (!addButton) return;
      
      if (disable) {
        addButton.setAttribute('disabled', 'disabled');

        // if (text) addButtonText.textContent = text;
      } else {
        addButton.removeAttribute('disabled');

        // addButtonText.textContent = window.variantStrings.addToCart;
      }
      if (!modifyClass) return;
    }
    renderProductInfo() {
      let available = this.currentVariant && this.currentVariant.available;
      if (available == true) {
        this.querySelector('.stock').classList.add('hidden');
        this.querySelector('.add-item-btn').classList.remove('outstock');
      } else {
        this.querySelector('.stock').classList.remove('hidden');
        this.querySelector('.add-item-btn').classList.add('outstock');
      }
      if (!this.currentVariant) return;

      let price = this.currentVariant.price;
      let comparePrice = this.currentVariant.compare_at_price;
       let format = `{{shop.money_format}}`;
      if (this.discount) {
        comparePrice = price;
        if (this.discount.DiscountCodeType == 'percentage') {
          price = price - Math.ceil((price * this.discount.Percentage) / 100);
          } else {
          // price = price -  this.discount
        }
      }
      if (price < comparePrice) {
        this.querySelector('.price').classList.add('price--on-sale');
        this.querySelector('.price-item--regular').innerHTML = window.formatMoney(comparePrice, format);
        this.querySelector('.price__sale .price-item--regular').innerHTML = window.formatMoney(comparePrice, format);
        this.querySelector('.price-item--last').innerHTML = window.formatMoney(price, format);
      } else {
        this.querySelector('.price').classList.remove('price--on-sale');
        this.querySelector('.price-item--regular').innerHTML = window.formatMoney(price, format);
        this.querySelector('.price-item--last').innerHTML = window.formatMoney(price, format);
      }
    }
  }

  customElements.define('product-bundle', ProductBundleItem);

  document.addEventListener('limoniapps:discountninja:promotions:loaded', function (event) {
    let promotions = event.detail.data;
    if (promotions && promotions.length > 0) {
      promotions = promotions.find((promo) => {
        return promo;
      });

      const activePromotion = promotions.find((promo) => {
        return promo.Prerequisite.PrerequisiteProducts == currentProduct;
      });
      if (activePromotion) {
        // activePromotion
        const discountProduct = activePromotion.Entitlement.EntitledProductHandles;
        document.querySelectorAll('product-bundle').forEach(function (pro) {
          if (activePromotion.DiscountCodeType == 'percentage') {
            pro.discount = {
              DiscountCodeType: activePromotion.DiscountCodeType,
              Percentage: activePromotion.Tiers[0].Entitlement.Percentage,
            };
          }
          pro.renderProductInfo();
        });
      }
    }
  });
  function formatMoney(cents, format) {
    if (typeof cents === 'string') {
      cents = cents.replace('.', '');
    }

    let value = '';
    const placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
    const formatString = format || moneyFormat;

    function formatWithDelimiters(number, precision, thousands, decimal) {
      thousands = thousands || ',';
      decimal = decimal || '.';

      if (isNaN(number) || number === null) {
        return 0;
      }

      number = (number / 100.0).toFixed(precision);

      const parts = number.split('.');
      const dollarsAmount = parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + thousands);
      const centsAmount = parts[1] ? decimal + parts[1] : '';

      return dollarsAmount + centsAmount;
    }

    switch (formatString.match(placeholderRegex)[1]) {
      case 'amount':
        value = formatWithDelimiters(cents, 2);
        break;
      case 'amount_no_decimals':
        value = formatWithDelimiters(cents, 0);
        break;
      case 'amount_with_comma_separator':
        value = formatWithDelimiters(cents, 2, '.', ',');
        break;
      case 'amount_no_decimals_with_comma_separator':
        value = formatWithDelimiters(cents, 0, '.', ',');
        break;
      case 'amount_no_decimals_with_space_separator':
        value = formatWithDelimiters(cents, 0, ' ');
        break;
      case 'amount_with_apostrophe_separator':
        value = formatWithDelimiters(cents, 2, "'");
        break;
    }

    return formatString.replace(placeholderRegex, value);
  }
</script>
