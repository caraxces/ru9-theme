<div class="product-bundle-container">
  {%- liquid
    assign pr_size = 0
    for pro in bundleProduct
      assign pr_size = pr_size | plus: 1
    endfor
  -%}
  {%- if pr_size > 0 -%}
    <div class="pb-block">
      <div class="pb-block__header">
        {%- if title != blank -%}
          <p class="pb-block__title">
            <span>{{ title }}</span>
            {%- if label_sale != blank -%}
              <span class="badge">{{ label_sale }}</span>
            {%- endif -%}
          </p>
        {%- endif -%}
        <div class="pb-block__nav">
          <button class="pb-block__nav-button pb-block__nav-button--prev" type="button" aria-label="Previous">
            <svg width="8" height="14" viewBox="0 0 8 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 1L1 7L7 13" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="pb-block__nav-button pb-block__nav-button--next" type="button" aria-label="Next">
            <svg width="8" height="14" viewBox="0 0 8 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 13L7 7L1 1" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>

      <div class="pb-block__slider-wrapper">
        <product-bundle-list
          id="product-bundle-list"
          data-block-id="{{ block.id }}"
          data-section-type="product-bunble-block"
          data-main-form-id="{{ form_id }}"
        >
          <div
            class="pb-block__slider"
            data-slideshow
            id="ProductBundle-{{ block.id }}"
            data-flickity-options='{
              "prevNextButtons": false,
              "pageDots": false,
              "cellAlign": "left",
              "contain": true,
              "wrapAround": true,
              "cellSelector": ".pb-block__slide"
            }'
          >
            {%- for pro in bundleProduct -%}
              {%- if pro.available and pro.id != product.id -%}
                <div class="pb-block__slide">
                  <product-bundle class="pb-card" data-id="{{ pro.id }}" data-url="{{ pro.url }}">
                    <div class="pb-card__image-wrapper">
                      <a href="{{ pro.url }}" title="{{ pro.title }}">
                        <img
                          loading="lazy"
                          width="200"
                          height="200"
                          src="{{ pro.media[0].preview_image | img_url: 'large' }}"
                          alt="{{ pro.title }}"
                        >
                      </a>
                    </div>
                    <div class="pb-card__info">
                      <div>
                        <p class="pb-card__title">
                          <a href="{{ pro.url }}">{{ pro.title }}</a>
                        </p>
                        {%- render 'price', product: pro, price_class: '' -%}
                        <div class="pb-card__variants">
                          {%- unless pro.has_only_default_variant -%}
                            {%- for option in pro.options_with_values -%}
                              {%- liquid
                                assign is_color = false
                                assign swatch_trigger = 'products.general.color_swatch_trigger' | t | downcase
                                assign downcased_option = option.name | downcase
                                if downcased_option contains swatch_trigger
                                  assign is_color = true
                                endif
                              -%}
                              {%- if is_color -%}
                                {%- render 'variant--button', product: pro, option: option, form_id: form_id, is_color: is_color -%}
                              {%- else -%}
                                {%- render 'variant--dropdown', product: pro, option: option, form_id: form_id -%}
                              {%- endif -%}
                            {%- endfor -%}
                          {%- endunless -%}
                          <script type="application/json">
                            {{ pro.variants | json }}
                          </script>
                        </div>
                      </div>
                      <div class="pb-card__actions">
                        <div class="pb-card__quantity">
                          <span class="pb-card__quantity-label">{{ 'products.product.quantity.label' | t }}</span>
                          <quantity-input class="quantity">
                            <button class="quantity__button" name="minus" type="button">
                              <span class="visually-hidden">{{ 'products.product.quantity.decrease' | t: product: pro.title | escape }}</span>
                              <svg xmlns="http://www.w3.org/2000/svg" width="10" height="2" viewBox="0 0 10 2" fill="none"><path d="M0 1H10" stroke="#1C2C58" stroke-width="2"/></svg>
                            </button>
                            <input class="quantity__input" type="number" name="quantity" value="1" min="1" aria-label="{{ 'products.product.quantity.input_label' | t: product: pro.title | escape }}">
                            <button class="quantity__button" name="plus" type="button">
                              <span class="visually-hidden">{{ 'products.product.quantity.increase' | t: product: pro.title | escape }}</span>
                              <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 10 10" fill="none"><path d="M0 5H10M5 0V10" stroke="#1C2C58" stroke-width="2"/></svg>
                            </button>
                          </quantity-input>
                        </div>
                        <button class="pb-card__add-btn add-item-btn">
                          {{ 'products.bundle.add_to_cart' | t }}
                        </button>
                      </div>
                    </div>
                  </product-bundle>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        </product-bundle-list>
      </div>
    </div>
  {%- endif -%}
</div>

<script>
  window.cartBox = window.cartBox || [];
  
  class ProductBundleList extends HTMLElement {
    constructor() {
      super();
      this.slider = this.querySelector('.pb-block__slider');
      this.prevButton = this.closest('.pb-block').querySelector('.pb-block__nav-button--prev');
      this.nextButton = this.closest('.pb-block').querySelector('.pb-block__nav-button--next');
      this.mainFormId = this.dataset.mainFormId;
      this.bundleItemsContainer = document.querySelector(`#${this.mainFormId} #bundle-items-container`);

      // Using an event listener to wait for Flickity to be ready
      this.slider.addEventListener('ready.flickity', () => {
        this.flickity = Flickity.data(this.slider);
        this.bindNavEvents();
      });
      
      this.addEventListener('item:change', this.updateBundleItemsInForm.bind(this));
    }

    bindNavEvents() {
      this.prevButton.addEventListener('click', () => this.flickity.previous());
      this.nextButton.addEventListener('click', () => this.flickity.next());
    }
    
    updateBundleItemsInForm() {
      if (!this.bundleItemsContainer) return;
      
      let inputsHTML = '';
      window.cartBox.forEach(item => {
        inputsHTML += `
          <input type="hidden" name="items[][id]" value="${item.id}">
          <input type="hidden" name="items[][quantity]" value="${item.quantity}">
        `;
      });
      this.bundleItemsContainer.innerHTML = inputsHTML;
    }
  }
  customElements.define('product-bundle-list', ProductBundleList);

  class ProductBundleItem extends HTMLElement {
    constructor() {
      super();
      this.productId = this.getAttribute('data-id');
      this.addEventListener('change', this.onVariantChange.bind(this));
      this.querySelector('.add-item-btn').addEventListener('click', this.addItem.bind(this));
      this.initQuantityButtons();
      this.onVariantChange();
    }

    initQuantityButtons() {
      this.quantityInput = this.querySelector('.quantity__input');
      this.changeEvent = new Event('change', { bubbles: true });

      this.querySelectorAll('.quantity__button').forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault();
          const previousValue = this.quantityInput.value;
          if (button.name === 'plus') {
            this.quantityInput.stepUp();
          } else {
            this.quantityInput.stepDown();
          }
          if (previousValue !== this.quantityInput.value) {
            this.quantityInput.dispatchEvent(this.changeEvent);
          }
        });
      });
    }

    addItem() {
      const addButton = this.querySelector('.add-item-btn');
      const quantity = parseInt(this.quantityInput.value);

      // Remove item if already in cartBox to update it later
      window.cartBox = window.cartBox.filter(item => item.proId !== this.productId);

      if (addButton.classList.contains('added')) {
        addButton.classList.remove('added');
        addButton.textContent = `{{ 'products.bundle.add_to_cart' | t }}`;
      } else {
        if (this.currentVariant && this.currentVariant.available) {
          addButton.classList.add('added');
          addButton.textContent = `{{ 'products.product.added' | t }}`;
          window.cartBox.push({ proId: this.productId, id: this.currentVariant.id, quantity: quantity });
        }
      }
      this.dispatchEvent(new CustomEvent('item:change', { bubbles: true }));
    }

    onVariantChange() {
      this.updateOptions();
      this.updateMasterId();
      this.toggleAddButton(true, '', false);
      this.updatePickupAvailability();

      if (!this.currentVariant) {
        this.toggleAddButton(true, '', true);
        this.setUnavailable();
      } else {
        this.renderProductInfo();
      }
    }

    updateOptions() {
      this.options = Array.from(this.querySelectorAll('select, input[type="radio"]:checked'), (element) => element.value);
    }
    
    updateMasterId() {
      this.currentVariant = this.getVariantData().find((variant) => {
        return !variant.options.map((option, index) => {
          return this.options[index] === option;
        }).includes(false);
      });
    }

    getVariantData() {
      this.variantData = this.variantData || JSON.parse(this.querySelector('[type="application/json"]').textContent);
      return this.variantData;
    }

    toggleAddButton(disable = true, text, modifyClass = true) {
      const addButton = this.querySelector('.add-item-btn');
      if (!addButton) return;
      
      if (disable) {
        addButton.setAttribute('disabled', 'disabled');
      } else {
        addButton.removeAttribute('disabled');
      }
    }

    setUnavailable() {
      const addButton = this.querySelector('.add-item-btn');
      if (addButton) {
        addButton.textContent = window.variantStrings.unavailable;
        addButton.setAttribute('disabled', 'disabled');
      }
      
      const price = this.querySelector('.price');
      if (price) price.classList.add('visibility-hidden');
    }

    renderProductInfo() {
      const priceElement = this.querySelector('.price');
      if (priceElement) priceElement.classList.remove('visibility-hidden');

      fetch(`${this.dataset.url}?variant=${this.currentVariant.id}&section_id={{ section.id }}`)
        .then((response) => response.text())
        .then((responseText) => {
          const id = `price-{{ section.id }}-${this.productId}`;
          const html = new DOMParser().parseFromString(responseText, 'text/html');
          const destination = this.querySelector('.price');
          const source = html.getElementById(id);

          if (source && destination) destination.innerHTML = source.innerHTML;
          
          const addButton = this.querySelector('.add-item-btn');
          const isInCartBox = window.cartBox.some(item => item.id === this.currentVariant.id);

          if (isInCartBox) {
            addButton.classList.add('added');
            addButton.textContent = `{{ 'products.product.added' | t }}`;
          } else {
            addButton.classList.remove('added');
            addButton.textContent = `{{ 'products.bundle.add_to_cart' | t }}`;
          }

          this.toggleAddButton(!this.currentVariant.available, window.variantStrings.soldOut);
        });
    }
     updatePickupAvailability() {
      // Not relevant for this implementation
    }
  }

  customElements.define('product-bundle', ProductBundleItem);
</script>

<style>
  .pb-block {
    border: 1px solid #E0E0E0;
    border-radius: 5px;
    overflow: hidden;
  }

  .pb-block__header {
    background: #F5F9FF;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    height: 55px;
  }

  .pb-block__title {
    margin: 0;
    font-weight: 600;
    font-size: 18px;
    color: #1C2C58;
  }
  
  .pb-block__title .badge {
    font-weight: 500;
    padding: 2px 8px 3px;
    margin-left: 10px;
  }

  .pb-block__nav {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .pb-block__nav-button {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 1px solid #E0E0E0;
    padding: 0;
    cursor: pointer;
    background-color: white;
  }
  
  .pb-block__nav-button--next {
    background-color: #1C2C58;
    border-color: #1C2C58;
  }

  .pb-block__slider-wrapper {
    background: white;
  }

  .pb-block__slide {
    width: 100%;
  }

  .pb-card {
    display: flex;
    padding: 20px;
    gap: 20px;
  }

  .pb-card__image-wrapper {
    width: 251px;
    height: 182px;
    flex-shrink: 0;
    background-color: #F9F9F9;
    border-radius: 5px;
    overflow: hidden;
  }

  .pb-card__image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .pb-card__info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .pb-card__title {
    margin: 0 0 8px 0;
  }
  
  .pb-card__title a {
    text-decoration: none;
    font-size: 20px;
    font-weight: 600;
    color: #1C2C58;
  }
  
  .pb-card .price .price-item {
    font-size: 16px;
  }
  
  .pb-card .price--on-sale .price__regular {
    display: none;
  }
  
  .pb-card__variants {
    margin-top: 15px;
  }

  .pb-card__variants .variant-wrapper--dropdown select {
    width: 100%;
    height: 41px;
    border-radius: 5px;
    background-color: #F5F5F5;
    padding: 4px 15px;
    border: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%231C2C58' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    cursor: pointer;
  }

  .pb-card__actions {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-top: 15px;
  }
  
  .pb-card__quantity {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .pb-card__quantity-label {
    font-size: 14px;
    color: #555;
  }

  .pb-card .quantity {
    display: flex;
    align-items: center;
    border: 1px solid #E0E0E0;
    border-radius: 5px;
  }

  .pb-card .quantity__input {
    width: 30px;
    border: none;
    text-align: center;
    padding: 0;
    background: transparent;
  }
  .pb-card .quantity__input::-webkit-outer-spin-button,
  .pb-card .quantity__input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .pb-card .quantity__input[type=number] {
    -moz-appearance: textfield;
  }

  .pb-card .quantity__button {
    width: 30px;
    height: 40px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .pb-card .variant-wrapper--color .variant-input-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .pb-card .variant-wrapper--color .variant-input {
    margin: 0;
  }

  .pb-card .variant-wrapper--color .color-swatch {
    display: block;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid #E0E0E0;
    padding: 2px;
    text-indent: -9999px;
  }

  .pb-card .variant-wrapper--color .color-swatch::before {
    content: '';
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: var(--color-swatch-fallback);
    background-image: var(--color-swatch-image);
  }

  .pb-card .variant-wrapper--color input:checked + .color-swatch {
    border-color: #1C2C58;
  }

  .pb-card__add-btn {
    flex-grow: 1;
    height: 41px;
    padding: 12px 20px;
    border-radius: 5px;
    background: #FCE390;
    color: #1C2C58;
    border: none;
    font-weight: 600;
    cursor: pointer;
  }
  
  .pb-card__add-btn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .pb-card__add-btn.added {
    background: #1C2C58;
    color: white;
  }
</style>
