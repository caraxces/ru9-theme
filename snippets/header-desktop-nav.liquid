{%- liquid
  unless limit
    assign limit = main_menu.links.size
  endunless
  unless offset
    assign offset = 0
  endunless
-%}

<ul
  class="site-nav site-navigation medium-down--hide"
>
  {%- for link in main_menu.links limit: limit offset: offset -%}
    {%- liquid
      assign active_sale_lv1 = section.settings.active_sale_lv1 | escape | downcase | split: ',' | strip | handle
      assign active_sale_lv2 = section.settings.active_sale_lv2 | escape | downcase | split: ',' | strip | handle
      assign active_sale_lv3 = section.settings.active_sale_lv3 | escape | downcase | split: ',' | strip | handle

      assign select_title_first_lv1 = section.settings.select_title_first_lv1 | escape | downcase | split: ',' | split: ',' | strip | handle
      assign select_title_first_lv2 = section.settings.select_title_first_lv2 | escape | downcase | split: ',' | split: ',' | strip | handle
      assign select_title_first_lv3 = section.settings.select_title_first_lv3 | escape | downcase | split: ','
      assign text_on_label_1 = section.settings.text_on_label_1

      assign select_title_second_lv1 = section.settings.select_title_second_lv1 | escape | downcase | split: ',' | split: ',' | strip | handle
      assign select_title_second_lv2 = section.settings.select_title_second_lv2 | escape | downcase | split: ',' | split: ',' | strip | handle
      assign select_title_second_lv3 = section.settings.select_title_second_lv3 | escape | downcase | split: ','
      assign text_on_label_2 = section.settings.text_on_label_2

      assign select_title_thrid_lv1 = section.settings.select_title_thrid_lv1 | escape | downcase | split: ',' | split: ',' | strip | handle
      assign select_title_thrid_lv2 = section.settings.select_title_thrid_lv2 | escape | downcase | split: ',' | split: ',' | strip | handle
      assign select_title_thrid_lv3 = section.settings.select_title_thrid_lv3 | escape | downcase | split: ','
      assign text_on_label_3 = section.settings.text_on_label_3

      assign select_title_fourth_lv1 = section.settings.select_title_fourth_lv1 | escape | downcase | split: ',' | split: ',' | strip | handle
      assign select_title_fourth_lv2 = section.settings.select_title_fourth_lv2 | escape | downcase | split: ',' | split: ',' | strip | handle
      assign select_title_fourth_lv3 = section.settings.select_title_fourth_lv3 | escape | downcase | split: ','
      assign text_on_label_4 = section.settings.text_on_label_4

      assign title = link.title | escape | downcase | split: ',' | strip | handle

      assign has_dropdown = false
      assign is_megamenu = false
      if link.links != blank
        assign has_dropdown = true
        if link.levels > 1
          assign is_megamenu = true
        endif
      endif
    -%}

    <li class="site-nav__item site-nav__expanded-item{% if has_dropdown %} site-nav--has-dropdown{% endif %}{% if is_megamenu %} site-nav--is-megamenu{% endif %}">
      {% if is_megamenu or has_dropdown %}
        <div
          data-hover="{{ hover_menu }}"
          id="site-nav-item--{{ forloop.index }}"
          class="site-nav__details"
        >
          
          <a
             href="{{ link.url }}"
            aria-expanded="false"
            aria-controls="site-nav-item--{{ forloop.index }}"
            class="site-nav__link site-nav__link--hover{% if has_dropdown %} site-nav__link--has-dropdown{% endif %}{% if active_sale_lv1 contains title %} is-sale{% endif %}"
            style="{% if active_sale_lv1 contains title %}--active-sale-clr: {{ section.settings.color_active_sale.rgb }};{% endif %}"
          >
            {% if link.title == 'For baby' or link.title == 'Dành cho bé' %}
              <svg class="baby-icon-svg" xmlns="http://www.w3.org/2000/svg" width="60" height="20" viewBox="0 0 606.000000 200.000000" preserveAspectRatio="xMidYMid meet">
                <g transform="translate(0.000000,200.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
                  <path d="M4095 1983 c-123 -65 -130 -167 -34 -509 45 -161 58 -279 59 -511 0 -216 29 -301 117 -344 40 -20 67 -24 169 -27 336 -10 529 112 564 357 20 140 -22 290 -103 369 -80 78 -189 112 -359 112 -92 0 -101 2 -123 25 -14 13 -25 32 -26 42 0 10 -4 101 -8 203 -7 211 -16 237 -87 277 -47 27 -124 30 -169 6z m515 -843 c48 -24 70 -56 76 -107 9 -73 -60 -153 -131 -153 -66 0 -135 75 -135 146 0 41 37 95 80 116 45 23 62 23 110 -2z"/>
                  <path d="M2225 1976 c-38 -16 -84 -70 -87 -99 -2 -12 -3 -186 -3 -387 0 -409 4 -381 -81 -576 -24 -56 -44 -112 -44 -125 0 -52 85 -138 189 -190 160 -80 390 -79 543 3 75 40 150 121 180 196 19 48 23 76 23 172 0 109 -2 119 -32 182 -66 139 -179 213 -349 227 -143 12 -152 30 -114 206 33 150 43 229 36 268 -8 45 -58 105 -103 123 -41 18 -119 17 -158 0z m365 -891 c94 -48 103 -181 15 -235 -113 -70 -251 53 -190 169 37 72 110 99 175 66z"/>
                  <path d="M535 1790 c-73 -11 -100 -24 -153 -74 l-48 -45 -53 26 c-69 35 -131 35 -167 2 -59 -55 -69 -124 -48 -314 28 -247 9 -555 -46 -752 -11 -40 -20 -100 -20 -134 0 -105 44 -149 159 -156 76 -5 117 14 151 69 33 54 40 95 49 284 9 178 24 254 51 254 20 0 65 -58 113 -144 178 -320 418 -492 661 -473 216 16 353 150 274 267 -39 57 -98 80 -234 90 -170 12 -248 43 -335 132 -39 40 -119 166 -119 186 0 6 24 31 53 57 157 141 204 312 137 490 -31 82 -132 183 -210 212 -66 24 -147 33 -215 23z m143 -288 c63 -41 73 -140 19 -198 -28 -31 -42 -37 -84 -41 -68 -7 -117 22 -145 84 -16 36 -17 50 -8 77 28 87 143 128 218 78z"/>
                  <path d="M1775 1616 c-16 -8 -43 -27 -59 -44 -37 -39 -43 -93 -22 -194 31 -151 -21 -256 -144 -289 -65 -17 -126 -5 -227 47 -72 37 -96 44 -143 44 -73 0 -119 -29 -139 -85 -21 -61 -2 -115 62 -180 225 -224 695 -132 848 166 95 188 43 486 -94 538 -36 14 -45 13 -82 -3z"/>
                  <path d="M5195 1473 c-65 -34 -105 -88 -105 -141 0 -16 9 -64 20 -107 11 -43 20 -108 20 -144 0 -103 19 -240 39 -285 40 -91 105 -137 222 -155 34 -6 67 -15 72 -20 14 -14 -25 -72 -79 -120 -66 -58 -115 -71 -298 -82 -88 -5 -182 -15 -210 -23 -85 -25 -126 -83 -126 -177 0 -87 39 -152 115 -192 56 -29 223 -36 315 -12 145 38 287 122 396 236 196 206 475 772 477 969 2 176 -150 242 -262 114 -38 -42 -47 -63 -72 -164 -37 -142 -91 -229 -155 -250 -47 -16 -101 -5 -116 23 -6 12 -15 91 -19 177 -8 165 -27 251 -68 309 -42 58 -107 76 -166 44z"/>
                  <path d="M3360 1367 c-98 -28 -181 -105 -233 -215 -30 -64 -32 -73 -32 -188 0 -119 0 -121 38 -197 25 -51 52 -88 81 -111 119 -98 305 -128 441 -72 49 21 60 20 96 -6 25 -19 44 -23 99 -23 59 0 72 3 94 24 22 21 26 33 26 85 0 33 -5 98 -10 145 -6 47 -14 170 -19 273 -7 167 -11 192 -32 234 -37 74 -78 78 -171 18 -25 -17 -28 -17 -89 11 -51 23 -81 29 -154 31 -54 3 -108 -1 -135 -9z m206 -263 c68 -33 96 -128 58 -196 -12 -20 -38 -42 -66 -56 -40 -20 -51 -22 -87 -12 -74 20 -124 96 -107 164 9 35 55 86 91 102 40 18 70 17 111 -2z"/>
                </g>
              </svg>
            {% else %}
              {{ link.title }}
            {% endif %}
            {% if has_dropdown %}
              <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none" style="margin-left: 4px; transition: transform 0.3s ease;">
                <path d="M4.5 6.75L9 11.25L13.5 6.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            {% endif %}
          </a>
      {% else %}
        <a
          href="{{ link.url }}"
          class="site-nav__link site-nav__link--hover{% if has_dropdown %} site-nav__link--has-dropdown{% endif %}{% if active_sale_lv1 contains title %} is-sale{% endif %}"
          style="{% if active_sale_lv1 contains title %}--active-sale-clr: {{ section.settings.color_active_sale.rgb }};{% endif %}"
        >
          {% if link.title == 'For baby' or link.title == 'Dành cho bé' %}
            <svg class="baby-icon-svg" xmlns="http://www.w3.org/2000/svg" width="60" height="20" viewBox="0 0 606.000000 200.000000" preserveAspectRatio="xMidYMid meet">
              <g transform="translate(0.000000,200.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
                <path d="M4095 1983 c-123 -65 -130 -167 -34 -509 45 -161 58 -279 59 -511 0 -216 29 -301 117 -344 40 -20 67 -24 169 -27 336 -10 529 112 564 357 20 140 -22 290 -103 369 -80 78 -189 112 -359 112 -92 0 -101 2 -123 25 -14 13 -25 32 -26 42 0 10 -4 101 -8 203 -7 211 -16 237 -87 277 -47 27 -124 30 -169 6z m515 -843 c48 -24 70 -56 76 -107 9 -73 -60 -153 -131 -153 -66 0 -135 75 -135 146 0 41 37 95 80 116 45 23 62 23 110 -2z"/>
                <path d="M2225 1976 c-38 -16 -84 -70 -87 -99 -2 -12 -3 -186 -3 -387 0 -409 4 -381 -81 -576 -24 -56 -44 -112 -44 -125 0 -52 85 -138 189 -190 160 -80 390 -79 543 3 75 40 150 121 180 196 19 48 23 76 23 172 0 109 -2 119 -32 182 -66 139 -179 213 -349 227 -143 12 -152 30 -114 206 33 150 43 229 36 268 -8 45 -58 105 -103 123 -41 18 -119 17 -158 0z m365 -891 c94 -48 103 -181 15 -235 -113 -70 -251 53 -190 169 37 72 110 99 175 66z"/>
                <path d="M535 1790 c-73 -11 -100 -24 -153 -74 l-48 -45 -53 26 c-69 35 -131 35 -167 2 -59 -55 -69 -124 -48 -314 28 -247 9 -555 -46 -752 -11 -40 -20 -100 -20 -134 0 -105 44 -149 159 -156 76 -5 117 14 151 69 33 54 40 95 49 284 9 178 24 254 51 254 20 0 65 -58 113 -144 178 -320 418 -492 661 -473 216 16 353 150 274 267 -39 57 -98 80 -234 90 -170 12 -248 43 -335 132 -39 40 -119 166 -119 186 0 6 24 31 53 57 157 141 204 312 137 490 -31 82 -132 183 -210 212 -66 24 -147 33 -215 23z m143 -288 c63 -41 73 -140 19 -198 -28 -31 -42 -37 -84 -41 -68 -7 -117 22 -145 84 -16 36 -17 50 -8 77 28 87 143 128 218 78z"/>
                <path d="M1775 1616 c-16 -8 -43 -27 -59 -44 -37 -39 -43 -93 -22 -194 31 -151 -21 -256 -144 -289 -65 -17 -126 -5 -227 47 -72 37 -96 44 -143 44 -73 0 -119 -29 -139 -85 -21 -61 -2 -115 62 -180 225 -224 695 -132 848 166 95 188 43 486 -94 538 -36 14 -45 13 -82 -3z"/>
                <path d="M5195 1473 c-65 -34 -105 -88 -105 -141 0 -16 9 -64 20 -107 11 -43 20 -108 20 -144 0 -103 19 -240 39 -285 40 -91 105 -137 222 -155 34 -6 67 -15 72 -20 14 -14 -25 -72 -79 -120 -66 -58 -115 -71 -298 -82 -88 -5 -182 -15 -210 -23 -85 -25 -126 -83 -126 -177 0 -87 39 -152 115 -192 56 -29 223 -36 315 -12 145 38 287 122 396 236 196 206 475 772 477 969 2 176 -150 242 -262 114 -38 -42 -47 -63 -72 -164 -37 -142 -91 -229 -155 -250 -47 -16 -101 -5 -116 23 -6 12 -15 91 -19 177 -8 165 -27 251 -68 309 -42 58 -107 76 -166 44z"/>
                <path d="M3360 1367 c-98 -28 -181 -105 -233 -215 -30 -64 -32 -73 -32 -188 0 -119 0 -121 38 -197 25 -51 52 -88 81 -111 119 -98 305 -128 441 -72 49 21 60 20 96 -6 25 -19 44 -23 99 -23 59 0 72 3 94 24 22 21 26 33 26 85 0 33 -5 98 -10 145 -6 47 -14 170 -19 273 -7 167 -11 192 -32 234 -37 74 -78 78 -171 18 -25 -17 -28 -17 -89 11 -51 23 -81 29 -154 31 -54 3 -108 -1 -135 -9z m206 -263 c68 -33 96 -128 58 -196 -12 -20 -38 -42 -66 -56 -40 -20 -51 -22 -87 -12 -74 20 -124 96 -107 164 9 35 55 86 91 102 40 18 70 17 111 -2z"/>
              </g>
            </svg>
          {% else %}
            {{ link.title }}
          {% endif %}
          {% if has_dropdown %}
            <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none" style="margin-left: 4px; transition: transform 0.3s ease;">
              <path d="M4.5 6.75L9 11.25L13.5 6.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          {% endif %}
        </a>
      {% endif %}
      {%- if is_megamenu -%}
        {%- assign previous_column_type = '' -%}
        {%- assign animation_column = 1 -%}

        <div class="site-nav__dropdown megamenu text-left">
          <div class="page-width gap" style="{% if section.settings.section_width != 'page-width' %}{% if section.settings.section_width == 'full-width' %}--page-width: 100%{% elsif section.settings.section_width == 'customize_width' %}--page-width: {{ section.settings.customize_width | plus: 80 }}px{% endif %}{% endif %}">
            <div class="megamenu__content">
              <div class="grid">
                <div class="grid__item medium-up--two-sixths appear-animation appear-delay-{{ animation_column }}">
                  {%- assign animation_column = animation_column | plus: 1 -%}

                  {%- for childlink in link.links -%}
                    {%- liquid
                      assign create_new_column = false

                      if childlink.levels > 0 and forloop.index != 1
                        assign create_new_column = true
                      endif

                      if childlink.levels == 0 and previous_column_type == 'full'
                        assign create_new_column = true
                      endif

                      assign childtitle = childlink.title | escape | downcase | split: ',' | strip | handle
                    -%}

                    {%- if create_new_column -%}
                      </div>
                      <div class="grid__item medium-up--two-sixths appear-animation appear-delay-{{ animation_column }}">
                        {%- assign animation_column = animation_column | plus: 1 -%}
                    {%- endif -%}

                    {% comment %}
                      {%- if childlink.levels > 0 and childlink.url contains '/collections/' -%}
                        {%- if collections[childlink.object.handle].image != blank and section.settings.mega_menu_images -%}
                          <a href="{{ childlink.url }}">
                            <div class="svg-mask svg-mask--landscape">
                            {%- render 'image-element',
                              img: collections[childlink.object.handle].image,
                              sizeVariable: '20vw',
                              alt: collections[childlink.object.handle].title,
                              classes: 'megamenu__collection-image',
                            -%}
                            </div>
                          </a>
                        {%- endif -%}
                      {%- endif -%}
                    {% endcomment %}

                    <div class="f-bold">
                      <a
                        href="{{ childlink.url }}"
                        class="site-nav__dropdown-link {% if active_sale_lv2 contains childtitle %} is-sale{% endif %} site-nav__dropdown-link--top-level"
                        style="{% if active_sale_lv2 contains childtitle %}--active-sale-clr: {{ section.settings.color_active_sale.rgb }};{% endif %}"
                      >
                        {{ childlink.title }}
                        {%- if select_title_first_lv2 contains childtitle -%}
                          <span
                            class="badge-label text-xs leading-none"
                            style="--clr-on-label: {{ section.settings.color_label_1.rgb }}; --bg-on-label: {{ section.settings.background_label_1 }};"
                          >
                            {{- text_on_label_1 -}}
                          </span>
                        {%- elsif select_title_second_lv2 contains childtitle -%}
                          <span
                            class="badge-label text-xs leading-none"
                            style="--clr-on-label: {{ section.settings.color_label_2.rgb }}; --bg-on-label: {{ section.settings.background_label_2 }};"
                          >
                            {{- text_on_label_2 -}}
                          </span>
                        {%- elsif select_title_thrid_lv2 contains childtitle -%}
                          <span
                            class="badge-label text-xs leading-none"
                            style="--clr-on-label: {{ section.settings.color_label_3.rgb }}; --bg-on-label: {{ section.settings.background_label_3 }};"
                          >
                            {{- text_on_label_3 -}}
                          </span>
                        {%- elsif select_title_fourth_lv2 contains childtitle -%}
                          <span
                            class="badge-label text-xs leading-none"
                            style="--clr-on-label: {{ section.settings.color_label_4.rgb }}; --bg-on-label: {{ section.settings.background_label_4 }};"
                          >
                            {{- text_on_label_4 -}}
                          </span>
                        {%- endif -%}
                      </a>
                    </div>

                    {%- liquid
                      if childlink.levels > 0
                        assign previous_column_type = 'full'
                      else
                        assign previous_column_type = 'single'
                      endif
                    -%}

                    {%- if childlink.links != blank -%}
                      <div class="mega-cards">
                        {%- for grandchildlink in childlink.links -%}
                          {% assign grandchildtitle = grandchildlink.title | escape | downcase | strip %}
                          {% assign tagline_text = '' %}
                          {% if grandchildlink.url contains '/collections/' %}
                            {% assign _coll = collections[grandchildlink.object.handle] %}
                            {% if _coll and _coll.metafields and _coll.metafields.custom and _coll.metafields.custom.tagline != blank %}
                              {% assign tagline_text = _coll.metafields.custom.tagline %}
                            {% endif %}
                          {% elsif grandchildlink.url contains '/products/' %}
                            {% if grandchildlink.object and grandchildlink.object.metafields and grandchildlink.object.metafields.custom and grandchildlink.object.metafields.custom.tagline != blank %}
                              {% assign tagline_text = grandchildlink.object.metafields.custom.tagline %}
                            {% endif %}
                          {% endif %}
                          <a href="{{ grandchildlink.url }}" class="mega-card__link{% if active_sale_lv3 contains grandchildtitle %} is-sale{% endif %}" style="{% if active_sale_lv3 contains grandchildtitle %}--active-sale-clr: {{ section.settings.color_active_sale.rgb }};{% endif %}">
                            <div class="mega-card__image">
                              {% if grandchildlink.object and grandchildlink.object.featured_media %}
                                <img src="{{ grandchildlink.object.featured_media | image_url: width: 400, height: 296, crop: 'center' }}" alt="{{ grandchildlink.title | escape }}" width="200" height="148" loading="lazy">
                              {% elsif _coll and _coll.image %}
                                <img src="{{ _coll.image | image_url: width: 400, height: 296, crop: 'center' }}" alt="{{ grandchildlink.title | escape }}" width="200" height="148" loading="lazy">
                              {% else %}
                                <div class="mega-card__image--placeholder"></div>
                              {% endif %}
                            </div>
                            <div class="mega-card__title">{{ grandchildlink.title }}</div>
                            {% if tagline_text != blank %}
                              <div class="mega-card__tagline">{{ tagline_text }}</div>
                            {% endif %}
                          </a>
                        {%- endfor -%}
                      </div>
                    {%- endif -%}
                  {%- endfor -%}
                </div>
              </div>
            </div>
            
          </div>
          <div class="megamenu__bottom">
            <div class="page-width">
              <div class="megamenu__links flex-center py-base border-t">
                {%- if section.settings.mega_menu_first_links_text != blank
                  or section.settings.mega_menu_first_links_icon
                -%}
                  <a
                    href="{{ section.settings.mega_menu_first_links_url }}"
                    class="megamenu__links-item flex ai-center gap-x-xs"
                  >
                    {%- if section.settings.mega_menu_first_links_icon != blank -%}
                      <span class="megamenu__links-icon">{{ section.settings.mega_menu_first_links_icon }}</span>
                    {%- endif -%}
                    {%- if section.settings.mega_menu_first_links_text != blank -%}
                      <span class="megamenu__links-text">{{ section.settings.mega_menu_first_links_text }}</span>
                    {%- endif -%}
                  </a>
                {%- endif -%}
                {%- if section.settings.mega_menu_second_links_text != blank
                  or section.settings.mega_menu_second_links_icon
                -%}
                  <a
                    href="{{ section.settings.mega_menu_second_links_url }}"
                    class="megamenu__links-item flex ai-center gap-x-xs"
                  >
                    {%- if section.settings.mega_menu_second_links_icon != blank -%}
                      <span class="megamenu__links-icon">{{ section.settings.mega_menu_second_links_icon }}</span>
                    {%- endif -%}
                    {%- if section.settings.mega_menu_second_links_text != blank -%}
                      <span class="megamenu__links-text">{{ section.settings.mega_menu_second_links_text }}</span>
                    {%- endif -%}
                  </a>
                {%- endif -%}
              </div>
            </div>
          </div>
          <div class="megamenu_promotion">
            <div class="promotion_container page-width">
              <div class="promotions flex-center">
                {%- assign block_promotion = section.blocks | where: 'type', 'header_promotion' -%}
                {%- if block_promotion.size > 0 -%}
                  {%- for block in block_promotion -%}
                    <div class="promotion flex ai-center text-xs">
                      {%- if block.settings.promotion_icon != blank -%}
                        <div class="promotion_icon">
                          {{ block.settings.promotion_icon }}
                        </div>
                      {%- endif -%}
                      {%- if block.settings.promotion_text != blank -%}
                        <div class="promotion_text">
                          {{ block.settings.promotion_text }}
                        </div>
                      {%- endif -%}
                    </div>
                  {%- endfor -%}
                {%- endif -%}
              </div>
            </div>
          </div>
        </div>
      {%- elsif has_dropdown -%}
        <ul class="site-nav__dropdown text-left">
          {%- for childlink in link.links -%}
            {%- liquid
              assign has_sub_dropdown = false
              assign childtitle = childlink.title | escape | downcase | split: ',' | strip | handle
              if childlink.links != blank
                assign has_sub_dropdown = true
              endif
            -%}

            <li class="{% if has_sub_dropdown %} site-nav__deep-dropdown-trigger{% endif %}">
              <a
                href="{{ childlink.url }}"
                class="site-nav__dropdown-link site-nav__dropdown-link--second-level{% if has_sub_dropdown %} site-nav__dropdown-link--has-children{% endif %}{% if active_sale_lv2 contains childtitle %} is-sale{% endif %}"
                style="{% if active_sale_lv2 contains childtitle %}--active-sale-clr: {{ section.settings.color_active_sale.rgb }};{% endif %}"
              >
                {{ childlink.title | escape }}
                {%- if has_sub_dropdown -%}
                  <svg
                    aria-hidden="true"
                    focusable="false"
                    role="presentation"
                    class="icon icon--wide icon-chevron-down"
                    viewBox="0 0 28 16"
                  >
                    <path d="m1.57 1.59 12.76 12.77L27.1 1.59" stroke-width="2" stroke="#000" fill="none"/>
                  </svg>
                {%- endif -%}
                {%- if select_title_first_lv2 contains childtitle -%}
                  <span
                    class="badge-label text-xs leading-none"
                    style="--clr-on-label: {{ section.settings.color_label_1.rgb }}; --bg-on-label: {{ section.settings.background_label_1 }};"
                  >
                    {{- text_on_label_1 -}}
                  </span>
                {%- elsif select_title_second_lv2 contains childtitle -%}
                  <span
                    class="badge-label text-xs leading-none"
                    style="--clr-on-label: {{ section.settings.color_label_2.rgb }}; --bg-on-label: {{ section.settings.background_label_2 }};"
                  >
                    {{- text_on_label_2 -}}
                  </span>
                {%- elsif select_title_thrid_lv2 contains childtitle -%}
                  <span
                    class="badge-label text-xs leading-none"
                    style="--clr-on-label: {{ section.settings.color_label_3.rgb }}; --bg-on-label: {{ section.settings.background_label_3 }};"
                  >
                    {{- text_on_label_3 -}}
                  </span>
                {%- elsif select_title_fourth_lv2 contains childtitle -%}
                  <span
                    class="badge-label text-xs leading-none"
                    style="--clr-on-label: {{ section.settings.color_label_4.rgb }}; --bg-on-label: {{ section.settings.background_label_4 }};"
                  >
                    {{- text_on_label_4 -}}
                  </span>
                {%- endif -%}
              </a>
              {%- if has_sub_dropdown -%}
                <ul class="site-nav__deep-dropdown">
                  {%- for grandchildlink in childlink.links -%}
                    {% assign grandchildtitle = grandchildlink.title
                      | escape
                      | downcase
                      | split: ','
                    %}
                    <li>
                      <a
                        href="{{ grandchildlink.url }}"
                        class="site-nav__dropdown-link{% if active_sale_lv3 contains grandchildtitle %} is-sale{% endif %}"
                        style="{% if active_sale_lv3 contains grandchildtitle %}--active-sale-clr: {{ section.settings.color_active_sale.rgb }};{% endif %}"
                      >
                        {{ grandchildlink.title | escape }}
                        {% for title in select_title_first_lv3 %}
                          {%- assign title_cv = title | strip -%}
                          {%- if title_cv == grandchildtitle -%}
                          <span
                            class="badge-label text-xs leading-none"
                            style="--clr-on-label: {{ section.settings.color_label_1.rgb }}; --bg-on-label: {{ section.settings.background_label_1 }};"
                          >
                            {{- text_on_label_1 -}}
                          </span>
                          {%- endif -%}
                        {% endfor %}
                        {% for title in select_title_second_lv3 %}
                          {%- assign title_cv = title | strip -%}
                          {%- if title_cv == grandchildtitle -%}
                          <span
                            class="badge-label text-xs leading-none"
                            style="--clr-on-label: {{ section.settings.color_label_2.rgb }}; --bg-on-label: {{ section.settings.background_label_2 }};"
                          >
                            {{- text_on_label_2 -}}
                          </span>
                          {%- endif -%}
                        {% endfor %}
                        {% for title in select_title_thrid_lv3 %}
                          {%- assign title_cv = title | strip -%}
                          {%- if title_cv == grandchildtitle -%}
                          <span
                            class="badge-label text-xs leading-none"
                            style="--clr-on-label: {{ section.settings.color_label_3.rgb }}; --bg-on-label: {{ section.settings.background_label_3 }};"
                          >
                            {{- text_on_label_3 -}}
                          </span>
                        {%- endif -%}
                        {% endfor %}
                        {% for title in select_title_fourth_lv3 %}
                          {%- assign title_cv = title | strip -%}
                          {%- if title_cv == grandchildtitle -%}
                            <span
                              class="badge-label text-xs leading-none"
                              style="--clr-on-label: {{ section.settings.color_label_4.rgb }}; --bg-on-label: {{ section.settings.background_label_4 }};"
                            >
                              {{- text_on_label_4 -}}
                            </span>
                          {%- endif -%}
                        {% endfor %}
                      </a>
                    </li>
                  {%- endfor -%}
                </ul>
              {%- endif -%}
            </li>
          {%- endfor -%}
        </ul>
      {%- endif -%}
      {% if is_megamenu or has_dropdown %}
        </div>
      {% endif %}
    </li>
  {%- endfor -%}
</ul>

<style>
  @media (min-width: 750px) {
    /* Constrain megamenu width exactly like header (1360px) */
    .site-nav__dropdown.megamenu .page-width {
      margin: 0 auto !important;
      max-width: 1360px !important;
      width: 100% !important;
      padding-left: 0;
      padding-right: 0;
    }
    /* Base layout */
    .site-nav__dropdown.megamenu .megamenu__content .grid { display: block; }
    .site-nav__dropdown.megamenu .megamenu__content .grid__item.appear-animation { width: 100% !important; max-width: none; }
    .site-nav__dropdown.megamenu .megamenu__content .grid__item.appear-animation + .grid__item.appear-animation { margin-top: 24px; }

    /* Only keep first row structure; other rows' cards will be moved into a scroller */
    .site-nav__dropdown.megamenu .megamenu__content .grid__item.appear-animation:not(:first-child) { display: none !important; }

    /* Scroller that shows only mega-cards, title (f-bold) stays fixed */
    .site-nav__dropdown.megamenu .mega-scroll {
      height: var(--mega-row-height, 288px);
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      padding-right: 0;
      /* Hide scrollbar across browsers */
      -ms-overflow-style: none; /* IE and Edge */
      scrollbar-width: none; /* Firefox */
    }
    .site-nav__dropdown.megamenu .mega-scroll::-webkit-scrollbar { display: none; }
    .site-nav__dropdown.megamenu .mega-scroll > .mega-cards {
      scroll-snap-align: start;
      scroll-snap-stop: always;
      min-height: var(--mega-row-height, 288px);
      display: flex;
      flex-wrap: wrap;
      gap: 12px; /* add a bit spacing between product cards */
      align-items: flex-start;
    }
    .site-nav__dropdown.megamenu .mega-scroll > .mega-cards > * { margin: 0 !important; }

    /* Dim titles in display-2 and display-3 */
    .site-nav__dropdown.megamenu .grid__item.appear-delay-2 .f-bold,
    .site-nav__dropdown.megamenu .grid__item.appear-delay-3 .f-bold {
      opacity: 0.7;
    }

    /* Reveal animation */
    .site-nav__dropdown.megamenu .grid__item.appear-delay-2,
    .site-nav__dropdown.megamenu .grid__item.appear-delay-3 {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 0.35s ease, transform 0.35s ease;
    }
    .site-nav__dropdown.megamenu .grid__item.appear-animation.is-visible {
      opacity: 1;
      transform: none;
    }

    /* Place tabs inline next to .f-bold heading */
    .site-nav__dropdown.megamenu .f-bold {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .site-nav__dropdown.megamenu .mega-tabs { display: inline-flex; gap: 12px; }
    .site-nav__dropdown.megamenu .mega-tab {
      background: none;
      border: 0;
      padding: 0;
      cursor: pointer;
      font: inherit;
      font-weight: inherit; /* match .f-bold */
      opacity: 0.6; /* lighter than f-bold */
    }
    .site-nav__dropdown.megamenu .mega-tab.is-active { opacity: 1; }

    /* Align when header is left-center: center the scroller and fix row height */
    .header-layout--left-center .site-nav__dropdown.megamenu .mega-scroll {
      --mega-row-height: 288px;
      height: 288px;
      margin-left: auto;
      margin-right: auto;
      width: 100%;
    }
  }
</style>

<script>
  (function () {
    if (window.__ru9MegaStagedInit) return;
    window.__ru9MegaStagedInit = true;

    function initStagedReveal() {
      var megaMenus = document.querySelectorAll('.site-nav__dropdown.megamenu');
      if (!('IntersectionObserver' in window)) {
        // Fallback: show everything if IO not supported
        megaMenus.forEach(function (menu) {
          menu.querySelectorAll('.mega-scroll > .mega-cards').forEach(function (el) {
            el.classList.add('is-visible');
          });
        });
        return;
      }

      megaMenus.forEach(function (menu) {
        var scroller = menu.querySelector('.mega-scroll');
        var targets = menu.querySelectorAll('.mega-scroll > .mega-cards');
        if (!targets.length) return;

        var io = new IntersectionObserver(function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
              io.unobserve(entry.target);
            }
          });
        }, {
          root: scroller || menu,
          rootMargin: '0px 0px -10% 0px',
          threshold: 0.1
        });

        targets.forEach(function (el) { io.observe(el); });
      });
    }

    function initMegaTabsAndScroll() {
      var megaMenus = document.querySelectorAll('.site-nav__dropdown.megamenu');
      megaMenus.forEach(function (menu) {
        var grid = menu.querySelector('.megamenu__content .grid');
        if (!grid) return;
        var pages = Array.prototype.slice.call(grid.querySelectorAll('.grid__item.appear-animation'));
        if (pages.length === 0) return;

        // Build scroller of mega-cards and keep first f-bold fixed
        var firstRow = pages[0];
        var firstBold = firstRow && firstRow.querySelector('.f-bold');
        if (!firstBold) return;

        var scroller = document.createElement('div');
        scroller.className = 'mega-scroll';

        var cardsList = [];
        pages.forEach(function (page) {
          var cards = page.querySelector('.mega-cards');
          if (cards) {
            cardsList.push(cards);
          }
        });

        // Wrap each mega-cards into its own viewport container to ensure clear snapping
        cardsList.forEach(function (cards) {
          var viewport = document.createElement('div');
          viewport.className = 'mega-cards';
          // If cards is already a mega-cards element, move its children into viewport
          while (cards.firstChild) {
            viewport.appendChild(cards.firstChild);
          }
          scroller.appendChild(viewport);
          // Remove original empty node
          cards.parentNode && cards.parentNode.removeChild(cards);
        });

        // Insert scroller after first title
        firstBold.parentNode.insertBefore(scroller, firstBold.nextSibling);

        // Tabs inline next to first title for rows 2 and 3
        var tabs = document.createElement('div');
        tabs.className = 'mega-tabs';
        [1, 2].forEach(function (idx) {
          if (!pages[idx]) return;
          var labelAnchor = pages[idx].querySelector('.f-bold a');
          var label = labelAnchor ? labelAnchor.textContent.trim() : ('Collection ' + (idx + 1));
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'mega-tab';
          btn.setAttribute('data-index', String(idx));
          btn.textContent = label;
          tabs.appendChild(btn);
        });
        firstBold.appendChild(tabs);

        // Height: if header layout left-center exists, force 288px
        if (document.querySelector('.header-layout--left-center')) {
          scroller.style.setProperty('--mega-row-height', '288px');
          scroller.style.height = '288px';
        }

        function highlightTabByIndex(activeIndex) {
          tabs.querySelectorAll('.mega-tab').forEach(function (tab) {
            var idx = parseInt(tab.getAttribute('data-index') || '0', 10);
            tab.classList.toggle('is-active', idx === activeIndex);
            tab.setAttribute('aria-selected', idx === activeIndex ? 'true' : 'false');
          });
        }

        tabs.addEventListener('click', function (e) {
          var btn = e.target && e.target.closest('.mega-tab');
          if (!btn) return;
          var idx = parseInt(btn.getAttribute('data-index') || '1', 10);
          var targetCards = scroller.children[idx] || null; // index: 0 is first row's cards
          if (!targetCards) return;
          var offset = targetCards.offsetTop - scroller.firstElementChild.offsetTop;
          scroller.scrollTo({ top: offset, behavior: 'smooth' });
          highlightTabByIndex(idx);
        });

        // Sync tab state on scroll
        scroller.addEventListener('scroll', function () {
          var scrollTop = scroller.scrollTop + 1;
          var current = 0;
          for (var i = 0; i < scroller.children.length; i++) {
            if (scrollTop >= scroller.children[i].offsetTop - scroller.firstElementChild.offsetTop) {
              current = i;
            }
          }
          // Only highlight for indexes 1 and 2 (display 2/3)
          if (current >= 1 && current <= 2) {
            highlightTabByIndex(current);
          } else {
            highlightTabByIndex(-1);
          }
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        initStagedReveal();
        initMegaTabsAndScroll();
      });
    } else {
      initStagedReveal();
      initMegaTabsAndScroll();
    }
  })();
</script>
