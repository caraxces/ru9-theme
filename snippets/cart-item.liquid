{% comment %}
  This logic checks if the cart item is part of a bundle.
  If it is, it will render a header for the bundle (once per bundle)
  and apply a custom background color to the item.
{% endcomment %}

{%- assign is_bundle_item = false -%}
{%- assign bundle_id = '' -%}
{%- assign bundle_title = '' -%}
{%- assign bundle_discount_title = '' -%}

{%- for p in product.properties -%}
  {%- if p.first == '_bundle_id' -%}
    {%- assign is_bundle_item = true -%}
    {%- assign bundle_id = p.last -%}
  {%- endif -%}
  {%- if p.first == '_bundle_title' -%}
    {%- assign bundle_title = p.last -%}
  {%- endif -%}
  {%- if p.first == '_bundle_discount_title' -%}
    {%- assign bundle_discount_title = p.last -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}
  Bundle header will be shown by JavaScript - one header per bundle group
{%- endcomment -%}
{%- if is_bundle_item -%}
  <div class="bundle-header" data-bundle-id="{{ bundle_id }}" style="display: none;">
    <div class="bundle-header__content" style="background: #F0F7FF; padding: 12px 16px; margin: 0 0 0 0; border-radius: 8px 8px 0 0; border-left: 4px solid #234085;border-bottom: #F0F7FF !important; display: flex; justify-content: space-between; align-items: center;">
      <h4 style="color: #1C2C58; font-family: 'Be Vietnam Pro', sans-serif; font-size: 16px; font-weight: 600; margin: 0;">
        {{ bundle_title }}
      </h4>
      {%- if bundle_discount_title != blank -%}
        <span class="bundle-voucher" style="font-size: 14px; color: #234085; font-weight: 600;">
          {{ bundle_discount_title }}
        </span>
      {%- endif -%}
    </div>
  </div>
{%- endif -%}

<style>
  /* Bundle header - rounded top corners only */
  .bundle-header {
    margin: 0 !important;
    padding: 0 !important;
    border-bottom: transparent !important;
  }
  
  /* All bundle items - base styling */
  .cart__item--bundle-item {
    background-color: #F0F7FF !important;
    border-left: 4px solid #234085 !important;
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    padding: 12px 12px 12px 16px !important;
    border-radius: 0 !important;
  }
  
  /* First bundle item - connect to header (no gap) */
  .cart__item--bundle-item.bundle-item-first {
    border-radius: 0 !important;
    margin-top: 0 !important;
  }
  
  /* Middle bundle items */
  .cart__item--bundle-item.bundle-item-middle {
    border-radius: 0 !important;
  }
  
  /* Last bundle item - rounded bottom corners */
  .cart__item--bundle-item.bundle-item-last {
    border-radius: 0 !important;
    margin-bottom: 0 !important;
  }
  
  /* Single bundle item - rounded bottom only */
  .cart__item--bundle-item.bundle-item-single {
    border-radius: 0 0 8px 8px !important;
    margin-bottom: 12px !important;
  }
</style>

<div class="cart__item{% if is_bundle_item %} cart__item--bundle-item{% endif %}" data-key="{{ product.key }}" {% if is_bundle_item %}data-bundle-id="{{ bundle_id }}" data-bundle-quantity="{{ product.properties._bundle_quantity }}"{% endif %} data-quantity="{{ product.quantity }}">
  <div class="cart__image">
    {% if product.image != blank %}
      <a href="{{ product.url }}" class="image-wrap">
        {%- render 'image-element',
          img: product.image,
          alt: product.product.title,
          widths: '264',
          sizes: '132px'
        -%}
      </a>
    {% endif %}
  </div>
  <div class="cart__item-details">
    <a href="{{ product.url }}" class="cart-item__title">
      {{ product.product.title }}
    </a>
    {%- unless product.product.has_only_default_variant -%}
      {%- assign has_variant_options = false -%}
      {%- for option in product.options_with_values -%}
        {%- if option.value != blank -%}
          {%- assign has_variant_options = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if has_variant_options -%}
        <div class="cart-item__variant">
          {%- for option in product.options_with_values -%}
            {%- if option.value != blank -%}
              <div>{{ option.value }}</div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      {%- endif -%}
    {%- endunless -%}

    <div class="cart-item__price-wrapper">
        {%- comment -%}
            Check if there's any discount to display. This can be either:
            1. A "compare at" price on the variant (a sale).
            2. A cart-level discount making final_price different from original_price.
        {%- endcomment -%}
        {%- if product.variant.compare_at_price > product.price or product.original_price != product.final_price -%}
            
            {%- comment -%}
                Determine the strikethrough price. 
                If it's a sale item, the strikethrough should be the 'compare at price'.
                Otherwise, it's the original price before cart discounts.
            {%- endcomment -%}
            <span class="cart-item__price--original">
                {%- if product.variant.compare_at_price > product.price -%}
                    {{ product.variant.compare_at_price | money }}
                {%- else -%}
                    {{ product.original_price | money }}
                {%- endif -%}
            </span>

            <span class="cart-item__price--final">{{ product.final_price | money }}</span>

        {%- else -%}
            {%- comment -%} No discounts, just show the final price. {%- endcomment -%}
            <span class="cart-item__price--final">{{ product.final_price | money }}</span>
        {%- endif -%}
    </div>

    {%- if product.selling_plan_allocation != empty and product.selling_plan_allocation.selling_plan.name != blank -%}
      <div class="cart-item__variant">
        {{ product.selling_plan_allocation.selling_plan.name }}
      </div>
    {%- endif -%}

    {%- assign property_size = product.properties | size -%}
    {% if property_size > 0 %}
      {% for p in product.properties %}
        {%- assign first_character_in_key = p.first | truncate: 1, '' -%}
        {% unless p.last == blank or first_character_in_key == '_' %}
          <div class="cart-item__variant">
            <div>
              <span>{{ p.first }}:</span>
              {% if p.last contains '/uploads/' %}
                <a href="{{ p.last }}">{{ p.last | split: '/' | last }}</a>
              {% else %}
                {{ p.last }}
              {% endif %}
            </div>
          </div>
        {% endunless %}
      {% endfor %}
    {% endif %}
  </div>
  {%- comment -%} Hide controls for bundle items, they will be controlled by a master footer {%- endcomment -%}
  {%- unless is_bundle_item -%}
  <div class="cart-item__footer">
      <div class="js-qty__wrapper">
          <button type="button" class="js-qty__adjust js-qty__adjust--minus" aria-label="{{ 'cart.general.reduce_quantity' | t }}">
              &minus;
          </button>
          <input
              type="text"
              class="js-qty__num"
              value="{{ product.quantity }}"
              min="0"
              pattern="[0-9]*"
              data-id="{{ product.key }}"
              aria-label="{{ 'cart.label.quantity' | t }}"
          >
          <button type="button" class="js-qty__adjust js-qty__adjust--plus" aria-label="{{ 'cart.general.increase_quantity' | t }}">
              +
          </button>
      </div>
  </div>
  {%- endunless -%}
</div>
