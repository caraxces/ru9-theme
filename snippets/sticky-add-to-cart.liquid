{%- liquid
  assign product_form_id = product_form_id | append: '-duplicate'
  assign current_variant = product.selected_or_first_available_variant
-%}

<sticky-add-to-cart
  class="product__sticky flex ai-center fixed z-index-10 pointer-none no-js-hidden"
  id="product-sticky-{{ section.id }}-{{ product.id }}"
  data-section="{{ section.id }}"
>
  <nav class="product__sticky-navigation shrink-0 mobile-hidden">
    <div class="sticky-navigation__links flex ai-center gap-x"></div>
  </nav>
  <div class="product__stick-product-wrap flex ai-center jc-between gap-x-sm flex-1">
    {%- liquid
      assign buy_buttons = section.blocks | where: 'type', 'buy_buttons'
    -%}
    <div class="product__sticky-product desktop-only">
      <div class="product__sticky-content">
        <h3 class="product__sticky-title fw-bold">{{ product.title }}</h3>
        <div class="product__sticky-variants">
            <div class="label-select text-xs" data-header-option-container>
              {%- for option in product.options_with_values -%}
                <span class="sticky-variant-item">{{ option.selected_value | split: '-' | first | strip }}</span>&nbsp;{%- unless forloop.last %} {% endunless -%}
              {%- endfor -%}
            </div>
        </div>
      </div>
      <div class="product__sticky-price desktop-only" data-sticky-price>
        <div class="current-price">{{ current_variant.price | money }}</div>
        {%- if current_variant.compare_at_price > current_variant.price -%}
          <div class="original-price">{{ current_variant.compare_at_price | money }}</div>
        {%- endif -%}
      </div>
    </div>
    <div class="sticky-mobile-info mobile-only">
      <div class="sticky-mobile-info__text">
        <span class="sticky-variant-title" data-header-option>
          {%- for option in product.options_with_values -%}
            {{ option.selected_value | split: '-' | first | strip }}{%- unless forloop.last %} / {% endunless -%}
          {%- endfor -%}
        </span>
        <div class="sticky-variant-price" data-sticky-price>
          <span class="current-price">{{ current_variant.price | money }}</span>
          {%- if current_variant.compare_at_price > current_variant.price -%}
            <span class="original-price">{{ current_variant.compare_at_price | money }}</span>
          {%- endif -%}
        </div>
      </div>
    </div>
    <div class="product__sticky-inner o-h">
      <div class="product__sticky-wrapper">
        {%- if buy_buttons.size > 0 -%}
          {%- if product != blank -%}
            {%- form 'product', product, id: product_form_id, class: 'product-single__sticky-form' -%}
              {%- liquid
                assign gift_card_recipient_feature_active = false
                if block.settings.show_gift_card_recipient and product.gift_card?
                  assign gift_card_recipient_feature_active = true
                endif
              -%}

              {%- if gift_card_recipient_feature_active -%}
                {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
              {%- endif -%}

              {%- liquid
                assign default_text = 'products.product.add_to_cart' | t
                assign button_text = 'products.product.add_to_cart' | t
                if template contains 'preorder'
                  assign default_text = 'products.product.preorder' | t
                  assign button_text = 'products.product.preorder' | t
                endif
                unless current_variant.available
                  assign button_text = 'products.product.sold_out' | t
                endunless
              -%}

              <!-- Desktop Button Layout -->
              <div class="sticky-buttons-wrapper desktop-buttons">
                <button
                  {% if product.empty? %}
                    type="button"
                  {% else %}
                    type="submit"
                  {% endif %}
                  name="add"
                  data-add-to-cart-sticky
                  id="ProductSubmitButtonSticky-{{ block.id }}-{{ product.id }}"
                  class="btn btn--full btn--secondary add-to-cart custom-add-to-cart-btn{% if enable_dynamic_buttons and product.selling_plan_groups == empty %} btn--secondary{% endif %}"
                  {% unless current_variant.available %}
                    disabled="disabled"
                  {% endunless %}
                >
                  <span class="icon-cart">{% render 'icon-cart-2' %}</span>
                  <span data-add-to-cart-text-sticky data-default-text="{{ default_text }}">
                    {{ button_text }}
                  </span>
                </button>
              </div>

              <!-- Mobile Button Layout -->
              <div class="sticky-buttons-wrapper mobile-buttons mobile-only">
                <button
                  {% if product.empty? %}
                    type="button"
                  {% else %}
                    type="submit"
                  {% endif %}
                  name="add"
                  data-add-to-cart-sticky
                  class="btn btn--full add-to-cart mobile-add-to-cart-btn{% if enable_dynamic_buttons and product.selling_plan_groups == empty %} btn--secondary{% endif %}"
                  {% unless current_variant.available %}
                    disabled="disabled"
                  {% endunless %}
                >
                  <span class="mobile-cart-text">THÊM VÀO GIỎ</span>
                </button>
              </div>

              <select name="id" data-product-select-sticky class="product-single__variants no-js">
                {%- for variant in product.variants -%}
                  {%- if variant.available -%}
                    <option
                      {% if variant == product.selected_or_first_available_variant %}
                        selected="selected"
                      {% endif %}
                      {% for option_value in variant.options %}
                        data-option{{ forloop.index }}="{{ option_value | escape }}"
                      {% endfor %}
                      value="{{ variant.id }}"
                    >
                      {{ variant.title }} - {{ variant.price | money_with_currency }}
                    </option>
                  {%- else -%}
                    <option disabled="disabled">{{ variant.title }} - {{ 'products.product.sold_out' | t }}</option>
                  {%- endif -%}
                {%- endfor -%}
              </select>
            {%- endform -%}

          {%- else -%}
          {%- endif -%}
        {%- endif -%}
      </div>
    </div>
  </div>
</sticky-add-to-cart>

<style>
  .product__sticky-content {
    margin-left: 15px;
  }
  
  .product__sticky-title {
    font-size: 14px;
    margin: 0 !important;
    padding: 0;
    line-height: 1.2;
  }
  
  .product__sticky-price {
    display: none;
    font-size: 12px;
    margin-bottom: 5px;
  }

  .current-price {
    font-size: 16px;
    font-weight: 600;
    color: #1C2C58;
  }

  .original-price {
    font-size: 14px;
    font-weight: 400;
    color: #999;
    text-decoration: line-through;
    margin-top: 2px;
  }
  
  /* Desktop Only Elements - Always visible on desktop */
  .desktop-only {
    display: block;
  }
  
  /* Mobile Only Elements - Hidden by default */
  .mobile-only {
    display: none;
  }
  
  /* Desktop layout for product sticky */
  .product__sticky-product {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .product__sticky-image {
    flex-shrink: 0;
    width: 110px !important;
  }
  
  .product__sticky-content {
    flex: 1;
    margin-left: 0;
  }
  
  /* Custom button styles */
  .custom-add-to-cart-btn {
    background-color: #ffffff !important;
    border-color: #FCE390 !important;
    color: #FCE390 !important;
    border-radius: calc(var(--buttonRadius) * 0.5) !important;
    padding: 11px 20px !important;
    font-size: var(--f-size-button) !important;
    font-weight: 500 !important;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    font-family: inherit !important;
    font-variant-numeric: normal !important;
  }
  
  .custom-add-to-cart-btn:hover,
  .custom-add-to-cart-btn:focus {
    background-color: #FCE390 !important;
    border-color: #FCE390 !important;
    color: #ffffff !important;
  }
  
  /* Desktop Buy Now Button Styles */
  .desktop-buy-now-btn {
    background-color: #FCE390 !important;
    border-color: #FCE390 !important;
    color: #ffffff !important;
    border-radius: calc(var(--buttonRadius) * 0.5) !important;
    padding: 11px 20px !important;
    font-size: calc(var(--f-size-button) - 3px) !important;
    font-weight: 500 !important;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    font-family: inherit !important;
    font-variant-numeric: normal !important;
  }
  
  .desktop-buy-now-btn:hover,
  .desktop-buy-now-btn:focus {
    background-color: #e85a2b !important;
    border-color: #e85a2b !important;
    color: #ffffff !important;
  }
  
  .desktop-buy-now-btn.btn--loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  /* Mobile Button Styles */
  .mobile-buttons .mobile-add-to-cart-btn {
    background-color: #FCE390 !important;
    border-color: #FCE390 !important;
    color: #000000 !important;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    font-family: inherit !important;
    font-variant-numeric: normal !important;
  }
  
  .mobile-buttons .mobile-add-to-cart-btn:hover {
    background-color: #FCE390 !important;
    border-color: #FCE390 !important;
    color: #000000 !important;
  }
  
  /* Buy Now Button Styles - Mobile Only */
  .mobile-buttons .buy-now-btn {
    background-color: #FCE390 !important;
    border-color: #FCE390 !important;
    color: #000000 !important;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    font-family: inherit !important;
    font-variant-numeric: normal !important;
  }
  
  .mobile-buttons .buy-now-btn:hover,
  .mobile-buttons .buy-now-btn:focus {
    background-color: #e85a2b !important;
    border-color: #e85a2b !important;
    color: #ffffff !important;
  }
  
  .mobile-buttons .buy-now-btn.btn--loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  /* Desktop Sticky Buttons Wrapper */
  .desktop-buttons {
    width: 100%;
    display: flex;
    gap: 10px;
  }
  
  /* Mobile Sticky Buttons Wrapper - Hidden by default */
  .mobile-buttons {
    display: none;
    width: 100%;
    gap: 0;
  }
  
  /* Hide payment buttons on mobile when setting is enabled */
  .hide-payment-mobile .payment-buttons {
    display: block;
  }
  
  /* Mobile styles */
  @media screen and (max-width: 749px) {
    /* Always show sticky cart on mobile */
    .product__sticky {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 1000 !important;
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      box-shadow: none !important;
    }
    
    /* Hide desktop elements on mobile */
    .desktop-only {
      display: none !important;
    }
    
    /* Show mobile elements on mobile */
    .mobile-only {
      display: block !important;
    }
    
    .product__stick-product-wrap {
      width: 100% !important;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: #FFF;
    }
    
    .product__sticky-inner,
    .product__sticky-wrapper,
    .product-single__sticky-form {
      width: auto !important;
    }
    
    .product__sticky.active {
      transform: translateY(0) !important;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      background: #fff;
    }
    
    /* Hide desktop buttons on mobile */
    .desktop-buttons {
      display: none !important;
    }
    
    /* Show mobile buttons on mobile */
    .mobile-buttons {
      width: auto !important;
      display: flex !important;
      padding: 0;
      margin: 0;
      position: static;
      margin-left: 0;
      margin-right: 0;
    }
    
    .mobile-buttons .btn {
      border-radius: 50px !important;
      height: 48px;
      font-size: 14px !important;
      font-weight: 600;
      font-family: inherit !important;
      font-variant-numeric: normal !important;
      padding: 0 24px !important;
      white-space: nowrap;
    }
    
    .mobile-buttons .btn:first-child {
      border-radius: 50px !important;
      border-right: none;
    }
    
    .mobile-buttons .btn:last-child {
      border-radius: 50px !important;
    }
    
    /* Hide payment buttons on mobile when setting is enabled */
    .hide-payment-mobile .payment-buttons {
      display: none !important;
    }
    
    /* Hide entire buy buttons form on mobile when setting is enabled */
    .hide-buy-buttons-mobile {
      display: none !important;
    }
    
    /* Hide product info completely on mobile */
    .product__sticky-product {
      display: none !important;
    }
    
    .product__sticky-image {
      display: none !important;
    }
    
    .product__sticky-content {
      display: none !important;
    }

    .sticky-mobile-info {
      display: flex;
      flex-direction: row;
      align-items: baseline;
      gap: 8px;
    }

    .sticky-mobile-info__text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .sticky-variant-title {
      font-size: 14px;
      font-weight: 500;
      color: #000;
    }

    .sticky-variant-price {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .sticky-variant-price .current-price {
      font-size: 16px;
      font-weight: 600;
      color: #1C2C58;
    }

    .sticky-variant-price .original-price {
      font-size: 14px;
      font-weight: 400;
      color: #999;
      text-decoration: line-through;
      margin-top: 2px;
    }
  }
  
  /* Desktop styles */
  @media screen and (min-width: 750px) {
    /* Ensure desktop elements are visible */
    .desktop-only {
      display: block !important;
    }
    
    /* Hide mobile elements on desktop */
    .mobile-only {
      display: none !important;
    }
    
    /* Desktop flexbox layout for product info */
    .product__sticky-product {
      display: flex !important;
      align-items: center !important;
      gap: 15px !important;
      flex: 1;
      justify-content: space-between;
    }
    
    .product__sticky-price.desktop-only {
      display: flex !important;
      flex-direction: column !important;
      align-items: flex-end !important;
      font-size: 16px;
      font-weight: 600;
      color: #1C2C58;
      white-space: nowrap;
    }

    .product__sticky-price.desktop-only .current-price {
      font-size: 16px;
      font-weight: 600;
      color: #1C2C58;
    }

    .product__sticky-price.desktop-only .original-price {
      font-size: 14px;
      font-weight: 400;
      color: #999;
      text-decoration: line-through;
      margin-top: 2px;
    }
    
    .sticky-variant-item {
      text-decoration: underline;
    }

    .product__sticky-image {
      flex-shrink: 0 !important;
      width: 110px !important;
    }
    
    .product__sticky-content {
      flex: 1 !important;
      margin-left: 0 !important;
    }
    
    .product__sticky-variants {
      display: block;
    }
    
    .desktop-price {
      display: none;
    }
    
    /* Show desktop buttons on desktop */
    .desktop-buttons {
      width: 100%;
      display: flex;
      gap: 10px;
      padding: 0;
      margin: 0;
      position: static;
      left: auto;
      right: auto;
      margin-left: 0;
      margin-right: 0;
    }
    
    /* Hide mobile buttons on desktop */
    .mobile-buttons {
      display: none !important;
    }
    
    .desktop-buttons .btn {
      width: 100%;
      border-radius: calc(var(--buttonRadius) * 0.5) !important;
      height: auto;
      font-size: var(--f-size-button);
      font-weight: 500;
      font-family: inherit !important;
      font-variant-numeric: normal !important;
      flex: 1;
      padding: 11px 20px;
    }
    
    .desktop-buttons .desktop-buy-now-btn {
      font-size: calc(var(--f-size-button) - 3px) !important;
    }
    
    .desktop-buy-now-text,
    .mobile-buy-now-text {
      font-size: inherit;
    }
    
    /* Ensure both desktop buttons have equal width */
    .desktop-buttons .custom-add-to-cart-btn,
    .desktop-buttons .desktop-buy-now-btn {
      flex: 1;
      min-width: 0;
    }
  }
  .sticky-add-to-cart__bar {
    --sticky-bar-bg: {{ section.settings.color_body_bg }};
    --sticky-bar-text-color: {{ section.settings.color_body_text }};
  }
  .add-to-cart.btn--secondary {
    background: #FCE390 !important;
    color: #000000 !important;
  }
</style>

<script>
  class StickyAddToCart extends HTMLElement {
    constructor() {
      super();
      this.anchor =
        this.closest('[id^=ProductSection-]').querySelector('[id^=ProductSubmitButton-]') ||
        this.closest('[id^=ProductSection-]');
      this.mark = document.querySelector('footer');
      this.inner = this.querySelector('.product__sticky-inner');
      this.toogle = this.querySelector('button[data-toggle]');
      this.variantSelect = this.querySelector('[data-product-select-sticky]');
      
      this.toogle?.addEventListener('click', this.toggleEvent.bind(this));
      
      this.variantSelect?.addEventListener('change', this.onVariantChange.bind(this));
    }

    connectedCallback() {
      setTimeout(() => {
        this.renderAnchorLink();
      }, 500);

      // Always show on mobile
      if (window.matchMedia('(max-width: 749px)').matches) {
        this.show();
      }

      this.onScrollHandler = this.onScroll.bind(this);
      window.addEventListener('scroll', this.onScrollHandler, false);
      
      // Listen for variant change events from main product form
      this.variantChangeHandler = this.onMainVariantChange.bind(this);
      document.addEventListener('variant:change', this.variantChangeHandler);
    }

    disconnectedCallback() {
      window.removeEventListener('scroll', this.onScrollHandler);
      document.removeEventListener('variant:change', this.variantChangeHandler);
    }
    
    onMainVariantChange(event) {
      if (!event.detail || !event.detail.variant) {
        return;
      }
      
      const variant = event.detail.variant;
      
      // Update sticky cart price
      if (variant.price) {
        const formattedPrice = this.formatMoney(variant.price);
        this.updateStickyPrice(formattedPrice);
      }
      
      // Update original price
      if (variant.compare_at_price && variant.price) {
        this.updateOriginalPrice(variant.compare_at_price, variant.price);
      } else {
        this.updateOriginalPrice(null, variant.price);
      }
      
      // Update variant options display
      if (variant.options && Array.isArray(variant.options)) {
        const cleanedOptions = variant.options.map(opt => opt.split('-')[0].trim());
        
        // Update mobile variant title
        const mobileTitleEl = this.querySelector('.sticky-variant-title');
        if (mobileTitleEl) {
          mobileTitleEl.textContent = cleanedOptions.join(' / ');
        }
        
        // Update desktop variant title
        const desktopContainer = this.querySelector('.desktop-only [data-header-option-container]');
        if (desktopContainer) {
          const newHtml = cleanedOptions.map(val => `<span class="sticky-variant-item">${val}</span>`).join(' ');
          desktopContainer.innerHTML = newHtml;
        }
      }
      
      // Update the hidden select if it exists
      if (this.variantSelect) {
        this.variantSelect.value = variant.id;
      }
    }

    onVariantChange(event) {
      const selectedOption = event.target.selectedOptions[0];
      if (selectedOption) {
        const variantData = selectedOption.textContent.split(' - ');
        const variantPrice = variantData[variantData.length - 1];
        this.updateStickyPrice(variantPrice.trim());

        // Update original price if available
        const variantId = selectedOption.value;
        let hasUpdatedOriginalPrice = false;
        
        // Try to get variant data from product JSON
        const productJson = document.querySelector('[data-product-json]');
        if (productJson) {
          try {
            const productData = JSON.parse(productJson.textContent);
            const variant = productData.variants.find(v => v.id == variantId);
            if (variant) {
              this.updateOriginalPrice(variant.compare_at_price, variant.price);
              hasUpdatedOriginalPrice = true;
            }
          } catch (e) {
            // Silent fail
          }
        }
        
        // Try to get from window.productData if available
        if (!hasUpdatedOriginalPrice && window.productData) {
          try {
            const variant = window.productData.variants.find(v => v.id == variantId);
            if (variant) {
              this.updateOriginalPrice(variant.compare_at_price, variant.price);
              hasUpdatedOriginalPrice = true;
            }
          } catch (e) {
            // Silent fail
          }
        }
        
        // Fallback: try to get from variant data element
        if (!hasUpdatedOriginalPrice) {
          const product = this.closest('[data-product-handle]');
          if (product) {
            const variantDataEl = product.querySelector('[data-variant-data]');
            if (variantDataEl) {
              try {
                const variantData = JSON.parse(variantDataEl.textContent);
                const variant = variantData[variantId];
                if (variant) {
                  this.updateOriginalPrice(variant.compare_at_price, variant.price);
                  hasUpdatedOriginalPrice = true;
                }
              } catch (e) {
                // Silent fail
              }
            }
          }
        }
        
        // Final fallback: try to extract from option text content
        if (!hasUpdatedOriginalPrice) {
          const optionText = selectedOption.textContent;
          const priceMatch = optionText.match(/(\d+[\.,]\d+)/g);
          if (priceMatch && priceMatch.length >= 2) {
            const currentPrice = parseFloat(priceMatch[priceMatch.length - 1].replace(',', '.'));
            const comparePrice = parseFloat(priceMatch[priceMatch.length - 2].replace(',', '.'));
            if (comparePrice > currentPrice) {
              this.updateOriginalPrice(comparePrice * 100, currentPrice * 100);
            }
          }
        }

        const optionValues = [];
        let i = 1;
        while(selectedOption.dataset[`option${i}`]) {
          const rawValue = selectedOption.dataset[`option${i}`];
          optionValues.push(rawValue.split('-')[0].trim());
          i++;
        }
        const cleanedTitle = optionValues.join(' / ');

        // Update variant title for mobile view
        const mobileTitleEl = this.querySelector('.sticky-variant-title');
        if (mobileTitleEl) {
          mobileTitleEl.textContent = cleanedTitle;
        }
        
        // Update variant title for desktop view
        const desktopContainer = this.querySelector('.desktop-only [data-header-option-container]');
        if (desktopContainer) {
          const newHtml = optionValues.map(val => `<span class="sticky-variant-item">${val}</span>`).join(' ');
          desktopContainer.innerHTML = newHtml;
        }
      }
    }

    updateStickyPrice(price) {
      const priceElements = this.querySelectorAll('[data-sticky-price]');
      priceElements.forEach(element => {
        // Update current price
        const currentPriceEl = element.querySelector('.current-price');
        if (currentPriceEl) {
          currentPriceEl.textContent = price;
        } else {
          // Fallback for old structure
          element.textContent = price;
        }
      });
    }

    updateOriginalPrice(compareAtPrice, currentPrice) {
      const priceElements = this.querySelectorAll('[data-sticky-price]');
      
      priceElements.forEach((element) => {
        const originalPriceEl = element.querySelector('.original-price');
        if (originalPriceEl) {
          if (compareAtPrice && compareAtPrice > currentPrice) {
            const formattedPrice = this.formatMoney(compareAtPrice);
            originalPriceEl.textContent = formattedPrice;
            originalPriceEl.style.display = 'block';
          } else {
            originalPriceEl.style.display = 'none';
          }
        }
      });
      
      // Also update mobile sticky price
      const mobilePriceEl = this.querySelector('.sticky-variant-price');
      if (mobilePriceEl) {
        const mobileOriginalPriceEl = mobilePriceEl.querySelector('.original-price');
        if (mobileOriginalPriceEl) {
          if (compareAtPrice && compareAtPrice > currentPrice) {
            const formattedPrice = this.formatMoney(compareAtPrice);
            mobileOriginalPriceEl.textContent = formattedPrice;
            mobileOriginalPriceEl.style.display = 'block';
          } else {
            mobileOriginalPriceEl.style.display = 'none';
          }
        }
      }
    }

    formatMoney(cents) {
      // Simple money formatting - you may need to adjust based on your theme's money format
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(cents / 100);
    }

    renderAnchorLink() {
      const divs = document.querySelectorAll('div[data-anchor-link="true"]');
      const linksWrap = this.querySelector('.sticky-navigation__links');

      divs.forEach((div) => {
        const text = div.getAttribute('data-anchor-link-text');
        if (text) {
          const href = text.toLowerCase().replace(/\s+/g, '-');
          const a = document.createElement('a');

          a.href = '#' + href;
          a.textContent = text;

          linksWrap.appendChild(a);
        }
      });
    }

    onScroll() {
      // Always show on mobile
      if (window.matchMedia('(max-width: 749px)').matches) {
        requestAnimationFrame(this.show.bind(this));
        this.style.top = 'auto';
        return;
      }
      
      // Desktop behavior
      if (this.anchor && this.check(this.anchor, 100)) {
        requestAnimationFrame(this.show.bind(this));

        setTimeout(() => {
          if (document.body.classList.contains('scroll-up')) {
            let height = document.querySelector('sticky-header').offsetHeight;
            if (document.querySelector('sticky-header').classList.contains('header-sticky__none')) {
              this.style.top = 0;
            } else {
              this.style.top = `${height}px`;
            }
          } else if (document.body.classList.contains('scroll-down')) {
            let height = document.querySelector('sticky-header').offsetHeight;
            if (document.querySelector('sticky-header').classList.contains('header-sticky__always')) {
              this.style.top = `${height}px`;
            } else {
              this.style.top = 0;
            }
          }
        });
      } else {
        requestAnimationFrame(this.hide.bind(this));
      }
    }

    check(element, threshold) {
      let rect = element.getBoundingClientRect().y;
      threshold = threshold ? threshold : 0;

      return rect + threshold < 0;
    }

    hide() {
      // Don't hide on mobile
      if (window.matchMedia('(max-width: 749px)').matches) {
        return;
      }
      
      this.classList.remove('active', 'full');
      document.body.classList.remove('sticky-atc-is-active')

      if (this.inner.style.maxHeight) this.inner.style.maxHeight = null;
    }

    show() {
      this.classList.add('active');
      document.body.classList.add('sticky-atc-is-active')
      
      window.matchMedia('(max-width: 749px)').matches &&
        document.body.style.setProperty('--p-b-xs', `${Math.floor(this.offsetHeight)}px`);
    }

    toggleEvent(event) {
      event.preventDefault();
      event.stopPropagation();

      if (this.inner.style.maxHeight) {
        this.inner.style.maxHeight = null;
      } else {
        this.inner.style.maxHeight = `${this.inner.scrollHeight}px`;
      }

      this.classList.toggle('full');
    }
  }

  customElements.define('sticky-add-to-cart', StickyAddToCart);
</script>
