{%- liquid
  assign product_form_id = product_form_id | append: '-duplicate'
  assign current_variant = product.selected_or_first_available_variant
-%}

<sticky-add-to-cart
  class="product__sticky flex ai-center fixed z-index-10 pointer-none no-js-hidden"
  id="product-sticky-{{ section.id }}-{{ product.id }}"
  data-section="{{ section.id }}"
>
  <nav class="product__sticky-navigation shrink-0 mobile-hidden">
    <div class="sticky-navigation__links flex ai-center gap-x"></div>
  </nav>
  <div class="product__stick-product-wrap flex ai-center jc-between gap-x-sm flex-1">
    {%- liquid
      assign product_media = product.media | where: 'media_type', 'image'
      assign media_count = product_media | size
      if media_count > 0
        if product.selected_or_first_available_variant.image
          assign image = product.selected_or_first_available_variant.image
        else
          assign image = product.featured_image.src
        endif
      endif

      assign Buybuttons = section.blocks | where: 'type', 'buy_buttons'
    -%}
    <div class="product__sticky-product desktop-only">
      {%- if media_count > 0 -%}
        <div class="product__sticky-image w-full shrink-0">
          <div
            class="relative ovh grid__image-ratio rounded-sm ovh"
            style="--padding-bottom: 100%;"
          >
            <img
              srcset="{{ image | img_url: '110x' }}"
              src="{{ image | img_url: '110x' }}"
              alt="{{ image.alt | default: product.title | escape }}"
              sizes="110"
              loading="lazy"
              width="110"
              height="110"
            >
          </div>
        </div>
      {%- endif -%}
      <div class="product__sticky-content">
        <h3 class="product__sticky-title fw-bold">{{ product.title }}</h3>
        <div class="product__sticky-price desktop-price">{{ current_variant.price | money }}</div>
        <div class="product__sticky-variants">
          {%- for option in product.options_with_values -%}
            <div class="label-select text-xs">
              <span data-header-option>{{ option.selected_value }}</span>
            </div>
          {%- endfor -%}
        </div>
      </div>
    </div>
    <div class="product__sticky-inner o-h">
      <div class="product__sticky-wrapper">
        {%- if Buybuttons.size > 0 -%}
          {%- if product != blank -%}
            {%- form 'product', product, id: product_form_id, class: 'product-single__sticky-form' -%}
              {%- liquid
                assign gift_card_recipient_feature_active = false
                if block.settings.show_gift_card_recipient and product.gift_card?
                  assign gift_card_recipient_feature_active = true
                endif
              -%}

              {%- if gift_card_recipient_feature_active -%}
                {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
              {%- endif -%}

              {%- liquid
                assign default_text = 'products.product.add_to_cart' | t
                assign button_text = 'products.product.add_to_cart' | t
                if template contains 'preorder'
                  assign default_text = 'products.product.preorder' | t
                  assign button_text = 'products.product.preorder' | t
                endif
                unless current_variant.available
                  assign button_text = 'products.product.sold_out' | t
                endunless
              -%}

              <!-- Desktop Button Layout -->
              <div class="sticky-buttons-wrapper desktop-buttons">
                <button
                  {% if product.empty? %}
                    type="button"
                  {% else %}
                    type="submit"
                  {% endif %}
                  name="add"
                  data-add-to-cart-sticky
                  id="ProductSubmitButtonSticky-{{ block.id }}-{{ product.id }}"
                  class="btn btn--full btn--secondary add-to-cart custom-add-to-cart-btn{% if enable_dynamic_buttons and product.selling_plan_groups == empty %} btn--secondary{% endif %}"
                  {% unless current_variant.available %}
                    disabled="disabled"
                  {% endunless %}
                >
                  <span class="icon-cart">{% render 'icon-cart-2' %}</span>
                  <span data-add-to-cart-text-sticky data-default-text="{{ default_text }}">
                    {{ button_text }}
                  </span>
                </button>
                
                <button
                  type="button"
                  class="btn btn--full btn--primary desktop-buy-now-btn"
                  data-buy-now-sticky
                >
                  <span class="desktop-buy-now-text" data-buy-now-price>Mua Ngay - {{ current_variant.price | money }}</span>
                </button>
              </div>

              <!-- Mobile Button Layout -->
              <div class="sticky-buttons-wrapper mobile-buttons mobile-only">
                <button
                  {% if product.empty? %}
                    type="button"
                  {% else %}
                    type="submit"
                  {% endif %}
                  name="add"
                  data-add-to-cart-sticky
                  class="btn btn--full btn--secondary add-to-cart mobile-add-to-cart-btn{% if enable_dynamic_buttons and product.selling_plan_groups == empty %} btn--secondary{% endif %}"
                  {% unless current_variant.available %}
                    disabled="disabled"
                  {% endunless %}
                >
                  <span class="icon-cart">{% render 'icon-cart-2' %}</span>
                  <span class="mobile-cart-text">Thêm vào giỏ hàng</span>
                </button>
                
                <button
                  type="button"
                  class="btn btn--full btn--primary buy-now-btn"
                  data-buy-now-sticky
                >
                  <span class="mobile-buy-now-text" data-buy-now-price>Mua Ngay - {{ current_variant.price | money }}</span>
                </button>
              </div>

              <select name="id" data-product-select-sticky class="product-single__variants no-js">
                {%- for variant in product.variants -%}
                  {%- if variant.available -%}
                    <option
                      {% if variant == product.selected_or_first_available_variant %}
                        selected="selected"
                      {% endif %}
                      value="{{ variant.id }}"
                    >
                      {{ variant.title }} - {{ variant.price | money_with_currency }}
                    </option>
                  {%- else -%}
                    <option disabled="disabled">{{ variant.title }} - {{ 'products.product.sold_out' | t }}</option>
                  {%- endif -%}
                {%- endfor -%}
              </select>
            {%- endform -%}

          {%- else -%}
          {%- endif -%}
        {%- endif -%}
      </div>
    </div>
  </div>
</sticky-add-to-cart>

<style>
  .product__sticky-content {
    margin-left: 15px;
  }
  
  .product__sticky-title {
    font-size: 14px;
    margin: 0 !important;
    padding: 0;
    line-height: 1.2;
  }
  
  .product__sticky-price {
    display: none;
    font-size: 12px;
    margin-bottom: 5px;
  }
  
  /* Desktop Only Elements - Always visible on desktop */
  .desktop-only {
    display: block;
  }
  
  /* Mobile Only Elements - Hidden by default */
  .mobile-only {
    display: none;
  }
  
  /* Desktop layout for product sticky */
  .product__sticky-product {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .product__sticky-image {
    flex-shrink: 0;
    width: 110px !important;
  }
  
  .product__sticky-content {
    flex: 1;
    margin-left: 0;
  }
  
  /* Custom button styles */
  .custom-add-to-cart-btn {
    background-color: #ffffff !important;
    border-color: #f97046 !important;
    color: #f97046 !important;
    border-radius: calc(var(--buttonRadius) * 0.5) !important;
    padding: 11px 20px !important;
    font-size: var(--f-size-button) !important;
    font-weight: 500 !important;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    font-family: inherit !important;
    font-variant-numeric: normal !important;
  }
  
  .custom-add-to-cart-btn:hover,
  .custom-add-to-cart-btn:focus {
    background-color: #f97046 !important;
    border-color: #f97046 !important;
    color: #ffffff !important;
  }
  
  /* Desktop Buy Now Button Styles */
  .desktop-buy-now-btn {
    background-color: #f97046 !important;
    border-color: #f97046 !important;
    color: #ffffff !important;
    border-radius: calc(var(--buttonRadius) * 0.5) !important;
    padding: 11px 20px !important;
    font-size: calc(var(--f-size-button) - 3px) !important;
    font-weight: 500 !important;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    font-family: inherit !important;
    font-variant-numeric: normal !important;
  }
  
  .desktop-buy-now-btn:hover,
  .desktop-buy-now-btn:focus {
    background-color: #e85a2b !important;
    border-color: #e85a2b !important;
    color: #ffffff !important;
  }
  
  .desktop-buy-now-btn.btn--loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  /* Mobile Button Styles */
  .mobile-buttons .mobile-add-to-cart-btn {
    background-color: #ffffff !important;
    border-color: #f97046 !important;
    color: #f97046 !important;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    font-family: inherit !important;
    font-variant-numeric: normal !important;
  }
  
  .mobile-buttons .mobile-add-to-cart-btn:hover,
  .mobile-buttons .mobile-add-to-cart-btn:focus {
    background-color: #f97046 !important;
    border-color: #f97046 !important;
    color: #ffffff !important;
  }
  
  /* Buy Now Button Styles - Mobile Only */
  .mobile-buttons .buy-now-btn {
    background-color: #f97046 !important;
    border-color: #f97046 !important;
    color: #ffffff !important;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    font-family: inherit !important;
    font-variant-numeric: normal !important;
  }
  
  .mobile-buttons .buy-now-btn:hover,
  .mobile-buttons .buy-now-btn:focus {
    background-color: #e85a2b !important;
    border-color: #e85a2b !important;
    color: #ffffff !important;
  }
  
  .mobile-buttons .buy-now-btn.btn--loading {
    opacity: 0.7;
    pointer-events: none;
  }
  
  /* Desktop Sticky Buttons Wrapper */
  .desktop-buttons {
    width: 100%;
    display: flex;
    gap: 10px;
  }
  
  /* Mobile Sticky Buttons Wrapper - Hidden by default */
  .mobile-buttons {
    display: none;
    width: 100%;
    gap: 0;
  }
  
  /* Hide payment buttons on mobile when setting is enabled */
  .hide-payment-mobile .payment-buttons {
    display: block;
  }
  
  /* Mobile styles */
  @media screen and (max-width: 749px) {
    /* Always show sticky cart on mobile */
    .product__sticky {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 1000 !important;
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      box-shadow: none !important;
    }
    
    /* Hide desktop elements on mobile */
    .desktop-only {
      display: none !important;
    }
    
    /* Show mobile elements on mobile */
    .mobile-only {
      display: block !important;
    }
    
    .product__stick-product-wrap {
      width: 100% !important;
    }
    
    .product__sticky-inner {
      width: 100% !important;
    }
    
    .product__sticky-wrapper {
      width: 100% !important;
    }
    
    .product-single__sticky-form {
      width: 100% !important;
    }
    
    .product__sticky.active {
      transform: translateY(0) !important;
    }
    
    /* Hide desktop buttons on mobile */
    .desktop-buttons {
      display: none !important;
    }
    
    /* Show mobile buttons on mobile */
    .mobile-buttons {
      width: 100vw !important;
      display: flex !important;
      gap: 0;
      padding: 0;
      margin: 0;
      position: relative;
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
    }
    
    .mobile-buttons .btn {
      border-radius: 0;
      height: 50px;
      font-size: 14px !important;
      font-weight: 600;
      font-family: inherit !important;
      font-variant-numeric: normal !important;
      flex: 1;
    }
    
    .mobile-buttons .buy-now-btn {
      font-size: 11px !important;
    }
    
    .mobile-buttons .btn:first-child {
      border-radius: 0;
      border-right: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .mobile-buttons .btn:last-child {
      border-radius: 0;
    }
    
    /* Hide payment buttons on mobile when setting is enabled */
    .hide-payment-mobile .payment-buttons {
      display: none !important;
    }
    
    /* Hide entire buy buttons form on mobile when setting is enabled */
    .hide-buy-buttons-mobile {
      display: none !important;
    }
    
    /* Hide product info completely on mobile */
    .product__sticky-product {
      display: none !important;
    }
    
    .product__sticky-image {
      display: none !important;
    }
    
    .product__sticky-content {
      display: none !important;
    }
  }
  
  /* Desktop styles */
  @media screen and (min-width: 750px) {
    /* Ensure desktop elements are visible */
    .desktop-only {
      display: block !important;
    }
    
    /* Hide mobile elements on desktop */
    .mobile-only {
      display: none !important;
    }
    
    /* Desktop flexbox layout for product info */
    .product__sticky-product {
      display: flex !important;
      align-items: center !important;
      gap: 15px !important;
    }
    
    .product__sticky-image {
      flex-shrink: 0 !important;
      width: 110px !important;
    }
    
    .product__sticky-content {
      flex: 1 !important;
      margin-left: 0 !important;
    }
    
    .product__sticky-variants {
      display: block;
    }
    
    .desktop-price {
      display: none;
    }
    
    /* Show desktop buttons on desktop */
    .desktop-buttons {
      width: 100%;
      display: flex;
      gap: 10px;
      padding: 0;
      margin: 0;
      position: static;
      left: auto;
      right: auto;
      margin-left: 0;
      margin-right: 0;
    }
    
    /* Hide mobile buttons on desktop */
    .mobile-buttons {
      display: none !important;
    }
    
    .desktop-buttons .btn {
      width: 100%;
      border-radius: calc(var(--buttonRadius) * 0.5) !important;
      height: auto;
      font-size: var(--f-size-button);
      font-weight: 500;
      font-family: inherit !important;
      font-variant-numeric: normal !important;
      flex: 1;
      padding: 11px 20px;
    }
    
    .desktop-buttons .desktop-buy-now-btn {
      font-size: calc(var(--f-size-button) - 3px) !important;
    }
    
    .desktop-buy-now-text,
    .mobile-buy-now-text {
      font-size: inherit;
    }
    
    /* Ensure both desktop buttons have equal width */
    .desktop-buttons .custom-add-to-cart-btn,
    .desktop-buttons .desktop-buy-now-btn {
      flex: 1;
      min-width: 0;
    }
  }
</style>

<script>
  class StickyAddToCart extends HTMLElement {
    constructor() {
      super();
      this.anchor =
        this.closest('[id^=ProductSection-]').querySelector('[id^=ProductSubmitButton-]') ||
        this.closest('[id^=ProductSection-]');
      this.mark = document.querySelector('footer');
      this.inner = this.querySelector('.product__sticky-inner');
      this.toogle = this.querySelector('button[data-toggle]');
      this.buyNowBtns = this.querySelectorAll('[data-buy-now-sticky]');
      this.variantSelect = this.querySelector('[data-product-select-sticky]');
      
      this.toogle?.addEventListener('click', this.toggleEvent.bind(this));
      
      // Add event listeners to all buy now buttons (desktop and mobile)
      this.buyNowBtns.forEach(btn => {
        btn.addEventListener('click', this.buyNowEvent.bind(this));
      });
      
      this.variantSelect?.addEventListener('change', this.onVariantChange.bind(this));
    }

    connectedCallback() {
      setTimeout(() => {
        this.renderAnchorLink();
      }, 500);

      // Reset all buy now buttons in case user came back to page
      this.resetBuyNowButtons();

      // Always show on mobile
      if (window.matchMedia('(max-width: 749px)').matches) {
        this.show();
      }

      this.onScrollHandler = this.onScroll.bind(this);
      window.addEventListener('scroll', this.onScrollHandler, false);
    }

    disconnectedCallback() {
      window.removeEventListener('scroll', this.onScrollHandler);
    }

    onVariantChange(event) {
      const selectedOption = event.target.selectedOptions[0];
      if (selectedOption) {
        const variantPrice = selectedOption.textContent.split(' - ')[1];
        this.updateBuyNowPrice(variantPrice);
      }
    }

    updateBuyNowPrice(price) {
      const buyNowPriceElements = this.querySelectorAll('[data-buy-now-price]');
      buyNowPriceElements.forEach(element => {
        element.textContent = `Mua Ngay - ${price}`;
      });
    }

    resetBuyNowButtons() {
      this.buyNowBtns.forEach(btn => {
        btn.classList.remove('btn--loading');
        btn.disabled = false;
      });
    }

    renderAnchorLink() {
      const divs = document.querySelectorAll('div[data-anchor-link="true"]');
      const linksWrap = this.querySelector('.sticky-navigation__links');

      divs.forEach((div) => {
        const text = div.getAttribute('data-anchor-link-text');
        if (text) {
          const href = text.toLowerCase().replace(/\s+/g, '-');
          const a = document.createElement('a');

          a.href = '#' + href;
          a.textContent = text;

          linksWrap.appendChild(a);
        }
      });
    }

    onScroll() {
      // Always show on mobile
      if (window.matchMedia('(max-width: 749px)').matches) {
        requestAnimationFrame(this.show.bind(this));
        this.style.top = 'auto';
        return;
      }
      
      // Desktop behavior
      if (this.anchor && this.check(this.anchor, 100)) {
        requestAnimationFrame(this.show.bind(this));

        setTimeout(() => {
          if (document.body.classList.contains('scroll-up')) {
            let height = document.querySelector('sticky-header').offsetHeight;
            if (document.querySelector('sticky-header').classList.contains('header-sticky__none')) {
              this.style.top = 0;
            } else {
              this.style.top = `${height}px`;
            }
          } else if (document.body.classList.contains('scroll-down')) {
            let height = document.querySelector('sticky-header').offsetHeight;
            if (document.querySelector('sticky-header').classList.contains('header-sticky__always')) {
              this.style.top = `${height}px`;
            } else {
              this.style.top = 0;
            }
          }
        });
      } else {
        requestAnimationFrame(this.hide.bind(this));
      }
    }

    check(element, threshold) {
      let rect = element.getBoundingClientRect().y;
      threshold = threshold ? threshold : 0;

      return rect + threshold < 0;
    }

    hide() {
      // Don't hide on mobile
      if (window.matchMedia('(max-width: 749px)').matches) {
        return;
      }
      
      this.classList.remove('active', 'full');
      document.body.classList.remove('sticky-atc-is-active')

      if (this.inner.style.maxHeight) this.inner.style.maxHeight = null;
    }

    show() {
      this.classList.add('active');
      document.body.classList.add('sticky-atc-is-active')
      
      window.matchMedia('(max-width: 749px)').matches &&
        document.body.style.setProperty('--p-b-xs', `${Math.floor(this.offsetHeight)}px`);
    }

    toggleEvent(event) {
      event.preventDefault();
      event.stopPropagation();

      if (this.inner.style.maxHeight) {
        this.inner.style.maxHeight = null;
      } else {
        this.inner.style.maxHeight = `${this.inner.scrollHeight}px`;
      }

      this.classList.toggle('full');
    }

    buyNowEvent(event) {
      event.preventDefault();
      event.stopPropagation();
      
      console.log('Buy Now clicked!', event.target); // Debug log
      
      // Get the current variant ID
      const variantSelect = this.querySelector('[data-product-select-sticky]');
      const variantId = variantSelect ? variantSelect.value : null;
      
      console.log('Variant ID:', variantId); // Debug log
      
      if (!variantId) {
        console.log('No variant ID found!'); // Debug log
        return;
      }

      // Add loading state to the clicked buy now button
      const buyNowBtn = event.target.closest('[data-buy-now-sticky]');
      if (buyNowBtn) {
        buyNowBtn.classList.add('btn--loading');
        buyNowBtn.disabled = true;
        
        // Reset button state after 3 seconds in case user comes back
        setTimeout(() => {
          buyNowBtn.classList.remove('btn--loading');
          buyNowBtn.disabled = false;
        }, 3000);
      }

      // Create a hidden form and submit it just like Shopify payment button does
      // This is exactly how {{ form | payment_button }} works internally
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/cart/add';
      
      // Add variant ID
      const variantInput = document.createElement('input');
      variantInput.type = 'hidden';
      variantInput.name = 'id';
      variantInput.value = variantId;
      
      // Add quantity 
      const quantityInput = document.createElement('input');
      quantityInput.type = 'hidden';
      quantityInput.name = 'quantity';
      quantityInput.value = '1';
      
      // Add return_to parameter - this is the key to making it work like payment button
      const returnToInput = document.createElement('input');
      returnToInput.type = 'hidden';
      returnToInput.name = 'return_to';
      returnToInput.value = '/checkout';
      
      // Append inputs to form
      form.appendChild(variantInput);
      form.appendChild(quantityInput);
      form.appendChild(returnToInput);
      
      // Append form to body and submit
      document.body.appendChild(form);
      form.submit();
    }
  }

  customElements.define('sticky-add-to-cart', StickyAddToCart);
</script>
