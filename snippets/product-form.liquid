{%- liquid
  assign form_classes = 'product-single__form'
  if hide_payment_button_mobile
    assign form_classes = form_classes | append: ' hide-buy-buttons-mobile'
  endif
-%}

{%- form 'product', product, id: form_id, class: form_classes -%}
  <div id="bundle-items-container"></div>
  {%- liquid
    assign gift_card_recipient_feature_active = false
    if block.settings.show_gift_card_recipient and product.gift_card?
      assign gift_card_recipient_feature_active = true
    endif

    assign enable_dynamic_buttons = false
    if show_dynamic_checkout and template != 'product.preorder' and gift_card_recipient_feature_active == false
      assign enable_dynamic_buttons = true
    endif
  -%}

  {%- if gift_card_recipient_feature_active -%}
    {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
  {%- endif -%}

<div class="product-form-actions{% if enable_dynamic_buttons %} has-buy-now{% endif %}">
  {%- liquid
    assign default_text = 'products.product.add_to_cart' | t
    assign button_text = 'products.product.add_to_cart' | t
    if template contains 'preorder'
      assign default_text = 'products.product.preorder' | t
      assign button_text = 'products.product.preorder' | t
    endif
    unless current_variant.available
      assign button_text = 'products.product.sold_out' | t
    endunless
  -%}

  {%- if enable_dynamic_buttons -%}
    {%- comment -%} Top row: Quantity + Add to Cart side by side {%- endcomment -%}
    <div class="actions-top-row">
      <div class="product__quantity-inline">
        {% assign qty_id = form_id | append: '-qty' %}
        {%- render 'quantity-input', form_id: form_id, id: qty_id, qty: 1, min: 1 -%}
      </div>
      
      <button
        {% if product.empty? %}
          type="button"
        {% else %}
          type="submit"
        {% endif %}
        name="add"
        data-add-to-cart
        id="ProductSubmitButton-{{ block.id }}-{{ product.id }}"
        class="btn btn--secondary add-to-cart{% if enable_dynamic_buttons and product.selling_plan_groups == empty %} btn--secondary{% endif %}"
        {% unless current_variant.available %}
          disabled="disabled"
        {% endunless %}
      >
        <span class="icon-cart">{% render 'icon-cart-2' %}</span>
        <span data-add-to-cart-text data-default-text="{{ default_text }}">
          {{ button_text }}
        </span>
      </button>
    </div>
    
    {%- comment -%} Bottom row: Buy Now + optional Hotline button {%- endcomment -%}
    {%- liquid
      assign show_hotline = false
      if block.settings.enable_hotline_button and block.settings.hotline_phone != blank
        assign show_hotline = true
      endif
    -%}
    <div class="actions-bottom-row{% if show_hotline %} has-hotline{% endif %}">
      <div class="payment-buttons{% if hide_payment_button_mobile %} hide-payment-mobile{% endif %}">
        {{ form | payment_button }}
      </div>
      {%- if show_hotline -%}
        <a
          class="btn btn--secondary product-hotline-button"
          href="tel:{{ block.settings.hotline_phone | strip | remove: ' ' }}"
        >
          {{ block.settings.hotline_label | default: 'Gọi tư vấn' }}
        </a>
      {%- endif -%}
    </div>
  {%- else -%}
    {%- comment -%} Default layout without Buy Now {%- endcomment -%}
    <button
      {% if product.empty? %}
        type="button"
      {% else %}
        type="submit"
      {% endif %}
      name="add"
      data-add-to-cart
      id="ProductSubmitButton-{{ block.id }}-{{ product.id }}"
      class="btn btn--full btn--secondary add-to-cart"
      {% unless current_variant.available %}
        disabled="disabled"
      {% endunless %}
    >
      <span class="icon-cart">{% render 'icon-cart-2' %}</span>
      <span data-add-to-cart-text data-default-text="{{ default_text }}">
        {{ button_text }}
      </span>
    </button>
  {%- endif -%}
</div>

  <div class="shopify-payment-terms product__policies">{{ form | payment_terms }}</div>

  <select name="id" data-product-select class="product-single__variants no-js">
    {%- for variant in product.variants -%}
      {%- if variant.available -%}
        <option
          {% if variant == product.selected_or_first_available_variant %}
            selected="selected"
          {% endif %}
          value="{{ variant.id }}"
        >
          {{ variant.title }} - {{ variant.price | money_with_currency }}
        </option>
      {%- else -%}
        <option disabled="disabled">{{ variant.title }} - {{ 'products.product.sold_out' | t }}</option>
      {%- endif -%}
    {%- endfor -%}
  </select>
{%- endform -%}
