{%- if settings.cart_type == 'drawer' -%}
  <style>
    /* General Drawer Styles */
    #CartDrawer {
      --font-stack-header: 'Be Vietnam Pro', serif;
      --font-stack-body: 'Be Vietnam Pro', sans-serif;
      --drawer-max-width: clamp(320px, 86vw, 490px);
      --drawer-horizontal-padding: clamp(16px, 5vw, 24px);
      --drawer-header-height: 120px;
      --drawer-footer-height: 220px;
      --drawer-actual-width: 390px; /* Default, will be updated by JS */
      font-family: var(--font-stack-body);
    }
    
    @supports (height: 100dvh) {
      #CartDrawer {
        height: 100dvh !important;
        min-height: 100dvh !important;
      }
    }
    
    #CartDrawer .bundle-header {
      padding: clamp(12px, calc(15px * var(--drawer-actual-width) / 390px), 15px) 0;
      font-weight: bold;
      font-size: clamp(14px, calc(18px * var(--drawer-actual-width) / 390px), 18px);
      color: #1C2C58;
      border-bottom: 1px solid #e9e9e9;
      margin-top: clamp(8px, calc(10px * var(--drawer-actual-width) / 390px), 10px);
    }
    
    #CartDrawer .bundle-header__content {
      padding: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(12px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
    }
    
    #CartDrawer .bundle-header__content h4 {
      font-size: clamp(14px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
    }
    
    #CartDrawer .bundle-voucher {
      font-size: clamp(12px, calc(14px * var(--drawer-actual-width) / 390px), 14px) !important;
    }

    #CartDrawer .cart__item--bundle-item {
      background-color: #F0F7FF;
      border-color: transparent;
      padding: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(12px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
    }
    
    /* Auto-add gift item styling */
    #CartDrawer .cart__item--auto-add-gift {
      background-color: #FFF9E6 !important;
      border-left: 4px solid #FFB800 !important;
      padding: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(12px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
      margin: 0 0 10px 0 !important;
      border-radius: 8px !important;
      position: relative;
    }
    
    /* Disable clicks on gift items */
    #CartDrawer .cart__item--auto-add-gift a {
      pointer-events: none !important;
      cursor: default !important;
    }
    
    #CartDrawer .cart__item--auto-add-gift .cart-item__title {
      pointer-events: none !important;
      cursor: default !important;
      color: inherit !important;
      text-decoration: none !important;
    }
    
    #CartDrawer .cart__item--auto-add-gift .cart__image a,
    #CartDrawer .cart__item--auto-add-gift .cart__image .image-wrap {
      pointer-events: none !important;
      cursor: default !important;
    }
    
    #CartDrawer .cart-item__gift-badge {
      display: inline-block !important;
      background: #FFB800 !important;
      color: #fff !important;
      padding: 4px 10px !important;
      border-radius: 4px !important;
      font-size: 12px !important;
      font-weight: 600 !important;
      font-family: "Be Vietnam Pro", sans-serif !important;
      margin-top: 4px !important;
      line-height: 1.4 !important;
    }
    
    #CartDrawer .cart-item__gift-price {
      color: #FFB800 !important;
      font-weight: 600 !important;
      font-size: clamp(12px, calc(14px * var(--drawer-actual-width) / 390px), 14px) !important;
    }
    
    /* Hide quantity controls for auto-add gift items */
    #CartDrawer .cart__item--auto-add-gift .cart-item__footer {
      display: none !important;
    }
    
    /* Desktop: Smaller drawer width */
    @media (min-width: 769px) {
      #CartDrawer {
        width: min(var(--drawer-max-width), 100vw) !important;
        max-width: min(var(--drawer-max-width), 100vw) !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      #CartDrawer .drawer__inner {
        width: min(var(--drawer-max-width), 100vw) !important;
        max-width: min(var(--drawer-max-width), 100vw) !important;
      }
      #CartDrawer.drawer--is-open {
        transform: translateX(0) !important;
      }
    }
    
    /* Mobile: Full screen drawer - Responsive based on 390px */
    @media (max-width: 768px) {
      #CartDrawer {
        width: 100% !important;
        max-width: 100% !important;
      }
      #CartDrawer .drawer__inner {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Update all responsive values to use drawer actual width instead of viewport width */
      .cart__image {
        width: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px) !important;
        height: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px) !important;
        min-width: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px) !important;
        min-height: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px) !important;
        border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px) !important;
      }
      .cart__image .image-wrap img,
      .cart__image .image-wrap image-element img,
      .cart__image .image-wrap picture img {
        border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px) !important;
      }
      .cart-item__title {
        font-size: clamp(14px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
        margin-bottom: clamp(4px, calc(6px * var(--drawer-actual-width) / 390px), 6px) !important;
      }
      .cart-item__variant {
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) !important;
        margin-bottom: clamp(2px, calc(3px * var(--drawer-actual-width) / 390px), 3px) !important;
      }
      .cart-item__price-wrapper {
        gap: clamp(6px, calc(10px * var(--drawer-actual-width) / 390px), 10px) !important;
      }
      .cart-item__price--original,
      .cart-item__price--final {
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) !important;
      }
      #CartDrawer .js-qty__wrapper {
        width: clamp(80px, calc(103px * var(--drawer-actual-width) / 390px), 103px) !important;
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
        border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px) !important;
        padding-left: clamp(3px, calc(4px * var(--drawer-actual-width) / 390px), 4px) !important;
      }
      #CartDrawer .js-qty__adjust {
        width: clamp(24px, calc(30px * var(--drawer-actual-width) / 390px), 30px) !important;
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
        font-size: clamp(14px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
      }
      #CartDrawer .js-qty__num {
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
        font-size: clamp(14px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
      }
      .cart-item__footer {
        align-self: start !important;
      }
      #CartDrawer .cart-drawer__savings {
        min-height: clamp(50px, calc(59px * var(--drawer-actual-width) / 390px), 59px) !important;
        margin: 0 0 clamp(15px, calc(20px * var(--drawer-actual-width) / 390px), 20px) 0 !important;
        padding: clamp(12px, calc(15px * var(--drawer-actual-width) / 390px), 15px) 0 clamp(14px, calc(18px * var(--drawer-actual-width) / 390px), 18px) 0 !important;
      }
      #CartDrawer .cart-drawer__savings::before {
        bottom: calc(clamp(7px, calc(9px * var(--drawer-actual-width) / 390px), 9px) - clamp(1.5px, calc(2.5px * var(--drawer-actual-width) / 390px), 2.5px)) !important;
        height: clamp(3px, calc(5px * var(--drawer-actual-width) / 390px), 5px) !important;
        border-radius: clamp(2px, calc(2.5px * var(--drawer-actual-width) / 390px), 2.5px) !important;
      }
      #CartDrawer .cart-drawer__savings-text {
        font-size: clamp(12px, calc(14px * var(--drawer-actual-width) / 390px), 14px) !important;
        padding: 0 !important;
        margin: 0 auto clamp(8px, calc(10px * var(--drawer-actual-width) / 390px), 10px) !important;
        width: 100% !important;
        max-width: 100% !important;
        text-align: center !important;
      }
      #CartDrawer .cart-drawer__savings-badge {
        right: clamp(44px, calc(44px * var(--drawer-actual-width) / 390px), 44px) !important;
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) !important;
        padding: 0 clamp(8px, calc(10px * var(--drawer-actual-width) / 390px), 10px) !important;
        height: clamp(14px, calc(18px * var(--drawer-actual-width) / 390px), 18px) !important;
        width: clamp(40px, calc(53px * var(--drawer-actual-width) / 390px), 53px) !important;
        border-radius: clamp(7px, calc(9px * var(--drawer-actual-width) / 390px), 9px) !important;
      }
      .cross-sell-item__image {
        width: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px) !important;
        height: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px) !important;
        min-width: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px) !important;
        min-height: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px) !important;
        border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px) !important;
      }
      .cross-sell-item__image img {
        border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px) !important;
      }
      .cross-sell-item__quantity-wrapper {
        width: clamp(60px, calc(70px * var(--drawer-actual-width) / 390px), 70px) !important;
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
      }
      .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust {
        width: clamp(18px, calc(20px * var(--drawer-actual-width) / 390px), 20px) !important;
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) !important;
      }
      .cross-sell-item__quantity-wrapper .cross-sell-qty__num {
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) !important;
      }
      .cross-sell-item__add-btn {
        width: clamp(60px, calc(77px * var(--drawer-actual-width) / 390px), 70px) !important;
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px) !important;
        padding: clamp(8px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(10px, calc(15px * var(--drawer-actual-width) / 390px), 15px) !important;
      }
      
      /* Mobile: Fixed footer full width - Always visible, not hidden by browser UI */
      /* Footer is part of scrollable content - no fixed position */
      #CartDrawer .drawer__footer {
        position: relative !important;
        width: 100% !important;
        background: #fff !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        /* Responsive padding: 480px = 18px, scale down proportionally */
        padding-bottom: calc(clamp(14px, calc(28px * (100vw / 480px)), 28px) + env(safe-area-inset-bottom)) !important;
      }

      /* Scrollable area - no max-height, can grow freely */
      #CartDrawer .drawer__scrollable {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        flex-grow: 1;
        flex-shrink: 1;
        min-height: 0;
        width: 100%;
        max-height: none !important;
        /* Add padding-bottom to ensure last element is fully visible */
        padding-bottom: calc(40px + env(safe-area-inset-bottom)) !important;
      }
      
      /* Footer content wrapper on mobile - ensure proper constraints */
      #CartDrawer .drawer__footer [data-cart-footer] {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        padding: 0 !important;
      }
      
      /* Summary section on mobile */
      #CartDrawer .cart-drawer__summary {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
      }
    }
    
    /* Ensure drawer is properly positioned and visible */
    #CartDrawer {
      position: fixed !important;
      top: 0 !important;
      right: 0 !important;
      height: 100vh !important;
      min-height: 100vh !important;
      width: min(var(--drawer-max-width), 100vw) !important;
      max-width: min(var(--drawer-max-width), 100vw) !important;
      z-index: 1000 !important;
      background: #fff !important;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1) !important;
      transform: translateX(100%) !important;
      transition: transform 0.3s ease !important;
      visibility: hidden !important;
      opacity: 0 !important;
      box-sizing: border-box !important;
    }
    
    #CartDrawer.drawer--is-open {
      transform: translateX(0) !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Hide sticky add-to-cart when cart drawer is open */
    #CartDrawer.drawer--is-open ~ sticky-add-to-cart,
    body:has(#CartDrawer.drawer--is-open) sticky-add-to-cart {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    /* --- BUNDLE FOOTER STYLES --- */
    /* Nối sản phẩm cuối cùng với footer */
    .cart__item--bundle-item.is-before-footer {
      margin-bottom: 0 !important;
      border-bottom: none !important;
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }
    /* Style cho footer chung của bundle */
    .bundle-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background-color: #F0F7FF;
      border-left: 4px solid #234085;
      border-radius: 0 0 8px 8px;
      margin-bottom: 12px;
    }
    .bundle-footer .js-qty__wrapper {
      border: 1px solid #E5E7EB;
      border-radius: 5px;
      overflow: hidden;
      background: #fff;
    }
    .bundle-footer .js-qty__num {
      background-color: #fff;
      border: none;
    }
    .bundle-footer .cart-item__remove {
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
    }

    #CartDrawer .cross-sell-item__title a {
      border-bottom: none !important;
      font-size: clamp(12px, calc(16px * var(--drawer-actual-width) / 390px), 16px);
      color: #1C2C58;
    }
    #CartDrawer .drawer__inner {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      max-height: 100vh;
      overflow: hidden;
    }
    #CartDrawer .drawer__fixed-header {
      position: relative;
      flex-shrink: 0;
    }
    #CartDrawer .drawer__scrollable {
      overflow-y: auto !important;
      overflow-x: hidden !important;
      flex-grow: 1;
      flex-shrink: 1;
      scrollbar-width: none; /* For Firefox */
      -ms-overflow-style: none; /* For Internet Explorer and Edge */
      min-height: 0; /* Allow flex item to shrink below content size */
      width: 100%;
      max-height: none !important;
      /* Add padding-bottom to ensure last element is fully visible */
      padding-bottom: calc(40px + env(safe-area-inset-bottom)) !important;
    }
    #CartDrawer .drawer__header {
      padding: 20px 0 15px 0;
      margin-bottom: 0;
      position: static;
      background: #fff;
      display: block;
      width: 100%;
      flex-shrink: 0;
      z-index: 10;
    }
    
    #CartDrawer .drawer__header .drawer__title {
      font-family: var(--font-stack-body);
      width: 344px;
      height: 39px;
      flex-shrink: 0;
      color: #1C2C58;
      font-size: clamp(22px, calc(30px * var(--drawer-actual-width) / 390px), 30px);
      font-style: normal;
      font-weight: 600;
      line-height: 120%;
    }
    
    /* Desktop: Title font-size 38px */
    @media (min-width: 769px) {
      #CartDrawer .drawer__header .drawer__title {
        font-size: clamp(30px, calc(38px * var(--drawer-actual-width) / 490px), 38px) !important;
      }
    }
    
    #CartDrawer .drawer__header .drawer__count {
      font-family: var(--font-stack-body);
      font-size: 16px;
    }
    
    /* Desktop only - Force header visibility */
    @media (min-width: 769px) {
      #CartDrawer .drawer__header {
        background: #fff !important;
        display: block !important;
        width: 100% !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      #CartDrawer .drawer__header .drawer__title {
        display: block !important;
        visibility: visible !important;
        font-size: clamp(30px, calc(38px * var(--drawer-actual-width) / 490px), 38px) !important;
      }
      
      #CartDrawer .drawer__header .drawer__count {
        display: block !important;
        visibility: visible !important;
        color: #000 !important;
      }
      
      /* Ensure drawer scrollable works on desktop */
      #CartDrawer .drawer__scrollable {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        flex-grow: 1;
        flex-shrink: 1;
        min-height: 0;
        width: 100%;
        max-height: none !important;
        /* Add padding-bottom to ensure last element is fully visible */
        padding-bottom: calc(40px + env(safe-area-inset-bottom)) !important;
      }
      
      /* Desktop: Footer is part of scrollable content */
      #CartDrawer .drawer__footer {
        position: relative !important;
        width: 100% !important;
        background: #fff !important;
        padding-bottom: calc(clamp(20px, 3vw, 28px) + env(safe-area-inset-bottom)) !important;
      }
    }
    
    #CartDrawer .cart-empty-message {
      padding: 40px 20px;
      text-align: center;
      font-size: 16px;
      color: #666;
    }
    #CartDrawer .drawer__scrollable::-webkit-scrollbar {
      display: none; /* For Chrome, Safari, and Opera */
    }
    
    /* Remove gray line above drawer__scrollable */
    #CartDrawer .drawer__scrollable {
      border-top: none !important;
    }
    
    #CartDrawer .drawer__scrollable::before {
      display: none !important;
    }
    #CartDrawer .drawer__header .drawer__title {
      font-family: var(--font-stack-body);
      width: clamp(260px, calc(344px * var(--drawer-actual-width) / 390px), 344px);
      height: clamp(30px, calc(39px * var(--drawer-actual-width) / 390px), 39px);
      flex-shrink: 0;
      color: #1C2C58;
      font-size: clamp(22px, calc(30px * var(--drawer-actual-width) / 390px), 30px);
      font-style: normal;
      font-weight: 600;
      line-height: 120%;
      box-sizing: border-box;
    }
    #CartDrawer .drawer__header .drawer__count {
      font-family: var(--font-stack-body);
      font-size: clamp(14px, calc(16px * (100vw / 480px)), 16px);
    }


    /* Cart Items - Responsive based on 390px */
    .cart-item__title {
      color: #1C2C58 !important;
      font-family: "Be Vietnam Pro" !important;
      font-size: clamp(14px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
      font-style: normal !important;
      font-weight: 700 !important;
      line-height: 150% !important;
      margin-bottom: clamp(4px, calc(6px * var(--drawer-actual-width) / 390px), 6px);
    }
    
    /* Desktop: Title Font Size 16px */
    @media (min-width: 769px) {
      .cart-item__title {
        font-size: 16px !important;
      }
    }

    .cart-item__variant {
      overflow: hidden;
      color: #000;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      margin-bottom: clamp(2px, calc(3px * var(--drawer-actual-width) / 390px), 3px);
    }
    
    /* Desktop: Variant Font Size 14px */
    @media (min-width: 769px) {
      .cart-item__variant {
        font-size: 14px !important;
      }
    }

    .cart-item__price-wrapper {
      display: flex;
      align-items: center;
      gap: clamp(6px, calc(10px * var(--drawer-actual-width) / 390px), 10px);
      margin: 0;
      flex-wrap: nowrap;
    }
    .cart-item__price--original {
      overflow: hidden;
      color: #808080;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      text-decoration-line: line-through;
      order: 2;
    }
    
    /* Desktop: Original Price Font Size 14px */
    @media (min-width: 769px) {
      .cart-item__price--original {
        font-size: 14px !important;
      }
    }

    .cart-item__price--final {
      overflow: hidden;
      color: #1C2C58;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      order: 1;
    }

    /* Desktop: Final Price Font Size 14px */
    @media (min-width: 769px) {
      .cart-item__price--final {
        font-size: 14px !important;
      }
    }

    .cart-drawer__free-shipping-info {
      padding: clamp(10px, calc(15px * (100vw / 480px)), 15px);
      text-align: center;
      color: #1C2C58;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(12px, calc(14px * (100vw / 480px)), 14px);
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      margin: 0;
      position: static;
      background: #fff;
      width: 100%;
      box-sizing: border-box;
    }

    /* Cart Item Layout - Responsive based on 390px */
    .cart__item {
      display: grid;
      grid-template-columns: auto 1fr;
      grid-template-rows: auto auto;
      gap: 0;
      padding: 0;
      border-bottom: none;
      margin: 0 0 10px 0;
      position: static;
      background: #fff;
      width: 100%;
      box-sizing: border-box;
    }
    .cart__image {
      grid-column: 1;
      grid-row: 1;
      width: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px);
      height: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px);
      min-width: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px);
      min-height: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px);
      border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px);
      overflow: hidden;
      position: relative;
    }
    .cart__image .image-wrap {
      width: 100%;
      height: 100%;
      display: block;
      position: relative;
      overflow: hidden;
    }
    .cart__image .image-wrap image-element,
    .cart__image .image-wrap picture {
      width: 100%;
      height: 100%;
      display: block;
      position: relative;
    }
    .cart__image .image-wrap img,
    .cart__image .image-wrap image-element img,
    .cart__image .image-wrap picture img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      object-position: center !important;
      display: block;
      border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px);
    }
    .cart__image .image-wrap image-element {
      width: 100%;
      height: 100%;
      display: block;
    }
    .cart__item-details {
      grid-column: 2;
      grid-row: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      min-width: 0;
      overflow: visible;
      position: relative;
      z-index: 1;
    }
    .cart-item__footer {
      grid-column: 2;
      grid-row: 2;
      display: flex;
      justify-content: flex-start;
      align-items: flex-start;
      align-self: start;
      width: auto;
      box-sizing: border-box;
    }
    /* Remove button is hidden for regular cart items (only shown in bundle footer) */
    .cart-item__footer .cart-item__remove {
      display: none !important;
    }
    
    /* Bundle footer remove button is still visible */
    .bundle-footer .cart-item__remove {
      display: inline-flex !important;
      font-family: var(--font-stack-body);
      font-size: clamp(12px, calc(14px * var(--drawer-actual-width) / 390px), 14px);
      text-decoration: none;
      color: #25282B;
      align-items: center;
      justify-content: center;
      width: clamp(20px, calc(24px * var(--drawer-actual-width) / 390px), 24px);
      height: clamp(20px, calc(24px * var(--drawer-actual-width) / 390px), 24px);
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
      flex-shrink: 0;
    }
    .bundle-footer .cart-item__remove svg {
      width: clamp(20px, calc(24px * var(--drawer-actual-width) / 390px), 24px);
      height: clamp(20px, calc(24px * var(--drawer-actual-width) / 390px), 24px);
    }
    
    /* Quantity Selector - Copy style from cross-sell-item__quantity-wrapper, keep background-color */
    #CartDrawer .js-qty__wrapper {
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: nowrap !important;
      width: clamp(90px, calc(120px * var(--drawer-actual-width) / 390px), 120px);
      height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px);
      align-items: center;
      gap: 0;
      flex-shrink: 0;
      border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px);
      border: 1px solid #E5E7EB;
      background: #F5F9FF; /* Keep original background color */
      overflow: hidden;
      position: relative;
      box-sizing: border-box;
      justify-content: flex-start;
      padding-left: clamp(3px, calc(4px * var(--drawer-actual-width) / 390px), 4px);
      padding-right: 0;
    }
    
    #CartDrawer .js-qty__wrapper > * {
      position: relative !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    #CartDrawer .js-qty__adjust {
      width: clamp(24px, calc(30px * var(--drawer-actual-width) / 390px), 30px) !important;
      height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
      min-width: clamp(24px, calc(30px * var(--drawer-actual-width) / 390px), 30px) !important;
      max-width: clamp(24px, calc(30px * var(--drawer-actual-width) / 390px), 30px) !important;
      border: none !important;
      background: transparent !important;
      color: #000;
      font-size: clamp(14px, calc(16px * var(--drawer-actual-width) / 390px), 16px);
      font-weight: 600;
      font-family: "Be Vietnam Pro", sans-serif;
      cursor: pointer;
      display: flex !important;
      align-items: center;
      justify-content: center;
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      position: relative !important;
      top: auto !important;
      bottom: auto !important;
      left: auto !important;
      right: auto !important;
      z-index: 1;
      padding: 0 !important;
      margin: 0 !important;
      outline: none;
      box-sizing: border-box;
      line-height: 1.5;
    }
    
    #CartDrawer .js-qty__adjust:hover {
      background: transparent;
    }
    
    #CartDrawer .js-qty__adjust:active {
      background: transparent;
    }
    
    #CartDrawer .js-qty__adjust--minus {
      border: none !important;
      left: auto !important;
      right: auto !important;
    }
    
    #CartDrawer .js-qty__adjust--plus {
      border: none !important;
      left: auto !important;
      right: auto !important;
    }
    
    #CartDrawer .js-qty__num {
      flex: 1;
      height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px);
      min-width: 0;
      border: none !important;
      background: #F5F9FF !important; /* Match wrapper background */
      text-align: center;
      font-size: clamp(14px, calc(16px * var(--drawer-actual-width) / 390px), 16px);
      font-weight: 400;
      font-family: "Be Vietnam Pro", sans-serif;
      box-sizing: border-box;
      color: #1C2C58;
      outline: none;
      padding: 0 !important;
      margin: 0 !important;
      min-width: 0;
      position: relative !important;
      z-index: 1;
      display: block !important;
      width: auto !important;
      line-height: 1.5;
    }
    
    /* Bundle footer quantity wrapper */
    .bundle-footer .js-qty__wrapper {
      min-width: clamp(60px, calc(80px * (100vw / 480px)), 80px);
      max-width: clamp(60px, calc(128px * (100vw / 480px)), 128px);
      width: clamp(60px, calc(80px * (100vw / 480px)), 80px);
      box-sizing: border-box;
    }
    
    /* 
    To implement the SVG icon for cart-item__remove, replace the text content 
    with this SVG in your cart item template or JavaScript:
    
    <button class="cart-item__remove" data-cart-remove>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M3 6H5H21" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M10 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    */
    
    /* Discount Code */
    .cart-drawer__discount-header {
        overflow: hidden;
        color: #1C2C58;
        text-align: left;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: "Be Vietnam Pro", sans-serif;
        font-size: clamp(14px, calc(16px * (100vw / 480px)), 16px);
        font-style: normal;
        font-weight: 400;
        line-height: 150%;
        margin: clamp(12px, calc(20px * (100vw / 480px)), 20px) 0 clamp(6px, calc(10px * (100vw / 480px)), 10px);
    }
    .cart-drawer__discount-form {
      display: flex !important;
      justify-content: center;
      align-items: stretch;
      gap: 0;
      max-width: clamp(300px, calc(400px * (100vw / 480px)), 400px);
      margin: 0 auto;
      flex-direction: row;
      width: 100%;
      box-sizing: border-box;
    }
    .cart-drawer__discount-input {
      width: 70%;
      flex-grow: 1;
      height: clamp(32px, calc(38px * (100vw / 480px)), 38px);
      border-radius: clamp(6px, calc(8px * (100vw / 480px)), 8px) 0 0 clamp(6px, calc(8px * (100vw / 480px)), 8px);
      background: #F0F7FF;
      border: 1px solid #D1E5FF;
      border-right: none;
      padding: 0 clamp(10px, calc(15px * (100vw / 480px)), 15px);
      font-family: var(--font-stack-body);
      font-size: clamp(12px, calc(14px * (100vw / 480px)), 14px);
      display: inline-block;
      box-sizing: border-box;
    }
    .cart-drawer__discount-button {
      width: 28%;
      background: #759CE6;
      color: white;
      border: 1px solid #759CE6;
      border-radius: 0 clamp(6px, calc(8px * (100vw / 480px)), 8px) clamp(6px, calc(8px * (100vw / 480px)), 8px) 0;
      padding: 0 clamp(12px, calc(20px * (100vw / 480px)), 20px);
      cursor: pointer;
      font-family: var(--font-stack-body);
      font-size: clamp(12px, calc(14px * (100vw / 480px)), 14px);
      height: clamp(32px, calc(38px * (100vw / 480px)), 38px);
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      box-sizing: border-box;
    }
    .cart-drawer__voucher-carousel {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: clamp(10px, calc(15px * (100vw / 480px)), 15px) 0;
      position: relative;
      box-sizing: border-box;
    }
    .cart-drawer__voucher-carousel-inner {
      overflow: hidden;
      width: 100%;
      box-sizing: border-box;
    }
    .cart-drawer__voucher-list {
      display: flex;
      gap: clamp(6px, calc(10px * (100vw / 480px)), 10px);
      transition: transform 0.3s ease-in-out;
      overflow: hidden;
    }
    .cart-drawer__voucher-item {
      position: relative;
      flex: 0 0 auto;
    }
    .cart-drawer__voucher-item img {
      display: block;
      width: clamp(100px, calc(130px * (100vw / 480px)), 130px);
      height: auto;
      border-radius: clamp(6px, calc(8px * (100vw / 480px)), 8px);
    }
      .voucher-copy-button {
        position: absolute;
        bottom: clamp(6px, calc(8px * (100vw / 480px)), 8px);
        width: clamp(2.5rem, calc(3.5rem * (100vw / 480px)), 3.875rem);
        height: clamp(6px, calc(8px * (100vw / 480px)), 32px);
        right: clamp(10px, calc(15px * (100vw / 480px)), 15px);
        background: #759CE6;
        color: white;
        border: none;
        border-radius: clamp(3px, calc(4px * (100vw / 480px)), 4px);
        cursor: pointer;
        font-size: clamp(6px, calc(6px * (100vw / 480px)), 12px);
        font-weight: 400;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(2px, calc(4px * (100vw / 480px)), 4px) clamp(6px, calc(8px * (100vw / 480px)), 8px);
        box-sizing: border-box;
        white-space: nowrap;
      }
      
      .voucher-copy-button:hover {
        background: #6B8CDB;
      }
      
      .voucher-copy-button:active,
      .voucher-copy-button.copied {
        background: #ccc;
        color: #333;
      }
    .cart-drawer__carousel-arrow {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0 clamp(6px, calc(10px * (100vw / 480px)), 10px);
      flex-shrink: 0;
      box-sizing: border-box;
    }

    /* Cart Summary */
    #CartDrawer .cart-drawer__summary {
      padding: 5px 0;
      background: #fff;
      width: 100%;
      opacity: 1 !important;
      transform: none !important;
      visibility: visible !important;
    }
    
    #CartDrawer .drawer__footer {
      opacity: 1 !important;
      transform: none !important;
      visibility: visible !important;
    }
    
    /* Footer content wrapper - ensure proper width constraints */
    #CartDrawer .drawer__footer [data-cart-footer] {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }
    
    #CartDrawer .cart-drawer__summary-item {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-stack-body);
      /* Responsive font size: 480px = 16px, scale down proportionally */
      font-size: clamp(12px, calc(16px * (100vw / 480px)), 16px);
      padding: clamp(3px, calc(5px * (100vw / 480px)), 5px) 0;
    }

    /* Responsive font sizes for mobile - 480px as base */
    @media (max-width: 480px) {
      /* Ensure footer is always visible and not hidden by browser UI (Chrome tabs) */
      #CartDrawer .drawer__footer {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        margin-bottom: 0 !important;
      }

      /* Scrollable area - no max-height, can grow freely */
      #CartDrawer .drawer__scrollable {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        flex-grow: 1;
        flex-shrink: 1;
        min-height: 0;
        width: 100%;
        max-height: none !important;
        /* Add padding-bottom to ensure last element is fully visible */
        padding-bottom: calc(40px + env(safe-area-inset-bottom)) !important;
      }

      /* Responsive font sizes */
      #CartDrawer .cart-drawer__summary-item {
        font-size: calc(16px * (100vw / 480px));
      }
      #CartDrawer .cart-drawer__summary-item .price--original {
        font-size: calc(16px * (100vw / 480px));
      }
      #CartDrawer .cart-drawer__summary-item .price--final {
        font-size: calc(18px * (100vw / 480px));
      }
      /* Discount item responsive - same as summary-item */
      #CartDrawer .cart-drawer__discount-item {
        font-size: calc(16px * (100vw / 480px));
        padding: calc(5px * (100vw / 480px)) 0;
      }
      #CartDrawer .cart-drawer__discount-title {
        font-size: calc(16px * (100vw / 480px));
      }
      #CartDrawer .cart-drawer__discount-amount {
        font-size: calc(16px * (100vw / 480px));
      }
      #CartDrawer .cart-drawer__discount-right {
        gap: calc(8px * (100vw / 480px));
      }
      #CartDrawer .cart-drawer__discount-remove {
        padding: calc(4px * (100vw / 480px));
      }
      #CartDrawer .cart-drawer__discount-remove svg {
        width: calc(16px * (100vw / 480px));
        height: calc(16px * (100vw / 480px));
      }
      #CartDrawer .cart-drawer__savings {
        font-size: clamp(12px, calc(14px * (100vw / 480px)), 14px);
      }
      #CartDrawer .btn {
        font-size: clamp(14px, calc(16px * (100vw / 480px)), 16px);
        padding: clamp(10px, calc(12px * (100vw / 480px)), 12px) clamp(20px, calc(24px * (100vw / 480px)), 24px);
      }
    }
    #CartDrawer .cart-drawer__summary-item .price-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #CartDrawer .cart-drawer__summary-item .price--original {
      overflow: hidden;
      color: #808080;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      /* Responsive font size: 480px = 16px, scale down proportionally */
      font-size: clamp(12px, calc(16px * (100vw / 480px)), 16px);
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      text-decoration-line: line-through;
    }
    #CartDrawer .cart-drawer__summary-item .price--final {
      overflow: hidden;
      color: #1C2C58;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      /* Responsive font size: 480px = 18px, scale down proportionally */
      font-size: clamp(14px, calc(18px * (100vw / 480px)), 18px);
      font-style: normal;
      font-weight: 700;
      line-height: 150%;
    }
    
    /* Discount Applications Styling */
    #CartDrawer .cart-drawer__discount-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: var(--font-stack-body);
      /* Responsive font size: 480px = 16px, scale down proportionally - same as summary-item */
      font-size: clamp(12px, calc(16px * (100vw / 480px)), 16px);
      padding: clamp(3px, calc(5px * (100vw / 480px)), 5px) 0;
      color: #000000;
      border-bottom: none;
      margin-bottom: 0;
    }
    #CartDrawer .cart-drawer__discount-title {
      flex: 1;
      color: #000000;
      font-weight: 400;
      /* Responsive font size: 480px = 16px, scale down proportionally */
      font-size: clamp(12px, calc(16px * (100vw / 480px)), 16px);
    }
    #CartDrawer .cart-drawer__discount-right {
      display: flex;
      align-items: center;
      gap: clamp(6px, calc(8px * (100vw / 480px)), 8px);
    }
    #CartDrawer .cart-drawer__discount-amount {
      overflow: hidden;
      color: #000000;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: var(--font-stack-body);
      /* Responsive font size: 480px = 16px, scale down proportionally */
      font-size: clamp(12px, calc(16px * (100vw / 480px)), 16px);
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
    }
    #CartDrawer .cart-drawer__discount-remove {
      background: none;
      border: none;
      cursor: pointer;
      padding: clamp(3px, calc(4px * (100vw / 480px)), 4px);
      border-radius: clamp(3px, calc(4px * (100vw / 480px)), 4px);
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    #CartDrawer .cart-drawer__discount-remove:hover {
      background: #f5f5f5;
      color: #666;
    }
    #CartDrawer .cart-drawer__discount-remove svg {
      width: clamp(14px, calc(16px * (100vw / 480px)), 16px);
      height: clamp(14px, calc(16px * (100vw / 480px)), 16px);
    }
    #CartDrawer .summary-item__right-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    #CartDrawer .summary-item__right-content .text-right {
      font-size: 14px;
      margin-top: 4px;
    }
    #CartDrawer .cart-drawer__savings {
      width: calc(100% + (var(--drawer-horizontal-padding) * 2));
      min-height: clamp(50px, calc(59px * var(--drawer-actual-width) / 390px), 59px);
      flex-shrink: 0;
      border-radius: 0;
      background: #F5F9FF;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin: 0 calc(var(--drawer-horizontal-padding) * -1) clamp(15px, calc(20px * var(--drawer-actual-width) / 390px), 20px) calc(var(--drawer-horizontal-padding) * -1);
      position: sticky;
      top: clamp(70px, calc(80px * var(--drawer-actual-width) / 390px), 80px);
      z-index: 9;
      overflow: visible;
      padding: clamp(12px, calc(15px * var(--drawer-actual-width) / 390px), 15px) 0 clamp(14px, calc(18px * var(--drawer-actual-width) / 390px), 18px) 0;
      box-sizing: border-box;
    }
    /* Desktop: Adjust top position for larger header */
    @media (min-width: 769px) {
      #CartDrawer .cart-drawer__savings {
        top: clamp(80px, calc(90px * var(--drawer-actual-width) / 490px), 90px);
      }
    }
    #CartDrawer .cart-drawer__savings::before {
      content: '';
      position: absolute;
      bottom: calc(clamp(7px, calc(9px * var(--drawer-actual-width) / 390px), 9px) - clamp(1.5px, calc(2.5px * var(--drawer-actual-width) / 390px), 2.5px));
      left: 0;
      height: clamp(3px, calc(5px * var(--drawer-actual-width) / 390px), 5px);
      width: 100%;
      background: #1C2C58;
      border-radius: clamp(2px, calc(2.5px * var(--drawer-actual-width) / 390px), 2.5px);
      z-index: 1;
    }
    #CartDrawer .cart-drawer__savings-text {
      overflow: hidden;
      color: #1C2C58;
      text-align: center;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(12px, calc(14px * var(--drawer-actual-width) / 390px), 14px);
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      position: relative;
      z-index: 2;
      padding: 0;
      margin: 0 auto clamp(8px, calc(10px * var(--drawer-actual-width) / 390px), 10px);
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    #CartDrawer .cart-drawer__savings-amount {
      font-weight: 700;
      display: inline-block;
    }
    #CartDrawer .cart-drawer__savings-badge {
      position: absolute;
      right: clamp(44px, calc(44px * var(--drawer-actual-width) / 390px), 44px);
      bottom: 0;
      background: #1C2C58;
      color: white;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
      font-weight: 400;
      padding: 0 clamp(8px, calc(10px * var(--drawer-actual-width) / 390px), 10px);
      height: clamp(14px, calc(18px * var(--drawer-actual-width) / 390px), 18px);
      width: clamp(40px, calc(53px * var(--drawer-actual-width) / 390px), 53px);
      border-radius: clamp(7px, calc(9px * var(--drawer-actual-width) / 390px), 9px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      animation: slideInFromRight 0.8s ease-out;
    }
    
    /* Animation for Save badge sliding in */
    @keyframes slideInFromRight {
      0% {
        transform: translateX(100px);
        opacity: 0;
      }
      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Animation for savings amount counter */
    @keyframes numberBounce {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.15);
      }
    }
    
    #CartDrawer .cart-drawer__savings-amount.animate {
      animation: numberBounce 0.6s ease-out;
    }
    .cart-drawer__cross-sell-header-wrapper {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin: 20px 0 10px;
    }
    .cart-drawer__cross-sell-header {
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(14px, calc(16px * (100vw / 480px)), 16px);
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      margin: 0;
      flex: 1;
    }
    .cart-drawer__cross-sell-slider-wrapper {
      position: relative;
    }
    .cart-drawer__arrows-container {
      display: flex;
      gap: 10px;
      margin: 0;
    }
    .cart-drawer__cross-sell-slider {
      display: flex;
      overflow-x: auto;
      overflow-y: auto;
      scroll-behavior: smooth;
      gap: 15px;
      padding-bottom: 20px;
      cursor: grab;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: #D1E5FF transparent;
    }
    
    /* Ensure interactive elements in slider are clickable */
    .cart-drawer__cross-sell-slider select,
    .cart-drawer__cross-sell-slider input,
    .cart-drawer__cross-sell-slider button,
    .cart-drawer__cross-sell-slider a {
      cursor: pointer;
      pointer-events: auto;
      position: relative;
      z-index: 20;
    }
    .cart-drawer__cross-sell-slider::-webkit-scrollbar {
      height: 6px;
    }
    .cart-drawer__cross-sell-slider::-webkit-scrollbar-track {
      background: transparent;
    }
    .cart-drawer__cross-sell-slider::-webkit-scrollbar-thumb {
      background: #D1E5FF;
      border-radius: 3px;
    }
    .cart-drawer__cross-sell-slider::-webkit-scrollbar-thumb:hover {
      background: #B3D9FF;
    }
    .cart-drawer__cross-sell-slider:active {
      cursor: grabbing;
    }
    .cart-drawer__cross-sell-item {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 15px;
      padding: 15px;
      border-radius: 8px;
      background: #F0F7FF;
      align-items: center;
      flex: 0 0 100%; /* Each item takes full width */
    }
    
    /* Mobile: Width 274px (259px + 15px) with base 390px */
    @media (max-width: 768px) {
      .cart-drawer__cross-sell-item {
        width: clamp(215px, calc(274px * var(--drawer-actual-width) / 390px), 274px) !important;
        flex: 0 0 clamp(215px, calc(274px * var(--drawer-actual-width) / 390px), 274px) !important;
        max-width: clamp(215px, calc(274px * var(--drawer-actual-width) / 390px), 274px) !important;
      }
    }
    
    /* Desktop: Fixed width 320px with base 490px */
    @media (min-width: 769px) {
      .cart-drawer__cross-sell-item {
        width: clamp(280px, calc(320px * var(--drawer-actual-width) / 490px), 320px);
        flex: 0 0 clamp(280px, calc(320px * var(--drawer-actual-width) / 490px), 320px);
        max-width: clamp(280px, calc(320px * var(--drawer-actual-width) / 490px), 320px);
      }
    }
    .cross-sell-item__top-row {
      display: flex;
      gap: clamp(10px, calc(15px * (100vw / 480px)), 15px);
      align-items: flex-start;
      width: 100%;
      box-sizing: border-box;
    }
    .cross-sell-item__image {
      display: flex;
      width: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px);
      height: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px);
      min-width: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px);
      min-height: clamp(100px, calc(132px * var(--drawer-actual-width) / 390px), 132px);
      justify-content: center;
      align-items: center;
      gap: 0;
      flex-shrink: 0;
      border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px);
      border: none;
      background: transparent;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }
    .cross-sell-item__image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px);
    }
    .cross-sell-item__info {
      flex-grow: 1;
      text-align: left;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      align-self: flex-end;
      gap: clamp(6px, calc(8px * (100vw / 480px)), 8px);
      min-width: 0;
      overflow: hidden;
    }
    .cross-sell-item__variant-select {
      width: 100%;
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(14px, calc(16px * (100vw / 480px)), 16px);
      text-decoration-line: underline;
      cursor: pointer;
      border: 1px solid #ddd;
      background: white;
      padding: clamp(6px, calc(8px * (100vw / 480px)), 8px) clamp(10px, calc(20px * (100vw / 480px)), 20px) clamp(6px, calc(8px * (100vw / 480px)), 8px) clamp(8px, calc(12px * (100vw / 480px)), 12px);
      margin-bottom: clamp(2px, calc(3px * (100vw / 480px)), 3px);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 6.75L9 11.25L13.5 6.75' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right center;
      background-size: clamp(14px, calc(18px * (100vw / 480px)), 18px);
      text-align: left;
      box-sizing: border-box;
      position: relative;
      z-index: 10;
      pointer-events: auto;
    }
    .cross-sell-item__quantity-label {
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: clamp(14px, calc(16px * (100vw / 480px)), 16px);
      white-space: nowrap;
      margin-bottom: 0 !important;
    }
    .cross-sell-item__quantity-wrapper {
        display: flex !important;
        width: clamp(60px, calc(70px * var(--drawer-actual-width) / 390px), 70px);
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px);
        align-items: center;
        gap: 0;
        flex-shrink: 0;
        border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px);
        border: 1px solid #E5E7EB;
        background: #FFF;
        overflow: hidden;
        position: relative;
        box-sizing: border-box;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust {
        width: clamp(18px, calc(20px * var(--drawer-actual-width) / 390px), 20px);
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px);
        border: none;
        background: transparent;
        color: #000;
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
        font-weight: normal;
        cursor: pointer;
        display: flex !important;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
        padding: 0;
        margin: 0;
        outline: none;
        box-sizing: border-box;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust:hover {
        background: transparent;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust:active {
        background: transparent;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust--minus {
        border: none;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust--plus {
        border: none;
    }
    
    /* Ensure quantity wrapper children stay inside */
    .cross-sell-item__quantity-wrapper > * {
        position: relative !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__num {
        flex: 1;
        height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px);
        min-width: 0;
        border: none;
        background: #FFF;
        text-align: center;
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
        font-weight: 600;
        box-sizing: border-box;
        color: #1C2C58;
        outline: none;
        padding: 0;
        min-width: 0;
        position: relative;
        z-index: 1;
        justify-content: center !important;
    }
    .cross-sell-item__add-btn {
      display: flex;
      width: clamp(60px, calc(70px * var(--drawer-actual-width) / 390px), 70px);
      height: clamp(28px, calc(35px * var(--drawer-actual-width) / 390px), 35px);
      padding: clamp(8px, calc(12px * var(--drawer-actual-width) / 390px), 12px) clamp(10px, calc(15px * var(--drawer-actual-width) / 390px), 15px);
      justify-content: center;
      align-items: center;
      gap: clamp(6px, calc(10px * var(--drawer-actual-width) / 390px), 10px);
      flex-shrink: 0;
      border-radius: clamp(4px, calc(5px * var(--drawer-actual-width) / 390px), 5px);
      background: #FCE390;
      color: #1C2C58;
      font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
      font-weight: 600;
      border: none;
      cursor: pointer;
      box-sizing: border-box;
      white-space: nowrap;
    }
      box-sizing: border-box;
    }
    .cross-sell-item__info h4 { 
      font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px); 
    }
    .cross-sell-item__info p,
    .cross-sell-item__variant-select,
    .cross-sell-item__quantity-label {
      font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
    }
    .cross-sell-item__price-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: clamp(3px, calc(4px * var(--drawer-actual-width) / 390px), 4px);
    }
    .cross-sell-item__price-wrapper .price {
      font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
      color: #1C2C58;
      font-weight: 400;
    }
    .cross-sell-item__price-wrapper .compare-at-price {
        font-size: clamp(10px, calc(12px * var(--drawer-actual-width) / 390px), 12px);
        text-decoration: line-through;
        opacity: 0.7;
    }
    .cross-sell-item__form {
        width: 100%;
    }
    .cross-sell-item__form-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: clamp(20px, calc(40px * (100vw / 480px)), 40px);
        width: 100%;
        box-sizing: border-box;
        flex-wrap: nowrap;
    }
    .cross-sell-item__quantity {
        display: flex;
        align-items: center;
        gap: clamp(6px, calc(10px * (100vw / 480px)), 10px);
        width: 50%;
        min-width: 0;
        box-sizing: border-box;
    }
    /* Bundle Voucher Notice */
    .bundle-voucher-notice {
      margin: 10px 0;
    }
    
    .bundle-voucher-notice div {
      background: #E8F4FD;
      border: 1px solid #B3D9FF;
      border-radius: 8px;
      padding: 12px;
      font-family: 'Be Vietnam Pro', sans-serif;
      font-size: 14px;
      color: #1C2C58;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Checkout Buttons */
    #CartDrawer .cart__checkout-wrapper--custom {
      display: flex;
      gap: clamp(6px, 2vw, 10px);
      margin-top: 20px;
      width: 100%;
      box-sizing: border-box;
      flex-wrap: nowrap;
      align-items: stretch;
    }
    #CartDrawer .btn--cod, #CartDrawer .btn--online {
      flex: 1 1 0;
      min-width: 0;
      max-width: 100%;
      border-radius: 15px;
      text-align: center;
      text-decoration: none;
      font-family: var(--font-stack-body);
      font-weight: 700;
      font-size: 16px;
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      box-sizing: border-box;
      padding: 12px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    #CartDrawer .btn--online {
      background-color: #FCE390;
      color: #1C2C58;
    }
    
    /* Mobile responsive for checkout buttons */
    @media (max-width: 768px) {
      #CartDrawer .cart__checkout-wrapper--custom {
        gap: clamp(4px, 1.5vw, 8px);
        margin-top: clamp(12px, 3vw, 20px);
        padding: 0;
      }
      #CartDrawer .btn--cod, #CartDrawer .btn--online {
        font-size: clamp(12px, 3.5vw, 14px);
        padding: clamp(10px, 2.5vw, 12px) clamp(6px, 1.5vw, 8px);
        border-radius: clamp(12px, 3.5vw, 15px);
        min-width: 0;
        flex-shrink: 1;
      }
    }
    
    /* Extra small mobile screens - 380px and below */
    @media (max-width: 380px) {
      /* Ensure quantity selector doesn't overflow - responsive based on drawer actual width */
      #CartDrawer .js-qty__wrapper {
        min-width: clamp(60px, calc(103px * var(--drawer-actual-width) / 390px), 103px) !important;
        max-width: clamp(60px, calc(103px * var(--drawer-actual-width) / 390px), 103px) !important;
        width: clamp(60px, calc(103px * var(--drawer-actual-width) / 390px), 103px) !important;
        height: clamp(24px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
      }
      
      #CartDrawer .js-qty__num {
        font-size: clamp(12px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
      }
      
      #CartDrawer .js-qty__adjust {
        width: clamp(18px, calc(24px * var(--drawer-actual-width) / 390px), 24px) !important;
        height: clamp(24px, calc(35px * var(--drawer-actual-width) / 390px), 35px) !important;
        font-size: clamp(12px, calc(16px * var(--drawer-actual-width) / 390px), 16px) !important;
      }
      
      /* Ensure cart item footer doesn't overflow */
      .cart-item__footer {
        gap: 6px !important;
        flex-wrap: nowrap !important;
      }
      
      /* Bundle footer quantity wrapper - responsive based on drawer actual width */
      .bundle-footer .js-qty__wrapper {
        min-width: clamp(60px, calc(103px * var(--drawer-actual-width) / 390px), 103px) !important;
        max-width: clamp(60px, calc(103px * var(--drawer-actual-width) / 390px), 103px) !important;
        width: clamp(60px, calc(103px * var(--drawer-actual-width) / 390px), 103px) !important;
      }
      
      /* Cross-sell quantity wrapper */
      .cross-sell-item__quantity-wrapper {
        width: 70px !important;
        height: 28px !important;
      }
      
      .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust {
        width: 20px !important;
        height: 28px !important;
        font-size: 12px !important;
      }
      
      .cross-sell-item__quantity-wrapper .cross-sell-qty__num {
        height: 28px !important;
        font-size: 12px !important;
      }
      
      .cross-sell-item__add-btn {
        width: 70px !important;
        height: 28px !important;
        font-size: 10px !important;
        padding: 8px 10px !important;
      }
    }
    
    /* Extra small mobile screens - 360px and below */
    @media (max-width: 360px) {
      #CartDrawer .cart__checkout-wrapper--custom {
        gap: 4px;
      }
      #CartDrawer .btn--cod, #CartDrawer .btn--online {
        font-size: 12px;
        padding: 10px 4px;
        gap: 2px;
      }
    }

    /* Voucher Section */
    .cart-drawer__voucher-section {
      margin-top: 10px;
    }
    .cart-drawer__voucher-trigger {
      display: flex;
      align-items: center;
      width: 100%;
      border-radius: clamp(6px, calc(8px * (100vw / 480px)), 8px);
      overflow: hidden;
      border: 1px solid #D1E5FF;
      background: #F0F7FF;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .cart-drawer__voucher-trigger:hover {
      background: #E0EFFF;
    }
    .cart-drawer__voucher-trigger-label {
      flex: 1;
      padding: clamp(10px, calc(12px * (100vw / 480px)), 12px) clamp(10px, calc(15px * (100vw / 480px)), 15px);
      font-family: var(--font-stack-body);
      font-size: clamp(12px, calc(14px * (100vw / 480px)), 14px);
      color: #000;
      text-align: left;
      background: transparent;
    }
    .cart-drawer__voucher-trigger-button {
      padding: clamp(10px, calc(12px * (100vw / 480px)), 12px) clamp(12px, calc(20px * (100vw / 480px)), 20px);
      font-family: var(--font-stack-body);
      font-size: clamp(12px, calc(14px * (100vw / 480px)), 14px);
      font-weight: 500;
      color: white;
      background: #759CE6;
      white-space: nowrap;
    }

    /* Voucher Popup Overlay - Outside Cart Drawer */
    .voucher-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .voucher-popup-overlay.is-open {
      display: flex;
    }

    /* Voucher Popup */
    .voucher-popup {
      background: white;
      border-radius: 8px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      position: relative;
      margin: auto;
    }

    /* Mobile Popup - 360px width */
    @media (max-width: 768px) {
      .voucher-popup-overlay {
        padding: 0;
        align-items: center;
        justify-content: center;
      }
      .voucher-popup {
        width: 360px;
        max-width: 360px;
        max-height: 90vh;
        border-radius: 8px;
        height: auto;
      }
    }

    /* Desktop Popup - 787px width (exact Figma size), border-radius 48px */
    @media (min-width: 769px) {
      .voucher-popup {
        width: 787px;
        max-width: 787px;
        border-radius: 48px;
      }
    }

    /* Popup Header - Exact Figma spacing */
    .voucher-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 35px 26px 0;
      border-bottom: none;
      position: relative;
    }
    .voucher-popup-title {
      font-family: var(--font-stack-body);
      font-size: 39px;
      font-weight: 700;
      color: #1C2C58;
      margin: 0;
      text-transform: capitalize;
      line-height: 1.2;
    }
    .voucher-popup-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 27px;
      height: 27px;
      flex-shrink: 0;
    }
    .voucher-popup-close svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile Header */
    @media (max-width: 768px) {
      .voucher-popup-header {
        padding: 8px 15px;
      }
      .voucher-popup-title {
        font-size: 20px;
        font-weight: 600;
      }
    }

    /* Popup Content - Exact Figma padding */
    .voucher-popup-content {
      flex: 1;
      overflow-y: auto;
      padding: 26px 26px 20px;
      scrollbar-width: thin;
      scrollbar-color: #D1E5FF transparent;
    }
    .voucher-popup-content::-webkit-scrollbar {
      width: 6px;
    }
    .voucher-popup-content::-webkit-scrollbar-track {
      background: transparent;
    }
    .voucher-popup-content::-webkit-scrollbar-thumb {
      background: #D1E5FF;
      border-radius: 3px;
    }

    /* Mobile Content */
    @media (max-width: 768px) {
      .voucher-popup-content {
        padding: 15px;
      }
    }

    /* Voucher Form - Exact Figma sizes with #F5F9FF wrapper */
    .voucher-popup-form {
      margin-bottom: 30px;
      position: relative;
    }
    .voucher-popup-error {
      display: none;
      background: #FEE2E2;
      border: 1px solid #FCA5A5;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 15px;
      color: #DC2626;
      font-family: var(--font-stack-body);
      font-size: 14px;
      font-weight: 400;
      line-height: 1.5;
      text-align: left;
    }
    .voucher-popup-success {
      display: none;
      background: #D1FAE5;
      border: 1px solid #86EFAC;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 15px;
      color: #059669;
      font-family: var(--font-stack-body);
      font-size: 14px;
      font-weight: 400;
      line-height: 1.5;
      text-align: left;
    }
    .voucher-popup-input-wrapper {
      background: #F5F9FF;
      border-radius: 15px;
      width: 724.594px;
      height: 96.787px;
      padding: 25.51px 16.99px;
      box-sizing: border-box;
      position: relative;
      display: flex;
      align-items: center;
      overflow: visible;
    }
    .voucher-popup-input-group {
      display: flex;
      align-items: center;
      gap: 0;
      position: relative;
      width: 100%;
      height: 45.768px;
      padding-right:16.99px;
      overflow: visible;
    }
    .voucher-popup-input {
      width: 690.619px;
      padding: 0 20px;
      border: none;
      border-right: none;
      background: white;
      font-family: var(--font-stack-body);
      font-size: 20px;
      color: #000;
      outline: none;
      border-radius: 37.5px 0 0 37.5px;
      height: 45.768px;
      box-sizing: border-box;
      flex-shrink: 0;
      position: relative;
      z-index: 1;
    }
    .voucher-popup-input::placeholder {
      color: #999;
      font-size: 20px;
    }
    .voucher-popup-apply-btn {
      width: 239.22px;
      height: 45.768px;
      background: #FCE390;
      color: #1C2C58;
      border: none;
      border-radius: 37.5px;
      font-family: var(--font-stack-body);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      text-transform: uppercase;
      transition: background 0.2s ease;
      flex-shrink: 0;
      box-sizing: border-box;
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2;
    }
    .voucher-popup-apply-btn:hover {
      background: #F9D966;
    }
    .voucher-popup-apply-btn:active {
      background: #F5C842;
    }

    /* Mobile Form */
    @media (max-width: 768px) {
      .voucher-popup-form {
        margin-bottom: 20px;
      }
      .voucher-popup-input-wrapper {
        width: 100%;
        height: auto;
        min-height: 77px;
        padding: 18px 15px;
        border-radius: 5px;
      }
      .voucher-popup-input-group {
        flex-direction: column;
        gap: 10px;
        height: auto;
      }
      .voucher-popup-input {
        width: 100%;
        max-width: 308px;
        padding: 0 12px;
        font-size: 14px;
        border-radius: 37.5px;
        border: none;
        height: 41px;
        margin-left: 0;
        z-index: 1;
      }
      .voucher-popup-apply-btn {
        width: 118px;
        height: 41px;
        border-radius: 37.5px;
        font-size: 14px;
        font-weight: 500;
        margin-left: 0;
        margin-top: 0;
        z-index: 2;
      }
    }

    /* Voucher List Section - Exact Figma spacing */
    .voucher-popup-list-section {
      margin-top: 40px;
    }
    .voucher-popup-list-title {
      font-family: var(--font-stack-body);
      font-size: 20px;
      font-weight: 400;
      color: #000;
      margin: 0 0 27px 0;
    }
    .voucher-popup-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    .voucher-popup-empty {
      text-align: center;
      padding: 30px;
      color: #999;
      font-family: var(--font-stack-body);
      font-size: 14px;
    }
    .voucher-popup-disclaimer {
      font-family: var(--font-stack-body);
      font-size: 20px;
      font-weight: 300;
      font-style: italic;
      color: #000;
      margin: 0;
      padding-top: 15px;
      border-top: 1px solid #E5E7EB;
    }

    /* Mobile List Section */
    @media (max-width: 768px) {
      .voucher-popup-list-section {
        margin-top: 20px;
      }
      .voucher-popup-list-title {
        font-size: 14px;
        font-weight: 400;
        margin-bottom: 15px;
      }
      .voucher-popup-list {
        gap: 12px;
        margin-bottom: 15px;
      }
      .voucher-popup-disclaimer {
        font-size: 14px;
        font-weight: 300;
        font-style: italic;
        padding-top: 10px;
      }
    }

    /* Voucher Card - Exact Design Match from Figma Desktop */
    .voucher-card {
      background: #F5F9FF;
      border: none;
      border-radius: 15px;
      padding: 0;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      width: 729.448px;
      height: 126.049px;
      box-sizing: border-box;
      overflow: hidden;
    }
    .voucher-card:hover {
      background: #E8F2FF;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .voucher-card-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 0;
      position: relative;
      flex: 1;
      min-width: 0;
    }
    .voucher-card-title {
      font-family: var(--font-stack-body);
      font-size: 18px;
      font-weight: 700;
      color: #1C2C58;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      line-height: 1.2;
    }
    .voucher-card-description {
      font-family: var(--font-stack-body);
      font-size: 18px;
      font-weight: 400;
      color: #000;
      margin: 0 0 8px 0;
      line-height: 1.2;
    }
    .voucher-card-code-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 0 8px 0;
    }
    .voucher-card-code-label {
      font-family: var(--font-stack-body);
      font-size: 18px;
      font-weight: 400;
      color: #000;
      margin: 0;
    }
    .voucher-card-code-box {
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 5px;
      padding: 4px 12px;
      display: inline-flex;
      align-items: center;
      width: 104px;
      height: 27px;
      box-sizing: border-box;
    }
    .voucher-card-code {
      font-family: var(--font-stack-body);
      font-size: 18px;
      font-weight: 500;
      color: #1C2C58;
      margin: 0;
    }
    .voucher-card-expiry {
      font-family: var(--font-stack-body);
      font-size: 18px;
      font-weight: 400;
      color: #000;
      margin: 0;
    }
    .voucher-card-radio {
      width: 35px;
      height: 35px;
      border: 2px solid #E5E7EB;
      border-radius: 50%;
      background: white;
      margin-right: 20px;
      margin-left: auto;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .voucher-card-radio::after {
      content: '';
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #1C2C58;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .voucher-card.selected .voucher-card-radio::after {
      opacity: 1;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .voucher-card-dashed-line {
      position: absolute;
      right: 55px;
      top: 0;
      bottom: 0;
      width: 1.387px;
      background: repeating-linear-gradient(
        to bottom,
        #E5E7EB 0,
        #E5E7EB 7.503px,
        transparent 7.503px,
        transparent 15.006px
      );
      pointer-events: none;
    }

    /* Mobile Voucher Card */
    @media (max-width: 768px) {
      .voucher-card {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        height: auto !important;
        min-height: 106px;
        border-radius: 5px;
      }
      .voucher-card-content {
        padding: 12px 15px;
      }
      .voucher-card-title {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 4px;
      }
      .voucher-card-description {
        font-size: 12px;
        margin-bottom: 4px;
      }
      .voucher-card-code-wrapper {
        margin-bottom: 4px;
      }
      .voucher-card-code-label {
        font-size: 12px;
      }
      .voucher-card-code-box {
        height: 23px;
        padding: 4px 8px;
        border: 1px solid #E5E7EB;
        border-radius: 5px;
      }
      .voucher-card-code {
        font-size: 12px;
        font-weight: 500;
      }
      .voucher-card-expiry {
        font-size: 12px;
      }
      .voucher-card-dashed-line {
        width: 1.234px;
        background: repeating-linear-gradient(
          to bottom,
          #E5E7EB 0,
          #E5E7EB 6.169px,
          transparent 6.169px,
          transparent 12.338px
        );
      }
    }

    /* Popup Footer - Exact Figma spacing */
    .voucher-popup-footer {
      padding: 20px 26px;
      border-top: 1px solid #E5E7EB;
      display: flex;
      justify-content: flex-end;
    }
    .voucher-popup-back-btn {
      padding: 0;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 37.5px;
      font-family: var(--font-stack-body);
      font-size: 20px;
      font-weight: 500;
      color: #000;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 185px;
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .voucher-popup-back-btn:hover {
      background: #F5F5F5;
      border-color: #D1D5DB;
    }

    /* Mobile Footer */
    @media (max-width: 768px) {
      .voucher-popup-footer {
        padding: 15px;
        justify-content: center;
      }
      .voucher-popup-back-btn {
        width: 117px;
        height: 41px;
        border: 1px solid #E5E7EB;
        border-radius: 37.5px;
        font-size: 14px;
        font-weight: 500;
      }
    }
  </style>

  <div id="CartDrawer" class="drawer drawer--right">
    <form id="CartDrawerForm" action="{{ routes.cart_url }}" method="post" novalidate class="drawer__contents" data-location="cart-drawer">
      <div class="drawer__inner">
        <!-- Fixed Header - Always visible -->
        <div class="drawer__header relative appear-animation appear-delay-1">
          <div class="h2 drawer__title">{{ 'cart.general.title' | t }}</div>
          <div class="drawer__count">
             {{ cart.item_count }} sản phẩm
          </div>
          <div class="drawer__close absolute right-0">
            <button type="button" class="drawer__close-button js-drawer-close">
              {%- render 'close-icon' -%}
              <span class="icon__fallback-text">{{ 'cart.general.close_cart' | t }}</span>
            </button>
          </div>
        </div>
        
        <!-- SAVINGS BANNER - Sticky below header -->
        {%- comment -%}
          Calculate original total price based on the same logic as cart-item.liquid
          This ensures we capture both compare_at_price and original_price correctly.
        {%- endcomment -%}
        {%- assign original_total_price_calculated = 0 -%}
        {%- for item in cart.items -%}
            {%- assign line_price = 0 -%}
            {%- if item.variant.compare_at_price > item.price -%}
                {%- assign line_price = item.variant.compare_at_price | times: item.quantity -%}
            {%- else -%}
                {%- assign line_price = item.original_price | times: item.quantity -%}
            {%- endif -%}
            {%- assign original_total_price_calculated = original_total_price_calculated | plus: line_price -%}
        {%- endfor -%}
        {%- assign total_savings = original_total_price_calculated | minus: cart.total_price -%}
        
        <!-- Savings banner always visible -->
        <div class="cart-drawer__savings" data-savings-display>
          <span class="cart-drawer__savings-text">Bạn đã tiết kiệm được <span class="cart-drawer__savings-amount" data-savings-amount>{{ total_savings | money }}</span></span>
          <span class="cart-drawer__savings-badge">Save</span>
        </div>
        
        <div class="drawer__scrollable">

          <!-- CART ITEMS -->
          <div data-products class="appear-animation appear-delay-2">
            {%- comment -%} Cart items are rendered here via JS {%- endcomment -%}
          </div>


          <!-- CROSS-SELL -->
          {%- assign cross_sell_products = settings.cart_cross_sell_products -%}
          {%- if cross_sell_products.count > 0 -%}
          <div class="cart-drawer__cross-sell">
            <div class="cart-drawer__cross-sell-header-wrapper">
              <h3 class="cart-drawer__cross-sell-header">Thăng hạng chất lượng giấc ngủ cùng</h3>
            </div>
            <div class="cart-drawer__cross-sell-slider-wrapper">
              <div class="cart-drawer__cross-sell-slider">
                {%- for product in cross_sell_products -%}
                    {%- assign current_variant = product.first_available_variant -%}
                    <div class="cart-drawer__cross-sell-item" data-product-id="{{ product.id }}">
                      <!-- First row: Image and Product info side by side -->
                      <div class="cross-sell-item__top-row">
                        <a href="{{ product.url }}" class="cross-sell-item__image">
                          <img src="{{ product.featured_image | image_url: width: 264, height: 264 }}" alt="{{ product.featured_image.alt | escape }}" loading="lazy">
                        </a>
                        <div class="cross-sell-item__info">
                          <h4 class="cross-sell-item__title"><a href="{{ product.url }}">{{ product.title }}</a></h4>
                          <div class="cross-sell-item__price-wrapper">
                            <span class="price">{{ current_variant.price | money }}</span>
                            {% if current_variant.compare_at_price > current_variant.price %}
                              <del class="compare-at-price">{{ current_variant.compare_at_price | money }}</del>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      
                      <!-- Second row: Variant select -->
                      {% if product.variants.size > 1 %}
                        <select name="id" class="cross-sell-item__variant-select">
                          {% for variant in product.variants %}
                            <option {% if variant == current_variant %}selected="selected"{% endif %} value="{{ variant.id }}">{{ variant.title }}</option>
                          {% endfor %}
                        </select>
                      {% endif %}
                      
                      <!-- Third row: Form row (quantity + add button) -->
                      <form method="post" action="{{ routes.cart_add_url }}" class="cross-sell-item__form">
                        <input type="hidden" name="id" value="{{ current_variant.id }}">
                        <div class="cross-sell-item__form-row">
                          <div class="cross-sell-item__quantity">
                            <label for="cross-sell-quantity-{{ product.id }}" class="cross-sell-item__quantity-label">Số lượng:</label>
                            <div class="cross-sell-item__quantity-wrapper">
                              <button type="button" class="cross-sell-qty__adjust cross-sell-qty__adjust--minus" aria-label="-">-</button>
                              <input type="text" id="cross-sell-quantity-{{ product.id }}" name="quantity" value="1" min="1" class="cross-sell-qty__num">
                              <button type="button" class="cross-sell-qty__adjust cross-sell-qty__adjust--plus" aria-label="+">+</button>
                            </div>
                          </div>
                          <button type="button" class="cross-sell-item__add-btn">Thêm</button>
                        </div>
                      </form>
                    </div>
                  {%- endfor -%}
              </div>
            </div>
          </div>
          {%- endif -%}

          <!-- Voucher Section -->
          <div class="cart-drawer__voucher-section">
            <button type="button" class="cart-drawer__voucher-trigger" data-voucher-popup-open>
              <span class="cart-drawer__voucher-trigger-label">Mã giảm giá</span>
              <span class="cart-drawer__voucher-trigger-button">Chọn mã giảm giá</span>
            </button>
          </div>

          <!-- Footer is now part of scrollable content -->
          <div class="drawer__footer appear-animation appear-delay-4">
          <div data-cart-footer>
            
            <!-- SUMMARY -->
            <div class="cart-drawer__summary">
                {%- comment -%}
                  Calculate original total price based on the same logic as cart-item.liquid
                  This ensures we capture both compare_at_price and original_price correctly.
                {%- endcomment -%}
                {%- assign original_total_price_calculated = 0 -%}
                {%- for item in cart.items -%}
                    {%- assign line_price = 0 -%}
                    {%- if item.variant.compare_at_price > item.price -%}
                        {%- assign line_price = item.variant.compare_at_price | times: item.quantity -%}
                    {%- else -%}
                        {%- assign line_price = item.original_price | times: item.quantity -%}
                    {%- endif -%}
                    {%- assign original_total_price_calculated = original_total_price_calculated | plus: line_price -%}
                {%- endfor -%}

                {%- assign total_savings = original_total_price_calculated | minus: cart.total_price -%}

                <!-- DISCOUNT APPLICATIONS -->
                {%- if cart.cart_level_discount_applications.size > 0 -%}
                  {%- for cart_discount in cart.cart_level_discount_applications -%}
                    <div class="cart-drawer__summary-item cart-drawer__discount-item">
                      <span class="cart-drawer__discount-title">Giảm giá</span>
                      <div class="cart-drawer__discount-right">
                        <span class="cart-drawer__discount-amount">{{ cart_discount.total_allocated_amount | money }}</span>
                        <button type="button" class="cart-drawer__discount-remove" data-discount-title="{{ cart_discount.title }}" title="Bỏ mã giảm giá">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  {%- endfor -%}
                {%- endif -%}

                <div class="cart-drawer__summary-item">
                    <span>Tạm tính</span>
                    <div class="summary-item__right-content">
                      <span class="price-container">
                        {%- if total_savings > 0 -%}
                          <del class="price--original">{{ original_total_price_calculated | money }}</del>
                        {%- endif -%}
                        <span data-subtotal class="price--final">{{ cart.total_price | money }}</span>
                      </span>
                      {%- if cart.cart_level_discount_applications.size > 0 -%}
                        <span class="text-right">Đã áp dụng ưu đãi</span>
                      {%- endif -%}
                    </div>
                </div>

                <div class="cart-drawer__summary-item">
                    <span style="color: #000;">Vận chuyển</span>
                    <span style="color: #1C2C58;">Miễn phí</span>
                </div>
            </div>


            <!-- CHECKOUT BUTTONS -->
            <div class="cart__checkout-wrapper--custom">
                {%- assign bundle_voucher = '' -%}
                {%- comment -%} Check bundle items for voucher {%- endcomment -%}
                {%- for item in cart.items -%}
                  {%- if item.properties._bundle_voucher -%}
                    {%- assign bundle_voucher = item.properties._bundle_voucher -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}

                <button type="submit" name="checkout" class="btn btn--online" onclick="handleCheckout(); return false;">Thanh toán ngay</button>
            </div>
            {% if additional_checkout_buttons and settings.cart_additional_buttons %}
              <div class="additional-checkout-buttons additional-checkout-buttons--vertical">{{ content_for_additional_checkout_buttons }}</div>
            {% endif %}
          </div>
          </div>
        </div>
      </div>

      <div class="drawer__cart-empty appear-animation appear-delay-2">
        <div class="drawer__scrollable">
          <div class="cart-empty-message">
            {{ 'cart.general.empty' | t }}
          </div>
        </div>
      </div>
    </form>

    <script>
      (function() {
        // --- General Cart Drawer Functions ---
        let hasCheckedStoredVoucher = false;
        let layoutUpdateFrame = null;

        function updateCartDrawerLayout() {
          const drawer = document.getElementById('CartDrawer');
          if (!drawer) return;

          if (layoutUpdateFrame) {
            cancelAnimationFrame(layoutUpdateFrame);
          }

          layoutUpdateFrame = requestAnimationFrame(() => {
            const header = drawer.querySelector('.drawer__header');
            const footer = drawer.querySelector('.drawer__footer');
            const headerHeight = header ? header.offsetHeight : 0;
            const footerHeight = footer ? footer.offsetHeight : 0;

            drawer.style.setProperty('--drawer-header-height', `${headerHeight}px`);
            drawer.style.setProperty('--drawer-footer-height', `${footerHeight}px`);
            
            // Set drawer actual width for responsive calculations
            const drawerWidth = drawer.offsetWidth || drawer.clientWidth || window.innerWidth;
            drawer.style.setProperty('--drawer-actual-width', `${drawerWidth}px`);
          });
        }

        function rebuildCart() {
          if (theme && typeof theme.CartForm === 'function') {
            const cartFormInstance = new theme.CartForm(document.getElementById('CartDrawerForm'));
            cartFormInstance.buildCart();
            updateCartDrawerLayout();
            // Re-initialize drag scroll after cart rebuild
            setTimeout(() => {
              initCrossSellDragScroll();
            }, 100);
            
            // Check for bundle vouchers after cart rebuild
            setTimeout(() => {
              checkAndApplyBundleVouchers();
              if (!hasCheckedStoredVoucher) {
                hasCheckedStoredVoucher = true;
                checkStoredBundleVoucher();
              }
              manageDiscountFieldForBundle();
              updateCartDrawerLayout();
            }, 500);
            
            // MutationObserver will handle all UI updates instantly after this.
          } else {
            window.location.href = '{{ routes.cart_url }}';
          }
        }

        // Also call checkStoredBundleVoucher on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          if (!hasCheckedStoredVoucher) {
            hasCheckedStoredVoucher = true;
            setTimeout(() => {
              checkStoredBundleVoucher();
              updateCartDrawerLayout();
            }, 1000);
          }
          updateCartDrawerLayout();
        });

        // Function to refresh cart drawer (alias for rebuildCart)
        function refreshCartDrawer() {
          rebuildCart();
        }

        // Function to ensure drawer is visible
        function ensureDrawerVisible() {
          const drawer = document.getElementById('CartDrawer');
          if (drawer) {
            drawer.classList.add('drawer--is-open');
            // Update layout immediately and after a short delay to ensure width is calculated correctly
            updateCartDrawerLayout();
            setTimeout(() => {
              updateCartDrawerLayout();
            }, 50);
          }
        }

        // Function to show sticky add to cart
        function showStickyAddToCart() {
          const drawer = document.getElementById('CartDrawer');
          if (drawer) {
            drawer.classList.remove('drawer--is-open');
          }
        }

        function checkAndApplyBundleVouchers() {
          
          bundleItems.forEach((item, index) => {
            
            // Look for bundle voucher in item properties
            const propertiesEl = item.querySelector('.cart-item__properties');
            if (propertiesEl) {
              const bundleVoucherEl = propertiesEl.querySelector('[data-property-name="_bundle_voucher"]');
              if (bundleVoucherEl) {
                const voucherCode = bundleVoucherEl.textContent?.trim();
                if (voucherCode && voucherCode !== '') {
                  // Check if voucher is already applied
                  const existingDiscount = document.querySelector('.cart-drawer__discount-item');
                  if (!existingDiscount) {
                    autoApplyBundleVoucher(voucherCode);
                  }
                }

                updateCartDrawerLayout();
              }
            }
          });
        }

        function autoApplyBundleVoucher(voucherCode) {
          
          fetch('/cart/update.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ 'discount': voucherCode })
          })
          .then(response => response.json())
          .then(data => {
          .then(data => {
            if (!data.status) {
              
              // Show success notification
              showBundleVoucherNotification(voucherCode, data);
              
              // Update cart display
              setTimeout(() => rebuildCart(), 300);
            }
          })
          .catch(error => {
            console.error('❌ Error applying bundle voucher:', error);
          });
        }

        function showBundleVoucherNotification(voucherCode, cartData) {
          console.log('=== SHOW BUNDLE VOUCHER NOTIFICATION ===');
          
          // Calculate discount amount
          let discountAmount = 0;
          if (cartData.cart_level_discount_applications && cartData.cart_level_discount_applications.length > 0) {
            cartData.cart_level_discount_applications.forEach(discount => {
              if (discount.title && discount.title.toLowerCase().includes(voucherCode.toLowerCase())) {
                discountAmount = discount.total_allocated_amount || discount.amount || 0;
              }
            });
          }
          
          // Create notification element
          const notification = document.createElement('div');
          notification.className = 'bundle-voucher-notification';
          notification.innerHTML = `
            <div style="
              position: fixed;
              top: 20px;
              right: 20px;
              background: #10B981;
              color: white;
              padding: 12px 16px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              z-index: 10000;
              font-family: 'Be Vietnam Pro', sans-serif;
              font-size: 14px;
              max-width: 300px;
            ">
              <div style="font-weight: 600; margin-bottom: 4px;">
                🎉 Bundle Voucher Applied!
              </div>
              <div style="font-size: 12px; opacity: 0.9;">
                Code: ${voucherCode} • Savings: ${discountAmount > 0 ? discountAmount.toLocaleString('vi-VN') + '₫' : 'Applied'}
              </div>
            </div>
          `;
          
          document.body.appendChild(notification);
          
          // Auto remove after 3 seconds
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 3000);
        }

        // Ensure bundle voucher persists through checkout
        function ensureBundleVoucherPersistence() {
          
          // Get current discount code from cart
          const discountInput = document.querySelector('.cart-drawer__discount-input');
          if (discountInput && discountInput.value) {
            const currentDiscount = discountInput.value;
            
            // Store in sessionStorage for checkout persistence
            sessionStorage.setItem('bundle_voucher_code', currentDiscount);
          }
        }

        // Check for stored voucher on page load
        // Function to verify discount is applied
        function verifyDiscountApplied(discountCode, maxRetries = 3, retryDelay = 500) {
          return new Promise((resolve, reject) => {
            let retries = 0;
            
            function checkDiscount() {
              fetch('/cart.js')
                .then(response => response.json())
                .then(cartData => {
                  const hasDiscount = cartData.cart_level_discount_applications && 
                                     cartData.cart_level_discount_applications.length > 0;
                  
                  // Check if the specific discount code is applied
                  const discountApplied = hasDiscount && cartData.cart_level_discount_applications.some(
                    discount => discount.title && discount.title.toLowerCase().includes(discountCode.toLowerCase())
                  );
                  
                  if (discountApplied) {
                    console.log('Discount verified as applied:', discountCode);
                    resolve(true);
                  } else if (retries < maxRetries) {
                    retries++;
                    console.log(`Retrying discount verification (${retries}/${maxRetries})...`);
                    setTimeout(checkDiscount, retryDelay);
                  } else {
                    console.warn('Discount verification failed after retries');
                    resolve(false);
                  }
                })
                .catch(error => {
                  console.error('Error verifying discount:', error);
                  if (retries < maxRetries) {
                    retries++;
                    setTimeout(checkDiscount, retryDelay);
                  } else {
                    reject(error);
                  }
                });
            }
            
            checkDiscount();
          });
        }

        // Function to check if voucher code is already applied
        function isVoucherAlreadyApplied(voucherCode) {
          return fetch('/cart.js')
            .then(response => response.json())
            .then(cartData => {
              if (cartData.cart_level_discount_applications && cartData.cart_level_discount_applications.length > 0) {
                // Check if any discount application matches the voucher code
                return cartData.cart_level_discount_applications.some(discount => {
                  const discountTitle = discount.title || '';
                  const discountCode = discount.code || '';
                  return discountTitle.toLowerCase().includes(voucherCode.toLowerCase()) ||
                         discountCode.toLowerCase() === voucherCode.toLowerCase();
                });
              }
              return false;
            })
            .catch(error => {
              console.error('Error checking voucher status:', error);
              return false;
            });
        }

        // Function to check if voucher is expired
        function isVoucherExpired(voucherCode) {
          const voucherDataScript = document.querySelector('[data-voucher-data]');
          if (!voucherDataScript) return false;
          
          try {
            const voucherData = JSON.parse(voucherDataScript.textContent);
            const vouchers = voucherData.vouchers || [];
            
            const voucher = vouchers.find(v => v.code && v.code.toLowerCase() === voucherCode.toLowerCase());
            if (!voucher) return false;
            
            // Check expiry date
            if (voucher.expiry_date) {
              // Parse DD.MM.YYYY format
              const [day, month, year] = voucher.expiry_date.split('.');
              const expiryDate = new Date(year, month - 1, day);
              const today = new Date();
              today.setHours(0, 0, 0, 0);
              expiryDate.setHours(0, 0, 0, 0);
              
              return expiryDate < today;
            }
            
            // Check ends_at if available
            if (voucher.ends_at) {
              const expiryDate = new Date(voucher.ends_at);
              const today = new Date();
              return expiryDate < today;
            }
            
            return false;
          } catch (error) {
            console.error('Error checking voucher expiry:', error);
            return false;
          }
        }

        // Function to show voucher error/success message
        function showVoucherMessage(message, type = 'error') {
          // Hide any existing messages
          const existingError = document.querySelector('.voucher-popup-error');
          const existingSuccess = document.querySelector('.voucher-popup-success');
          if (existingError) existingError.style.display = 'none';
          if (existingSuccess) existingSuccess.style.display = 'none';
          
          // If message is empty, just hide messages
          if (!message || message.trim() === '') {
            return;
          }
          
          // Create or update message element
          const className = type === 'success' ? 'voucher-popup-success' : 'voucher-popup-error';
          let messageElement = document.querySelector('.' + className);
          
          if (!messageElement) {
            messageElement = document.createElement('div');
            messageElement.className = className;
            const form = document.querySelector('[data-voucher-apply-form]');
            if (form) {
              form.insertBefore(messageElement, form.firstChild);
            }
          }
          
          messageElement.textContent = message;
          messageElement.style.display = 'block';
          
          // Auto hide after 5 seconds
          setTimeout(() => {
            messageElement.style.display = 'none';
          }, 5000);
        }

        // Function to handle checkout with voucher
        function handleCheckout() {
          
          // Get current cart state
          fetch('/cart.js')
            .then(response => response.json())
            .then(cartData => {
              // Check if discount is already applied (cart-level OR product-level)
              const hasCartLevelDiscount = cartData.cart_level_discount_applications && 
                                 cartData.cart_level_discount_applications.length > 0;
              const hasProductDiscount = cartData.total_discount > 0;
              const hasDiscount = hasCartLevelDiscount || hasProductDiscount;
              
              // Find voucher from bundle items
              let bundleVoucher = null;
              for (const item of cartData.items) {
                if (item.properties && item.properties._bundle_voucher) {
                  bundleVoucher = item.properties._bundle_voucher;
                  break;
                }
              }
              
              // Check for stored discount code from voucher popup
              const storedDiscountCode = sessionStorage.getItem('applied_discount_code') || 
                                        localStorage.getItem('applied_discount_code');
              
              // CRITICAL: Per Shopify 2026 documentation (Summer '25 update)
              // Discounts applied via /cart/update.js SHOULD persist to checkout
              // We must RE-APPLY the discount before redirecting to ensure persistence
              if (storedDiscountCode) {
              if (storedDiscountCode) {
                // Re-apply discount via /cart/update.js before checkout
                
                // Re-apply discount to ensure it's in the cart session
                fetch('/cart/update.js', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({ 
                    discount: storedDiscountCode
                  })
                })
                .then(response => response.json())
                .then(data => {
                  // Per Shopify docs: discount applied via cart/update.js persists to checkout
                  
                  // Per Shopify docs: discount applied via cart/update.js persists to checkout
                  // Just redirect to /checkout, NOT /discount/CODE
                  window.location.href = '/checkout';
                })
                .catch(error => {
                  console.error('❌ Error re-applying discount:', error);
                  // Redirect anyway
                  window.location.href = '/checkout';
                });
              } else if (bundleVoucher) {
                // Apply bundle voucher first, then verify and go to checkout
              } else if (bundleVoucher) {
                // Apply bundle voucher first, then verify and go to checkout
                fetch('/cart/update.js', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({ 'discount': bundleVoucher })
                })
                .then(response => response.json())
                .then(data => {
                  console.log('Voucher applied response:', data);
                  // Verify discount is applied before redirecting
                  return verifyDiscountApplied(bundleVoucher);
                })
                .then(verified => {
                  if (verified) {
                  if (verified) {
                    window.location.href = '/checkout';
                  } else {
                    console.warn('Voucher not verified, but proceeding to checkout');
                    // Still go to checkout - discount might be applied on server side
                    window.location.href = '/checkout';
                  }
                })
                .catch(error => {
                  console.error('Error applying voucher before checkout:', error);
                  // Go to checkout anyway
                  window.location.href = '/checkout';
                });
              } else {
                // No discount and no bundle voucher, go to checkout normally
              } else {
                // No discount and no bundle voucher, go to checkout normally
                window.location.href = '/checkout';
              }
            })
            .catch(error => {
              console.error('Error getting cart state:', error);
              // Fallback: go directly to checkout
              window.location.href = '/checkout';
            });
        }


        function checkStoredBundleVoucher() {
          // Check if voucher is stored in bundle items and apply silently
          fetch('/cart.js')
            .then(response => response.json())
            .then(cartData => {
              const hasDiscount = cartData.cart_level_discount_applications &&
                                 cartData.cart_level_discount_applications.length > 0;
              
              // Find voucher from bundle items
              let storedVoucher = null;
              for (const item of cartData.items) {
                if (item.properties && item.properties._bundle_voucher) {
                  storedVoucher = item.properties._bundle_voucher;
                  break;
                }
              }
              
              
              if (!hasDiscount && storedVoucher) {
                // Apply voucher silently
                fetch('/cart/update.js', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({ 'discount': storedVoucher })
                })
                .then(response => response.json())
                .then(data => {
                  console.log('Voucher re-applied successfully');
                  // Refresh cart to show updated prices
                  setTimeout(() => rebuildCart(), 500);
                })
                .catch(error => {
                  console.error('Error re-applying voucher:', error);
                });
              } else if (hasDiscount) {
                console.log('Discount already applied, no need to re-apply');
              } else {
                console.log('No stored voucher found');
              }
            })
            .catch(error => {
              console.error('Error checking stored voucher:', error);
            });
        }
        

        function manageDiscountFieldForBundle() {
          // Discount wrapper has been removed, so this function is no longer needed
          // Keeping function for compatibility but it does nothing
          return;
        }

        function handleBundleHeaders() {
          const productContainer = document.querySelector('#CartDrawer [data-products]');
          if (productContainer) {
            const renderedBundleIds = new Set();
            const bundleGroups = {}; // Track items by bundle ID
            
            // First, hide all headers to reset
            productContainer.querySelectorAll('.bundle-header').forEach(h => h.style.display = 'none');
            
            // Group bundle items by bundle ID
            const items = productContainer.querySelectorAll('.cart__item--bundle-item');
            items.forEach(item => {
              const bundleId = item.dataset.bundleId;
              if (bundleId) {
                if (!bundleGroups[bundleId]) {
                  bundleGroups[bundleId] = [];
                }
                bundleGroups[bundleId].push(item);
              }
            });
            
            // For each bundle group, show header and add classes
            Object.keys(bundleGroups).forEach(bundleId => {
              const bundleItems = bundleGroups[bundleId];
              
              if (bundleItems.length > 0) {
                // Show header and move to before first item
                const header = productContainer.querySelector(`.bundle-header[data-bundle-id="${bundleId}"]`);
                const firstItem = bundleItems[0];
                
                if (header && firstItem) {
                  header.style.display = 'block';
                  firstItem.parentNode.insertBefore(header, firstItem);
                }
                
                // Add classes to first and last items for seamless styling
                bundleItems.forEach((item, index) => {
                  item.classList.remove('bundle-item-first', 'bundle-item-last', 'bundle-item-middle');
                  
                  if (bundleItems.length === 1) {
                    item.classList.add('bundle-item-single');
                  } else if (index === 0) {
                    item.classList.add('bundle-item-first');
                  } else if (index === bundleItems.length - 1) {
                    item.classList.add('bundle-item-last');
                  } else {
                    item.classList.add('bundle-item-middle');
                  }
                });
              }
            });
          }
        }

        function createDiscountField(cart, discountCode) {
          
          // Remove any existing discount fields (both from Liquid and JS) to avoid duplicates
          // We'll recreate them from the current cart data
          document.querySelectorAll('.cart-drawer__discount-item').forEach(item => item.remove());
          
          const summaryContainer = document.querySelector('.cart-drawer__summary');
          if (!summaryContainer) {
            console.log('Summary container not found');
            return;
          }
          
          // Find the "Tạm tính" (Subtotal) item to insert discount before it
          const subtotalItem = summaryContainer.querySelector('[data-subtotal]')?.closest('.cart-drawer__summary-item') || 
                               Array.from(summaryContainer.querySelectorAll('.cart-drawer__summary-item')).find(item => 
                                 item.textContent.includes('Tạm tính')
                               );
          
          // Handle cart-level discounts (order discounts, shipping discounts)
          if (cart.cart_level_discount_applications && cart.cart_level_discount_applications.length > 0) {
            cart.cart_level_discount_applications.forEach((cartDiscount, index) => {
            cart.cart_level_discount_applications.forEach((cartDiscount, index) => {
              
              const discountItem = document.createElement('div');
              discountItem.className = 'cart-drawer__summary-item cart-drawer__discount-item';
              
              // Use value directly from Shopify API - no modification
              let discountAmount = 0;
              let discountTitle = 'Discount';
              
              if (cartDiscount.total_allocated_amount !== undefined) {
                discountAmount = cartDiscount.total_allocated_amount;
              } else if (cartDiscount.amount !== undefined) {
                discountAmount = cartDiscount.amount;
              }
              
              if (cartDiscount.title) {
                discountTitle = cartDiscount.title;
              } else if (cartDiscount.discount_application && cartDiscount.discount_application.title) {
                discountTitle = cartDiscount.discount_application.title;
              }
              
              
              discountItem.innerHTML = `
                <span class="cart-drawer__discount-title">Giảm giá</span>
                <div class="cart-drawer__discount-right">
                  <span class="cart-drawer__discount-amount">${formatDiscountAmount(discountAmount)}</span>
                  <button type="button" class="cart-drawer__discount-remove" data-discount-title="${discountTitle}" title="Bỏ mã giảm giá">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              `;
              
              // Insert before subtotal item, or at the beginning of summary if subtotal not found
              if (subtotalItem) {
                summaryContainer.insertBefore(discountItem, subtotalItem);
              } else {
                summaryContainer.insertBefore(discountItem, summaryContainer.firstChild);
              }
            });
            
            console.log('Created discount field in summary section');
          } 
          // Handle product discounts (don't appear in cart_level_discount_applications but reflected in total_discount)
          else if (cart.total_discount > 0 && discountCode) {
            
            const discountItem = document.createElement('div');
            discountItem.className = 'cart-drawer__summary-item cart-drawer__discount-item';
            
            discountItem.innerHTML = `
              <span class="cart-drawer__discount-title">Giảm giá (${discountCode})</span>
              <div class="cart-drawer__discount-right">
                <span class="cart-drawer__discount-amount">${formatDiscountAmount(cart.total_discount)}</span>
                <button type="button" class="cart-drawer__discount-remove" data-discount-title="${discountCode}" title="Bỏ mã giảm giá">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            `;
            
            // Insert before subtotal item, or at the beginning of summary if subtotal not found
            if (subtotalItem) {
              summaryContainer.insertBefore(discountItem, subtotalItem);
            } else {
              summaryContainer.insertBefore(discountItem, summaryContainer.firstChild);
            }
            
            console.log('Created product discount field in summary section');
          } else {
            console.log('No discount applications found in cart');
          }

          updateCartDrawerLayout();
        }

        function updateCartPrices(cart) {
          
          // Update subtotal immediately using server cart total (already includes discounts)
          const subtotalElement = document.querySelector('[data-subtotal]');
          if (subtotalElement) {
            subtotalElement.textContent = formatMoney(cart.total_price);
            console.log('Updated subtotal immediately:', formatMoney(cart.total_price));
          }
          
          // Calculate original price from DOM (before any discounts)
          let totalOriginalPrice = 0;
          const cartItems = document.querySelectorAll('#CartDrawer .cart__item');
          // Parse price from DOM - remove all non-digit characters (dots, spaces, VNĐ, ₫, m-symbol, etc.)
          const parsePrice = (el) => {
            if (!el) return 0;
            let text = el.textContent || '';
            // Remove m-symbol and its content if present
            const mSymbol = el.querySelector('.m-symbol');
            if (mSymbol) {
              text = text.replace(mSymbol.textContent, '');
            }
            // Remove all non-digit characters
            const cleaned = text.replace(/[^\d]/g, '');
            return parseInt(cleaned, 10) || 0;
          };
          
          cartItems.forEach(item => {
            const quantity = parseInt(item.dataset.quantity, 10) || 1;
            const originalPriceEl = item.querySelector('.cart-item__price--original');
            const finalPriceEl = item.querySelector('.cart-item__price--final');
            const originalPriceUnit = originalPriceEl ? parsePrice(originalPriceEl) : parsePrice(finalPriceEl);
            totalOriginalPrice += originalPriceUnit * quantity;
          });
          
          // Total savings = original price - final price (from server, includes all discounts)
          // Note: cart.total_price from API is in smallest unit (multiplied by 100)
          // totalOriginalPrice from DOM is in main unit (parsed from formatted text)
          // Convert totalOriginalPrice to smallest unit to match API, then calculate savings
          const totalOriginalPriceInSmallestUnit = totalOriginalPrice * 100;
          const totalSavingsInSmallestUnit = totalOriginalPriceInSmallestUnit - cart.total_price;
          
          console.log('updateCartPrices - Server calculation:', {
            totalOriginalPrice,
            totalOriginalPriceInSmallestUnit,
            serverTotalPrice: cart.total_price,
            totalSavingsInSmallestUnit
          });
          
          const savingsDisplay = document.querySelector('[data-savings-display]');
          
          // Always show savings banner and update amount
          if (savingsDisplay) {
            savingsDisplay.style.display = '';
            const savingsAmountEl = savingsDisplay.querySelector('.cart-drawer__savings-amount');
            if (savingsAmountEl) {
              // Trigger animation
              savingsAmountEl.classList.remove('animate');
              setTimeout(() => {
                savingsAmountEl.textContent = formatMoney(totalSavingsInSmallestUnit);
                savingsAmountEl.classList.add('animate');
              }, 10);
            } else {
              // Fallback: update entire text if structure not found
              const savingsText = savingsDisplay.querySelector('.cart-drawer__savings-text');
              if (savingsText) {
                savingsText.innerHTML = 'Bạn đã tiết kiệm được <span class="cart-drawer__savings-amount animate">' + formatMoney(totalSavingsInSmallestUnit) + '</span>';
              }
            }
          }
          
          // Show/hide original price
          const priceContainer = document.querySelector('.cart-drawer__summary-item .price-container');
          if (priceContainer) {
            let priceOriginalEl = priceContainer.querySelector('.price--original');
            if (totalSavingsInSmallestUnit > 0) {
              if (!priceOriginalEl) {
                priceOriginalEl = document.createElement('del');
                priceOriginalEl.className = 'price--original';
                priceContainer.insertBefore(priceOriginalEl, subtotalElement);
              }
              priceOriginalEl.textContent = formatMoney(totalOriginalPriceInSmallestUnit);
              priceOriginalEl.style.display = '';
            } else {
              if (priceOriginalEl) priceOriginalEl.style.display = 'none';
            }
          }
          
          // Show "Đã áp dụng ưu đãi" text
          const discountText = document.querySelector('.cart-drawer__summary-item .text-right');
          if (discountText && cart.cart_level_discount_applications && cart.cart_level_discount_applications.length > 0) {
            discountText.style.display = '';
          }

          updateCartDrawerLayout();
        }

        function updateCartPricesAfterRemoval(cart) {
          
          // Update subtotal immediately
          const subtotalElement = document.querySelector('[data-subtotal]');
          if (subtotalElement) {
            subtotalElement.textContent = formatMoney(cart.total_price);
            console.log('Updated subtotal after removal:', formatMoney(cart.total_price));
          }
          
          // Calculate new savings (without cart-level discounts)
          let totalOriginalPrice = 0;
          const cartItems = document.querySelectorAll('#CartDrawer .cart__item');
          // Parse price from DOM - remove all non-digit characters (dots, spaces, VNĐ, ₫, m-symbol, etc.)
          const parsePrice = (el) => {
            if (!el) return 0;
            let text = el.textContent || '';
            // Remove m-symbol and its content if present
            const mSymbol = el.querySelector('.m-symbol');
            if (mSymbol) {
              text = text.replace(mSymbol.textContent, '');
            }
            // Remove all non-digit characters
            const cleaned = text.replace(/[^\d]/g, '');
            return parseInt(cleaned, 10) || 0;
          };
          
          cartItems.forEach(item => {
            const quantity = parseInt(item.dataset.quantity, 10) || 1;
            const originalPriceEl = item.querySelector('.cart-item__price--original');
            const finalPriceEl = item.querySelector('.cart-item__price--final');
            const originalPriceUnit = originalPriceEl ? parsePrice(originalPriceEl) : parsePrice(finalPriceEl);
            totalOriginalPrice += originalPriceUnit * quantity;
          });
          
          // Convert totalOriginalPrice to smallest unit to match API
          const totalOriginalPriceInSmallestUnit = totalOriginalPrice * 100;
          const newSavingsInSmallestUnit = totalOriginalPriceInSmallestUnit - cart.total_price;
          
          // Update savings display
          const savingsDisplay = document.querySelector('[data-savings-display]');
          
          // Show/hide savings banner based on newSavings
          if (savingsDisplay) {
            // Always show savings banner and update amount
            savingsDisplay.style.display = '';
            const savingsAmountEl = savingsDisplay.querySelector('.cart-drawer__savings-amount');
            if (savingsAmountEl) {
              // Trigger animation
              savingsAmountEl.classList.remove('animate');
              setTimeout(() => {
                savingsAmountEl.textContent = formatMoney(newSavingsInSmallestUnit);
                savingsAmountEl.classList.add('animate');
              }, 10);
            } else {
              // Fallback: update entire text if structure not found
              const savingsText = savingsDisplay.querySelector('.cart-drawer__savings-text');
              if (savingsText) {
                savingsText.innerHTML = 'Bạn đã tiết kiệm được <span class="cart-drawer__savings-amount animate">' + formatMoney(newSavingsInSmallestUnit) + '</span>';
              }
            }
          }
          
          // Hide original price if no savings
          const priceContainer = document.querySelector('.cart-drawer__summary-item .price-container');
          if (priceContainer) {
            let priceOriginalEl = priceContainer.querySelector('.price--original');
            if (newSavingsInSmallestUnit > 0) {
              if (!priceOriginalEl) {
                priceOriginalEl = document.createElement('del');
                priceOriginalEl.className = 'price--original';
                priceContainer.insertBefore(priceOriginalEl, subtotalElement);
              }
              priceOriginalEl.textContent = formatMoney(totalOriginalPriceInSmallestUnit);
              priceOriginalEl.style.display = '';
            } else {
              if (priceOriginalEl) priceOriginalEl.style.display = 'none';
            }
          }
          
          // Hide "Đã áp dụng ưu đãi" text
          const discountText = document.querySelector('.cart-drawer__summary-item .text-right');
          if (discountText) {
            discountText.style.display = 'none';
          }
          
          // Remove all discount fields
          document.querySelectorAll('.cart-drawer__discount-item').forEach(item => item.remove());

          updateCartDrawerLayout();
        }

        function formatMoney(amount) {
          if (amount === undefined || amount === null) {
            return '0₫';
          }
          // IMPORTANT: Shopify API returns prices in smallest currency unit
          // For VND: API returns 25000000 for 250.000 VND (multiplied by 100)
          // Liquid filter | money automatically divides by 100
          // JavaScript must match Liquid behavior by dividing by 100
          const amountInMainUnit = amount / 100;
          return amountInMainUnit.toLocaleString('vi-VN') + '₫';
        }
        
        // Function for discount amounts
        function formatDiscountAmount(amount) {
          if (amount === undefined || amount === null) {
            return '0₫';
          }
          // IMPORTANT: Shopify API returns discount amounts in smallest currency unit
          // For VND: API returns 25000000 for 250.000 VND (multiplied by 100)
          // Liquid filter | money automatically divides by 100
          // JavaScript must match Liquid behavior by dividing by 100
          const amountInMainUnit = amount / 100;
          return amountInMainUnit.toLocaleString('vi-VN') + '₫';
        }

        function updateDiscountApplications() {
          // This function will be called after cart rebuild to update discount display
          // The discount applications are already rendered in the HTML by Liquid
          // We just need to ensure they're visible and properly styled
          const discountItems = document.querySelectorAll('.cart-drawer__discount-item');
          
          discountItems.forEach(item => {
            item.style.display = '';
          });
        }

        function syncCartUIFromDOM() {
          const countElement = document.querySelector('.drawer__count');
          const cartItems = document.querySelectorAll('#CartDrawer .cart__item');

          // Part 1: Update Count by reading DOM
          const bundleGroups = {};
          let standaloneItemCount = 0;
          let totalStandaloneQty = 0;
          cartItems.forEach(item => {
            const bundleId = item.dataset.bundleId;
            if (bundleId) {
              if (!bundleGroups[bundleId]) bundleGroups[bundleId] = [];
              bundleGroups[bundleId].push(item);
            } else {
              standaloneItemCount++;
              totalStandaloneQty += parseInt(item.dataset.quantity, 10) || 1;
            }
          });

          const bundleCount = Object.keys(bundleGroups).length;
          let countText = '0 sản phẩm';
          if (cartItems.length > 0) {
            if (bundleCount > 0 && standaloneItemCount === 0) {
              countText = `${bundleCount} bộ sản phẩm`;
            } else if (bundleCount > 0 && standaloneItemCount > 0) {
              countText = `${bundleCount} bộ + ${totalStandaloneQty} sản phẩm`;
            } else if (standaloneItemCount > 0) {
              countText = `${totalStandaloneQty} sản phẩm`;
            }
          }
          if (countElement) countElement.textContent = countText;

          // Part 2: Update Summary Prices by reading DOM
          let totalOriginalPrice = 0, totalFinalPrice = 0;
          // Parse price from DOM - remove all non-digit characters (dots, spaces, VNĐ, ₫, m-symbol, etc.)
          const parsePrice = (el) => {
            if (!el) return 0;
            let text = el.textContent || '';
            // Remove m-symbol and its content if present
            const mSymbol = el.querySelector('.m-symbol');
            if (mSymbol) {
              text = text.replace(mSymbol.textContent, '');
            }
            // Remove all non-digit characters
            const cleaned = text.replace(/[^\d]/g, '');
            return parseInt(cleaned, 10) || 0;
          };

          // Calculate total from cart items
          cartItems.forEach(item => {
            const quantity = parseInt(item.dataset.quantity, 10) || 1;
            const finalPriceUnit = parsePrice(item.querySelector('.cart-item__price--final'));
            const originalPriceEl = item.querySelector('.cart-item__price--original');
            const originalPriceUnit = originalPriceEl ? parsePrice(originalPriceEl) : finalPriceUnit;
            totalFinalPrice += finalPriceUnit * quantity;
            totalOriginalPrice += originalPriceUnit * quantity;
          });

          // Get voucher discount amount from DOM first
          let voucherDiscountAmount = 0;
          const discountItems = document.querySelectorAll('.cart-drawer__discount-amount');
          discountItems.forEach(discountEl => {
            // Parse discount amount - remove m-symbol if present
            let text = discountEl.textContent || '';
            const mSymbol = discountEl.querySelector('.m-symbol');
            if (mSymbol) {
              text = text.replace(mSymbol.textContent, '');
            }
            const cleaned = text.replace(/[^\d]/g, '');
            const discountAmount = parseInt(cleaned, 10) || 0;
            voucherDiscountAmount += discountAmount;
          });

          // Calculate savings from price difference (more reliable)
          // Values from DOM are in main unit, convert to smallest unit for formatting
          const totalOriginalPriceInSmallestUnit = totalOriginalPrice * 100;
          const totalFinalPriceInSmallestUnit = totalFinalPrice * 100;
          const priceDifference = totalOriginalPriceInSmallestUnit - totalFinalPriceInSmallestUnit;
          const totalSavingsInSmallestUnit = priceDifference > 0 ? priceDifference : 0;
          const finalPriceAfterVoucherInSmallestUnit = totalFinalPriceInSmallestUnit;
          

          const savingsDisplay = document.querySelector('[data-savings-display]');
          if (savingsDisplay) {
            // Always show savings banner
            savingsDisplay.style.display = '';
            const savingsAmountEl = savingsDisplay.querySelector('.cart-drawer__savings-amount');
            if (savingsAmountEl) {
              // Trigger animation
              savingsAmountEl.classList.remove('animate');
              setTimeout(() => {
                savingsAmountEl.textContent = formatMoney(totalSavingsInSmallestUnit);
                savingsAmountEl.classList.add('animate');
              }, 10);
            } else {
              // Fallback: update entire text if structure not found
              const savingsText = savingsDisplay.querySelector('.cart-drawer__savings-text');
              if (savingsText) {
                savingsText.innerHTML = 'Bạn đã tiết kiệm được <span class="cart-drawer__savings-amount animate">' + formatMoney(totalSavingsInSmallestUnit) + '</span>';
              }
            }
          }
          
          // Update subtotal with price after voucher discount
          const subtotalElement = document.querySelector('[data-subtotal]');
          if (subtotalElement) {
            subtotalElement.textContent = formatMoney(finalPriceAfterVoucherInSmallestUnit);
            console.log('Updated subtotal to:', formatMoney(finalPriceAfterVoucherInSmallestUnit));
          }
          
          const priceContainer = document.querySelector('.cart-drawer__summary-item .price-container');
          if (priceContainer) {
            let priceOriginalEl = priceContainer.querySelector('.price--original');
            if (totalSavingsInSmallestUnit > 0) {
              if (!priceOriginalEl) {
                priceOriginalEl = document.createElement('del');
                priceOriginalEl.className = 'price--original';
                priceContainer.insertBefore(priceOriginalEl, subtotalElement);
              }
              priceOriginalEl.textContent = formatMoney(totalOriginalPriceInSmallestUnit);
              priceOriginalEl.style.display = '';
            } else {
              if (priceOriginalEl) priceOriginalEl.style.display = 'none';
            }
          }
          
          // Update discount applications display
          updateDiscountApplications();
          
          // Update discount applied text
          const discountText = document.querySelector('.cart-drawer__summary-item .text-right');
          if (discountText) {
            // Check if there are any discount applications by looking for discount-related elements
            const hasDiscount = document.querySelector('[data-discount]') || 
                               document.querySelector('.cart-item__discount') ||
                               document.querySelector('.cart-drawer__discount-item') ||
                               totalSavings > 0;
            discountText.style.display = hasDiscount ? '' : 'none';
          }
          
          // Part 3: Add/Update Bundle Footer
          document.querySelectorAll('.bundle-footer').forEach(f => f.remove());
          document.querySelectorAll('.is-before-footer').forEach(i => i.classList.remove('is-before-footer'));
          Object.keys(bundleGroups).forEach(bundleId => {
            const items = bundleGroups[bundleId];
            if (items.length === 0) return;
            const lastItem = items[items.length - 1];
            lastItem.classList.add('is-before-footer');

            const itemKeys = items.map(item => item.dataset.key);
            const customBundleQty = items[0].dataset.bundleQuantity;
            const currentQuantity = customBundleQty ? parseInt(customBundleQty, 10) : 1;
            const footer = document.createElement('div');
            footer.className = 'bundle-footer';
            const removeBtnHTML = `<button type="button" class="cart-item__remove bundle__remove" data-bundle-keys="${itemKeys.join(',')}" title="Xóa bộ sản phẩm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3 6H5H21" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`;
            const qtyWrapperHTML = `<div style="display: flex; align-items: center; gap: 10px; margin-left: auto;"><span>Số lượng bộ:</span><div class="js-qty__wrapper bundle__qty-wrapper" data-bundle-keys="${itemKeys.join(',')}"><button type="button" class="js-qty__adjust js-qty__adjust--minus">&minus;</button><input type="text" class="js-qty__num" value="${currentQuantity}" min="1" pattern="[0-9]*" readonly><button type="button" class="js-qty__adjust js-qty__adjust--plus">+</button></div></div>`;
            footer.innerHTML = `${removeBtnHTML} ${qtyWrapperHTML}`;
            lastItem.insertAdjacentElement('afterend', footer);
          });

          updateCartDrawerLayout();
        }

        // Use MutationObserver to detect when cart items are loaded/updated
        const productContainer = document.querySelector('#CartDrawer [data-products]');
        if (productContainer) {
          const observer = new MutationObserver((mutationsList) => {
            for(const mutation of mutationsList) {
              if (mutation.type === 'childList') {
                handleBundleHeaders();
                syncCartUIFromDOM();
                updateCartDrawerLayout();
                break; 
              }
            }
          });
          observer.observe(productContainer, { childList: true });
        }
        
        // Listen for cart:updated event from bundle add to cart
        document.addEventListener('cart:updated', function() {
          console.log('Cart updated event received, showing bundle headers...');
          setTimeout(() => {
            handleBundleHeaders();
            syncCartUIFromDOM();
            updateCartDrawerLayout();
            // Only check stored voucher if not already checked
            if (!hasCheckedStoredVoucher) {
              hasCheckedStoredVoucher = true;
              checkStoredBundleVoucher();
            }
          }, 100);
        });
        
        // Also run on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(() => {
            handleBundleHeaders();
            syncCartUIFromDOM();
            updateCartDrawerLayout();
            // Only check stored voucher if not already checked
            if (!hasCheckedStoredVoucher) {
              hasCheckedStoredVoucher = true;
              checkStoredBundleVoucher();
            }
          }, 500);
        });

        // NOTE: All manual quantity listeners are removed. 
        // The MutationObserver + the master bundle controls handle everything.

        // --- Event Delegation for Clicks ---
        document.addEventListener('click', function(event) {
          const target = event.target;

          // --- BUNDLE CONTROLS (HIGHEST PRIORITY) ---
          const bundleRemoveBtn = target.closest('.bundle__remove');
          if (bundleRemoveBtn) {
              event.preventDefault();
              const keys = bundleRemoveBtn.dataset.bundleKeys.split(',');
              if (keys.length === 0 || keys[0] === '') return;
              const updates = keys.reduce((acc, key) => {
                  if (key) acc[key] = 0;
                  return acc;
              }, {});
              fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ updates: updates })
              }).then(res => res.json()).then(cart => rebuildCart()).catch(e => console.error(e));
              return;
          }
      
          const bundleQtyAdjust = target.closest('.bundle__qty-wrapper .js-qty__adjust');
          if (bundleQtyAdjust) {
              event.stopImmediatePropagation();
              event.preventDefault();
              const wrapper = bundleQtyAdjust.closest('.bundle__qty-wrapper');
              const input = wrapper.querySelector('.js-qty__num');
              const keys = wrapper.dataset.bundleKeys.split(',');
              if (keys.length === 0 || keys[0] === '') return;
              let currentQty = parseInt(input.value);
              let newQty = bundleQtyAdjust.classList.contains('js-qty__adjust--minus') ? Math.max(1, currentQty - 1) : currentQty + 1;
              if (newQty === currentQty) return;
              input.value = newQty;
              const updates = keys.reduce((acc, key) => {
                  if (key) acc[key] = newQty;
                  return acc;
              }, {});
              fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ updates: updates })
              }).then(res => res.json()).then(cart => rebuildCart()).catch(e => console.error(e));
              return;
          }

          // Handle Regular Cart Item Quantity Adjust (not bundle)
          const regularQtyAdjust = target.closest('.js-qty__adjust');
          if (regularQtyAdjust && !regularQtyAdjust.closest('.bundle__qty-wrapper') && !regularQtyAdjust.closest('.cross-sell-item__quantity-wrapper')) {
              event.preventDefault();
              const wrapper = regularQtyAdjust.closest('.js-qty__wrapper');
              const input = wrapper.querySelector('.js-qty__num');
              const itemKey = input.dataset.id;
              
              if (!itemKey) return;
              
              let currentQty = parseInt(input.value) || 0;
              let newQty = regularQtyAdjust.classList.contains('js-qty__adjust--minus') ? Math.max(0, currentQty - 1) : currentQty + 1;
              
              if (newQty === currentQty) return;
              
              // Update quantity via API
              fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ updates: { [itemKey]: newQty } })
              })
              .then(res => res.json())
              .then(cart => {
                  // Rebuild cart to update prices
                  rebuildCart();
              })
              .catch(e => console.error('Error updating quantity:', e));
            return;
          }

          // Handle Cross-sell Slider Arrows
          // Handle Voucher Carousel Arrows
          const voucherPrevArrow = target.closest('.cart-drawer__carousel-arrow.prev');
          const voucherNextArrow = target.closest('.cart-drawer__carousel-arrow.next');
          if (voucherPrevArrow || voucherNextArrow) {
            const voucherList = document.querySelector('.cart-drawer__voucher-list');
            if (!voucherList) return;
            
            const voucherItemWidth = voucherList.querySelector('.cart-drawer__voucher-item').clientWidth;
            const currentTransform = voucherList.style.transform || 'translateX(0px)';
            const currentX = parseInt(currentTransform.match(/-?\d+/)[0]) || 0;
            
            if (voucherPrevArrow) {
              const newX = Math.min(0, currentX + voucherItemWidth);
              voucherList.style.transform = `translateX(${newX}px)`;
            } else if (voucherNextArrow) {
              const maxX = -(voucherList.scrollWidth - voucherList.parentElement.clientWidth);
              const newX = Math.max(maxX, currentX - voucherItemWidth);
              voucherList.style.transform = `translateX(${newX}px)`;
            }
            return;
          }

          // Handle Apply Discount Button
          const applyButton = target.closest('.cart-drawer__discount-button');
          if (applyButton) {
            event.preventDefault();
            const form = applyButton.closest('form');
            const discountInput = form.querySelector('input[name="discount"]');
            if (!discountInput.value) {
              alert('Vui lòng nhập mã giảm giá.');
              return;
            }
            
            const originalButtonText = applyButton.textContent;
            applyButton.textContent = 'Đang áp dụng...';
            applyButton.disabled = true;

            fetch('/cart/update.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ 'discount': discountInput.value })
            })
            .then(res => res.json())
            .then(cart => {
              console.log('Discount applied, cart response:', cart);
              
              // Fetch fresh cart to verify discount application
              return fetch('/cart.js')
                .then(response => response.json())
                .then(freshCart => {
                  const discountApplied = freshCart.cart_level_discount_applications && 
                                         freshCart.cart_level_discount_applications.length > 0;
                  
                  if (discountApplied) {
                    // Success - clear the input and update UI
                    discountInput.value = '';
                    
                    // Ensure voucher persists through checkout
                    ensureBundleVoucherPersistence();
                    
                    // Update prices and create discount field
                    updateCartPrices(freshCart);
                    createDiscountField(freshCart, discountInput.value);
                    
                    // Rebuild cart for full sync
                    rebuildCart();
                    
                    // Fetch fresh cart data after rebuild and update prices again
                    setTimeout(() => {
                      fetch('/cart.js')
                        .then(response => response.json())
                        .then(finalCart => {
                          updateCartPrices(finalCart);
                          if (finalCart.cart_level_discount_applications && finalCart.cart_level_discount_applications.length > 0) {
                            createDiscountField(finalCart, discountInput.value);
                          }
                        })
                        .catch(error => console.error('Error fetching cart after rebuild:', error));
                    }, 800);
                  } else {
                    // Failure - discount was not applied
                    alert('Mã giảm giá không hợp lệ hoặc chưa đáp ứng điều kiện áp dụng.');
                    discountInput.value = '';
                  }
                  
                  applyButton.textContent = originalButtonText;
                  applyButton.disabled = false;
                });
            })
            .catch(e => {
              console.error(e);
              applyButton.textContent = originalButtonText;
              applyButton.disabled = false;
            });
            return;
          }

          // Handle Cross-Sell Add to Cart Button
          const addButton = target.closest('.cross-sell-item__add-btn');
          if (addButton) {
            event.preventDefault();
            const form = addButton.closest('form');
            const submitButton = form.querySelector('.cross-sell-item__add-btn');
            const quantityInput = form.querySelector('.cross-sell-qty__num');
            
            if (!quantityInput || parseInt(quantityInput.value) < 1) {
              alert('Vui lòng chọn số lượng sản phẩm.');
              return;
            }
            
            const originalButtonText = submitButton.textContent;
            submitButton.textContent = 'Đang thêm...';
            submitButton.disabled = true;

            // Update the hidden variant input with selected variant
            const variantSelect = form.closest('.cart-drawer__cross-sell-item').querySelector('.cross-sell-item__variant-select');
            if (variantSelect) {
              const hiddenIdInput = form.querySelector('input[name="id"]');
              hiddenIdInput.value = variantSelect.value;
            }

            fetch('{{ routes.cart_add_url }}.js', {
              method: 'POST',
              body: new FormData(form),
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(item => {
              if (item.status) {
                alert(item.description || 'Sản phẩm đã hết hàng.');
              } else {
                // Reset quantity to 1 after successful add
                quantityInput.value = '1';
              }
              // Add delay to ensure server state is updated before rebuilding cart
              setTimeout(() => {
                rebuildCart();
              }, 500);
            })
            .catch(e => console.error(e))
            .finally(() => {
              submitButton.textContent = originalButtonText;
              submitButton.disabled = false;
            });
            return;
          }

          // Handle Cross-sell Quantity Adjust Buttons
          const qtyAdjust = target.closest('.cross-sell-qty__adjust');
          if (qtyAdjust) {
            event.preventDefault();
            event.stopPropagation();
            const isPlus = qtyAdjust.classList.contains('cross-sell-qty__adjust--plus');
            const quantityInput = qtyAdjust.parentElement.querySelector('.cross-sell-qty__num');
            if (!quantityInput) return;
            
            let currentValue = parseInt(quantityInput.value) || 0;
            if (isPlus) {
              quantityInput.value = currentValue + 1;
            } else {
              quantityInput.value = Math.max(0, currentValue - 1);
            }
            return;
          }

          // Handle Discount Remove Button
          const discountRemoveButton = target.closest('.cart-drawer__discount-remove');
          if (discountRemoveButton) {
            event.preventDefault();
            const discountTitle = discountRemoveButton.dataset.discountTitle;
            
            if (!discountTitle) return;
            
            const originalButtonContent = discountRemoveButton.innerHTML;
            discountRemoveButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="1.5"/><path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            discountRemoveButton.disabled = true;
            
            // Immediately hide the discount item for better UX
            const discountItem = discountRemoveButton.closest('.cart-drawer__discount-item');
            if (discountItem) {
              discountItem.style.display = 'none';
            }
            
            // Remove discount by setting it to empty string
            fetch('/cart/update.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ 'discount': '' })
            })
            .then(response => response.json())
            .then(cart => {
              console.log('Discount removed, cart response:', cart);
              
              // Immediately update prices and remove discount field
              updateCartPricesAfterRemoval(cart);
              
              // Rebuild cart for full sync
              rebuildCart();
            })
            .catch(error => {
              console.error('Error removing discount:', error);
              // Restore the button and show discount item again
              discountRemoveButton.innerHTML = originalButtonContent;
              discountRemoveButton.disabled = false;
              if (discountItem) {
                discountItem.style.display = '';
              }
            });
            return;
          }

          // Handle Voucher Copy Button
          const copyButton = target.closest('.voucher-copy-button');
          if (copyButton) {
            event.preventDefault();
            const codeToCopy = copyButton.dataset.copyCode;
            
            navigator.clipboard.writeText(codeToCopy).then(() => {
              const originalText = copyButton.textContent;
              copyButton.textContent = 'Đã chép!';
              copyButton.classList.add('copied');
              copyButton.disabled = true;
              setTimeout(() => {
                copyButton.textContent = originalText;
                copyButton.classList.remove('copied');
                copyButton.disabled = false;
              }, 2000);
            }).catch(err => {
              console.error('Không thể sao chép: ', err);
              alert('Không thể sao chép mã.');
            });
            return;
          }

          // Handle Cart Item Remove Button
          const removeButton = target.closest('.cart-item__remove');
          if (removeButton) {
            event.preventDefault();
            const itemId = removeButton.dataset.id;
            
            if (!itemId) return;
            
            const originalButtonContent = removeButton.innerHTML;
            removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#25282B" stroke-width="1.5"/><path d="M9 12l2 2 4-4" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            removeButton.disabled = true;
            
            fetch('/cart/change.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ id: itemId, quantity: 0 })
            })
            .then(response => response.json())
            .then(cart => {
              rebuildCart();
            })
            .catch(error => {
              console.error('Error removing item:', error);
              removeButton.innerHTML = originalButtonContent;
              removeButton.disabled = false;
            });
            return;
          }
        });

        // --- Event Delegation for Form Submissions ---
        document.addEventListener('submit', function(event) {
          // ... (existing submit handler)
        });
        
        // --- Event Delegation for Select Focus/Blur to toggle arrow direction ---
        document.addEventListener('focusin', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                event.target.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 11.25L9 6.75L13.5 11.25' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            }
        });

        document.addEventListener('focusout', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                event.target.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 6.75L9 11.25L13.5 6.75' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            }
        });

        // Handle variant select change
        document.addEventListener('change', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                const select = event.target;
                const crossSellItem = select.closest('.cart-drawer__cross-sell-item');
                const form = crossSellItem.querySelector('.cross-sell-item__form');
                const hiddenIdInput = form.querySelector('input[name="id"]');
                
                // Update the hidden variant input
                hiddenIdInput.value = select.value;
                
                // Update price display if needed
                // This would require fetching variant data from Shopify
                // For now, we'll just update the variant ID
            }
        });
        
        // Listen for drawer open events
        document.addEventListener('click', function(event) {
          // Check if cart drawer should be opened
          if (event.target.closest('[data-cart-drawer-toggle]') || 
              event.target.closest('.cart-link') ||
              event.target.closest('[href*="cart"]')) {
            setTimeout(() => {
              ensureDrawerVisible();
              // Check for stored vouchers when drawer opens (only if not already checked)
              if (!hasCheckedStoredVoucher) {
                hasCheckedStoredVoucher = true;
                setTimeout(() => checkStoredBundleVoucher(), 500);
              }
            }, 100);
          }
          
          // Check if cart drawer should be closed
          if (event.target.closest('.js-drawer-close') || 
              event.target.closest('[data-cart-drawer-close]')) {
            setTimeout(showStickyAddToCart, 100);
          }
        });
        
        // Also ensure drawer is visible on page load if it should be open
        if (document.getElementById('CartDrawer').classList.contains('drawer--is-open')) {
          ensureDrawerVisible();
        }
        
        // Update cart count on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          syncCartUIFromDOM();
          // Only check stored voucher if not already checked
          if (!hasCheckedStoredVoucher) {
            hasCheckedStoredVoucher = true;
            checkStoredBundleVoucher();
          }
          
          // Initialize drag scroll for cross-sell slider
          initCrossSellDragScroll();
        });
        
        // Drag and scroll functionality for cross-sell slider
        function initCrossSellDragScroll() {
          const slider = document.querySelector('.cart-drawer__cross-sell-slider');
          if (!slider) return;
          
          let isDragging = false;
          let startX = 0;
          let startY = 0;
          let scrollLeft = 0;
          let scrollTop = 0;
          let lastX = 0;
          let lastY = 0;
          let velocity = 0;
          let animationFrame = null;
          let isHorizontalScroll = false;
          
          // Smooth scroll update using requestAnimationFrame
          function updateScroll() {
            if (!isDragging) return;
            animationFrame = requestAnimationFrame(updateScroll);
          }
          
          // Determine scroll direction based on initial movement
          function determineScrollDirection(currentX, currentY) {
            const deltaX = Math.abs(currentX - startX);
            const deltaY = Math.abs(currentY - startY);
            return deltaX > deltaY;
          }
          
          // Mouse events
          slider.addEventListener('mousedown', (e) => {
            // Don't interfere with interactive elements like select, input, button
            if (e.target.matches('select, input, button, a, .cross-sell-item__variant-select, .cross-sell-item__add-btn, .cross-sell-qty__adjust')) {
              return;
            }
            
            isDragging = true;
            slider.style.cursor = 'grabbing';
            slider.style.userSelect = 'none';
            startX = e.pageX;
            startY = e.pageY;
            scrollLeft = slider.scrollLeft;
            scrollTop = slider.scrollTop;
            lastX = e.pageX;
            lastY = e.pageY;
            velocity = 0;
            isHorizontalScroll = false;
            e.preventDefault();
            updateScroll();
          });
          
          slider.addEventListener('mouseleave', () => {
            isDragging = false;
            slider.style.cursor = 'grab';
            slider.style.userSelect = '';
            if (animationFrame) {
              cancelAnimationFrame(animationFrame);
              animationFrame = null;
            }
          });
          
          slider.addEventListener('mouseup', () => {
            isDragging = false;
            slider.style.cursor = 'grab';
            slider.style.userSelect = '';
            if (animationFrame) {
              cancelAnimationFrame(animationFrame);
              animationFrame = null;
            }
          });
          
          slider.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            // Determine scroll direction on first move
            if (!isHorizontalScroll && (Math.abs(e.pageX - startX) > 5 || Math.abs(e.pageY - startY) > 5)) {
              isHorizontalScroll = determineScrollDirection(e.pageX, e.pageY);
            }
            
            if (isHorizontalScroll) {
              e.preventDefault();
              const currentX = e.pageX;
              const diff = currentX - startX;
              slider.scrollLeft = scrollLeft - diff;
              velocity = currentX - lastX;
              lastX = currentX;
            } else {
              // Allow vertical scrolling
              const currentY = e.pageY;
              const diff = currentY - startY;
              slider.scrollTop = scrollTop - diff;
              lastY = currentY;
            }
          });
          
          // Touch events for mobile
          slider.addEventListener('touchstart', (e) => {
            // Don't interfere with interactive elements like select, input, button
            if (e.target.matches('select, input, button, a, .cross-sell-item__variant-select, .cross-sell-item__add-btn, .cross-sell-qty__adjust')) {
              return;
            }
            
            isDragging = true;
            startX = e.touches[0].pageX;
            startY = e.touches[0].pageY;
            scrollLeft = slider.scrollLeft;
            scrollTop = slider.scrollTop;
            lastX = e.touches[0].pageX;
            lastY = e.touches[0].pageY;
            velocity = 0;
            isHorizontalScroll = false;
            // Don't preventDefault here - let the browser determine scroll direction
          }, { passive: true });
          
          slider.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            const currentX = e.touches[0].pageX;
            const currentY = e.touches[0].pageY;
            
            // Determine scroll direction on first move
            if (!isHorizontalScroll && (Math.abs(currentX - startX) > 5 || Math.abs(currentY - startY) > 5)) {
              isHorizontalScroll = determineScrollDirection(currentX, currentY);
            }
            
            if (isHorizontalScroll) {
              // Horizontal scroll - prevent default and handle manually
              e.preventDefault();
              const diff = currentX - startX;
              slider.scrollLeft = scrollLeft - diff;
              velocity = currentX - lastX;
              lastX = currentX;
            } else {
              // Vertical scroll - allow natural scrolling
              // Don't preventDefault, let browser handle vertical scroll
              const diff = currentY - startY;
              slider.scrollTop = scrollTop - diff;
              lastY = currentY;
            }
          }, { passive: false });
          
          slider.addEventListener('touchend', () => {
            isDragging = false;
            isHorizontalScroll = false;
          });
        }

        // Backup function to ensure voucher is applied before checkout
        function ensureVoucherBeforeCheckout() {
          console.log('🔔 === ENSURE VOUCHER BEFORE CHECKOUT ===');
          
          fetch('/cart.js')
            .then(response => response.json())
            .then(cartData => {
              // Check for both cart-level AND product-level discounts
              const hasCartLevelDiscount = cartData.cart_level_discount_applications && 
                                 cartData.cart_level_discount_applications.length > 0;
              const hasProductDiscount = cartData.total_discount > 0;
              const hasDiscount = hasCartLevelDiscount || hasProductDiscount;
              
              console.log('💡 Discount check:', {
                hasCartLevelDiscount,
                hasProductDiscount,
                hasDiscount,
                total_discount: cartData.total_discount
              });
              
              // Check for stored discount code
              const storedDiscountCode = sessionStorage.getItem('applied_discount_code') || 
                                        localStorage.getItem('applied_discount_code');
              
              // Find bundle voucher
              let bundleVoucher = null;
              for (const item of cartData.items) {
                if (item.properties && item.properties._bundle_voucher) {
                  bundleVoucher = item.properties._bundle_voucher;
                  break;
                }
              }
              
              const discountToApply = storedDiscountCode || bundleVoucher;
              
              if (discountToApply) {
                fetch('/cart/update.js', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({ 'discount': discountToApply })
                })
                .then(response => response.json())
                .then(data => {
                  window.location.href = '/checkout?discount=' + discountToApply;
                })
                .catch(error => {
                  console.error('❌ Error applying discount:', error);
                  window.location.href = '/checkout?discount=' + discountToApply;
                });
              } else {
                // No discount to apply, just go to checkout
              } else {
                // No discount to apply, just go to checkout
                window.location.href = '/checkout';
              }
            })
            .catch(error => {
              console.error('Error in backup voucher check:', error);
              // Fallback if check fails
              window.location.href = '/checkout';
            });
        }

        // Override the checkout button to ensure voucher is applied
        document.addEventListener('click', function(event) {
          if (event.target.closest('button[name="checkout"]') || 
              event.target.closest('.btn--online')) {
            
            event.preventDefault();
            event.stopPropagation();
            
            // Call ensureVoucherBeforeCheckout immediately
            ensureVoucherBeforeCheckout();
          }
        }, true); // Use capture phase to intercept early

        window.addEventListener('resize', updateCartDrawerLayout);
        window.addEventListener('orientationchange', updateCartDrawerLayout);

        // --- Voucher Popup Functions ---
        function openVoucherPopup() {
          const overlay = document.querySelector('[data-voucher-popup-overlay]');
          if (overlay) {
            overlay.classList.add('is-open');
            document.body.style.overflow = 'hidden';
            
            // Clear any existing error messages
            const errorElement = document.querySelector('.voucher-popup-error');
            const successElement = document.querySelector('.voucher-popup-success');
            if (errorElement) errorElement.style.display = 'none';
            if (successElement) successElement.style.display = 'none';
            
            // Clear input field
            const input = overlay.querySelector('.voucher-popup-input');
            if (input) input.value = '';
            
            // Reset voucher card selection
            document.querySelectorAll('.voucher-card').forEach(card => {
              card.classList.remove('selected');
            });
            
            // Load vouchers when popup opens
            setTimeout(() => {
              loadAvailableVouchers();
              // Focus on input when popup opens
              if (input) input.focus();
            }, 100);
          }
        }

        function closeVoucherPopup() {
          const overlay = document.querySelector('[data-voucher-popup-overlay]');
          if (overlay) {
            overlay.classList.remove('is-open');
            document.body.style.overflow = '';
          }
          
          // Clear error messages when closing popup
          const errorElement = document.querySelector('.voucher-popup-error');
          const successElement = document.querySelector('.voucher-popup-success');
          if (errorElement) errorElement.style.display = 'none';
          if (successElement) successElement.style.display = 'none';
          
          // Clear input field
          const input = document.querySelector('.voucher-popup-input');
          if (input) input.value = '';
          
          // Reset voucher card selection
          document.querySelectorAll('.voucher-card').forEach(card => {
            card.classList.remove('selected');
          });
        }

        // Open popup when trigger is clicked
        document.addEventListener('click', function(event) {
          if (event.target.closest('[data-voucher-popup-open]')) {
            event.preventDefault();
            openVoucherPopup();
          }
        });

        // Close popup when close button or overlay is clicked
        document.addEventListener('click', function(event) {
          if (event.target.closest('[data-voucher-popup-close]') || 
              (event.target.closest('[data-voucher-popup-overlay]') && 
               event.target === event.target.closest('[data-voucher-popup-overlay]'))) {
            event.preventDefault();
            closeVoucherPopup();
          }
        });

        // Close popup on Escape key
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape') {
            const overlay = document.querySelector('[data-voucher-popup-overlay]');
            if (overlay && overlay.classList.contains('is-open')) {
              closeVoucherPopup();
            }
          }
        });

        // Handle voucher form submission
        document.addEventListener('submit', function(event) {
          const form = event.target.closest('[data-voucher-apply-form]');
          if (form) {
            event.preventDefault();
            const input = form.querySelector('.voucher-popup-input');
            const applyBtn = form.querySelector('.voucher-popup-apply-btn');
            
            if (!input || !input.value.trim()) {
              showVoucherMessage('Vui lòng nhập mã giảm giá.', 'error');
              return;
            }

            const discountCode = input.value.trim().toUpperCase();
            const originalButtonText = applyBtn.textContent;
            applyBtn.textContent = 'Đang áp dụng...';
            applyBtn.disabled = true;
            
            // Hide any existing messages
            showVoucherMessage('', 'error');

            // Check if voucher is already applied
            isVoucherAlreadyApplied(discountCode)
              .then(isApplied => {
                if (isApplied) {
                  showVoucherMessage('Voucher đã được áp dụng.', 'error');
                  applyBtn.textContent = originalButtonText;
                  applyBtn.disabled = false;
                  return;
                }
                
                // Check if voucher is expired
                if (isVoucherExpired(discountCode)) {
                  showVoucherMessage('Voucher đã hết hạn.', 'error');
                  applyBtn.textContent = originalButtonText;
                  applyBtn.disabled = false;
                  return;
                }
                
                // Apply discount
                // Apply discount
                
                fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ 'discount': discountCode })
                })
                .then(res => res.json())
                .then(cart => {
                  // CRITICAL: Fetch fresh cart data to verify discount application
                  // The /cart/update.js response may not include updated discount_applications
                  return fetch('/cart.js')
                    .then(response => response.json())
                    .then(freshCart => {
                      
                      if (freshCart.cart_level_discount_applications && freshCart.cart_level_discount_applications.length > 0) {
                        // Discount application logic handled below
                      }
                      
                      // CRITICAL FIX: Product discounts don't appear in cart_level_discount_applications
                      // but they ARE reflected in total_discount!
                      // Check if discount was actually applied by looking at total_discount OR cart_level_discount_applications
                      // RELAXED FIX: Accept ANY discount application as success
                      // This avoids issues where the discount title (e.g. "Summer Sale") 
                      // doesn't strictly match the code (e.g. "SUMMER20")
                      const hasCartLevelDiscount = freshCart.cart_level_discount_applications && 
                                                   freshCart.cart_level_discount_applications.length > 0;
                      
                      const hasProductDiscount = freshCart.total_discount > 0;
                      const discountApplied = hasCartLevelDiscount || hasProductDiscount;
                      
                      const hasProductDiscount = freshCart.total_discount > 0;
                      const discountApplied = hasCartLevelDiscount || hasProductDiscount;
                      
                      if (discountApplied) {
                        // SUCCESS: Discount was applied
                      if (discountApplied) {
                        // SUCCESS: Discount was applied
                        showVoucherMessage('Voucher đã được áp dụng thành công!', 'success');
                        input.value = '';
                        
                        // Store for checkout persistence
                        sessionStorage.setItem('applied_discount_code', discountCode);
                        localStorage.setItem('applied_discount_code', discountCode);
                        
                        // Update UI
                        createDiscountField(freshCart, discountCode);
                        updateCartPrices(freshCart);
                        rebuildCart();
                        
                        // Update prices again after rebuild to ensure they're correct
                        setTimeout(() => {
                          fetch('/cart.js')
                            .then(response => response.json())
                            .then(finalCart => {
                              updateCartPrices(finalCart);
                              createDiscountField(finalCart, discountCode);
                            })
                            .catch(error => console.error('Error fetching cart after rebuild:', error));
                        }, 800);
                        
                        // Close popup after success
                        setTimeout(() => closeVoucherPopup(), 1500);
                      } else {
                        // FAILURE: Discount code was not applied
                        
                        // Check client-side expiry first
                        const isExpired = isVoucherExpired(discountCode);
                        
                        if (isExpired) {
                          showVoucherMessage('Voucher đã hết hạn.', 'error');
                        } else {
                          // Generic message for all other validation failures
                          // We can't determine the exact reason without Shopify's checkout validation
                          showVoucherMessage('Mã giảm giá không hợp lệ hoặc chưa đáp ứng điều kiện áp dụng.', 'error');
                        }
                        input.value = '';
                      }
                      
                      applyBtn.textContent = originalButtonText;
                      applyBtn.disabled = false;
                    });
                })
                .catch(e => {
                  console.error('Error applying discount:', e);
                  showVoucherMessage('Có lỗi xảy ra khi áp dụng mã giảm giá.', 'error');
                  input.value = '';
                  applyBtn.textContent = originalButtonText;
                  applyBtn.disabled = false;
                });
              })
              .catch(error => {
                console.error('Error checking voucher status:', error);
                showVoucherMessage('Có lỗi xảy ra khi kiểm tra voucher.', 'error');
                applyBtn.textContent = originalButtonText;
                applyBtn.disabled = false;
              });
          }
        });

        // Load available vouchers from section data
        function loadAvailableVouchers() {
          const voucherList = document.querySelector('[data-voucher-list]');
          const emptyState = document.querySelector('[data-voucher-empty]');
          
          if (!voucherList) return;
          
          // Get voucher data from section JSON
          const voucherDataScript = document.querySelector('[data-voucher-data]');
          if (!voucherDataScript) {
            if (emptyState) {
              emptyState.style.display = 'block';
              emptyState.innerHTML = '<p>Không có voucher nào khả dụng</p>';
            }
            return;
          }
          
          try {
            const voucherData = JSON.parse(voucherDataScript.textContent);
            const vouchers = voucherData.vouchers || [];
            
            // Clear existing vouchers
            voucherList.innerHTML = '';
            
            if (vouchers.length === 0) {
              if (emptyState) {
                emptyState.style.display = 'block';
                emptyState.innerHTML = '<p>Không có voucher nào khả dụng</p>';
              }
              return;
            }
            
            // Hide empty state
            if (emptyState) emptyState.style.display = 'none';
            
            // Render each voucher
            vouchers.forEach(voucher => {
              renderVoucherCard(voucher);
            });
          } catch (error) {
            console.error('Error parsing voucher data:', error);
            if (emptyState) {
              emptyState.style.display = 'block';
              emptyState.innerHTML = '<p>Không thể tải voucher</p>';
            }
          }
        }

        // Function to render voucher card
        function renderVoucherCard(voucher) {
          const voucherList = document.querySelector('[data-voucher-list]');
          if (!voucherList) return;
          
          const emptyState = document.querySelector('[data-voucher-empty]');
          if (emptyState) emptyState.style.display = 'none';
          
          const card = document.createElement('div');
          card.className = 'voucher-card';
          card.dataset.voucherCode = voucher.code;
          
          // Format expiry date
          let expiryText = '';
          if (voucher.ends_at) {
            const expiryDate = new Date(voucher.ends_at);
            expiryText = expiryDate.toLocaleDateString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });
          } else if (voucher.expiry_date) {
            expiryText = voucher.expiry_date;
          }
          
          card.innerHTML = `
            <div class="voucher-card-content">
              <div class="voucher-card-title">${voucher.title || 'VOUCHER'}</div>
              <div class="voucher-card-description">${voucher.description || 'Giảm giá cho đơn hàng'}</div>
              <div class="voucher-card-code-wrapper">
                <span class="voucher-card-code-label">Mã</span>
                <div class="voucher-card-code-box">
                  <span class="voucher-card-code">${voucher.code}</span>
                </div>
              </div>
              ${expiryText ? `<div class="voucher-card-expiry">Hạn sử dụng: ${expiryText}</div>` : ''}
            </div>
            <div class="voucher-card-dashed-line"></div>
            <div class="voucher-card-radio"></div>
          `;
          
          voucherList.appendChild(card);
        }

        // Handle voucher card click - Auto-fill input and apply directly
        document.addEventListener('click', function(event) {
          const voucherCard = event.target.closest('.voucher-card');
          if (voucherCard) {
            event.preventDefault();
            event.stopPropagation();
            
            const voucherCode = voucherCard.dataset.voucherCode;
            if (!voucherCode) {
              console.error('Voucher code not found');
              return;
            }
            
            // Visual feedback - mark as selected
            document.querySelectorAll('.voucher-card').forEach(card => {
              card.classList.remove('selected');
            });
            voucherCard.classList.add('selected');
            
            // Find the discount input field and apply button in the popup
            const discountInput = document.querySelector('.voucher-popup-input');
            const applyForm = document.querySelector('[data-voucher-apply-form]');
            const applyBtn = applyForm ? applyForm.querySelector('.voucher-popup-apply-btn') : null;
            
            if (!discountInput || !applyForm || !applyBtn) {
              console.error('Discount input, form, or button not found');
              return;
            }
            
            // Auto-fill the input with voucher code (for visual feedback)
            discountInput.value = voucherCode;
            
            // Hide any existing messages
            showVoucherMessage('', 'error');
            
            // Show loading state on button
            const originalButtonText = applyBtn.textContent;
            applyBtn.textContent = 'Đang áp dụng...';
            applyBtn.disabled = true;
            
            // Check if voucher is already applied
            isVoucherAlreadyApplied(voucherCode)
              .then(isApplied => {
                if (isApplied) {
                  showVoucherMessage('Voucher đã được áp dụng.', 'error');
                  applyBtn.textContent = originalButtonText;
                  applyBtn.disabled = false;
                  voucherCard.classList.remove('selected');
                  return;
                }
                
                // Check if voucher is expired
                if (isVoucherExpired(voucherCode)) {
                  showVoucherMessage('Voucher đã hết hạn.', 'error');
                  applyBtn.textContent = originalButtonText;
                  applyBtn.disabled = false;
                  voucherCard.classList.remove('selected');
                  return;
                }
                
                // Apply discount directly via API
                fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 
                    'Content-Type': 'application/json', 
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({ 'discount': voucherCode })
                })
                .then(res => {
                  if (!res.ok) {
                    throw new Error('Network response was not ok');
                  }
                  return res.json();
                })
                .then(cart => {
                  // CRITICAL: Fetch fresh cart data to verify discount application
                  // The /cart/update.js response may not include updated discount_applications
                  console.log('🔵 [VOUCHER POPUP DEBUG] Fetching fresh cart data...');
                  return fetch('/cart.js')
                    .then(response => response.json())
                    .then(freshCart => {
                      
                      // RELAXED FIX: Accept ANY discount application as success
                      const hasCartLevelDiscount = freshCart.cart_level_discount_applications && 
                                                   freshCart.cart_level_discount_applications.length > 0;
                      
                      const hasProductDiscount = freshCart.total_discount > 0;
                      const discountApplied = hasCartLevelDiscount || hasProductDiscount;
                      
                      if (discountApplied) {
                        // SUCCESS: Discount was applied
                        showVoucherMessage('Voucher đã được áp dụng thành công!', 'success');
                        discountInput.value = '';
                        
                        // Store for checkout persistence
                        sessionStorage.setItem('applied_discount_code', voucherCode);
                        localStorage.setItem('applied_discount_code', voucherCode);
                        
                        // Update UI with fresh data
                        createDiscountField(freshCart, voucherCode);
                        updateCartPrices(freshCart);
                        rebuildCart();
                        
                        // Update prices again after rebuild to ensure they're correct
                        setTimeout(() => {
                          fetch('/cart.js')
                            .then(response => response.json())
                            .then(finalCart => {
                              updateCartPrices(finalCart);
                              createDiscountField(finalCart, voucherCode);
                            })
                            .catch(error => console.error('Error fetching cart after rebuild:', error));
                        }, 800);
                        
                        // Close popup after success
                        setTimeout(() => closeVoucherPopup(), 1500);
                      } else {
                        // FAILURE: Discount code was not applied
                        console.log('❌ [VOUCHER POPUP DEBUG] FAILURE - Discount was NOT applied');
                        
                        if (isVoucherExpired(voucherCode)) {
                          showVoucherMessage('Voucher đã hết hạn.', 'error');
                        } else {
                          showVoucherMessage('Chưa thỏa điều kiện của voucher.', 'error');
                        }
                        discountInput.value = '';
                      }
                      
                      applyBtn.textContent = originalButtonText;
                      applyBtn.disabled = false;
                      if (!discountApplied) voucherCard.classList.remove('selected');
                    })
                .catch(e => {
                  console.error('Error applying voucher:', e);
                  showVoucherMessage('Có lỗi xảy ra khi áp dụng voucher: ' + (e.message || 'Vui lòng thử lại.'), 'error');
                  discountInput.value = '';
                  applyBtn.textContent = originalButtonText;
                  applyBtn.disabled = false;
                  voucherCard.classList.remove('selected');
                });
              })
            })
              .catch(error => {
                console.error('Error checking voucher status:', error);
                applyBtn.textContent = originalButtonText;
                applyBtn.disabled = false;
                voucherCard.classList.remove('selected');
              });
          }
        });

        // Vouchers are now loaded in openVoucherPopup() function

        updateCartDrawerLayout();
      })();
    </script>

  </div>

  <!-- Voucher Popup Overlay - Outside Cart Drawer -->
  <div class="voucher-popup-overlay" data-voucher-popup-overlay>
    <div class="voucher-popup">
            <!-- Popup Header -->
            <div class="voucher-popup-header">
              <h3 class="voucher-popup-title">Chọn Voucher</h3>
              <button type="button" class="voucher-popup-close" data-voucher-popup-close aria-label="Đóng">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M18 6L6 18" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M6 6L18 18" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            <!-- Popup Content -->
            <div class="voucher-popup-content">
              <!-- Discount Code Input Form -->
              <form class="voucher-popup-form" data-voucher-apply-form>
                <div class="voucher-popup-input-wrapper">
                  <div class="voucher-popup-input-group">
                    <input 
                      type="text" 
                      name="discount" 
                      class="voucher-popup-input" 
                      placeholder="Mã giảm giá"
                      aria-label="Mã giảm giá"
                    >
                    <button type="submit" class="voucher-popup-apply-btn">ÁP DỤNG</button>
                  </div>
                </div>
              </form>

              <!-- Applicable Vouchers List -->
              <div class="voucher-popup-list-section">
                <h4 class="voucher-popup-list-title">Voucher có thể áp dụng</h4>
                <div class="voucher-popup-list" data-voucher-list>
                  <!-- Vouchers will be loaded here via JavaScript -->
                  <div class="voucher-popup-empty" data-voucher-empty>
                    <p>Đang tải voucher...</p>
                  </div>
                </div>
                <p class="voucher-popup-disclaimer">
                  * Đã hiển thị tất cả Ru9 voucher thuộc mục voucher của bạn.
                </p>
              </div>
            </div>

            <!-- Popup Footer -->
      <div class="voucher-popup-footer">
        <button type="button" class="voucher-popup-back-btn" data-voucher-popup-close>TRỞ LẠI</button>
      </div>
    </div>
  </div>
{%- endif -%}
