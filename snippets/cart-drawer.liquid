{%- if settings.cart_type == 'drawer' -%}
  <style>
    /* General Drawer Styles */
    #CartDrawer {
      --font-stack-header: 'Be Vietnam Pro', serif;
      --font-stack-body: 'Be Vietnam Pro', sans-serif;
      font-family: var(--font-stack-body);
    }
    
    #CartDrawer .bundle-header {
      padding: 15px 0;
      font-weight: bold;
      font-size: 18px;
      color: #1C2C58;
      border-bottom: 1px solid #e9e9e9;
      margin-top: 10px;
    }

    #CartDrawer .cart__item--bundle-item {
      background-color: #F0F7FF;
      border-color: transparent;
    }
    
    /* Desktop: Smaller drawer width */
    @media (min-width: 769px) {
      #CartDrawer {
        width: 420px !important;
        max-width: 420px !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      #CartDrawer .drawer__inner {
        width: 420px !important;
        max-width: 420px !important;
      }
      #CartDrawer.drawer--is-open {
        transform: translateX(0) !important;
      }
    }
    
    /* Mobile: Full screen drawer */
    @media (max-width: 768px) {
      #CartDrawer {
        width: 100% !important;
        max-width: 100% !important;
      }
      #CartDrawer .drawer__inner {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Mobile: Fixed footer full width */
      #CartDrawer .drawer__footer {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        background: #fff !important;
        z-index: 1001 !important;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
        padding: 0 20px 20px 20px !important;
      }
    }
    
    /* Ensure drawer is properly positioned and visible */
    #CartDrawer {
      position: fixed !important;
      top: 0 !important;
      right: 0 !important;
      height: 100vh !important;
      z-index: 1000 !important;
      background: #fff !important;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1) !important;
      transform: translateX(100%) !important;
      transition: transform 0.3s ease !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    #CartDrawer.drawer--is-open {
      transform: translateX(0) !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Hide sticky add-to-cart when cart drawer is open */
    #CartDrawer.drawer--is-open ~ sticky-add-to-cart,
    body:has(#CartDrawer.drawer--is-open) sticky-add-to-cart {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    /* --- BUNDLE FOOTER STYLES --- */
    /* Nối sản phẩm cuối cùng với footer */
    .cart__item--bundle-item.is-before-footer {
      margin-bottom: 0 !important;
      border-bottom: none !important;
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }
    /* Style cho footer chung của bundle */
    .bundle-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background-color: #F0F7FF;
      border-left: 4px solid #234085;
      border-radius: 0 0 8px 8px;
      margin-bottom: 12px;
    }
    .bundle-footer .js-qty__wrapper {
      border: 1px solid #E5E7EB;
      border-radius: 5px;
      overflow: hidden;
      background: #fff;
    }
    .bundle-footer .js-qty__num {
      background-color: #fff;
      border: none;
    }
    .bundle-footer .cart-item__remove {
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
    }

    #CartDrawer .cross-sell-item__title a {
      border-bottom: none !important;
      font-size: 20px;
      color: #1C2C58;
    }
    #CartDrawer .drawer__inner {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }
    #CartDrawer .drawer__fixed-header {
      position: relative;
      flex-shrink: 0;
    }
    #CartDrawer .drawer__scrollable {
      overflow-y: auto !important;
      flex-grow: 1;
      scrollbar-width: none; /* For Firefox */
      -ms-overflow-style: none; /* For Internet Explorer and Edge */
      max-height: calc(100vh - 120px); /* Ensure scrollable area */
      min-height: 200px; /* Minimum height to enable scroll */
      padding-bottom: 200px !important; /* Space for fixed footer */
    }
    #CartDrawer .drawer__header {
      padding: 20px 0 15px 0;
      margin-bottom: 0;
      position: static;
      background: #fff;
      display: block;
      width: 100%;
      flex-shrink: 0;
      z-index: 10;
    }
    
    #CartDrawer .drawer__header .drawer__title {
      font-family: var(--font-stack-body);
      width: 344px;
      height: 39px;
      flex-shrink: 0;
      color: #1C2C58;
      font-size: 38px;
      font-style: normal;
      font-weight: 600;
      line-height: 120%;
    }
    
    #CartDrawer .drawer__header .drawer__count {
      font-family: var(--font-stack-body);
      font-size: 16px;
    }
    
    /* Desktop only - Force header visibility */
    @media (min-width: 769px) {
      #CartDrawer .drawer__header {
        background: #fff !important;
        display: block !important;
        width: 100% !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      #CartDrawer .drawer__header .drawer__title {
        display: block !important;
        visibility: visible !important;
      }
      
      #CartDrawer .drawer__header .drawer__count {
        display: block !important;
        visibility: visible !important;
        color: #000 !important;
      }
      
      /* Ensure drawer scrollable works on desktop */
      #CartDrawer .drawer__scrollable {
        overflow-y: auto !important;
        height: auto !important;
        max-height: calc(100vh - 150px) !important;
        padding-bottom: 200px !important;
      }
      
      /* Desktop: Fixed footer with drawer width */
      #CartDrawer .drawer__footer {
        position: fixed !important;
        bottom: 0 !important;
        right: 0 !important;
        left: auto !important;
        width: 420px !important;
        max-width: 420px !important;
        background: #fff !important;
        z-index: 1001 !important;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
        padding: 20px !important;
      }
    }
    
    #CartDrawer .cart-empty-message {
      padding: 40px 20px;
      text-align: center;
      font-size: 16px;
      color: #666;
    }
    #CartDrawer .drawer__scrollable::-webkit-scrollbar {
      display: none; /* For Chrome, Safari, and Opera */
    }
    
    /* Remove gray line above drawer__scrollable */
    #CartDrawer .drawer__scrollable {
      border-top: none !important;
    }
    
    #CartDrawer .drawer__scrollable::before {
      display: none !important;
    }
    #CartDrawer .drawer__header .drawer__title {
      font-family: var(--font-stack-body);
      width: 344px;
      height: 39px;
      flex-shrink: 0;
      color: #1C2C58;
      font-size: 38px;
      font-style: normal;
      font-weight: 600;
      line-height: 120%;
    }
    #CartDrawer .drawer__header .drawer__count {
      font-family: var(--font-stack-body);
      font-size: 16px;
    }
    #CartDrawer .cart-drawer__services {
      display: flex;
      justify-content: space-around;
      padding: 0px 0 15px 0;
      border-bottom: 1px solid #e9e9e9;
      text-align: center;
      margin: 0;
      position: static;
      background: #fff;
      width: 100%;
    }
    .cart-drawer__service-item {
      font-family: var(--font-stack-body);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: #000;
      text-align: center;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
    }
    .cart-drawer__service-icon {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }


    /* Cart Items */
    .cart-item__title {
      color: #000 !important;
      font-family: "Be Vietnam Pro" !important;
      font-size: 20px !important;
      font-style: normal !important;
      font-weight: 600 !important;
      line-height: 140%; /* 28px */
    }
    .cart-item__variant {
      overflow: hidden;
      color: #000;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%; /* 24px */
    }
    .cart-item__price--original {
      overflow: hidden;
      color: #808080;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%; /* 24px */
      text-decoration-line: line-through;
    }
    .cart-item__price--final {
      overflow: hidden;
      color: #1C2C58;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%; /* 24px */
      margin-left: 10px;
    }

    .cart-drawer__free-shipping-info {
      padding: 15px;
      text-align: center;
      color: #1C2C58;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      margin: 0;
      position: static;
      background: #fff;
      width: 100%;
    }

    /* Cart Item Layout */
    .cart__item {
      display: flex;
      gap: 15px;
      padding: 20px 0;
      border-bottom: 1px solid #e9e9e9;
      margin: 0;
      position: static;
      background: #fff;
      width: 100%;
    }
    .cart__image {
      flex-shrink: 0;
    }
    .cart__item-details {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .cart-item__price-wrapper {
      margin: 5px 0;
    }
    .cart-item__footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto; /* Pushes footer to the bottom */
    }
    .cart-item__remove {
      font-family: var(--font-stack-body);
      font-size: 14px;
      text-decoration: none;
      color: #25282B;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
    }
    .cart-item__remove svg {
      width: 24px;
      height: 24px;
    }
    
    /* 
    To implement the SVG icon for cart-item__remove, replace the text content 
    with this SVG in your cart item template or JavaScript:
    
    <button class="cart-item__remove" data-cart-remove>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M3 6H5H21" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M10 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    */
    
    /* Discount Code */
    .cart-drawer__discount-header {
        overflow: hidden;
        color: #1C2C58;
        text-align: left;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: "Be Vietnam Pro", sans-serif;
        font-size: 16px;
        font-style: normal;
        font-weight: 400;
        line-height: 150%;
        margin: 20px 0 10px;
    }
    .cart-drawer__discount-form {
      display: flex !important;
      justify-content: center;
      align-items: stretch;
      gap: 0;
      max-width: 400px;
      margin: 0 auto;
      flex-direction: row;
    }
    .cart-drawer__discount-input {
      width: 70%;
      flex-grow: 1;
      height: 38px;
      border-radius: 8px 0 0 8px;
      background: #F0F7FF;
      border: 1px solid #D1E5FF;
      border-right: none;
      padding: 0 15px;
      font-family: var(--font-stack-body);
      display: inline-block;
      box-sizing: border-box;
    }
    .cart-drawer__discount-button {
      width: 28%;
      background: #759CE6;
      color: white;
      border: 1px solid #759CE6;
      border-radius: 0 8px 8px 0;
      padding: 0 20px;
      cursor: pointer;
      font-family: var(--font-stack-body);
      height: 38px;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .cart-drawer__voucher-carousel {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 0;
      position: relative;
    }
    .cart-drawer__voucher-carousel-inner {
      overflow: hidden;
      width: 100%;
    }
    .cart-drawer__voucher-list {
      display: flex;
      gap: 10px;
      transition: transform 0.3s ease-in-out;
      overflow: hidden;
    }
    .cart-drawer__voucher-item {
      position: relative;
      flex: 0 0 auto;
    }
    .cart-drawer__voucher-item img {
      display: block;
      width: 130px;
      height: auto;
      border-radius: 8px;
    }
      .voucher-copy-button {
        position: absolute;
        bottom: 8px;
        width: 60px;
        right: 15px;
        background: #759CE6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 4px;
        font-weight: 400;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .voucher-copy-button:hover {
        background: #6B8CDB;
      }
      
      .voucher-copy-button:active,
      .voucher-copy-button.copied {
        background: #ccc;
        color: #333;
      }
    .cart-drawer__carousel-arrow {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0 10px;
    }

    /* Cart Summary */
    #CartDrawer .cart-drawer__summary {
      padding: 5px 0;
      background: #fff;
      width: 100%;
      opacity: 1 !important;
      transform: none !important;
      visibility: visible !important;
    }
    
    #CartDrawer .drawer__footer {
      opacity: 1 !important;
      transform: none !important;
      visibility: visible !important;
    }
    
    #CartDrawer .cart-drawer__summary-item {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-stack-body);
      font-size: 16px;
      padding: 5px 0;
    }
    #CartDrawer .cart-drawer__summary-item .price-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #CartDrawer .cart-drawer__summary-item .price--original {
      overflow: hidden;
      color: #808080;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      text-decoration-line: line-through;
    }
    #CartDrawer .cart-drawer__summary-item .price--final {
      overflow: hidden;
      color: #1C2C58;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 18px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%;
    }
    #CartDrawer .summary-item__right-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    #CartDrawer .summary-item__right-content .text-right {
      font-size: 14px;
      margin-top: 4px;
    }
    #CartDrawer .cart-drawer__savings {
      width: 100%;
      height: 38px;
      flex-shrink: 0;
      border-radius: 8px;
      background: #FCE390;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }
    #CartDrawer .cart-drawer__savings span {
      overflow: hidden;
      color: #1C2C58;
      text-align: center;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%;
    }
    .cart-drawer__cross-sell-header-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0 10px;
    }
    .cart-drawer__cross-sell-header {
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      margin: 0;
      flex: 1;
    }
    .cart-drawer__cross-sell-slider-wrapper {
      position: relative;
    }
    .cart-drawer__arrows-container {
      display: flex;
      gap: 10px;
      margin: 0;
    }
    .cart-drawer__cross-sell-slider {
      display: flex;
      overflow-x: hidden;
      scroll-behavior: smooth;
      gap: 15px;
      padding-bottom: 20px;
    }
    .cart-drawer__cross-sell-item {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 15px;
      padding: 15px;
      border-radius: 8px;
      background: #F0F7FF;
      align-items: center;
      flex: 0 0 100%; /* Each item takes full width */
    }
    .cross-sell-item__top-row {
      display: flex;
      gap: 15px;
      align-items: flex-start;
      width: 100%;
    }
    .cross-sell-item__image {
      display: flex;
      width: 203px;
      height: 132px;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      background: #FFF;
    }
    .cross-sell-item__info {
      flex-grow: 1;
      text-align: left;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    .cross-sell-item__variant-select {
      width: 100%;
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      text-decoration-line: underline;
      cursor: pointer;
      border: 1px solid #ddd;
      background: white;
      padding: 8px 20px 8px 12px;
      margin-bottom: 3px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 6.75L9 11.25L13.5 6.75' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right center;
      text-align: left;
    }
    .cross-sell-item__quantity-label {
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      white-space: nowrap;
      margin-bottom: 0 !important;
    }
    .cross-sell-item__quantity-wrapper {
        display: flex !important;
        width: 120px;
        height: 35px;
        align-items: center;
        gap: 0;
        flex-shrink: 0;
        border-radius: 5px;
        border: 1px solid #E5E7EB;
        background: #FFF;
        overflow: hidden;
        position: relative;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust {
        width: 30px;
        height: 35px;
        border: none;
        background: transparent;
        color: #000;
        font-size: 16px;
        font-weight: normal;
        cursor: pointer;
        display: flex !important;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
        padding: 0;
        margin: 0;
        outline: none;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust:hover {
        background: transparent;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust:active {
        background: transparent;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust--minus {
        border: none;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust--plus {
        border: none;
    }
    
    /* Ensure quantity wrapper children stay inside */
    .cross-sell-item__quantity-wrapper > * {
        position: relative !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__num {
        flex: 1;
        height: 35px;
        border: none;
        background: #FFF;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: #1C2C58;
        outline: none;
        padding: 0;
        min-width: 0;
        position: relative;
        z-index: 1;
        justify-content: center !important;
    }
    .cross-sell-item__add-btn {
      display: flex;
      width: 120px;
      height: 35px;
      padding: 12px 35px;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      border-radius: 5px;
      background: #FCE390;
      color: #1C2C58;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }
    .cart-drawer__cross-sell-arrow--next {
      background: #234085 !important;
    }
    .cart-drawer__cross-sell-arrow {
      background: #F5F9FF;
      border: 1px solid #e9e9e9;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cross-sell-item__info h4 { font-size: 16px; }
    .cross-sell-item__info p,
    .cross-sell-item__variant-select,
    .cross-sell-item__quantity-label {
      font-size: 14px;
    }
    .cross-sell-item__image {
      width: 140px;
      height: 140px;
      flex-shrink: 0;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      background: #FFF;
    }
    .cross-sell-item__price-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
    .cross-sell-item__price-wrapper .compare-at-price {
        font-size: 14px;
        text-decoration: line-through;
        opacity: 0.7;
    }
    .cross-sell-item__form {
        width: 100%;
    }
    .cross-sell-item__form-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 40px;
        width: 100%;
    }
    .cross-sell-item__quantity {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 50%;
    }
    .cross-sell-item__add-btn {
      display: flex;
      padding: 12px 0;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      border-radius: 15px;
      background: #FCE390;
      color: #000;
      border: none;
      cursor: pointer;
    }
    /* Checkout Buttons */
    #CartDrawer .cart__checkout-wrapper--custom {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    #CartDrawer .btn--cod, #CartDrawer .btn--online {
      flex: 1;
      border-radius: 15px;
      text-align: center;
      text-decoration: none;
      font-family: var(--font-stack-body);
      font-weight: 700;
      font-size: 16px;
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    #CartDrawer .btn--online {
      background-color: #FCE390;
      color: #1C2C58;
    }
    
    /* Mobile responsive for checkout buttons */
    @media (max-width: 768px) {
      #CartDrawer .btn--cod, #CartDrawer .btn--online {
        font-size: 14px;
      }
    }
  </style>

  <div id="CartDrawer" class="drawer drawer--right">
    <form id="CartDrawerForm" action="{{ routes.cart_url }}" method="post" novalidate class="drawer__contents" data-location="cart-drawer">
      <div class="drawer__inner">
        <!-- Fixed Header - Always visible -->
        <div class="drawer__header relative appear-animation appear-delay-1">
          <div class="h2 drawer__title">{{ 'cart.general.title' | t }}</div>
          <div class="drawer__count">
             {{ cart.item_count }} sản phẩm
          </div>
          <div class="drawer__close absolute right-0">
            <button type="button" class="drawer__close-button js-drawer-close">
              {%- render 'close-icon' -%}
              <span class="icon__fallback-text">{{ 'cart.general.close_cart' | t }}</span>
            </button>
          </div>
        </div>
        
        <div class="drawer__scrollable">
          
          <!-- SERVICES -->
          <div class="cart-drawer__services">
            <div class="cart-drawer__service-item">
              {% if settings.cart_free_shipping_icon != blank %}
                <img src="{{ settings.cart_free_shipping_icon | image_url: width: 64 }}" class="cart-drawer__service-icon" alt="Miễn phí vận chuyển" width="32" height="32">
              {% endif %}
              <span>Miễn phí vận chuyển</span>
            </div>
            <div class="cart-drawer__service-item">
              {% if settings.cart_warranty_icon != blank %}
                <img src="{{ settings.cart_warranty_icon | image_url: width: 64 }}" class="cart-drawer__service-icon" alt="Bảo hành dài lâu" width="32" height="32">
              {% endif %}
              <span>Bảo hành dài lâu</span>
            </div>
          </div>

          <!-- FREE SHIPPING DETAILS -->
          {%- if settings.cart_free_shipping_enable -%}
            <div class="cart-drawer__free-shipping-info appear-animation appear-delay-2">
              {%- assign threshold = settings.cart_free_shipping_threshold -%}
              {%- if cart.total_price >= threshold -%}
                Đơn hàng của bạn được miễn phí vận chuyển
              {%- else -%}
                {%- assign remaining = threshold | minus: cart.total_price -%}
                Mua thêm {{ remaining | money }} để được miễn phí vận chuyển
              {%- endif -%}
            </div>
          {%- endif -%}

          <!-- CART ITEMS -->
          <div data-products class="appear-animation appear-delay-2">
            {%- comment -%} Cart items are rendered here via JS {%- endcomment -%}
          </div>

          
          <!-- DISCOUNT CODE -->
          <div class="cart-drawer__discount-wrapper">
              <h3 class="cart-drawer__discount-header">Nhập mã ưu đãi của bạn (copy và dán vào ô dưới)</h3>
              <form action="{{ routes.cart_url }}/update" method="post" class="cart-drawer__discount-form" novalidate>
                  <input type="text" id="CartDrawer-Discount" name="discount" class="cart-drawer__discount-input" placeholder="Mã ưu đãi">
                  <button type="button" class="cart-drawer__discount-button">Áp dụng</button>
              </form>
              <div class="cart-drawer__voucher-carousel">
                  <button type="button" class="cart-drawer__carousel-arrow prev">
                      <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none"><path d="M12.9163 15.5L18.0833 20.6668L16.7917 21.9583L10.3333 15.5L16.7917 9.04163L18.0833 10.3331L12.9163 15.5Z" fill="#9E9EB0"/><circle cx="15.5" cy="15.5" r="15" stroke="#E9E9E9"/></svg>
                  </button>
                  <div class="cart-drawer__voucher-carousel-inner">
                      <div class="cart-drawer__voucher-list">
                        {% for i in (1..5) %}
                          {%- assign voucher_image_setting = 'voucher_image_' | append: i -%}
                          {%- assign voucher_code_setting = 'voucher_code_' | append: i -%}
                          {%- assign voucher_image = settings[voucher_image_setting] -%}
                          {%- assign voucher_code = settings[voucher_code_setting] -%}
                          {% if voucher_image != blank and voucher_code != blank %}
                            <div class="cart-drawer__voucher-item">
                              <img src="{{ voucher_image | image_url: width: 260 }}" alt="Voucher {{ i }}" loading="lazy" width="130" height="65">
                              <button class="voucher-copy-button" data-copy-code="{{ voucher_code }}">Copy</button>
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>
                  </div>
                   <button type="button" class="cart-drawer__carousel-arrow next">
                      <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none"><path d="M18.0837 15.5L12.9167 10.3332L14.2083 9.04171L20.6667 15.5L14.2083 21.9584L12.9167 20.6669L18.0837 15.5Z" fill="#609EE9"/><circle cx="15.5" cy="15.5" r="15" stroke="#E9E9E9"/></svg>
                  </button>
              </div>
          </div>

          <!-- CROSS-SELL -->
          {%- assign cross_sell_products = settings.cart_cross_sell_products -%}
          {%- if cross_sell_products.count > 0 -%}
          <div class="cart-drawer__cross-sell">
            <div class="cart-drawer__cross-sell-header-wrapper">
              <h3 class="cart-drawer__cross-sell-header">Thăng hạng chất lượng giấc ngủ cùng</h3>
              <div class="cart-drawer__arrows-container">
                <button type="button" class="cart-drawer__cross-sell-arrow cart-drawer__cross-sell-arrow--prev" aria-label="Previous product">
                  <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none">
                    <path d="M12.9163 15.5L18.0833 20.6668L16.7917 21.9583L10.3333 15.5L16.7917 9.04163L18.0833 10.3331L12.9163 15.5Z" fill="#9E9EB0"/>
                  </svg>
                </button>
                <button type="button" class="cart-drawer__cross-sell-arrow cart-drawer__cross-sell-arrow--next" aria-label="Next product">
                   <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none">
                    <path d="M18.0837 15.5L12.9167 10.3332L14.2083 9.04171L20.6667 15.5L14.2083 21.9584L12.9167 20.6669L18.0837 15.5Z" fill="#FFF"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="cart-drawer__cross-sell-slider-wrapper">
              <div class="cart-drawer__cross-sell-slider">
                {%- for product in cross_sell_products -%}
                    {%- assign current_variant = product.first_available_variant -%}
                    <div class="cart-drawer__cross-sell-item" data-product-id="{{ product.id }}">
                      <!-- First row: Image and Product info side by side -->
                      <div class="cross-sell-item__top-row">
                        <a href="{{ product.url }}" class="cross-sell-item__image">
                          <img src="{{ product.featured_image | image_url: width: 280, height: 280 }}" width="140" height="140" alt="{{ product.featured_image.alt | escape }}" loading="lazy">
                        </a>
                        <div class="cross-sell-item__info">
                          <h4 class="cross-sell-item__title"><a href="{{ product.url }}">{{ product.title }}</a></h4>
                          <div class="cross-sell-item__price-wrapper">
                            <span class="price">{{ current_variant.price | money }}</span>
                            {% if current_variant.compare_at_price > current_variant.price %}
                              <del class="compare-at-price">{{ current_variant.compare_at_price | money }}</del>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      
                      <!-- Second row: Variant select -->
                      {% if product.variants.size > 1 %}
                        <select name="id" class="cross-sell-item__variant-select">
                          {% for variant in product.variants %}
                            <option {% if variant == current_variant %}selected="selected"{% endif %} value="{{ variant.id }}">{{ variant.title }}</option>
                          {% endfor %}
                        </select>
                      {% endif %}
                      
                      <!-- Third row: Form row (quantity + add button) -->
                      <form method="post" action="{{ routes.cart_add_url }}" class="cross-sell-item__form">
                        <input type="hidden" name="id" value="{{ current_variant.id }}">
                        <div class="cross-sell-item__form-row">
                          <div class="cross-sell-item__quantity">
                            <label for="cross-sell-quantity-{{ product.id }}" class="cross-sell-item__quantity-label">Số lượng:</label>
                            <div class="cross-sell-item__quantity-wrapper">
                              <button type="button" class="cross-sell-qty__adjust cross-sell-qty__adjust--minus" aria-label="-">-</button>
                              <input type="text" id="cross-sell-quantity-{{ product.id }}" name="quantity" value="1" min="1" class="cross-sell-qty__num">
                              <button type="button" class="cross-sell-qty__adjust cross-sell-qty__adjust--plus" aria-label="+">+</button>
                            </div>
                          </div>
                          <button type="button" class="cross-sell-item__add-btn">Thêm</button>
                        </div>
                      </form>
                    </div>
                  {%- endfor -%}
              </div>
            </div>
          </div>
          {%- endif -%}
        </div>

        <div class="drawer__footer appear-animation appear-delay-4">
          <div data-cart-footer>
            
            <!-- SUMMARY -->
            <div class="cart-drawer__summary">
                {%- comment -%}
                  Calculate original total price based on the same logic as cart-item.liquid
                  This ensures we capture both compare_at_price and original_price correctly.
                {%- endcomment -%}
                {%- assign original_total_price_calculated = 0 -%}
                {%- for item in cart.items -%}
                    {%- assign line_price = 0 -%}
                    {%- if item.variant.compare_at_price > item.price -%}
                        {%- assign line_price = item.variant.compare_at_price | times: item.quantity -%}
                    {%- else -%}
                        {%- assign line_price = item.original_price | times: item.quantity -%}
                    {%- endif -%}
                    {%- assign original_total_price_calculated = original_total_price_calculated | plus: line_price -%}
                {%- endfor -%}

                {%- assign total_savings = original_total_price_calculated | minus: cart.total_price -%}

                <div class="cart-drawer__savings" data-savings-display>
                  <span>Bạn đã tiết kiệm được {{ total_savings | money }}</span>
                </div>

                <div class="cart-drawer__summary-item">
                    <span>Tạm tính</span>
                    <div class="summary-item__right-content">
                      <span class="price-container">
                        {%- if total_savings > 0 -%}
                          <del class="price--original">{{ original_total_price_calculated | money }}</del>
                        {%- endif -%}
                        <span data-subtotal class="price--final">{{ cart.total_price | money }}</span>
                      </span>
                      {%- if cart.cart_level_discount_applications.size > 0 -%}
                        <span class="text-right">Đã áp dụng ưu đãi</span>
                      {%- endif -%}
                    </div>
                </div>

                <div class="cart-drawer__summary-item">
                    <span style="color: #000;">Vận chuyển</span>
                    <span style="color: #1C2C58;">Miễn phí</span>
                </div>
            </div>


            <!-- CHECKOUT BUTTONS -->
            <div class="cart__checkout-wrapper--custom">
                {%- assign bundle_voucher = '' -%}
                {%- for item in cart.items -%}
                  {%- for property in item.properties -%}
                    {%- if property.first == '_bundle_voucher' -%}
                      {%- assign bundle_voucher = property.last -%}
                      {%- break -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- if bundle_voucher != '' -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- if bundle_voucher != '' -%}
                  <button type="submit" name="checkout" class="btn btn--online" onclick="window.location.href='/checkout?discount={{ bundle_voucher }}'; return false;">Thanh toán ngay</button>
                {%- else -%}
                  <button type="submit" name="checkout" class="btn btn--online">Thanh toán ngay</button>
                {%- endif -%}
            </div>
            {% if additional_checkout_buttons and settings.cart_additional_buttons %}
              <div class="additional-checkout-buttons additional-checkout-buttons--vertical">{{ content_for_additional_checkout_buttons }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="drawer__cart-empty appear-animation appear-delay-2">
        <div class="drawer__scrollable">
          <div class="cart-empty-message">
            {{ 'cart.general.empty' | t }}
          </div>
        </div>
      </div>
    </form>

    <script>
      (function() {
        // --- General Cart Drawer Functions ---
        function rebuildCart() {
          if (theme && typeof theme.CartForm === 'function') {
            const cartFormInstance = new theme.CartForm(document.getElementById('CartDrawerForm'));
            cartFormInstance.buildCart();
            // MutationObserver will handle all UI updates instantly after this.
          } else {
            window.location.href = '{{ routes.cart_url }}';
          }
        }
        
        function handleBundleHeaders() {
          const productContainer = document.querySelector('#CartDrawer [data-products]');
          if (productContainer) {
            const renderedBundleIds = new Set();
            const bundleGroups = {}; // Track items by bundle ID
            
            // First, hide all headers to reset
            productContainer.querySelectorAll('.bundle-header').forEach(h => h.style.display = 'none');
            
            // Group bundle items by bundle ID
            const items = productContainer.querySelectorAll('.cart__item--bundle-item');
            items.forEach(item => {
              const bundleId = item.dataset.bundleId;
              if (bundleId) {
                if (!bundleGroups[bundleId]) {
                  bundleGroups[bundleId] = [];
                }
                bundleGroups[bundleId].push(item);
              }
            });
            
            // For each bundle group, show header and add classes
            Object.keys(bundleGroups).forEach(bundleId => {
              const bundleItems = bundleGroups[bundleId];
              
              if (bundleItems.length > 0) {
                // Show header and move to before first item
                const header = productContainer.querySelector(`.bundle-header[data-bundle-id="${bundleId}"]`);
                const firstItem = bundleItems[0];
                
                if (header && firstItem) {
                  header.style.display = 'block';
                  firstItem.parentNode.insertBefore(header, firstItem);
                }
                
                // Add classes to first and last items for seamless styling
                bundleItems.forEach((item, index) => {
                  item.classList.remove('bundle-item-first', 'bundle-item-last', 'bundle-item-middle');
                  
                  if (bundleItems.length === 1) {
                    item.classList.add('bundle-item-single');
                  } else if (index === 0) {
                    item.classList.add('bundle-item-first');
                  } else if (index === bundleItems.length - 1) {
                    item.classList.add('bundle-item-last');
                  } else {
                    item.classList.add('bundle-item-middle');
                  }
                });
              }
            });
          }
        }

        function syncCartUIFromDOM() {
          const countElement = document.querySelector('.drawer__count');
          const cartItems = document.querySelectorAll('#CartDrawer .cart__item');

          // Part 1: Update Count by reading DOM
          const bundleGroups = {};
          let standaloneItemCount = 0;
          let totalStandaloneQty = 0;
          cartItems.forEach(item => {
            const bundleId = item.dataset.bundleId;
            if (bundleId) {
              if (!bundleGroups[bundleId]) bundleGroups[bundleId] = [];
              bundleGroups[bundleId].push(item);
            } else {
              standaloneItemCount++;
              totalStandaloneQty += parseInt(item.dataset.quantity, 10) || 1;
            }
          });

          const bundleCount = Object.keys(bundleGroups).length;
          let countText = '0 sản phẩm';
          if (cartItems.length > 0) {
            if (bundleCount > 0 && standaloneItemCount === 0) {
              countText = `${bundleCount} bộ sản phẩm`;
            } else if (bundleCount > 0 && standaloneItemCount > 0) {
              countText = `${bundleCount} bộ + ${totalStandaloneQty} sản phẩm`;
            } else if (standaloneItemCount > 0) {
              countText = `${totalStandaloneQty} sản phẩm`;
            }
          }
          if (countElement) countElement.textContent = countText;

          // Part 2: Update Summary Prices by reading DOM
          let totalOriginalPrice = 0, totalFinalPrice = 0;
          const moneyRegex = /[^\d]/g;
          const parsePrice = (el) => el ? (parseInt(el.textContent.replace(moneyRegex, ''), 10) || 0) : 0;

          cartItems.forEach(item => {
            const quantity = parseInt(item.dataset.quantity, 10) || 1;
            const finalPriceUnit = parsePrice(item.querySelector('.cart-item__price--final'));
            const originalPriceEl = item.querySelector('.cart-item__price--original');
            const originalPriceUnit = originalPriceEl ? parsePrice(originalPriceEl) : finalPriceUnit;
            totalFinalPrice += finalPriceUnit * quantity;
            totalOriginalPrice += originalPriceUnit * quantity;
          });
          
          const totalSavings = totalOriginalPrice - totalFinalPrice;
          const formatMoney = (amount) => amount.toLocaleString('vi-VN') + '₫';

          const savingsDisplay = document.querySelector('[data-savings-display] span');
          if (savingsDisplay) savingsDisplay.textContent = 'Bạn đã tiết kiệm được ' + formatMoney(totalSavings);
          const subtotalElement = document.querySelector('[data-subtotal]');
          if (subtotalElement) subtotalElement.textContent = formatMoney(totalFinalPrice);
          const priceContainer = document.querySelector('.cart-drawer__summary-item .price-container');
          if (priceContainer) {
            let priceOriginalEl = priceContainer.querySelector('.price--original');
            if (totalSavings > 0) {
              if (!priceOriginalEl) {
                priceOriginalEl = document.createElement('del');
                priceOriginalEl.className = 'price--original';
                priceContainer.insertBefore(priceOriginalEl, subtotalElement);
              }
              priceOriginalEl.textContent = formatMoney(totalOriginalPrice);
              priceOriginalEl.style.display = '';
            } else {
              if (priceOriginalEl) priceOriginalEl.style.display = 'none';
            }
          }
          
          // Part 3: Add/Update Bundle Footer
          document.querySelectorAll('.bundle-footer').forEach(f => f.remove());
          document.querySelectorAll('.is-before-footer').forEach(i => i.classList.remove('is-before-footer'));
          Object.keys(bundleGroups).forEach(bundleId => {
            const items = bundleGroups[bundleId];
            if (items.length === 0) return;
            const lastItem = items[items.length - 1];
            lastItem.classList.add('is-before-footer');

            const itemKeys = items.map(item => item.dataset.key);
            const customBundleQty = items[0].dataset.bundleQuantity;
            const currentQuantity = customBundleQty ? parseInt(customBundleQty, 10) : 1;
            const footer = document.createElement('div');
            footer.className = 'bundle-footer';
            const removeBtnHTML = `<button type="button" class="cart-item__remove bundle__remove" data-bundle-keys="${itemKeys.join(',')}" title="Xóa bộ sản phẩm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3 6H5H21" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`;
            const qtyWrapperHTML = `<div style="display: flex; align-items: center; gap: 10px; margin-left: auto;"><span>Số lượng bộ:</span><div class="js-qty__wrapper bundle__qty-wrapper" data-bundle-keys="${itemKeys.join(',')}"><button type="button" class="js-qty__adjust js-qty__adjust--minus">&minus;</button><input type="text" class="js-qty__num" value="${currentQuantity}" min="1" pattern="[0-9]*" readonly><button type="button" class="js-qty__adjust js-qty__adjust--plus">+</button></div></div>`;
            footer.innerHTML = `${removeBtnHTML} ${qtyWrapperHTML}`;
            lastItem.insertAdjacentElement('afterend', footer);
          });
        }

        // Use MutationObserver to detect when cart items are loaded/updated
        const productContainer = document.querySelector('#CartDrawer [data-products]');
        if (productContainer) {
          const observer = new MutationObserver((mutationsList) => {
            for(const mutation of mutationsList) {
              if (mutation.type === 'childList') {
                handleBundleHeaders();
                syncCartUIFromDOM();
                break; 
              }
            }
          });
          observer.observe(productContainer, { childList: true });
        }
        
        // Listen for cart:updated event from bundle add to cart
        document.addEventListener('cart:updated', function() {
          console.log('Cart updated event received, showing bundle headers...');
          setTimeout(() => {
            handleBundleHeaders();
            syncCartUIFromDOM();
          }, 100);
        });
        
        // Also run on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(() => {
            handleBundleHeaders();
            syncCartUIFromDOM();
          }, 500);
        });

        // NOTE: All manual quantity listeners are removed. 
        // The MutationObserver + the master bundle controls handle everything.

        // --- Event Delegation for Clicks ---
        document.addEventListener('click', function(event) {
          const target = event.target;

          // --- BUNDLE CONTROLS (HIGHEST PRIORITY) ---
          const bundleRemoveBtn = target.closest('.bundle__remove');
          if (bundleRemoveBtn) {
              event.preventDefault();
              const keys = bundleRemoveBtn.dataset.bundleKeys.split(',');
              if (keys.length === 0 || keys[0] === '') return;
              const updates = keys.reduce((acc, key) => {
                  if (key) acc[key] = 0;
                  return acc;
              }, {});
              fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ updates: updates })
              }).then(res => res.json()).then(cart => rebuildCart()).catch(e => console.error(e));
              return;
          }
      
          const bundleQtyAdjust = target.closest('.bundle__qty-wrapper .js-qty__adjust');
          if (bundleQtyAdjust) {
              event.stopImmediatePropagation();
              event.preventDefault();
              const wrapper = bundleQtyAdjust.closest('.bundle__qty-wrapper');
              const input = wrapper.querySelector('.js-qty__num');
              const keys = wrapper.dataset.bundleKeys.split(',');
              if (keys.length === 0 || keys[0] === '') return;
              let currentQty = parseInt(input.value);
              let newQty = bundleQtyAdjust.classList.contains('js-qty__adjust--minus') ? Math.max(1, currentQty - 1) : currentQty + 1;
              if (newQty === currentQty) return;
              input.value = newQty;
              const updates = keys.reduce((acc, key) => {
                  if (key) acc[key] = newQty;
                  return acc;
              }, {});
              fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ updates: updates })
              }).then(res => res.json()).then(cart => rebuildCart()).catch(e => console.error(e));
              return;
          }

          // Handle Cross-sell Slider Arrows
          const prevArrow = target.closest('.cart-drawer__cross-sell-arrow--prev');
          const nextArrow = target.closest('.cart-drawer__cross-sell-arrow--next');
          if (prevArrow || nextArrow) {
            const slider = document.querySelector('.cart-drawer__cross-sell-slider');
            if (!slider) return;
            const slideWidth = slider.querySelector('.cart-drawer__cross-sell-item').clientWidth;
            slider.scrollLeft += nextArrow ? slideWidth : -slideWidth;
            return;
          }

          // Handle Voucher Carousel Arrows
          const voucherPrevArrow = target.closest('.cart-drawer__carousel-arrow.prev');
          const voucherNextArrow = target.closest('.cart-drawer__carousel-arrow.next');
          if (voucherPrevArrow || voucherNextArrow) {
            const voucherList = document.querySelector('.cart-drawer__voucher-list');
            if (!voucherList) return;
            
            const voucherItemWidth = voucherList.querySelector('.cart-drawer__voucher-item').clientWidth;
            const currentTransform = voucherList.style.transform || 'translateX(0px)';
            const currentX = parseInt(currentTransform.match(/-?\d+/)[0]) || 0;
            
            if (voucherPrevArrow) {
              const newX = Math.min(0, currentX + voucherItemWidth);
              voucherList.style.transform = `translateX(${newX}px)`;
            } else if (voucherNextArrow) {
              const maxX = -(voucherList.scrollWidth - voucherList.parentElement.clientWidth);
              const newX = Math.max(maxX, currentX - voucherItemWidth);
              voucherList.style.transform = `translateX(${newX}px)`;
            }
            return;
          }

          // Handle Apply Discount Button
          const applyButton = target.closest('.cart-drawer__discount-button');
          if (applyButton) {
            event.preventDefault();
            const form = applyButton.closest('form');
            const discountInput = form.querySelector('input[name="discount"]');
            if (!discountInput.value) {
              alert('Vui lòng nhập mã giảm giá.');
              return;
            }
            
            const originalButtonText = applyButton.textContent;
            applyButton.textContent = 'Đang áp dụng...';
            applyButton.disabled = true;

            fetch('/cart/update.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ 'discount': discountInput.value })
            })
            .then(res => res.json())
            .then(cart => {
              if (cart.status) {
                alert(cart.description || 'Mã giảm giá không hợp lệ.');
                discountInput.value = '';
              }
              rebuildCart();
            })
            .catch(e => console.error(e))
            .finally(() => {
              applyButton.textContent = originalButtonText;
              applyButton.disabled = false;
            });
            return;
          }

          // Handle Cross-Sell Add to Cart Button
          const addButton = target.closest('.cross-sell-item__add-btn');
          if (addButton) {
            event.preventDefault();
            const form = addButton.closest('form');
            const submitButton = form.querySelector('.cross-sell-item__add-btn');
            const quantityInput = form.querySelector('.cross-sell-qty__num');
            
            if (!quantityInput || parseInt(quantityInput.value) < 1) {
              alert('Vui lòng chọn số lượng sản phẩm.');
              return;
            }
            
            const originalButtonText = submitButton.textContent;
            submitButton.textContent = 'Đang thêm...';
            submitButton.disabled = true;

            // Update the hidden variant input with selected variant
            const variantSelect = form.closest('.cart-drawer__cross-sell-item').querySelector('.cross-sell-item__variant-select');
            if (variantSelect) {
              const hiddenIdInput = form.querySelector('input[name="id"]');
              hiddenIdInput.value = variantSelect.value;
            }

            fetch('{{ routes.cart_add_url }}.js', {
              method: 'POST',
              body: new FormData(form),
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(item => {
              if (item.status) {
                alert(item.description || 'Sản phẩm đã hết hàng.');
              } else {
                // Reset quantity to 1 after successful add
                quantityInput.value = '1';
              }
              rebuildCart();
            })
            .catch(e => console.error(e))
            .finally(() => {
              submitButton.textContent = originalButtonText;
              submitButton.disabled = false;
            });
            return;
          }

          // Handle Cross-sell Quantity Adjust Buttons
          const qtyAdjust = target.closest('.cross-sell-qty__adjust');
          if (qtyAdjust) {
            event.preventDefault();
            event.stopPropagation();
            const isPlus = qtyAdjust.classList.contains('cross-sell-qty__adjust--plus');
            const quantityInput = qtyAdjust.parentElement.querySelector('.cross-sell-qty__num');
            if (!quantityInput) return;
            
            let currentValue = parseInt(quantityInput.value) || 0;
            if (isPlus) {
              quantityInput.value = currentValue + 1;
            } else {
              quantityInput.value = Math.max(0, currentValue - 1);
            }
            return;
          }

          // Handle Voucher Copy Button
          const copyButton = target.closest('.voucher-copy-button');
          if (copyButton) {
            event.preventDefault();
            const codeToCopy = copyButton.dataset.copyCode;
            
            navigator.clipboard.writeText(codeToCopy).then(() => {
              const originalText = copyButton.textContent;
              copyButton.textContent = 'Đã chép!';
              copyButton.classList.add('copied');
              copyButton.disabled = true;
              setTimeout(() => {
                copyButton.textContent = originalText;
                copyButton.classList.remove('copied');
                copyButton.disabled = false;
              }, 2000);
            }).catch(err => {
              console.error('Không thể sao chép: ', err);
              alert('Không thể sao chép mã.');
            });
            return;
          }

          // Handle Cart Item Remove Button
          const removeButton = target.closest('.cart-item__remove');
          if (removeButton) {
            event.preventDefault();
            const itemId = removeButton.dataset.id;
            
            if (!itemId) return;
            
            const originalButtonContent = removeButton.innerHTML;
            removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#25282B" stroke-width="1.5"/><path d="M9 12l2 2 4-4" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            removeButton.disabled = true;
            
            fetch('/cart/change.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ id: itemId, quantity: 0 })
            })
            .then(response => response.json())
            .then(cart => {
              rebuildCart();
            })
            .catch(error => {
              console.error('Error removing item:', error);
              removeButton.innerHTML = originalButtonContent;
              removeButton.disabled = false;
            });
            return;
          }
        });

        // --- Event Delegation for Form Submissions ---
        document.addEventListener('submit', function(event) {
          // ... (existing submit handler)
        });
        
        // --- Event Delegation for Select Focus/Blur to toggle arrow direction ---
        document.addEventListener('focusin', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                event.target.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 11.25L9 6.75L13.5 11.25' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            }
        });

        document.addEventListener('focusout', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                event.target.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 6.75L9 11.25L13.5 6.75' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            }
        });

        // Handle variant select change
        document.addEventListener('change', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                const select = event.target;
                const crossSellItem = select.closest('.cart-drawer__cross-sell-item');
                const form = crossSellItem.querySelector('.cross-sell-item__form');
                const hiddenIdInput = form.querySelector('input[name="id"]');
                
                // Update the hidden variant input
                hiddenIdInput.value = select.value;
                
                // Update price display if needed
                // This would require fetching variant data from Shopify
                // For now, we'll just update the variant ID
            }
        });
        
        // Listen for drawer open events
        document.addEventListener('click', function(event) {
          // Check if cart drawer should be opened
          if (event.target.closest('[data-cart-drawer-toggle]') || 
              event.target.closest('.cart-link') ||
              event.target.closest('[href*="cart"]')) {
            setTimeout(ensureDrawerVisible, 100);
          }
          
          // Check if cart drawer should be closed
          if (event.target.closest('.js-drawer-close') || 
              event.target.closest('[data-cart-drawer-close]')) {
            setTimeout(showStickyAddToCart, 100);
          }
        });
        
        // Also ensure drawer is visible on page load if it should be open
        if (document.getElementById('CartDrawer').classList.contains('drawer--is-open')) {
          ensureDrawerVisible();
        }
        
        // Update cart count on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          syncCartUIFromDOM();
        });
      })();
    </script>

  </div>
{%- endif -%}
