{%- if settings.cart_type == 'drawer' -%}
  <style>
    /* General Drawer Styles */
    #CartDrawer {
      --font-stack-header: 'Be Vietnam Pro', serif;
      --font-stack-body: 'Be Vietnam Pro', sans-serif;
      font-family: var(--font-stack-body);
    }
    
    #CartDrawer .bundle-header {
      padding: 15px 0;
      font-weight: bold;
      font-size: 18px;
      color: #1C2C58;
      border-bottom: 1px solid #e9e9e9;
      margin-top: 10px;
    }

    #CartDrawer .cart__item--bundle-item {
      background-color: #F0F7FF;
      border-color: transparent;
    }
    
    /* Desktop: Smaller drawer width */
    @media (min-width: 769px) {
      #CartDrawer {
        width: 420px !important;
        max-width: 420px !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      #CartDrawer .drawer__inner {
        width: 420px !important;
        max-width: 420px !important;
      }
      #CartDrawer.drawer--is-open {
        transform: translateX(0) !important;
      }
    }
    
    /* Mobile: Full screen drawer */
    @media (max-width: 768px) {
      #CartDrawer {
        width: 100% !important;
        max-width: 100% !important;
      }
      #CartDrawer .drawer__inner {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Mobile: Fixed footer full width */
      #CartDrawer .drawer__footer {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        background: #fff !important;
        z-index: 1001 !important;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
        padding: 0 20px 20px 20px !important;
      }
    }
    
    /* Ensure drawer is properly positioned and visible */
    #CartDrawer {
      position: fixed !important;
      top: 0 !important;
      right: 0 !important;
      height: 100vh !important;
      z-index: 1000 !important;
      background: #fff !important;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1) !important;
      transform: translateX(100%) !important;
      transition: transform 0.3s ease !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    #CartDrawer.drawer--is-open {
      transform: translateX(0) !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Hide sticky add-to-cart when cart drawer is open */
    #CartDrawer.drawer--is-open ~ sticky-add-to-cart,
    body:has(#CartDrawer.drawer--is-open) sticky-add-to-cart {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    /* --- BUNDLE FOOTER STYLES --- */
    /* N·ªëi s·∫£n ph·∫©m cu·ªëi c√πng v·ªõi footer */
    .cart__item--bundle-item.is-before-footer {
      margin-bottom: 0 !important;
      border-bottom: none !important;
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }
    /* Style cho footer chung c·ªßa bundle */
    .bundle-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background-color: #F0F7FF;
      border-left: 4px solid #234085;
      border-radius: 0 0 8px 8px;
      margin-bottom: 12px;
    }
    .bundle-footer .js-qty__wrapper {
      border: 1px solid #E5E7EB;
      border-radius: 5px;
      overflow: hidden;
      background: #fff;
    }
    .bundle-footer .js-qty__num {
      background-color: #fff;
      border: none;
    }
    .bundle-footer .cart-item__remove {
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
    }

    #CartDrawer .cross-sell-item__title a {
      border-bottom: none !important;
      font-size: 20px;
      color: #1C2C58;
    }
    #CartDrawer .drawer__inner {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }
    #CartDrawer .drawer__fixed-header {
      position: relative;
      flex-shrink: 0;
    }
    #CartDrawer .drawer__scrollable {
      overflow-y: auto !important;
      flex-grow: 1;
      scrollbar-width: none; /* For Firefox */
      -ms-overflow-style: none; /* For Internet Explorer and Edge */
      max-height: calc(100vh - 120px); /* Ensure scrollable area */
      min-height: 200px; /* Minimum height to enable scroll */
      padding-bottom: 200px !important; /* Space for fixed footer */
    }
    #CartDrawer .drawer__header {
      padding: 20px 0 15px 0;
      margin-bottom: 0;
      position: static;
      background: #fff;
      display: block;
      width: 100%;
      flex-shrink: 0;
      z-index: 10;
    }
    
    #CartDrawer .drawer__header .drawer__title {
      font-family: var(--font-stack-body);
      width: 344px;
      height: 39px;
      flex-shrink: 0;
      color: #1C2C58;
      font-size: 38px;
      font-style: normal;
      font-weight: 600;
      line-height: 120%;
    }
    
    #CartDrawer .drawer__header .drawer__count {
      font-family: var(--font-stack-body);
      font-size: 16px;
    }
    
    /* Desktop only - Force header visibility */
    @media (min-width: 769px) {
      #CartDrawer .drawer__header {
        background: #fff !important;
        display: block !important;
        width: 100% !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      #CartDrawer .drawer__header .drawer__title {
        display: block !important;
        visibility: visible !important;
      }
      
      #CartDrawer .drawer__header .drawer__count {
        display: block !important;
        visibility: visible !important;
        color: #000 !important;
      }
      
      /* Ensure drawer scrollable works on desktop */
      #CartDrawer .drawer__scrollable {
        overflow-y: auto !important;
        height: auto !important;
        max-height: calc(100vh - 150px) !important;
        padding-bottom: 200px !important;
      }
      
      /* Desktop: Fixed footer with drawer width */
      #CartDrawer .drawer__footer {
        position: fixed !important;
        bottom: 0 !important;
        right: 0 !important;
        left: auto !important;
        width: 420px !important;
        max-width: 420px !important;
        background: #fff !important;
        z-index: 1001 !important;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
        padding: 20px !important;
      }
    }
    
    #CartDrawer .cart-empty-message {
      padding: 40px 20px;
      text-align: center;
      font-size: 16px;
      color: #666;
    }
    #CartDrawer .drawer__scrollable::-webkit-scrollbar {
      display: none; /* For Chrome, Safari, and Opera */
    }
    
    /* Remove gray line above drawer__scrollable */
    #CartDrawer .drawer__scrollable {
      border-top: none !important;
    }
    
    #CartDrawer .drawer__scrollable::before {
      display: none !important;
    }
    #CartDrawer .drawer__header .drawer__title {
      font-family: var(--font-stack-body);
      width: 344px;
      height: 39px;
      flex-shrink: 0;
      color: #1C2C58;
      font-size: 38px;
      font-style: normal;
      font-weight: 600;
      line-height: 120%;
    }
    #CartDrawer .drawer__header .drawer__count {
      font-family: var(--font-stack-body);
      font-size: 16px;
    }
    #CartDrawer .cart-drawer__services {
      display: flex;
      justify-content: space-around;
      padding: 0px 0 15px 0;
      border-bottom: 1px solid #e9e9e9;
      text-align: center;
      margin: 0;
      position: static;
      background: #fff;
      width: 100%;
    }
    .cart-drawer__service-item {
      font-family: var(--font-stack-body);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: #000;
      text-align: center;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
    }
    .cart-drawer__service-icon {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }


    /* Cart Items */
    .cart-item__title {
      color: #000 !important;
      font-family: "Be Vietnam Pro" !important;
      font-size: 20px !important;
      font-style: normal !important;
      font-weight: 600 !important;
      line-height: 140%; /* 28px */
    }
    .cart-item__variant {
      overflow: hidden;
      color: #000;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%; /* 24px */
    }
    .cart-item__price--original {
      overflow: hidden;
      color: #808080;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%; /* 24px */
      text-decoration-line: line-through;
    }
    .cart-item__price--final {
      overflow: hidden;
      color: #1C2C58;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%; /* 24px */
      margin-left: 10px;
    }

    .cart-drawer__free-shipping-info {
      padding: 15px;
      text-align: center;
      color: #1C2C58;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      margin: 0;
      position: static;
      background: #fff;
      width: 100%;
    }

    /* Cart Item Layout */
    .cart__item {
      display: flex;
      gap: 15px;
      padding: 20px 0;
      border-bottom: 1px solid #e9e9e9;
      margin: 0;
      position: static;
      background: #fff;
      width: 100%;
    }
    .cart__image {
      flex-shrink: 0;
    }
    .cart__item-details {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .cart-item__price-wrapper {
      margin: 5px 0;
    }
    .cart-item__footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto; /* Pushes footer to the bottom */
    }
    .cart-item__remove {
      font-family: var(--font-stack-body);
      font-size: 14px;
      text-decoration: none;
      color: #25282B;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
    }
    .cart-item__remove svg {
      width: 24px;
      height: 24px;
    }
    
    /* 
    To implement the SVG icon for cart-item__remove, replace the text content 
    with this SVG in your cart item template or JavaScript:
    
    <button class="cart-item__remove" data-cart-remove>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M3 6H5H21" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M10 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    */
    
    /* Discount Code */
    .cart-drawer__discount-header {
        overflow: hidden;
        color: #1C2C58;
        text-align: left;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: "Be Vietnam Pro", sans-serif;
        font-size: 16px;
        font-style: normal;
        font-weight: 400;
        line-height: 150%;
        margin: 20px 0 10px;
    }
    .cart-drawer__discount-form {
      display: flex !important;
      justify-content: center;
      align-items: stretch;
      gap: 0;
      max-width: 400px;
      margin: 0 auto;
      flex-direction: row;
    }
    .cart-drawer__discount-input {
      width: 70%;
      flex-grow: 1;
      height: 38px;
      border-radius: 8px 0 0 8px;
      background: #F0F7FF;
      border: 1px solid #D1E5FF;
      border-right: none;
      padding: 0 15px;
      font-family: var(--font-stack-body);
      display: inline-block;
      box-sizing: border-box;
    }
    .cart-drawer__discount-button {
      width: 28%;
      background: #759CE6;
      color: white;
      border: 1px solid #759CE6;
      border-radius: 0 8px 8px 0;
      padding: 0 20px;
      cursor: pointer;
      font-family: var(--font-stack-body);
      height: 38px;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .cart-drawer__voucher-carousel {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 0;
      position: relative;
    }
    .cart-drawer__voucher-carousel-inner {
      overflow: hidden;
      width: 100%;
    }
    .cart-drawer__voucher-list {
      display: flex;
      gap: 10px;
      transition: transform 0.3s ease-in-out;
      overflow: hidden;
    }
    .cart-drawer__voucher-item {
      position: relative;
      flex: 0 0 auto;
    }
    .cart-drawer__voucher-item img {
      display: block;
      width: 130px;
      height: auto;
      border-radius: 8px;
    }
      .voucher-copy-button {
        position: absolute;
        bottom: 8px;
        width: 60px;
        right: 15px;
        background: #759CE6;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 4px;
        font-weight: 400;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .voucher-copy-button:hover {
        background: #6B8CDB;
      }
      
      .voucher-copy-button:active,
      .voucher-copy-button.copied {
        background: #ccc;
        color: #333;
      }
    .cart-drawer__carousel-arrow {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0 10px;
    }

    /* Cart Summary */
    #CartDrawer .cart-drawer__summary {
      padding: 5px 0;
      background: #fff;
      width: 100%;
      opacity: 1 !important;
      transform: none !important;
      visibility: visible !important;
    }
    
    #CartDrawer .drawer__footer {
      opacity: 1 !important;
      transform: none !important;
      visibility: visible !important;
    }
    
    #CartDrawer .cart-drawer__summary-item {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-stack-body);
      font-size: 16px;
      padding: 5px 0;
    }
    #CartDrawer .cart-drawer__summary-item .price-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #CartDrawer .cart-drawer__summary-item .price--original {
      overflow: hidden;
      color: #808080;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      text-decoration-line: line-through;
    }
    #CartDrawer .cart-drawer__summary-item .price--final {
      overflow: hidden;
      color: #1C2C58;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 18px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%;
    }
    
    /* Discount Applications Styling */
    #CartDrawer .cart-drawer__discount-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: var(--font-stack-body);
      font-size: 16px;
      padding: 8px 0;
      color: #1C2C58;
      border-bottom: 1px solid #f0f0f0;
      margin-bottom: 8px;
    }
    #CartDrawer .cart-drawer__discount-title {
      flex: 1;
      color: #1C2C58;
      font-weight: 500;
    }
    #CartDrawer .cart-drawer__discount-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #CartDrawer .cart-drawer__discount-amount {
      overflow: hidden;
      color: #E74C3C;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%;
    }
    #CartDrawer .cart-drawer__discount-remove {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    #CartDrawer .cart-drawer__discount-remove:hover {
      background: #f5f5f5;
      color: #666;
    }
    #CartDrawer .cart-drawer__discount-remove svg {
      width: 16px;
      height: 16px;
    }
    #CartDrawer .summary-item__right-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    #CartDrawer .summary-item__right-content .text-right {
      font-size: 14px;
      margin-top: 4px;
    }
    #CartDrawer .cart-drawer__savings {
      width: 100%;
      height: 38px;
      flex-shrink: 0;
      border-radius: 8px;
      background: #FCE390;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }
    #CartDrawer .cart-drawer__savings span {
      overflow: hidden;
      color: #1C2C58;
      text-align: center;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%;
    }
    .cart-drawer__cross-sell-header-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0 10px;
    }
    .cart-drawer__cross-sell-header {
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      margin: 0;
      flex: 1;
    }
    .cart-drawer__cross-sell-slider-wrapper {
      position: relative;
    }
    .cart-drawer__arrows-container {
      display: flex;
      gap: 10px;
      margin: 0;
    }
    .cart-drawer__cross-sell-slider {
      display: flex;
      overflow-x: hidden;
      scroll-behavior: smooth;
      gap: 15px;
      padding-bottom: 20px;
    }
    .cart-drawer__cross-sell-item {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 15px;
      padding: 15px;
      border-radius: 8px;
      background: #F0F7FF;
      align-items: center;
      flex: 0 0 100%; /* Each item takes full width */
    }
    .cross-sell-item__top-row {
      display: flex;
      gap: 15px;
      align-items: flex-start;
      width: 100%;
    }
    .cross-sell-item__image {
      display: flex;
      width: 203px;
      height: 132px;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      background: #FFF;
    }
    .cross-sell-item__info {
      flex-grow: 1;
      text-align: left;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    .cross-sell-item__variant-select {
      width: 100%;
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      text-decoration-line: underline;
      cursor: pointer;
      border: 1px solid #ddd;
      background: white;
      padding: 8px 20px 8px 12px;
      margin-bottom: 3px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 6.75L9 11.25L13.5 6.75' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right center;
      text-align: left;
    }
    .cross-sell-item__quantity-label {
      color: #000;
      font-family: "Be Vietnam Pro", sans-serif;
      font-size: 16px;
      white-space: nowrap;
      margin-bottom: 0 !important;
    }
    .cross-sell-item__quantity-wrapper {
        display: flex !important;
        width: 120px;
        height: 35px;
        align-items: center;
        gap: 0;
        flex-shrink: 0;
        border-radius: 5px;
        border: 1px solid #E5E7EB;
        background: #FFF;
        overflow: hidden;
        position: relative;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust {
        width: 30px;
        height: 35px;
        border: none;
        background: transparent;
        color: #000;
        font-size: 16px;
        font-weight: normal;
        cursor: pointer;
        display: flex !important;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
        padding: 0;
        margin: 0;
        outline: none;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust:hover {
        background: transparent;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust:active {
        background: transparent;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust--minus {
        border: none;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__adjust--plus {
        border: none;
    }
    
    /* Ensure quantity wrapper children stay inside */
    .cross-sell-item__quantity-wrapper > * {
        position: relative !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .cross-sell-item__quantity-wrapper .cross-sell-qty__num {
        flex: 1;
        height: 35px;
        border: none;
        background: #FFF;
        text-align: center;
        font-size: 16px;
        font-weight: 600;
        color: #1C2C58;
        outline: none;
        padding: 0;
        min-width: 0;
        position: relative;
        z-index: 1;
        justify-content: center !important;
    }
    .cross-sell-item__add-btn {
      display: flex;
      width: 120px;
      height: 35px;
      padding: 12px 35px;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      border-radius: 5px;
      background: #FCE390;
      color: #1C2C58;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }
    .cart-drawer__cross-sell-arrow--next {
      background: #234085 !important;
    }
    .cart-drawer__cross-sell-arrow {
      background: #F5F9FF;
      border: 1px solid #e9e9e9;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cross-sell-item__info h4 { font-size: 16px; }
    .cross-sell-item__info p,
    .cross-sell-item__variant-select,
    .cross-sell-item__quantity-label {
      font-size: 14px;
    }
    .cross-sell-item__image {
      width: 140px;
      height: 140px;
      flex-shrink: 0;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      background: #FFF;
    }
    .cross-sell-item__price-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
    .cross-sell-item__price-wrapper .compare-at-price {
        font-size: 14px;
        text-decoration: line-through;
        opacity: 0.7;
    }
    .cross-sell-item__form {
        width: 100%;
    }
    .cross-sell-item__form-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 40px;
        width: 100%;
    }
    .cross-sell-item__quantity {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 50%;
    }
    .cross-sell-item__add-btn {
      display: flex;
      padding: 12px 0;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      border-radius: 15px;
      background: #FCE390;
      color: #000;
      border: none;
      cursor: pointer;
    }
    /* Bundle Voucher Notice */
    .bundle-voucher-notice {
      margin: 10px 0;
    }
    
    .bundle-voucher-notice div {
      background: #E8F4FD;
      border: 1px solid #B3D9FF;
      border-radius: 8px;
      padding: 12px;
      font-family: 'Be Vietnam Pro', sans-serif;
      font-size: 14px;
      color: #1C2C58;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Checkout Buttons */
    #CartDrawer .cart__checkout-wrapper--custom {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    #CartDrawer .btn--cod, #CartDrawer .btn--online {
      flex: 1;
      border-radius: 15px;
      text-align: center;
      text-decoration: none;
      font-family: var(--font-stack-body);
      font-weight: 700;
      font-size: 16px;
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    #CartDrawer .btn--online {
      background-color: #FCE390;
      color: #1C2C58;
    }
    
    /* Mobile responsive for checkout buttons */
    @media (max-width: 768px) {
      #CartDrawer .btn--cod, #CartDrawer .btn--online {
        font-size: 14px;
      }
    }
  </style>

  <div id="CartDrawer" class="drawer drawer--right">
    <form id="CartDrawerForm" action="{{ routes.cart_url }}" method="post" novalidate class="drawer__contents" data-location="cart-drawer">
      <div class="drawer__inner">
        <!-- Fixed Header - Always visible -->
        <div class="drawer__header relative appear-animation appear-delay-1">
          <div class="h2 drawer__title">{{ 'cart.general.title' | t }}</div>
          <div class="drawer__count">
             {{ cart.item_count }} s·∫£n ph·∫©m
          </div>
          <div class="drawer__close absolute right-0">
            <button type="button" class="drawer__close-button js-drawer-close">
              {%- render 'close-icon' -%}
              <span class="icon__fallback-text">{{ 'cart.general.close_cart' | t }}</span>
            </button>
          </div>
        </div>
        
        <div class="drawer__scrollable">
          
          <!-- SERVICES -->
          <div class="cart-drawer__services">
            <div class="cart-drawer__service-item">
              {% if settings.cart_free_shipping_icon != blank %}
                <img src="{{ settings.cart_free_shipping_icon | image_url: width: 64 }}" class="cart-drawer__service-icon" alt="Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn" width="32" height="32">
              {% endif %}
              <span>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</span>
            </div>
            <div class="cart-drawer__service-item">
              {% if settings.cart_warranty_icon != blank %}
                <img src="{{ settings.cart_warranty_icon | image_url: width: 64 }}" class="cart-drawer__service-icon" alt="B·∫£o h√†nh d√†i l√¢u" width="32" height="32">
              {% endif %}
              <span>B·∫£o h√†nh d√†i l√¢u</span>
            </div>
          </div>

          <!-- FREE SHIPPING DETAILS -->
          {%- if settings.cart_free_shipping_enable -%}
            <div class="cart-drawer__free-shipping-info appear-animation appear-delay-2">
              {%- assign threshold = settings.cart_free_shipping_threshold -%}
              {%- if cart.total_price >= threshold -%}
                ƒê∆°n h√†ng c·ªßa b·∫°n ƒë∆∞·ª£c mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn
              {%- else -%}
                {%- assign remaining = threshold | minus: cart.total_price -%}
                Mua th√™m {{ remaining | money }} ƒë·ªÉ ƒë∆∞·ª£c mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn
              {%- endif -%}
            </div>
          {%- endif -%}

          <!-- CART ITEMS -->
          <div data-products class="appear-animation appear-delay-2">
            {%- comment -%} Cart items are rendered here via JS {%- endcomment -%}
          </div>

          
          <!-- DISCOUNT CODE -->
          <div class="cart-drawer__discount-wrapper" id="discount-wrapper">
              <h3 class="cart-drawer__discount-header">Nh·∫≠p m√£ ∆∞u ƒë√£i c·ªßa b·∫°n (copy v√† d√°n v√†o √¥ d∆∞·ªõi)</h3>
              <form action="{{ routes.cart_url }}/update" method="post" class="cart-drawer__discount-form" novalidate>
                  <input type="text" id="CartDrawer-Discount" name="discount" class="cart-drawer__discount-input" placeholder="M√£ ∆∞u ƒë√£i">
                  <button type="button" class="cart-drawer__discount-button">√Åp d·ª•ng</button>
              </form>
              <div class="cart-drawer__voucher-carousel">
                  <button type="button" class="cart-drawer__carousel-arrow prev">
                      <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none"><path d="M12.9163 15.5L18.0833 20.6668L16.7917 21.9583L10.3333 15.5L16.7917 9.04163L18.0833 10.3331L12.9163 15.5Z" fill="#9E9EB0"/><circle cx="15.5" cy="15.5" r="15" stroke="#E9E9E9"/></svg>
                  </button>
                  <div class="cart-drawer__voucher-carousel-inner">
                      <div class="cart-drawer__voucher-list">
                        {% for i in (1..5) %}
                          {%- assign voucher_image_setting = 'voucher_image_' | append: i -%}
                          {%- assign voucher_code_setting = 'voucher_code_' | append: i -%}
                          {%- assign voucher_image = settings[voucher_image_setting] -%}
                          {%- assign voucher_code = settings[voucher_code_setting] -%}
                          {% if voucher_image != blank and voucher_code != blank %}
                            <div class="cart-drawer__voucher-item">
                              <img src="{{ voucher_image | image_url: width: 260 }}" alt="Voucher {{ i }}" loading="lazy" width="130" height="65">
                              <button class="voucher-copy-button" data-copy-code="{{ voucher_code }}">Copy</button>
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>
                  </div>
                   <button type="button" class="cart-drawer__carousel-arrow next">
                      <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none"><path d="M18.0837 15.5L12.9167 10.3332L14.2083 9.04171L20.6667 15.5L14.2083 21.9584L12.9167 20.6669L18.0837 15.5Z" fill="#609EE9"/><circle cx="15.5" cy="15.5" r="15" stroke="#E9E9E9"/></svg>
                  </button>
              </div>
          </div>

          <!-- CROSS-SELL -->
          {%- assign cross_sell_products = settings.cart_cross_sell_products -%}
          {%- if cross_sell_products.count > 0 -%}
          <div class="cart-drawer__cross-sell">
            <div class="cart-drawer__cross-sell-header-wrapper">
              <h3 class="cart-drawer__cross-sell-header">ThƒÉng h·∫°ng ch·∫•t l∆∞·ª£ng gi·∫•c ng·ªß c√πng</h3>
              <div class="cart-drawer__arrows-container">
                <button type="button" class="cart-drawer__cross-sell-arrow cart-drawer__cross-sell-arrow--prev" aria-label="Previous product">
                  <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none">
                    <path d="M12.9163 15.5L18.0833 20.6668L16.7917 21.9583L10.3333 15.5L16.7917 9.04163L18.0833 10.3331L12.9163 15.5Z" fill="#9E9EB0"/>
                  </svg>
                </button>
                <button type="button" class="cart-drawer__cross-sell-arrow cart-drawer__cross-sell-arrow--next" aria-label="Next product">
                   <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none">
                    <path d="M18.0837 15.5L12.9167 10.3332L14.2083 9.04171L20.6667 15.5L14.2083 21.9584L12.9167 20.6669L18.0837 15.5Z" fill="#FFF"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="cart-drawer__cross-sell-slider-wrapper">
              <div class="cart-drawer__cross-sell-slider">
                {%- for product in cross_sell_products -%}
                    {%- assign current_variant = product.first_available_variant -%}
                    <div class="cart-drawer__cross-sell-item" data-product-id="{{ product.id }}">
                      <!-- First row: Image and Product info side by side -->
                      <div class="cross-sell-item__top-row">
                        <a href="{{ product.url }}" class="cross-sell-item__image">
                          <img src="{{ product.featured_image | image_url: width: 280, height: 280 }}" width="140" height="140" alt="{{ product.featured_image.alt | escape }}" loading="lazy">
                        </a>
                        <div class="cross-sell-item__info">
                          <h4 class="cross-sell-item__title"><a href="{{ product.url }}">{{ product.title }}</a></h4>
                          <div class="cross-sell-item__price-wrapper">
                            <span class="price">{{ current_variant.price | money }}</span>
                            {% if current_variant.compare_at_price > current_variant.price %}
                              <del class="compare-at-price">{{ current_variant.compare_at_price | money }}</del>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      
                      <!-- Second row: Variant select -->
                      {% if product.variants.size > 1 %}
                        <select name="id" class="cross-sell-item__variant-select">
                          {% for variant in product.variants %}
                            <option {% if variant == current_variant %}selected="selected"{% endif %} value="{{ variant.id }}">{{ variant.title }}</option>
                          {% endfor %}
                        </select>
                      {% endif %}
                      
                      <!-- Third row: Form row (quantity + add button) -->
                      <form method="post" action="{{ routes.cart_add_url }}" class="cross-sell-item__form">
                        <input type="hidden" name="id" value="{{ current_variant.id }}">
                        <div class="cross-sell-item__form-row">
                          <div class="cross-sell-item__quantity">
                            <label for="cross-sell-quantity-{{ product.id }}" class="cross-sell-item__quantity-label">S·ªë l∆∞·ª£ng:</label>
                            <div class="cross-sell-item__quantity-wrapper">
                              <button type="button" class="cross-sell-qty__adjust cross-sell-qty__adjust--minus" aria-label="-">-</button>
                              <input type="text" id="cross-sell-quantity-{{ product.id }}" name="quantity" value="1" min="1" class="cross-sell-qty__num">
                              <button type="button" class="cross-sell-qty__adjust cross-sell-qty__adjust--plus" aria-label="+">+</button>
                            </div>
                          </div>
                          <button type="button" class="cross-sell-item__add-btn">Th√™m</button>
                        </div>
                      </form>
                    </div>
                  {%- endfor -%}
              </div>
            </div>
          </div>
          {%- endif -%}
        </div>

        <div class="drawer__footer appear-animation appear-delay-4">
          <div data-cart-footer>
            
            <!-- SUMMARY -->
            <div class="cart-drawer__summary">
                {%- comment -%}
                  Calculate original total price based on the same logic as cart-item.liquid
                  This ensures we capture both compare_at_price and original_price correctly.
                {%- endcomment -%}
                {%- assign original_total_price_calculated = 0 -%}
                {%- for item in cart.items -%}
                    {%- assign line_price = 0 -%}
                    {%- if item.variant.compare_at_price > item.price -%}
                        {%- assign line_price = item.variant.compare_at_price | times: item.quantity -%}
                    {%- else -%}
                        {%- assign line_price = item.original_price | times: item.quantity -%}
                    {%- endif -%}
                    {%- assign original_total_price_calculated = original_total_price_calculated | plus: line_price -%}
                {%- endfor -%}

                {%- assign total_savings = original_total_price_calculated | minus: cart.total_price -%}

                <div class="cart-drawer__savings" data-savings-display>
                  <span>B·∫°n ƒë√£ ti·∫øt ki·ªám ƒë∆∞·ª£c {{ total_savings | money }}</span>
                </div>

                <!-- DISCOUNT APPLICATIONS -->
                {%- if cart.cart_level_discount_applications.size > 0 -%}
                  {%- for cart_discount in cart.cart_level_discount_applications -%}
                    <div class="cart-drawer__summary-item cart-drawer__discount-item">
                      <span class="cart-drawer__discount-title">{{ cart_discount.title }}</span>
                      <div class="cart-drawer__discount-right">
                        <span class="cart-drawer__discount-amount">-{{ cart_discount.total_allocated_amount | money }}</span>
                        <button type="button" class="cart-drawer__discount-remove" data-discount-title="{{ cart_discount.title }}" title="B·ªè m√£ gi·∫£m gi√°">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  {%- endfor -%}
                {%- endif -%}

                <div class="cart-drawer__summary-item">
                    <span>T·∫°m t√≠nh</span>
                    <div class="summary-item__right-content">
                      <span class="price-container">
                        {%- if total_savings > 0 -%}
                          <del class="price--original">{{ original_total_price_calculated | money }}</del>
                        {%- endif -%}
                        <span data-subtotal class="price--final">{{ cart.total_price | money }}</span>
                      </span>
                      {%- if cart.cart_level_discount_applications.size > 0 -%}
                        <span class="text-right">ƒê√£ √°p d·ª•ng ∆∞u ƒë√£i</span>
                      {%- endif -%}
                    </div>
                </div>

                <div class="cart-drawer__summary-item">
                    <span style="color: #000;">V·∫≠n chuy·ªÉn</span>
                    <span style="color: #1C2C58;">Mi·ªÖn ph√≠</span>
                </div>
            </div>


            <!-- CHECKOUT BUTTONS -->
            <div class="cart__checkout-wrapper--custom">
                {%- assign bundle_voucher = '' -%}
                {%- comment -%} Check bundle items for voucher {%- endcomment -%}
                {%- for item in cart.items -%}
                  {%- if item.properties._bundle_voucher -%}
                    {%- assign bundle_voucher = item.properties._bundle_voucher -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}

                <button type="submit" name="checkout" class="btn btn--online" onclick="handleCheckout(); return false;">Thanh to√°n ngay</button>
            </div>
            {% if additional_checkout_buttons and settings.cart_additional_buttons %}
              <div class="additional-checkout-buttons additional-checkout-buttons--vertical">{{ content_for_additional_checkout_buttons }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="drawer__cart-empty appear-animation appear-delay-2">
        <div class="drawer__scrollable">
          <div class="cart-empty-message">
            {{ 'cart.general.empty' | t }}
          </div>
        </div>
      </div>
    </form>

    <script>
      (function() {
        // --- General Cart Drawer Functions ---
        function rebuildCart() {
          if (theme && typeof theme.CartForm === 'function') {
            const cartFormInstance = new theme.CartForm(document.getElementById('CartDrawerForm'));
            cartFormInstance.buildCart();
            
            // Check for bundle vouchers after cart rebuild
            setTimeout(() => {
              checkAndApplyBundleVouchers();
              checkStoredBundleVoucher();
              manageDiscountFieldForBundle();
            }, 500);
            
            // MutationObserver will handle all UI updates instantly after this.
          } else {
            window.location.href = '{{ routes.cart_url }}';
          }
        }

        // Also call checkStoredBundleVoucher on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(() => {
            checkStoredBundleVoucher();
          }, 1000);
        });

        // Function to refresh cart drawer (alias for rebuildCart)
        function refreshCartDrawer() {
          rebuildCart();
        }

        // Function to ensure drawer is visible
        function ensureDrawerVisible() {
          const drawer = document.getElementById('CartDrawer');
          if (drawer) {
            drawer.classList.add('drawer--is-open');
          }
        }

        // Function to show sticky add to cart
        function showStickyAddToCart() {
          const drawer = document.getElementById('CartDrawer');
          if (drawer) {
            drawer.classList.remove('drawer--is-open');
          }
        }

        function checkAndApplyBundleVouchers() {
          console.log('=== CHECK AND APPLY BUNDLE VOUCHERS ===');
          
          // Get all bundle items in cart
          const bundleItems = document.querySelectorAll('.cart__item--bundle-item');
          console.log('Found bundle items:', bundleItems.length);
          
          bundleItems.forEach((item, index) => {
            console.log(`Checking bundle item ${index}:`, item);
            
            // Look for bundle voucher in item properties
            const propertiesEl = item.querySelector('.cart-item__properties');
            if (propertiesEl) {
              const bundleVoucherEl = propertiesEl.querySelector('[data-property-name="_bundle_voucher"]');
              if (bundleVoucherEl) {
                const voucherCode = bundleVoucherEl.textContent?.trim();
                console.log('Found bundle voucher:', voucherCode);
                
                if (voucherCode && voucherCode !== '') {
                  // Check if voucher is already applied
                  const existingDiscount = document.querySelector('.cart-drawer__discount-item');
                  if (!existingDiscount) {
                    console.log('Auto-applying bundle voucher:', voucherCode);
                    autoApplyBundleVoucher(voucherCode);
                  } else {
                    console.log('Voucher already applied, skipping...');
                  }
                }
              }
            }
          });
        }

        function autoApplyBundleVoucher(voucherCode) {
          console.log('=== AUTO APPLY BUNDLE VOUCHER ===');
          console.log('Voucher code:', voucherCode);
          
          fetch('/cart/update.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ 'discount': voucherCode })
          })
          .then(response => response.json())
          .then(data => {
            console.log('Bundle voucher application response:', data);
            if (data.status) {
              console.log('‚ùå Bundle voucher application failed:', data.description);
            } else {
              console.log('‚úÖ Bundle voucher applied successfully');
              
              // Show success notification
              showBundleVoucherNotification(voucherCode, data);
              
              // Update cart display
              setTimeout(() => rebuildCart(), 300);
            }
          })
          .catch(error => {
            console.error('‚ùå Error applying bundle voucher:', error);
          });
        }

        function showBundleVoucherNotification(voucherCode, cartData) {
          console.log('=== SHOW BUNDLE VOUCHER NOTIFICATION ===');
          
          // Calculate discount amount
          let discountAmount = 0;
          if (cartData.cart_level_discount_applications && cartData.cart_level_discount_applications.length > 0) {
            cartData.cart_level_discount_applications.forEach(discount => {
              if (discount.title && discount.title.toLowerCase().includes(voucherCode.toLowerCase())) {
                discountAmount = discount.total_allocated_amount || discount.amount || 0;
              }
            });
          }
          
          // Create notification element
          const notification = document.createElement('div');
          notification.className = 'bundle-voucher-notification';
          notification.innerHTML = `
            <div style="
              position: fixed;
              top: 20px;
              right: 20px;
              background: #10B981;
              color: white;
              padding: 12px 16px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              z-index: 10000;
              font-family: 'Be Vietnam Pro', sans-serif;
              font-size: 14px;
              max-width: 300px;
            ">
              <div style="font-weight: 600; margin-bottom: 4px;">
                üéâ Bundle Voucher Applied!
              </div>
              <div style="font-size: 12px; opacity: 0.9;">
                Code: ${voucherCode} ‚Ä¢ Savings: ${discountAmount > 0 ? (discountAmount / 100).toLocaleString('vi-VN') + '‚Ç´' : 'Applied'}
              </div>
            </div>
          `;
          
          document.body.appendChild(notification);
          
          // Auto remove after 3 seconds
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 3000);
        }

        // Ensure bundle voucher persists through checkout
        function ensureBundleVoucherPersistence() {
          console.log('=== ENSURE BUNDLE VOUCHER PERSISTENCE ===');
          
          // Get current discount code from cart
          const discountInput = document.querySelector('.cart-drawer__discount-input');
          if (discountInput && discountInput.value) {
            const currentDiscount = discountInput.value;
            console.log('Current discount in cart:', currentDiscount);
            
            // Store in sessionStorage for checkout persistence
            sessionStorage.setItem('bundle_voucher_code', currentDiscount);
            console.log('Stored voucher in sessionStorage:', currentDiscount);
          }
        }

        // Check for stored voucher on page load
        // Function to handle checkout with voucher
        function handleCheckout() {
          console.log('=== HANDLE CHECKOUT ===');
          
          // Get current cart state
          fetch('/cart.js')
            .then(response => response.json())
            .then(cartData => {
              // Check if discount is already applied
              const hasDiscount = cartData.cart_level_discount_applications && 
                                 cartData.cart_level_discount_applications.length > 0;
              
              // Find voucher from bundle items
              let bundleVoucher = null;
              for (const item of cartData.items) {
                if (item.properties && item.properties._bundle_voucher) {
                  bundleVoucher = item.properties._bundle_voucher;
                  break;
                }
              }
              
              console.log('Cart state:', {
                hasDiscount,
                bundleVoucher,
                discountApplications: cartData.cart_level_discount_applications
              });
              
              if (hasDiscount) {
                // Discount already applied, go directly to checkout
                console.log('Discount already applied, going to checkout');
                window.location.href = '/checkout';
              } else if (bundleVoucher) {
                // Apply bundle voucher first, then go to checkout
                console.log('Applying bundle voucher before checkout:', bundleVoucher);
                fetch('/cart/update.js', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({ 'discount': bundleVoucher })
                })
                .then(response => response.json())
                .then(data => {
                  console.log('Voucher applied before checkout:', data);
                  // Go to checkout after voucher is applied
                  window.location.href = '/checkout';
                })
                .catch(error => {
                  console.error('Error applying voucher before checkout:', error);
                  // Go to checkout anyway
                  window.location.href = '/checkout';
                });
              } else {
                // No discount and no bundle voucher, go to checkout normally
                console.log('No discount or bundle voucher, going to checkout');
                window.location.href = '/checkout';
              }
            })
            .catch(error => {
              console.error('Error getting cart state:', error);
              // Fallback: go directly to checkout
              window.location.href = '/checkout';
            });
        }


        function checkStoredBundleVoucher() {
          // Check if voucher is stored in bundle items and apply silently
          fetch('/cart.js')
            .then(response => response.json())
            .then(cartData => {
              const hasDiscount = cartData.cart_level_discount_applications &&
                                 cartData.cart_level_discount_applications.length > 0;
              
              // Find voucher from bundle items
              let storedVoucher = null;
              for (const item of cartData.items) {
                if (item.properties && item.properties._bundle_voucher) {
                  storedVoucher = item.properties._bundle_voucher;
                  break;
                }
              }
              
              console.log('=== CHECK STORED BUNDLE VOUCHER ===');
              console.log('Has discount:', hasDiscount);
              console.log('Stored voucher:', storedVoucher);
              
              if (!hasDiscount && storedVoucher) {
                console.log('Auto-applying stored voucher:', storedVoucher);
                // Apply voucher silently
                fetch('/cart/update.js', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify({ 'discount': storedVoucher })
                })
                .then(response => response.json())
                .then(data => {
                  console.log('Voucher re-applied successfully');
                  // Refresh cart to show updated prices
                  setTimeout(() => rebuildCart(), 500);
                })
                .catch(error => {
                  console.error('Error re-applying voucher:', error);
                });
              } else if (hasDiscount) {
                console.log('Discount already applied, no need to re-apply');
              } else {
                console.log('No stored voucher found');
              }
            })
            .catch(error => {
              console.error('Error checking stored voucher:', error);
            });
        }
        

        function manageDiscountFieldForBundle() {
          // Always show discount field to allow users to add additional vouchers
          // Only hide if there's a specific reason (like preventing multiple discounts)
          const discountWrapper = document.getElementById('discount-wrapper');
          
          if (discountWrapper) {
            // Always show the discount input field
            discountWrapper.style.display = '';
            
            // Optional: Add a note about bundle vouchers if present
            fetch('/cart.js')
              .then(response => response.json())
              .then(cartData => {
                let hasBundleVoucher = false;
                for (const item of cartData.items) {
                  if (item.properties && item.properties._bundle_voucher) {
                    hasBundleVoucher = true;
                    break;
                  }
                }
                
                // Add/update bundle voucher notice if needed
                let noticeElement = document.querySelector('.bundle-voucher-notice');
                if (hasBundleVoucher && !noticeElement) {
                  noticeElement = document.createElement('div');
                  noticeElement.className = 'bundle-voucher-notice';
                  noticeElement.innerHTML = `
                    <div style="
                      background: #E8F4FD;
                      border: 1px solid #B3D9FF;
                      border-radius: 8px;
                      padding: 12px;
                      margin: 10px 0;
                      font-family: 'Be Vietnam Pro', sans-serif;
                      font-size: 14px;
                      color: #1C2C58;
                      text-align: center;
                    ">
                      üí° B·∫°n ƒë√£ c√≥ voucher t·ª´ bundle. B·∫°n c√≥ th·ªÉ th√™m voucher kh√°c n·∫øu c·∫ßn.
                    </div>
                  `;
                  discountWrapper.parentNode.insertBefore(noticeElement, discountWrapper);
                } else if (!hasBundleVoucher && noticeElement) {
                  noticeElement.remove();
                }
              })
              .catch(error => {
                // Silent fail
              });
          }
        }

        function handleBundleHeaders() {
          const productContainer = document.querySelector('#CartDrawer [data-products]');
          if (productContainer) {
            const renderedBundleIds = new Set();
            const bundleGroups = {}; // Track items by bundle ID
            
            // First, hide all headers to reset
            productContainer.querySelectorAll('.bundle-header').forEach(h => h.style.display = 'none');
            
            // Group bundle items by bundle ID
            const items = productContainer.querySelectorAll('.cart__item--bundle-item');
            items.forEach(item => {
              const bundleId = item.dataset.bundleId;
              if (bundleId) {
                if (!bundleGroups[bundleId]) {
                  bundleGroups[bundleId] = [];
                }
                bundleGroups[bundleId].push(item);
              }
            });
            
            // For each bundle group, show header and add classes
            Object.keys(bundleGroups).forEach(bundleId => {
              const bundleItems = bundleGroups[bundleId];
              
              if (bundleItems.length > 0) {
                // Show header and move to before first item
                const header = productContainer.querySelector(`.bundle-header[data-bundle-id="${bundleId}"]`);
                const firstItem = bundleItems[0];
                
                if (header && firstItem) {
                  header.style.display = 'block';
                  firstItem.parentNode.insertBefore(header, firstItem);
                }
                
                // Add classes to first and last items for seamless styling
                bundleItems.forEach((item, index) => {
                  item.classList.remove('bundle-item-first', 'bundle-item-last', 'bundle-item-middle');
                  
                  if (bundleItems.length === 1) {
                    item.classList.add('bundle-item-single');
                  } else if (index === 0) {
                    item.classList.add('bundle-item-first');
                  } else if (index === bundleItems.length - 1) {
                    item.classList.add('bundle-item-last');
                  } else {
                    item.classList.add('bundle-item-middle');
                  }
                });
              }
            });
          }
        }

        function createDiscountField(cart, discountCode) {
          // Remove existing discount fields
          document.querySelectorAll('.cart-drawer__discount-item').forEach(item => item.remove());
          
          console.log('Creating discount field, cart data:', cart);
          console.log('cart_level_discount_applications:', cart.cart_level_discount_applications);
          
          if (cart.cart_level_discount_applications && cart.cart_level_discount_applications.length > 0) {
            const summaryContainer = document.querySelector('.cart-drawer__summary');
            const savingsElement = document.querySelector('[data-savings-display]');
            
            if (summaryContainer && savingsElement) {
              cart.cart_level_discount_applications.forEach((cartDiscount, index) => {
                console.log(`Discount ${index}:`, cartDiscount);
                
                const discountItem = document.createElement('div');
                discountItem.className = 'cart-drawer__summary-item cart-drawer__discount-item';
                
                // Safe handling of discount amount - try different possible properties
                let discountAmount = 0;
                let discountTitle = 'Discount';
                
                if (cartDiscount.total_allocated_amount) {
                  discountAmount = cartDiscount.total_allocated_amount / 100; // Remove extra zeros
                } else if (cartDiscount.amount) {
                  discountAmount = cartDiscount.amount / 100; // Remove extra zeros
                }
                
                if (cartDiscount.title) {
                  discountTitle = cartDiscount.title;
                } else if (cartDiscount.discount_application && cartDiscount.discount_application.title) {
                  discountTitle = cartDiscount.discount_application.title;
                }
                
                console.log(`Processed discount: amount=${discountAmount}, title=${discountTitle}`);
                
                discountItem.innerHTML = `
                  <span class="cart-drawer__discount-title">${discountTitle}</span>
                  <div class="cart-drawer__discount-right">
                    <span class="cart-drawer__discount-amount">-${formatMoney(discountAmount)}</span>
                    <button type="button" class="cart-drawer__discount-remove" data-discount-title="${discountTitle}" title="B·ªè m√£ gi·∫£m gi√°">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                `;
                
                savingsElement.parentNode.insertBefore(discountItem, savingsElement.nextSibling);
              });
              
              console.log('Created discount field with X button');
            }
          } else {
            console.log('No discount applications found in cart');
          }
        }

        function updateCartPrices(cart) {
          
          // Update subtotal immediately using server cart total (already includes discounts)
          const subtotalElement = document.querySelector('[data-subtotal]');
          if (subtotalElement) {
            subtotalElement.textContent = formatMoney(cart.total_price);
            console.log('Updated subtotal immediately:', formatMoney(cart.total_price));
          }
          
          // Calculate original price from DOM (before any discounts)
          let totalOriginalPrice = 0;
          const cartItems = document.querySelectorAll('#CartDrawer .cart__item');
          const moneyRegex = /[^\d]/g;
          const parsePrice = (el) => el ? (parseInt(el.textContent.replace(moneyRegex, ''), 10) || 0) : 0;
          
          cartItems.forEach(item => {
            const quantity = parseInt(item.dataset.quantity, 10) || 1;
            const originalPriceEl = item.querySelector('.cart-item__price--original');
            const finalPriceEl = item.querySelector('.cart-item__price--final');
            const originalPriceUnit = originalPriceEl ? parsePrice(originalPriceEl) : parsePrice(finalPriceEl);
            totalOriginalPrice += originalPriceUnit * quantity;
          });
          
          // Total savings = original price - final price (from server, includes all discounts)
          const totalSavings = totalOriginalPrice - cart.total_price;
          
          console.log('updateCartPrices - Server calculation:', {
            totalOriginalPrice,
            serverTotalPrice: cart.total_price,
            totalSavings
          });
          
          const savingsDisplay = document.querySelector('[data-savings-display] span');
          if (savingsDisplay) {
            savingsDisplay.textContent = 'B·∫°n ƒë√£ ti·∫øt ki·ªám ƒë∆∞·ª£c ' + formatMoney(totalSavings);
          }
          
          // Show/hide original price
          const priceContainer = document.querySelector('.cart-drawer__summary-item .price-container');
          if (priceContainer) {
            let priceOriginalEl = priceContainer.querySelector('.price--original');
            if (totalSavings > 0) {
              if (!priceOriginalEl) {
                priceOriginalEl = document.createElement('del');
                priceOriginalEl.className = 'price--original';
                priceContainer.insertBefore(priceOriginalEl, subtotalElement);
              }
              priceOriginalEl.textContent = formatMoney(totalOriginalPrice);
              priceOriginalEl.style.display = '';
            } else {
              if (priceOriginalEl) priceOriginalEl.style.display = 'none';
            }
          }
          
          // Show "ƒê√£ √°p d·ª•ng ∆∞u ƒë√£i" text
          const discountText = document.querySelector('.cart-drawer__summary-item .text-right');
          if (discountText && cart.cart_level_discount_applications && cart.cart_level_discount_applications.length > 0) {
            discountText.style.display = '';
          }
        }

        function updateCartPricesAfterRemoval(cart) {
          
          // Update subtotal immediately
          const subtotalElement = document.querySelector('[data-subtotal]');
          if (subtotalElement) {
            subtotalElement.textContent = formatMoney(cart.total_price);
            console.log('Updated subtotal after removal:', formatMoney(cart.total_price));
          }
          
          // Calculate new savings (without cart-level discounts)
          let totalOriginalPrice = 0;
          const cartItems = document.querySelectorAll('#CartDrawer .cart__item');
          const moneyRegex = /[^\d]/g;
          const parsePrice = (el) => el ? (parseInt(el.textContent.replace(moneyRegex, ''), 10) || 0) : 0;
          
          cartItems.forEach(item => {
            const quantity = parseInt(item.dataset.quantity, 10) || 1;
            const originalPriceEl = item.querySelector('.cart-item__price--original');
            const finalPriceEl = item.querySelector('.cart-item__price--final');
            const originalPriceUnit = originalPriceEl ? parsePrice(originalPriceEl) : parsePrice(finalPriceEl);
            totalOriginalPrice += originalPriceUnit * quantity;
          });
          
          const newSavings = totalOriginalPrice - cart.total_price;
          
          // Update savings display
          const savingsDisplay = document.querySelector('[data-savings-display] span');
          if (savingsDisplay) {
            savingsDisplay.textContent = 'B·∫°n ƒë√£ ti·∫øt ki·ªám ƒë∆∞·ª£c ' + formatMoney(newSavings);
          }
          
          // Hide original price if no savings
          const priceContainer = document.querySelector('.cart-drawer__summary-item .price-container');
          if (priceContainer) {
            let priceOriginalEl = priceContainer.querySelector('.price--original');
            if (newSavings > 0) {
              if (!priceOriginalEl) {
                priceOriginalEl = document.createElement('del');
                priceOriginalEl.className = 'price--original';
                priceContainer.insertBefore(priceOriginalEl, subtotalElement);
              }
              priceOriginalEl.textContent = formatMoney(totalOriginalPrice);
              priceOriginalEl.style.display = '';
            } else {
              if (priceOriginalEl) priceOriginalEl.style.display = 'none';
            }
          }
          
          // Hide "ƒê√£ √°p d·ª•ng ∆∞u ƒë√£i" text
          const discountText = document.querySelector('.cart-drawer__summary-item .text-right');
          if (discountText) {
            discountText.style.display = 'none';
          }
          
          // Remove all discount fields
          document.querySelectorAll('.cart-drawer__discount-item').forEach(item => item.remove());
        }

        function formatMoney(amount) {
          if (amount === undefined || amount === null) {
            return '0‚Ç´';
          }
          return amount.toLocaleString('vi-VN') + '‚Ç´';
        }

        function updateDiscountApplications() {
          // This function will be called after cart rebuild to update discount display
          // The discount applications are already rendered in the HTML by Liquid
          // We just need to ensure they're visible and properly styled
          const discountItems = document.querySelectorAll('.cart-drawer__discount-item');
          
          discountItems.forEach(item => {
            item.style.display = '';
          });
        }

        function syncCartUIFromDOM() {
          const countElement = document.querySelector('.drawer__count');
          const cartItems = document.querySelectorAll('#CartDrawer .cart__item');

          // Part 1: Update Count by reading DOM
          const bundleGroups = {};
          let standaloneItemCount = 0;
          let totalStandaloneQty = 0;
          cartItems.forEach(item => {
            const bundleId = item.dataset.bundleId;
            if (bundleId) {
              if (!bundleGroups[bundleId]) bundleGroups[bundleId] = [];
              bundleGroups[bundleId].push(item);
            } else {
              standaloneItemCount++;
              totalStandaloneQty += parseInt(item.dataset.quantity, 10) || 1;
            }
          });

          const bundleCount = Object.keys(bundleGroups).length;
          let countText = '0 s·∫£n ph·∫©m';
          if (cartItems.length > 0) {
            if (bundleCount > 0 && standaloneItemCount === 0) {
              countText = `${bundleCount} b·ªô s·∫£n ph·∫©m`;
            } else if (bundleCount > 0 && standaloneItemCount > 0) {
              countText = `${bundleCount} b·ªô + ${totalStandaloneQty} s·∫£n ph·∫©m`;
            } else if (standaloneItemCount > 0) {
              countText = `${totalStandaloneQty} s·∫£n ph·∫©m`;
            }
          }
          if (countElement) countElement.textContent = countText;

          // Part 2: Update Summary Prices by reading DOM
          let totalOriginalPrice = 0, totalFinalPrice = 0;
          const moneyRegex = /[^\d]/g;
          const parsePrice = (el) => el ? (parseInt(el.textContent.replace(moneyRegex, ''), 10) || 0) : 0;

          // Calculate total from cart items
          cartItems.forEach(item => {
            const quantity = parseInt(item.dataset.quantity, 10) || 1;
            const finalPriceUnit = parsePrice(item.querySelector('.cart-item__price--final'));
            const originalPriceEl = item.querySelector('.cart-item__price--original');
            const originalPriceUnit = originalPriceEl ? parsePrice(originalPriceEl) : finalPriceUnit;
            totalFinalPrice += finalPriceUnit * quantity;
            totalOriginalPrice += originalPriceUnit * quantity;
          });

          // Get voucher discount amount from DOM first
          let voucherDiscountAmount = 0;
          const discountItems = document.querySelectorAll('.cart-drawer__discount-amount');
          discountItems.forEach(discountEl => {
            const discountAmount = parsePrice(discountEl);
            voucherDiscountAmount += discountAmount;
          });

          // Calculate savings from price difference (more reliable)
          const priceDifference = totalOriginalPrice - totalFinalPrice;
          const totalSavings = priceDifference > 0 ? priceDifference : 0;
          const finalPriceAfterVoucher = totalFinalPrice;
          

          const savingsDisplay = document.querySelector('[data-savings-display] span');
          if (savingsDisplay) savingsDisplay.textContent = 'B·∫°n ƒë√£ ti·∫øt ki·ªám ƒë∆∞·ª£c ' + formatMoney(totalSavings);
          
          // Update subtotal with price after voucher discount
          const subtotalElement = document.querySelector('[data-subtotal]');
          if (subtotalElement) {
            subtotalElement.textContent = formatMoney(finalPriceAfterVoucher);
            console.log('Updated subtotal to:', formatMoney(finalPriceAfterVoucher));
          }
          
          const priceContainer = document.querySelector('.cart-drawer__summary-item .price-container');
          if (priceContainer) {
            let priceOriginalEl = priceContainer.querySelector('.price--original');
            if (totalSavings > 0) {
              if (!priceOriginalEl) {
                priceOriginalEl = document.createElement('del');
                priceOriginalEl.className = 'price--original';
                priceContainer.insertBefore(priceOriginalEl, subtotalElement);
              }
              priceOriginalEl.textContent = formatMoney(totalOriginalPrice);
              priceOriginalEl.style.display = '';
            } else {
              if (priceOriginalEl) priceOriginalEl.style.display = 'none';
            }
          }
          
          // Update discount applications display
          updateDiscountApplications();
          
          // Update discount applied text
          const discountText = document.querySelector('.cart-drawer__summary-item .text-right');
          if (discountText) {
            // Check if there are any discount applications by looking for discount-related elements
            const hasDiscount = document.querySelector('[data-discount]') || 
                               document.querySelector('.cart-item__discount') ||
                               document.querySelector('.cart-drawer__discount-item') ||
                               totalSavings > 0;
            discountText.style.display = hasDiscount ? '' : 'none';
          }
          
          // Part 3: Add/Update Bundle Footer
          document.querySelectorAll('.bundle-footer').forEach(f => f.remove());
          document.querySelectorAll('.is-before-footer').forEach(i => i.classList.remove('is-before-footer'));
          Object.keys(bundleGroups).forEach(bundleId => {
            const items = bundleGroups[bundleId];
            if (items.length === 0) return;
            const lastItem = items[items.length - 1];
            lastItem.classList.add('is-before-footer');

            const itemKeys = items.map(item => item.dataset.key);
            const customBundleQty = items[0].dataset.bundleQuantity;
            const currentQuantity = customBundleQty ? parseInt(customBundleQty, 10) : 1;
            const footer = document.createElement('div');
            footer.className = 'bundle-footer';
            const removeBtnHTML = `<button type="button" class="cart-item__remove bundle__remove" data-bundle-keys="${itemKeys.join(',')}" title="X√≥a b·ªô s·∫£n ph·∫©m"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3 6H5H21" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 11V17" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`;
            const qtyWrapperHTML = `<div style="display: flex; align-items: center; gap: 10px; margin-left: auto;"><span>S·ªë l∆∞·ª£ng b·ªô:</span><div class="js-qty__wrapper bundle__qty-wrapper" data-bundle-keys="${itemKeys.join(',')}"><button type="button" class="js-qty__adjust js-qty__adjust--minus">&minus;</button><input type="text" class="js-qty__num" value="${currentQuantity}" min="1" pattern="[0-9]*" readonly><button type="button" class="js-qty__adjust js-qty__adjust--plus">+</button></div></div>`;
            footer.innerHTML = `${removeBtnHTML} ${qtyWrapperHTML}`;
            lastItem.insertAdjacentElement('afterend', footer);
          });
        }

        // Use MutationObserver to detect when cart items are loaded/updated
        const productContainer = document.querySelector('#CartDrawer [data-products]');
        if (productContainer) {
          const observer = new MutationObserver((mutationsList) => {
            for(const mutation of mutationsList) {
              if (mutation.type === 'childList') {
                handleBundleHeaders();
                syncCartUIFromDOM();
                break; 
              }
            }
          });
          observer.observe(productContainer, { childList: true });
        }
        
        // Listen for cart:updated event from bundle add to cart
        document.addEventListener('cart:updated', function() {
          console.log('Cart updated event received, showing bundle headers...');
          setTimeout(() => {
            handleBundleHeaders();
            syncCartUIFromDOM();
          }, 100);
        });
        
        // Also run on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(() => {
            handleBundleHeaders();
            syncCartUIFromDOM();
          }, 500);
        });

        // NOTE: All manual quantity listeners are removed. 
        // The MutationObserver + the master bundle controls handle everything.

        // --- Event Delegation for Clicks ---
        document.addEventListener('click', function(event) {
          const target = event.target;

          // --- BUNDLE CONTROLS (HIGHEST PRIORITY) ---
          const bundleRemoveBtn = target.closest('.bundle__remove');
          if (bundleRemoveBtn) {
              event.preventDefault();
              const keys = bundleRemoveBtn.dataset.bundleKeys.split(',');
              if (keys.length === 0 || keys[0] === '') return;
              const updates = keys.reduce((acc, key) => {
                  if (key) acc[key] = 0;
                  return acc;
              }, {});
              fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ updates: updates })
              }).then(res => res.json()).then(cart => rebuildCart()).catch(e => console.error(e));
              return;
          }
      
          const bundleQtyAdjust = target.closest('.bundle__qty-wrapper .js-qty__adjust');
          if (bundleQtyAdjust) {
              event.stopImmediatePropagation();
              event.preventDefault();
              const wrapper = bundleQtyAdjust.closest('.bundle__qty-wrapper');
              const input = wrapper.querySelector('.js-qty__num');
              const keys = wrapper.dataset.bundleKeys.split(',');
              if (keys.length === 0 || keys[0] === '') return;
              let currentQty = parseInt(input.value);
              let newQty = bundleQtyAdjust.classList.contains('js-qty__adjust--minus') ? Math.max(1, currentQty - 1) : currentQty + 1;
              if (newQty === currentQty) return;
              input.value = newQty;
              const updates = keys.reduce((acc, key) => {
                  if (key) acc[key] = newQty;
                  return acc;
              }, {});
              fetch('/cart/update.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ updates: updates })
              }).then(res => res.json()).then(cart => rebuildCart()).catch(e => console.error(e));
              return;
          }

          // Handle Cross-sell Slider Arrows
          const prevArrow = target.closest('.cart-drawer__cross-sell-arrow--prev');
          const nextArrow = target.closest('.cart-drawer__cross-sell-arrow--next');
          if (prevArrow || nextArrow) {
            const slider = document.querySelector('.cart-drawer__cross-sell-slider');
            if (!slider) return;
            const slideWidth = slider.querySelector('.cart-drawer__cross-sell-item').clientWidth;
            slider.scrollLeft += nextArrow ? slideWidth : -slideWidth;
            return;
          }

          // Handle Voucher Carousel Arrows
          const voucherPrevArrow = target.closest('.cart-drawer__carousel-arrow.prev');
          const voucherNextArrow = target.closest('.cart-drawer__carousel-arrow.next');
          if (voucherPrevArrow || voucherNextArrow) {
            const voucherList = document.querySelector('.cart-drawer__voucher-list');
            if (!voucherList) return;
            
            const voucherItemWidth = voucherList.querySelector('.cart-drawer__voucher-item').clientWidth;
            const currentTransform = voucherList.style.transform || 'translateX(0px)';
            const currentX = parseInt(currentTransform.match(/-?\d+/)[0]) || 0;
            
            if (voucherPrevArrow) {
              const newX = Math.min(0, currentX + voucherItemWidth);
              voucherList.style.transform = `translateX(${newX}px)`;
            } else if (voucherNextArrow) {
              const maxX = -(voucherList.scrollWidth - voucherList.parentElement.clientWidth);
              const newX = Math.max(maxX, currentX - voucherItemWidth);
              voucherList.style.transform = `translateX(${newX}px)`;
            }
            return;
          }

          // Handle Apply Discount Button
          const applyButton = target.closest('.cart-drawer__discount-button');
          if (applyButton) {
            event.preventDefault();
            const form = applyButton.closest('form');
            const discountInput = form.querySelector('input[name="discount"]');
            if (!discountInput.value) {
              alert('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°.');
              return;
            }
            
            const originalButtonText = applyButton.textContent;
            applyButton.textContent = 'ƒêang √°p d·ª•ng...';
            applyButton.disabled = true;

            fetch('/cart/update.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ 'discount': discountInput.value })
            })
            .then(res => res.json())
            .then(cart => {
              console.log('Discount applied, cart response:', cart);
              if (cart.status) {
                alert(cart.description || 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá.');
                discountInput.value = '';
              } else {
                // Success - clear the input and update UI immediately
                discountInput.value = '';
                
                // Ensure voucher persists through checkout
                ensureBundleVoucherPersistence();
                
                // Immediately create discount field with X button
                createDiscountField(cart, discountInput.value);
                
                // Update prices immediately
                updateCartPrices(cart);
              }
              
              // Rebuild cart for full sync
              rebuildCart();
            })
            .catch(e => console.error(e))
            .finally(() => {
              applyButton.textContent = originalButtonText;
              applyButton.disabled = false;
            });
            return;
          }

          // Handle Cross-Sell Add to Cart Button
          const addButton = target.closest('.cross-sell-item__add-btn');
          if (addButton) {
            event.preventDefault();
            const form = addButton.closest('form');
            const submitButton = form.querySelector('.cross-sell-item__add-btn');
            const quantityInput = form.querySelector('.cross-sell-qty__num');
            
            if (!quantityInput || parseInt(quantityInput.value) < 1) {
              alert('Vui l√≤ng ch·ªçn s·ªë l∆∞·ª£ng s·∫£n ph·∫©m.');
              return;
            }
            
            const originalButtonText = submitButton.textContent;
            submitButton.textContent = 'ƒêang th√™m...';
            submitButton.disabled = true;

            // Update the hidden variant input with selected variant
            const variantSelect = form.closest('.cart-drawer__cross-sell-item').querySelector('.cross-sell-item__variant-select');
            if (variantSelect) {
              const hiddenIdInput = form.querySelector('input[name="id"]');
              hiddenIdInput.value = variantSelect.value;
            }

            fetch('{{ routes.cart_add_url }}.js', {
              method: 'POST',
              body: new FormData(form),
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(item => {
              if (item.status) {
                alert(item.description || 'S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng.');
              } else {
                // Reset quantity to 1 after successful add
                quantityInput.value = '1';
              }
              rebuildCart();
            })
            .catch(e => console.error(e))
            .finally(() => {
              submitButton.textContent = originalButtonText;
              submitButton.disabled = false;
            });
            return;
          }

          // Handle Cross-sell Quantity Adjust Buttons
          const qtyAdjust = target.closest('.cross-sell-qty__adjust');
          if (qtyAdjust) {
            event.preventDefault();
            event.stopPropagation();
            const isPlus = qtyAdjust.classList.contains('cross-sell-qty__adjust--plus');
            const quantityInput = qtyAdjust.parentElement.querySelector('.cross-sell-qty__num');
            if (!quantityInput) return;
            
            let currentValue = parseInt(quantityInput.value) || 0;
            if (isPlus) {
              quantityInput.value = currentValue + 1;
            } else {
              quantityInput.value = Math.max(0, currentValue - 1);
            }
            return;
          }

          // Handle Discount Remove Button
          const discountRemoveButton = target.closest('.cart-drawer__discount-remove');
          if (discountRemoveButton) {
            event.preventDefault();
            const discountTitle = discountRemoveButton.dataset.discountTitle;
            
            if (!discountTitle) return;
            
            const originalButtonContent = discountRemoveButton.innerHTML;
            discountRemoveButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="1.5"/><path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            discountRemoveButton.disabled = true;
            
            // Immediately hide the discount item for better UX
            const discountItem = discountRemoveButton.closest('.cart-drawer__discount-item');
            if (discountItem) {
              discountItem.style.display = 'none';
            }
            
            // Remove discount by setting it to empty string
            fetch('/cart/update.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ 'discount': '' })
            })
            .then(response => response.json())
            .then(cart => {
              console.log('Discount removed, cart response:', cart);
              
              // Immediately update prices and remove discount field
              updateCartPricesAfterRemoval(cart);
              
              // Rebuild cart for full sync
              rebuildCart();
            })
            .catch(error => {
              console.error('Error removing discount:', error);
              // Restore the button and show discount item again
              discountRemoveButton.innerHTML = originalButtonContent;
              discountRemoveButton.disabled = false;
              if (discountItem) {
                discountItem.style.display = '';
              }
            });
            return;
          }

          // Handle Voucher Copy Button
          const copyButton = target.closest('.voucher-copy-button');
          if (copyButton) {
            event.preventDefault();
            const codeToCopy = copyButton.dataset.copyCode;
            
            navigator.clipboard.writeText(codeToCopy).then(() => {
              const originalText = copyButton.textContent;
              copyButton.textContent = 'ƒê√£ ch√©p!';
              copyButton.classList.add('copied');
              copyButton.disabled = true;
              setTimeout(() => {
                copyButton.textContent = originalText;
                copyButton.classList.remove('copied');
                copyButton.disabled = false;
              }, 2000);
            }).catch(err => {
              console.error('Kh√¥ng th·ªÉ sao ch√©p: ', err);
              alert('Kh√¥ng th·ªÉ sao ch√©p m√£.');
            });
            return;
          }

          // Handle Cart Item Remove Button
          const removeButton = target.closest('.cart-item__remove');
          if (removeButton) {
            event.preventDefault();
            const itemId = removeButton.dataset.id;
            
            if (!itemId) return;
            
            const originalButtonContent = removeButton.innerHTML;
            removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#25282B" stroke-width="1.5"/><path d="M9 12l2 2 4-4" stroke="#25282B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            removeButton.disabled = true;
            
            fetch('/cart/change.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ id: itemId, quantity: 0 })
            })
            .then(response => response.json())
            .then(cart => {
              rebuildCart();
            })
            .catch(error => {
              console.error('Error removing item:', error);
              removeButton.innerHTML = originalButtonContent;
              removeButton.disabled = false;
            });
            return;
          }
        });

        // --- Event Delegation for Form Submissions ---
        document.addEventListener('submit', function(event) {
          // ... (existing submit handler)
        });
        
        // --- Event Delegation for Select Focus/Blur to toggle arrow direction ---
        document.addEventListener('focusin', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                event.target.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 11.25L9 6.75L13.5 11.25' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            }
        });

        document.addEventListener('focusout', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                event.target.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18' fill='none'%3E%3Cpath d='M4.5 6.75L9 11.25L13.5 6.75' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E")`;
            }
        });

        // Handle variant select change
        document.addEventListener('change', function(event) {
            if (event.target.matches('.cross-sell-item__variant-select')) {
                const select = event.target;
                const crossSellItem = select.closest('.cart-drawer__cross-sell-item');
                const form = crossSellItem.querySelector('.cross-sell-item__form');
                const hiddenIdInput = form.querySelector('input[name="id"]');
                
                // Update the hidden variant input
                hiddenIdInput.value = select.value;
                
                // Update price display if needed
                // This would require fetching variant data from Shopify
                // For now, we'll just update the variant ID
            }
        });
        
        // Listen for drawer open events
        document.addEventListener('click', function(event) {
          // Check if cart drawer should be opened
          if (event.target.closest('[data-cart-drawer-toggle]') || 
              event.target.closest('.cart-link') ||
              event.target.closest('[href*="cart"]')) {
            setTimeout(() => {
              ensureDrawerVisible();
              // Check for stored vouchers when drawer opens
              setTimeout(() => checkStoredBundleVoucher(), 500);
            }, 100);
          }
          
          // Check if cart drawer should be closed
          if (event.target.closest('.js-drawer-close') || 
              event.target.closest('[data-cart-drawer-close]')) {
            setTimeout(showStickyAddToCart, 100);
          }
        });
        
        // Also ensure drawer is visible on page load if it should be open
        if (document.getElementById('CartDrawer').classList.contains('drawer--is-open')) {
          ensureDrawerVisible();
        }
        
        // Update cart count on initial page load
        document.addEventListener('DOMContentLoaded', function() {
          syncCartUIFromDOM();
        });

        // Backup function to ensure voucher is applied before checkout
        function ensureVoucherBeforeCheckout() {
          console.log('=== ENSURE VOUCHER BEFORE CHECKOUT ===');
          
          fetch('/cart.js')
            .then(response => response.json())
            .then(cartData => {
              const hasDiscount = cartData.cart_level_discount_applications && 
                                 cartData.cart_level_discount_applications.length > 0;
              
              if (!hasDiscount) {
                // Find bundle voucher
                let bundleVoucher = null;
                for (const item of cartData.items) {
                  if (item.properties && item.properties._bundle_voucher) {
                    bundleVoucher = item.properties._bundle_voucher;
                    break;
                  }
                }
                
                if (bundleVoucher) {
                  console.log('Last-minute voucher application:', bundleVoucher);
                  fetch('/cart/update.js', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 'discount': bundleVoucher })
                  });
                }
              }
            })
            .catch(error => {
              console.error('Error in backup voucher check:', error);
            });
        }

        // Override the checkout button to ensure voucher is applied
        document.addEventListener('click', function(event) {
          if (event.target.closest('button[name="checkout"]') || 
              event.target.closest('.btn--online')) {
            
            // Small delay to ensure voucher is applied
            setTimeout(() => {
              ensureVoucherBeforeCheckout();
            }, 100);
          }
        });
      })();
    </script>

  </div>
{%- endif -%}
