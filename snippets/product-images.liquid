{% comment %}
  Parameters
  context - used to determine whether on the featured product or main product template
  sizes
  sizeVariable
  fallback
  mobile_layout
{% endcomment %}

<style>
  .overlay-image {
     display: none;
   }

   @media screen and (min-width: 95rem) {
     .overlay-image {
       z-index: 2;
       background-color: #00000080;
       color: #fff;
       font-size: calc(var(--typeHeaderSize)* calc(4 / 3));
       font-weight: bold;
       cursor: pointer;
       display: flex;
       border-radius: calc(var(--radiusBase)* .75);
     }

    .product__thumb-item--hide {
      display: none !important;
    }

    .product__thumbs--scroller.show-all-image .product__thumb-item--hide {
      display: block !important;
    }

    .product__thumbs--scroller.show-all-image .overlay-image {
      display: none;
    }

    /* Hide images from 6th onwards initially (show first 5 images) */
    .product__thumbs--scroller .product__thumb-item:nth-child(n+6) {
      display: none !important;
    }

    .product__thumbs--scroller.show-all-image .product__thumb-item:nth-child(n+6) {
      display: block !important;
    }
    
    /* Alternative selector for better compatibility */
    .product__thumbs--scroller.show-all-image .product__thumb-item {
      display: block !important;
    }

    /* Carousel mode: Show 5 thumbnails at a time, scrollable horizontally */
    .huan-false.product__thumbs--scroller {
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: nowrap !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      -webkit-overflow-scrolling: touch !important;
      /* Limit container width to show only 5 thumbnails at a time */
      /* 15rem per thumbnail * 5 + 12px gap * 4 = 75rem + 48px */
      max-width: calc(75rem + 48px) !important;
      width: 100% !important;
    }

    /* Override hide rule to show all thumbnails for scrolling */
    .huan-false.product__thumbs--scroller .product__thumb-item:nth-child(n+6) {
      display: block !important;
    }

    /* Ensure all thumbnails are visible for scrolling - fixed width */
    .huan-false.product__thumbs--scroller .product__thumb-item {
      flex-shrink: 0 !important;
      width: 15rem !important;
    }

    /* Show more button styling */
    .show-more-gallery-btn {
      display: flex;
      width: 237px;
      height: 55px;
      padding: 4px 0;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-shrink: 0;
      border-radius: 30px;
      border: 1px solid #1C2C58;
      background: #FFF;
      margin: 20px auto 0;
      cursor: pointer;
      font-family: 'Be Vietnam Pro', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: #1C2C58;
      transition: all 0.3s ease;
    }
    
    .show-more-gallery-btn:hover {
      background: #F5F9FF !important;
      border-color: #234085 !important;
    }
    
    /* Hide show more button when all images are shown */
    .product__thumbs--scroller.show-all-image ~ .show-more-gallery-btn {
      display: none !important;
    }
   }

   /* Hide show more button on mobile */
   @media (max-width: 768px) {
     .show-more-gallery-btn {
       display: none !important;
     }
   }

   .product__zoom-wrapper {
     position: absolute;
     top: 15px;
     right: 15px;
     z-index: 1;
     width: 32px;
     height: 32px;
     background: rgba(255,255,255,0.7);
     border-radius: 50%;
     display: flex;
     align-items: center;
     justify-content: center;
     pointer-events: none; /* Allows click-through to the image for zoom */
   }
   .product__zoom-icon {
     width: 20px;
     height: 20px;
   }

   .product__photo-zoom {
     position: absolute;
     top: 15px;
     right: 15px;
     z-index: 2;
     width: 40px;
     height: 40px;
     background-color: rgba(255,255,255,0.8) !important;
     border-radius: 50%;
     display: flex;
     align-items: center;
     justify-content: center;
   }
   .product__photo-zoom .icon-search {
     width: 20px;
     height: 20px;
     stroke: black;
   }
</style>

{%- liquid
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
  assign first_3d_model = product.media | where: 'media_type', 'model' | first
  assign limit_product_carousel = section.settings.limit_product_carousel

  # Product images and thumbnails on the main product template should load early
  if context == 'main-product'
    assign loading = 'eager'
  endif

  assign handle_metafields = product.metafields.custom.product_bundle
-%}

{%- unless product.empty? -%}
  <div
    class="product-column-content"
    data-product-images
    data-zoom="{{ product_zoom_enable }}"
    data-has-slideshow="{% if product.media.size > 1 %}true{% else %}false{% endif %}"
  >
    <div class="product__photos{% if product_carousel_enable == false %} product__photos--stack{% endif %} product__photos-{{ section_id }} product__photos--{{ thumbnail_position }}">
      <div class="product-tags-wrapper">
        {%- for block in blocks -%}
          {%- if block.type == 'tag' -%}
            <div class="product-tag-item" style="background-color: {{ block.settings.bg_color }}; color: {{ block.settings.text_color }};">
              {{ block.settings.tag_text }}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
      <div class="product__main-photos" data-aos data-product-single-media-group>
        <div
          data-product-photos
          data-zoom="{{ product_zoom_enable }}"
          class="product-slideshow"
          id="ProductPhotos-{{ section_id }}"
        >
          {%- if check_block_combo -%}
            {%- render 'media',
              section_id: section_id,
              media: product.media[0],
              featured_media: featured_media,
              loopIndex0: 0,
              loopIndex: 0,
              product_zoom_enable: product_zoom_enable,
              product_zoom_size: product_zoom_size,
              product_image_size: product_image_size,
              isModal: isModal,
              video_looping: video_looping,
              video_style: video_style,
              sizes: sizes,
              sizeVariable: sizeVariable,
              fallback: fallback,
              loading: loading,
              mobile_layout: mobile_layout
            -%}
            {%- for bundle in handle_metafields.value -%}
              {%-
                render 'media',
                section_id: section_id,
                media: bundle.media[0],
                featured_media: featured_media,
                loopIndex0: forloop.index0 | plus: 1,
                loopIndex: forloop.index | plus: 1,
                product_zoom_enable: product_zoom_enable,
                product_zoom_size: product_zoom_size,
                product_image_size: product_image_size,
                isModal: isModal,
                video_looping: video_looping,
                video_style: video_style,
                sizes: sizes,
                sizeVariable: sizeVariable,
                fallback: fallback,
                loading: loading,
                mobile_layout: mobile_layout
              -%}
            {%- endfor -%}

          {%- else -%}
            {%- for media in product.media -%}
              {%- render 'media',
                section_id: section_id,
                media: media,
                featured_media: featured_media,
                loopIndex0: forloop.index0,
                loopIndex: forloop.index,
                product_zoom_enable: product_zoom_enable,
                product_zoom_size: product_zoom_size,
                product_image_size: product_image_size,
                isModal: isModal,
                video_looping: video_looping,
                video_style: video_style,
                sizes: sizes,
                sizeVariable: sizeVariable,
                fallback: fallback,
                loading: loading,
                mobile_layout: mobile_layout
              -%}
            {%- endfor -%}
          {%- endif -%}
        </div>

        {%- if first_3d_model -%}
          <button
            aria-label="{{ 'products.product.view_in_space_label' | t }}"
            class="product-single__view-in-space"
            data-shopify-xr
            data-shopify-model3d-id="{{ first_3d_model.id }}"
            data-shopify-title="{{ product.title }}"
            data-shopify-xr-hidden
          >
            <svg
              aria-hidden="true"
              focusable="false"
              role="presentation"
              class="icon icon-3d"
              viewBox="18.24 17.35 24.52 28.3"
            >
              <path fill="#3A3A3A" d="m30.5 17.35-12.26 7.07v14.16l12.26 7.07 12.26-7.08V24.42L30.5 17.35zM20.24 37.42V25.58l10.26-5.93 10.13 5.85-10.13 5.88v12l-10.26-5.96z"/>
            </svg>
            <span class="product-single__view-in-space-text">
              {{ 'products.product.view_in_space' | t }}
            </span>
          </button>
        {%- endif -%}
      </div>

        <div
          data-product-thumbs
          class="product__thumbs product__thumbs--{{ thumbnail_position }}{% unless check_block_combo %}{% if product.media.size == 1 %} medium-up--hide{% endif %}{% endunless %}"
          data-position="{{ thumbnail_position }}"
          {% if thumbnail_position == 'below' %}
            data-position-tablet="beside"
          {% endif %}
          data-arrows="{{ thumbnail_arrows }}"
        >
        {%- if thumbnail_arrows -%}
          <button type="button" class="product__thumb-arrow product__thumb-arrow--prev hide">
            <svg
              aria-hidden="true"
              focusable="false"
              role="presentation"
              class="icon icon-chevron-left"
              viewBox="0 0 284.49 498.98"
            >
              <path d="M249.49 0a35 35 0 0 1 24.75 59.75L84.49 249.49l189.75 189.74a35.002 35.002 0 1 1-49.5 49.5L10.25 274.24a35 35 0 0 1 0-49.5L224.74 10.25A34.89 34.89 0 0 1 249.49 0Z"/>
            </svg>
          </button>
        {%- endif -%}

        <div class="{% if product_carousel_enable %}huan-{{ section.settings.limit_product_carousel }}{% endif %} product__thumbs--scroller">
          {%- if check_block_combo -%}
            {%- liquid
              assign image_set = false
              assign image_set_group = ''
              if product.media[0].alt contains '#'
                assign image_set_full = product.media[0].alt | split: '#' | last
                if image_set_full contains '_'
                  assign image_set = true
                  assign image_set_group = image_set_full | split: '_' | first
                endif
              endif
            -%}
            <div
              class="product__thumb-item{% if product_carousel_enable == false %} large-up--hide{% endif %}"
              data-index="0"
              {% if image_set %}
                data-set-name="{{image_set_group}}"
                data-group="{{image_set_full}}"
              {% endif %}
            >
              <a
                href="{{ product.media[0].preview_image | img_url: product_zoom_size }}"
                data-product-thumb
                class="product__thumb photoswipe__image"
                data-index="0"
                data-id="{{ product.media[0].id }}"
                data-zoom="true"
              >
                <div
                  class="image-wrap image-wrap__thumbnail"
                  style="height: 0; padding-bottom: {{ 100 | divided_by: product.media[0].preview_image.aspect_ratio }}%;"
                >
                  {%- if product.media[0].media_type == 'video' or product.media[0].media_type == 'external_video' -%}
                    <span class="product__thumb-icon">
                      <svg
                        aria-hidden="true"
                        focusable="false"
                        role="presentation"
                        class="icon icon-play"
                        viewBox="18.24 17.35 24.52 28.3"
                      >
                        <path fill="#323232" d="M22.1 19.151v25.5l20.4-13.489-20.4-12.011z"/>
                      </svg>
                    </span>
                  {%- endif -%}
                  {%- if product.media[0].media_type == 'model' -%}
                    <span class="product__thumb-icon">
                      <svg
                        aria-hidden="true"
                        focusable="false"
                        role="presentation"
                        class="icon icon-3d"
                        viewBox="18.24 17.35 24.52 28.3"
                      >
                        <path fill="#3A3A3A" d="m30.5 17.35-12.26 7.07v14.16l12.26 7.07 12.26-7.08V24.42L30.5 17.35zM20.24 37.42V25.58l10.26-5.93 10.13 5.85-10.13 5.88v12l-10.26-5.96z"/>
                      </svg>
                    </span>
                  {%- endif -%}

                  {%- capture image_classes -%}
                  appear-delay-{{ 0 | times: 3 }}
                {%- endcapture -%}
                  {%-
                    render 'image-element',
                    img: product.media[0].preview_image,
                    alt: product.media[0].alt | escape | split: '#' | first,
                    widths: '540, 720',
                    sizeVariable: '80px',
                    loading: loading,
                  -%}
                </div>
              </a>
            </div>
            {%- for bundle in handle_metafields.value -%}
              {%- liquid
                assign image_set = false
                assign image_set_group = ''
                if bundle.media[0].alt contains '#'
                  assign image_set_full = bundle.media[0].alt | split: '#' | last
                  if image_set_full contains '_'
                    assign image_set = true
                    assign image_set_group = image_set_full | split: '_' | first
                  endif
                endif
              -%}
              <div
                class="product__thumb-item"
                data-index="{{ forloop.index0 | plus: 1 }}"
                {% if image_set %}
                  data-set-name="{{image_set_group}}"
                  data-group="{{image_set_full}}"
                {% endif %}
              >
                <a
                  href="{{ bundle.media[0].preview_image | img_url: product_zoom_size }}"
                  data-product-thumb
                  class="product__thumb photoswipe__image"
                  data-index="{{ forloop.index0 | plus: 1 }}"
                  data-id="{{ bundle.media[0].id }}"
                  data-zoom="true"
                >
                  <div
                    class="image-wrap image-wrap__thumbnail"
                    style="height: 0; padding-bottom: {{ 100 | divided_by: bundle.media[0].preview_image.aspect_ratio }}%;"
                  >
                    {%- if bundle.media[0].media_type == 'video' or bundle.media[0].media_type == 'external_video' -%}
                      <span class="product__thumb-icon">
                        <svg
                          aria-hidden="true"
                          focusable="false"
                          role="presentation"
                          class="icon icon-play"
                          viewBox="18.24 17.35 24.52 28.3"
                        >
                          <path fill="#323232" d="M22.1 19.151v25.5l20.4-13.489-20.4-12.011z"/>
                        </svg>
                      </span>
                    {%- endif -%}
                    {%- if bundle.media[0].media_type == 'model' -%}
                      <span class="product__thumb-icon">
                        <svg
                          aria-hidden="true"
                          focusable="false"
                          role="presentation"
                          class="icon icon-3d"
                          viewBox="18.24 17.35 24.52 28.3"
                        >
                          <path fill="#3A3A3A" d="m30.5 17.35-12.26 7.07v14.16l12.26 7.07 12.26-7.08V24.42L30.5 17.35zM20.24 37.42V25.58l10.26-5.93 10.13 5.85-10.13 5.88v12l-10.26-5.96z"/>
                        </svg>
                      </span>
                    {%- endif -%}

                    {%- capture image_classes -%}
                    appear-delay-{{ forloop.index | plus: 1 | times: 3 }}
                  {%- endcapture -%}
                    {%-
                      render 'image-element',
                      img: bundle.media[0].preview_image,
                      alt: bundle.media[0].alt | escape | split: '#' | first,
                      widths: '540, 720',
                      sizeVariable: '80px',
                      loading: loading,
                    -%}
                  </div>
                </a>
              </div>
            {%- endfor -%}

          {%- else -%}
            {%- if product.media.size > 1 -%}
              {%- for media in product.media -%}
                {%- liquid
                  assign image_set = false
                  assign image_set_group = ''
                  if media.alt contains '#'
                    assign image_set_full = media.alt | split: '#' | last
                    if image_set_full contains '_'
                      assign image_set = true
                      assign image_set_group = image_set_full | split: '_' | first
                    endif
                  endif

                  assign item_count = forloop.index
                  assign has_hide_thumb = false
                  if limit_product_carousel == true
                    if item_count > 5
                      assign has_hide_thumb = true
                      assign hide_item_class = 'product__thumb-item--hide'
                    endif
                  endif
                -%}
                <div
                  class="product__thumb-item {% if limit_product_carousel == true %} relative {% endif %} {{ hide_item_class }} {% if product_carousel_enable == false and forloop.first %} large-up--hide{% endif %}"
                  data-index="{{ forloop.index0 }}"
                  {% if image_set %}
                    data-set-name="{{image_set_group}}"
                    data-group="{{image_set_full}}"
                  {% endif %}
                >
                  <a
                    href="{{ media.preview_image | img_url: product_zoom_size }}"
                    data-product-thumb
                    class="product__thumb photoswipe__image"
                    data-index="{{ forloop.index0 }}"
                    data-id="{{ media.id }}"
                    data-zoom="true"
                  >
                    <div
                      class="image-wrap image-wrap__thumbnail"
                      style="height: 0; padding-bottom: {{ 100 | divided_by: media.preview_image.aspect_ratio }}%;"
                    >
                      {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
                        <span class="product__thumb-icon">
                          <svg
                            aria-hidden="true"
                            focusable="false"
                            role="presentation"
                            class="icon icon-play"
                            viewBox="18.24 17.35 24.52 28.3"
                          >
                            <path fill="#323232" d="M22.1 19.151v25.5l20.4-13.489-20.4-12.011z"/>
                          </svg>
                        </span>
                      {%- endif -%}
                      {%- if media.media_type == 'model' -%}
                        <span class="product__thumb-icon">
                          <svg
                            aria-hidden="true"
                            focusable="false"
                            role="presentation"
                            class="icon icon-3d"
                            viewBox="18.24 17.35 24.52 28.3"
                          >
                            <path fill="#3A3A3A" d="m30.5 17.35-12.26 7.07v14.16l12.26 7.07 12.26-7.08V24.42L30.5 17.35zM20.24 37.42V25.58l10.26-5.93 10.13 5.85-10.13 5.88v12l-10.26-5.96z"/>
                          </svg>
                        </span>
                      {%- endif -%}

                      {%- capture image_classes -%}
                        appear-delay-{{ forloop.index | times: 3 }}
                      {%- endcapture -%}
                      {%-
                        render 'image-element',
                        img: media.preview_image,
                        alt: media.alt | escape | split: '#' | first,
                        widths: '540, 720',
                        sizeVariable: '80px',
                        loading: loading,
                      -%}
                    </div>
                  </a>
                  {% if limit_product_carousel == true %}
                    {%- if forloop.index == 5 -%}
                      <overlay-image class="overlay-image block absolute top-0 left-0 w-full h-full flex ai-center jc-center">
                        +{{ product.media.size | minus: 5 }}
                      </overlay-image>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {%- endfor -%}
            {%- endif -%}
          {%- endif -%}
        </div>

        {%- if thumbnail_arrows -%}
          <button type="button" class="product__thumb-arrow product__thumb-arrow--next">
            <svg
              aria-hidden="true"
              focusable="false"
              role="presentation"
              class="icon icon-chevron-right"
              viewBox="0 0 284.49 498.98"
            >
              <title>icon-chevron</title><path d="M35 498.98a35 35 0 0 1-24.75-59.75l189.74-189.74L10.25 59.75a35.002 35.002 0 0 1 49.5-49.5l214.49 214.49a35 35 0 0 1 0 49.5L59.75 488.73A34.89 34.89 0 0 1 35 498.98Z"/>
            </svg>
          </button>
        {%- endif -%}
      </div>
      
      <!-- Show More Button for Desktop - Hide if carousel is enabled -->
      {%- if product.media.size > 5 and thumbnail_position == 'below' and product_carousel_enable == false -%}
        <div class="show-more-gallery-btn">
          <span class="show-more-text">Xem thêm</span>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M5 7.5L10 12.5L15 7.5" stroke="#1C2C58" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      {%- endif -%}
    </div>
  </div>

  {% if thumbnail_height == 'fixed' %}
    {% style %}
      .product__photos-{{ section_id }} .product__thumbs:not(.product__thumbs--below) {
        min-height: 400px;
        max-height: 400px;
      }

      @media screen and (max-width: 798px) {
        .product__photos-{{ section_id }} .product__thumbs:not(.product__thumbs--below) {
          min-height: 300px;
          max-height: 300px;
        }
      }
    {% endstyle %}
  {% endif %}

  <script type="application/json" id="ModelJson-{{ section_id }}">
    {{ product.media | where: 'media_type', 'model' | json }}
  </script>
{%- else -%}
  <div class="product__photos product__photos-{{ section_id }}">
    <div class="product__main-photos" style="width: 100%">
      <div data-product-photos class="{% if product_carousel_enable == false %} prevent-slider{% endif %}">
        <div class="product-main-slide" data-index="{{ forloop.index0 }}">
          <a href="#">
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          </a>
        </div>
      </div>
    </div>
  </div>
{%- endunless -%}

<style>
  .product__photos {
    position: relative;
  }
  .product-tags-wrapper {
    position: absolute;
    top: 15px;
    left: 15px;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
  }
  .product-tag-item {
    display: flex;
    height: 31px;
    padding: 3.5px 12px 4.5px 12px;
    justify-content: center;
    align-items: center;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 400;
    line-height: 1;
    color: white;
  }
  
  /* Thumbnail zoom styles */
  .product__thumb-item a[data-zoom="true"] {
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .product__thumb-item a[data-zoom="true"]:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  
  .product__thumb-item a[data-zoom="true"]:hover .image-wrap__thumbnail {
    border-radius: 8px;
    overflow: hidden;
  }
  
  /* Zoom modal styles */
  .product-thumb-zoom-modal {
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .product-thumb-zoom-modal img {
    animation: zoomIn 0.3s ease;
  }
  
  @keyframes zoomIn {
    from { 
      transform: scale(0.8);
      opacity: 0;
    }
    to { 
      transform: scale(1);
      opacity: 1;
    }
  }
  
  /* Zoom modal navigation buttons */
  .zoom-modal-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10001;
    transition: background 0.2s;
    color: white;
  }
  
  .zoom-modal-nav-btn:hover {
    background: rgba(0, 0, 0, 0.7);
  }
  
  .zoom-modal-nav-btn.prev {
    left: 20px;
  }
  
  .zoom-modal-nav-btn.next {
    right: 20px;
  }
  
  .zoom-modal-nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .zoom-modal-nav-btn svg {
    width: 24px;
    height: 24px;
  }
  
  @media (max-width: 768px) {
    .zoom-modal-nav-btn {
      width: 40px;
      height: 40px;
    }
    
    .zoom-modal-nav-btn.prev {
      left: 10px;
    }
    
    .zoom-modal-nav-btn.next {
      right: 10px;
    }
    
    .zoom-modal-nav-btn svg {
      width: 20px;
      height: 20px;
    }
  }
</style>

{%- if product_carousel_enable == false -%}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const productImagesContainer = document.querySelector('#ProductPhotos-{{ section_id }}').closest('[data-product-images]');
    if (productImagesContainer && typeof theme.Photoswipe !== 'undefined') {
      new theme.Photoswipe(productImagesContainer, '{{ section_id }}');
    }
  });
</script>
{%- endif -%}

<script>
  class OverlayImage extends HTMLElement {
    constructor() {
      super();

      if(window.innerWidth >= 960) {
        this.addEventListener('click', ()=> {
          this.closest('.product__thumbs--scroller').classList.add('show-all-image');
          const parent = this.closest('.product__thumbs--scroller');
          if (parent) {
              const children = parent.querySelectorAll('.product__thumb-item');
              children.forEach(child => {
              child.classList.remove('relative');
              });
              
              // Re-initialize thumbnail zoom for newly visible items
              setTimeout(() => {
                console.log('Re-initializing zoom after overlay click');
                initThumbnailZoom();
              }, 200);
        }
        })
      }
    }
  }
  customElements.define('overlay-image', OverlayImage);

  // Show More Gallery Button Handler
  function initShowMoreButton() {
    console.log('Initializing show more button...');
    
    const showMoreBtns = document.querySelectorAll('.show-more-gallery-btn');
    console.log('Found buttons:', showMoreBtns.length);
    
    showMoreBtns.forEach((btn, index) => {
      console.log('Setting up button', index, btn);
      
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('Button clicked!', this);
        
        const scroller = this.previousElementSibling;
        console.log('Scroller found:', scroller);
        
        if (scroller && scroller.classList.contains('product__thumbs--scroller')) {
          // Remove the hiding class and force show all images
          scroller.classList.add('show-all-image');
          console.log('Expanded gallery - showing all images');
          
          // Remove any hiding styles from all thumb items
          const allThumbItems = scroller.querySelectorAll('.product__thumb-item');
          console.log('All thumb items found:', allThumbItems.length);
          
          allThumbItems.forEach((item, index) => {
            // Remove any inline display:none styles
            item.style.display = '';
            // Remove any hiding classes
            item.classList.remove('product__thumb-item--hide');
            console.log('Cleared hiding styles for item', index + 1, item);
          });
          
          // Re-initialize thumbnail zoom for newly visible items
          setTimeout(() => {
            console.log('Re-initializing zoom for expanded gallery');
            initThumbnailZoom();
          }, 200);
          
          // Hide the show more button
          this.style.display = 'none';
          console.log('Hidden show more button');
        }
      });
    });
  }
  
  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', initShowMoreButton);
  
  // Re-initialize on section load
  document.addEventListener('shopify:section:load', function() {
    setTimeout(initShowMoreButton, 100);
  });
</script>

<script>
document.addEventListener('shopify:section:load', function() {
  initMobileThumbZoom('{{ section_id }}');
  initThumbnailZoom(); // Re-initialize thumbnail zoom
  
  // Re-initialize show more button after section load
  setTimeout(function() {
    console.log('Re-initializing show more button after section load');
  }, 100);
});
document.addEventListener('DOMContentLoaded', function() {
  initMobileThumbZoom('{{ section_id }}');
});

// Simple show more button handler - placed at the end to ensure it runs
setTimeout(function() {
  console.log('=== INITIALIZING SHOW MORE BUTTON ===');
  
  const showMoreBtns = document.querySelectorAll('.show-more-gallery-btn');
  console.log('Found show more buttons:', showMoreBtns.length);
  
  showMoreBtns.forEach((btn, index) => {
    console.log('Setting up button', index);
    
    // Remove any existing event listeners
    btn.onclick = null;
    
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('=== BUTTON CLICKED ===');
      console.log('Button element:', this);
      
      const scroller = this.previousElementSibling;
      console.log('Scroller element:', scroller);
      
      if (scroller) {
        console.log('Scroller classes:', scroller.className);
        
        // Add show-all-image class to scroller to trigger CSS
        const scrollerInner = scroller.querySelector('.product__thumbs--scroller');
        if (scrollerInner) {
          scrollerInner.classList.add('show-all-image');
          console.log('Added show-all-image class to scroller');
        }
        
        // Find all thumb items
        const thumbItems = scroller.querySelectorAll('.product__thumb-item');
        console.log('Total thumb items found:', thumbItems.length);
        
        // Show all thumb items
        thumbItems.forEach((item, i) => {
          console.log('Processing item', i + 1, item);
          
          // Only process items from 6th onwards (index 5+)
          if (i >= 5) {
            console.log('Showing hidden item', i + 1);
            console.log('Item before - display:', window.getComputedStyle(item).display);
            console.log('Item before - visibility:', window.getComputedStyle(item).visibility);
            console.log('Item before - opacity:', window.getComputedStyle(item).opacity);
            
            // Only remove display: none, keep all other properties unchanged
            item.style.removeProperty('display');
            item.style.removeProperty('visibility');
            item.style.removeProperty('opacity');
            
            // Remove any hiding classes
            item.classList.remove('product__thumb-item--hide');
            item.classList.remove('hide');
            item.classList.remove('hidden');
            
            console.log('Item after - display:', window.getComputedStyle(item).display);
            console.log('Item after - visibility:', window.getComputedStyle(item).visibility);
            console.log('Item after - opacity:', window.getComputedStyle(item).opacity);
          }
          // Items 1-5: Do nothing, keep original layout
        });
        
        // Hide the button
        this.style.display = 'none';
        console.log('Button hidden');
        
        console.log('=== EXPANSION COMPLETE ===');
      }
    });
    
    console.log('Button', index, 'setup complete');
  });
  
  console.log('=== SHOW MORE INITIALIZATION COMPLETE ===');
}, 1000);

// Thumbnail zoom functionality
document.addEventListener('DOMContentLoaded', function() {
  initThumbnailZoom();
  
  // Debug: Check for thumbnails
  setTimeout(() => {
    const allThumbItems = document.querySelectorAll('.product__thumb-item');
    const allThumbLinks = document.querySelectorAll('.product__thumb-item a');
    console.log('=== THUMBNAIL DEBUG ===');
    console.log('Total thumbnail items found:', allThumbItems.length);
    console.log('Total thumbnail links found:', allThumbLinks.length);
    
    allThumbItems.forEach((item, index) => {
      const link = item.querySelector('a');
      console.log(`Thumbnail Item ${index + 1}:`, {
        itemClasses: item.className,
        itemDataIndex: item.getAttribute('data-index'),
        hasLink: !!link,
        linkHref: link?.href,
        linkClasses: link?.className,
        hasDataZoom: link?.hasAttribute('data-zoom'),
        dataZoom: link?.getAttribute('data-zoom'),
        linkDataIndex: link?.getAttribute('data-index')
      });
    });
    console.log('=== END THUMBNAIL DEBUG ===');
  }, 1000);
  
  // Preload images for faster zoom (with delay to not block initial page load)
  setTimeout(() => {
    preloadThumbnailImages();
  }, 2000);
  
  // Use event delegation for better reliability
  document.addEventListener('click', function(e) {
    console.log('Click detected on:', e.target);
    console.log('Click target classes:', e.target.className);
    console.log('Click target tag:', e.target.tagName);
    
    // Check if click is on thumbnail item or inside it
    const thumbItem = e.target.closest('.product__thumb-item');
    if (thumbItem) {
      console.log('Thumbnail item clicked:', thumbItem);
      
      // Look for link inside the thumbnail item
      const thumbLink = thumbItem.querySelector('a[data-zoom="true"]') || thumbItem.querySelector('a');
      
      if (thumbLink) {
        console.log('Thumb link found inside item:', thumbLink);
        e.preventDefault();
        e.stopPropagation();
        
        const imageUrl = thumbLink.href;
        const imageAlt = thumbLink.querySelector('img')?.alt || '';
        const imageIndex = thumbLink.dataset.index || thumbItem.dataset.index || '0';
        
        console.log('Thumbnail click processed:', { imageUrl, imageAlt, imageIndex });
        createZoomModal(imageUrl, imageAlt, imageIndex);
      } else {
        console.log('No link found inside thumbnail item');
      }
    }
  });
});

function initThumbnailZoom() {
  // Function to setup zoom for thumbnails
  function setupThumbnailZoom() {
    const thumbItems = document.querySelectorAll('.product__thumb-item a[data-zoom="true"]');
    
    thumbItems.forEach((thumbLink, index) => {
      // Remove existing event listeners to prevent duplicates
      thumbLink.removeEventListener('click', handleThumbnailClick);
      thumbLink.addEventListener('click', handleThumbnailClick);
    });
  }
  
  // Handle thumbnail click
  function handleThumbnailClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Get the image data
    const imageUrl = this.href;
    const imageAlt = this.querySelector('img')?.alt || '';
    const imageIndex = this.dataset.index;
    
    console.log('Thumbnail clicked:', { imageUrl, imageAlt, imageIndex });
    
    // Create zoom modal
    createZoomModal(imageUrl, imageAlt, imageIndex);
  }
  
  // Initial setup
  setupThumbnailZoom();
  
  // Re-setup when show-all-image class is added
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const target = mutation.target;
        if (target.classList.contains('show-all-image')) {
          console.log('Show-all-image detected, re-setting up zoom');
          setTimeout(setupThumbnailZoom, 100);
        }
      }
    });
  });
  
  // Observe the scroller element
  const scroller = document.querySelector('.product__thumbs--scroller');
  if (scroller) {
    observer.observe(scroller, { attributes: true, attributeFilter: ['class'] });
  }
}

// Preload thumbnail images for faster zoom
function preloadThumbnailImages() {
  const thumbLinks = document.querySelectorAll('.product__thumb-item a');
  const preloadedImages = new Map();
  
  console.log('Preloading thumbnail images...');
  
  thumbLinks.forEach((link, index) => {
    const imageUrl = link.href;
    if (imageUrl && !preloadedImages.has(imageUrl)) {
      const img = new Image();
      img.onload = () => {
        console.log(`Preloaded image ${index + 1}:`, imageUrl);
        preloadedImages.set(imageUrl, img);
      };
      img.onerror = () => {
        console.warn(`Failed to preload image:`, imageUrl);
      };
      img.src = imageUrl;
      preloadedImages.set(imageUrl, null); // Mark as loading
    }
  });
  
  // Store preloaded images globally for zoom modal
  window.preloadedThumbnailImages = preloadedImages;
}

function createZoomModal(imageUrl, imageAlt, imageIndex) {
  // Remove existing zoom modal if any
  const existingModal = document.querySelector('.product-thumb-zoom-modal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Get all product images for navigation
  const allImageButtons = Array.from(document.querySelectorAll('.js-thumb-zoom'));
  const allImages = allImageButtons.map(btn => ({
    url: btn.dataset.zoomImage,
    alt: btn.dataset.zoomAlt,
    mediaId: btn.dataset.mediaId
  }));
  
  let currentIndex = imageIndex !== undefined ? imageIndex : 0;
  
  // If imageIndex not provided, try to find it by URL
  if (imageIndex === undefined && imageUrl) {
    currentIndex = allImages.findIndex(img => img.url === imageUrl);
    if (currentIndex === -1) currentIndex = 0;
  }
  
  // Create modal overlay
  const modal = document.createElement('div');
  modal.className = 'product-thumb-zoom-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  // Create image container
  const imageContainer = document.createElement('div');
  imageContainer.style.cssText = `
    position: relative;
    max-width: 90%;
    max-height: 90%;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  // Create loading indicator
  const loadingIndicator = document.createElement('div');
  loadingIndicator.innerHTML = `
    <div style="
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    "></div>
    <div style="
      margin-top: 10px;
      color: white;
      font-size: 14px;
    ">Đang tải...</div>
  `;
  loadingIndicator.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 1;
  `;
  
  // Add spin animation
  if (!document.querySelector('#zoom-modal-spin-style')) {
    const style = document.createElement('style');
    style.id = 'zoom-modal-spin-style';
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  }
  
  // Create zoomed image
  const zoomedImage = document.createElement('img');
  zoomedImage.alt = imageAlt;
  zoomedImage.style.cssText = `
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    transition: opacity 0.2s ease;
  `;
  
  // Show loading indicator initially
  imageContainer.appendChild(loadingIndicator);
  
  // Function to load image
  function loadImage(url, alt) {
    loadingIndicator.style.display = 'flex';
    zoomedImage.style.opacity = '0';
    
    const newImage = new Image();
    newImage.onload = function() {
      zoomedImage.src = newImage.src;
      zoomedImage.alt = alt;
      loadingIndicator.style.display = 'none';
      zoomedImage.style.opacity = '1';
      console.log('Zoom image loaded successfully');
    };
    
    newImage.onerror = function() {
      loadingIndicator.innerHTML = `
        <div style="color: white; font-size: 14px; text-align: center;">
          Không thể tải hình ảnh
        </div>
      `;
      console.error('Failed to load zoom image');
    };
    
    // Check if image is preloaded
    if (window.preloadedThumbnailImages && window.preloadedThumbnailImages.has(url)) {
      const preloadedImg = window.preloadedThumbnailImages.get(url);
      if (preloadedImg && preloadedImg.complete) {
        newImage.src = preloadedImg.src;
        console.log('Using preloaded image for zoom');
      } else {
        newImage.src = url;
        console.log('Preloaded image still loading, using original URL');
      }
    } else {
      newImage.src = url;
      console.log('Image not preloaded, using original URL');
    }
  }
  
  // Initial load
  loadImage(allImages[currentIndex].url, allImages[currentIndex].alt);
  
  // Create close button
  const closeButton = document.createElement('button');
  closeButton.innerHTML = `
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  `;
  closeButton.style.cssText = `
    position: absolute;
    top: -20px;
    right: 30px;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    transition: background 0.3s ease;
    z-index: 10002;
  `;
  
  closeButton.addEventListener('mouseenter', function() {
    this.style.background = 'rgba(0, 0, 0, 0.8)';
  });
  
  closeButton.addEventListener('mouseleave', function() {
    this.style.background = 'rgba(0, 0, 0, 0.5)';
  });
  
  // Create Previous button
  const prevButton = document.createElement('button');
  prevButton.className = 'zoom-modal-nav-btn prev';
  prevButton.innerHTML = `
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  `;
  
  // Create Next button
  const nextButton = document.createElement('button');
  nextButton.className = 'zoom-modal-nav-btn next';
  nextButton.innerHTML = `
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  `;
  
  // Navigation functions
  function updateNavButtons() {
    prevButton.disabled = currentIndex === 0;
    nextButton.disabled = currentIndex === allImages.length - 1;
  }
  
  function navigatePrevious() {
    if (currentIndex > 0) {
      currentIndex--;
      loadImage(allImages[currentIndex].url, allImages[currentIndex].alt);
      updateNavButtons();
      syncWithMainSlideshow();
    }
  }
  
  function navigateNext() {
    if (currentIndex < allImages.length - 1) {
      currentIndex++;
      loadImage(allImages[currentIndex].url, allImages[currentIndex].alt);
      updateNavButtons();
      syncWithMainSlideshow();
    }
  }
  
  // Sync with main slideshow (Flickity)
  function syncWithMainSlideshow() {
    const slideshow = document.querySelector('.product-slideshow, .product__main-photos');
    if (slideshow && window.Flickity) {
      const flkty = Flickity.data(slideshow);
      if (flkty) {
        flkty.select(currentIndex, false, true); // Select without animation
      }
    }
  }
  
  prevButton.addEventListener('click', function(e) {
    e.stopPropagation();
    navigatePrevious();
  });
  
  nextButton.addEventListener('click', function(e) {
    e.stopPropagation();
    navigateNext();
  });
  
  // Touch swipe support
  let touchStartX = 0;
  let touchEndX = 0;
  let touchStartY = 0;
  let touchEndY = 0;
  
  modal.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, { passive: true });
  
  modal.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipe();
  }, { passive: true });
  
  function handleSwipe() {
    const diffX = touchStartX - touchEndX;
    const diffY = Math.abs(touchStartY - touchEndY);
    
    // Only trigger if horizontal swipe is dominant (not vertical scroll)
    if (Math.abs(diffX) > 50 && Math.abs(diffX) > diffY) {
      if (diffX > 0) {
        // Swipe left - next
        navigateNext();
      } else {
        // Swipe right - previous
        navigatePrevious();
      }
    }
  }
  
  // Close modal function
  function closeModal() {
    modal.remove();
    document.body.style.overflow = '';
  }
  
  // Event listeners
  closeButton.addEventListener('click', function(e) {
    e.stopPropagation();
    closeModal();
  });
  
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });
  
  // Keyboard support
  const keydownHandler = function(e) {
    if (e.key === 'Escape') {
      closeModal();
      document.removeEventListener('keydown', keydownHandler);
    } else if (e.key === 'ArrowLeft') {
      navigatePrevious();
    } else if (e.key === 'ArrowRight') {
      navigateNext();
    }
  };
  document.addEventListener('keydown', keydownHandler);
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
  
  // Update navigation buttons state
  updateNavButtons();
  
  // Assemble modal
  imageContainer.appendChild(zoomedImage);
  imageContainer.appendChild(closeButton);
  modal.appendChild(imageContainer);
  modal.appendChild(prevButton);
  modal.appendChild(nextButton);
  document.body.appendChild(modal);
  
  // Add animation
  modal.style.opacity = '0';
  setTimeout(() => {
    modal.style.transition = 'opacity 0.3s ease';
    modal.style.opacity = '1';
  }, 10);
}

function initMobileThumbZoom(sectionId) {
  // Replaced with new thumb zoom modal - no longer using Photoswipe
  // This function is kept for compatibility but does nothing
  console.log('initMobileThumbZoom called - using new thumb zoom modal instead');
}

// Initialize thumb zoom modal event listeners
function initThumbZoomEventListeners() {
  document.querySelectorAll('.js-thumb-zoom').forEach((btn, index) => {
    // Remove any existing listeners to prevent duplicates
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    
    newBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const imageUrl = this.dataset.zoomImage;
      const imageAlt = this.dataset.zoomAlt;
      const mediaId = this.dataset.mediaId;
      
      // Find the index of this button in all zoom buttons
      const allButtons = document.querySelectorAll('.js-thumb-zoom');
      let buttonIndex = 0;
      allButtons.forEach((b, i) => {
        if (b === this) buttonIndex = i;
      });
      
      console.log('Opening zoom modal for image:', imageUrl, 'at index:', buttonIndex);
      createZoomModal(imageUrl, imageAlt, buttonIndex);
    });
  });
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing thumb zoom event listeners');
  initThumbZoomEventListeners();
});

// Re-initialize on section load (Shopify theme editor)
document.addEventListener('shopify:section:load', function() {
  console.log('Re-initializing thumb zoom on section load');
  setTimeout(initThumbZoomEventListeners, 100);
});

// Re-initialize when variant changes (in case images change)
document.addEventListener('variant:change', function() {
  console.log('Re-initializing thumb zoom on variant change');
  setTimeout(initThumbZoomEventListeners, 100);
});
</script>
