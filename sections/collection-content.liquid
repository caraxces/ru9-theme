{% liquid
  if section.settings.section_width != 'page-width'
    if section.settings.section_width == 'full-width'
      assign page_width = '100%'
    endif
    if section.settings.section_width == 'customize_width'
      assign page_width = section.settings.customize_width | plus: 80 | append: 'px'
    endif
  endif

  assign align = section.settings.align_text | prepend: 'text-'
%}

<style>
  .collection-content-dropdown {
    width: 100%;
  }
  
  .collection-content-dropdown__trigger {
    width: 100%;
    padding: 15px 20px;
    background: transparent;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-align: left;
  }
  
  .collection-content-dropdown__trigger:hover {
    background: rgba(0, 0, 0, 0.02);
  }
  
  .collection-content-dropdown__trigger.is-open {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    border-bottom: none;
  }
  
  .collection-content-dropdown__icon {
    transition: transform 0.3s ease;
    display: inline-block;
    margin-left: 10px;
  }
  
  .collection-content-dropdown__trigger.is-open .collection-content-dropdown__icon {
    transform: rotate(180deg);
  }
  
  .collection-content-dropdown__content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-top: none;
    border-radius: 0 0 4px 4px;
    padding: 0 20px;
  }
  
  .collection-content-dropdown__content.is-open {
    max-height: 2000px;
    padding: 20px;
  }
  
  .collection-content-dropdown__content-inner {
    opacity: 0;
    transition: opacity 0.3s ease 0.1s;
  }
  
  .collection-content-dropdown__content.is-open .collection-content-dropdown__content-inner {
    opacity: 1;
  }
  
  .collection-content-text {
    position: relative;
  }
  
  /* Hide truncated initially, show after JS processes */
  .collection-content-text__truncated:not(.js-processed) {
    display: none !important;
  }
  
  .collection-content-text__truncated.js-processed {
    display: block !important;
  }
  
  .collection-content-text__full {
    display: none !important;
  }
  
  .collection-content-text.is-expanded .collection-content-text__truncated {
    display: none !important;
  }
  
  .collection-content-text.is-expanded .collection-content-text__full {
    display: block !important;
  }
  
  .collection-content-text__expand-btn {
    margin-top: 10px;
    padding: 8px 16px;
    background: transparent;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #1C2C58;
    transition: all 0.3s ease;
  }
  
  .collection-content-text__expand-btn:hover {
    background: rgba(28, 44, 88, 0.05);
    border-color: #1C2C58;
  }
  
  .collection-content-text.is-expanded .collection-content-text__expand-btn {
    display: none;
  }
</style>

<div
  id="CollectionContentSection"
  data-section-id="{{ section.id }}"
  data-section-type="collection-content"
>
  <div class="collection-hero spacing-top-base">
    <div class="collection-hero__content">
      <div
        class="page-width"
        style="{% if section.settings.section_width != 'page-width' %}--page-width: {{ page_width }}{% endif %}"
      >
        <div class="section-collection--content {{ align }}">
          <div class="rte section-header__desc" style="--mw: {{ section.settings.max_width_desc }}px;">
            {% if collection.description != blank %}
              {% assign char_limit = section.settings.text_char_limit | default: 200 %}
              {% assign desc_text = collection.description | strip_html %}
              {% assign desc_length = desc_text | size %}
              
              <div class="collection-content-text" data-char-limit="{{ char_limit }}" data-desc-length="{{ desc_length }}">
                <div class="collection-content-text__truncated">
                  {{ collection.description }}
                </div>
                <div class="collection-content-text__full" style="display: none;">
                  {{ collection.description }}
                </div>
                {% if desc_length > char_limit %}
                  <button type="button" class="collection-content-text__expand-btn">
                    {{ section.settings.expand_button_text | default: 'Xem thêm' }}
                  </button>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const textContainer = document.querySelector('#CollectionContentSection .collection-content-text');
    if (!textContainer) return;
    
    const expandBtn = textContainer.querySelector('.collection-content-text__expand-btn');
    const truncatedDiv = textContainer.querySelector('.collection-content-text__truncated');
    const fullDiv = textContainer.querySelector('.collection-content-text__full');
    const charLimit = parseInt(textContainer.getAttribute('data-char-limit')) || 200;
    
    if (truncatedDiv && fullDiv) {
      const fullText = fullDiv.textContent.trim();
      const fullHTML = fullDiv.innerHTML;
      
      if (fullText.length > charLimit && expandBtn) {
        // Truncate HTML while preserving structure
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = fullHTML;
        
        let charCount = 0;
        let truncatedHTML = '';
        
        function truncateNode(node) {
          if (charCount >= charLimit) return;
          
          if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            if (charCount + text.length <= charLimit) {
              truncatedHTML += text;
              charCount += text.length;
            } else {
              const remaining = charLimit - charCount;
              let truncatedText = text.substring(0, remaining);
              const lastSpace = truncatedText.lastIndexOf(' ');
              if (lastSpace > remaining * 0.8) {
                truncatedText = truncatedText.substring(0, lastSpace);
              }
              truncatedHTML += truncatedText + '...';
              charCount = charLimit;
            }
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            const tagName = node.tagName.toLowerCase();
            const attrs = Array.from(node.attributes).map(attr => 
              `${attr.name}="${attr.value}"`
            ).join(' ');
            const openTag = attrs ? `<${tagName} ${attrs}>` : `<${tagName}>`;
            const closeTag = `</${tagName}>`;
            
            truncatedHTML += openTag;
            Array.from(node.childNodes).forEach(child => {
              if (charCount < charLimit) {
                truncateNode(child);
              }
            });
            truncatedHTML += closeTag;
          }
        }
        
        Array.from(tempDiv.childNodes).forEach(child => {
          if (charCount < charLimit) {
            truncateNode(child);
          }
        });
        
        truncatedDiv.innerHTML = truncatedHTML;
        truncatedDiv.classList.add('js-processed');
      } else {
        // Text is shorter than limit, show full text
        truncatedDiv.classList.add('js-processed');
      }
    }
    
    if (expandBtn) {
      expandBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        textContainer.classList.add('is-expanded');
      });
    }
  })();
</script>


{% schema %}
{
  "name": "Collection content",
  "settings": [
    {
      "type": "select",
      "id": "section_width",
      "options": [
        {
          "value": "full-width",
          "label": "t:sections.all.section_width.options__1"
        },
        {
          "value": "page-width",
          "label": "t:sections.all.section_width.options__2"
        },
        {
          "value": "customize_width",
          "label": "t:sections.all.section_width.options__3"
        }
      ],
      "default": "page-width",
      "label": "t:sections.all.section_width.label"
    },
    {
      "type": "range",
      "id": "customize_width",
      "min": 1000,
      "max": 1800,
      "step": 10,
      "default": 1800,
      "unit": "px",
      "label": "t:sections.all.customize_width.label"
    },
    {
      "type": "range",
      "id": "max_width_desc",
      "min": 500,
      "max": 2000,
      "step": 20,
      "default": 620,
      "unit": "px",
      "label": "Custom width content"
    },
    {
      "type": "select",
      "id": "align_text",
      "label": "t:sections.all.alignment.label__1",
      "default": "left",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_collection_description",
      "default": true,
      "label": "t:sections.collection-header.settings.show_collection_description.label",
      "info": "t:sections.collection-header.settings.show_collection_description.info"
    },
    {
      "type": "text",
      "id": "dropdown_label",
      "label": "Dropdown label",
      "default": "Xem thêm thông tin",
      "info": "Text hiển thị trên button dropdown"
    },
    {
      "type": "range",
      "id": "text_char_limit",
      "min": 100,
      "max": 2000,
      "step": 50,
      "default": 200,
      "unit": "ch",
      "label": "Số ký tự hiển thị mặc định",
      "info": "Số ký tự sẽ được hiển thị trước khi user click để xem thêm"
    },
    {
      "type": "text",
      "id": "expand_button_text",
      "label": "Text nút mở rộng",
      "default": "Xem thêm",
      "info": "Text hiển thị trên button để mở rộng xem toàn bộ nội dung"
    }
  ],
  "disabled_on": {
    "groups": ["footer", "header"]
  }
}
{% endschema %}
