{%- liquid
  assign section_id = section.id
-%}

<section class="reviews-carousel-section" id="reviews-carousel-{{ section_id }}" data-section-id="{{ section_id }}">
  <div class="page-width">
    <div class="reviews-carousel-header">
      <div class="reviews-carousel-header__left">
        <div class="reviews-carousel-stars">
          <svg width="137" height="24" viewBox="0 0 137 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.4987 0.414593C11.6783 -0.138197 12.4603 -0.138197 12.6399 0.414593L15.0778 7.91753C15.1581 8.16474 15.3885 8.33212 15.6484 8.33212H23.5375C24.1187 8.33212 24.3604 9.07585 23.8902 9.41755L17.5078 14.0547C17.2975 14.2074 17.2095 14.4783 17.2898 14.7255L19.7277 22.2284C19.9073 22.7812 19.2746 23.2409 18.8044 22.8992L12.422 18.2622C12.2117 18.1094 11.9269 18.1094 11.7166 18.2622L5.33427 22.8992C4.86405 23.2409 4.23136 22.7812 4.41097 22.2284L6.84882 14.7255C6.92915 14.4783 6.84115 14.2074 6.63086 14.0547L0.248482 9.41755C-0.221748 9.07585 0.0199116 8.33212 0.601152 8.33212H8.49023C8.75013 8.33212 8.98053 8.16474 9.06083 7.91753L11.4987 0.414593Z" fill="#FFDC5F"/><path d="M39.4988 0.414593C39.6784 -0.138197 40.4603 -0.138197 40.6399 0.414593L43.0778 7.91753C43.1581 8.16474 43.3886 8.33212 43.6485 8.33212H51.5375C52.1187 8.33212 52.3604 9.07585 51.8902 9.41755L45.5078 14.0547C45.2975 14.2074 45.2096 14.4783 45.2899 14.7255L47.7278 22.2284C47.9074 22.7812 47.2746 23.2409 46.8044 22.8992L40.422 18.2622C40.2117 18.1094 39.927 18.1094 39.7167 18.2622L33.3342 22.8992C32.864 23.2409 32.2313 22.7812 32.4109 22.2284L34.8488 14.7255C34.9291 14.4783 34.8411 14.2074 34.6308 14.0547L28.2484 9.41755C27.7782 9.07585 28.0199 8.33212 28.6011 8.33212H36.4902C36.7501 8.33212 36.9805 8.16474 37.0609 7.91753L39.4988 0.414593Z" fill="#FFDC5F"/><path d="M67.4987 0.414593C67.6783 -0.138197 68.4604 -0.138197 68.64 0.414593L71.0778 7.91753C71.1581 8.16474 71.3886 8.33212 71.6485 8.33212H79.5375C80.1187 8.33212 80.3604 9.07585 79.8902 9.41755L73.5078 14.0547C73.2975 14.2074 73.2095 14.4783 73.2898 14.7255L75.7278 22.2284C75.9074 22.7812 75.2746 23.2409 74.8044 22.8992L68.422 18.2622C68.2117 18.1094 67.927 18.1094 67.7167 18.2622L61.3342 22.8992C60.864 23.2409 60.2313 22.7812 60.4109 22.2284L62.8489 14.7255C62.9292 14.4783 62.8411 14.2074 62.6308 14.0547L56.2484 9.41755C55.7782 9.07585 56.0199 8.33212 56.6011 8.33212H64.4902C64.7501 8.33212 64.9805 8.16474 65.0609 7.91753L67.4987 0.414593Z" fill="#FFDC5F"/><path d="M95.4987 0.414593C95.6783 -0.138197 96.4604 -0.138197 96.64 0.414593L99.0774 7.91753C99.1584 8.16474 99.3884 8.33212 99.6484 8.33212H107.537C108.118 8.33212 108.36 9.07585 107.89 9.41755L101.507 14.0547C101.297 14.2074 101.209 14.4783 101.29 14.7255L103.727 22.2284C103.907 22.7812 103.274 23.2409 102.804 22.8992L96.422 18.2622C96.2117 18.1094 95.927 18.1094 95.7167 18.2622L89.3342 22.8992C88.864 23.2409 88.2313 22.7812 88.4109 22.2284L90.8489 14.7255C90.9292 14.4783 90.8411 14.2074 90.6308 14.0547L84.2484 9.41755C83.7782 9.07585 84.0199 8.33212 84.6011 8.33212H92.4902C92.7501 8.33212 92.9805 8.16474 93.0609 7.91753L95.4987 0.414593Z" fill="#FFDC5F"/><path d="M123.498 0.414593C123.678 -0.138197 124.46 -0.138197 124.64 0.414593L127.077 7.91753C127.158 8.16474 127.388 8.33212 127.648 8.33212H135.537C136.118 8.33212 136.36 9.07585 135.89 9.41755L129.507 14.0547C129.297 14.2074 129.209 14.4783 129.29 14.7255L131.727 22.2284C131.907 22.7812 131.274 23.2409 130.804 22.8992L124.422 18.2622C124.211 18.1094 123.927 18.1094 123.716 18.2622L117.334 22.8992C116.864 23.2409 116.231 22.7812 116.411 22.2284L118.848 14.7255C118.929 14.4783 118.841 14.2074 118.631 14.0547L112.248 9.41755C111.778 9.07585 112.02 8.33212 112.601 8.33212H120.49C120.75 8.33212 120.98 8.16474 121.061 7.91753L123.498 0.414593Z" fill="#FFDC5F"/></svg>
        </div>
        {% if section.settings.heading != blank %}
          <div class="reviews-carousel-title rte">{{ section.settings.heading }}</div>
        {% endif %}
      </div>
      <div class="reviews-carousel-header__right">
        <button class="reviews-carousel-nav reviews-carousel-nav--prev" aria-label="Previous slide">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 9L4.5 6L7.5 3" stroke="#9CA3AF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button class="reviews-carousel-nav reviews-carousel-nav--next" aria-label="Next slide">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.5 9L7.5 6L4.5 3" stroke="#609EE9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>

    <div class="reviews-carousel-viewport">
      <div class="reviews-carousel-track">
        {%- for block in section.blocks -%}
          <article class="review-card" {{ block.shopify_attributes }}>
            <div class="review-card__video-wrapper">
              {%- if block.settings.video != blank -%}
                <div class="review-card__video">
                  <video 
                    autoplay
                    muted
                    loop
                    playsinline
                    preload="auto" 
                    loading="lazy"
                    poster="{% if block.settings.video.preview_image %}{{ block.settings.video.preview_image | image_url: width: 800 }}{% endif %}"
                  >
                    {%- for source in block.settings.video.sources -%}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {%- endfor -%}
                    Your browser does not support the video tag.
                  </video>
                </div>
              {%- else -%}
                <div class="review-card__video-placeholder">
                  <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 21.3333L40 32L24 42.6667V21.3333Z" stroke="#759CE6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                  </svg>
                </div>
              {%- endif -%}
              {%- if block.settings.product_link != blank and block.settings.product_name != blank -%}
                <a href="{{ block.settings.product_link }}" class="review-card__product-link">
                  <span class="review-card__product-name">{{ block.settings.product_name }}</span>
                  <span class="review-card__product-icon">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="10" cy="10" r="10" fill="#2940A6"/>
                      <path d="M8 6L12 10L8 14" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                  </span>
                </a>
              {%- endif -%}
            </div>
          </article>
        {%- endfor -%}
      </div>
    </div>
    <div class="reviews-carousel-progress-container">
      <div class="reviews-carousel-progress-background"></div>
      <div class="reviews-carousel-progress-bar"></div>
    </div>
  </div>
</section>

<style>
.reviews-carousel-section .page-width {
  max-width: none;
  margin: 0 5rem;
  padding: 0 0 20px 0;
}
/* General Styles */
.reviews-carousel-section { padding: 0px 0; font-family: "Be Vietnam Pro", sans-serif; }
.reviews-carousel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
@media (max-width: 768px) {.reviews-carousel-header { margin-bottom: 20px; }}
.reviews-carousel-header__left { display: flex; flex-direction: column; gap: 8px; }
.reviews-carousel-title { 
  font-family: "Be Vietnam Pro", sans-serif; 
  font-size: 39px; 
  font-weight: 700; 
  line-height: 1.2; 
  color: #1C2C58; 
}
.reviews-carousel-title p { margin: 0; }

.reviews-carousel-title strong {
  color: #759CE6 !important;
}

.reviews-carousel-title p strong {
  color: #759CE6 !important;
}

/* Target any strong tags within the title */
.reviews-carousel-title .rte strong {
  color: #759CE6 !important;
}

/* Target specific numbers in the title */
.reviews-carousel-title {
  color: #1C2C58;
}

.reviews-carousel-title strong {
  color: #759CE6 !important;
}

/* More specific targeting for numbers */
.reviews-carousel-title p strong,
.reviews-carousel-title .rte strong,
.reviews-carousel-title strong {
  color: #759CE6 !important;
}
.reviews-carousel-header__right { display: flex; gap: 12px; }
.reviews-carousel-nav { width: 40px; height: 40px; border-radius: 50%; background-color: #F5F9FF; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s; }
.reviews-carousel-nav:hover { background-color: #234085; }
.reviews-carousel-nav:disabled { opacity: 0.5; cursor: not-allowed; }

/* Carousel Viewport & Track */
.reviews-carousel-viewport { overflow: hidden; margin-bottom: 5rem; }
@media (max-width: 768px) {.reviews-carousel-viewport { margin-bottom: 0px; }}
.reviews-carousel-track { display: flex; gap: 24px; transition: transform 0.5s ease-in-out; }

/* Review Card */
/* Wireframe: 478px x 745px trên màn hình 1920px */
/* Tỷ lệ canvas 1594px: 1594/1920 = 0.830208333 */
/* Card: 478 * 0.8302 = 397px, 745 * 0.8302 = 618px */
/* Giảm 12%: 397 * 0.88 = 349px, 618 * 0.88 = 544px */
.review-card { 
  flex: 0 0 349px; 
  width: 349px; 
  display: flex; 
  flex-direction: column; 
  background: transparent; 
  border-radius: 0; 
  padding: 0; 
  box-shadow: none;
  height: fit-content;
}
.review-card__video-wrapper { 
  width: 100%; 
  height: 544px; 
  border-radius: 12px; 
  overflow: hidden; 
  background: #FFFFFF; 
  position: relative;
  flex-shrink: 0;
}
.review-card__video { 
  width: 100%; 
  height: 100%; 
  position: relative;
}
.review-card__video video { 
  width: 100%; 
  height: 100%; 
  object-fit: cover; 
  display: block; 
  border: none; 
  border-radius: 12px;
}
/* Ẩn thanh timeline và nút fullscreen - Đã bỏ controls nên không cần nữa */

.review-card__video-placeholder { 
  width: 100%; 
  height: 100%; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  background: #FFFFFF; 
  border-radius: 12px;
}
.review-card__product-link { 
  position: absolute;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  padding: 9px 20px; 
  background: #FFF; 
  border: 2px solid #E5E7EB;
  text-decoration: none; 
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
  transition: box-shadow 0.3s, transform 0.2s; 
  flex-shrink: 0;
  z-index: 10;
  box-sizing: border-box;
  /* Kích thước giảm 12%: 339*0.88=298px, 55*0.88=48px, 31*0.88=27px */
  width: 298px;
  height: 48px;
  border-radius: 27px;
}
.review-card__product-link:hover { 
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); 
  transform: translateX(-50%) translateY(-1px); 
}
.review-card__product-name { 
  font-size: 11px; 
  font-weight: 500; 
  color: #1C2C58; 
  margin: 0; 
}
.review-card__product-icon { 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  flex-shrink: 0; 
  margin-left: 12px;
}
.review-card__product-icon svg { 
  display: block; 
}

/* Progress Bar */
.reviews-carousel-progress-container { width: 100%; height: 4px; display: none; position: relative; }
.reviews-carousel-progress-background { width: 100%; height: 100%; background-color: #E0E0E0; border-radius: 2px; position: absolute; top: 0; left: 0; }
.reviews-carousel-progress-bar { width: 0; height: 100%; background-color: #234085; border-radius: 2px; position: absolute; top: 0; left: 0; z-index: 2; }
.reviews-carousel-track.is-dragging { cursor: grabbing; user-select: none; }
  
  /* Large screens - maintain fixed padding */
  @media (min-width: 1400px) {
    .reviews-carousel-section .page-width {
      margin: 0 5rem;
    }
  }
  
  /* Medium screens - responsive padding */
  @media (max-width: 1399px) and (min-width: 1024px) {
    .reviews-carousel-section .page-width {
      margin: 0 5% 0 4%;
    }
  }

  @media (max-width: 1023px) and (min-width: 769px) {
    .reviews-carousel-section .page-width {
      margin: 0 4% 0 4%;
    }
  }

  @media (max-width: 768px) {
    .reviews-carousel-section .page-width {
      margin: 0 15px;
      padding: 0;
    }
    .reviews-carousel-section { padding: 40px 0; }
    .reviews-carousel-header { flex-direction: column; align-items: flex-start; gap: 20px; }
    .reviews-carousel-title {
        font-size: 20px;
        font-weight: 600;
        line-height: 33.6px;
        letter-spacing: 0.6px;
    }
    .reviews-carousel-header__right { display: none; }
    
    /* Mobile: Enable horizontal scroll with blue scrollbar */
    .reviews-carousel-viewport {
      overflow-x: auto !important;
      overflow-y: hidden !important;
      padding-bottom: 20px !important; /* Space for scrollbar */
      scrollbar-width: auto !important; /* Show scrollbar */
      -ms-overflow-style: auto !important; /* Show scrollbar for IE/Edge */
      -webkit-overflow-scrolling: touch !important;
      scroll-behavior: smooth !important;
    }
    
    /* Mobile scrollbar styling - Blue scrollbar like other sections */
    .reviews-carousel-viewport::-webkit-scrollbar {
      height: 8px !important;
      display: block !important; /* Ensure scrollbar is visible */
    }
    
    .reviews-carousel-viewport::-webkit-scrollbar-track {
      background: #F0F1EF !important;
      border-radius: 100px !important;
    }
    
    .reviews-carousel-viewport::-webkit-scrollbar-thumb {
      background: #234085 !important;
      border-radius: 100px !important;
    }
    
    .reviews-carousel-viewport::-webkit-scrollbar-thumb:hover {
      background: #1a2f6b !important;
    }
    
    .reviews-carousel-viewport::-webkit-scrollbar-button {
      display: none !important;
    }
    
    /* Mobile: giảm 12% từ desktop */
    /* Desktop mới: 349px × 544px */
    /* Mobile: 280 * 0.88 = 246px, height: 436 * 0.88 = 384px */
    .review-card { 
      flex: 0 0 246px; 
      width: 246px; 
      display: flex; 
      flex-direction: column; 
      background: transparent; 
      border-radius: 0; 
      padding: 0; 
      box-shadow: none;
      height: fit-content;
    }
    .review-card__video-wrapper { 
      width: 100%; 
      height: 384px; 
      border-radius: 12px; 
      overflow: hidden; 
      background: #FFFFFF; 
      position: relative;
      flex-shrink: 0;
    }
    .review-card__video { 
      width: 100%; 
      height: 100%; 
      position: relative;
    }
    .review-card__video video { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      display: block; 
      border: none; 
      border-radius: 12px;
    }
    .review-card__video-placeholder { 
      width: 100%; 
      height: 100%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: #FFFFFF; 
      border-radius: 12px;
    }
    .review-card__product-link { 
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 7px 16px; 
      background: #FFF; 
      border: 2px solid #E5E7EB;
      text-decoration: none; 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
      transition: box-shadow 0.3s, transform 0.2s; 
      flex-shrink: 0;
      z-index: 10;
      box-sizing: border-box;
      /* Kích thước giảm 12%: 239*0.88=210px, 39*0.88=34px, 22*0.88=19px */
      width: 210px;
      height: 34px;
      border-radius: 19px;
    }
    .review-card__product-link:hover { 
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); 
      transform: translateX(-50%) translateY(-1px); 
    }
    .review-card__product-name { 
      font-size: 11px; 
      font-weight: 500; 
      color: #1C2C58; 
      margin: 0; 
    }
    .review-card__product-icon { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      flex-shrink: 0; 
      margin-left: 12px;
    }
    .review-card__product-icon svg { 
      display: block; 
      width: 18px; 
      height: 18px; 
    }
  }
</style>

<script>
(function() {
  const sectionId = '{{ section_id }}';
  const carouselId = `reviews-carousel-${sectionId}`;

  // Không cần tính toán JavaScript nữa vì đã gán trực tiếp vào CSS

  const initCarousel = (carousel) => {
    if (carousel.dataset.initialized) return;

    const viewport = carousel.querySelector('.reviews-carousel-viewport');
    const track = carousel.querySelector('.reviews-carousel-track');
    const cards = Array.from(carousel.querySelectorAll('.review-card'));
    const prevButton = carousel.querySelector('.reviews-carousel-nav--prev');
    const nextButton = carousel.querySelector('.reviews-carousel-nav--next');
    const progressContainer = carousel.querySelector('.reviews-carousel-progress-container');
    const progressBar = carousel.querySelector('.reviews-carousel-progress-bar');
    
    if (!track || !cards.length || !prevButton || !nextButton || !progressContainer || !progressBar) {
      return;
    }

    let currentIndex = 0;
    let isDragging = false;
    let isDown = false; // Track if mouse/touch is down
    let startPos = 0;
    let startPosY = 0; // Track Y position for direction detection
    let currentTranslate = 0;
    let prevTranslate = 0;
    let animationID = 0;
    const dragThreshold = 5; // Only prevent default after 5px horizontal movement

    let cardWidth, gap, viewportWidth, visibleCards, maxIndex, totalTrackWidth, maxScroll;

    function calculateDimensions() {
      cardWidth = cards.length > 0 ? cards[0].offsetWidth : 0;
      if (cardWidth === 0) return;
      gap = parseInt(window.getComputedStyle(track).gap) || 24;
      viewportWidth = viewport.offsetWidth;
      visibleCards = Math.floor((viewportWidth + gap) / (cardWidth + gap));
      maxIndex = cards.length > visibleCards ? cards.length - visibleCards : 0;
      totalTrackWidth = (cards.length * cardWidth) + Math.max(0, cards.length - 1) * gap;
      maxScroll = totalTrackWidth - viewportWidth;

      if (currentIndex > maxIndex) {
        currentIndex = maxIndex;
      }
    }
    
    function updateProgressBar() {
      if (totalTrackWidth > viewportWidth) {
        progressContainer.style.display = 'block';
        const thumbWidth = (viewportWidth / totalTrackWidth) * 100;
        progressBar.style.width = `${thumbWidth}%`;

        const clampedTranslate = Math.max(-maxScroll, Math.min(0, currentTranslate));
        const currentScroll = -clampedTranslate;
        
        const scrollPercentage = maxScroll > 0 ? (currentScroll / maxScroll) : 0;
        const thumbTranslate = scrollPercentage * (100 - thumbWidth);
        progressBar.style.left = `${thumbTranslate}%`;
      } else {
        progressContainer.style.display = 'none';
      }
    }
    
    function setPositionByIndex() {
      currentTranslate = -currentIndex * (cardWidth + gap);
      prevTranslate = currentTranslate;
      track.style.transition = 'transform 0.5s ease-in-out';
      progressBar.style.transition = 'width 0.5s ease-in-out, left 0.5s ease-in-out';
      track.style.transform = `translateX(${currentTranslate}px)`;
      
      prevButton.disabled = currentIndex === 0;
      nextButton.disabled = currentIndex >= maxIndex;
      
      updateProgressBar();
    }

    function startDrag(e) {
      isDown = true;
      isDragging = false; // Not dragging yet, just started
      startPos = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      startPosY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      animationID = requestAnimationFrame(animation);
      track.style.transition = 'none';
      progressBar.style.transition = 'none';
      track.classList.add('is-dragging');
      
      // For touch events, add listeners to window (like blog-carousel)
      if (e.type === 'touchstart') {
        window.addEventListener('touchmove', dragMove);
        window.addEventListener('touchend', dragEnd);
      }
    }

    function dragMove(e) {
      if (!isDown) return;
      
      const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      const walk = currentX - startPos;
      const walkY = currentY - startPosY;
      
      // Only prevent default and handle drag if horizontal movement exceeds threshold
      // This allows vertical scrolling to work normally
      if (Math.abs(walk) > dragThreshold && Math.abs(walk) > Math.abs(walkY)) {
        isDragging = true;
        e.preventDefault();
        currentTranslate = prevTranslate + walk;
      }
    }

    function drag(e) {
      // For mouse events, use the old logic
      if (isDown) {
        const currentPosition = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        currentTranslate = prevTranslate + currentPosition - startPos;
      }
    }

    function dragEnd() {
      if (!isDown) return;
      
      cancelAnimationFrame(animationID);
      isDown = false;
      isDragging = false;
      track.classList.remove('is-dragging');
      
      // Remove window listeners for touch events
      window.removeEventListener('touchmove', dragMove);
      window.removeEventListener('touchend', dragEnd);

      const movedBy = currentTranslate - prevTranslate;

      if (movedBy < -50 && currentIndex < maxIndex) {
        currentIndex += 1;
      }
      if (movedBy > 50 && currentIndex > 0) {
        currentIndex -= 1;
      }
      
      setPositionByIndex();
    }

    function endDrag() {
      dragEnd();
    }

    function animation() {
      if (!isDown && !isDragging) return;
      track.style.transform = `translateX(${currentTranslate}px)`;
      updateProgressBar();
      if (isDown || isDragging) {
        requestAnimationFrame(animation);
      }
    }
    
    function onResize() {
      calculateDimensions();
      setPositionByIndex();
      // Không cần applyButtonStyles vì tỷ lệ đã cố định theo canvas
    }

    prevButton.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        setPositionByIndex();
      }
    });

    nextButton.addEventListener('click', () => {
      if (currentIndex < maxIndex) {
        currentIndex++;
        setPositionByIndex();
      }
    });

    track.querySelectorAll('img, iframe, video').forEach(media => media.addEventListener('dragstart', (e) => e.preventDefault()));
    
    track.addEventListener('mousedown', startDrag);
    track.addEventListener('touchstart', startDrag, { passive: true }); // Start passive to allow vertical scroll
    track.addEventListener('mousemove', drag);
    // touchmove is handled by window listener in startDrag (like blog-carousel)
    track.addEventListener('mouseup', endDrag);
    track.addEventListener('mouseleave', endDrag);
    // touchend is handled by window listener in startDrag

    const resizeObserver = new ResizeObserver(onResize);
    resizeObserver.observe(viewport);

    // Đảm bảo video tự động phát
    const videos = carousel.querySelectorAll('.review-card__video video');
    videos.forEach(video => {
      // Đảm bảo video tự động phát khi load
      video.addEventListener('loadeddata', () => {
        video.play().catch(err => {
          // Nếu autoplay bị chặn, thử lại khi user tương tác
          console.log('Autoplay blocked, will play on interaction');
        });
      });
      
      // Thử phát ngay khi video sẵn sàng
      if (video.readyState >= 2) {
        video.play().catch(err => {
          console.log('Autoplay blocked');
        });
      }
    });
    
    // Sử dụng Intersection Observer để phát video khi vào viewport
    if ('IntersectionObserver' in window) {
      const videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const video = entry.target;
            video.play().catch(err => {
              console.log('Autoplay blocked by browser policy');
            });
          } else {
            // Tạm dừng video khi ra khỏi viewport để tiết kiệm tài nguyên
            entry.target.pause();
          }
        });
      }, {
        threshold: 0.5 // Phát khi 50% video hiển thị
      });
      
      videos.forEach(video => {
        videoObserver.observe(video);
      });
    }

    setTimeout(() => {
        calculateDimensions();
        setPositionByIndex();
    }, 150);

    carousel.dataset.initialized = true;
  };
  
  const setup = () => {
    const carouselElement = document.getElementById(carouselId);
    if (carouselElement) {
      initCarousel(carouselElement);
    }
  }
  
  // Không cần resize listener nữa vì tỷ lệ đã cố định theo canvas

  document.addEventListener('DOMContentLoaded', setup);
  document.addEventListener('shopify:section:load', function(event) {
    if (event.detail.sectionId === sectionId) {
      const carouselElement = event.target.querySelector(`#${carouselId}`);
      if (carouselElement) {
          delete carouselElement.dataset.initialized;
          initCarousel(carouselElement);
      }
    }
  });

})();
</script>

{% schema %}
{
  "name": "Customer Reviews Carousel",
  "settings": [
    {
      "type": "richtext",
      "id": "heading",
      "label": "Heading",
      "default": "<p><strong>Hơn 50,000 khách hàng</strong><br>và <strong>30,000 đánh giá 5 sao</strong> toàn quốc</p>"
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Review",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "Video"
        },
        { "type": "text", "id": "product_name", "label": "Product Name", "default": "Nệm Original" },
        { "type": "url", "id": "product_link", "label": "Product Link" }
      ]
    }
  ],
  "presets": [
    { 
      "name": "Reviews Carousel", 
      "category": "Testimonials",
      "blocks": [
        { "type": "review" },
        { "type": "review" },
        { "type": "review" },
        { "type": "review" },
        { "type": "review" }
      ]
    }
  ]
}
{% endschema %}


