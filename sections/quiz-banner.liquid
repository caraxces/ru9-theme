<style>
  .quiz-banner-section {
    padding: 0px 0;
  }
  .quiz-banner-section .page-width {
    max-width: none;
    padding: 0;
    margin: 0 5rem;
  }

  /* Large screens - 1400px+ (100% zoom equivalent) */
  @media (min-width: 1400px) {
    .quiz-banner-section .page-width {
      max-width: 1594px !important;
      margin: 0 auto !important;
      padding: 0 5rem 5rem 5rem !important;
    }
  }

  /* Large screens - 1200px to 1399px */
  @media (max-width: 1399px) and (min-width: 1200px) {
    .quiz-banner-section .page-width {
      max-width: 1594px !important;
      margin: 0 auto !important;
      padding: 0 5rem 5rem 5rem !important;
    }
  }

  /* Medium screens - 768px to 1199px */
  @media (max-width: 1199px) and (min-width: 769px) {
    .quiz-banner-section .page-width {
      max-width: 1594px !important;
      margin: 0 auto !important;
      padding: 0 5rem 5rem 5rem !important;
      padding-bottom: 5rem !important;
    }
  }

  /* Small screens - 768px and below */
  @media (max-width: 768px) {
    .quiz-banner-container {
      padding: 0 15px;
    }
    .quiz-banner-section {
      padding: 0px !important;
    }
    .quiz-banner-section .page-width {
      margin: 0;
    }
    .index-section.quiz-banner-section {
      margin: 0px !important;
    }
  }
  .quiz-banner-container {
    display: flex;
    align-items: center;
    gap: 2.5vw;
    background: #F5F9FF;
    border-radius: 6px;
    height: 22vw;
    min-height: 300px;
    max-height: 400px;
    {% comment %} max-width: 1595px; {% endcomment %}
    width: 100%;
    margin: 0 0;
    overflow: hidden;
  }
  .quiz-banner-left {
    flex-basis: auto;
    height: calc(100% - 20px);
    margin: 10px 0;
    flex-shrink: 0;
    max-width: 600px;
    width: auto;
  }
  .quiz-banner-left img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  /* Desktop and Mobile Image Visibility */
  .mobile-image {
    display: none;
  }
  
  .desktop-image {
    display: block;
  }
  .quiz-banner-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
  }
  /* Desktop buttons - inside quiz-banner-right */
  .quiz-banner-buttons.desktop-buttons {
    display: flex;
    gap: 1vw;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  
  /* Mobile buttons - hidden on desktop */
  .quiz-banner-buttons.mobile-buttons {
    display: none;
  }
  .quiz-banner-title {
    color: #1C2C58;
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: 39px;
    font-style: normal;
    font-weight: 700;
    line-height: 1.25;
    letter-spacing: 0.6px;
    margin: 0 0 1vw 0;
  }

  .quiz-banner-subtitle {
    color: #000;
    text-align: center;
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: clamp(14px, 1.2vw, 20px);
    font-style: normal;
    font-weight: 400;
    line-height: 1.5;
    letter-spacing: 0.6px;
    margin: 0 0 2vw 0;
    max-width: 700px;
  }
  .quiz-btn {
    display: inline-flex;
    padding: clamp(8px, 1vw, 16px) clamp(16px, 2vw, 32px);
    justify-content: center;
    align-items: center;
    border-radius: 100px;
    min-width: clamp(200px, 20vw, 350px);
    background: #234085;
    color: white;
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: clamp(14px, 1vw, 20px);
    font-weight: 500;
    border: none;
    cursor: pointer;
    text-decoration: none;
    white-space: nowrap;
    transition: background 0.3s ease;
  }
  .quiz-btn:hover {
    background: #3a4c7a;
    color: white;
  }

  /* Large screens - 1200px+ */
  @media (min-width: 1200px) {
    .quiz-banner-container {
      gap: 3vw;
      height: 20vw;
    }
  }

  /* Medium screens - 768px to 1199px */
  @media (max-width: 1199px) and (min-width: 769px) {
    .quiz-banner-container {
      gap: 2vw;
      height: 25vw;
    }
    .quiz-banner-title {
      font-size: clamp(20px, 2.2vw, 32px);
    }
    .quiz-banner-subtitle {
      font-size: clamp(14px, 1.1vw, 20px);
    }
  }

  /* Small screens - 768px and below (merged with 480px styles) */
  @media (max-width: 768px) {
    .quiz-banner-container {
      flex-direction: column;
      justify-content: flex-start;
      padding: 3vw;
      width: 95vw;
      max-width: none;
      height: auto;
      min-height: 490px;
      border-radius: 5px;
      margin: 0 15px;
      margin-top: 0px !important;
    }
    .quiz-banner-left {
      display: block;
      width: 100%;
      max-width: 400px;
      height: auto;
      flex-shrink: 0;
      aspect-ratio: 634/441;
      margin-top: 20px;
      align-self: center;
      margin-left: auto;
      margin-right: auto;
      padding: 0;
    }
    .quiz-banner-left img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    /* Show mobile image on mobile devices */
    .desktop-image {
      display: none;
    }
    
    .mobile-image {
      display: block;
    }
    .quiz-banner-subtitle {
      display: none;
    }
    .quiz-banner-right {
      align-items: center;
      text-align: center;
      flex: initial;
      padding: 0;
      order: 1;
    }
    .quiz-banner-title {
      font-size: 20px;
      margin: 20px 0 0 0 !important;
      max-width: 200px;
    }
    .quiz-banner-left {
      order: 2;
    }
    /* Hide desktop buttons on mobile */
    .quiz-banner-buttons.desktop-buttons {
      display: none;
    }
    
    /* Show mobile buttons on mobile */
    .quiz-banner-buttons.mobile-buttons {
      display: flex;
      flex-direction: column;
      gap: 2vw;
      order: 3;
      flex: initial;
      margin-top: 0;
    }
    .quiz-btn {
      width: 320px;
      height: 40px;
      flex-shrink: 0;
      border-radius: 30px;
      background: #234085;
      font-size: 14px;
    }
    .quiz-btn:hover {
      background: #3c5aa0;
    }
  }


  /* Zoom levels - 50% to 200% */
  @media (min-resolution: 0.5dppx) {
    .quiz-banner-container {
      gap: max(1vw, 10px);
    }
  }

  @media (min-resolution: 2dppx) {
    .quiz-banner-container {
      gap: min(3vw, 50px);
    }
  }
  
  /* Quiz Popup Styles - Fixed Layout */
  .quiz-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .quiz-popup-content {
    background: #fff;
    border-radius: 15px;
    width: 1594px;
    max-width: 1594px;
    height: 889px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
    box-sizing: border-box;
    transition: width 0.3s ease, height 0.3s ease;
  }
  
  /* Result step specific sizing - 828px x 1009px for 1594px canvas */
  .quiz-popup-content.quiz-result-mode {
    width: 828px;
    max-width: 828px;
    height: 1009px;
    max-height: 90vh;
  }
  
  /* Responsive adjustments for different screen sizes */
  @media (min-width: 1600px) {
    .quiz-popup-content {
      width: 1594px;
      height: 889px;
    }
    .quiz-popup-content.quiz-result-mode {
      width: 828px;
      height: 1009px;
    }
  }
  
  @media (max-width: 1600px) {
    .quiz-popup-content {
      width: 95%;
      max-width: 1594px;
      height: auto;
      min-height: 600px;
    }
  }
  
  @media (max-width: 1400px) {
    .quiz-popup-content {
      width: 90%;
      max-width: 1200px;
      height: auto;
      max-height: 90vh;
    }
    .quiz-step {
      padding: 50px 60px 30px;
      gap: 60px;
    }
    .quiz-step-content {
      gap: 60px;
    }
    .quiz-navigation {
      padding: 25px 60px;
    }
  }
  
  @media (max-width: 1200px) {
    .quiz-popup-content {
      width: 95%;
      max-width: 1000px;
    }
    .quiz-step {
      padding: 40px 50px 25px;
      gap: 50px;
    }
    .quiz-step-content {
      gap: 50px;
    }
    .quiz-question-section {
      min-width: 300px;
      max-width: 400px;
    }
  }
  .quiz-popup-close {
    position: absolute;
    top: 15px;
    right: 20px;
    cursor: pointer;
    font-size: 35px;
    line-height: 1;
    z-index: 2;
    color: #888;
    transition: color 0.2s ease;
  }
  .quiz-popup-close:hover {
    color: #000;
  }
  .quiz-steps-container {
    flex: 1;
    overflow: hidden;
    position: relative;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }
  .quiz-step {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 60px 80px 40px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    transform: translateX(20px);
    overflow-y: auto;
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: 80px;
    box-sizing: border-box;
  }
  .quiz-step.active {
    opacity: 1;
    visibility: visible;
    transform: translateX(0);
  }
  .quiz-step.prev {
     transform: translateX(-20px);
  }
  .quiz-step-content {
    display: flex;
    flex-direction: row;
    width: 100%;
    gap: 80px;
    align-items: flex-start;
    position: relative;
  }
  .quiz-question-section {
    flex: 0 0 auto;
    min-width: 350px;
    max-width: 450px;
  }
  .quiz-step h3 {
    font-size: 24px;
    margin: 0;
    font-weight: 600;
    color: #1C2C58;
    text-align: left;
    font-family: "Be Vietnam Pro", sans-serif;
    line-height: 1.4;
  }
  .quiz-answers {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 120px 120px;
    gap: 15px;
    align-items: stretch;
  }
  .quiz-answer {
    padding: 20px 24px;
    border: 1px solid #E0E0E0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 16px;
    text-align: center;
    background: #F5F5F5;
    position: relative;
    height: 120px;
    min-height: 120px;
    max-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
  }
  .quiz-answer:hover {
    border-color: #FCE390;
    background: #FFFEF5;
  }
  .quiz-answer.selected {
    background: #FCE390;
    border-color: #FCE390;
    color: #1C2C58;
    font-weight: 500;
  }
  /* Layout for answers: A top-left, B top-right, C bottom-left */
  .quiz-answer:nth-child(1) {
    grid-column: 1;
    grid-row: 1;
  }
  .quiz-answer:nth-child(2) {
    grid-column: 2;
    grid-row: 1;
  }
  .quiz-answer:nth-child(3) {
    grid-column: 1;
    grid-row: 2;
  }
  .quiz-answer:nth-child(4) {
    grid-column: 2;
    grid-row: 2;
  }
  .quiz-answer-text {
    font-weight: 500;
    margin-bottom: 4px;
    text-align: center;
    line-height: 1.4;
  }
  .quiz-answer-subtitle {
    font-size: 14px;
    color: #666;
    font-weight: 400;
    margin-top: 4px;
    text-align: center;
    line-height: 1.4;
  }
  .quiz-answer.selected .quiz-answer-subtitle {
    color: #1C2C58;
  }
  .quiz-navigation {
    padding: 30px 80px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #eee;
    background: #fff;
    flex-shrink: 0;
  }
  .quiz-continue-btn {
    background: #FCE390;
    color: #1C2C58;
    border: none;
    padding: 12px 32px;
    border-radius: 100px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: "Be Vietnam Pro", sans-serif;
    min-width: 140px;
  }
  .quiz-continue-btn:hover:not(:disabled) {
    background: #FFC700;
    transform: translateY(-1px);
  }
  .quiz-continue-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .quiz-progress-container {
    flex: 1;
    margin-right: 20px;
  }
  .quiz-navigation .quiz-progress-container .quiz-progress-bar {
    width: 100%;
    height: 8px;
    background: #F5F5F5 !important;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    display: block;
  }
  .quiz-navigation .quiz-progress-container .quiz-progress-bar .quiz-progress-bar-inner {
    height: 100% !important;
    width: 0;
    background: #FCE390 !important;
    transition: width 0.4s ease;
    border-radius: 4px;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    z-index: 1;
    display: block !important;
    min-width: 0;
    max-width: 100%;
  }

  /* Result styling */
  .quiz-step[data-step="result"] {
    padding: 60px 80px 40px;
    overflow-y: auto;
  }
  
  /* Mobile padding for result step */
  @media (max-width: 768px) {
    .quiz-step[data-step="result"] {
      padding: 20px 16px 20px;
    }
    .quiz-result-header {
      top: -20px;
      padding-top: 20px;
      margin-top: -20px;
      margin-bottom: 24px;
      padding-bottom: 16px;
    }
  }
  
  @media (max-width: 480px) {
    .quiz-step[data-step="result"] {
      padding: 16px 12px 16px;
    }
    .quiz-result-header {
      top: -16px;
      padding-top: 16px;
      margin-top: -16px;
      margin-bottom: 20px;
      padding-bottom: 12px;
    }
  }
  .quiz-result-content {
    text-align: left;
    padding: 0;
    width: 100%;
  }
  .quiz-result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid #E0E0E0;
    position: sticky;
    top: -60px;
    background: #fff;
    z-index: 10;
    padding-top: 60px;
    margin-top: -60px;
  }
  .quiz-result-title {
    font-size: 28px;
    font-weight: 600;
    color: #1C2C58;
    margin: 0;
    font-family: "Be Vietnam Pro", sans-serif;
  }
  .quiz-retry-btn--header {
    padding: 12px 32px;
    background: #FCE390;
    color: #1C2C58;
    border: none;
    border-radius: 100px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: "Be Vietnam Pro", sans-serif;
  }
  .quiz-retry-btn--header:hover {
    background: #FFC700;
    transform: translateY(-1px);
  }
  .quiz-result-products {
    display: flex !important;
    flex-direction: column !important;
    gap: 30px;
    width: 100%;
    grid-template-columns: none !important;
    grid-template-rows: none !important;
  }
  .quiz-result-section {
    display: flex !important;
    flex-direction: column !important;
    gap: 20px;
    width: 100% !important;
    max-width: 100% !important;
    flex: 0 0 auto !important;
  }
  .quiz-result-section-header {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 0;
  }
  .quiz-result-section--comprehensive .quiz-result-section-header {
    background: #1C2C58;
    color: #fff;
  }
  .quiz-result-section--optimal .quiz-result-section-header {
    background: #E8F0FE;
    color: #1C2C58;
  }
  .quiz-result-section--priority .quiz-result-section-header {
    background: #234085;
    color: #fff;
  }
  .quiz-result-section--suitable .quiz-result-section-header {
    background: #F5F5F5;
    color: #1C2C58;
  }
  .quiz-result-section-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    font-family: "Be Vietnam Pro", sans-serif;
  }
  .quiz-result-section-reason {
    font-size: 16px;
    font-weight: 400;
    line-height: 1.5;
    font-family: "Be Vietnam Pro", sans-serif;
  }
  .quiz-result-cc-card {
    width: 100% !important;
    max-width: 100% !important;
    flex: 0 0 auto !important;
  }
  
  /* Import cc-card styles from collection - Horizontal layout for results */
  .quiz-result-content .cc-card {
    display: flex !important;
    flex-direction: row !important;
    gap: 24px;
    align-items: stretch;
    width: 100% !important;
    max-width: 100% !important;
  }
  .quiz-result-content .cc-image-container {
    position: relative;
    width: 380px;
    max-width: 380px;
    min-width: 380px;
    height: 284px;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: 8px;
  }
  .quiz-result-content .cc-image {
    display: block;
    width: 100%;
    height: 100%;
  }
  .quiz-result-content .cc-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .quiz-result-content .cc-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0;
    height: 284px;
    min-height: 284px;
    justify-content: flex-start;
    overflow: visible;
    margin: 0;
    padding: 0;
  }
  .quiz-result-content .cc-rating {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    padding: 0;
    flex-shrink: 0;
  }
  .quiz-result-content .cc-stars {
    display: flex;
    gap: 2px;
  }
  .quiz-result-content .cc-star {
    color: #FCE390;
    font-size: 20px;
  }
  .quiz-result-content .cc-rating-text {
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: 14px;
    color: #000;
  }
  .quiz-result-content .cc-title {
    margin: 0;
    padding: 0;
    flex-shrink: 0;
  }
  .quiz-result-content .cc-title a {
    color: #000;
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: 20px;
    font-weight: 500;
    line-height: 27px;
    letter-spacing: 0.6px;
    text-decoration: none;
  }
  .quiz-result-content .cc-title a:hover {
    color: #3264E0;
  }
  .quiz-result-content .cc-description {
    color: #000;
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: 16px;
    font-weight: 400;
    letter-spacing: 0.6px;
    margin: 0;
    padding: 0;
    line-height: 1.5;
    flex: 1;
    overflow: visible;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    text-overflow: ellipsis;
    max-height: 60px;
  }
  .quiz-result-content .cc-price-row {
    display: flex;
    align-items: center;
    gap: 0;
    margin: 0;
    padding: 0;
    flex-shrink: 0;
  }
  .quiz-result-content .cc-price {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .quiz-result-content .cc-price__current {
    color: #000;
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: 20px;
    font-weight: 600;
    line-height: 27px;
    letter-spacing: 0.6px;
  }
  .quiz-result-content .cc-price__discount {
    background: #FCE390;
    color: #1C2C58;
    padding: 0px 8px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    font-family: "Be Vietnam Pro", sans-serif;
  }
  .quiz-result-content .cc-compare-price-container {
    margin: 0;
    padding: 0;
    flex-shrink: 0;
  }
  .quiz-result-content .cc-compare-price {
    color: #999;
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: 18px;
    text-decoration: line-through;
  }
  .quiz-result-content .cc-compare-price--empty {
    display: none;
  }
  .quiz-result-content .cc-actions {
    margin: 0;
    padding: 0;
    flex-shrink: 0;
    margin-top: auto;
  }
  .quiz-result-content .cc-buy-now {
    background: #234085;
    color: #fff;
    border: none;
    padding: 12px 32px;
    border-radius: 100px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: "Be Vietnam Pro", sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.5;
    min-height: 44px;
  }
  .quiz-result-content .cc-buy-now:hover {
    background: #3a4c7a;
    transform: translateY(-1px);
  }
  .quiz-result-content .cc-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 4px 8px;
    border-radius: 6px;
    font-family: "Be Vietnam Pro", sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: #fff;
    z-index: 2;
  }
  .quiz-result-content .cc-badge--top-rated {
    background: #3264E0;
  }
  .quiz-result-content .cc-badge--best-seller {
    background: #234085;
  }
  .quiz-result-content .cc-badge--new {
    background: #234085;
  }
  
  @media (max-width: 1400px) {
    .quiz-popup-content.quiz-result-mode {
      width: 95%;
      max-width: 828px;
      height: auto;
      min-height: 600px;
    }
  }
  
  /* Ensure vertical layout at all screen sizes */
  @media (min-width: 769px) {
    .quiz-result-products {
      display: flex !important;
      flex-direction: column !important;
      grid-template-columns: none !important;
    }
    .quiz-result-section {
      width: 100% !important;
      max-width: 100% !important;
    }
  }
  
  /* Mobile and Tablet - Horizontal layout (≤ 1024px) */
  @media (max-width: 1024px) {
    .quiz-popup-content.quiz-result-mode {
      width: 95%;
      max-width: 100%;
      height: auto;
    }
    .quiz-result-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 20px;
    }
    .quiz-result-title {
      font-size: 24px;
    }
    .quiz-result-products {
      display: flex !important;
      flex-direction: column !important;
    }
    /* Keep horizontal layout for mobile - image left, content right */
    .quiz-result-content .cc-card {
      flex-direction: row !important;
      gap: 16px;
      align-items: flex-start;
    }
    .quiz-result-content .cc-image-container {
      width: 140px !important;
      min-width: 140px !important;
      max-width: 140px !important;
      height: 140px !important;
      flex-shrink: 0;
    }
    .quiz-result-content .cc-content {
      flex: 1;
      height: 140px !important;
      min-height: 140px !important;
      gap: 0;
      margin: 0;
      padding: 0;
    }
    
    /* Mobile font sizes */
    .quiz-result-content .cc-title a {
      font-size: 20px;
      line-height: 1.3;
    }
    .quiz-result-content .cc-description {
      display: none !important;
    }
    .quiz-result-content .cc-price__current {
      font-size: 14px;
      line-height: 1.3;
    }
    .quiz-result-content .cc-compare-price {
      font-size: 12px;
    }
    .quiz-result-content .cc-rating-text {
      font-size: 12px;
    }
    .quiz-result-content .cc-star {
      font-size: 14px;
    }
    .quiz-result-section-title {
      font-size: 16px;
    }
    .quiz-result-section-reason {
      font-size: 14px;
    }
    .quiz-result-content .cc-buy-now {
      font-size: 14px;
      padding: 10px 20px;
      width: 100%;
      margin: 0;
    }
    .quiz-result-content .cc-price-row {
      flex-wrap: wrap;
      gap: 4px;
      margin: 0;
      padding: 0;
    }
    .quiz-result-content .cc-actions {
      margin: 0;
      padding: 0;
      width: 100%;
    }
  }

  @media (min-width: 768px) {
    .quiz-result-products {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  @media (max-width: 768px) {
    .quiz-step {
      padding: 40px 30px 20px;
      flex-direction: column;
      gap: 30px;
    }
    .quiz-step-content {
      flex-direction: column;
      gap: 30px;
    }
    .quiz-question-section {
      min-width: 100%;
      max-width: 100%;
    }
    .quiz-answers {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
      width: 100%;
    }
    .quiz-answer:nth-child(1),
    .quiz-answer:nth-child(2),
    .quiz-answer:nth-child(3),
    .quiz-answer:nth-child(4) {
      grid-column: 1;
      grid-row: auto;
    }
    .quiz-navigation {
      padding: 15px 30px;
      flex-direction: column;
      gap: 15px;
    }
    .quiz-continue-btn {
      width: 100%;
      margin-left: 0;
    }
    .quiz-progress-container {
      margin-right: 0;
      width: 100%;
    }
    .quiz-result-product {
      flex-direction: column;
    }
    .quiz-result-product img {
      width: 100%;
      height: auto;
    }
  }
</style>

<div class="index-section quiz-banner-section" data-section-id="{{ section.id }}" style="margin-top: 0px !important;">
  <div class="page-width">
    <div class="quiz-banner-container">
      <div class="quiz-banner-left">
        <!-- Desktop Image -->
        {%- if section.settings.image != blank -%}
          <img 
            class="desktop-image"
            src="{{ section.settings.image | image_url: width: 1000 }}" 
            alt="{{ section.settings.title | escape }}"
            width="499"
            height="348"
            loading="lazy">
        {%- else -%}
          {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
        {%- endif -%}
        
        <!-- Mobile Image -->
        {%- if section.settings.mobile_image != blank -%}
          <img 
            class="mobile-image"
            src="{{ section.settings.mobile_image | image_url: width: 634 }}" 
            alt="{{ section.settings.title | escape }}"
            width="634"
            height="441"
            loading="lazy">
        {%- elsif section.settings.image != blank -%}
          <img 
            class="mobile-image"
            src="{{ section.settings.image | image_url: width: 634 }}" 
            alt="{{ section.settings.title | escape }}"
            width="634"
            height="441"
            loading="lazy">
        {%- endif -%}
      </div>
      <div class="quiz-banner-right">
        {%- if section.settings.title != blank -%}
          <h2 class="quiz-banner-title">
            {{ section.settings.title | escape }}
          </h2>
        {%- endif -%}
        {%- if section.settings.text != blank -%}
          <div class="quiz-banner-subtitle rte">{{ section.settings.text }}</div>
        {%- endif -%}
        <!-- Desktop buttons - inside quiz-banner-right -->
        <div class="quiz-banner-buttons desktop-buttons">
          {%- if section.settings.button_1_text != blank -%}
            <button type="button" class="quiz-btn quiz-start-button">
              {{ section.settings.button_1_text }}
            </button>
          {%- endif -%}
          {%- if section.settings.button_2_text != blank and section.settings.button_2_link != blank -%}
            <a href="{{ section.settings.button_2_link }}" class="quiz-btn">
              {{ section.settings.button_2_text }}
            </a>
          {%- endif -%}
        </div>
      </div>
      <!-- Mobile buttons - outside quiz-banner-right, below image -->
      <div class="quiz-banner-buttons mobile-buttons">
        {%- if section.settings.button_1_text != blank -%}
          <button type="button" class="quiz-btn quiz-start-button">
            {{ section.settings.button_1_text }}
          </button>
        {%- endif -%}
        {%- if section.settings.button_2_text != blank and section.settings.button_2_link != blank -%}
          <a href="{{ section.settings.button_2_link }}" class="quiz-btn">
            {{ section.settings.button_2_text }}
          </a>
        {%- endif -%}
      </div>
    </div>
  </div>
</div>

<div id="quiz-popup-{{ section.id }}" class="quiz-popup-overlay">
  <div class="quiz-popup-content">
    <span class="quiz-popup-close">&times;</span>
    <div class="quiz-steps-container">
      {%- for i in (1..7) -%}
        {%- capture question_title_key -%}q_{{ i }}_title{%- endcapture -%}
        {%- assign question_title = section.settings[question_title_key] -%}

        <div class="quiz-step" data-step="{{ i }}">
            <div class="quiz-step-content">
                <div class="quiz-question-section">
                    <h3>{{ question_title }}</h3>
                </div>
                <div class="quiz-answers">
                    {%- for j in (1..4) -%}
                        {%- capture answer_text_key -%}q_{{ i }}_a_{{ j }}_text{%- endcapture -%}
                        {%- capture answer_subtitle_key -%}q_{{ i }}_a_{{ j }}_subtitle{%- endcapture -%}
                        {%- capture answer_value_key -%}q_{{ i }}_a_{{ j }}_value{%- endcapture -%}
                        {%- assign answer_text = section.settings[answer_text_key] -%}
                        {%- assign answer_subtitle = section.settings[answer_subtitle_key] -%}
                        {%- assign answer_value = section.settings[answer_value_key] -%}

                        {%- if answer_text != blank -%}
                            <div class="quiz-answer" data-question="{{ i }}" data-value="{{ answer_value | escape }}">
                                <div class="quiz-answer-text">{{ answer_text }}</div>
                                {%- if answer_subtitle != blank -%}
                                    <div class="quiz-answer-subtitle">{{ answer_subtitle }}</div>
                                {%- endif -%}
                            </div>
                        {%- endif -%}
                    {%- endfor -%}
                </div>
            </div>
        </div>
      {%- endfor -%}

      <!-- Result Step -->
      <div class="quiz-step" data-step="result">
        <div id="quiz-result-content-{{ section.id }}" class="quiz-result-content">
          <!-- Recommended products will be injected here by JS -->
        </div>
      </div>
    </div>

    <div class="quiz-navigation">
        <div class="quiz-progress-container">
            <div class="quiz-progress-bar">
                <div class="quiz-progress-bar-inner" id="quiz-progress-bar-inner-{{ section.id }}"></div>
            </div>
        </div>
        <button type="button" class="quiz-continue-btn" id="quiz-continue-btn-{{ section.id }}" disabled>TIẾP TỤC</button>
    </div>
  </div>
</div>

{%- capture product_results -%}
  {%- for block in section.blocks -%}
    {%- if block.type == 'product_result' and block.settings.product != blank -%}
      {%- assign product = block.settings.product -%}
      {
        "product_id": "{{ product.id }}",
        "title": "{{ product.title | escape }}",
        "url": "{{ product.url }}",
        "image": "{{ product.featured_image | image_url: width: 760 }}",
        "price": {{ product.price }},
        "price_formatted": "{{ product.price | money }}",
        "compare_at_price": {{ product.compare_at_price | default: 0 }},
        "compare_at_price_formatted": "{{ product.compare_at_price | money }}",
        "handle": "{{ product.handle }}",
        "rating": {{ product.metafields.reviews.rating.value | default: 5 }},
        "rating_count": {{ product.metafields.reviews.rating_count | default: 0 }},
        "description": {{ product.description | strip_html | truncate: 100 | json }},
        "subdes": {{ product.metafields.custom.subdes.value | default: "" | json }},
        "tags": {{ product.tags | json }},
        "order": {{ block.settings.order | default: 999 }},
        "result_reason": {{ block.settings.result_reason | default: "Sản phẩm phù hợp với nhu cầu của bạn" | json }},
        "result_type": "{{ block.settings.result_type | default: 'comprehensive' }}",
        "condition_answers": "{{ block.settings.condition_answers | default: '' }}"
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endif -%}
  {%- endfor -%}
{%- endcapture -%}
<script type="application/json" id="quiz-products-{{ section.id }}">
  [{{ product_results }}]
</script>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const popup = document.getElementById(`quiz-popup-${sectionId}`);
  const closeBtn = popup?.querySelector('.quiz-popup-close');
  const startButtons = document.querySelectorAll(`.quiz-start-button`);
  const continueBtn = document.getElementById(`quiz-continue-btn-${sectionId}`);
  const progressBar = document.getElementById(`quiz-progress-bar-inner-${sectionId}`);
  const resultContent = document.getElementById(`quiz-result-content-${sectionId}`);
  
  let currentStep = 1;
  const totalSteps = 7;
  let answers = {};
  
  // Product handle mapping - map various handle formats to standard handles
  const productHandleMap = {
    // Original and Original Lite are the same product
    'foam-original': 'foam-original',
    'nem-original': 'foam-original',
    'original': 'foam-original',
    'original-lite': 'foam-original',
    'nem-original-lite': 'foam-original',
    // Nest
    'foam-nest': 'foam-nest',
    'nest': 'foam-nest',
    'nem-nest': 'foam-nest',
    // Hybrid
    'nem-hybrid': 'nem-hybrid',
    'hybrid': 'nem-hybrid',
    // Original Pro
    'nem-original-pro': 'nem-original-pro',
    'original-pro': 'nem-original-pro',
    'nem-original-pro-firm': 'nem-original-pro',
    // Toppers
    'nem-cuon-foam-topper': 'nem-cuon-foam-topper',
    'topper-foam': 'nem-cuon-foam-topper',
    'mate_topper219071626': 'mate_topper219071626',
    'topper-mate': 'mate_topper219071626',
    'may_topper218298303-1': 'may_topper218298303-1'
  };
  
  // Function to normalize product handle
  function normalizeHandle(handle) {
    if (!handle) return handle;
    const normalized = handle.toLowerCase().trim();
    return productHandleMap[normalized] || normalized;
  }
  
  // Product mapping based on customer profiles (fallback logic)
  const productMapping = {
    // Profile 1: Người Thích Cứng / Quen Nệm Bông Ép
    profile1: {
      conditions: {
        q3: ['A'], // Quen cứng
        q4: ['A'], // Thích Firm
        q1: ['B', 'C'] // Trung/Nặng
      },
      products: [
        { handle: 'foam-nest', reason: 'Lựa chọn phù hợp: Nệm có độ cứng cao, mặt phẳng vững chãi giống nệm bông ép nhưng có lớp foam trên cùng giúp êm điểm tiếp xúc, không đau xương.' },
        { handle: 'nem-original-pro', reason: 'Lựa chọn tối ưu: Nệm có thêm tính năng mát lạnh (Cooling) + Zoning nâng đỡ, giải pháp toàn diện cho giấc ngủ nếu có ngân sách tốt hơn.' }
      ]
    },
    // Profile 2: Người Đau Lưng & Máu Nóng (Trị liệu)
    profile2: {
      conditions: {
        q5: ['A', 'B'], // Đau (A) hoặc Nóng (B)
        q7: ['A'] // Premium
      },
      products: [
        { handle: 'nem-original-pro', reason: 'Lựa chọn toàn diện: Nệm có thiết kế zoning nâng đỡ 3 vùng giảm đau lưng + Graphene tản nhiệt cực nhanh.' },
        { handle: 'nem-hybrid', reason: 'Lựa chọn phù hợp: Nệm thoáng khí kiểu lò xo túi đem lại cảm giác nảy hơn là foam thuần.' }
      ]
    },
    // Profile 3: Cặp Đôi Trẻ / Thích "Hotel Feel"
    profile3: {
      conditions: {
        q2: ['B'], // Cặp đôi
        q4: ['C'], // Thích nảy
        q5: ['D'] // Nâng cấp
      },
      products: [
        { handle: 'nem-hybrid', reason: 'Lựa chọn ưu tiên: Nệm có lò xo túi độc lập giúp nệm nảy nhẹ, sang trọng, viền cứng cáp an toàn.' },
        { handle: 'foam-original', reason: 'Lựa chọn tiết kiệm: Nệm ở phân khúc giá tiết kiệm hơn nhưng vẫn muốn độ nảy nhẹ và bề mặt vững chãi.' }
      ]
    },
    // Profile 4: Người Nhẹ Cân / Ngủ Nghiêng
    profile4: {
      conditions: {
        q1: ['A'], // Nhẹ cân
        q6: ['B'], // Nghiêng
        q4: ['B'] // Thích êm
      },
      products: [
        { handle: 'foam-original', reason: 'Lựa chọn phù hợp: Nệm có độ mềm lý tưởng để người nhẹ cân có thể "lún" xuống, giảm áp lực lên vai và hông khi nằm nghiêng.' },
        { handle: 'foam-original', reason: 'Lựa chọn tiết kiệm: Bản dupe hoàn hảo với chi phí tiết kiệm hơn, vẫn giữ độ êm (softness) tương tự.' }
      ]
    },
    // Profile 5: Gia Đình Có Con Nhỏ (Co-sleeping)
    profile5: {
      conditions: {
        q2: ['C'], // Gia đình
        q5: ['C'] // Dễ tỉnh giấc
      },
      products: [
        { handle: 'nem-original-pro', reason: 'Lựa chọn ưu tiên: Nệm có khả năng cách ly chuyển động tốt nhất (Zero motion transfer), thêm tính năng mát lạnh (Cooling) + Zoning nâng đỡ.' },
        { handle: 'foam-nest', reason: 'Lựa chọn tối ưu: Nệm có bề mặt cứng hơn và ngân sách ở mức vừa phải.' }
      ]
    },
    // Profile 6: Người Nặng Cân (>80kg)
    profile6: {
      conditions: {
        q1: ['C'], // Nặng cân
        q5: ['A'] // Đau lưng
      },
      products: [
        { handle: 'nem-hybrid', reason: 'Lựa chọn toàn diện: Nệm có hệ thống lò xo túi kết hợp foam đáy chịu lực rất tốt cho người có trọng lượng lớn.' },
        { handle: 'nem-original-pro', reason: 'Lựa chọn phù hợp: Nệm có công nghệ Graphene tản nhiệt đem lại cảm giác mát lạnh kết hợp với thiết kế 3 vùng chuyên biệt nâng đỡ thắt lưng' }
      ]
    },
    // Profile 7: Sinh Viên / Thuê Nhà / Guest Room
    profile7: {
      conditions: {
        q7: ['C'], // Tiết kiệm
        q3: ['D'] // Ngủ lung tung
      },
      products: [
        { handle: 'nem-cuon-foam-topper', reason: 'Lựa chọn ưu tiên: Topper có kích thước gọn nhẹ, dễ dàng cất đi, dễ vận chuyển lên gác/chung cư, giá tốt nhất mà vẫn chuẩn chất lượng Ru9.' },
        { handle: 'mate_topper219071626', reason: 'Lựa chọn tiết kiệm: Topper trải trên nệm cũ là giải pháp "cứu cánh" tiết kiệm nhất nếu chỉ cần làm mềm mặt.' }
      ]
    }
  };
  
  // Get products data
  const productsData = JSON.parse(document.getElementById(`quiz-products-${sectionId}`)?.textContent || '[]');
  const productsByHandle = {};
  productsData.forEach(p => {
    // Normalize handle and store with both original and normalized
    const normalizedHandle = normalizeHandle(p.handle);
    productsByHandle[p.handle] = p;
    if (normalizedHandle !== p.handle) {
      productsByHandle[normalizedHandle] = p;
    }
  });
  
  // Initialize quiz
  function initQuiz() {
    if (!popup) return;
    
    // Open popup
    startButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        popup.style.display = 'flex';
        currentStep = 1;
        answers = {};
        // Reset progress bar
        if (progressBar) {
          progressBar.style.setProperty('width', '0%', 'important');
          progressBar.style.setProperty('min-width', '0', 'important');
        }
        // Clear all selected answers
        const allAnswers = popup.querySelectorAll('.quiz-answer');
        allAnswers.forEach(answer => {
          answer.classList.remove('selected');
        });
        updateStep();
      });
    });
    
    // Close popup
    closeBtn?.addEventListener('click', () => {
      popup.style.display = 'none';
    });
    
    popup.addEventListener('click', (e) => {
      if (e.target === popup) {
        popup.style.display = 'none';
      }
    });
    
    // Answer selection
    const answerElements = popup.querySelectorAll('.quiz-answer');
    answerElements.forEach(answer => {
      answer.addEventListener('click', function() {
        const question = parseInt(this.dataset.question);
        const value = this.dataset.value;
        
        // Remove selection from other answers in same question
        const questionAnswers = popup.querySelectorAll(`.quiz-answer[data-question="${question}"]`);
        questionAnswers.forEach(a => a.classList.remove('selected'));
        
        // Select this answer
        this.classList.add('selected');
        answers[question] = value;
        
        // Enable continue button
        if (continueBtn) {
          continueBtn.disabled = false;
        }
      });
    });
    
    // Continue button
    continueBtn?.addEventListener('click', () => {
      if (currentStep < totalSteps) {
        currentStep++;
        updateStep();
      } else {
        showResults();
      }
    });
    
    // Initialize first step
    updateStep();
  }
  
  function updateStep() {
    // Hide all steps
    const steps = popup.querySelectorAll('.quiz-step');
    steps.forEach(step => {
      step.classList.remove('active', 'prev');
    });
    
    // Show current step
    const currentStepEl = popup.querySelector(`.quiz-step[data-step="${currentStep}"]`);
    if (currentStepEl) {
      currentStepEl.classList.add('active');
    }
    
    // Update progress - calculate based on current step
    if (progressBar) {
      // Progress should be: (currentStep / totalSteps) * 100
      // For step 1: (1/7) * 100 = 14.29%
      // For step 2: (2/7) * 100 = 28.57%
      // etc.
      const progress = Math.round((currentStep / totalSteps) * 100 * 100) / 100; // Round to 2 decimals
      // Remove any existing width styles first
      progressBar.style.removeProperty('width');
      progressBar.style.removeProperty('min-width');
      progressBar.style.removeProperty('max-width');
      // Set new width
      progressBar.style.width = progress + '%';
      progressBar.style.minWidth = '0';
      progressBar.style.maxWidth = '100%';
      // Force reflow to ensure style is applied
      progressBar.offsetHeight;
    }
    
    // Update continue button
    if (continueBtn) {
      const hasAnswer = answers[currentStep] !== undefined;
      continueBtn.disabled = !hasAnswer;
      if (currentStep === totalSteps) {
        continueBtn.textContent = 'XEM KẾT QUẢ';
      } else {
        continueBtn.textContent = 'TIẾP TỤC';
      }
    }
  }
  
  // Function to check if condition answers match user answers
  // Format: "3A,4A,1B|C" means Q3=A AND Q4=A AND (Q1=B OR Q1=C)
  function checkConditionAnswers(conditionAnswers, userAnswers) {
    // If no condition, always match
    if (!conditionAnswers || conditionAnswers.trim() === '') {
      return true;
    }
    
    // Split by comma to get individual conditions
    const conditions = conditionAnswers.trim().split(',').map(c => c.trim()).filter(c => c !== '');
    
    // Check all conditions (AND logic)
    for (const condition of conditions) {
      // Parse condition: format is "1A", "2B|C", etc.
      // Check if it has OR operator (|)
      if (condition.includes('|')) {
        // Multiple answers for same question (OR logic)
        const parts = condition.split('|');
        if (parts.length < 2) continue;
        
        // Extract question number from first part
        const firstPart = parts[0].trim();
        const match = firstPart.match(/^(\d+)([A-D])$/i);
        if (!match) continue;
        
        const questionNum = parseInt(match[1]);
        const userAnswer = userAnswers[questionNum];
        
        // Check if user answer matches any of the options
        let matches = false;
        for (const part of parts) {
          const partTrimmed = part.trim();
          // Check if part has question number or just answer
          const partMatch = partTrimmed.match(/^(\d+)?([A-D])$/i);
          if (partMatch) {
            const expectedAnswer = partMatch[2].toUpperCase();
            if (userAnswer && userAnswer.toUpperCase() === expectedAnswer) {
              matches = true;
              break;
            }
          }
        }
        
        if (!matches) {
          return false; // This condition doesn't match
        }
      } else {
        // Single answer condition
        const match = condition.match(/^(\d+)([A-D])$/i);
        if (!match) continue;
        
        const questionNum = parseInt(match[1]);
        const expectedAnswer = match[2].toUpperCase();
        const userAnswer = userAnswers[questionNum];
        
        // If user answer doesn't match, condition fails
        if (!userAnswer || userAnswer.toUpperCase() !== expectedAnswer) {
          return false;
        }
      }
    }
    
    // All conditions matched
    return true;
  }
  
  function showResults() {
    // Priority 1: Use products from blocks - filter by condition answers
    const productsData = JSON.parse(document.getElementById(`quiz-products-${sectionId}`)?.textContent || '[]');
    const productsByHandle = {};
    productsData.forEach(p => {
      productsByHandle[p.handle] = p;
    });
    
    let productsToRender = productsData.map(productData => {
      // Check condition answers if set
      const conditionAnswers = productData.condition_answers || '';
      
      // If condition is set, check if it matches
      if (conditionAnswers.trim() !== '') {
        const matches = checkConditionAnswers(conditionAnswers, answers);
        // If condition doesn't match, skip this product
        if (!matches) {
          return null;
        }
      }
      
      return {
        handle: productData.handle,
        reason: productData.result_reason || 'Sản phẩm phù hợp với nhu cầu của bạn',
        result_type: productData.result_type || 'comprehensive',
        order: productData.order !== undefined ? productData.order : 999,
        data: productData
      };
    }).filter(p => p !== null && p.data);
    
    // If no products from blocks match, use fallback logic
    if (productsToRender.length === 0) {
      // Determine profile based on answers
      let matchedProfile = null;
      let matchedProducts = [];
      
      // Check each profile - need ALL conditions to match
      for (const [profileKey, profile] of Object.entries(productMapping)) {
        let allConditionsMatch = true;
        
        for (const [question, values] of Object.entries(profile.conditions)) {
          const qNum = parseInt(question.replace('q', ''));
          const answer = answers[qNum];
          
          // Check if answer matches any of the required values (OR condition)
          if (!answer || !values.includes(answer)) {
            allConditionsMatch = false;
            break;
          }
        }
        
        // If all conditions match, use this profile (first match wins)
        if (allConditionsMatch) {
          matchedProfile = profileKey;
          matchedProducts = profile.products;
          break;
        }
      }
      
      // Default products if no profile matches
      if (!matchedProfile || matchedProducts.length === 0) {
        matchedProducts = [
          { handle: 'foam-original', reason: 'Sản phẩm phù hợp nhất với nhu cầu của bạn.' },
          { handle: 'foam-nest', reason: 'Lựa chọn tiết kiệm với chất lượng tốt.' }
        ];
      }
      
      // Map matched products with block data
      productsToRender = matchedProducts.map(product => {
        // Try to find product by normalized handle
        const normalizedHandle = normalizeHandle(product.handle);
        const productData = productsByHandle[normalizedHandle] || productsByHandle[product.handle];
        if (productData) {
          return {
            handle: productData.handle || normalizedHandle, // Use actual handle from data
            reason: productData.result_reason || product.reason || 'Sản phẩm phù hợp với nhu cầu của bạn',
            result_type: productData.result_type || 'comprehensive',
            order: productData.order !== undefined ? productData.order : 999,
            data: productData
          };
        }
        return null;
      }).filter(p => p !== null);
    }
    
    // Sort logic:
    // 1. Priority based on result_type: comprehensive > optimal > priority > suitable
    // 2. Then by order field
    const typePriority = {
      'comprehensive': 2,
      'optimal': 4,
      'priority': 1,
      'suitable': 3
    };
    
    productsToRender.sort((a, b) => {
      const typeA = typePriority[a.result_type] || 99;
      const typeB = typePriority[b.result_type] || 99;
      
      if (typeA !== typeB) {
        return typeA - typeB;
      }
      
      return (a.order || 999) - (b.order || 999);
    });
    
    // Limit to maximum 2 products
    productsToRender = productsToRender.slice(0, 2);
    
    // Render results
    if (resultContent) {
      const sectionTitles = {
        'comprehensive': 'Lựa chọn toàn diện',
        'optimal': 'Lựa chọn tối ưu',
        'priority': 'Lựa chọn ưu tiên',
        'suitable': 'Lựa chọn phù hợp'
      };
      const sectionClasses = {
        'comprehensive': 'quiz-result-section--comprehensive',
        'optimal': 'quiz-result-section--optimal',
        'priority': 'quiz-result-section--priority',
        'suitable': 'quiz-result-section--suitable'
      };
      
      let html = '<div class="quiz-result-header">';
      html += '<h2 class="quiz-result-title">Ru9 gợi ý chiếc nệm phù hợp với bạn</h2>';
      html += '<button type="button" class="quiz-retry-btn quiz-retry-btn--header" id="quiz-retry-btn-' + sectionId + '">THỬ LẠI</button>';
      html += '</div>';
      
      html += '<div class="quiz-result-products">';
      let renderedCount = 0;
      
      productsToRender.forEach((product, index) => {
        if (renderedCount >= 2) return; // Only show 2 products max
        
        // Normalize handle for lookup
        const normalizedHandle = normalizeHandle(product.handle);
        const productData = productsByHandle[normalizedHandle] || productsByHandle[product.handle] || product.data;
        if (productData) {
          // Calculate discount
          const price = productData.price || 0;
          const comparePrice = productData.compare_at_price || 0;
          const hasDiscount = comparePrice > 0 && comparePrice > price;
          const discountPercent = hasDiscount ? Math.round(((comparePrice - price) / comparePrice) * 100) : 0;
          
          // Use formatted prices from Liquid
          const priceFormatted = productData.price_formatted || '0 VNĐ';
          const comparePriceFormatted = productData.compare_at_price_formatted || '';
          
          // Check for badges
          const tags = productData.tags || [];
          const isTopRated = tags.some(tag => tag.toLowerCase().includes('top-rated') || tag.toLowerCase().includes('top rated'));
          const isBestSeller = tags.some(tag => tag.toLowerCase().includes('best-seller') || tag.toLowerCase().includes('best seller'));
          const isNew = tags.some(tag => tag.toLowerCase().includes('new'));
          
          // Get rating
          const rating = productData.rating || 5;
          const ratingCount = productData.rating_count || 0;
          
          // Get description
          const description = productData.subdes || productData.description || 'Sản phẩm chất lượng cao với thiết kế hiện đại, phù hợp cho mọi không gian sống.';
          
          const resultType = product.result_type || 'comprehensive';
          html += `<div class="quiz-result-section ${sectionClasses[resultType]}">`;
          
          // Section header
          html += `<div class="quiz-result-section-header">`;
          html += `<div class="quiz-result-section-title">${sectionTitles[resultType]}:</div>`;
          html += `<div class="quiz-result-section-reason">${product.reason}</div>`;
          html += `</div>`;
          
          // Product card using cc-card structure
          html += `<div class="cc-card quiz-result-cc-card">`;
          
          // Image container
          html += `<div class="cc-image-container">`;
          html += `<a class="cc-image" href="${productData.url}" aria-label="${productData.title}">`;
          html += `<img src="${productData.image}" alt="${productData.title}" loading="lazy">`;
          html += `</a>`;
          
          // Badges - Only show if explicitly needed (prioritize Top rated > Best Seller > New)
          // Hide New badge for quiz results unless specifically required
          if (isTopRated) {
            html += `<div class="cc-badge cc-badge--top-rated">Top rated</div>`;
          } else if (isBestSeller) {
            html += `<div class="cc-badge cc-badge--best-seller">Best Seller</div>`;
          }
          // Removed New badge display for quiz results
          html += `</div>`;
          
          // Content
          html += `<div class="cc-content">`;
          
          // Rating
          html += `<div class="cc-rating">`;
          html += `<div class="cc-stars">`;
          for (let i = 0; i < 5; i++) {
            html += `<span class="cc-star">★</span>`;
          }
          html += `</div>`;
          if (ratingCount > 0) {
            html += `<span class="cc-rating-text">${rating.toFixed(1)} (${ratingCount} đánh giá)</span>`;
          }
          html += `</div>`;
          
          // Title
          html += `<h3 class="cc-title">`;
          html += `<a href="${productData.url}">${productData.title}</a>`;
          html += `</h3>`;
          
          // Description
          html += `<div class="cc-description">${description}</div>`;
          
          // Price row
          html += `<div class="cc-price-row">`;
          html += `<div class="cc-price">`;
          html += `<span class="cc-price__current">Từ ${priceFormatted}</span>`;
          if (hasDiscount) {
            html += `<div class="cc-price__discount">-${discountPercent}%</div>`;
          }
          html += `</div>`;
          html += `</div>`;
          
          // Compare price
          html += `<div class="cc-compare-price-container">`;
          if (hasDiscount && comparePriceFormatted) {
            html += `<div class="cc-compare-price">${comparePriceFormatted}</div>`;
          } else {
            html += `<div class="cc-compare-price cc-compare-price--empty"></div>`;
          }
          html += `</div>`;
          
          // Actions
          html += `<div class="cc-actions">`;
          html += `<button class="cc-buy-now" type="button" onclick="window.location.href='${productData.url}'">Mua ngay</button>`;
          html += `</div>`;
          
          html += `</div>`; // End cc-content
          html += `</div>`; // End cc-card
          html += `</div>`; // End quiz-result-section
          
          renderedCount++;
        }
      });
      
      html += '</div>';
      resultContent.innerHTML = html;
      
      // Add retry button event listener
      const retryBtn = document.getElementById(`quiz-retry-btn-${sectionId}`);
      if (retryBtn) {
        retryBtn.addEventListener('click', resetQuiz);
      }
    }
    
    // Show result step
    const steps = popup.querySelectorAll('.quiz-step');
    steps.forEach(step => {
      step.classList.remove('active', 'prev');
    });
    
    const resultStep = popup.querySelector('.quiz-step[data-step="result"]');
    if (resultStep) {
      resultStep.classList.add('active');
    }
    
    // Add result mode class to resize popup
    const popupContent = popup.querySelector('.quiz-popup-content');
    if (popupContent) {
      popupContent.classList.add('quiz-result-mode');
    }
    
    // Hide continue button on results
    if (continueBtn) {
      continueBtn.style.display = 'none';
    }
    
    // Update progress to 100%
    if (progressBar) {
      progressBar.style.setProperty('width', '100%', 'important');
    }
  }
  
  // Reset quiz function
  function resetQuiz() {
    // Reset answers
    answers = {};
    currentStep = 1;
    
    // Remove result mode class to restore original size
    const popupContent = popup.querySelector('.quiz-popup-content');
    if (popupContent) {
      popupContent.classList.remove('quiz-result-mode');
    }
    
    // Reset progress bar
    if (progressBar) {
      progressBar.style.setProperty('width', '0%', 'important');
      progressBar.style.setProperty('min-width', '0', 'important');
    }
    
    // Clear all selected answers
    const allAnswers = popup.querySelectorAll('.quiz-answer');
    allAnswers.forEach(answer => {
      answer.classList.remove('selected');
    });
    
    // Show first step
    updateStep();
    
    // Show continue button again
    if (continueBtn) {
      continueBtn.style.display = 'block';
      continueBtn.disabled = true;
      continueBtn.textContent = 'TIẾP TỤC';
    }
    
    // Clear result content
    if (resultContent) {
      resultContent.innerHTML = '';
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initQuiz);
  } else {
    initQuiz();
  }
})();
</script>

{% schema %}
{
  "name": "Quiz Banner (Advanced)",
  "settings": [
    { "type": "header", "content": "Banner Content" },
    { "type": "image_picker", "id": "image", "label": "Desktop Image" },
    { "type": "image_picker", "id": "mobile_image", "label": "Mobile Image" },
    { "type": "text", "id": "title", "label": "Title", "default": "Đâu là chiếc nệm phù hợp với bạn?" },
    { "id": "text", "type": "richtext", "label": "Subtitle", "default": "<p>Chỉ mất 2 phút cùng Ru9 khám phá và chọn chiếc nệm cho bạn.</p>" },
    { "type": "text", "label": "Button 1 Text", "id": "button_1_text", "default": "Quiz chọn nệm" },
    { "type": "text", "label": "Button 2 Text", "id": "button_2_text", "default": "So sánh các loại nệm" },
    { "type": "url", "label": "Button 2 Link", "id": "button_2_link" },

    { "type": "header", "content": "Question 1" },
    { "type": "text", "id": "q_1_title", "label": "Question", "default": "1. Vóc dáng và Thể trạng của người sử dụng chính?" },
    { "type": "text", "id": "q_1_a_1_text", "label": "Answer 1 Text", "default": "A. Nhẹ cân (< 50kg)" },
    { "type": "text", "id": "q_1_a_1_subtitle", "label": "Answer 1 Subtitle", "default": "(Dáng người nhỏ nhắn, thư sinh)" },
    { "type": "text", "id": "q_1_a_1_value", "label": "Answer 1 Value", "default": "A", "info": "Value used for matching (A, B, C, D)" },
    { "type": "text", "id": "q_1_a_2_text", "label": "Answer 2 Text", "default": "B. Trung bình (50kg - 80kg)" },
    { "type": "text", "id": "q_1_a_2_subtitle", "label": "Answer 2 Subtitle", "default": "(Vóc dáng phổ thông của người Việt)" },
    { "type": "text", "id": "q_1_a_2_value", "label": "Answer 2 Value", "default": "B" },
    { "type": "text", "id": "q_1_a_3_text", "label": "Answer 3 Text", "default": "C. Đậm người/Nặng cân (> 80kg)" },
    { "type": "text", "id": "q_1_a_3_subtitle", "label": "Answer 3 Subtitle", "default": "(Cơ bắp hoặc vóc dáng lớn)" },
    { "type": "text", "id": "q_1_a_3_value", "label": "Answer 3 Value", "default": "C" },

    { "type": "header", "content": "Question 2" },
    { "type": "text", "id": "q_2_title", "label": "Question", "default": "2. Bạn thường ngủ với ai?" },
    { "type": "text", "id": "q_2_a_1_text", "label": "Answer 1 Text", "default": "A. Ngủ một mình" },
    { "type": "text", "id": "q_2_a_1_subtitle", "label": "Answer 1 Subtitle", "default": "(Tự do, ưu tiên sở thích cá nhân)" },
    { "type": "text", "id": "q_2_a_1_value", "label": "Answer 1 Value", "default": "A" },
    { "type": "text", "id": "q_2_a_2_text", "label": "Answer 2 Text", "default": "B. Ngủ với Vợ/Chồng" },
    { "type": "text", "id": "q_2_a_2_subtitle", "label": "Answer 2 Subtitle", "default": "(Cần sự yên tĩnh, không làm phiền người bên cạnh khi trở mình)" },
    { "type": "text", "id": "q_2_a_2_value", "label": "Answer 2 Value", "default": "B" },
    { "type": "text", "id": "q_2_a_3_text", "label": "Answer 3 Text", "default": "C. Ngủ cả gia đình (Co-sleeping với con nhỏ) hoặc Thú cưng" },
    { "type": "text", "id": "q_2_a_3_subtitle", "label": "Answer 3 Subtitle", "default": "(Cần không gian rộng, bề mặt phẳng, cực kỳ yên tĩnh và an toàn)" },
    { "type": "text", "id": "q_2_a_3_value", "label": "Answer 3 Value", "default": "C" },

    { "type": "header", "content": "Question 3" },
    { "type": "text", "id": "q_3_title", "label": "Question", "default": "3. Hiện tại, anh/chị đang ngủ trên loại bề mặt nào và cảm thấy thế nào?" },
    { "type": "text", "id": "q_3_a_1_text", "label": "Answer 1 Text", "default": "A. Nệm bông ép/Nệm cao su cứng hoặc Chiếu trúc" },
    { "type": "text", "id": "q_3_a_1_subtitle", "label": "Answer 1 Subtitle", "default": "(Rất cứng, phẳng lì)" },
    { "type": "text", "id": "q_3_a_1_value", "label": "Answer 1 Value", "default": "A" },
    { "type": "text", "id": "q_3_a_2_text", "label": "Answer 2 Text", "default": "B. Nệm lò xo cũ" },
    { "type": "text", "id": "q_3_a_2_subtitle", "label": "Answer 2 Subtitle", "default": "(Có độ nảy, nhưng có thể đang bị võng/rung lắc)" },
    { "type": "text", "id": "q_3_a_2_value", "label": "Answer 2 Value", "default": "B" },
    { "type": "text", "id": "q_3_a_3_text", "label": "Answer 3 Text", "default": "C. Nệm foam hoặc cao su thiên nhiên" },
    { "type": "text", "id": "q_3_a_3_subtitle", "label": "Answer 3 Subtitle", "default": "(Có độ êm, ôm sát)" },
    { "type": "text", "id": "q_3_a_3_value", "label": "Answer 3 Value", "default": "C" },
    { "type": "text", "id": "q_3_a_4_text", "label": "Answer 4 Text", "default": "D. Ngủ lung tung/Nệm quá cũ không còn cảm nhận được" },
    { "type": "text", "id": "q_3_a_4_subtitle", "label": "Answer 4 Subtitle" },
    { "type": "text", "id": "q_3_a_4_value", "label": "Answer 4 Value", "default": "D" },

    { "type": "header", "content": "Question 4" },
    { "type": "text", "id": "q_4_title", "label": "Question", "default": "4. Cảm giác tiếp xúc (Feel Preference) anh/chị ưu tiên nhất?" },
    { "type": "text", "id": "q_4_a_1_text", "label": "Answer 1 Text", "default": "A. Chắc chắn & Vững chãi (Firm)" },
    { "type": "text", "id": "q_4_a_1_subtitle", "label": "Answer 1 Subtitle", "default": "(Thích nằm trên mặt phẳng, không thích lún)" },
    { "type": "text", "id": "q_4_a_1_value", "label": "Answer 1 Value", "default": "A" },
    { "type": "text", "id": "q_4_a_2_text", "label": "Answer 2 Text", "default": "B. Êm ái & Ôm sát (Contour)" },
    { "type": "text", "id": "q_4_a_2_subtitle", "label": "Answer 2 Subtitle", "default": "(Thích nệm ôm cơ thể, nâng niu vai/hông)" },
    { "type": "text", "id": "q_4_a_2_value", "label": "Answer 2 Value", "default": "B" },
    { "type": "text", "id": "q_4_a_3_text", "label": "Answer 3 Text", "default": "C. Nảy & Đàn hồi (Bouncy)" },
    { "type": "text", "id": "q_4_a_3_subtitle", "label": "Answer 3 Subtitle", "default": "(Thích độ nảy nhẹ để dễ trở mình, cảm giác sang trọng \"Hotel feel\")" },
    { "type": "text", "id": "q_4_a_3_value", "label": "Answer 3 Value", "default": "C" },
    { "type": "text", "id": "q_4_a_4_text", "label": "Answer 4 Text", "default": "D. Mát lạnh & Trị liệu (Cooling)" },
    { "type": "text", "id": "q_4_a_4_subtitle", "label": "Answer 4 Subtitle", "default": "(Ưu tiên số 1 là phải MÁT và giảm đau lưng)" },
    { "type": "text", "id": "q_4_a_4_value", "label": "Answer 4 Value", "default": "D" },

    { "type": "header", "content": "Question 5" },
    { "type": "text", "id": "q_5_title", "label": "Question", "default": "5. \"Nỗi đau\" lớn nhất với giấc ngủ hiện tại?" },
    { "type": "text", "id": "q_5_a_1_text", "label": "Answer 1 Text", "default": "A. Đau thắt lưng/Cổ vai gáy" },
    { "type": "text", "id": "q_5_a_1_subtitle", "label": "Answer 1 Subtitle", "default": "(Cần nâng đỡ cột sống tối ưu)" },
    { "type": "text", "id": "q_5_a_1_value", "label": "Answer 1 Value", "default": "A" },
    { "type": "text", "id": "q_5_a_2_text", "label": "Answer 2 Text", "default": "B. Nóng bí lưng" },
    { "type": "text", "id": "q_5_a_2_subtitle", "label": "Answer 2 Subtitle", "default": "(Hay đổ mồ hôi trộm)" },
    { "type": "text", "id": "q_5_a_2_value", "label": "Answer 2 Value", "default": "B" },
    { "type": "text", "id": "q_5_a_3_text", "label": "Answer 3 Text", "default": "C. Dễ tỉnh giấc" },
    { "type": "text", "id": "q_5_a_3_subtitle", "label": "Answer 3 Subtitle", "default": "(Nhạy cảm với tiếng động/rung lắc từ người bên cạnh)" },
    { "type": "text", "id": "q_5_a_3_value", "label": "Answer 3 Value", "default": "C" },
    { "type": "text", "id": "q_5_a_4_text", "label": "Answer 4 Text", "default": "D. Không có vấn đề lớn" },
    { "type": "text", "id": "q_5_a_4_subtitle", "label": "Answer 4 Subtitle", "default": "(Muốn nâng cấp trải nghiệm tốt hơn)" },
    { "type": "text", "id": "q_5_a_4_value", "label": "Answer 4 Value", "default": "D" },

    { "type": "header", "content": "Question 6" },
    { "type": "text", "id": "q_6_title", "label": "Question", "default": "6. Tư thế ngủ chủ đạo?" },
    { "type": "text", "id": "q_6_a_1_text", "label": "Answer 1 Text", "default": "A. Nằm ngửa" },
    { "type": "text", "id": "q_6_a_1_subtitle", "label": "Answer 1 Subtitle", "default": "(Cần đỡ thắt lưng)" },
    { "type": "text", "id": "q_6_a_1_value", "label": "Answer 1 Value", "default": "A" },
    { "type": "text", "id": "q_6_a_2_text", "label": "Answer 2 Text", "default": "B. Nằm nghiêng" },
    { "type": "text", "id": "q_6_a_2_subtitle", "label": "Answer 2 Subtitle", "default": "(Cần êm vai & hông - giảm áp lực)" },
    { "type": "text", "id": "q_6_a_2_value", "label": "Answer 2 Value", "default": "B" },
    { "type": "text", "id": "q_6_a_3_text", "label": "Answer 3 Text", "default": "C. Nằm sấp" },
    { "type": "text", "id": "q_6_a_3_subtitle", "label": "Answer 3 Subtitle", "default": "(Cần nệm cứng để bụng không võng)" },
    { "type": "text", "id": "q_6_a_3_value", "label": "Answer 3 Value", "default": "C" },
    { "type": "text", "id": "q_6_a_4_text", "label": "Answer 4 Text", "default": "D. Xoay trở liên tục" },
    { "type": "text", "id": "q_6_a_4_subtitle", "label": "Answer 4 Subtitle", "default": "(Cần nệm hỗ trợ chuyển động)" },
    { "type": "text", "id": "q_6_a_4_value", "label": "Answer 4 Value", "default": "D" },

    { "type": "header", "content": "Question 7" },
    { "type": "text", "id": "q_7_title", "label": "Question", "default": "7. Ngân sách & Nhu cầu sử dụng?" },
    { "type": "text", "id": "q_7_a_1_text", "label": "Answer 1 Text", "default": "A. Premium" },
    { "type": "text", "id": "q_7_a_1_subtitle", "label": "Answer 1 Subtitle", "default": "(Đầu tư tối đa cho sức khỏe)" },
    { "type": "text", "id": "q_7_a_1_value", "label": "Answer 1 Value", "default": "A" },
    { "type": "text", "id": "q_7_a_2_text", "label": "Answer 2 Text", "default": "B. Best Value" },
    { "type": "text", "id": "q_7_a_2_subtitle", "label": "Answer 2 Subtitle", "default": "(Cân bằng chất lượng/giá cả)" },
    { "type": "text", "id": "q_7_a_2_value", "label": "Answer 2 Value", "default": "B" },
    { "type": "text", "id": "q_7_a_3_text", "label": "Answer 3 Text", "default": "C. Tiết kiệm/Linh hoạt" },
    { "type": "text", "id": "q_7_a_3_subtitle", "label": "Answer 3 Subtitle", "default": "(Thuê nhà, sinh viên, nệm phụ)" },
    { "type": "text", "id": "q_7_a_3_value", "label": "Answer 3 Value", "default": "C" },

    { "type": "header", "content": "Quiz Result" },
    { "type": "text", "id": "result_title", "label": "Result page title", "default": "Chúng tôi đề xuất cho bạn" }
  ],
  "blocks": [
    {
      "type": "product_result",
      "name": "Product Result",
      "limit": 20,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Recommended Product",
          "info": "Select the product to recommend"
        },
        {
          "type": "number",
          "id": "order",
          "label": "Thứ tự hiển thị",
          "default": 0,
          "info": "Số càng nhỏ hiển thị càng trước (0, 1, 2, ...)"
        },
        {
          "type": "text",
          "id": "result_reason",
          "label": "Tại sao chọn?",
          "default": "Sản phẩm phù hợp với nhu cầu của bạn",
          "info": "Lý do hiển thị trong kết quả quiz (text từ cột 'Tại sao chọn?' trong bảng)"
        },
        {
          "type": "select",
          "id": "result_type",
          "label": "Loại kết quả",
          "default": "comprehensive",
          "options": [
            {
              "value": "comprehensive",
              "label": "Lựa chọn toàn diện"
            },
            {
              "value": "optimal",
              "label": "Lựa chọn tối ưu"
            },
            {
              "value": "priority",
              "label": "Lựa chọn ưu tiên"
            },
            {
              "value": "suitable",
              "label": "Lựa chọn phù hợp"
            }
          ],
          "info": "Chọn loại kết quả để hiển thị"
        },
        {
          "type": "header",
          "content": "Điều kiện hiển thị (tùy chọn)"
        },
        {
          "type": "text",
          "id": "condition_answers",
          "label": "Câu trả lời bắt buộc",
          "info": "Nhập các câu trả lời bắt buộc. Format: 3A,4A,1B|C (Q3=A AND Q4=A AND (Q1=B OR Q1=C)). Dùng dấu | để chỉ nhiều lựa chọn cho cùng 1 câu hỏi. Ví dụ:\n- 3A,4A,1B|C (Q3=A, Q4=A, Q1=B hoặc C)\n- 5A|B,7A (Q5=A hoặc B, Q7=A)\n\nĐể trống nếu sản phẩm luôn hiển thị."
        }
      ]
    }
  ],
  "presets": [
    { "name": "Quiz Banner (Advanced)" }
  ]
}
{% endschema %}
