{%- if section.settings.title != blank -%}
  <div class="collections-listing-section" data-section-id="{{ section.id }}">
    
    <div class="section-header">
      <h2 class="section-title">
        {{ section.settings.title }}
      </h2>
      <div class="carousel-nav">
        <button class="nav-btn nav-prev">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.5 9L4.5 6L7.5 3" stroke="#9CA3AF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="nav-btn nav-next">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4.5 3L7.5 6L4.5 9" stroke="#609EE9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="collections-carousel-container">
      <div class="collections-carousel">
      
      {%- for block in section.blocks -%}
        {%- assign collection = block.settings.collection -%}
        {%- assign custom_image = block.settings.custom_image -%}
        {%- assign custom_title = block.settings.custom_title -%}
        {%- assign custom_link = block.settings.custom_link -%}
        
        {%- if collection != blank or custom_image != blank -%}
          
          <a href="{{ custom_link | default: collection.url }}" class="collection-item">
            <div class="collection-image-container">
              {%- if custom_image != blank -%}
                <img 
                  src="{{ custom_image | image_url: width: 560, height: 420, crop: 'center' }}" 
                  srcset="{{ custom_image | image_url: width: 280, height: 210, crop: 'center' }} 280w,
                          {{ custom_image | image_url: width: 560, height: 420, crop: 'center' }} 560w,
                          {{ custom_image | image_url: width: 840, height: 630, crop: 'center' }} 840w"
                  sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 25vw"
                  alt="{{ custom_title | default: collection.title }}"
                  width="280" height="210"
                  loading="lazy"
                >
              {%- elsif collection.image -%}
                <img 
                  src="{{ collection.image | image_url: width: 560, height: 420, crop: 'center' }}" 
                  srcset="{{ collection.image | image_url: width: 280, height: 210, crop: 'center' }} 280w,
                          {{ collection.image | image_url: width: 560, height: 420, crop: 'center' }} 560w,
                          {{ collection.image | image_url: width: 840, height: 630, crop: 'center' }} 840w"
                  sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 25vw"
                  alt="{{ custom_title | default: collection.title }}"
                  width="280" height="210"
                  loading="lazy"
                >
              {%- else -%}
                <div class="placeholder-svg-container">
                  {{ 'collection-1' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {%- endif -%}
            </div>
            <div class="collection-info">
              <h3 class="collection-title">
                {{ custom_title | default: collection.title }}
              </h3>
            </div>
          </a>
          
        {%- endif -%}
      {%- endfor -%}
      
      </div>
    </div>
    
  </div>
{%- endif -%}

<style>
  /* ========================================
     COLLECTIONS LISTING TEMPLATE
     Responsive design for all zoom levels
     ======================================== */
  
  .collections-listing-section {
    width: 100%;
    max-width: 1594px;
    margin: 0 auto 3rem auto;
    padding: 0 5rem;
    font-family: 'Be Vietnam Pro', sans-serif;
  }
  
  .collections-listing-section .section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 40px;
  }
  
  .collections-listing-section .section-title {
    color: #1C2C58;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 39px;
    font-style: normal;
    font-weight: 700;
    line-height: 100%;
    margin: 0;
    text-align: left;
  }
  
  .carousel-nav {
    display: flex;
    padding-bottom: 16px;
    gap: 8px;
  }
  
  .collections-listing-section .collections-carousel-container {
    position: relative;
    overflow: hidden;
  }
  
  .collections-listing-section .collections-carousel {
    display: flex;
    transition: transform 0.4s ease;
    gap: 20px;
  }
  
  .collections-listing-section .collection-item {
    width: calc((100% - 5rem) / 4);
    flex-shrink: 0;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    position: relative;
    text-decoration: none;
    color: inherit;
    display: block;
  }
  
  .collections-listing-section .collection-item.is-visible {
    opacity: 1;
    transform: translateY(0);
  }
  
  .collections-listing-section .collection-image-container {
    width: 100%;
    height: 0;
    padding-bottom: 75%;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 25px;
    background: #F8F9FA;
    position: relative;
  }
  
  .collections-listing-section .collection-image-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    transition: transform 0.3s ease;
  }
  
  .collections-listing-section .placeholder-svg-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #E9ECEF;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6C757D;
    border-radius: 8px;
  }
  
  .collections-listing-section .collection-info {
    text-align: left;
  }
  
  .collections-listing-section .collection-title {
    color: #212121;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 22px;
    font-style: normal;
    font-weight: 400;
    line-height: 140%;
    margin: 0;
    text-align: left;
  }
  
  .collections-listing-section .collection-title {
    text-decoration: none;
    color: inherit;
    display: block;
    pointer-events: auto;
    cursor: pointer;
    position: relative;
    z-index: 1;
  }
  
  /* Drag/Swipe styles removed - collections are now clickable */
  
  .collection-image-container:hover img {
    transform: scale(1.05);
  }
  
  .collections-listing-section .collection-item:hover .collection-title {
    color: #609EE9 !important;
    transition: color 0.3s ease;
  }


  /* Desktop Layout - Carousel */
  @media (min-width: 769px) {
    .collections-listing-section .collections-carousel {
      display: flex;
    }
    
    .collections-listing-section .collection-item {
      width: calc((100% - 5rem) / 4);
      flex-shrink: 0;
    }
  }
  
  .nav-btn {
    width: 45px;
    height: 45px;
    border: 1px solid #E5E5E5;
    border-radius: 50%;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .nav-btn:hover {
    background-color: #f0f0f0;
  }
  
  .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ========================================
     FIXED TEMPLATE - NO RESPONSIVE
     Template cố định như Koala mattress
     ======================================== */

  /* Mobile Layout - 2x2 Grid */
  @media (max-width: 768px) {
    .collections-listing-section {
      padding: 0 20px;
    }

    .collections-listing-section .section-header {
      margin-bottom: 0px;
      text-align: left !important;
    }
    .collections-listing-section .section-title {
      font-size: 20px;
      text-align: left !important;
      margin-bottom: 20px;
    }
    
    .carousel-nav {
      display: none; /* Ẩn navigation trên mobile vì hiển thị tất cả 4 items */
    }
    
    .collections-listing-section .collections-carousel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 15px;
      transform: none !important; /* Tắt transform trên mobile */
    }
    
    .collections-listing-section .collection-item {
      width: 100%;
      opacity: 1;
      transform: none;
    }
    
    .collections-listing-section .collection-image-container {
      padding-bottom: 75%;
      margin-bottom: 15px;
      border-radius: 3px;
    }
    
    .collections-listing-section .collection-image-container img {
      border-radius: 3px;
    }
    
    .collections-listing-section .placeholder-svg-container {
      border-radius: 3px;
    }
    
    .collections-listing-section .collection-title {
      font-size: 16px;
      text-align: left;
      text-transform: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sectionContainer = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!sectionContainer) return;

    const carousel = sectionContainer.querySelector('.collections-carousel');
    const prevBtn = sectionContainer.querySelector('.nav-prev');
    const nextBtn = sectionContainer.querySelector('.nav-next');
    
    if (!carousel || !prevBtn || !nextBtn) return;

    if (window.innerWidth <= 768) {
      // Trên mobile, hiển thị tất cả items ngay lập tức với layout 2x2
      sectionContainer.querySelectorAll('.collection-item').forEach(item => {
        item.classList.add('is-visible');
        item.style.opacity = '1';
        item.style.transform = 'none';
      });
      // Ẩn navigation buttons trên mobile
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
      return; // Exit script, do not initialize carousel functionality.
    }

    const collectionItems = carousel.querySelectorAll('.collection-item');
    if (collectionItems.length === 0) {
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      return;
    }

    let currentIndex = 0;

    function getItemsPerView() {
      // Always show 4 items on desktop
      if (window.innerWidth > 1200) {
        return 4;
      }
      // Show 3 items on tablet
      if (window.innerWidth > 768) {
        return 3;
      }
      // Show 2 items on mobile
      return 2;
    }

    function updateCarousel(isResize = false) {
      if (isResize) {
        carousel.style.transition = 'none';
        currentIndex = 0;
      } else {
        carousel.style.transition = 'transform 0.4s ease';
      }

      const itemsPerView = getItemsPerView();
      const maxIndex = Math.max(0, collectionItems.length - itemsPerView);
      
      currentIndex = Math.max(0, Math.min(currentIndex, maxIndex));

      const containerWidth = carousel.parentElement.offsetWidth;
      const gap = 15;
      const itemWidth = (containerWidth - (itemsPerView - 1) * gap) / itemsPerView;
      const translateX = -currentIndex * (itemWidth + gap);
      carousel.style.transform = `translateX(${translateX}px)`;
      
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex >= maxIndex;
    }

    nextBtn.addEventListener('click', () => {
      const itemsPerView = getItemsPerView();
      const maxIndex = Math.max(0, collectionItems.length - itemsPerView);
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateCarousel();
      }
    });

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateCarousel();
      }
    });

    // Handle click events for collection items
    collectionItems.forEach(item => {
        item.addEventListener('click', (e) => {
            // Allow click to proceed normally to collection page
            // The entire item is now a link, so no need for special handling
            return true;
        });
    });
    
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        updateCarousel(true);
      }, 250);
    });
    
    // --- Intersection Observer for Appear Animation ---
    if ('IntersectionObserver' in window) {
      const itemsToAnimate = carousel.querySelectorAll('.collection-item');
      const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      }, {
        threshold: 0.1
      });

      itemsToAnimate.forEach((item, index) => {
        item.style.transitionDelay = `${index * 100}ms`;
        observer.observe(item);
      });
    } else {
      // Fallback for older browsers
      carousel.querySelectorAll('.collection-item').forEach(item => {
        item.classList.add('is-visible');
      });
    }

    setTimeout(() => {
        updateCarousel();
    }, 100);
  });
</script>

{% schema %}
{
  "name": "Collections Listing",
  "class": "index-section",
  "disabled_on": {
    "groups": ["footer", "header", "custom.popups"]
  },
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Our Collections"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#1C2C58"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#212121"
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "limit": 12,
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection",
          "info": "Select collection to display"
        },
        {
          "type": "image_picker",
          "id": "custom_image",
          "label": "Custom Image",
          "info": "Upload a custom image for this collection block. If not provided, will use collection's default image."
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "Custom Title",
          "info": "Override collection title with custom text"
        },
        {
          "type": "url",
          "id": "custom_link",
          "label": "Custom Link",
          "info": "Override collection URL with custom link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collections Listing",
      "blocks": [
        {
          "type": "collection"
        },
        {
          "type": "collection"
        },
        {
          "type": "collection"
        }
      ]
    }
  ]
}
{% endschema %}
