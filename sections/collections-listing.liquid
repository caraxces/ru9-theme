{%- if section.settings.title != blank -%}
  <div class="collections-listing-section" data-section-id="{{ section.id }}">
    
    <div class="section-header">
      <p class="section-title">
        {{ section.settings.title }}
      </p>
    </div>
    
    <div class="collections-carousel-container">
      <div class="collections-carousel">
      
      {%- for block in section.blocks -%}
        {%- assign collection = block.settings.collection -%}
        {%- assign custom_image = block.settings.custom_image -%}
        {%- assign custom_title = block.settings.custom_title -%}
        {%- assign custom_link = block.settings.custom_link -%}
        
        {%- if collection != blank or custom_image != blank -%}
          
          <a href="{{ custom_link | default: collection.url }}" class="collection-item">
            <div class="collection-image-container">
              {%- if custom_image != blank -%}
                <img 
                  src="{{ custom_image | image_url: width: 560, height: 420, crop: 'center' }}" 
                  srcset="{{ custom_image | image_url: width: 280, height: 210, crop: 'center' }} 280w,
                          {{ custom_image | image_url: width: 560, height: 420, crop: 'center' }} 560w,
                          {{ custom_image | image_url: width: 840, height: 630, crop: 'center' }} 840w"
                  sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 25vw"
                  alt="{{ custom_title | default: collection.title }}"
                  width="280" height="210"
                  loading="lazy"
                >
              {%- elsif collection.image -%}
                <img 
                  src="{{ collection.image | image_url: width: 560, height: 420, crop: 'center' }}" 
                  srcset="{{ collection.image | image_url: width: 280, height: 210, crop: 'center' }} 280w,
                          {{ collection.image | image_url: width: 560, height: 420, crop: 'center' }} 560w,
                          {{ collection.image | image_url: width: 840, height: 630, crop: 'center' }} 840w"
                  sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 25vw"
                  alt="{{ custom_title | default: collection.title }}"
                  width="280" height="210"
                  loading="lazy"
                >
              {%- else -%}
                <div class="placeholder-svg-container">
                  {{ 'collection-1' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {%- endif -%}
            </div>
            <div class="collection-info">
              <h3 class="collection-title">
                {{ custom_title | default: collection.title }}
              </h3>
            </div>
          </a>
          
        {%- endif -%}
      {%- endfor -%}
      
      </div>
    </div>
    
  </div>
{%- endif -%}

<style>
  /* ========================================
     COLLECTIONS LISTING TEMPLATE
     Desktop: 4 cards fit exactly with canvas
     Mobile: 2x2 grid layout
     ======================================== */
  
  /* Desktop Layout (769px+) */
  @media (min-width: 769px) {
    .collections-listing-section {
      width: 100%;
      max-width: 1594px;
      margin: 5rem auto 3rem auto;
      padding: 0 5rem;
      font-family: 'Be Vietnam Pro', sans-serif;
    }
  
    .collections-listing-section .section-header {
      margin-bottom: 40px;
    }
  
    .collections-listing-section .section-title {
      color: #1C2C58;
      font-family: 'Be Vietnam Pro', sans-serif;
      font-size: 39px;
      font-style: normal;
      font-weight: 700;
      line-height: 100%;
      margin: 0;
      text-align: left;
    }
  
    .collections-listing-section .collections-carousel-container {
      position: relative;
      overflow: visible;
    }
  
    .collections-listing-section .collections-carousel {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
  
    .collections-listing-section .collection-item {
      width: calc((100% - 60px) / 4); /* 4 cards với 3 gaps 20px = 60px */
      flex-shrink: 0;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
      position: relative;
      text-decoration: none;
      color: inherit;
      display: block;
    }
  
    .collections-listing-section .collection-item.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .collections-listing-section .collection-image-container {
    width: 100%;
    height: 0;
    padding-bottom: 75%;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 25px;
    background: #F8F9FA;
    position: relative;
  }
  
  .collections-listing-section .collection-image-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    transition: transform 0.3s ease;
  }
  
  .collections-listing-section .placeholder-svg-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #E9ECEF;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6C757D;
    border-radius: 8px;
  }
  
  .collections-listing-section .collection-info {
    text-align: left;
  }
  
  .collections-listing-section .collection-title {
    color: #212121;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 22px;
    font-style: normal;
    font-weight: 400;
    line-height: 140%;
    margin: 0;
    text-align: left;
  }
  
  .collections-listing-section .collection-title {
    text-decoration: none;
    color: inherit;
    display: block;
    pointer-events: auto;
    cursor: pointer;
    position: relative;
    z-index: 1;
  }
  
  /* Drag/Swipe styles removed - collections are now clickable */
  
  .collection-image-container:hover img {
    transform: scale(1.05);
  }
  
  .collections-listing-section .collection-item:hover .collection-title {
    color: #609EE9 !important;
    transition: color 0.3s ease;
  }

  /* ========================================
     FIXED TEMPLATE - NO RESPONSIVE
     Template cố định như Koala mattress
     ======================================== */

  /* Mobile Layout - 2x2 Grid */
  @media (max-width: 768px) {
    .collections-listing-section {
      padding: 0 15px !important;
      margin: 2rem auto !important;
    }

    .collections-listing-section .section-header {
      margin-bottom: 0px;
      text-align: left !important;
    }
    
    .collections-listing-section .section-title {
      font-size: 20px;
      text-align: left !important;
      margin-bottom: 20px;
    }
    
    .collections-listing-section .collections-carousel-container {
      overflow: visible !important;
    }
    
    .collections-listing-section .collections-carousel {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      grid-template-rows: auto auto !important;
      gap: 15px !important;
      transform: none !important;
      flex-direction: unset !important;
      transition: none !important;
    }
    
    .collections-listing-section .collection-item {
      width: 100% !important;
      opacity: 1 !important;
      transform: none !important;
      flex-shrink: unset !important;
      position: relative !important;
    }
    
    .collections-listing-section .collection-image-container {
      padding-bottom: 75%;
      margin-bottom: 15px;
      border-radius: 3px;
    }
    
    .collections-listing-section .collection-image-container img {
      border-radius: 3px;
    }
    
    .collections-listing-section .placeholder-svg-container {
      border-radius: 3px;
    }
    
    .collections-listing-section .collection-title {
      font-size: 16px;
      text-align: left;
      text-transform: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sectionContainer = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!sectionContainer) return;

    const carousel = sectionContainer.querySelector('.collections-carousel');
    if (!carousel) return;

    // Mobile: Force grid layout
    if (window.innerWidth <= 768) {
      carousel.style.display = 'grid';
      carousel.style.gridTemplateColumns = '1fr 1fr';
      carousel.style.gridTemplateRows = 'auto auto';
      carousel.style.gap = '15px';
      
      sectionContainer.querySelectorAll('.collection-item').forEach(item => {
        item.classList.add('is-visible');
        item.style.opacity = '1';
        item.style.transform = 'none';
        item.style.width = '100%';
      });
      
      return;
    }

    // Desktop: Show all items with animation
    // Intersection Observer for Appear Animation
    if ('IntersectionObserver' in window) {
      const itemsToAnimate = carousel.querySelectorAll('.collection-item');
      const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      }, {
        threshold: 0.1
      });

      itemsToAnimate.forEach((item, index) => {
        item.style.transitionDelay = `${index * 100}ms`;
        observer.observe(item);
      });
    } else {
      // Fallback for older browsers
      carousel.querySelectorAll('.collection-item').forEach(item => {
        item.classList.add('is-visible');
      });
    }
  });
</script>

{% schema %}
{
  "name": "Collections Listing",
  "class": "index-section",
  "disabled_on": {
    "groups": ["footer", "header", "custom.popups"]
  },
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Our Collections"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#1C2C58"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#212121"
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "limit": 12,
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection",
          "info": "Select collection to display"
        },
        {
          "type": "image_picker",
          "id": "custom_image",
          "label": "Custom Image",
          "info": "Upload a custom image for this collection block. If not provided, will use collection's default image."
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "Custom Title",
          "info": "Override collection title with custom text"
        },
        {
          "type": "url",
          "id": "custom_link",
          "label": "Custom Link",
          "info": "Override collection URL with custom link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collections Listing",
      "blocks": [
        {
          "type": "collection"
        },
        {
          "type": "collection"
        },
        {
          "type": "collection"
        }
      ]
    }
  ]
}
{% endschema %}
