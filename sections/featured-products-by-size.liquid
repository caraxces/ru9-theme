<div data-section-id="{{ section.id }}" data-section-type="featured-products-by-size">
  <div class="featured-collections-section">
    
    {%- liquid
      assign source_collection = section.settings.collection
      assign all_sizes = ''
      assign size_option_name = ''
      
      if source_collection.products.size > 0
        for product in source_collection.products limit: 1
          for option in product.options_with_values
            assign option_name_lower = option.name | downcase
            if option_name_lower contains 'size' or option_name_lower contains 'kích thước' or option_name_lower contains 'kich thuoc'
              assign size_option_name = option.name
              break
            endif
          endfor
          break
        endfor
        
        if size_option_name != blank
          for product in source_collection.products
            for option in product.options_with_values
              if option.name == size_option_name
                for value in option.values
                  assign size_string = value | append: ','
                  unless all_sizes contains size_string
                    assign all_sizes = all_sizes | append: size_string
                  endunless
                endfor
              endif
            endfor
          endfor
        endif
        
        assign unique_sizes = all_sizes | remove_last: ',' | split: ',' | uniq
        assign rendered_short_sizes = ''
      endif
    -%}
    
    <!-- Header Section -->
    <div class="section-header">
      <div class="header-left">
        <h2 class="section-title">
          {{ section.settings.title }}
        </h2>
      </div>
      <div class="header-right">
        {%- if source_collection != blank -%}
          <a href="{{ source_collection.url }}" class="view-all-link">
            Xem tất cả
          </a>
        {%- endif -%}
        <div class="carousel-nav">
          <button class="nav-btn nav-prev">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7.5 9L4.5 6L7.5 3" stroke="#9CA3AF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="nav-btn nav-next">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4.5 9L7.5 6L4.5 3" stroke="#1A1A1A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    
    <!-- Size Tabs -->
    <div class="category-tabs-container">
      <div class="category-tabs">
        {%- for size in unique_sizes -%}
          {%- if size != blank -%}
            {%- assign short_size = size | split: '-' | first | strip -%}
            {%- assign short_size_handle = short_size | handle | append: ',' -%}
            {%- unless rendered_short_sizes contains short_size_handle -%}
              <button 
                class="category-tab{% if rendered_short_sizes == blank %} active{% endif %}" 
                data-size="{{ short_size | handle }}"
              >
                {{ short_size }}
              </button>
              {%- assign rendered_short_sizes = rendered_short_sizes | append: short_size_handle -%}
            {%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
    
    <!-- Product Carousel Section -->
    <div class="product-carousel-section">
      <div class="product-carousel">
        <div class="product-cards-container">
          {%- if source_collection.products.size > 0 -%}
            {%- for size in unique_sizes -%}
              {%- if size != blank -%}
                {%- assign short_size = size | split: '-' | first | strip | handle -%}
                
                {%- for product in source_collection.products -%}
                  {%- liquid
                    assign size_option_key_index = 0
                    for option in product.options
                      if option == size_option_name
                        assign size_option_key_index = forloop.index
                        break
                      endif
                    endfor
                    assign size_option_key = 'option' | append: size_option_key_index
                    
                    assign product_size = ''
                    assign product_variant = product.selected_or_first_available_variant
                    
                    for variant in product.variants
                      assign variant_size = variant[size_option_key]
                      if variant_size != blank
                        assign variant_size_handle = variant_size | split: '-' | first | strip | handle
                        if variant_size_handle == short_size
                          assign product_size = variant_size_handle
                          assign product_variant = variant
                          break
                        endif
                      endif
                    endfor
                  -%}

                  {%- if product_size != blank -%}
                <a href="{{ product.url }}" class="product-card" data-size="{{ product_size }}">
                  <div class="product-image-container{% if product.media.size > 1 %} has-secondary-image{% endif %}">
                    {%- if section.settings.product_label != blank -%}
                      <div class="product-label" style="background-color: {{ section.settings.label_bg }}; color: {{ section.settings.label_color }};">
                        {{ section.settings.product_label }}
                      </div>
                    {%- endif -%}
                    
                    {%- assign image = product_variant.image | default: product.featured_image -%}
                    {%- if image -%}
                      <img 
                        class="product-image-primary"
                        src="{{ image | image_url: width: 400, height: 320, crop: 'center' }}" 
                        alt="{{ product.title }}"
                        width="400" height="320"
                      >
                    {%- else -%}
                      <div class="placeholder-image">No Image</div>
                    {%- endif -%}

                    {%- if product.media.size > 1 -%}
                      {%- for media in product.media offset: 1 limit: 1 -%}
                         {%- if media.preview_image != image -%}
                          <img 
                            class="product-image-secondary"
                            src="{{ media.preview_image | image_url: width: 400, height: 320, crop: 'center' }}" 
                            alt="{{ product.title }}"
                            width="400" height="320"
                          >
                        {%- endif -%}
                      {%- endfor -%}
                    {%- endif -%}
                  </div>
                  
                  <div class="product-info">
                    <div class="product-rating">
                      <svg width="81" height="14" viewBox="0 0 81 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6.84155 0.245755C6.94841 -0.0819184 7.41368 -0.0819184 7.52054 0.245755L8.97105 4.69322C9.01883 4.83976 9.15591 4.93898 9.31055 4.93898H14.0044C14.3502 4.93898 14.494 5.37983 14.2143 5.58238L10.4169 8.33108C10.2917 8.4216 10.2394 8.58218 10.2872 8.72871L11.7377 13.1762C11.8445 13.5038 11.4681 13.7763 11.1883 13.5738L7.3909 10.8251C7.26577 10.7346 7.09632 10.7346 6.9712 10.8251L3.1738 13.5738C2.89403 13.7763 2.51759 13.5038 2.62445 13.1762L4.07493 8.72871C4.12273 8.58218 4.07037 8.4216 3.94525 8.33108L0.147842 5.58238C-0.131937 5.37983 0.0118471 4.93898 0.357675 4.93898H5.05154C5.20618 4.93898 5.34326 4.83976 5.39104 4.69322L6.84155 0.245755Z" fill="#FFDC5F"/>
                        <path d="M23.5007 0.245755C23.6076 -0.0819184 24.0729 -0.0819184 24.1797 0.245755L25.6302 4.69322C25.678 4.83976 25.8151 4.93898 25.9697 4.93898H30.6636C31.0094 4.93898 31.1532 5.37983 30.8735 5.58238L27.0761 8.33108C26.9509 8.4216 26.8986 8.58218 26.9463 8.72871L28.3969 13.1762C28.5037 13.5038 28.1273 13.7763 27.8475 13.5738L24.0501 10.8251C23.925 10.7346 23.7555 10.7346 23.6304 10.8251L19.833 13.5738C19.5532 13.7763 19.1768 13.5038 19.2836 13.1762L20.7341 8.72871C20.7819 8.58218 20.7295 8.4216 20.6044 8.33108L16.807 5.58238C16.5272 5.37983 16.671 4.93898 17.0169 4.93898H21.7107C21.8654 4.93898 22.0025 4.83976 22.0502 4.69322L23.5007 0.245755Z" fill="#FFDC5F"/>
                        <path d="M40.1609 0.245755C40.2678 -0.0819184 40.733 -0.0819184 40.8399 0.245755L42.2904 4.69322C42.3382 4.83976 42.4753 4.93898 42.6299 4.93898H47.3238C47.6696 4.93898 47.8134 5.37983 47.5336 5.58238L43.7362 8.33108C43.6111 8.4216 43.5587 8.58218 43.6065 8.72871L45.057 13.1762C45.1639 13.5038 44.7874 13.7763 44.5077 13.5738L40.7102 10.8251C40.5851 10.7346 40.4157 10.7346 40.2905 10.8251L36.4931 13.5738C36.2134 13.7763 35.8369 13.5038 35.9438 13.1762L37.3943 8.72871C37.4421 8.58218 37.3897 8.4216 37.2646 8.33108L33.4672 5.58238C33.1874 5.37983 33.3312 4.93898 33.677 4.93898H38.3709C38.5255 4.93898 38.6626 4.83976 38.7104 4.69322L40.1609 0.245755Z" fill="#FFDC5F"/>
                        <path d="M56.8201 0.245755C56.9269 -0.0819184 57.3922 -0.0819184 57.4991 0.245755L58.9493 4.69322C58.9975 4.83976 59.1343 4.93898 59.289 4.93898H63.9828C64.3285 4.93898 64.4725 5.37983 64.1929 5.58238L60.3951 8.33108C60.2701 8.4216 60.2178 8.58218 60.266 8.72871L61.716 13.1762C61.823 13.5038 61.4464 13.7763 61.1668 13.5738L57.3694 10.8251C57.2443 10.7346 57.0748 10.7346 56.9497 10.8251L53.1523 13.5738C52.8725 13.7763 52.4961 13.5038 52.603 13.1762L54.0535 8.72871C54.1012 8.58218 54.0489 8.4216 53.9238 8.33108L50.1263 5.58238C49.8466 5.37983 49.9904 4.93898 50.3362 4.93898H55.0301C55.1847 4.93898 55.3218 4.83976 55.3696 4.69322L56.8201 0.245755Z" fill="#FFDC5F"/>
                        <path d="M73.4789 0.245755C73.586 -0.0819184 74.0513 -0.0819184 74.1584 0.245755L75.6084 4.69322C75.6566 4.83976 75.7934 4.93898 75.9481 4.93898H80.6419C80.9876 4.93898 81.1316 5.37983 80.852 5.58238L77.0542 8.33108C76.9292 8.4216 76.8769 8.58218 76.9251 8.72871L78.3751 13.1762C78.4822 13.5038 78.1055 13.7763 77.8259 13.5738L74.0287 10.8251C73.9032 10.7346 73.7342 10.7346 73.6086 10.8251L69.8115 13.5738C69.5318 13.7763 69.1552 13.5038 69.2623 13.1762L70.7123 8.72871C70.7605 8.58218 70.7081 8.4216 70.5832 8.33108L66.7854 5.58238C66.5057 5.37983 66.6497 4.93898 66.9954 4.93898H71.6892C71.8439 4.93898 71.9808 4.83976 72.029 4.69322L73.4789 0.245755Z" fill="#FFDC5F"/>
                      </svg>
                      {%- assign rating = product.metafields.reviews.rating.value -%}
                      {%- if rating != blank -%}
                        <span class="rating-score">{{ rating.rating | round: 1 }}</span>
                        <span class="rating-count">({{ product.metafields.reviews.rating_count }})</span>
                      {%- endif -%}
                    </div>
                    <h3 class="product-name">{{ product.title | split: '-' | first }}</h3>
                    <div class="product-meta"></div>
                    <div class="product-price">
                      <span class="price">{{ product_variant.price | money }}</span>
                      {%- if product_variant.compare_at_price > product_variant.price -%}
                         {%- assign sale_percentage = product_variant.compare_at_price | minus: product_variant.price | times: 100.0 | divided_by: product_variant.compare_at_price | round -%}
                        <span class="discount-badge">-{{ sale_percentage }}%</span>
                        <span class="compare-price">{{ product_variant.compare_at_price | money }}</span>
                      {%- endif -%}
                    </div>
                  </div>
                </a>
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  [data-section-id="{{ section.id }}"] .featured-collections-section {
    width: 100%;
    min-height: auto; 
    margin: 0 auto 0 auto;
    padding: 0 60px 0 60px;
    font-family: 'Be Vietnam Pro', sans-serif;
  }
  [data-section-id="{{ section.id }}"] .section-header {
    padding-bottom: 0px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }
  [data-section-id="{{ section.id }}"] .header-left {
    flex: 1;
    text-align: left;
  }
  [data-section-id="{{ section.id }}"] .section-title {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 39px;
    font-weight: 700;
    line-height: 120%;
    color: #1C2C58;
    margin: 0;
    padding-bottom: 10px;
    text-align: left;
  }
  [data-section-id="{{ section.id }}"] .header-right {
    display: flex;
    align-items: center;
    gap: 24px;
  }
  [data-section-id="{{ section.id }}"] .view-all-link {
    color: #1A1A1A;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 16px;
    font-weight: 500;
    text-decoration: underline;
    line-height: 1;
  }
  [data-section-id="{{ section.id }}"] .view-all-link:hover {
    color: #000 !important;
  }

  /* Category Tabs */
  [data-section-id="{{ section.id }}"] .category-tabs-container {
    margin-bottom: 24px;
  }
  [data-section-id="{{ section.id }}"] .category-tabs {
    display: flex;
    gap: 16px;
    align-items: center;
  }
  [data-section-id="{{ section.id }}"] .category-tab {
    display: flex;
    height: 45px;
    min-height: 45px;
    padding: 12px 24px;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    border-radius: 100.1px;
    border: 1px solid transparent;
    background: #FFFBE9;
    color: #1A1A1A;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  [data-section-id="{{ section.id }}"] .category-tab:hover {
    background: #e9ecef;
  }
  [data-section-id="{{ section.id }}"] .category-tab.active {
    background: #FFD35B;
    color: #1A1A1A;
    font-weight: 600;
  }

  /* Carousel Styles */
  [data-section-id="{{ section.id }}"] .product-carousel-section {
    position: relative;
  }
  [data-section-id="{{ section.id }}"] .product-carousel {
    position: relative;
    overflow: hidden;
    cursor: grab;
  }
  [data-section-id="{{ section.id }}"] .product-carousel.grabbing {
    cursor: grabbing;
  }
  [data-section-id="{{ section.id }}"] .product-carousel.grabbing .product-card {
    pointer-events: none;
  }
  [data-section-id="{{ section.id }}"] .product-cards-container {
    display: flex;
    gap: 2%;
    transition: transform 0.3s ease;
  }
  [data-section-id="{{ section.id }}"] .product-card {
    display: none; /* Hidden by default, shown by JS */
  }

  /* Carousel Navigation */
  [data-section-id="{{ section.id }}"] .carousel-nav {
    display: flex;
    gap: 6px;
  }
  [data-section-id="{{ section.id }}"] .nav-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    border: none;
  }
  [data-section-id="{{ section.id }}"] .nav-btn.nav-prev {
    background: #FFF9E5;
  }
  [data-section-id="{{ section.id }}"] .nav-btn.nav-prev:hover {
    background: #FFF3CD;
  }
  [data-section-id="{{ section.id }}"] .nav-btn.nav-next {
    background: #FFD35B;
  }
  [data-section-id="{{ section.id }}"] .nav-btn.nav-next:hover {
    background: #FBC947;
  }
  [data-section-id="{{ section.id }}"] .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }


  /* Product Card Styles */
  [data-section-id="{{ section.id }}"] .product-card {
    width: 380px;
    flex-shrink: 0;
    border-radius: 5px;
    overflow: hidden;
    text-decoration: none;
    color: inherit;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out !important;
  }
  [data-section-id="{{ section.id }}"] .product-card.is-visible {
    opacity: 1;
    transform: translateY(0);
  }
  [data-section-id="{{ section.id }}"] .product-image-container {
    position: relative;
    width: 380px;
    height: 284px;
    background: #FFFDF4;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
  }
  [data-section-id="{{ section.id }}"] .placeholder-image {
    width: 100%;
    height: 100%;
    background: #E9ECEF;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6C757D;
    border-radius: 8px;
  }
  [data-section-id="{{ section.id }}"] .product-label {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 8px 16px;
    border-radius: 8px;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 14px;
    font-weight: 600;
    z-index: 2;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  [data-section-id="{{ section.id }}"] .product-image-primary, [data-section-id="{{ section.id }}"] .product-image-secondary {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    transition: opacity 0.3s ease;
  }
  [data-section-id="{{ section.id }}"] .product-image-secondary {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
  }
  [data-section-id="{{ section.id }}"] .product-image-container.has-secondary-image:hover .product-image-primary,
  [data-section-id="{{ section.id }}"] .product-carousel.grabbing .product-image-container.has-secondary-image:hover .product-image-primary {
    opacity: 0 !important;
  }
  [data-section-id="{{ section.id }}"] .product-image-container.has-secondary-image:hover .product-image-secondary,
  [data-section-id="{{ section.id }}"] .product-carousel.grabbing .product-image-container.has-secondary-image:hover .product-image-secondary {
    opacity: 1 !important;
  }
  [data-section-id="{{ section.id }}"] .product-info {
    padding: 16px 0 0 0;
    margin: 0;
    text-align: left;
  }
  [data-section-id="{{ section.id }}"] .product-rating {
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  [data-section-id="{{ section.id }}"] .rating-score {
    font-size: 14px;
    font-weight: 600;
  }
  [data-section-id="{{ section.id }}"] .rating-count {
    font-size: 14px;
    color: #666;
  }
  [data-section-id="{{ section.id }}"] .product-name {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 20px;
    font-weight: 500;
    color: #1C2C58;
    margin: 0 0 8px 0;
    line-height: 27px;
  }
  [data-section-id="{{ section.id }}"] .product-meta {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
  }
  [data-section-id="{{ section.id }}"] .product-price {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 4px 8px;
    line-height: 1.2;
  }
  [data-section-id="{{ section.id }}"] .price {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: #1A1A1A;
  }
  [data-section-id="{{ section.id }}"] .discount-badge {
    font-size: 12px;
    font-weight: 600;
    color: #234085;
    background-color: #FCE390;
    padding: 2px 5px;
    border-radius: 4px;
  }
  [data-section-id="{{ section.id }}"] .compare-price {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 14px;
    color: #999;
    text-decoration: line-through;
    width: 100%;
  }
  
  /* Large screens - maintain fixed padding */
  @media (min-width: 1400px) {
    [data-section-id="{{ section.id }}"] .featured-collections-section {
      padding: 0 60px 0 60px;
    }
  }
  
  /* Medium screens - responsive padding */
  @media (max-width: 1399px) and (min-width: 1024px) {
    [data-section-id="{{ section.id }}"] .featured-collections-section {
      padding: 0 60px 0 60px;
    }
  }
  
  @media (max-width: 1200px) {
    [data-section-id="{{ section.id }}"] .product-card {
      width: calc(50% - 1%) !important;
      min-width: 250px;
    }
    [data-section-id="{{ section.id }}"] .product-image-container {
      width: 100% !important;
      height: auto !important;
      aspect-ratio: 121/80 !important;
    }
    [data-section-id="{{ section.id }}"] .product-name {
      font-size: 24px !important;
    }
    [data-section-id="{{ section.id }}"] .section-title {
      font-size: 36px !important;
    }
  }
  
  /* Mobile screens */
  @media (max-width: 768px) {
    [data-section-id="{{ section.id }}"] .featured-collections-section {
      padding: 0 15px;
    }
    [data-section-id="{{ section.id }}"] .section-header {
      flex-direction: row !important;
      flex-wrap: wrap;
      align-items: center;
      padding-bottom: 0px !important;
    }
    [data-section-id="{{ section.id }}"] .header-left {
      order: 1;
      flex: 1 1 auto;
    }
    [data-section-id="{{ section.id }}"] .header-right {
      order: 2;
      flex: 0 0 auto;
    }
    [data-section-id="{{ section.id }}"] .header-right .carousel-nav {
      display: none !important;
    }
    [data-section-id="{{ section.id }}"] .category-tabs-container {
      order: 3;
      width: 100%;
      margin: 0 -15px 24px -15px;
      position: relative;
    }
    [data-section-id="{{ section.id }}"] .category-tabs-container::after {
      content: none;
    }
    [data-section-id="{{ section.id }}"] .category-tabs {
      flex-wrap: nowrap;
      width: 375px;
      justify-content: flex-start;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      cursor: grab;
      padding: 0 15px;
    }
    [data-section-id="{{ section.id }}"] .category-tabs::-webkit-scrollbar {
        display: none;
    }
    [data-section-id="{{ section.id }}"] .product-carousel-section {
      margin: 0 -15px;
    }
    [data-section-id="{{ section.id }}"] .product-carousel {
      padding: 0 15px;
      overflow: visible;
    }
    [data-section-id="{{ section.id }}"] .product-cards-container {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      grid-auto-rows: auto !important;
      gap: 16px !important;
      transform: none !important;
    }
    [data-section-id="{{ section.id }}"] .product-card {
      width: 100% !important;
      flex-shrink: 0;
      min-width: auto;
      display: block !important;
    }
    [data-section-id="{{ section.id }}"] .product-card[style*="display: none"] {
      display: none !important;
    }
    [data-section-id="{{ section.id }}"] .product-image-container {
      width: 172px !important;
      height: 129px !important;
      flex-shrink: 0 !important;
      aspect-ratio: unset !important;
      border-radius: 3px !important;
    }
    [data-section-id="{{ section.id }}"] .product-name {
      color: #1C2C58 !important;
      font-family: "Be Vietnam Pro", sans-serif !important;
      font-size: 16px !important;
      font-style: normal !important;
      font-weight: 500 !important;
      line-height: 21px !important; /* 131.25% */
      letter-spacing: 0.6px !important;
    }
    [data-section-id="{{ section.id }}"] .product-price {
      flex-direction: row;
      align-items: center;
      gap: 0px 8px;
      flex-wrap: wrap;
    }
    [data-section-id="{{ section.id }}"] .price {
      color: #000 !important;
      font-family: "Be Vietnam Pro", sans-serif !important;
      font-size: 13px !important;
      font-style: normal !important;
      font-weight: 600 !important;
      line-height: 27px !important; /* 207.692% */
      letter-spacing: 0.6px !important;
    }
    [data-section-id="{{ section.id }}"] .discount-badge {
      font-family: "Be Vietnam Pro", sans-serif !important;
      font-size: 12px !important;
      font-weight: 600 !important;
      background: #FCE390 !important;
      color: #234085 !important;
    }
    [data-section-id="{{ section.id }}"] .compare-price {
      color: #888 !important;
      font-family: "Be Vietnam Pro", sans-serif !important;
      font-size: 13px !important;
      font-style: normal !important;
      font-weight: 400 !important;
      line-height: 27px !important; /* 207.692% */
      letter-spacing: 0.6px !important;
      text-decoration-line: line-through !important;
    }
  }
  
  @media (max-width: 480px) {
    [data-section-id="{{ section.id }}"] .section-title {
      font-size: 20px !important;
    }
    [data-section-id="{{ section.id }}"] .category-tab {
      font-size: 16px !important;
    }
    [data-section-id="{{ section.id }}"] .view-all-btn {
      width: 90px !important;
      height: 28px !important;
      padding: 6px 16px !important;
      font-size: 12px !important;
    }
    [data-section-id="{{ section.id }}"] .nav-btn {
      width: 24px !important;
      height: 24px !important;
    }
  }
</style>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const sectionId = '{{ section.id }}';
    const sectionContainer = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (!sectionContainer) return;

    const tabButtons = sectionContainer.querySelectorAll('.category-tab');
    const productCardsContainer = sectionContainer.querySelector('.product-cards-container');
    const allProductCards = sectionContainer.querySelectorAll('.product-card');
  
    const prevBtn = sectionContainer.querySelector('.nav-prev');
    const nextBtn = sectionContainer.querySelector('.nav-next');
    const carouselContainer = sectionContainer.querySelector('.product-carousel');
    
    let carousel = null;

    // --- Drag-to-scroll for tabs ---
    const tabsContainer = sectionContainer.querySelector('.category-tabs');
    if (tabsContainer) {
        let isDown = false;
        let startX;
        let scrollLeft;
        let isDragging = false;
        const startDrag = (e) => { isDown = true; isDragging = false; startX = (e.pageX || e.touches[0].pageX) - tabsContainer.offsetLeft; scrollLeft = tabsContainer.scrollLeft; tabsContainer.style.cursor = 'grabbing'; };
        const endDrag = () => { isDown = false; isDragging = false; tabsContainer.style.cursor = 'grab'; };
        const moveDrag = (e) => { if (!isDown) return; const x = (e.pageX || (e.touches && e.touches[0].pageX)) - tabsContainer.offsetLeft; if (x === undefined) return; const walk = x - startX; if (Math.abs(walk) > 5) { isDragging = true; } if(isDragging){ e.preventDefault(); } tabsContainer.scrollLeft = scrollLeft - walk; };
        tabsContainer.addEventListener('click', (e) => { if (isDragging) { e.preventDefault(); e.stopPropagation(); } }, true);
        tabsContainer.addEventListener('mousedown', startDrag);
        tabsContainer.addEventListener('mousemove', moveDrag);
        tabsContainer.addEventListener('mouseup', endDrag);
        tabsContainer.addEventListener('mouseleave', endDrag);
        tabsContainer.addEventListener('touchstart', startDrag);
        tabsContainer.addEventListener('touchmove', moveDrag);
        tabsContainer.addEventListener('touchend', endDrag);
    }

    function initializeCarousel() {
      let currentIndex = 0;
      let isDown = false;
      let startX;
      let initialTranslateX;
      let walk = 0;

      function getVisibleCards() {
          return Array.from(allProductCards).filter(card => card.style.display !== 'none');
      }

      function getItemsPerView() {
        // Trên mobile, hiển thị tất cả sản phẩm trong grid
        if (window.innerWidth <= 768) {
          return getVisibleCards().length;
        }
        const visibleCards = getVisibleCards();
        if (visibleCards.length === 0) return 1;
        const containerWidth = productCardsContainer.parentElement.offsetWidth;
        const itemWidth = visibleCards[0].offsetWidth;
        const gap = containerWidth * 0.02;
        if (itemWidth === 0) return 1;
        return Math.floor(containerWidth / (itemWidth + gap)) || 1;
      }

      function getTranslateX() {
          const style = window.getComputedStyle(productCardsContainer);
          const transform = style.transform;
          if (transform === 'none') return 0;
          const matrix = new DOMMatrixReadOnly(transform);
          return matrix.m41;
      }

      function updateCarousel(isResize = false) {
        // Trên mobile, không áp dụng carousel logic
        if (window.innerWidth <= 768) {
          prevBtn.disabled = true;
          nextBtn.disabled = true;
          productCardsContainer.style.transform = `translateX(0px)`;
          return;
        }

        productCardsContainer.style.transition = isResize ? 'none' : 'transform 0.4s ease';
        const visibleCards = getVisibleCards();
        if (visibleCards.length === 0) {
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            productCardsContainer.style.transform = `translateX(0px)`;
            return;
        }
        
        const itemsPerView = getItemsPerView();
        const maxIndex = Math.max(0, visibleCards.length - itemsPerView);
        currentIndex = Math.max(0, Math.min(currentIndex, maxIndex));

        const itemWidth = visibleCards[0].offsetWidth;
        const gap = productCardsContainer.parentElement.offsetWidth * 0.02;
        const translateX = -currentIndex * (itemWidth + gap);
        productCardsContainer.style.transform = `translateX(${translateX}px)`;
        
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex >= maxIndex;

      }

      function dragStart(e) {
        // Không cho phép drag trên mobile
        if (window.innerWidth <= 768) return;
        // Don't start drag if clicking on product card
        if (e.target.closest('.product-card')) {
          isDown = false;
          return;
        }
        isDown = true;
        carouselContainer.classList.add('grabbing');
        startX = e.type === 'touchstart' ? e.touches[0].pageX : e.pageX;
        productCardsContainer.style.transition = 'none';
        initialTranslateX = getTranslateX();
        walk = 0;
        if (e.type === 'touchstart') {
          window.addEventListener('touchmove', dragMove);
          window.addEventListener('touchend', dragEnd);
        }
      }

      function dragMove(e) {
        if (!isDown) return;
        e.preventDefault();
        const currentX = e.type === 'touchmove' ? e.touches[0].pageX : e.pageX;
        walk = currentX - startX;
        productCardsContainer.style.transform = `translateX(${initialTranslateX + walk}px)`;
      }
      

      function dragEnd() {
        if (!isDown) return;
        isDown = false;
        carouselContainer.classList.remove('grabbing');
        window.removeEventListener('touchmove', dragMove);
        window.removeEventListener('touchend', dragEnd);
        
        if (Math.abs(walk) > 10) { 
            const visibleCards = getVisibleCards();
            if (visibleCards.length === 0) return;
            const itemWidth = visibleCards[0].offsetWidth;
            const threshold = itemWidth / 4;
            const itemsPerView = getItemsPerView();
            const maxIndex = Math.max(0, visibleCards.length - itemsPerView);

            if (walk < -threshold && currentIndex < maxIndex) {
                currentIndex++;
            } else if (walk > threshold && currentIndex > 0) {
                currentIndex--;
            }
        }
        updateCarousel();
      }

      carouselContainer.addEventListener('mousedown', dragStart);
      carouselContainer.addEventListener('mousemove', dragMove);
      carouselContainer.addEventListener('mouseup', dragEnd);
      carouselContainer.addEventListener('mouseleave', dragEnd);
      carouselContainer.addEventListener('touchstart', dragStart);

      // Handle click events for product cards
      allProductCards.forEach(card => {
          card.addEventListener('click', (e) => {
              // Allow click to proceed normally to product page
              // The drag logic above already prevents drag on product cards
              return true;
          });
      });

      return {
        next: () => {
          const visibleCards = getVisibleCards();
          const itemsPerView = getItemsPerView();
          const maxIndex = Math.max(0, visibleCards.length - itemsPerView);
          if (currentIndex < maxIndex) { currentIndex++; updateCarousel(); }
        },
        prev: () => {
          if (currentIndex > 0) { currentIndex--; updateCarousel(); }
        },
        reset: () => {
            currentIndex = 0;
            updateCarousel();
        },
        update: () => updateCarousel(true)
      };
    }

    function filterProducts(size) {
      let visibleCount = 0;
      const isMobile = window.innerWidth <= 768;
      const maxMobileCards = isMobile ? 4 : allProductCards.length;
      
      // Reset all cards first
      allProductCards.forEach(card => {
        card.style.display = 'none';
        card.classList.remove('is-visible');
      });
      
      // Show matching cards
      allProductCards.forEach(card => {
        const cardSize = card.getAttribute('data-size');
        if (cardSize === size && visibleCount < maxMobileCards) {
          card.style.display = 'block';
          card.classList.add('is-visible');
          visibleCount++;
        }
      });
      
      // Force reflow để đảm bảo CSS grid cập nhật
      if (isMobile) {
        productCardsContainer.style.display = 'none';
        productCardsContainer.offsetHeight; // Trigger reflow
        productCardsContainer.style.display = 'grid';
      }
      
      if (carousel) carousel.reset();
    }
    
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        tabButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        const targetSize = this.getAttribute('data-size');
        filterProducts(targetSize);
      });
    });

    if (tabButtons.length > 0) {
      
      carousel = initializeCarousel();
      const initialActiveTab = sectionContainer.querySelector('.category-tab.active');
      if (initialActiveTab) {
        const initialSize = initialActiveTab.getAttribute('data-size');
        filterProducts(initialSize);
      }
      
      // Đảm bảo giới hạn 4 sản phẩm trên mobile ngay từ đầu
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          const activeTab = sectionContainer.querySelector('.category-tab.active');
          if (activeTab) {
            const currentSize = activeTab.getAttribute('data-size');
            filterProducts(currentSize);
          }
        }, 100);
      }
    }

    nextBtn.addEventListener('click', () => carousel ? carousel.next() : null);
    prevBtn.addEventListener('click', () => carousel ? carousel.prev() : null);

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        // Nếu chuyển sang mobile, cần filter lại để giới hạn 4 sản phẩm
        if (window.innerWidth <= 768) {
          const activeTab = sectionContainer.querySelector('.category-tab.active');
          if (activeTab) {
            const currentSize = activeTab.getAttribute('data-size');
            filterProducts(currentSize);
          }
        }
        if (carousel) carousel.update();
      }, 250);
    });

    // --- Intersection Observer for Appear Animation ---
    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            obs.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1, rootMargin: '0px 0px 0px 0px' });
      allProductCards.forEach((item, index) => {
        item.style.transitionDelay = `${(index % 4) * 100}ms`;
        observer.observe(item);
      });
    } else {
      allProductCards.forEach(item => item.classList.add('is-visible'));
    }
  });
})();
</script>

{% schema %}
{
  "name": "Sản phẩm theo Kích thước",
  "class": "index-section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Mua sắm theo Kích thước"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Chọn bộ sưu tập để lấy sản phẩm"
    },
    {
      "type": "text",
      "id": "product_label",
      "label": "Product Label",
      "info": "e.g., 'Mới', 'Bán chạy', 'Top rated'"
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Label Text Color",
      "default": "#fff"
    },
    {
      "type": "color",
      "id": "label_bg",
      "label": "Label Background",
      "default": "#609EE9"
    }
  ],
  "presets": [
    {
      "name": "Sản phẩm theo Kích thước",
      "category": "Product"
    }
  ]
}
{% endschema %}
