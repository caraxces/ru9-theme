<div data-section-id="{{ section.id }}" data-section-type="featured-collections">
  <div class="featured-collections-section">
    
    <!-- Header Section -->
    <div class="section-header">
      <div class="header-left">
        <h2 class="section-title">
          {{ section.settings.title | default: 'Sản phẩm bán chạy' }}
        </h2>
      </div>
      <div class="header-right">
        <a href="#" class="view-all-link">
          Xem tất cả
        </a>
      </div>
    </div>
    
    <!-- Category Tabs -->
    <div class="category-tabs-container">
      <div class="category-tabs">
        {%- for block in section.blocks -%}
          <button 
            class="category-tab{% if forloop.index == 1 %} active{% endif %}" 
            data-tab="Tab-{{ block.id }}"
            data-collection-url="{{ block.settings.collection.url }}"
          >
            {{ block.settings.tab_name | default: 'Nệm' }}
          </button>
        {%- endfor -%}
      </div>
      <div class="carousel-nav">
        <button class="nav-btn nav-prev">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.5 9L4.5 6L7.5 3" stroke="#9CA3AF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="nav-btn nav-next">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4.5 9L7.5 6L4.5 3" stroke="#1A1A1A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Product Carousel Section -->
    <div class="product-carousel-section">
      <div class="product-carousel">
        <div class="product-cards-container">
          {%- for block in section.blocks -%}
            <div class="tab-content{% if forloop.index == 1 %} active{% endif %}" id="Tab-content-{{ block.id }}">
              
              {%- assign collection = block.settings.collection -%}
              {%- if collection != blank -%}
                {%- for product in collection.products -%}
                  <a href="{{ product.url }}" class="product-card">
                    <div class="product-image-container{% if product.media.size > 1 %} has-secondary-image{% endif %}">
                      {%- if block.settings.product_label != blank -%}
                        <div class="product-label" style="color: {{ block.settings.label_color | default: '#fff' }}; background: {{ block.settings.label_bg | default: '#609EE9' }};">
                          {{ block.settings.product_label }}
                        </div>
                      {%- endif -%}
                      {%- if product.featured_image -%}
                        <img 
                          class="product-image-primary"
                          src="{{ product.featured_image | image_url: width: 400, height: 320, crop: 'center' }}" 
                          alt="{{ product.title }}"
                          width="400" height="320"
                          loading="lazy"
                        >
                        {%- if product.media.size > 1 -%}
                          {%- for media in product.media offset: 1 limit: 1 -%}
                            {%- assign second_image = media.preview_image -%}
                            {%- if second_image != blank -%}
                              <img 
                                class="product-image-secondary"
                                src="{{ second_image | image_url: width: 400, height: 320, crop: 'center' }}" 
                                alt="{{ product.title }}"
                                width="400" height="320"
                                loading="lazy"
                              >
                            {%- endif -%}
                          {%- endfor -%}
                        {%- endif -%}
                      {%- else -%}
                        <div class="placeholder-image">
                          No Image
                        </div>
                      {%- endif -%}
                    </div>
                    
                    <div class="product-info">
                      <div class="product-rating">
                        <svg width="81" height="14" viewBox="0 0 81 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M6.84155 0.245755C6.94841 -0.0819184 7.41368 -0.0819184 7.52054 0.245755L8.97105 4.69322C9.01883 4.83976 9.15591 4.93898 9.31055 4.93898H14.0044C14.3502 4.93898 14.494 5.37983 14.2143 5.58238L10.4169 8.33108C10.2917 8.4216 10.2394 8.58218 10.2872 8.72871L11.7377 13.1762C11.8445 13.5038 11.4681 13.7763 11.1883 13.5738L7.3909 10.8251C7.26577 10.7346 7.09632 10.7346 6.9712 10.8251L3.1738 13.5738C2.89403 13.7763 2.51759 13.5038 2.62445 13.1762L4.07493 8.72871C4.12273 8.58218 4.07037 8.4216 3.94525 8.33108L0.147842 5.58238C-0.131937 5.37983 0.0118471 4.93898 0.357675 4.93898H5.05154C5.20618 4.93898 5.34326 4.83976 5.39104 4.69322L6.84155 0.245755Z" fill="#FFDC5F"/>
                          <path d="M23.5007 0.245755C23.6076 -0.0819184 24.0729 -0.0819184 24.1797 0.245755L25.6302 4.69322C25.678 4.83976 25.8151 4.93898 25.9697 4.93898H30.6636C31.0094 4.93898 31.1532 5.37983 30.8735 5.58238L27.0761 8.33108C26.9509 8.4216 26.8986 8.58218 26.9463 8.72871L28.3969 13.1762C28.5037 13.5038 28.1273 13.7763 27.8475 13.5738L24.0501 10.8251C23.925 10.7346 23.7555 10.7346 23.6304 10.8251L19.833 13.5738C19.5532 13.7763 19.1768 13.5038 19.2836 13.1762L20.7341 8.72871C20.7819 8.58218 20.7295 8.4216 20.6044 8.33108L16.807 5.58238C16.5272 5.37983 16.671 4.93898 17.0169 4.93898H21.7107C21.8654 4.93898 22.0025 4.83976 22.0502 4.69322L23.5007 0.245755Z" fill="#FFDC5F"/>
                          <path d="M40.1609 0.245755C40.2678 -0.0819184 40.733 -0.0819184 40.8399 0.245755L42.2904 4.69322C42.3382 4.83976 42.4753 4.93898 42.6299 4.93898H47.3238C47.6696 4.93898 47.8134 5.37983 47.5336 5.58238L43.7362 8.33108C43.6111 8.4216 43.5587 8.58218 43.6065 8.72871L45.057 13.1762C45.1639 13.5038 44.7874 13.7763 44.5077 13.5738L40.7102 10.8251C40.5851 10.7346 40.4157 10.7346 40.2905 10.8251L36.4931 13.5738C36.2134 13.7763 35.8369 13.5038 35.9438 13.1762L37.3943 8.72871C37.4421 8.58218 37.3897 8.4216 37.2646 8.33108L33.4672 5.58238C33.1874 5.37983 33.3312 4.93898 33.677 4.93898H38.3709C38.5255 4.93898 38.6626 4.83976 38.7104 4.69322L40.1609 0.245755Z" fill="#FFDC5F"/>
                          <path d="M56.8201 0.245755C56.9269 -0.0819184 57.3922 -0.0819184 57.4991 0.245755L58.9493 4.69322C58.9975 4.83976 59.1343 4.93898 59.289 4.93898H63.9828C64.3285 4.93898 64.4725 5.37983 64.1929 5.58238L60.3951 8.33108C60.2701 8.4216 60.2178 8.58218 60.266 8.72871L61.716 13.1762C61.823 13.5038 61.4464 13.7763 61.1668 13.5738L57.3694 10.8251C57.2443 10.7346 57.0748 10.7346 56.9497 10.8251L53.1523 13.5738C52.8725 13.7763 52.4961 13.5038 52.603 13.1762L54.0535 8.72871C54.1012 8.58218 54.0489 8.4216 53.9238 8.33108L50.1263 5.58238C49.8466 5.37983 49.9904 4.93898 50.3362 4.93898H55.0301C55.1847 4.93898 55.3218 4.83976 55.3696 4.69322L56.8201 0.245755Z" fill="#FFDC5F"/>
                          <path d="M73.4789 0.245755C73.586 -0.0819184 74.0513 -0.0819184 74.1584 0.245755L75.6084 4.69322C75.6566 4.83976 75.7934 4.93898 75.9481 4.93898H80.6419C80.9876 4.93898 81.1316 5.37983 80.852 5.58238L77.0542 8.33108C76.9292 8.4216 76.8769 8.58218 76.9251 8.72871L78.3751 13.1762C78.4822 13.5038 78.1055 13.7763 77.8259 13.5738L74.0287 10.8251C73.9032 10.7346 73.7342 10.7346 73.6086 10.8251L69.8115 13.5738C69.5318 13.7763 69.1552 13.5038 69.2623 13.1762L70.7123 8.72871C70.7605 8.58218 70.7081 8.4216 70.5832 8.33108L66.7854 5.58238C66.5057 5.37983 66.6497 4.93898 66.9954 4.93898H71.6892C71.8439 4.93898 71.9808 4.83976 72.029 4.69322L73.4789 0.245755Z" fill="#FFDC5F"/>
                        </svg>
                        {%- assign rating = product.metafields.reviews.rating.value -%}
                        {%- if rating != blank -%}
                          <span class="rating-score">{{ rating.rating | round: 1 }}</span>
                          <span class="rating-count">({{ product.metafields.reviews.rating_count }})</span>
                        {%- endif -%}
                      </div>
                      <h3 class="product-name">{{ product.title }}</h3>
                      {% comment %} <div class="product-meta">25cm, 6 sizes</div> {% endcomment %}
                      <div class="product-price">
                        <span class="price">Từ {{ product.price | money }}</span>
                        {%- if product.compare_at_price > product.price -%}
                           {%- assign sale_percentage = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round -%}
                          <span class="discount-badge">-{{ sale_percentage }}%</span>
                          <span class="compare-price">{{ product.compare_at_price | money }}</span>
                        {%- endif -%}
                      </div>
                    </div>
                  </a>
                {%- endfor -%}
              {%- endif -%}
            </div>
          {%- endfor -%}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* General Section Styles */
  @media (min-width: 769px) {
    [data-section-type="featured-collections"] .featured-collections-section {
      width: 100%;
      max-width: 1360px;
      min-height: auto;
      margin: 0 auto 1.7rem auto;
      padding: 0 4.3rem 0 4.3rem;
      font-family: 'Be Vietnam Pro', sans-serif;
    }
  }
  [data-section-type="featured-collections"] .featured-collections-section .section-header {
    padding-bottom: 0px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }
  [data-section-type="featured-collections"] .header-left {
    flex: 1;
    text-align: left;
  }
  [data-section-type="featured-collections"] .featured-collections-section .section-title {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 33px;
    font-weight: 700;
    line-height: 120%;
    color: #1C2C58;
    margin: 0;
    text-align: left;
  }
  [data-section-type="featured-collections"] .header-right {
    display: flex;
    align-items: flex-start;
    padding-top: 0;
  }
  [data-section-type="featured-collections"] .view-all-link {
    color: #1A1A1A;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 20px;
    font-weight: 500;
    text-decoration: underline;
    line-height: 1;
  }
  [data-section-type="featured-collections"] .view-all-link:hover {
    color: #000 !important;
  }

  /* Category Tabs */
  [data-section-type="featured-collections"] .category-tabs-container {
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  [data-section-type="featured-collections"] .category-tabs {
    display: flex;
    gap: 14px;
    align-items: center;
    flex: 1;
    overflow-x: auto;
    overflow-y: hidden;
    flex-wrap: nowrap;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }
  [data-section-type="featured-collections"] .category-tab {
    display: flex;
    height: 38px;
    min-height: 38px;
    padding: 10px 20px;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    border-radius: 100.1px;
    border: 1px solid transparent;
    background: #FFFBE9;
    color: #1A1A1A;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }
  [data-section-type="featured-collections"] .category-tab:hover {
    background: #e9ecef;
  }
  [data-section-type="featured-collections"] .category-tab.active {
    background: #FFD35B;
    color: #1A1A1A;
    font-weight: 600;
  }

  /* Hide scrollbar for category tabs */
  [data-section-type="featured-collections"] .category-tabs::-webkit-scrollbar {
    display: none;
  }
  [data-section-type="featured-collections"] .category-tabs {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Carousel Styles */
  [data-section-type="featured-collections"] .product-carousel-section {
    position: relative; 
  }
  [data-section-type="featured-collections"] .product-carousel {
    position: relative;
    overflow: hidden;
    cursor: grab;
    padding-bottom: 40px; /* Space for fixed scrollbar */
  }
  [data-section-type="featured-collections"] .product-carousel.grabbing {
    cursor: grabbing;
  }
  [data-section-type="featured-collections"] .product-carousel.grabbing .product-card {
    pointer-events: none;
  }
  [data-section-type="featured-collections"] .product-cards-container {
    display: flex;
    gap: 2%;
    padding-right: 0;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Custom scrollbar styling - Always show on desktop */
  [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar {
    height: 8px;
  }
  [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar-track {
    background: #F0F1EF;
    border-radius: 100px;
  }
  [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar-thumb {
    background: #234085;
    border-radius: 100px;
  }
  [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar-thumb:hover {
    background: #1a2f6b;
  }
  [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar-button {
    display: none;
  }
  
  [data-section-type="featured-collections"] .tab-content {
    display: none;
    padding-bottom: 20px;
    padding-right: 0;
    gap: 2%;
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    flex-wrap: nowrap;
  }
  [data-section-type="featured-collections"] .tab-content.active {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    flex-wrap: nowrap;
    padding-right: 0;
  }
  
  [data-section-type="featured-collections"] .tab-content.is-dragging {
    cursor: grabbing;
    user-select: none;
  }
  
  [data-section-type="featured-collections"] .tab-content.is-dragging .product-card {
    pointer-events: none;
  }

  /* Mobile tab-content styling */
  @media (max-width: 768px) {
    [data-section-type="featured-collections"] .tab-content {
      display: none;
      padding: 0;
      gap: 4%;
      width: 100%;
      overflow: visible;
      flex-wrap: nowrap;
    }
    [data-section-type="featured-collections"] .tab-content.active {
      display: flex;
      overflow: visible;
      flex-wrap: nowrap;
      padding: 0 0 20px 0;
    }
  }

  /* Carousel Navigation */
  [data-section-type="featured-collections"] .carousel-nav {
    display: flex;
    gap: 7px;
  }
  [data-section-type="featured-collections"] .nav-btn {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    border: none;
  }
  [data-section-type="featured-collections"] .nav-btn.nav-prev {
    background: #FFF9E5;
  }
  [data-section-type="featured-collections"] .nav-btn.nav-prev:hover {
    background: #FFF3CD;
  }
  [data-section-type="featured-collections"] .nav-btn.nav-next {
    background: #FFF9E5;
  }
  [data-section-type="featured-collections"] .nav-btn.nav-next:hover {
    background: #FBC947;
  }
  [data-section-type="featured-collections"] .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Custom scrollbar styling for tab-content - Always show on desktop */
  [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar {
    height: 8px;
  }
  [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar-track {
    background: #F0F1EF;
    border-radius: 100px;
  }
  [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar-thumb {
    background: #234085;
    border-radius: 100px;
  }
  [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar-thumb:hover {
    background: #1a2f6b;
  }
  [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar-button {
    display: none;
  }

  /* Mobile scrollbar styling */
  @media (max-width: 768px) {
    [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar {
      height: 8px;
    }
    [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar-track {
      background: #F0F1EF;
      border-radius: 100px;
    }
    [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar-thumb {
      background: #234085;
      border-radius: 100px;
    }
    [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar-thumb:hover {
      background: #1a2f6b;
    }
    [data-section-type="featured-collections"] .tab-content::-webkit-scrollbar-button {
      display: none;
    }
  }

  /* Product Card Styles */
  [data-section-type="featured-collections"] .product-card {
    width: calc((100% - 4.3rem) / 4);
    flex-shrink: 0;
    border-radius: 4px;
    overflow: hidden;
    text-decoration: none;
    color: inherit;
    display: block;
    opacity: 1;
    transform: none;
  }

  [data-section-type="featured-collections"] .product-image-container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 75%;
    border-radius: 7px;
    overflow: hidden;
    margin-bottom: 21px;
    background: #F8F9FA;
    cursor: pointer;
  }
  [data-section-type="featured-collections"] .placeholder-image {
    width: 100%;
    height: 100%;
    background: #E9ECEF;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6C757D;
    border-radius: 7px;
  }
  [data-section-type="featured-collections"] .product-label {
    position: absolute;
    top: 9px;
    left: 9px;
    padding: 3px 7px;
    border-radius: 4px;
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 12px;
    font-weight: 400;
    color: #fff;
    background: #609EE9;
    z-index: 2;
    box-shadow: 0 2px 7px rgba(0,0,0,0.1);
  }
  [data-section-type="featured-collections"] .product-image-primary, [data-section-type="featured-collections"] .product-image-secondary {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 7px;
    transition: opacity 0.3s ease;
  }
  [data-section-type="featured-collections"] .product-image-secondary {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
  }
  [data-section-type="featured-collections"] .product-image-container.has-secondary-image:hover .product-image-primary,
  [data-section-type="featured-collections"] .product-carousel.grabbing .product-image-container.has-secondary-image:hover .product-image-primary {
    opacity: 0 !important;
  }
  [data-section-type="featured-collections"] .product-image-container.has-secondary-image:hover .product-image-secondary,
  [data-section-type="featured-collections"] .product-carousel.grabbing .product-image-container.has-secondary-image:hover .product-image-secondary {
    opacity: 1 !important;
  }
  [data-section-type="featured-collections"] .product-info {
    padding: 0;
    margin: 0;
    text-align: left;
  }
  [data-section-type="featured-collections"] .product-rating {
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  [data-section-type="featured-collections"] .rating-score {
    font-size: 10px;
    font-weight: 600;
  }
  [data-section-type="featured-collections"] .rating-count {
    font-size: 10px;
    color: #666;
  }
  [data-section-type="featured-collections"] .product-name {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 17px;
    font-weight: 500;
    color: #1C2C58;
    margin: 0 0 5px 0;
    line-height: 140%;
  }
  [data-section-type="featured-collections"] .product-meta {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 17px;
    font-weight: 400;
    color: #666;
    margin-bottom: 5px;
  }
  [data-section-type="featured-collections"] .product-price {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 3px 0px;
    line-height: 1.2;
  }
  [data-section-type="featured-collections"] .price {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 17px;
    font-weight: 600;
    color: #1A1A1A;
    padding-right: 7px;
  }
  [data-section-type="featured-collections"] .discount-badge {
    font-size: 12px;
    font-weight: 600;
    color: #234085;
    background: #FCE390;
    padding: 2px 7px;
    border-radius: 3px;
  }
  [data-section-type="featured-collections"] .compare-price {
    font-family: 'Be Vietnam Pro', sans-serif;
    font-size: 12px;
    color: #999;
    text-decoration: line-through;
    width: 100%;
  }
  
  /* ========================================
     FIXED TEMPLATE - NO RESPONSIVE
     Template cố định như Koala mattress
     ======================================== */

  /* Mobile Layout */
  @media (max-width: 768px) {
    [data-section-type="featured-collections"] .featured-collections-section {
      padding: 0 20px;
    }
    [data-section-type="featured-collections"] .view-all-link {
      font-size: 16px;
    }
    [data-section-type="featured-collections"] .featured-collections-section .section-header {
      flex-direction: row !important;
      flex-wrap: wrap;
      align-items: center;
      padding-bottom: 0px !important;
      margin-bottom: 20px;
    }
    
    [data-section-type="featured-collections"] .header-left {
      order: 1;
      flex: 1 1 auto;
    }
    
    [data-section-type="featured-collections"] .header-right {
      order: 2;
      flex: 0 0 auto;
      align-items: center;
    }
    
    [data-section-type="featured-collections"] .category-tabs-container .carousel-nav {
      display: none;
    }
    
    [data-section-type="featured-collections"] .featured-collections-section .section-title {
      font-size: 20px;
      margin-bottom: 0;
      text-align: left;
    }
    
    [data-section-type="featured-collections"] .category-tabs-container {
      order: 3;
      width: 100%;
      margin: 0 0 0 -20px;
      position: relative;
      flex-direction: column;
      align-items: flex-start;
      z-index: 10;
    }
    
    [data-section-type="featured-collections"] .category-tabs-container .carousel-nav {
      display: none;
    }
    
    [data-section-type="featured-collections"] .category-tabs {
      flex-wrap: nowrap;
      justify-content: flex-start;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      cursor: grab;
      padding: 0 20px 30px;
      width: 410px;
    }
    [data-section-type="featured-collections"] .category-tab {
      flex-shrink: 0 !important;
      white-space: nowrap !important;
    }
    
    [data-section-type="featured-collections"] .category-tabs::-webkit-scrollbar {
        display: none;
    }
    
    [data-section-type="featured-collections"] .product-carousel-section {
      margin: 0 -20px 0 -20px;
      padding: 0 20px;
    }
    
    [data-section-type="featured-collections"] .product-carousel {
      padding: 0 0 10px 0;
    }
    
    [data-section-type="featured-collections"] .product-cards-container {
      gap: 20px !important;
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: nowrap !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      -webkit-overflow-scrolling: touch !important;
    }
    
    /* Mobile scrollbar styling */
    [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar {
      height: 8px !important;
    }
    [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar-track {
      background: #F0F1EF !important;
      border-radius: 100px !important;
    }
    [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar-thumb {
      background: #234085 !important;
      border-radius: 100px !important;
    }
    [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar-thumb:hover {
      background: #1a2f6b !important;
    }
    [data-section-type="featured-collections"] .product-cards-container::-webkit-scrollbar-button {
      display: none !important;
    }
    
    [data-section-type="featured-collections"] .product-card {
      width: 280px !important;
      flex-shrink: 0;
      min-width: 280px;
    }
    
    [data-section-type="featured-collections"] .product-image-container {
      width: 100% !important;
      height: 200px !important;
      flex-shrink: 0 !important;
      aspect-ratio: unset !important;
      border-radius: 3px !important;
      margin-bottom: 0px !important;
    }
    
    [data-section-type="featured-collections"] .product-name {
      font-size: 18px !important;
    }
    
    [data-section-type="featured-collections"] .product-info {
      padding: 12px 0 0 0 !important;
    }
    
    [data-section-type="featured-collections"] .price {
      font-size: 14px !important;
    }
  }
  
</style>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const sectionId = '{{ section.id }}';
    const sectionContainer = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (!sectionContainer) return;

    const tabButtons = sectionContainer.querySelectorAll('.category-tab');
    const tabContents = sectionContainer.querySelectorAll('.tab-content');
    const viewAllBtn = sectionContainer.querySelector('.view-all-link');
    const progressBarContainer = sectionContainer.querySelector('.carousel-progress-container');
    const progressBar = sectionContainer.querySelector('.carousel-progress-bar');
    const prevBtn = sectionContainer.querySelector('.nav-prev');
    const nextBtn = sectionContainer.querySelector('.nav-next');
    const carouselContainer = sectionContainer.querySelector('.product-carousel');
    
    let carousels = {};

    // --- Drag-to-scroll for tabs ---
    const tabsContainer = sectionContainer.querySelector('.category-tabs');
    if (tabsContainer) {
        let isDown = false;
        let startX;
        let scrollLeft;
        let isDragging = false;

        const startDrag = (e) => {
            isDown = true;
            isDragging = false;
            startX = (e.pageX || e.touches[0].pageX) - tabsContainer.offsetLeft;
            scrollLeft = tabsContainer.scrollLeft;
            tabsContainer.style.cursor = 'grabbing';
        };

        const endDrag = () => {
            isDown = false;
            isDragging = false;
            tabsContainer.style.cursor = 'grab';
        };

        const moveDrag = (e) => {
            if (!isDown) return;
            const x = (e.pageX || (e.touches && e.touches[0].pageX)) - tabsContainer.offsetLeft;
            if (x === undefined) return;
            
            const walk = x - startX;
            if (Math.abs(walk) > 5) {
                isDragging = true;
            }
            if(isDragging){
                 e.preventDefault();
            }

            tabsContainer.scrollLeft = scrollLeft - walk;
        };
        
        tabsContainer.addEventListener('click', (e) => {
            if (isDragging) {
                e.preventDefault();
                e.stopPropagation();
            }
        }, true);

        tabsContainer.addEventListener('mousedown', startDrag);
        tabsContainer.addEventListener('mousemove', moveDrag);
        tabsContainer.addEventListener('mouseup', endDrag);
        tabsContainer.addEventListener('mouseleave', endDrag);

        tabsContainer.addEventListener('touchstart', startDrag);
        tabsContainer.addEventListener('touchmove', moveDrag);
        tabsContainer.addEventListener('touchend', endDrag);
    }

    function initializeCarouselForTab(tabContent) {
      const carouselId = tabContent.id;
      
      if (carousels[carouselId] && carousels[carouselId].initialized) return;

      const productCards = tabContent.querySelectorAll('.product-card');
      
      if (productCards.length === 0) return;

      // Check if mobile device
      const isMobile = window.innerWidth <= 768;
      
      if (!isMobile) {
        // Desktop: Use native scroll with smooth drag
        let isPointerDown = false;
        let hasExceededThreshold = false;
        let shouldSuppressClick = false;
        let startPos = 0;
        let startScrollLeft = 0;
        const dragThreshold = 6;

        function startDrag(e) {
          isPointerDown = true;
          hasExceededThreshold = false;
          startPos = e.type.includes('mouse') ? e.pageX : (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
          startScrollLeft = tabContent.scrollLeft;
          tabContent.style.transition = 'none';
          tabContent.classList.remove('is-dragging');
        }

        function drag(e) {
          if (!isPointerDown) return;
          const currentPosition = e.type.includes('mouse') ? e.pageX : (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
          const deltaX = currentPosition - startPos;

          if (!hasExceededThreshold && Math.abs(deltaX) > dragThreshold) {
            hasExceededThreshold = true;
            shouldSuppressClick = true;
            tabContent.classList.add('is-dragging');
          }

          if (hasExceededThreshold) {
            e.preventDefault();
            tabContent.scrollLeft = startScrollLeft - deltaX;
          }
        }

        function endDrag() {
          if (!isPointerDown) return;
          isPointerDown = false;
          hasExceededThreshold = false;
          tabContent.classList.remove('is-dragging');
          requestAnimationFrame(() => {
            shouldSuppressClick = false;
          });
        }

        // Event listeners for desktop only
        tabContent.querySelectorAll('img').forEach(img => img.addEventListener('dragstart', (e) => e.preventDefault()));
        
        tabContent.addEventListener('mousedown', startDrag);
        tabContent.addEventListener('mousemove', drag);
        tabContent.addEventListener('mouseup', endDrag);
        tabContent.addEventListener('mouseleave', endDrag);

        // Handle click events for product cards - block if was dragging
        tabContent.querySelectorAll('.product-card').forEach(card => {
          card.addEventListener('click', (e) => {
            if (shouldSuppressClick) {
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
            return true;
          });
        });
      } else {
        // Mobile: Use native touch scrolling - no custom handlers needed
        // Just prevent image drag
        tabContent.querySelectorAll('img').forEach(img => {
          img.addEventListener('dragstart', (e) => e.preventDefault());
        });
      }

      carousels[carouselId] = {
        initialized: true,
        next: () => {
          tabContent.scrollBy({
            left: 400,
            behavior: 'smooth'
          });
        },
        prev: () => {
          tabContent.scrollBy({
            left: -400,
            behavior: 'smooth'
          });
        },
        reset: () => {
          tabContent.scrollTo({
            left: 0,
            behavior: 'smooth'
          });
        },
        update: () => {}
      };
    }
    
    function getActiveCarousel() {
        const activeContent = sectionContainer.querySelector('.tab-content.active');
        return activeContent ? carousels[activeContent.id] : null;
    }

    nextBtn.addEventListener('click', () => {
      const activeCarousel = getActiveCarousel();
      if (activeCarousel) activeCarousel.next();
    });

    prevBtn.addEventListener('click', () => {
      const activeCarousel = getActiveCarousel();
      if (activeCarousel) activeCarousel.prev();
    });

    function updateViewAllButton(activeButton) {
      const collectionUrl = activeButton.getAttribute('data-collection-url');
      if (viewAllBtn && collectionUrl) {
        viewAllBtn.href = collectionUrl;
      } else if (viewAllBtn) {
        viewAllBtn.href = '#'; // Fallback
      }
    }

    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        const targetContent = document.getElementById('Tab-content-' + tabId.split('-')[1]);
        
        tabButtons.forEach(btn => {
          btn.classList.remove('active');
        });
        this.classList.add('active');
        
        tabContents.forEach(content => {
          content.classList.remove('active');
          content.style.display = 'none';
        });

        targetContent.classList.add('active');
        targetContent.style.display = 'flex';
        
        updateViewAllButton(this);
        initializeCarouselForTab(targetContent);
        
        const activeCarousel = getActiveCarousel();
        if (activeCarousel) activeCarousel.reset();
      });
    });

    const initialActiveTab = sectionContainer.querySelector('.category-tab.active');
    
    if (initialActiveTab) {
      updateViewAllButton(initialActiveTab);
      const initialTabContent = sectionContainer.querySelector('.tab-content.active');
      if (initialTabContent) {
        initializeCarouselForTab(initialTabContent);
      }
    }

    // Handle resize to reinitialize carousels when switching between mobile/desktop
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Reset all carousels and reinitialize
        carousels = {};
        const activeTabContent = sectionContainer.querySelector('.tab-content.active');
        if (activeTabContent) {
          initializeCarouselForTab(activeTabContent);
        }
      }, 250);
    });

    // Animation removed - products show immediately

  });
})();
</script>

{% schema %}
{
  "name": "Featured Collections",
  "class": "index-section",
  "disabled_on": {
    "groups": ["footer", "header", "custom.popups"]
  },
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Sản Phẩm Bán Chạy"
    },
    {
      "type": "text",
      "id": "description",
      "label": "Section Description",
      "default": "Chiếc nệm foam êm ái cho giấc ngủ thoải mái nhất"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#2960AD"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#1A1A1A"
    },
    {
      "type": "color",
      "id": "description_color",
      "label": "Description Color",
      "default": "#666"
    }
  ],
  "blocks": [
    {
      "type": "collection_tab",
      "name": "Collection Tab",
      "limit": 4,
      "settings": [
        {
          "type": "text",
          "id": "tab_name",
          "default": "Nệm",
          "label": "Tab Name"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection",
          "info": "Select collection to display products"
        },
        {
          "type": "text",
          "id": "product_label",
          "label": "Product Label",
          "info": "e.g., 'Mới', 'Bán chạy', 'Top rated'"
        },
        {
          "type": "color",
          "id": "label_color",
          "label": "Label Text Color",
          "default": "#fff"
        },
        {
          "type": "color",
          "id": "label_bg",
          "label": "Label Background",
          "default": "#609EE9"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Featured Collections",
      "category": "Product",
      "blocks": [
        {
          "type": "collection_tab"
        }
      ]
    }
  ]
}
{% endschema %}
