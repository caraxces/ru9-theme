{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  
  # Check section settings only - more robust check
  assign has_bundle_products = false
  assign bundle_products_list = blank
  
  if section.settings.bundle_products
    # Check if it's not empty by trying to access first element
    assign first_product = section.settings.bundle_products | first
    if first_product != blank
      assign has_bundle_products = true
      assign bundle_products_list = section.settings.bundle_products
    endif
  endif
-%}

{{ 'main-product-bundle.css' | asset_url | stylesheet_tag }}
{{ 'bundle-init.css' | asset_url | stylesheet_tag }}
<script src="{{ 'bundle-utils.js' | asset_url }}" defer></script>

{%- comment -%}
  BUNDLE PRICING CALCULATOR - Only visible in Theme Editor
{%- endcomment -%}
{%- if request.design_mode -%}
<div class="bundle-pricing-calculator" style="background: #FFF9E6; border: 2px solid #FFD700; border-radius: 8px; padding: 20px; margin: 20px auto; max-width: 800px;">
  <h3 style="color: #1C2C58; margin: 0 0 16px 0; font-size: 20px;">üí∞ Bundle Pricing Calculator</h3>
  
  <div class="calculator-info" style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <div style="margin-bottom: 12px;">
      <strong>üéØ Target Discount:</strong> 
      <span style="color: #234085; font-size: 24px; font-weight: bold;">{{ section.settings.target_discount_percentage | default: 15 }}%</span>
    </div>
    
    <div id="calculator-results" style="border-top: 1px solid #E0E0E0; padding-top: 12px; margin-top: 12px;">
      <p style="margin: 8px 0; color: #666; font-size: 14px;">
        ‚è≥ <em>Calculator s·∫Ω t·ª± ƒë·ªông t√≠nh khi c√≥ bundle products...</em>
      </p>
    </div>
  </div>
  
  <div style="background: #E3F2FD; padding: 12px; border-radius: 6px; font-size: 13px;">
    <strong>üìù L∆∞u √Ω:</strong> Calculator n√†y CH·ªà hi·ªÉn th·ªã trong Theme Editor. Kh√°ch h√†ng KH√îNG nh√¨n th·∫•y.
  </div>
</div>
{%- endif -%}

<div id="MainProductBundle-{{ section.id }}" class="bundle-main-container">
  <div class="bundle-loading-overlay">
    <div class="spinner"></div>
  </div>
  
  <div class="bundle-dynamic-content">
    <!-- Step 1: Default Product Display -->
    <div class="bundle-step bundle-step-1" data-step="1">
      {%- liquid
        assign product_zoom_size = '1800x1800'
        
        case section.settings.image_size
          when 'small'
            assign product_image_width = 'medium-up--two-fifths'
            assign product_description_width = 'medium-up--three-fifths'
          when 'medium'
            assign product_image_width = 'large-up--one-half'
            assign product_description_width = 'large-up--one-half'
          when 'large'
            assign product_image_width = 'large-up--three-fifths'
            assign product_description_width = 'large-up--two-fifths'
        endcase
      -%}

      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid{% unless section.settings.image_position == 'left' %} grid--product-images-right{% endunless %}{% if section.settings.mobile_layout == 'partial' %} grid--product-images--partial{% endif %}">
            {%- if section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                {%- render 'product-images',
                  section_id: section.id,
                  product: product,
                  product_zoom_enable: section.settings.product_zoom_enable,
                  product_zoom_size: product_zoom_size,
                  product_carousel_enable: true,
                  thumbnail_position: 'below',
                  thumbnail_height: section.settings.thumbnail_height,
                  thumbnail_arrows: section.settings.thumbnail_arrows,
                  mobile_layout: section.settings.mobile_layout,
                  blocks: section.blocks,
                  context: 'main-product',
                  sizes: sizes,
                  sizeVariable: product_image_width,
                  fallback: product_image_size,
                  video_looping: section.settings.enable_video_looping,
                  video_style: section.settings.video_style
                -%}
                <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            {%- endif -%}

            <div class="grid__item {{ product_description_width }} product-grid__info">
              <div class="product-single__meta product-info-inner">
                <div class="product-block product-block--header">
                  {%- if settings.vendor_enable -%}
                    <div class="product-single__vendor">
                      {%- assign vendor_handle = product.vendor | handleize -%}
                      {%- if collections[vendor_handle] != empty -%}
                        <a href="{{ routes.collections_url }}/{{ collections[vendor_handle].handle }}">
                          {{ collections[vendor_handle].title }}
                        </a>
                      {%- else -%}
                        {{ product.vendor | link_to_vendor }}
                      {%- endif -%}
                    </div>
                  {%- endif -%}

                  <!-- Product Reviews Section -->
                  {%- liquid
                    assign has_reviews = false
                    assign review_rating = 0
                    assign review_count = 0
                    
                    if product.metafields.reviews.rating.value != blank
                      assign has_reviews = true
                      assign review_rating = product.metafields.reviews.rating.value.rating
                      assign review_count = product.metafields.reviews.rating_count
                    elsif product.metafields.judgeme.rating != blank
                      assign has_reviews = true
                      assign review_rating = product.metafields.judgeme.rating
                      assign review_count = product.metafields.judgeme.review_count
                    endif
                  -%}
                  
                  <div class="product-reviews-summary">
                    <div class="product-rating">
                      {%- if has_reviews -%}
                        {%- liquid
                          assign rating_floor = review_rating | floor
                          assign rating_decimal = review_rating | modulo: 1
                          assign has_half_star = false
                          if rating_decimal >= 0.25 and rating_decimal < 0.75
                            assign has_half_star = true
                          elsif rating_decimal >= 0.75
                            assign rating_floor = rating_floor | plus: 1
                          endif
                        -%}
                      <div class="stars">
                          {%- for i in (1..5) -%}
                            {%- liquid
                              assign next_star = rating_floor | plus: 1
                              assign is_half_star = false
                              if i == next_star and has_half_star
                                assign is_half_star = true
                              endif
                            -%}
                            {%- if i <= rating_floor -%}
                              <span class="star star--filled">‚òÖ</span>
                            {%- elsif is_half_star -%}
                              <span class="star star--half">‚òÖ</span>
                            {%- else -%}
                              <span class="star star--empty">‚òÜ</span>
                            {%- endif -%}
                          {%- endfor -%}
                      </div>
                        <span class="rating-value">{{ review_rating | round: 1 }}</span>
                      {%- else -%}
                        <div class="stars">
                          <span class="star star--filled">‚òÖ</span>
                          <span class="star star--filled">‚òÖ</span>
                          <span class="star star--filled">‚òÖ</span>
                          <span class="star star--filled">‚òÖ</span>
                          <span class="star star--filled">‚òÖ</span>
                    </div>
                      {%- endif -%}
                    </div>
                    {%- if has_reviews and review_count > 0 -%}
                    <div class="reviews-count">
                        <span class="reviews-number">({{ review_count }} ƒë√°nh gi√°)</span>
                    </div>
                    {%- endif -%}
                  </div>

                  <h1 class="h2 product-single__title">
                    {%- unless product.empty? -%}
                      {{ product.title }}
                    {%- else -%}
                      {{ 'home_page.onboarding.product_title' | t }}
                    {%- endunless -%}
                  </h1>

                  {%- if section.settings.product_subtitle != blank -%}
                    <div class="product-single__subtitle">
                      {{ section.settings.product_subtitle }}
                    </div>
                  {%- endif -%}

                  {%- if section.settings.sku_enable -%}
                    <p data-sku class="product-single__sku">
                      {%- if current_variant.sku -%}
                        {{ current_variant.sku }}
                      {%- endif -%}
                    </p>
                  {%- endif -%}
                </div>

                <div data-product-blocks>
                  <!-- Price Block -->
                  <div class="product-block product-block--price">
                    <div class="price-container-wrapper">
                      <span class="product__price text-2xl f-smb">
                        {{ current_variant.price | money }}
                      </span>
                      {%- if current_variant.compare_at_price > current_variant.price -%}
                        <span class="product__price product__price--compare text-xl">
                          {{ current_variant.compare_at_price | money }}
                        </span>
                      {%- endif -%}
                      {%- if current_variant.compare_at_price > current_variant.price -%}
                        {%- capture discount_percentage -%}{{ current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round }}{%- endcapture -%}
                        <div class="product__discount-badge">-{{ discount_percentage }}%</div>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Combo Products List -->
                  <div class="product-block">
                      <h3 class="combo_title" style="background-color: #F5F9FF; padding: 10px; border-radius: 5px; margin: 0 0 0 0;">{{ section.settings.combo_title | default: "Combo bao g·ªìm c√°c s·∫£n ph·∫©m:" }}</h3>
                    <div class="combo-products-list">
                      {%- if has_bundle_products and bundle_products_list -%}
                        {%- for bundle_product in bundle_products_list -%}
                          {%- liquid
                            # Determine quantity for this product
                            assign product_quantity = 1
                            if forloop.index == 3 and section.settings.product_3_quantity
                              assign product_quantity = section.settings.product_3_quantity
                            endif
                            
                            # Calculate total variant options (nh√¢n t·∫•t c·∫£ options v·ªõi nhau)
                            assign total_variant_options = 1
                            for option in bundle_product.options_with_values
                              assign total_variant_options = total_variant_options | times: option.values.size
                            endfor
                          -%}
                          <div class="combo-product-item" data-product-index="{{ forloop.index }}" data-quantity="{{ product_quantity }}">
                            <div class="combo-product-image">
                              {%- if bundle_product.featured_media -%}
                                <img src="{{ bundle_product.featured_media | image_url: width: 440 }}" 
                                     alt="{{ bundle_product.title }}" 
                                     width="220" height="130"
                                     loading="lazy">
                              {%- endif -%}
                            </div>
                            <div class="combo-product-info">
                              <h4>{{ bundle_product.title }}</h4>
                              <div class="combo-product-attributes">
                                <span>S·ªë l∆∞·ª£ng: {{ product_quantity }}</span>
                                {% comment %} <span>{{ total_variant_options }} k√≠ch th∆∞·ªõc m√†u s·∫Øc</span> {% endcomment %}
                              </div>
                            </div>
                          </div>
                        {%- endfor -%}
                      {%- else -%}
                        <div class="combo-product-placeholder" style="text-align: center; padding: 2rem; color: #666;">
                          <p>Ch∆∞a c√≥ s·∫£n ph·∫©m trong combo</p>
                        </div>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Bundle CTA Button -->
                  <div class="product-block">
                    {%- if has_bundle_products -%}
                      <button
                        type="button"
                        name="bundle-cta"
                        data-bundle-cta
                        id="BundleCTAButton-{{ section.id }}-{{ product.id }}"
                        class="btn btn--full btn--primary bundle-cta-btn"
                        style="background: #FCE390; color: #1C2C58; font-weight: bold; font-size: 16px; padding: 15px; border-radius: 50px; border: none;"
                      >
                        <span data-bundle-cta-text>
                          {{ section.settings.cta_button_text | default: "B·∫ÆT ƒê·∫¶U T·∫†O COMBO" }}
                        </span>
                      </button>
                    {%- else -%}
                      <div class="bundle-setup-notice" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: center;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #856404;">‚ö†Ô∏è Bundle ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh</h4>
                        <p style="margin: 0; color: #856404; font-size: 1.15rem;">
                          ƒê·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng bundle, vui l√≤ng th√™m s·∫£n ph·∫©m v√†o bundle trong Theme Editor.
                        </p>
                        <div style="margin-top: 0.5rem;">
                          <button
                            type="button"
                            class="btn btn--secondary"
                            style="font-size: 1rem; padding: 0.5rem 1rem;"
                            onclick="alert('ƒê·ªÉ th√™m s·∫£n ph·∫©m v√†o bundle:\\n\\n1. V√†o Theme Editor\\n2. Ch·ªçn section Product Bundle\\n3. Trong settings, t√¨m Bundle Products\\n4. Click Change v√† ch·ªçn c√°c s·∫£n ph·∫©m mu·ªën th√™m v√†o bundle')"
                          >
                            H∆∞·ªõng d·∫´n c·∫•u h√¨nh
                          </button>
                        </div>
                      </div>
                    {%- endif -%}
                  </div>

                  <!-- Product Summary Block -->
                  <div class="product-block product-summary-block">
                    <div class="product-summary-content">
                      <!-- Description Accordion -->
                      <details class="product-accordion product-accordion--styled" open>
                        <summary>
                          <span>M√¥ t·∫£ s·∫£n ph·∫©m</span>
                          <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </summary>
                        <div class="product-accordion-content rte">
                          {{ product.description }}
                        </div>
                      </details>

                      <!-- Store System Accordion -->
                      {%- if section.settings.store_system_content != blank -%}
                      <details class="product-accordion product-accordion--styled">
                        <summary>
                          <span>H·ªá th·ªëng c·ª≠a h√†ng</span>
                          <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </summary>
                          <div class="product-accordion-content rte">
                            {{ section.settings.store_system_content }}
                        </div>
                      </details>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Service Grid -->
                  <div class="product-block product-block--service-grid">
                    <div class="service-grid-wrapper">
                      <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_1 -%}
                                <img src="{{ section.settings.service_icon_1 | image_url: width: 40 }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_3.svg' | asset_url }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_1 | default: "100 ƒë√™m ng·ªß th·ª≠" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_2 -%}
                                <img src="{{ section.settings.service_icon_2 | image_url: width: 40 }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_4.svg' | asset_url }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_2 | default: "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_3 -%}
                                <img src="{{ section.settings.service_icon_3 | image_url: width: 40 }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_5.svg' | asset_url }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_3 | default: "B·∫£o h√†nh d√†i l√¢u" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_4 -%}
                                <img src="{{ section.settings.service_icon_4 | image_url: width: 40 }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_6.svg' | asset_url }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_4 | default: "Thanh to√°n linh ho·∫°t" }}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Render blocks from main-product.liquid -->
                  {%- for block in section.blocks -%}
                    {%- case block.type -%}
                      {%- when 'showroom_dropdown' -%}
                        {%- comment -%} Showroom dropdown block disabled - using hardcoded showroom info instead {%- endcomment -%}
                      {%- when 'service_grid' -%}
                        {%- liquid
                          assign services_count = 0
                          for i in (1..4)
                            assign icon_setting = 'icon_' | append: i
                            assign text_setting = 'text_' | append: i
                            assign show_setting = 'show_service_' | append: i
                            if block.settings[show_setting]
                            if block.settings[icon_setting] != blank or block.settings[text_setting] != blank
                              assign services_count = services_count | plus: 1
                              endif
                            endif
                          endfor
                        -%}
                        <div class="product-block product-block--service-grid" {{ block.shopify_attributes }}>
                          <div class="service-grid-wrapper">
                            <div class="service-grid" style="grid-template-columns: repeat({{ services_count }}, 1fr);">
                              {%- for i in (1..4) -%}
                                {%- liquid
                                  assign icon_setting = 'icon_' | append: i
                                  assign text_setting = 'text_' | append: i
                                  assign show_setting = 'show_service_' | append: i
                                  assign icon = block.settings[icon_setting]
                                  assign text = block.settings[text_setting]
                                  assign show_service = block.settings[show_setting]
                                -%}
                                {%- if show_service -%}
                                {%- if icon != blank or text != blank -%}
                                  <div class="service-grid-item">
                                    <div class="service-item">
                                      {%- if icon != blank -%}
                                        <div class="service-item__icon">
                                          <img src="{{ icon | image_url: 'master' }}" alt="{{ icon.alt | default: text }}" width="40" height="40">
                                        </div>
                                      {%- endif -%}
                                      {%- if text != blank -%}
                                        <div class="service-item__text">
                                          <p>{{ text }}</p>
                                        </div>
                                      {%- endif -%}
                                    </div>
                                  </div>
                                  {%- endif -%}
                                {%- endif -%}
                              {%- endfor -%}
                            </div>
                        </div>
                      </div>
                    {%- endcase -%}
                  {%- endfor -%}
                </div>
              </div>
            </div>

            {%- unless section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                {%- render 'product-images',
                  section_id: section.id,
                  product: product,
                  product_zoom_enable: section.settings.product_zoom_enable,
                  product_zoom_size: product_zoom_size,
                  product_carousel_enable: true,
                  thumbnail_position: 'below',
                  thumbnail_height: section.settings.thumbnail_height,
                  thumbnail_arrows: section.settings.thumbnail_arrows,
                  mobile_layout: section.settings.mobile_layout,
                  blocks: section.blocks,
                  context: 'main-product',
                  sizes: sizes,
                  sizeVariable: product_image_width,
                  fallback: product_image_size,
                  video_looping: section.settings.enable_video_looping,
                  video_style: section.settings.video_style
                -%}
                <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            {%- endunless -%}
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Bundle Products Selection -->
    <div class="bundle-step bundle-step-2" data-step="2" style="display: none;">
      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid grid--product-images-right">
            <div class="grid__item large-up--one-half product-single__sticky product-grid__images" id="Step2ImageColumn-{{ section.id }}" data-step2-images>
              <!-- Step 2 images will be dynamically loaded here via JavaScript using real Shopify product data -->
            </div>

            <!-- Bundle Product Info (Right) -->
            <div class="grid__item large-up--one-half product-grid__info">
              <div class="product-single__meta product-info-inner">
                <!-- Product Header with Bundle Step Header as subtitle -->
                <div class="product-block product-block--header">
                  <h1 class="h2 bundle-step-title">Ch·ªçn s·∫£n ph·∫©m cho bundle <span class="bundle-step-subtitle">(<span class="bundle-progress-current">1</span>/<span class="bundle-progress-total">{% if has_bundle_products and bundle_products_list %}{{ bundle_products_list.size }}{% else %}0{% endif %}</span>)</span></h1>
                </div>

                <!-- Bundle Product Content -->
          <div class="bundle-products-grid">
            <!-- Bundle products will be loaded here -->
            <div class="bundle-product-placeholder" style="text-align: center; padding: 2rem; color: #666;">
              <p>ƒêang t·∫£i s·∫£n ph·∫©m...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Bundle Summary -->
    <div class="bundle-step bundle-step-3" data-step="3" style="display: none;">
      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid grid--product-images-right">
            <div class="grid__item large-up--one-half product-single__sticky product-grid__images">
              {%- render 'product-images',
                section_id: section.id,
                product: product,
                product_zoom_enable: section.settings.product_zoom_enable,
                product_zoom_size: product_zoom_size,
                product_carousel_enable: true,
                thumbnail_position: 'below',
                thumbnail_height: section.settings.thumbnail_height,
                thumbnail_arrows: section.settings.thumbnail_arrows,
                mobile_layout: section.settings.mobile_layout,
                blocks: section.blocks,
                context: 'main-product',
                sizes: sizes,
                sizeVariable: 'large-up--one-half',
                fallback: product_image_size,
                video_looping: section.settings.enable_video_looping,
                video_style: section.settings.video_style
              -%}
              <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>

            <!-- Bundle Summary (Right) -->
            <div class="grid__item large-up--one-half product-grid__info">
              <div class="product-single__meta">
                <!-- Bundle Summary Title -->
                <div class="product-block product-block--summary-title">
                  <h2 class="bundle-summary-title">Ki·ªÉm tra l·∫°i bundle c·ªßa b·∫°n</h2>
                </div>
                
                <!-- Bundle Header -->
                <div class="product-block product-block--header">
                  <h1 class="h2 product-single__title">{{ product.title }}</h1>
                </div>

                <!-- Bundle Products List -->
                <div class="product-block">
                  <div class="bundle-summary-products">
                    <!-- Selected products will be listed here -->
                  </div>
                </div>

                <!-- Divider Line -->
                <div class="bundle-summary-divider"></div>

                <!-- Bundle Total -->
                <div class="product-block">
                  <div class="bundle-summary-total">
                    <!-- Voucher Code Display -->
                    {% comment %} {%- if section.settings.voucher_code != blank -%}
                      <div class="bundle-total-row bundle-voucher-code">
                      <span>M√£ gi·∫£m gi√°</span>
                        <span class="voucher-code-display">{{ section.settings.voucher_code }}</span>
                      </div>
                    {%- endif -%} {% endcomment %}
                    <!-- Final Total (Gi√° sau gi·∫£m - t·ªïng price) - HI·ªÇN TH·ªä TR∆Ø·ªöC -->
                    <div class="bundle-total-row bundle-final">
                      <span class="bundle-final-total">0ƒë</span>
                    </div>
                    <!-- Original Total (Gi√° g·ªëc - t·ªïng compare_at_price) + Discount Badge - HI·ªÇN TH·ªä SAU -->
                    <div class="bundle-total-row bundle-original">
                      <span class="bundle-original-total">0ƒë</span>
                      <span class="bundle-discount-badge">-0%</span>
                    </div>
                  </div>
                </div>

                <!-- Bundle Actions -->
                <div class="product-block">
                  <div class="bundle-summary-actions">
                    <div class="bundle-quantity-selector">
                      <label for="bundle-quantity">S·ªë l∆∞·ª£ng combo:</label>
                      <div class="quantity-dropdown">
                        <div class="quantity-display" data-quantity="1">
                          <span class="quantity-text">1</span>
                          <svg class="quantity-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </div>
                        <div class="quantity-options">
                          <div class="quantity-option" data-value="1">1</div>
                          <div class="quantity-option" data-value="2">2</div>
                          <div class="quantity-option" data-value="3">3</div>
                          <div class="quantity-option" data-value="4">4</div>
                          <div class="quantity-option" data-value="5">5</div>
                        </div>
                      </div>
                    </div>
                    <button type="button" class="btn btn--primary bundle-add-to-cart-btn">Th√™m v√†o gi·ªè</button>
                  </div>
                </div>

                <!-- Product Summary Block -->
                <div class="product-block product-summary-block">
                  <div class="product-summary-content">
                    <!-- Description Accordion -->
                    <details class="product-accordion product-accordion--styled" open>
                      <summary>
                        <span>M√¥ t·∫£ s·∫£n ph·∫©m</span>
                        <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </summary>
                      <div class="product-accordion-content rte">
                        {{ product.description }}
                      </div>
                    </details>

                    <!-- Store System Accordion -->
                    {%- if section.settings.store_system_content != blank -%}
                    <details class="product-accordion product-accordion--styled">
                      <summary>
                        <span>H·ªá th·ªëng c·ª≠a h√†ng</span>
                        <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </summary>
                        <div class="product-accordion-content rte">
                          {{ section.settings.store_system_content }}
                      </div>
                    </details>
                    {%- endif -%}
                  </div>
                </div>

                <!-- Service Grid -->
                <div class="product-block product-block--service-grid">
                  <div class="service-grid-wrapper">
                    <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_1 -%}
                              <img src="{{ section.settings.service_icon_1 | image_url: width: 40 }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_3.svg' | asset_url }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_1 | default: "100 ƒë√™m ng·ªß th·ª≠" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_2 -%}
                              <img src="{{ section.settings.service_icon_2 | image_url: width: 40 }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_4.svg' | asset_url }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_2 | default: "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_3 -%}
                              <img src="{{ section.settings.service_icon_3 | image_url: width: 40 }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_5.svg' | asset_url }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_3 | default: "B·∫£o h√†nh d√†i l√¢u" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_4 -%}
                              <img src="{{ section.settings.service_icon_4 | image_url: width: 40 }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_6.svg' | asset_url }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_4 | default: "Thanh to√°n linh ho·∫°t" }}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            {%- unless section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                {%- render 'product-images',
                  section_id: section.id,
                  product: product,
                  product_zoom_enable: section.settings.product_zoom_enable,
                  product_zoom_size: product_zoom_size,
                  product_carousel_enable: false,
                  thumbnail_position: 'below',
                  thumbnail_height: section.settings.thumbnail_height,
                  thumbnail_arrows: section.settings.thumbnail_arrows,
                  mobile_layout: section.settings.mobile_layout,
                  blocks: section.blocks
                -%}
                <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            {%- endunless -%}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Debug Info -->
<!-- Has bundle products: {{ has_bundle_products }} -->
{%- if section.settings.bundle_products -%}
  <!-- Section settings bundle_products exists: true -->
  {%- assign first_product = section.settings.bundle_products | first -%}
  <!-- First product: {{ first_product }} -->
  {%- if first_product != blank -%}
    <!-- First product is not blank - bundle has products -->
    <!-- All products: {{ section.settings.bundle_products | join: ', ' }} -->
  {%- else -%}
    <!-- First product is blank - bundle is empty -->
  {%- endif -%}
{%- else -%}
  <!-- Section settings bundle_products exists: false -->
  <!-- Section settings bundle_products is blank -->
{%- endif -%}
{%- if bundle_products_list -%}
  <!-- Bundle products list count: {{ bundle_products_list.size }} -->
  <!-- Bundle products list: {{ bundle_products_list | join: ', ' }} -->
{%- else -%}
  <!-- Bundle products list is blank -->
{%- endif -%}

<!-- Raw section settings debug -->
<!-- Raw section.settings.bundle_products: {{ section.settings.bundle_products | json }} -->

<script id="BundleConfig-{{ section.id }}" type="application/json">
{
  "mainProductId": {{ product.id | json }},
  "mainProductHandle": {{ product.handle | json }},
  "moneyFormat": {{ shop.money_format | json }},
  "discountPercentage": {{ section.settings.discount_percentage | default: 10 }},
  "targetDiscountPercentage": {{ section.settings.target_discount_percentage | default: 15 }},
  "voucherCode": {{ section.settings.voucher_code | json }},
  "sectionId": {{ section.id | json }},
  "product3Quantity": {{ section.settings.product_3_quantity | default: 2 }},
  "sectionSettings": {
    "product_carousel_enable": {{ section.settings.product_carousel_enable | json }},
    "thumbnail_position": {{ section.settings.thumbnail_position | json }},
    "image_position": {{ section.settings.image_position | json }}
  },
  "iconWithTextSettings": {
    {%- assign icon_block_found = false -%}
    {%- for block in section.blocks -%}
      {%- if block.type == 'icon_with_text' -%}
        {%- assign icon_block_found = true -%}
        "icon_1_image": {{ block.settings.icon_1_image | image_url: '100x' | json }},
        "icon_1_heading": {{ block.settings.icon_1_heading | json }},
        "icon_2_image": {{ block.settings.icon_2_image | image_url: '100x' | json }},
        "icon_2_heading": {{ block.settings.icon_2_heading | json }},
        "icon_3_image": {{ block.settings.icon_3_image | image_url: '100x' | json }},
        "icon_3_heading": {{ block.settings.icon_3_heading | json }},
        "icon_4_image": {{ block.settings.icon_4_image | image_url: '100x' | json }},
        "icon_4_heading": {{ block.settings.icon_4_heading | json }},
        "icon_size": {{ block.settings.icon_size | default: 25 | json }},
        "icon_alignment": {{ block.settings.icon_alignment | default: 'center' | json }},
        "grid_columns": {{ block.settings.grid_columns | default: "2" | json }},
        "show_icon_4": {% if block.settings.show_icon_4 == false %}false{% else %}true{% endif %}
      {%- endif -%}
    {%- endfor -%}
    {%- unless icon_block_found -%}
      "icon_1_image": null,
      "icon_1_heading": "100 ƒë√™m ng·ªß th·ª≠",
      "icon_2_image": null,
      "icon_2_heading": "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn *",
      "icon_3_image": null,
      "icon_3_heading": "B·∫£o h√†nh d√†i l√¢u",
      "icon_4_image": null,
      "icon_4_heading": "Ch·∫•t li·ªáu Foam cao c·∫•p",
      "icon_size": 25,
      "icon_alignment": "center",
      "grid_columns": "2",
      "show_icon_4": true
    {%- endunless -%}
  },
  "debug": {
    "hasBundleProducts": {{ has_bundle_products | json }},
    "hasBundleProductsRaw": {{ has_bundle_products }},
    "bundleProductsListExists": {% if bundle_products_list %}true{% else %}false{% endif %},
    "sectionSettingsExists": {% if section.settings.bundle_products %}true{% else %}false{% endif %},
    "firstProduct": {{ section.settings.bundle_products | first | json }},
    "sectionSettingsRaw": {{ section.settings.bundle_products | json }}
  },
        "bundleProducts": [
        {%- if has_bundle_products and bundle_products_list -%}
          {%- for bundle_product in bundle_products_list -%}
            {%- if bundle_product -%}
            {
              "handle": {{ bundle_product.handle | json }},
              "title": {{ bundle_product.title | json }},
              "id": {{ bundle_product.id | json }},
              "featured_image": {{ bundle_product.featured_media | image_url: width: 360 | json }},
              "price": {{ bundle_product.price | json }},
              "compare_at_price": {{ bundle_product.compare_at_price | json }},
              "description": {{ bundle_product.description | json }},
              "options": [
                {%- for option in bundle_product.options_with_values -%}
                  {
                    "name": {{ option.name | json }},
                    "values": {{ option.values | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              "media": [
                {%- for media in bundle_product.media -%}
                  {%- liquid
                    if media.media_type == 'image'
                      assign img_for_url = media
                    else
                      assign img_for_url = media.preview_image
                    endif
                  -%}
                  {
                    "id": {{ media.id | json }},
                    "media_type": {{ media.media_type | json }},
                    "src": {{ img_for_url | image_url: width: 720 | json }},
                    "alt": {{ media.alt | json }},
                    "preview_image": {
                      "src": {{ img_for_url | image_url: width: 720 | json }},
                      "aspect_ratio": {{ media.aspect_ratio | default: 1 | json }}
                    }
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              "variants": [
                {%- for variant in bundle_product.variants -%}
                  {
                    "id": {{ variant.id | json }},
                    "title": {{ variant.title | json }},
                    "price": {{ variant.price | json }},
                    "compare_at_price": {{ variant.compare_at_price | json }},
                    "available": {{ variant.available | json }},
                    "featured_image": {{ variant.featured_media | default: bundle_product.featured_media | image_url: width: 360 | json }},
                    "options": {{ variant.options | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ]
            }{% unless forloop.last %},{% endunless %}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      ],
  "hasBundleProducts": {{ has_bundle_products | json }}
}
</script>
<!-- Carousel Modal Dialogs -->
{%- for block in section.blocks -%}
  {%- if block.type == 'carousel_modal' -%}
    <modal-dialog
      id="PopupModal-{{ block.id }}"
      class="product-popup-modal popup-modal fixed top-0 left-0 w-full h-full m-auto"
      {{ block.shopify_attributes }}
    >
      <div
        role="dialog"
        aria-label="Dialog Modal"
        aria-modal="true"
        class="product-popup-modal__content popup-modal__content absolute w-full h-auto m-auto"
        tabindex="-1"
      >
        <div class="product-popup-modal__content-info relative mx-auto popup-modal__content-info">
          <button
            id="ModalClose-{{ block.id }}"
            type="button"
            class="product-popup-modal__toggle popup-modal__toggle block border-none rounded-circle absolute z-index-3 button--close"
            aria-label="{{ 'general.accessibility.close' | t }}"
          >
            <span class="i__close e-none block relative color-current w-full h-full"></span>
          </button>
          <div class="product-popup-modal__carousel" data-slideshow id="ModalCarousel-{{ block.id }}">
            {% for index in (1..4) %}
              {%- capture description_index -%}description_{{ index }}{%- endcapture -%}
              {%- capture image_index -%}picture_{{ index }}{%- endcapture -%}
              {%- capture title_index -%}title_{{ index }}{%- endcapture -%}
              {% liquid
                assign desc = product.metafields.custom.product_features.value[description_index].value
                assign img = product.metafields.custom.product_features.value[image_index].value
                assign title = product.metafields.custom.product_features.value[title_index].value
              %}
              {%- if img != blank and title != blank -%}
                <div class="carousel-item">
                  <div class="carousel-item--inner flex gap-x">
                    {%- if img != blank -%}
                      <div class="carousel-item--image shrink-0">
                        {% render 'image-element',
                          img: img,
                          classes: 'rounded-sm-large',
                          img_width: 450,
                          img_height: 450,
                          sizes: '450px'
                        %}
                      </div>
                    {%- endif -%}
                    <div class="carousel-item--content">
                      {%- if title != blank -%}
                        <div class="carousel-item--title text-lg f-bold">{{ title }}</div>
                      {%- endif -%}
                      {%- if desc != blank -%}
                        <div class="carousel-item--desc text-sm">{{ desc }}</div>
                      {%- endif -%}
                    </div>
                  </div>
                </div>
              {%- endif -%}
            {% endfor %}
            
            <!-- Carousel Navigation -->
            <div class="carousel-navigation">
              <button class="carousel-nav carousel-nav--prev" aria-label="Previous slide">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button class="carousel-nav carousel-nav--next" aria-label="Next slide">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </modal-dialog>
  {%- endif -%}
{%- endfor -%}


{% style %}
  /* Showroom List Styling */
  .showroom-list {
    display: block;
    margin: 0;
    padding: 0;
  }

  .showroom-item {
    margin-bottom: 20px;
    padding: 0;
    line-height: 1.5;
  }

  .showroom-item:last-child {
    margin-bottom: 0;
  }

  .showroom-item strong {
    font-weight: 600;
    color: #1C2C58;
    display: block;
    margin-bottom: 5px;
  }

  .showroom-item span {
    display: block;
    margin-bottom: 5px;
    color: #666;
  }

  .showroom-item a {
    color: #1C2C58;
    text-decoration: none;
    font-weight: 500;
  }

  .showroom-item a:hover {
    text-decoration: underline;
  }

  /* Store System Accordion Content Styling */
  .product-accordion-content p {
    margin-bottom: 15px;
    line-height: 1.5;
  }

  .product-accordion-content p:last-child {
    margin-bottom: 0;
  }

  .product-accordion-content strong {
    font-weight: 600;
    color: #1C2C58;
  }

  .product-accordion-content a {
    color: #1C2C58;
    text-decoration: none;
    font-weight: 500;
  }

  .product-accordion-content a:hover {
    text-decoration: underline;
  }
{% endstyle %}

<style>
/* Active thumbnail state */
.product__thumb.active-thumb {
  border: 2px solid #000 !important;
  opacity: 1 !important;
}

.product__thumb {
  transition: border-color 0.2s ease, opacity 0.2s ease;
}

.product__thumb:hover {
  opacity: 0.8;
}
</style>

{% schema %}
{
  "name": "Product Bundle",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "customize_width",
          "label": "Customize width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "customize_width",
      "min": 800,
      "max": 2000,
      "step": 20,
      "unit": "px",
      "label": "Customize width",
      "default": 1800
    },
    {
      "type": "product_list",
      "id": "bundle_products",
      "label": "Bundle Products",
      "info": "Ch·ªçn c√°c s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã trong Step 2 c·ªßa bundle builder",
      "limit": 10
    },
    {
      "type": "range",
      "id": "product_3_quantity",
      "min": 1,
      "max": 10,
      "step": 1,
      "label": "S·ªë l∆∞·ª£ng s·∫£n ph·∫©m th·ª© 3",
      "info": "N·∫øu s·∫£n ph·∫©m th·ª© 3 l√† g·ªëi/ph·ª• ki·ªán, c√≥ th·ªÉ set s·ªë l∆∞·ª£ng > 1",
      "default": 2
    },
    {
      "type": "checkbox",
      "id": "sku_enable",
      "label": "Show SKU",
      "default": true
    },
    {
      "type": "header",
      "content": "Step 1 Content Settings"
    },
    {
      "type": "text",
      "id": "combo_title",
      "label": "Combo Products Title",
      "default": "Combo bao g·ªìm c√°c s·∫£n ph·∫©m:"
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "CTA Button Text",
      "default": "B·∫ÆT ƒê·∫¶U T·∫†O COMBO"
    },
    {
      "type": "header",
      "content": "üí∞ Bundle Pricing Calculator"
    },
    {
      "type": "range",
      "id": "target_discount_percentage",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "%",
      "label": "üéØ Target Bundle Discount",
      "info": "M·ª©c gi·∫£m gi√° m·ª•c ti√™u b·∫°n mu·ªën kh√°ch h√†ng th·∫•y (so v·ªõi Compare-at price)",
      "default": 15
    },
    {
      "type": "paragraph",
      "content": "H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG CALCULATOR:\n\n1Ô∏è Nh·∫≠p % gi·∫£m gi√° m·ª•c ti√™u ·ªü tr√™n (VD: 15%)\n\n2Ô∏è Save v√† Preview theme ƒë·ªÉ xem calculator t·ª± ƒë·ªông t√≠nh\n\n3Ô∏è Calculator s·∫Ω hi·ªÉn th·ªã:\n   ‚Ä¢ % gi·∫£m hi·ªán t·∫°i c·ªßa products (t·ª´ Price vs Compare-at price)\n   ‚Ä¢ % voucher c·∫ßn t·∫°o th√™m\n   ‚Ä¢ Gi√° cu·ªëi c√πng kh√°ch h√†ng s·∫Ω th·∫•y\n\n4Ô∏è V√†o Shopify Admin ‚Üí Discounts ‚Üí Create discount v·ªõi % ƒë∆∞·ª£c g·ª£i √Ω"
    },
    {
      "type": "header",
      "content": "Service Grid Settings"
    },
    {
      "type": "image_picker",
      "id": "service_icon_1",
      "label": "Service Icon 1 (100 ƒë√™m ng·ªß th·ª≠)"
    },
    {
      "type": "text",
      "id": "service_text_1",
      "label": "Service Text 1",
      "default": "100 ƒë√™m ng·ªß th·ª≠"
    },
    {
      "type": "image_picker",
      "id": "service_icon_2",
      "label": "Service Icon 2 (Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn)"
    },
    {
      "type": "text",
      "id": "service_text_2",
      "label": "Service Text 2",
      "default": "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn"
    },
    {
      "type": "image_picker",
      "id": "service_icon_3",
      "label": "Service Icon 3 (B·∫£o h√†nh d√†i l√¢u)"
    },
    {
      "type": "text",
      "id": "service_text_3",
      "label": "Service Text 3",
      "default": "B·∫£o h√†nh d√†i l√¢u"
    },
    {
      "type": "image_picker",
      "id": "service_icon_4",
      "label": "Service Icon 4 (Thanh to√°n linh ho·∫°t)"
    },
    {
      "type": "text",
      "id": "service_text_4",
      "label": "Service Text 4",
      "default": "Thanh to√°n linh ho·∫°t"
    },
    {
      "type": "select",
      "id": "image_position",
      "label": "Image position",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "right"
    },
    {
      "type": "checkbox",
      "id": "product_zoom_enable",
      "label": "Enable image zoom",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "product_carousel_enable",
      "label": "Enable product carousel",
      "default": false
    },
    {
      "type": "select",
      "id": "thumbnail_position",
      "label": "Thumbnail position",
      "options": [
        {
          "value": "beside",
          "label": "Beside main image"
        },
        {
          "value": "below",
          "label": "Below main image"
        }
      ],
      "default": "beside"
    },
    {
      "type": "range",
      "id": "thumbnail_height",
      "min": 60,
      "max": 120,
      "step": 10,
      "unit": "px",
      "label": "Thumbnail height",
      "default": 100
    },
    {
      "type": "checkbox",
      "id": "thumbnail_arrows",
      "label": "Show thumbnail arrows",
      "default": false
    },
    {
      "type": "select",
      "id": "mobile_layout",
      "label": "Mobile layout",
      "options": [
        {
          "value": "partial",
          "label": "Partial"
        },
        {
          "value": "stacked",
          "label": "Stacked"
        }
      ],
      "default": "partial"
    },
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "label": "Enable video looping",
      "default": false
    },
    {
      "type": "select",
      "id": "product_video_style",
      "label": "Video style",
      "options": [
        {
          "value": "muted",
          "label": "Muted"
        },
        {
          "value": "unmuted",
          "label": "Unmuted"
        }
      ],
      "default": "muted"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_add_to_cart",
      "label": "Enable sticky add to cart",
      "default": false
    },
    {
      "type": "richtext",
      "id": "store_system_content",
      "label": "H·ªá th·ªëng c·ª≠a h√†ng",
      "info": "Nh·∫≠p th√¥ng tin h·ªá th·ªëng c·ª≠a h√†ng. C√≥ th·ªÉ s·ª≠ d·ª•ng HTML v√† links.",
      "default": "<p><strong>Q.2, TP.HCM:</strong><br>Shop 09, B2 Sarimi, Khu ƒê√¥ Th·ªã Sala, 72 Nguy·ªÖn C∆° Th·∫°ch, P. An L·ª£i ƒê√¥ng<br><a href=\"tel:0964777960\">0964777960</a></p><p><strong>Q.3, TP.HCM:</strong><br>283A Hai B√† Tr∆∞ng, Ph∆∞·ªùng Xu√¢n Ho√†<br><a href=\"tel:0964777910\">0964777910</a></p><p><strong>Q. C·∫ßu Gi·∫•y, HN:</strong><br>228 C·∫ßu Gi·∫•y, Quan Hoa<br><a href=\"tel:0964777940\">0964777940</a></p>"
    },
    {
      "type": "checkbox",
      "id": "hide_payment_button_mobile",
      "label": "Hide payment button on mobile",
      "default": false
    },
    {
      "type": "select",
      "id": "image_size",
      "label": "Image size",
      "default": "medium",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ]
    },
    {
      "type": "header",
      "content": "Showroom Settings"
    },
    {
      "type": "text",
      "id": "showroom_1_name",
      "label": "Showroom 1 Name",
      "default": "Showroom 1"
    },
    {
      "type": "text",
      "id": "showroom_1_address",
      "label": "Showroom 1 Address",
      "default": "ƒê·ªãa ch·ªâ showroom"
    },
    {
      "type": "text",
      "id": "showroom_1_phone",
      "label": "Showroom 1 Phone",
      "default": "0964777910"
    },
    {
      "type": "url",
      "id": "showroom_1_map_link",
      "label": "Showroom 1 Map Link"
    },
    {
      "type": "text",
      "id": "showroom_2_name",
      "label": "Showroom 2 Name",
      "default": "Showroom 2"
    },
    {
      "type": "text",
      "id": "showroom_2_address",
      "label": "Showroom 2 Address",
      "default": "ƒê·ªãa ch·ªâ showroom"
    },
    {
      "type": "text",
      "id": "showroom_2_phone",
      "label": "Showroom 2 Phone",
      "default": "0964777910"
    },
    {
      "type": "url",
      "id": "showroom_2_map_link",
      "label": "Showroom 2 Map Link"
    },
    {
      "type": "text",
      "id": "showroom_3_name",
      "label": "Showroom 3 Name",
      "default": "Showroom 3"
    },
    {
      "type": "text",
      "id": "showroom_3_address",
      "label": "Showroom 3 Address",
      "default": "ƒê·ªãa ch·ªâ showroom"
    },
    {
      "type": "text",
      "id": "showroom_3_phone",
      "label": "Showroom 3 Phone",
      "default": "0964777940"
    },
    {
      "type": "url",
      "id": "showroom_3_map_link",
      "label": "Showroom 3 Map Link"
    },
    {
      "type": "header",
      "content": "Review Settings"
    },
    {
      "type": "text",
      "id": "review_rating",
      "label": "Review Rating",
      "default": "4.8"
    },
    {
      "type": "text",
      "id": "review_count",
      "label": "Review Count",
      "default": "2025 ƒë√°nh gi√°"
    },
    {
      "type": "text",
      "id": "voucher_code",
      "label": "M√£ voucher cho bundle",
      "info": "Nh·∫≠p m√£ gi·∫£m gi√° s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông √°p d·ª•ng khi kh√°ch h√†ng th√™m bundle v√†o gi·ªè h√†ng. V√≠ d·ª•: BUNDLE15, BUNDLE20, etc. M√£ n√†y ph·∫£i ƒë∆∞·ª£c t·∫°o trong Shopify Admin ‚Üí Discounts tr∆∞·ªõc."
    }
  ],
  "blocks": [
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "variant_labels",
          "label": "Show variant labels",
          "default": true
        },
        {
          "type": "select",
          "id": "picker_type",
          "label": "Picker type",
          "options": [
            {
              "value": "button",
              "label": "Buttons"
            },
            {
              "value": "dropdown",
              "label": "Dropdown"
            }
          ],
          "default": "button"
        },
        {
          "type": "checkbox",
          "id": "product_dynamic_variants_enable",
          "label": "Enable dynamic variants",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "color_swatches",
          "label": "Enable color swatches",
          "default": false
        }
      ]
    },
    {
      "type": "quantity_selector",
      "name": "Quantity selector",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "label": "Show dynamic checkout",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "surface_pickup_enable",
          "label": "Enable surface pickup",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_gift_card_recipient",
          "label": "Show gift card recipient",
          "default": false
        }
      ]
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1
    },
    {
      "type": "product_combo",
      "name": "Product Combo",
      "limit": 1,
      "settings": []
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "is_tab",
          "label": "Show as tab",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "collapse_content",
          "label": "Collapse content",
          "default": false
        }
      ]
    },
    {
      "type": "icon_with_text",
      "name": "Icon with Text",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "Icon 1"
        },
        {
          "type": "image_picker",
          "id": "icon_1_image",
          "label": "Icon 1 Image"
        },
        {
          "type": "text",
          "id": "icon_1_heading",
          "label": "Icon 1 Heading",
          "default": "100 ƒë√™m ng·ªß th·ª≠"
        },
        {
          "type": "header",
          "content": "Icon 2"
        },
        {
          "type": "image_picker",
          "id": "icon_2_image",
          "label": "Icon 2 Image"
        },
        {
          "type": "text",
          "id": "icon_2_heading",
          "label": "Icon 2 Heading",
          "default": "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn *"
        },
        {
          "type": "header",
          "content": "Icon 3"
        },
        {
          "type": "image_picker",
          "id": "icon_3_image",
          "label": "Icon 3 Image"
        },
        {
          "type": "text",
          "id": "icon_3_heading",
          "label": "Icon 3 Heading",
          "default": "B·∫£o h√†nh d√†i l√¢u"
        },
        {
          "type": "header",
          "content": "Icon 4"
        },
        {
          "type": "image_picker",
          "id": "icon_4_image",
          "label": "Icon 4 Image"
        },
        {
          "type": "text",
          "id": "icon_4_heading",
          "label": "Icon 4 Heading",
          "default": "Ch·∫•t li·ªáu Foam cao c·∫•p"
        },
        {
          "type": "header",
          "content": "Layout Settings"
        },
        {
          "type": "range",
          "id": "icon_size",
          "min": 20,
          "max": 60,
          "step": 5,
          "unit": "px",
          "label": "Icon Size",
          "default": 25
        },
        {
          "type": "select",
          "id": "icon_alignment",
          "label": "Icon Alignment",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "center"
        },
        {
          "type": "select",
          "id": "grid_columns",
          "label": "Layout Style",
          "options": [
            {
              "value": "1",
              "label": "1 c·ªôt"
            },
            {
              "value": "2",
              "label": "2 c·ªôt (2x2)"
            }
          ],
          "default": "2"
        },
        {
          "type": "checkbox",
          "id": "show_icon_4",
          "label": "Show Icon 4",
          "default": true
        }
      ]
    },
    {
      "type": "carousel_modal",
      "name": "Carousel modal",
      "limit": 1,
      "settings": []
    }
  ],
  "presets": [
    {
      "name": "Product Bundle",
      "blocks": [
        {
          "type": "variant_picker"
        },
        {
          "type": "quantity_selector"
        },
        {
          "type": "price"
        },
        {
          "type": "description"
        },
        {
          "type": "icon_with_text"
        }
      ]
    }
  ]
}
{% endschema %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Wait for BundleUtils to be loaded
  if (typeof window.BundleUtils === 'undefined') {
    console.error('BundleUtils not loaded');
    return;
  }
  
  // Set up bundle configuration
  window.bundleConfig = {
    productCarouselEnable: {{ section.settings.product_carousel_enable | json }},
    thumbnailArrows: {{ section.settings.thumbnail_arrows | json }},
    storeSystemContent: {{ section.settings.store_system_content | json }},
    serviceIcon1: {{ section.settings.service_icon_1 | image_url: width: 40 | json }},
    serviceText1: {{ section.settings.service_text_1 | default: "100 ƒë√™m ng·ªß th·ª≠" | json }},
    serviceIcon2: {{ section.settings.service_icon_2 | image_url: width: 40 | json }},
    serviceText2: {{ section.settings.service_text_2 | default: "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn" | json }},
    serviceIcon3: {{ section.settings.service_icon_3 | image_url: width: 40 | json }},
    serviceText3: {{ section.settings.service_text_3 | default: "B·∫£o h√†nh d√†i l√¢u" | json }},
    serviceIcon4: {{ section.settings.service_icon_4 | image_url: width: 40 | json }},
    serviceText4: {{ section.settings.service_text_4 | default: "Thanh to√°n linh ho·∫°t" | json }}
  };
  
  // Initialize bundle functionality
  const bundleInstance = window.BundleUtils.initializeBundle(
    '{{ section.id }}',
    {{ current_variant.id | json }},
    {{ product.title | json }},
    {{ product.variants | json }},
    {{ product.featured_image | json }}
  );
  
  // Store bundle instance globally for access
  window.bundleInstance = bundleInstance;
  
  console.log('‚úÖ Bundle initialized successfully');
});
</script>
