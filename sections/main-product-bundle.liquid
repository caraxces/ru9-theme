{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  
  # Check section settings only - more robust check
  assign has_bundle_products = false
  assign bundle_products_list = blank
  
  if section.settings.bundle_products
    # Check if it's not empty by trying to access first element
    assign first_product = section.settings.bundle_products | first
    if first_product != blank
      assign has_bundle_products = true
      assign bundle_products_list = section.settings.bundle_products
    endif
  endif
-%}

{{ 'main-product-bundle.css' | asset_url | stylesheet_tag }}

<style>
  /* Icon with Text Styles */
  .icon-with-text {
    margin: 2rem 0;
  }
  
  /* Step 3 Bundle Summary Styles - Match Step 1 & 2 Layout */
  .bundle-step-3 .bundle-summary-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  .bundle-step-3 .bundle-summary-title {
    font-size: 1rem;
    font-weight: 200;
    margin: 0;
    color: #6B7280;
  }

  /* Match Step 1 & 2 layout exactly */
  .bundle-step-3 .product-grid {
    align-items: start;
  }

  .bundle-step-3 .is-sticky {
    position: -webkit-sticky;
    position: sticky;
    top: 20px;
  }

  .bundle-step-3 .grid--product-images-right {
    display: flex !important;
    flex-direction: row !important;
    align-items: flex-start !important;
    gap: 0 !important;
  }

  /* Image column - exactly 50% width */
  .bundle-step-3 .grid__item.product-single__sticky,
  .bundle-step-3 .grid__item.product-grid__images {
    flex: 0 0 50% !important;
    width: 50% !important;
    max-width: 50% !important;
    min-width: 50% !important;
    margin-right: 0 !important;
    padding-right: 0 !important;
  }

  /* Content column - exactly 50% width with 60px right padding */
  .bundle-step-3 .grid__item.product-grid__info {
    flex: 0 0 50% !important;
    width: 50% !important;
    max-width: 50% !important;
    min-width: 50% !important;
    margin-right: 0 !important;
    padding-right: 60px !important;
    box-sizing: border-box !important;
  }

  /* Ensure images never exceed their containers */
  .bundle-step-3 .product__photos img,
  .bundle-step-3 .product-main-slide img {
    max-width: 100% !important;
    width: 100% !important;
    height: auto !important;
    object-fit: cover !important;
    box-sizing: border-box !important;
  }

  /* FIX Z-INDEX LAYERING - Ensure image column is not covered by content column */
  .bundle-step-3 .grid__item.product-single__sticky,
  .bundle-step-3 .grid__item.product-grid__images {
    position: relative !important;
    z-index: 2 !important;
  }

  .bundle-step-3 .grid__item.product-grid__info {
    position: relative !important;
    z-index: 1 !important;
  }

  /* Ensure image containers have proper z-index */
  .bundle-step-3 .product__photos,
  .bundle-step-3 .product-slideshow,
  .bundle-step-3 .product__main-photos {
    position: relative !important;
    z-index: 3 !important;
  }

  /* Prevent content column from overlapping image column */
  .bundle-step-3 .product-single__meta {
    position: relative !important;
    z-index: 1 !important;
  }
  
  .bundle-step-3 .product__photos {
    position: relative;
    margin-bottom: 1rem;
  }
  
  .bundle-step-3 .product__photos--beside {
    display: flex;
    flex-direction: column !important; /* Force column layout for step 3 */
    gap: 1rem;
  }
  
  .bundle-step-3 .product__thumbs-placement--left {
    order: -1;
    margin-left: 0;
    margin-right: 1rem;
  }
  
  
  .bundle-step-3 .product-slideshow {
    position: relative;
  }
  
  .bundle-step-3 .product-main-slide {
    display: none;
  }
  
  .bundle-step-3 .product-main-slide:first-child,
  .bundle-step-3 .product-main-slide[style*="display: block"] {
    display: block !important;
  }
  
  .bundle-step-3 .product-main-slide img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    max-height: 100%;
    object-fit: contain;
  }
  
  .bundle-step-3 .product__thumbs {
    width: 100% !important;
    position: relative !important;
    margin-top: 1rem;
    display: block !important;
    overflow: visible !important;
  }
  
  .bundle-step-3 .product__thumbs--below {
    display: block;
  }
  
  .bundle-step-3 .product__thumbs--beside {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  
  .bundle-step-3 .product__thumbs--scroller {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    width: 100%;
  }
  
  .bundle-step-3 .product__thumbs--scroller::-webkit-scrollbar {
    height: 0;
    width: 0;
  }
  
  .bundle-step-3 .product__thumb {
    display: block;
    border: 2px solid transparent;
    border-radius: calc(var(--radiusBase) * 0.75);
    overflow: hidden;
    transition: border-color 0.3s ease;
    cursor: pointer;
    position: relative;
    width: 100%;
    height: 100%;
  }
  
  .bundle-step-3 .product__thumb.active,
  .bundle-step-3 .product__thumb.is-active {
    border-color: var(--colorTextBody);
  }
  
  .bundle-step-3 .product__thumb:focus {
    outline: none;
  }
  
  .bundle-step-3 .product__thumb:focus:before {
    bottom: 0;
    box-shadow: inset 0 0 0 2px var(--colorTextBody);
    content: "";
    display: block;
    left: 0;
    position: absolute;
    right: 0;
    top: 0;
    z-index: 1;
    border-radius: calc(var(--radiusBase) * 0.75);
  }
  
  .bundle-step-3 .product__thumb img {
    display: block;
    margin: 0 auto;
    max-width: 100%;
    width: 100%;
    border-radius: calc(var(--radiusBase) * 0.75);
  }
  
  .bundle-step-3 .product__thumb-item {
    width: 100%;
    position: relative;
  }
  
  .bundle-step-3 .image-wrap__thumbnail {
    position: relative;
    overflow: hidden;
    border-radius: calc(var(--radiusBase) * 0.75);
    width: 100%;
    height: 100%;
    display: block;
  }
  
  .bundle-step-3 .product-single__meta {
    padding: 0;
  }
  
  .bundle-step-3 .product-block {
    margin-bottom: 1.5rem;
  }
  
  .bundle-step-3 .product-single__title {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: #333;
  }
  
  .bundle-step-3 .bundle-summary-products {
    margin-bottom: 1.5rem;
  }
  
  .bundle-step-3 .bundle-summary-product {
    display: flex;
    align-items: flex-start;
    padding: 0;
    border: none;
    border-radius: 0;
    margin-bottom: 0;
    background: transparent;
    position: relative;
  }
  
  .bundle-step-3 .bundle-product-number {
    position: absolute;
    top: 0;
    left: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1C2C58;
    margin-right: 1rem;
  }
  
  .bundle-step-3 .bundle-product-content {
    display: flex;
    align-items: flex-start;
    flex: 1;
    margin-left: 1.5rem;
  }
  
  .bundle-step-3 .bundle-product-info {
    flex: 1;
    margin-right: 1.25rem;
  }
  
  .bundle-step-3 .bundle-product-title {
    font-size: 1.375rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: #1C2C58;
    line-height: 1.3;
  }
  
  
  .bundle-step-3 .bundle-product-attribute {
    font-size: 1.125rem;
    color: #6B7280;
    margin-bottom: 0.25rem;
    line-height: 1.4;
  }
  
  .bundle-step-3 .bundle-product-change-link {
    color: #007cba;
    text-decoration: underline;
    font-size: 1.125rem;
    font-weight: 500;
    cursor: pointer;
    transition: color 0.2s ease;
    margin-bottom: 10px;
  }
  
  .bundle-step-3 .bundle-product-change-link:hover {
    color: #005a8b;
  }
  
  .bundle-step-3 .bundle-product-image {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #f3f4f6;
  }
  
  .bundle-step-3 .bundle-product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .bundle-step-3 .bundle-summary-divider {
    position: relative;
    width: 100%;
    height: 0;
    margin: 2rem 0;
    border: 2px solid #9CA3AF;
  }
  
  .bundle-step-3 .bundle-summary-total {
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }
  
  .bundle-step-3 .bundle-total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  
  .bundle-step-3 .bundle-total-row:last-child {
    font-weight: 600;
    font-size: 1.35rem;
  }
  
  .bundle-step-3 .bundle-discount {
    color: #28a745;
  }
  
  .bundle-step-3 .bundle-final {
    color: #007cba;
  }
  
  .bundle-step-3 .bundle-summary-actions {
    display: flex;
    gap: 1rem;
  }
  
  .bundle-step-3 .btn {
    flex: 1;
    padding: 1rem 2rem;
    font-size: 1.25rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .bundle-step-3 .btn--secondary {
    background: #fff;
    border-radius: 50px;
    color: #333;
    border: 2px solid #e5e5e5;
  }
  
  .bundle-step-3 .btn--secondary:hover {
    border-radius: 50px;
    background: #f8f9fa;
    border-color: #ccc;
  }
  
  .bundle-step-3 .btn--primary {
    border-radius: 50px;
    background: #FF7F41;
    color: #fff;
  }
  
  .bundle-step-3 .btn--primary:hover {
    border-radius: 50px;
    background: #FF7F41;
  }
  
  @media (max-width: 768px) {
    .bundle-step-3 .grid--product-images-right {
      flex-direction: column !important;
      flex-wrap: wrap !important;
    }
    
    .bundle-step-3 .grid__item.large-up--one-half {
      flex: 0 0 100% !important;
      max-width: 100% !important;
      width: 100% !important;
    }
    
    .bundle-step-3 .product__photos--beside {
      flex-direction: column;
    }
    
    .bundle-step-3 .product__thumbs-placement--left {
      order: 0;
      margin-right: 0;
      margin-bottom: 1rem;
    }
    
    .bundle-step-2 .product__photos--beside {
      flex-direction: column;
    }
    
    .bundle-step-2 .product__thumbs-placement--left {
      order: 0;
      margin-right: 0;
      margin-bottom: 1rem;
    }
    
    .bundle-step-3 .product__thumbs--beside {
      flex-direction: row;
      overflow-x: auto;
      width: 100%;
    }
    
    .bundle-step-2 .product__thumbs--beside {
      flex-direction: row;
      overflow-x: auto;
      width: 100%;
    }
    
    .bundle-step-3 .product__thumbs {
      width: auto;
    }
    
    .bundle-step-2 .product__thumbs {
      width: auto;
    }
    
    .bundle-step-3 .product__thumbs--scroller {
      position: static;
      overflow-x: scroll;
      white-space: nowrap;
      overflow-y: hidden;
    }
    
    .bundle-step-2 .product__thumbs--scroller {
      position: static;
      overflow-x: scroll;
      white-space: nowrap;
      overflow-y: hidden;
    }
    
    .bundle-step-3 .product__thumb-item {
      display: inline-block;
      margin-right: 8.5px;
      width: 80px;
      vertical-align: middle;
      margin-bottom: 0;
    }
    
    .bundle-step-2 .product__thumb-item {
      display: inline-block;
      margin-right: 8.5px;
      width: 80px;
      vertical-align: middle;
      margin-bottom: 0;
    }
    
    .bundle-step-3 .product__thumb-item:last-child {
      margin-right: 0;
    }
    
    .bundle-step-2 .product__thumb-item:last-child {
      margin-right: 0;
    }
    
    .bundle-step-3 .bundle-summary-actions {
      flex-direction: column;
    }
    
    .bundle-step-3 .bundle-summary-product {
      flex-direction: column;
      text-align: center;
      padding: 0;
    }
    
    .bundle-step-3 .bundle-product-number {
      position: static;
      margin-bottom: 0.75rem;
      margin-left: 0;
    }
    
    .bundle-step-3 .bundle-product-content {
      flex-direction: column;
      margin-left: 0;
    }
    
    .bundle-step-3 .bundle-product-info {
      margin-right: 0;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .bundle-step-3 .bundle-product-image {
      width: 60px;
      height: 60px;
    }
    
    .bundle-step-3 .bundle-summary-divider {
      margin: 1.5rem 0;
    }
    
    .bundle-step-3 .bundle-summary-title {
      font-size: 1rem;
    }
  }
  
  @media (min-width: 769px) and (max-width: 1024px) {
    .bundle-step-3 .grid--product-images-right {
      display: flex !important;
      flex-direction: row !important;
      flex-wrap: nowrap !important;
    }
    
    .bundle-step-3 .grid__item.large-up--one-half {
      flex: 0 0 50% !important;
      max-width: 50% !important;
      width: 50% !important;
    }
  }
  
  .icon-with-text__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    align-items: start;
  }
  
  .icon-with-text__grid[data-columns="1"] {
    grid-template-columns: 1fr;
  }
  
  .icon-with-text__grid[data-columns="2"] {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .icon-with-text__item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-align: left;
    padding: 0.5rem 0;
  }
  
  .icon-with-text__icon {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
  }
  
  .icon-with-text__icon img {
    max-width: 100%;
    height: auto;
  }
  
  .icon-with-text__content {
    flex: 1;
  }
  
  .icon-with-text__heading {
    margin: 0;
    font-size: 20px;
    font-weight: 400;
    line-height: 1.4;
    color: #333;
    font-family: inherit;
  }
  
  @media (max-width: 768px) {
    .icon-with-text__grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .icon-with-text__item {
      flex-direction: row;
      text-align: left;
      gap: 0.75rem;
    }
    
    .icon-with-text__heading {
      font-size: 1.15rem;
    }
  }

  /* Combo Products List Styles */
  .combo-products-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .combo-product-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #F8F9FA;
    border-radius: 8px;
    border: 1px solid #E5E7EB;
  }

  .combo-product-image {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
    border: 1px solid #E5E7EB;
  }

  .combo-product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .combo-product-info {
    flex: 1;
    min-width: 0;
  }

  .combo-product-info h4 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    color: #1C2C58;
    line-height: 1.4;
  }

  .combo-product-attributes {
    display: flex;
    align-items: left;
    gap: 0.75rem;
    font-size: 0.875rem;
    color: #6B7280;
  }

  .combo-product-attributes span:first-child {
    font-weight: 500;
    color: #374151;
  }

  /* Step 1 Bundle Layout Styles */
  .bundle-step-1 .product-single__meta {
    padding: 0;
  }

  .bundle-step-1 .product-block--header {
    margin-bottom: 1.5rem;
  }

  .bundle-step-1 .product-reviews-summary {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 1rem;
  }

  .bundle-step-1 .product-rating {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .bundle-step-1 .stars {
    display: flex;
    gap: 2px;
  }

  .bundle-step-1 .star {
    color: #FFD700;
    font-size: 16px;
  }

  .bundle-step-1 .rating-value {
    font-weight: 600;
    color: #1C2C58;
    font-size: 14px;
  }

  .bundle-step-1 .reviews-number {
    color: #6B7280;
    font-size: 14px;
  }

  .bundle-step-1 .product-single__title {
    font-size: 24px;
    font-weight: 700;
    color: #1C2C58;
    margin-bottom: 1rem;
    line-height: 1.3;
  }

  .bundle-step-1 .product-block--price {
    margin-bottom: 1.5rem;
  }

  .bundle-step-1 .price-container-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .bundle-step-1 .product__price {
    font-size: 24px;
    font-weight: 600;
    color: #1C2C58;
  }

  .bundle-step-1 .product__price--compare {
    font-size: 18px;
    color: #9CA3AF;
    text-decoration: line-through;
  }

  .bundle-step-1 .product__discount-badge {
    background: #FCE390;
    color: #1C2C58;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
  }

  .bundle-step-1 .promotion-block-container {
    margin-bottom: 1.5rem;
  }

  .bundle-step-1 .promotion-vouchers {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .bundle-step-1 .promotion-title {
    font-size: 16px;
    font-weight: 600;
    color: #1C2C58;
    margin: 0;
  }

  .bundle-step-1 .promotion-voucher-item {
    border: none;
    background: none;
    cursor: pointer;
    padding: 0;
  }

  .bundle-step-1 .combo-products-list {
    background-color: #F5F9FF;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .bundle-step-1 .combo-products-list h3 {
    font-size: 18px;
    font-weight: 600;
    color: #1C2C58;
    margin-bottom: 1rem;
  }

  .bundle-step-1 .combo-product-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #fff;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    margin-bottom: 8px;
  }

  .bundle-step-1 .combo-product-image {
    flex-shrink: 0;
    width: 220px;
    height: 130px;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
    border: 1px solid #E5E7EB;
  }

  .bundle-step-1 .combo-product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .bundle-step-1 .combo-product-info h4 {
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 4px 0;
    color: #1C2C58;
  }

  .bundle-step-1 .combo-product-attributes {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 14px;
    color: #6B7280;
  }

  .bundle-step-1 .combo-product-attributes span:first-child {
    font-weight: 500;
    color: #374151;
  }

  .bundle-step-1 .bundle-cta-btn {
    width: 100%;
    background: #FCE390 !important;
    color: #1C2C58 !important;
    font-weight: bold !important;
    font-size: 16px !important;
    padding: 15px !important;
    border-radius: 50px !important;
    border: none !important;
    margin-bottom: 1.5rem;
  }

  .bundle-step-1 .bundle-cta-btn:hover {
    background: #F4D03F !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  /* Product Summary Block Styles */
  .bundle-step-1 .product-summary-block {
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }



  .bundle-step-1 .product-accordion {
    background: #F5F9FF !important;
    border: none;
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .bundle-step-1 .product-accordion summary {
    background: #F5F9FF;
    padding: 16px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    color: #1C2C58;
    border: none;
    outline: none;
  }

  .bundle-step-1 .product-accordion summary:hover {
    background: #E8F2FF;
  }

  .bundle-step-1 .product-accordion-content {
    background: #F5F9FF;
    padding: 0 20px 16px 20px;
    border: none;
  }

  .bundle-step-1 .product-accordion[open] summary {
    border: none;
  }

  .bundle-step-1 .icon-toggle {
    transition: transform 0.3s ease;
  }

  .bundle-step-1 .product-accordion[open] .icon-toggle {
    transform: rotate(180deg);
  }

  .bundle-step-1 .showroom-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .bundle-step-1 .showroom-item {
    padding: 8px 0;
  }

  .bundle-step-1 .showroom-item strong {
    color: #1C2C58;
    font-weight: 600;
  }

  .bundle-step-1 .showroom-item a {
    color: #1C2C58;
    text-decoration: none;
  }

  .bundle-step-1 .showroom-item a:hover {
    text-decoration: underline;
  }

  /* Service Grid Styles */
  .bundle-step-1 .product-block--service-grid {
    margin-bottom: 1.5rem;
  }

  .bundle-step-1 .service-grid-wrapper {
    background: transparent;
  }

  .bundle-step-1 .service-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    background: transparent;
    border-radius: 0;
    overflow: visible;
  }

  .bundle-step-1 .service-grid-item {
    background: #F5F9FF;
    padding: 0;
    margin: 0;
    border-radius: 5px;
    border: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .bundle-step-1 .service-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    background: transparent;
    padding: 20px 16px;
    border-radius: 5px;
    transition: transform 0.2s ease;
    border: none;
    margin: 0;
    height: 100%;
  }

  .bundle-step-1 .service-item:hover {
    transform: translateY(-2px);
  }

  .bundle-step-1 .service-item__icon {
    margin-bottom: 12px;
    background: #F5F9FF;
  }

  .bundle-step-1 .service-item__icon img {
    width: 40px;
    height: 40px;
    object-fit: contain;
  }

  .bundle-step-1 .service-item__text {
    background: #F5F9FF;
  }

  .bundle-step-1 .service-item__text p {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #1C2C58;
    line-height: 1.4;
  }

  /* Sticky Scrolling Styles */
  .bundle-step-1 .product-grid {
    align-items: start;
  }

  .bundle-step-1 .is-sticky {
    position: -webkit-sticky;
    position: sticky;
    top: 120px; /* Adjust this value to sit below your site's sticky header */
    align-self: start; /* Ensures the column aligns to the top of the grid row */
  }

  /* 
    Definitive Pure CSS Sticky Column Solution
  */
  @media screen and (min-width: 991px) {
    /*
      CRITICAL FIX: `position: sticky` will NOT work if any parent element
      has `overflow` set to 'hidden', 'scroll', or 'auto'.
      This rule aggressively targets all potential parent containers in the product grid
      and forces them to allow sticky positioning.
    */
    .bundle-step-1 .page-content--product,
    .bundle-step-1 .page-content--product > .page-width,
    .bundle-step-1 .grid {
      padding-bottom: 0 !important;
      overflow: visible !important;
    }

    /*
      Disable theme's default sticky behavior on images.
      A custom script will handle advanced sticky positioning for either column.
    */
    .bundle-step-1 .product-single__sticky .sticky {
        position: static; /* Let JS control positioning */
    }

    /* 
      CRITICAL FIX: Dynamic max-width based on screen size
      Use CSS calc to make max-width responsive to viewport width
    */
    .bundle-step-1 .product-column-content {
      max-width: min(765px, 50vw) !important;
      width: 100% !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }

    .bundle-step-1 .product__photos img {
      max-width: min(765px, 50vw) !important;
      width: 100% !important;
      box-sizing: border-box !important;
      display: block !important;
      margin: 0 auto !important;
    }

    /* Force max-width lock during sticky states */
    .bundle-step-1 .product-column-content[style*="position: fixed"],
    .bundle-step-1 .product-column-content[style*="position: absolute"] {
      max-width: min(765px, 50vw) !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }

    /* Ensure product-main-slide respects container bounds during scroll animations */
    .bundle-step-1 .product-column-content[style*="position: fixed"] .product-main-slide,
    .bundle-step-1 .product-column-content[style*="position: fixed"] .product-main-slide img {
      max-width: 100% !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    /* Locked width columns - prevent any flex or grid from changing the locked widths */
    .bundle-step-1 .grid__item[style*="width:"] {
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
    }

    /* Lock all photos containers to prevent size fluctuations */
    .bundle-step-1 .product__photos[style*="width:"] {
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      box-sizing: border-box !important;
    }

    .bundle-step-1 .product-slideshow[style*="width:"] {
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      box-sizing: border-box !important;
    }

    .bundle-step-1 .product__main-photos[style*="width:"] {
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      box-sizing: border-box !important;
    }

    /* AGGRESSIVE GRID LOCK - Prevent any column from changing size */
    .bundle-step-1 .grid__item[style*="width:"] {
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      box-sizing: border-box !important;
    }

    /* Lock the main grid container */
    .bundle-step-1 .grid {
      display: flex !important;
      flex-wrap: nowrap !important;
      position: relative !important;
      overflow: visible !important;
      gap: 0 !important;
    }

    /* Image column - exactly 50% width */
    .bundle-step-1 .grid__item.product-single__sticky,
    .bundle-step-1 .grid__item.product-grid__images {
      flex: 0 0 50% !important;
      width: 50% !important;
      max-width: 50% !important;
      min-width: 50% !important;
      margin-right: 0 !important;
      padding-right: 0 !important;
    }

    /* Content column - exactly 50% width with 60px right padding */
    .bundle-step-1 .grid__item.product-grid__info {
      flex: 0 0 50% !important;
      width: 50% !important;
      max-width: 50% !important;
      min-width: 50% !important;
      margin-right: 0 !important;
      padding-right: 60px !important;
      box-sizing: border-box !important;
    }

    /* Ensure images never exceed their containers */
    .bundle-step-1 .product__photos img,
    .bundle-step-1 .product-main-slide img {
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      object-fit: cover !important;
      box-sizing: border-box !important;
    }

    /* FIX Z-INDEX LAYERING - Ensure image column is not covered by content column */
    .bundle-step-1 .grid__item.product-single__sticky,
    .bundle-step-1 .grid__item.product-grid__images {
      position: relative !important;
      z-index: 2 !important;
    }

    .bundle-step-1 .grid__item.product-grid__info {
      position: relative !important;
      z-index: 1 !important;
    }

    /* Ensure image containers have proper z-index */
    .bundle-step-1 .product__photos,
    .bundle-step-1 .product-slideshow,
    .bundle-step-1 .product__main-photos {
      position: relative !important;
      z-index: 3 !important;
    }

    /* Prevent content column from overlapping image column */
    .bundle-step-1 .product-single__meta {
      position: relative !important;
      z-index: 1 !important;
    }
  }

  /* Step 3: Bundle Summary - Match Step 1 Layout */
  .bundle-step-3 .product-summary-block {
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .bundle-step-3 .product-accordion {
    background: #F5F9FF !important;
    border: none;
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .bundle-step-3 .product-accordion summary {
    background: #F5F9FF;
    padding: 16px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    color: #1C2C58;
    border: none;
    outline: none;
  }

  .bundle-step-3 .product-accordion summary:hover {
    background: #E8F2FF;
  }

  .bundle-step-3 .product-accordion-content {
    background: #F5F9FF;
    padding: 0 20px 16px 20px;
    border: none;
  }

  .bundle-step-3 .product-accordion[open] summary {
    border: none;
  }

  .bundle-step-3 .icon-toggle {
    transition: transform 0.3s ease;
  }

  .bundle-step-3 .product-accordion[open] .icon-toggle {
    transform: rotate(180deg);
  }

  .bundle-step-3 .showroom-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .bundle-step-3 .showroom-item {
    background: white;
    padding: 12px 16px;
    border-radius: 6px;
    border: 1px solid #E8F2FF;
  }

  .bundle-step-3 .showroom-item strong {
    color: #1C2C58;
    font-weight: 600;
  }

  .bundle-step-3 .showroom-item a {
    color: #1C2C58;
    text-decoration: none;
  }

  .bundle-step-3 .showroom-item a:hover {
    text-decoration: underline;
  }

  /* Service Grid Styles for Step 3 */
  .bundle-step-3 .product-block--service-grid {
    margin-bottom: 1.5rem;
  }

  .bundle-step-3 .service-grid-wrapper {
    background: transparent;
  }

  .bundle-step-3 .service-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    background: transparent;
    border-radius: 0;
    overflow: visible;
  }

  .bundle-step-3 .service-grid-item {
    background: #F5F9FF;
    padding: 0;
    margin: 0;
    border-radius: 5px;
    border: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .bundle-step-3 .service-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    background: transparent;
    padding: 20px 16px;
    border-radius: 5px;
    transition: transform 0.2s ease;
    border: none;
    margin: 0;
    height: 100%;
  }

  .bundle-step-3 .service-item:hover {
    transform: translateY(-2px);
  }

  .bundle-step-3 .service-item__icon {
    margin-bottom: 12px;
    background: #F5F9FF;
  }

  .bundle-step-3 .service-item__icon img {
    width: 40px;
    height: 40px;
    object-fit: contain;
  }

  .bundle-step-3 .service-item__text {
    background: #F5F9FF;
  }

  .bundle-step-3 .service-item__text p {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #1C2C58;
    line-height: 1.4;
  }

  /* Step 2: Bundle Products Selection - Match Step 1 Layout */
  .bundle-step-2 .product-grid {
    align-items: start;
  }

  .bundle-step-2 .is-sticky {
    position: -webkit-sticky;
    position: sticky;
    top: 120px; /* Adjust this value to sit below your site's sticky header */
    align-self: start; /* Ensures the column aligns to the top of the grid row */
  }

  /* Step 2 Specific Styles */
  .bundle-step-2 .bundle-step-subtitle {
    font-size: 0.8em;
    font-weight: normal;
    color: #666;
    margin-left: 8px;
  }
  .bundle-step-title {
    font-size: 20px;
    font-weight: 400;
    color: #1C2C58;
    font-family: "Be Vietnam Pro";
    line-height: 140%;
    margin-bottom: 1rem;
  }
  .bundle-step-2 .product-block--header .product-single__title {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    color: #1C2C58;
    font-family: "Be Vietnam Pro";
    font-size: 39px;
    font-style: normal;
    font-weight: 600;
    line-height: 140%; /* 28px */
  }

  .bundle-products-grid .product-single__title {
    font-size: 39px;
    font-weight: 600;
    color: #1C2C58;
    font-family: "Be Vietnam Pro";
    line-height: 140%;
    margin-bottom: 1rem;
  }

  .bundle-step-2 .product-block--price {
    margin-bottom: 1.5rem;
  }

  .bundle-step-2 .price-container-wrapper {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .bundle-step-2 .product__price {
    font-size: 1.5rem;
    font-weight: bold;
    color: #1C2C58;
  }

  .bundle-step-2 .product__price--compare {
    text-decoration: line-through;
    font-weight: 400;
    color: #999;
    font-size: 1.2rem;
  }

  .bundle-step-2 .product__discount-badge {
    background: #FCE390;
    color: #1C2C58;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: bold;
  }


  /* Action Buttons */
  .bundle-step-2 .bundle-navigation {
    display: flex;
    gap: 1rem;
    margin: 2rem 0;
  }

  .bundle-step-2 .bundle-back-btn,
  .bundle-step-2 .bundle-continue-btn {
    flex: 1;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    text-transform: uppercase;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .bundle-step-2 .bundle-back-btn {
    background: #f5f5f5;
    color: #666;
    border: 1px solid #ddd;
    border-radius: 50px;
  }

  .bundle-step-2 .bundle-back-btn:hover {
    background: #e5e5e5;
  }

  .bundle-step-2 .bundle-continue-btn {
    border-radius: 50px;
    background: #FCE390;
    color: #000000;
  }

  .bundle-step-2 .bundle-continue-btn:hover {
    background: #0f1a3a;
  }


  /* Accordion Styles */
  .bundle-step-2 .product-accordion {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
  }

  .bundle-step-2 .product-accordion summary {
    padding: 1rem;
    background: #f9f9f9;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    color: #1C2C58;
  }

  .bundle-step-2 .product-accordion summary {
    background: #F5F9FF;
  }

  .bundle-step-2 .product-accordion-content {
    padding: 1rem;
    background: #F5F9FF;
  }

  /* Reviews Section */
  .bundle-step-2 .product-reviews-summary {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .bundle-step-2 .product-rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .bundle-step-2 .stars {
    display: flex;
    gap: 2px;
  }

  .bundle-step-2 .star {
    color: #ffd700;
    font-size: 1.2rem;
  }

  .bundle-step-2 .rating-value {
    font-weight: bold;
    color: #1C2C58;
  }

  .bundle-step-2 .reviews-number {
    color: #666;
  }

  /* Service Grid */
  .bundle-step-2 .service-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin: 2rem 0;
  }

  .bundle-step-2 .service-item {
    text-align: center;
    padding: 1rem;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    background: white;
  }

  .bundle-step-2 .service-item__icon {
    margin-bottom: 0.5rem;
  }

  .bundle-step-2 .service-item__text p {
    margin: 0;
    font-size: 0.9rem;
    color: #666;
  }

  /* 
    Definitive Pure CSS Sticky Column Solution for Step 2
  */
  @media screen and (min-width: 991px) {
    /*
      CRITICAL FIX: `position: sticky` will NOT work if any parent element
      has `overflow` set to 'hidden', 'scroll', or 'auto'.
      This rule aggressively targets all potential parent containers in the product grid
      and forces them to allow sticky positioning.
    */
    .bundle-step-2 .page-content--product,
    .bundle-step-2 .page-content--product > .page-width,
    .bundle-step-2 .grid {
      padding-bottom: 0 !important;
      overflow: visible !important;
    }

    /*
      Disable theme's default sticky behavior on images.
      A custom script will handle advanced sticky positioning for either column.
    */
    .bundle-step-2 .product-single__sticky .sticky {
        position: static; /* Let JS control positioning */
    }

    /* 
      CRITICAL FIX: Dynamic max-width based on screen size
      Use CSS calc to make max-width responsive to viewport width
    */
    .bundle-step-2 .product-column-content {
      max-width: min(765px, 50vw) !important;
      width: 100% !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }

  .bundle-step-2 .product__photos img {
    max-width: 100% !important;
    width: 100% !important;
    box-sizing: border-box !important;
    display: block !important;
    margin: 0 auto !important;
  }

  /* Ensure main photos container takes full width - Override all other rules */
  .bundle-step-2 .product__main-photos {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 100% !important;
    flex: 1 1 100% !important;
    display: block !important;
  }

  /* Ensure product slideshow takes full width */
  .bundle-step-2 .product__main-photos .product-slideshow {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 100% !important;
  }

  /* Ensure main slide takes full width */
  .bundle-step-2 .product-main-slide {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 100% !important;
    display: block !important;
  }

  /* Ensure main slide image takes full width */
  .bundle-step-2 .product-main-slide img {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 100% !important;
    height: auto !important;
    object-fit: cover !important;
    display: block !important;
  }

  /* Override any grid or flex constraints on the photos container */
  .bundle-step-2 .product__photos {
    width: 100% !important;
    max-width: 100% !important;
    display: block !important;
  }

  /* Override any column width constraints */
  .bundle-step-2 .product-column-content {
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Grid layout - Left column should be half width with proper spacing */
  .bundle-step-2 .grid__item.product-single__sticky {
    width: 50% !important;
    max-width: 50% !important;
    flex: 0 0 50% !important;
  }

  /* Product grid images should respect the column width */
  .bundle-step-2 .product-grid__images {
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Right column should also be half width */
  .bundle-step-2 .grid__item.product-grid__info {
    width: 50% !important;
    max-width: 50% !important;
    flex: 0 0 50% !important;
  }

  /* Force override for the entire photos container hierarchy */
  .bundle-step-2 .product__photos.product__photos--stack {
    width: 100% !important;
    max-width: 100% !important;
    display: block !important;
  }

  /* Override any potential flex or grid constraints */
  .bundle-step-2 .product__main-photos[data-product-single-media-group] {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 100% !important;
    flex: none !important;
    display: block !important;
  }

  /* Ensure grid container has proper display and spacing */
  .bundle-step-2 .grid {
    display: flex !important;
    flex-wrap: nowrap !important;
    gap: 20px !important;
    width: 100% !important;
  }

  /* Ensure proper spacing between columns */
  .bundle-step-2 .grid__item {
    box-sizing: border-box !important;
  }

    /* Force max-width lock during sticky states */
    .bundle-step-2 .product-column-content[style*="position: fixed"],
    .bundle-step-2 .product-column-content[style*="position: absolute"] {
      max-width: min(765px, 50vw) !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }
  }

  /* Bundle Main Container - Override theme styles */
  .bundle-main-container {
    width: 100% !important;
    max-width: none !important;
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    position: relative !important;
    overflow: visible !important;
  }

  /* Override any theme page-width styles that might affect our bundle */
  .bundle-main-container * {
    box-sizing: border-box;
  }

  .bundle-main-container .page-content {
    width: 100% !important;
    max-width: none !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Bundle Steps - Direct Padding */
  .bundle-step-1,
  .bundle-step-2,
  .bundle-step-3 {
    padding-left: 60px !important;
    padding-right: 60px !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }

  @media screen and (max-width: 768px) {
    .bundle-step-1,
    .bundle-step-2,
    .bundle-step-3 {
      padding-left: 16px !important;
      padding-right: 16px !important;
    }
  }

  /* Bundle Container - No padding, just max-width */
  .bundle-container {
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
  }

  /* Mobile responsive styles */
  @media screen and (max-width: 768px) {
    /* Step 1 Mobile Layout - Make it vertical like product template */
    .bundle-step-1 .grid {
      display: flex !important;
      flex-direction: column !important;
      flex-wrap: wrap !important;
    }
    show-more-gallery-btn{
      display: none !important;
    }
    .bundle-step-1 .grid__item.product-single__sticky,
    .bundle-step-1 .grid__item.product-grid__images {
      flex: 0 0 100% !important;
      width: 100% !important;
      max-width: 100% !important;
      min-width: 100% !important;
      margin-right: 0 !important;
      padding-right: 0 !important;
    }
    
    .bundle-step-1 .grid__item.product-grid__info {
      flex: 0 0 100% !important;
      width: 100% !important;
      max-width: 100% !important;
      min-width: 100% !important;
      margin-right: 0 !important;
      padding-right: 0 !important;
      box-sizing: border-box !important;
    }
    
    .bundle-step-1 .product-single__title {
      font-size: 20px;
    }
    
    .bundle-step-1 .product__price {
      font-size: 20px;
    }
    
    .bundle-step-1 .promotion-vouchers {
      flex-wrap: wrap;

    /* Mobile color swatch styles */
    [data-dynamic-variants-enabled] .variant-wrapper.is-color .variant-input-wrap {
      gap: 6px !important;
    }

    [data-dynamic-variants-enabled] .variant-wrapper.is-color .variant__button-label {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      max-width: 40px !important;
      max-height: 40px !important;
    }

    [data-dynamic-variants-enabled] .variant-wrapper.is-color .variant-input {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      max-width: 40px !important;
      max-height: 40px !important;
    }

    [data-dynamic-variants-enabled] .variant-wrapper.is-color .variant-input input[type="radio"]:checked + .variant__button-label::after {
      font-size: 14px !important;
    }

    /* Mobile step 2 color swatch styles */
    .bundle-step-2 .variant-wrapper.is-color .variant-input-wrap {
      gap: 6px !important;
    }

    .bundle-step-2 .variant-wrapper.is-color .variant__button-label {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      max-width: 40px !important;
      max-height: 40px !important;
    }

    .bundle-step-2 .variant-wrapper.is-color .variant-input {
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      max-width: 40px !important;
      max-height: 40px !important;
    }

    .bundle-step-2 .variant-wrapper.is-color .variant-input input[type="radio"]:checked + .variant__button-label::after {
      font-size: 14px !important;
    }
      gap: 8px;
    }
    
    .bundle-step-1 .combo-product-item {
      padding: 8px;
    }
    
    .bundle-step-1 .combo-product-image {
      width: 128px;
      height: 98px;
    }
    
    .bundle-step-1 .combo-product-attributes {
      gap: 2px;
      font-size: 12px;
      align-items: flex-start;
    }

    .bundle-step-1 .service-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .bundle-step-1 .service-grid-item {
      padding: 0;
      margin: 0;
      border-radius: 5px;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .bundle-step-1 .service-item {
      padding: 16px 12px;
      margin: 0;
      background: transparent;
    }

    .bundle-step-1 .product-summary-block,
    .bundle-step-1 .product-block--service-grid {
      padding: 16px;
    }

    .bundle-step-1 .product-accordion summary {
      padding: 12px 16px;
    }

    .bundle-step-1 .product-accordion-content {
      padding: 0 16px 12px 16px;
    }

    /* Step 3 Mobile Styles */
    .bundle-step-3 .service-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .bundle-step-3 .service-grid-item {
      padding: 0;
      margin: 0;
      border-radius: 5px;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .bundle-step-3 .service-item {
      padding: 16px 12px;
      margin: 0;
      background: transparent;
    }

    .bundle-step-3 .product-summary-block,
    .bundle-step-3 .product-block--service-grid {
      padding: 16px;
    }

    .bundle-step-3 .product-accordion summary {
      padding: 12px 16px;
    }

    .bundle-step-3 .product-accordion-content {
      padding: 0 16px 12px 16px;
    }
  }

</style>

<div id="MainProductBundle-{{ section.id }}" class="bundle-main-container">
  <div class="bundle-loading-overlay">
    <div class="spinner"></div>
  </div>
  
  <div class="bundle-dynamic-content">
    <!-- Step 1: Default Product Display -->
    <div class="bundle-step bundle-step-1" data-step="1">
      {%- liquid
        assign product_zoom_size = '1800x1800'
        
        case section.settings.image_size
          when 'small'
            assign product_image_width = 'medium-up--two-fifths'
            assign product_description_width = 'medium-up--three-fifths'
          when 'medium'
            assign product_image_width = 'large-up--one-half'
            assign product_description_width = 'large-up--one-half'
          when 'large'
            assign product_image_width = 'large-up--three-fifths'
            assign product_description_width = 'large-up--two-fifths'
        endcase
      -%}

      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid{% unless section.settings.image_position == 'left' %} grid--product-images-right{% endunless %}{% if section.settings.mobile_layout == 'partial' %} grid--product-images--partial{% endif %}">
            {%- if section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                <div class="product-column-content">
                  {%- render 'product-images',
                    section_id: section.id,
                    product: product,
                    product_zoom_enable: section.settings.product_zoom_enable,
                    product_zoom_size: product_zoom_size,
                    product_carousel_enable: false,
                    thumbnail_position: 'below',
                    thumbnail_height: section.settings.thumbnail_height,
                    thumbnail_arrows: section.settings.thumbnail_arrows,
                    mobile_layout: section.settings.mobile_layout,
                    blocks: section.blocks
                  -%}
                  <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                    <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                  <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                    <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
              </div>
            {%- endif -%}

            <div class="grid__item {{ product_description_width }} product-grid__info">
              <div class="product-single__meta product-info-inner">
                <div class="product-block product-block--header">
                  {%- if settings.vendor_enable -%}
                    <div class="product-single__vendor">
                      {%- assign vendor_handle = product.vendor | handleize -%}
                      {%- if collections[vendor_handle] != empty -%}
                        <a href="{{ routes.collections_url }}/{{ collections[vendor_handle].handle }}">
                          {{ collections[vendor_handle].title }}
                        </a>
                      {%- else -%}
                        {{ product.vendor | link_to_vendor }}
                      {%- endif -%}
                    </div>
                  {%- endif -%}

                  <!-- Product Reviews Section -->
                  <div class="product-reviews-summary">
                    <div class="product-rating">
                      <div class="stars">
                        <span class="star">★</span>
                        <span class="star">★</span>
                        <span class="star">★</span>
                        <span class="star">★</span>
                        <span class="star">★</span>
                      </div>
                      <span class="rating-value">{{ section.settings.review_rating | default: '4.8' }}</span>
                    </div>
                    <div class="reviews-count">
                      <span class="reviews-number">({{ section.settings.review_count | default: '2025 đánh giá' }})</span>
                    </div>
                  </div>

                  <h1 class="h2 product-single__title">
                    {%- unless product.empty? -%}
                      {{ product.title }}
                    {%- else -%}
                      {{ 'home_page.onboarding.product_title' | t }}
                    {%- endunless -%}
                  </h1>

                  {%- if section.settings.product_subtitle != blank -%}
                    <div class="product-single__subtitle">
                      {{ section.settings.product_subtitle }}
                    </div>
                  {%- endif -%}

                  {%- if section.settings.sku_enable -%}
                    <p data-sku class="product-single__sku">
                      {%- if current_variant.sku -%}
                        {{ current_variant.sku }}
                      {%- endif -%}
                    </p>
                  {%- endif -%}
                </div>

                <div data-product-blocks>
                  <!-- Price Block -->
                  <div class="product-block product-block--price">
                    <div class="price-container-wrapper">
                      <span class="product__price text-2xl f-smb">
                        {{ current_variant.price | money }}
                      </span>
                      {%- if current_variant.compare_at_price > current_variant.price -%}
                        <span class="product__price product__price--compare text-xl">
                          {{ current_variant.compare_at_price | money }}
                        </span>
                      {%- endif -%}
                      {%- if current_variant.compare_at_price > current_variant.price -%}
                        {%- capture discount_percentage -%}{{ current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round }}{%- endcapture -%}
                        <div class="product__discount-badge">-{{ discount_percentage }}%</div>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Combo Products List -->
                  <div class="product-block">
                      <h3 class="combo_title" style="background-color: #F5F9FF; padding: 10px; border-radius: 5px; margin: 0 0 0 0;">{{ section.settings.combo_title | default: "Combo bao gồm các sản phẩm:" }}</h3>
                    <div class="combo-products-list">
                      {%- if has_bundle_products and bundle_products_list -%}
                        {%- for bundle_product in bundle_products_list -%}
                          <div class="combo-product-item">
                            <div class="combo-product-image">
                              {%- if bundle_product.featured_media -%}
                                <img src="{{ bundle_product.featured_media | image_url: width: 440 }}" 
                                     alt="{{ bundle_product.title }}" 
                                     width="220" height="130"
                                     loading="lazy">
                              {%- endif -%}
                            </div>
                            <div class="combo-product-info">
                              <h4>{{ bundle_product.title }}</h4>
                              <div class="combo-product-attributes">
                                <span>Số lượng: 1</span>
                                <span>Kích thước: {{ bundle_product.options.size | default: '1' }} kích thước</span>
                              </div>
                            </div>
                          </div>
                        {%- endfor -%}
                      {%- else -%}
                        <div class="combo-product-placeholder" style="text-align: center; padding: 2rem; color: #666;">
                          <p>Chưa có sản phẩm trong combo</p>
                        </div>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Bundle CTA Button -->
                  <div class="product-block">
                    {%- if has_bundle_products -%}
                      <button
                        type="button"
                        name="bundle-cta"
                        data-bundle-cta
                        id="BundleCTAButton-{{ section.id }}-{{ product.id }}"
                        class="btn btn--full btn--primary bundle-cta-btn"
                        style="background: #FCE390; color: #1C2C58; font-weight: bold; font-size: 16px; padding: 15px; border-radius: 50px; border: none;"
                      >
                        <span data-bundle-cta-text>
                          {{ section.settings.cta_button_text | default: "BẮT ĐẦU TẠO COMBO" }}
                        </span>
                      </button>
                    {%- else -%}
                      <div class="bundle-setup-notice" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: center;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #856404;">⚠️ Bundle chưa được cấu hình</h4>
                        <p style="margin: 0; color: #856404; font-size: 1.15rem;">
                          Để sử dụng tính năng bundle, vui lòng thêm sản phẩm vào bundle trong Theme Editor.
                        </p>
                        <div style="margin-top: 0.5rem;">
                          <button
                            type="button"
                            class="btn btn--secondary"
                            style="font-size: 1rem; padding: 0.5rem 1rem;"
                            onclick="alert('Để thêm sản phẩm vào bundle:\\n\\n1. Vào Theme Editor\\n2. Chọn section Product Bundle\\n3. Trong settings, tìm Bundle Products\\n4. Click Change và chọn các sản phẩm muốn thêm vào bundle')"
                          >
                            Hướng dẫn cấu hình
                          </button>
                        </div>
                      </div>
                    {%- endif -%}
                  </div>

                  <!-- Product Summary Block -->
                  <div class="product-block product-summary-block">
                    <div class="product-summary-content">
                      <!-- Description Accordion -->
                      <details class="product-accordion product-accordion--styled" open>
                        <summary>
                          <span>Mô tả sản phẩm</span>
                          <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </summary>
                        <div class="product-accordion-content rte">
                          {{ product.description }}
                        </div>
                      </details>

                      <!-- Store System Accordion -->
                      <details class="product-accordion product-accordion--styled">
                        <summary>
                          <span>Hệ thống cửa hàng</span>
                          <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </summary>
                        <div class="product-accordion-content">
                          <div class="showroom-list">
                            <div class="showroom-item">
                              <strong>Showroom 1</strong><br>
                              <span>Địa chỉ showroom</span><br>
                              <a href="tel:0964777910">0964777910</a>
                            </div>
                            <div class="showroom-item">
                              <strong>Showroom 2</strong><br>
                              <span>Địa chỉ showroom</span><br>
                              <a href="tel:0964777910">0964777910</a>
                            </div>
                            <div class="showroom-item">
                              <strong>Showroom 3</strong><br>
                              <span>Địa chỉ showroom</span><br>
                              <a href="tel:0964777940">0964777940</a>
                            </div>
                          </div>
                        </div>
                      </details>

                      <!-- Reviews Accordion -->
                      <details class="product-accordion product-accordion--styled">
                        <summary>
                          <span>Đánh giá</span>
                          <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </summary>
                        <div class="product-accordion-content">
                          <div class="product-reviews-summary">
                            <div class="product-rating">
                              <div class="stars">
                                <span class="star">★</span>
                                <span class="star">★</span>
                                <span class="star">★</span>
                                <span class="star">★</span>
                                <span class="star">★</span>
                              </div>
                              <span class="rating-value">4.8</span>
                            </div>
                            <div class="reviews-count">
                              <span class="reviews-number">(2025 đánh giá)</span>
                            </div>
                          </div>
                        </div>
                      </details>
                    </div>
                  </div>

                  <!-- Service Grid -->
                  <div class="product-block product-block--service-grid">
                    <div class="service-grid-wrapper">
                      <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_1 -%}
                                <img src="{{ section.settings.service_icon_1 | image_url: width: 40 }}" alt="{{ section.settings.service_text_1 | default: '100 đêm ngủ thử' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_3.svg' | asset_url }}" alt="{{ section.settings.service_text_1 | default: '100 đêm ngủ thử' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_1 | default: "100 đêm ngủ thử" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_2 -%}
                                <img src="{{ section.settings.service_icon_2 | image_url: width: 40 }}" alt="{{ section.settings.service_text_2 | default: 'Miễn phí vận chuyển' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_4.svg' | asset_url }}" alt="{{ section.settings.service_text_2 | default: 'Miễn phí vận chuyển' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_2 | default: "Miễn phí vận chuyển" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_3 -%}
                                <img src="{{ section.settings.service_icon_3 | image_url: width: 40 }}" alt="{{ section.settings.service_text_3 | default: 'Bảo hành dài lâu' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_5.svg' | asset_url }}" alt="{{ section.settings.service_text_3 | default: 'Bảo hành dài lâu' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_3 | default: "Bảo hành dài lâu" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_4 -%}
                                <img src="{{ section.settings.service_icon_4 | image_url: width: 40 }}" alt="{{ section.settings.service_text_4 | default: 'Thanh toán linh hoạt' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_6.svg' | asset_url }}" alt="{{ section.settings.service_text_4 | default: 'Thanh toán linh hoạt' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_4 | default: "Thanh toán linh hoạt" }}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Render blocks from main-product.liquid -->
                  {%- for block in section.blocks -%}
                    {%- case block.type -%}
                      {%- when 'showroom_dropdown' -%}
                        <details class="product-accordion product-accordion--styled" {{ block.shopify_attributes }}>
                          <summary>
                            <span>{{ block.settings.title }}</span>
                            <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                          </summary>
                          <div class="product-accordion-content">
                            <div class="showroom-list showroom-list--accordion">
                              {%- if block.settings.showroom_1_name != blank -%}
                              <div class="showroom-item">
                                  <a href="{{ block.settings.showroom_1_map_link }}" target="_blank" rel="noopener" class="showroom-address">
                                    <strong>{{ block.settings.showroom_1_name }}</strong><br>
                                    {{ block.settings.showroom_1_address }}
                                  </a>
                                  <a class="phone-link" href="tel:{{ block.settings.showroom_1_phone | remove: ' ' }}">{{ block.settings.showroom_1_phone }}</a>
                              </div>
                              {%- endif -%}
                              {%- if block.settings.showroom_2_name != blank -%}
                              <div class="showroom-item">
                                  <a href="{{ block.settings.showroom_2_map_link }}" target="_blank" rel="noopener" class="showroom-address">
                                    <strong>{{ block.settings.showroom_2_name }}</strong><br>
                                    {{ block.settings.showroom_2_address }}
                                </a>
                                  <a class="phone-link" href="tel:{{ block.settings.showroom_2_phone | remove: ' ' }}">{{ block.settings.showroom_2_phone }}</a>
                              </div>
                              {%- endif -%}
                              {%- if block.settings.showroom_3_name != blank -%}
                              <div class="showroom-item">
                                  <a href="{{ block.settings.showroom_3_map_link }}" target="_blank" rel="noopener" class="showroom-address">
                                    <strong>{{ block.settings.showroom_3_name }}</strong><br>
                                    {{ block.settings.showroom_3_address }}
                                </a>
                                  <a class="phone-link" href="tel:{{ block.settings.showroom_3_phone | remove: ' ' }}">{{ block.settings.showroom_3_phone }}</a>
                              </div>
                              {%- endif -%}
                            </div>
                          </div>
                        </details>
                      {%- when 'service_grid' -%}
                        {%- liquid
                          assign services_count = 0
                          for i in (1..4)
                            assign icon_setting = 'icon_' | append: i
                            assign text_setting = 'text_' | append: i
                            assign show_setting = 'show_service_' | append: i
                            if block.settings[show_setting]
                              if block.settings[icon_setting] != blank or block.settings[text_setting] != blank
                                assign services_count = services_count | plus: 1
                              endif
                            endif
                          endfor
                        -%}
                        <div class="product-block product-block--service-grid" {{ block.shopify_attributes }}>
                          <div class="service-grid-wrapper">
                            <div class="service-grid" style="grid-template-columns: repeat({{ services_count }}, 1fr);">
                              {%- for i in (1..4) -%}
                                {%- liquid
                                  assign icon_setting = 'icon_' | append: i
                                  assign text_setting = 'text_' | append: i
                                  assign show_setting = 'show_service_' | append: i
                                  assign icon = block.settings[icon_setting]
                                  assign text = block.settings[text_setting]
                                  assign show_service = block.settings[show_setting]
                                -%}
                                {%- if show_service -%}
                                  {%- if icon != blank or text != blank -%}
                                  <div class="service-grid-item">
                                    <div class="service-item">
                                      {%- if icon != blank -%}
                                        <div class="service-item__icon">
                                          <img src="{{ icon | image_url: 'master' }}" alt="{{ icon.alt | default: text }}" width="40" height="40">
                                        </div>
                                      {%- endif -%}
                                      {%- if text != blank -%}
                                        <div class="service-item__text">
                                          <p>{{ text }}</p>
                                        </div>
                                      {%- endif -%}
                                    </div>
                                  </div>
                                  {%- endif -%}
                                {%- endif -%}
                              {%- endfor -%}
                            </div>
                        </div>
                      </div>
                    {%- endcase -%}
                  {%- endfor -%}
                </div>
              </div>
            </div>

            {%- unless section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                <div class="product-column-content">
                  {%- render 'product-images',
                    section_id: section.id,
                    product: product,
                    product_zoom_enable: section.settings.product_zoom_enable,
                    product_zoom_size: product_zoom_size,
                    product_carousel_enable: false,
                    thumbnail_position: 'below',
                    thumbnail_height: section.settings.thumbnail_height,
                    thumbnail_arrows: section.settings.thumbnail_arrows,
                    mobile_layout: section.settings.mobile_layout,
                    blocks: section.blocks
                  -%}
                  <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                    <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                  <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                    <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
              </div>
            {%- endunless -%}
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Bundle Products Selection -->
    <div class="bundle-step bundle-step-2" data-step="2" style="display: none;">
      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid grid--product-images-right">
            <!-- Bundle Product Images (Left) -->
            <div class="grid__item large-up--one-half product-single__sticky product-grid__images">
              <div class="product-column-content">
                <div class="product__photos product__photos-{{ section.id }} product__photos--stack product__photos--beside">
                  <!-- Main Product Image - Full Width Above Thumbnails -->
                  <div class="product__main-photos" data-product-single-media-group>
                    <div data-product-photos class="product-slideshow" id="BundleProductPhotos-{{ section.id }}">
                      <!-- Bundle product image will be loaded here -->
                      <div class="product-main-slide" data-index="0">
                        <div class="image-placeholder" style="width: 100%; height: 400px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #666;">
                          <p>Đang tải hình ảnh sản phẩm...</p>
                        </div>
                      </div>
            </div>
          </div>

                  <!-- Product Thumbnails Below Main Image -->
                  <div data-product-thumbs class="product__thumbs product__thumbs--below">
                    <div class="product__thumbs--scroller">
                      <!-- Thumbnails will be loaded here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bundle Product Info (Right) -->
            <div class="grid__item large-up--one-half product-grid__info">
              <div class="product-single__meta product-info-inner">
                <!-- Product Header with Bundle Step Header as subtitle -->
                <div class="product-block product-block--header">
                  <h1 class="h2 bundle-step-title">Chọn sản phẩm cho bundle <span class="bundle-step-subtitle">(<span class="bundle-progress-current">1</span>/<span class="bundle-progress-total">{% if has_bundle_products and bundle_products_list %}{{ bundle_products_list.size }}{% else %}0{% endif %}</span>)</span></h1>
                </div>

                <!-- Bundle Product Content -->
          <div class="bundle-products-grid">
            <!-- Bundle products will be loaded here -->
            <div class="bundle-product-placeholder" style="text-align: center; padding: 2rem; color: #666;">
              <p>Đang tải sản phẩm...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Bundle Summary -->
    <div class="bundle-step bundle-step-3" data-step="3" style="display: none;">
      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid grid--product-images-right">
            <!-- Bundle Images (Left) -->
            <div class="grid__item large-up--one-half product-single__sticky product-grid__images">
              <div class="product-column-content">
                <div class="product__photos product__photos-{{ section.id }} product__photos--stack product__photos--beside">
                  <!-- Main Product Image - Full Width Above Thumbnails -->
                  <div class="product__main-photos" data-product-single-media-group>
                    <div data-product-photos class="product-slideshow" id="BundlePhotos-{{ section.id }}">
                      <!-- Main bundle image will be loaded here -->
                      <div class="product-main-slide" data-index="0">
                        <img src="{{ product.featured_image | image_url: '620x' }}" alt="{{ product.title }}" width="620" height="620" style="width: 100%; height: auto;">
                      </div>
                    </div>
                  </div>

                  <!-- Product Thumbnails Below Main Image -->
                  <div data-product-thumbs class="product__thumbs product__thumbs--below">
                    <div class="product__thumbs--scroller">
                      <!-- Thumbnails will be loaded here -->
                    </div>
                  </div>
                </div>
                <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            </div>

            <!-- Bundle Summary (Right) -->
            <div class="grid__item large-up--one-half product-grid__info">
              <div class="product-single__meta">
                <!-- Bundle Summary Title -->
                <div class="product-block product-block--summary-title">
                  <h2 class="bundle-summary-title">Kiểm tra lại bundle của bạn</h2>
                </div>
                
                <!-- Bundle Header -->
                <div class="product-block product-block--header">
                  <h1 class="h2 product-single__title">{{ product.title }}</h1>
                </div>

                <!-- Bundle Products List -->
                <div class="product-block">
                  <div class="bundle-summary-products">
                    <!-- Selected products will be listed here -->
                  </div>
                </div>

                <!-- Divider Line -->
                <div class="bundle-summary-divider"></div>

                <!-- Bundle Total -->
                <div class="product-block">
                  <div class="bundle-summary-total">
                    <div class="bundle-total-row bundle-final">
                      <span class="bundle-final-total">0đ</span>
                    </div>
                    <div class="bundle-total-row">
                      <span class="bundle-original-total">0đ</span>
                      <span class="bundle-discount-badge">-{{ settings.discount_percentage | default: 10 }}%</span>
                    </div>
                  </div>
                </div>

                <!-- Bundle Actions -->
                <div class="product-block">
                  <div class="bundle-summary-actions">
                    <div class="bundle-quantity-selector">
                      <label for="bundle-quantity">Số lượng combo:</label>
                      <div class="quantity-dropdown">
                        <div class="quantity-display" data-quantity="1">
                          <span class="quantity-text">1</span>
                          <svg class="quantity-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </div>
                        <div class="quantity-options">
                          <div class="quantity-option" data-value="1">1</div>
                          <div class="quantity-option" data-value="2">2</div>
                          <div class="quantity-option" data-value="3">3</div>
                          <div class="quantity-option" data-value="4">4</div>
                          <div class="quantity-option" data-value="5">5</div>
                        </div>
                      </div>
                    </div>
                    <button type="button" class="btn btn--primary bundle-add-to-cart-btn" onclick="addBundleToCart()">Thêm vào giỏ</button>
                  </div>
                </div>

                <!-- Product Summary Block -->
                <div class="product-block product-summary-block">
                  <div class="product-summary-content">
                    <!-- Description Accordion -->
                    <details class="product-accordion product-accordion--styled" open>
                      <summary>
                        <span>Mô tả sản phẩm</span>
                        <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </summary>
                      <div class="product-accordion-content rte">
                        {{ product.description }}
                      </div>
                    </details>

                    <!-- Store System Accordion -->
                    <details class="product-accordion product-accordion--styled">
                      <summary>
                        <span>Hệ thống cửa hàng</span>
                        <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </summary>
                      <div class="product-accordion-content">
                        <div class="showroom-list">
                          <div class="showroom-item">
                            <strong>Showroom 1</strong><br>
                            <span>Địa chỉ showroom</span><br>
                            <a href="tel:0964777910">0964777910</a>
                          </div>
                          <div class="showroom-item">
                            <strong>Showroom 2</strong><br>
                            <span>Địa chỉ showroom</span><br>
                            <a href="tel:0964777910">0964777910</a>
                          </div>
                          <div class="showroom-item">
                            <strong>Showroom 3</strong><br>
                            <span>Địa chỉ showroom</span><br>
                            <a href="tel:0964777940">0964777940</a>
                          </div>
                        </div>
                      </div>
                    </details>

                    <!-- Reviews Accordion -->
                    <details class="product-accordion product-accordion--styled">
                      <summary>
                        <span>Đánh giá</span>
                        <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </summary>
                      <div class="product-accordion-content">
                        <div class="product-reviews-summary">
                          <div class="product-rating">
                            <div class="stars">
                              <span class="star">★</span>
                              <span class="star">★</span>
                              <span class="star">★</span>
                              <span class="star">★</span>
                              <span class="star">★</span>
                            </div>
                            <span class="rating-value">4.8</span>
                          </div>
                          <div class="reviews-count">
                            <span class="reviews-number">(2025 đánh giá)</span>
                          </div>
                        </div>
                      </div>
                    </details>
                  </div>
                </div>

                <!-- Service Grid -->
                <div class="product-block product-block--service-grid">
                  <div class="service-grid-wrapper">
                    <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_1 -%}
                              <img src="{{ section.settings.service_icon_1 | image_url: width: 40 }}" alt="{{ section.settings.service_text_1 | default: '100 đêm ngủ thử' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_3.svg' | asset_url }}" alt="{{ section.settings.service_text_1 | default: '100 đêm ngủ thử' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_1 | default: "100 đêm ngủ thử" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_2 -%}
                              <img src="{{ section.settings.service_icon_2 | image_url: width: 40 }}" alt="{{ section.settings.service_text_2 | default: 'Miễn phí vận chuyển' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_4.svg' | asset_url }}" alt="{{ section.settings.service_text_2 | default: 'Miễn phí vận chuyển' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_2 | default: "Miễn phí vận chuyển" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_3 -%}
                              <img src="{{ section.settings.service_icon_3 | image_url: width: 40 }}" alt="{{ section.settings.service_text_3 | default: 'Bảo hành dài lâu' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_5.svg' | asset_url }}" alt="{{ section.settings.service_text_3 | default: 'Bảo hành dài lâu' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_3 | default: "Bảo hành dài lâu" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_4 -%}
                              <img src="{{ section.settings.service_icon_4 | image_url: width: 40 }}" alt="{{ section.settings.service_text_4 | default: 'Thanh toán linh hoạt' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_6.svg' | asset_url }}" alt="{{ section.settings.service_text_4 | default: 'Thanh toán linh hoạt' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_4 | default: "Thanh toán linh hoạt" }}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            {%- unless section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                {%- render 'product-images',
                  section_id: section.id,
                  product: product,
                  product_zoom_enable: section.settings.product_zoom_enable,
                  product_zoom_size: product_zoom_size,
                  product_carousel_enable: false,
                  thumbnail_position: 'below',
                  thumbnail_height: section.settings.thumbnail_height,
                  thumbnail_arrows: section.settings.thumbnail_arrows,
                  mobile_layout: section.settings.mobile_layout,
                  blocks: section.blocks
                -%}
                <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            {%- endunless -%}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Debug Info -->
<!-- Has bundle products: {{ has_bundle_products }} -->
{%- if section.settings.bundle_products -%}
  <!-- Section settings bundle_products exists: true -->
  {%- assign first_product = section.settings.bundle_products | first -%}
  <!-- First product: {{ first_product }} -->
  {%- if first_product != blank -%}
    <!-- First product is not blank - bundle has products -->
    <!-- All products: {{ section.settings.bundle_products | join: ', ' }} -->
  {%- else -%}
    <!-- First product is blank - bundle is empty -->
  {%- endif -%}
{%- else -%}
  <!-- Section settings bundle_products exists: false -->
  <!-- Section settings bundle_products is blank -->
{%- endif -%}
{%- if bundle_products_list -%}
  <!-- Bundle products list count: {{ bundle_products_list.size }} -->
  <!-- Bundle products list: {{ bundle_products_list | join: ', ' }} -->
{%- else -%}
  <!-- Bundle products list is blank -->
{%- endif -%}

<!-- Raw section settings debug -->
<!-- Raw section.settings.bundle_products: {{ section.settings.bundle_products | json }} -->

<script id="BundleConfig-{{ section.id }}" type="application/json">
{
  "mainProductId": {{ product.id | json }},
  "mainProductHandle": {{ product.handle | json }},
  "moneyFormat": {{ shop.money_format | json }},
  "discountPercentage": {{ section.settings.discount_percentage | default: 10 }},
  "sectionId": {{ section.id | json }},
  "sectionSettings": {
    "product_carousel_enable": {{ section.settings.product_carousel_enable | json }},
    "thumbnail_position": {{ section.settings.thumbnail_position | json }},
    "image_position": {{ section.settings.image_position | json }}
  },
  "iconWithTextSettings": {
    {%- assign icon_block_found = false -%}
    {%- for block in section.blocks -%}
      {%- if block.type == 'icon_with_text' -%}
        {%- assign icon_block_found = true -%}
        "icon_1_image": {{ block.settings.icon_1_image | image_url: '100x' | json }},
        "icon_1_heading": {{ block.settings.icon_1_heading | json }},
        "icon_2_image": {{ block.settings.icon_2_image | image_url: '100x' | json }},
        "icon_2_heading": {{ block.settings.icon_2_heading | json }},
        "icon_3_image": {{ block.settings.icon_3_image | image_url: '100x' | json }},
        "icon_3_heading": {{ block.settings.icon_3_heading | json }},
        "icon_4_image": {{ block.settings.icon_4_image | image_url: '100x' | json }},
        "icon_4_heading": {{ block.settings.icon_4_heading | json }},
        "icon_size": {{ block.settings.icon_size | default: 25 | json }},
        "icon_alignment": {{ block.settings.icon_alignment | default: 'center' | json }},
        "grid_columns": {{ block.settings.grid_columns | default: "2" | json }},
        "show_icon_4": {% if block.settings.show_icon_4 == false %}false{% else %}true{% endif %}
      {%- endif -%}
    {%- endfor -%}
    {%- unless icon_block_found -%}
      "icon_1_image": null,
      "icon_1_heading": "100 đêm ngủ thử",
      "icon_2_image": null,
      "icon_2_heading": "Miễn phí vận chuyển *",
      "icon_3_image": null,
      "icon_3_heading": "Bảo hành dài lâu",
      "icon_4_image": null,
      "icon_4_heading": "Chất liệu Foam cao cấp",
      "icon_size": 25,
      "icon_alignment": "center",
      "grid_columns": "2",
      "show_icon_4": true
    {%- endunless -%}
  },
  "debug": {
    "hasBundleProducts": {{ has_bundle_products | json }},
    "hasBundleProductsRaw": {{ has_bundle_products }},
    "bundleProductsListExists": {% if bundle_products_list %}true{% else %}false{% endif %},
    "sectionSettingsExists": {% if section.settings.bundle_products %}true{% else %}false{% endif %},
    "firstProduct": {{ section.settings.bundle_products | first | json }},
    "sectionSettingsRaw": {{ section.settings.bundle_products | json }}
  },
        "bundleProducts": [
        {%- if has_bundle_products and bundle_products_list -%}
          {%- for bundle_product in bundle_products_list -%}
            {%- if bundle_product -%}
            {
              "handle": {{ bundle_product.handle | json }},
              "title": {{ bundle_product.title | json }},
              "id": {{ bundle_product.id | json }},
              "featured_image": {{ bundle_product.featured_media | image_url: 'medium' | json }},
              "price": {{ bundle_product.price | json }},
              "compare_at_price": {{ bundle_product.compare_at_price | json }},
              "description": {{ bundle_product.description | json }},
              "options": [
                {%- for option in bundle_product.options_with_values -%}
                  {
                    "name": {{ option.name | json }},
                    "values": {{ option.values | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              "media": [
                {%- for media in bundle_product.media -%}
                  {
                    "src": {{ media | image_url: 'medium' | json }},
                    "alt": {{ media.alt | json }},
                    "id": {{ media.id | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              "variants": [
                {%- for variant in bundle_product.variants -%}
                  {
                    "id": {{ variant.id | json }},
                    "title": {{ variant.title | json }},
                    "price": {{ variant.price | json }},
                    "compare_at_price": {{ variant.compare_at_price | json }},
                    "available": {{ variant.available | json }},
                    "featured_image": {{ variant.featured_media | image_url: 'medium' | json }},
                    "options": {{ variant.options | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ]
            }{% unless forloop.last %},{% endunless %}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      ],
  "hasBundleProducts": {{ has_bundle_products | json }}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('MainProductBundle-{{ section.id }}');
  if (!container) return;

  // IMMEDIATE WIDTH LOCK - Lock all photo containers as soon as page loads
  function lockAllPhotoContainers() {
    const step1Container = document.querySelector('.bundle-step-1');
    if (step1Container) {
      // Lock the main grid columns first
      const imageColumn = step1Container.querySelector('.grid__item.product-single__sticky, .grid__item.product-grid__images');
      const infoColumn = step1Container.querySelector('.grid__item.product-grid__info');
      
      if (imageColumn && infoColumn) {
        // Image column - exactly 50% width
        imageColumn.style.flex = '0 0 50%';
        imageColumn.style.width = '50%';
        imageColumn.style.maxWidth = '50%';
        imageColumn.style.minWidth = '50%';
        imageColumn.style.flexShrink = '0';
        imageColumn.style.flexGrow = '0';
        imageColumn.style.position = 'relative';
        imageColumn.style.zIndex = '2';
        imageColumn.style.paddingRight = '0';
        imageColumn.style.marginRight = '0';
        
        // Content column - exactly 50% width with 60px right padding
        infoColumn.style.flex = '0 0 50%';
        infoColumn.style.width = '50%';
        infoColumn.style.maxWidth = '50%';
        infoColumn.style.minWidth = '50%';
        infoColumn.style.flexShrink = '0';
        infoColumn.style.flexGrow = '0';
        infoColumn.style.position = 'relative';
        infoColumn.style.zIndex = '1';
        infoColumn.style.paddingRight = '60px';
        infoColumn.style.marginRight = '0';
        infoColumn.style.boxSizing = 'border-box';
        
      }
      
      // Set photo containers to take full width of their 50% column
      const photosContainers = step1Container.querySelectorAll('.product__photos, .product-slideshow, .product__main-photos, .product-main-slide');
      photosContainers.forEach(container => {
        container.style.width = '100%';
        container.style.maxWidth = '100%';
        container.style.minWidth = '100%';
        container.style.flexShrink = '0';
        container.style.flexGrow = '0';
        container.style.boxSizing = 'border-box';
        container.style.position = 'relative';
        container.style.zIndex = '3';
      });
      
      // Lock all images within the containers
      const images = step1Container.querySelectorAll('.product__photos img, .product-main-slide img');
      images.forEach(img => {
        img.style.maxWidth = '100%';
        img.style.width = '100%';
        img.style.height = 'auto';
        img.style.objectFit = 'cover';
        img.style.boxSizing = 'border-box';
      });
    }
  }
  
  // Lock immediately
  setTimeout(lockAllPhotoContainers, 100);
  window.addEventListener('resize', lockAllPhotoContainers);

  const configElement = document.getElementById('BundleConfig-{{ section.id }}');
  if (!configElement) return;

  
  let config;
  try {
    config = JSON.parse(configElement.textContent);
  } catch (error) {
    return;
  }
  
  
  if (config.bundleProducts.length === 0) {
    
    // Try to load products from debug info if available
    if (config.debug && config.debug.sectionSettingsRaw && Array.isArray(config.debug.sectionSettingsRaw)) {
      config.bundleProducts = config.debug.sectionSettingsRaw.map(productHandle => {
        return {
          handle: productHandle,
          title: productHandle, // Fallback title
          id: 0, // Fallback ID
          featured_image: '', // Fallback image
          price: 0, // Fallback price
          description: '', // Fallback description
          variants: [] // Fallback variants
        };
      });
    }
  }
  
  const dynamicContent = container.querySelector('.bundle-dynamic-content');
  const loadingOverlay = container.querySelector('.bundle-loading-overlay');

  // Bundle state
  let bundleState = {
    currentStep: 1,
    currentProductIndex: 0,
    bundleQuantity: 1,
    selectedProducts: {
      main: {
        variantId: {{ current_variant.id | json }},
        quantity: 1
      },
      bundle: []
    }
  };

  // Initialize variant picker for main product
  initializeVariantPicker();

  // Event listeners
  container.addEventListener('click', handleBundleEvents);
  

                function handleBundleEvents(e) {
                
                // Add to cart button click
                if (e.target.closest('.bundle-add-to-cart-btn')) {
                  e.preventDefault();
                  addBundleToCart();
                }
                // CTA button click
                else if (e.target.closest('.bundle-cta-btn') || e.target.closest('[data-bundle-cta]')) {
                  e.preventDefault();
                  
                  // More robust check for bundle products
                  const hasProducts = config.hasBundleProducts === true || config.hasBundleProducts === 'true';
                  const productsArray = Array.isArray(config.bundleProducts) ? config.bundleProducts : [];
                  const hasValidProducts = productsArray.length > 0;
                  
                  // Alternative check using debug info
                  const debugHasProducts = config.debug && config.debug.hasBundleProducts === true;
                  const debugFirstProduct = config.debug && config.debug.firstProduct && config.debug.firstProduct !== '';
                  
                  
                  // Use multiple checks to ensure we have products
                  const shouldProceed = (hasProducts && hasValidProducts) || (debugHasProducts && debugFirstProduct);
                  
                  if (shouldProceed) {
                    showStep(2);
                    loadBundleProduct(0);
                  } else {
                    alert('Chưa có sản phẩm bundle được cấu hình!\n\nĐể thêm sản phẩm vào bundle:\n1. Vào Theme Editor\n2. Chọn section "Product Bundle"\n3. Trong settings, tìm "Bundle Products"\n4. Click "Change" và chọn các sản phẩm muốn thêm vào bundle');
                  }
                }

    // Quantity selector
    if (e.target.closest('.quantity-display')) {
      e.preventDefault();
      const dropdown = e.target.closest('.quantity-dropdown');
      dropdown.classList.toggle('active');
    }
    
    if (e.target.closest('.quantity-option')) {
      e.preventDefault();
      const option = e.target.closest('.quantity-option');
      const newQuantity = parseInt(option.getAttribute('data-value'));
      const dropdown = option.closest('.quantity-dropdown');
      const display = dropdown.querySelector('.quantity-text');
      
      // Update display
      if (display) {
        display.textContent = newQuantity;
      }
      
      // Update data attribute
      dropdown.querySelector('.quantity-display').setAttribute('data-quantity', newQuantity);
      
      // Update selected state
      dropdown.querySelectorAll('.quantity-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      option.classList.add('selected');
      
      // Close dropdown
      dropdown.classList.remove('active');
      
      // Update bundle quantity
      bundleState.bundleQuantity = newQuantity;
      
      // Re-render bundle summary with new quantity
      if (bundleState.currentStep === 3) {
        renderBundleSummary();
      }
    }
    
    // Close dropdown when clicking outside
    if (!e.target.closest('.quantity-dropdown')) {
      container.querySelectorAll('.quantity-dropdown').forEach(dropdown => {
        dropdown.classList.remove('active');
      });
    }

    // Back button (only for step 2)
    if (e.target.closest('.bundle-back-btn')) {
      e.preventDefault();
      if (bundleState.currentStep === 2) {
        // Quay lại sản phẩm trước đó trong bundle
        if (bundleState.currentProductIndex > 0) {
          bundleState.currentProductIndex--;
          loadBundleProduct(bundleState.currentProductIndex);
        } else {
          // Nếu đang ở sản phẩm đầu tiên, quay lại step 1
          showStep(1);
        }
      } else if (bundleState.currentStep > 1) {
        showStep(bundleState.currentStep - 1);
      }
    }

    // Continue button
    if (e.target.closest('.bundle-continue-btn')) {
      e.preventDefault();
      
      if (bundleState.currentStep === 2) {
        
        if (bundleState.currentProductIndex < config.bundleProducts.length - 1) {
          bundleState.currentProductIndex++;
          loadBundleProduct(bundleState.currentProductIndex);
        } else {
          showStep(3);
          renderBundleSummary();
        }
      }
    }

    // Buy now button
    if (e.target.closest('.bundle-buy-now-btn')) {
      e.preventDefault();
      buyBundleNow();
    }
    
    // Change product link
    if (e.target.closest('.bundle-product-change-link')) {
      e.preventDefault();
      const changeLink = e.target.closest('.bundle-product-change-link');
      const productIndex = parseInt(changeLink.getAttribute('data-product-index'));
      console.log('Change product clicked for index:', productIndex);
      changeProduct(productIndex);
    }
  }

  function showStep(step) {
    bundleState.currentStep = step;
    
    // Hide all steps
    container.querySelectorAll('.bundle-step').forEach(el => {
      el.style.display = 'none';
    });
    
    // Show current step
    const currentStepEl = container.querySelector(`[data-step="${step}"]`);
    if (currentStepEl) {
      currentStepEl.style.display = 'block';
    }
    
    // Initialize step 2 - tự động chọn sản phẩm đầu tiên
    if (step === 2) {
      console.log('=== INITIALIZING STEP 2 ===');
      
      // Tự động chọn sản phẩm đầu tiên nếu chưa có sản phẩm nào được chọn
      if (bundleState.selectedProducts.bundle.length === 0 && config.bundleProducts && config.bundleProducts.length > 0) {
        console.log('Auto-selecting first bundle product...');
        const firstProduct = config.bundleProducts[0];
        
        // Tạo sản phẩm mặc định với variant đầu tiên
        const defaultVariant = firstProduct.variants && firstProduct.variants.length > 0 ? firstProduct.variants[0] : null;
        const defaultImage = extractImageUrl(firstProduct.featured_image) || 
                            (firstProduct.media && firstProduct.media.length > 0 ? extractImageUrl(firstProduct.media[0]) : '');
        
        const autoSelectedProduct = {
          productId: firstProduct.id,
          productHandle: firstProduct.handle,
          productTitle: firstProduct.title,
          image: defaultImage,
          variantId: defaultVariant ? defaultVariant.id : null,
          variantTitle: defaultVariant ? defaultVariant.title : 'Default Title',
          variantPrice: defaultVariant ? defaultVariant.price : firstProduct.price,
          variantOptions: defaultVariant ? defaultVariant.options : [],
          quantity: 1
        };
        
        bundleState.selectedProducts.bundle.push(autoSelectedProduct);
        console.log('✅ Auto-selected first product:', autoSelectedProduct);
      }
      
      // Load the first bundle product
      console.log('Loading first bundle product...');
      loadBundleProduct(0);
      
      // Initialize sticky columns for step 2
      setTimeout(() => {
        initializeStep2StickyColumns();
      }, 100);
    }
    
    // Initialize step 3 if needed
    if (step === 3) {
      console.log('=== INITIALIZING STEP 3 ===');
      
      // Initialize quantity selector
      initializeQuantitySelector();
      
      // Ensure first slide is visible
      const firstSlide = currentStepEl.querySelector('.product-main-slide');
      if (firstSlide) {
        firstSlide.style.display = 'block';
        console.log('✅ First slide made visible');
      }
      
      // Ensure first thumbnail is active
      const firstThumb = currentStepEl.querySelector('[data-product-thumb]');
      if (firstThumb) {
        firstThumb.classList.add('active');
        console.log('✅ First thumbnail made active');
      }
      
      // Check if thumbnails exist
      const thumbnails = currentStepEl.querySelectorAll('[data-product-thumb]');
      console.log('Found thumbnails in step 3:', thumbnails.length);
      
      // Check if product__thumbs--scroller exists
      const scroller = currentStepEl.querySelector('.product__thumbs--scroller');
      console.log('Found product__thumbs--scroller:', !!scroller);
      
      if (scroller) {
        console.log('Scroller innerHTML length:', scroller.innerHTML.length);
        console.log('Scroller children count:', scroller.children.length);
      }
    }
  }

  async function loadBundleProduct(index) {
    console.log('=== LOAD BUNDLE PRODUCT DEBUG ===');
    console.log('Index:', index);
    console.log('Config bundleProducts:', config.bundleProducts);
    console.log('Config bundleProducts length:', config.bundleProducts.length);
    console.log('Config bundleProducts type:', typeof config.bundleProducts);
    
    const product = config.bundleProducts[index];
    console.log('Product at index', index, ':', product);
    
    if (!product) {
      console.error('No product found at index:', index);
      return;
    }

    bundleState.currentProductIndex = index;
    
    // Update progress
    const progressCurrent = container.querySelector('.bundle-progress-current');
    const progressTotal = container.querySelector('.bundle-progress-total');
    if (progressCurrent) {
      progressCurrent.textContent = index + 1;
    }
    if (progressTotal) {
      progressTotal.textContent = config.bundleProducts.length;
    }

    // Update the product image in the left column
    const step2Element = container.querySelector('.bundle-step-2');
    console.log('Step 2 element found:', !!step2Element);
    
    if (!step2Element) {
      console.error('❌ Step 2 element not found!');
      return;
    }
    
    const productImageContainer = step2Element.querySelector('[data-product-photos]');
    const productThumbsContainer = step2Element.querySelector('.product__thumbs--scroller');
    
    console.log('Product image container found:', !!productImageContainer);
    console.log('Product thumbs container found:', !!productThumbsContainer);
    
    if (!productImageContainer) {
      console.error('❌ Product image container not found!');
      console.log('Available elements in step2:', step2Element.querySelectorAll('*'));
      return;
    }
    
    if (productImageContainer) {
      // Debug the product structure first
      console.log('=== PRODUCT IMAGE DEBUG ===');
      console.log('Product object:', product);
      console.log('Product.featured_image:', product.featured_image);
      console.log('Product.media:', product.media);
      console.log('Product.variants:', product.variants);
      
      if (product.variants && product.variants.length > 0) {
        console.log('First variant:', product.variants[0]);
        console.log('First variant featured_image:', product.variants[0].featured_image);
      }
      
      // Get the first variant's image or fallback to featured image
      let productImage = '';
      
      // Use the same logic as thumbnails - try media array first since thumbnails work
      if (product.media && product.media.length > 0) {
        // Check if media.src is actually a string or an object
        if (typeof product.media[0].src === 'string') {
          productImage = product.media[0].src;
        } else if (product.media[0].src && typeof product.media[0].src === 'object') {
          productImage = product.media[0].src.src || product.media[0].src.url || product.media[0].src.preview_image || '';
        }
      }
      
      // If media didn't work, try variant featured image
      if (!productImage && product.variants && product.variants.length > 0 && product.variants[0].featured_image) {
        if (typeof product.variants[0].featured_image === 'string') {
          productImage = product.variants[0].featured_image;
        } else if (product.variants[0].featured_image && typeof product.variants[0].featured_image === 'object') {
          productImage = product.variants[0].featured_image.src || product.variants[0].featured_image.url || product.variants[0].featured_image.preview_image || '';
        }
      }
      
      // If variant didn't work, try product featured image
      if (!productImage && product.featured_image) {
        if (typeof product.featured_image === 'string') {
          productImage = product.featured_image;
        } else if (product.featured_image && typeof product.featured_image === 'object') {
          productImage = product.featured_image.src || product.featured_image.url || product.featured_image.preview_image || '';
        }
      }
      
      console.log('Final product image URL:', productImage);
      
      if (productImage && productImage !== '') {
        console.log('✅ Setting product image:', productImage);
        productImageContainer.innerHTML = `
          <div class="product-main-slide" data-index="0">
            <img src="${productImage}" alt="${product.title}" width="620" height="620" style="width: 100%; height: auto;">
          </div>
        `;
        console.log('✅ Updated product image successfully');
      } else {
        console.log('❌ No valid product image found');
        console.log('ProductImage value:', productImage);
        console.log('ProductImage type:', typeof productImage);
        productImageContainer.innerHTML = `
          <div class="product-main-slide" data-index="0">
            <div class="image-placeholder" style="width: 100%; height: 400px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #666;">
              <p>Không có hình ảnh</p>
            </div>
          </div>
        `;
      }
    } else {
      console.log('Product image container not found');
    }
    
    // Update thumbnails below the main image
    if (productThumbsContainer && product.media && product.media.length > 1) {
      console.log('=== THUMBNAIL DEBUG ===');
      console.log('Product media array:', product.media);
      console.log('First media item:', product.media[0]);
      console.log('First media src:', product.media[0] ? product.media[0].src : 'undefined');
      console.log('First media type:', typeof (product.media[0] ? product.media[0].src : 'undefined'));
      
      const thumbnailsHTML = product.media.map((media, index) => {
        console.log(`Media ${index}:`, media);
        console.log(`Media ${index} src:`, media.src);
        console.log(`Media ${index} src type:`, typeof media.src);
        
        // Check if media.src is actually a string or an object
        let imageUrl = '';
        if (typeof media.src === 'string') {
          imageUrl = media.src;
        } else if (media.src && typeof media.src === 'object') {
          // If it's an object, try to extract the URL
          imageUrl = media.src.src || media.src.url || media.src.preview_image || '';
        }
        
        console.log(`Final imageUrl for media ${index}:`, imageUrl);
        
        return `
          <div class="product__thumb-item" data-index="${index}">
            <a href="${imageUrl}" data-product-thumb class="product__thumb" data-index="${index}">
              <div class="image-wrap image-wrap__thumbnail">
                <img src="${imageUrl}" alt="${product.title}" loading="lazy">
              </div>
            </a>
          </div>
        `;
      }).join('');
      
      productThumbsContainer.innerHTML = thumbnailsHTML;
      console.log('Updated product thumbnails:', product.media.length);
    }

    // Render product info in the right column
    const productsGrid = container.querySelector('.bundle-products-grid');
    console.log('Products grid element:', productsGrid);
    
    if (productsGrid) {
      try {
            console.log('Loading bundle product:', product.handle);
    console.log('Product data:', {
      title: product.title,
      price: product.price,
      description: product.description,
      variants: product.variants,
      featured_image: product.featured_image
    });
    
    // Debug variant structure
    if (product.variants && product.variants.length > 0) {
      console.log('Product variants count:', product.variants.length);
      console.log('First variant:', product.variants[0]);
      console.log('First variant options:', product.variants[0].options);
      console.log('Product options:', product.options);
    }
        
        // Use simplified product template structure for right column only
        const productHTML = `
          <div class="bundle-product-item" data-product-handle="${product.handle}" data-section-id="${config.sectionId}" data-product-id="${product.id}">
                      <!-- Product Header -->
                      <div class="product-block product-block--header">
                        <h1 class="h2 product-single__title">${product.title}</h1>
                      </div>

                      <!-- Price Block -->
                      <div class="product-block product-block--price">
                        <div class="price-container-wrapper">
                          <span class="product__price text-2xl f-smb" data-product-price data-product-price-base="${product.price}">
                            ${formatMoney(product.price)}
                          </span>
                          ${product.compare_at_price ? `
                            <span class="product__price product__price--compare text-xl" data-compare-price>
                              ${formatMoney(product.compare_at_price)}
                            </span>
                            <div class="product__discount-badge">
                              -${Math.round((product.compare_at_price - product.price) / product.compare_at_price * 100)}%
                            </div>
                          ` : ''}
                        </div>
                        

                      </div>


                      <!-- Hidden ProductSelect for variant tracking -->
                      <select name="id" id="ProductSelect-bundle-${product.id}" class="product-single__variants" style="display: none;">
                        ${product.variants.map(variant => `
                          <option value="${variant.id}" ${variant.available ? '' : 'disabled'} data-variant-price="${variant.price}" data-variant-compare-price="${variant.compare_at_price || ''}">
                            ${variant.title}
                          </option>
                        `).join('')}
                      </select>
                      
                      <!-- Hidden Sticky ProductSelect for variant tracking -->
                      <select name="id" id="ProductSelect-bundle-${product.id}-sticky" class="product-single__variants" style="display: none;">
                        ${product.variants.map(variant => `
                          <option value="${variant.id}" ${variant.available ? '' : 'disabled'} data-variant-price="${variant.price}" data-variant-compare-price="${variant.compare_at_price || ''}">
                            ${variant.title}
                          </option>
                        `).join('')}
                      </select>

                      <!-- Variant Picker - Using existing structure -->
                      ${product.variants && product.variants.length > 1 ? `
                        <div class="product-block" data-dynamic-variants-enabled>
                          ${(() => {
                            const options = [];
                            if (product.options && product.options.length > 0) {
                              product.options.forEach((option, optionIndex) => {
                                options.push({
                                  name: option.name,
                                  values: option.values,
                                  index: optionIndex
                                });
                              });
                            }
                            return options.map(option => {
                              const isColor = option.name.toLowerCase().includes('color') || option.name.toLowerCase().includes('màu') || option.name.toLowerCase().includes('colour');
                              const isSize = option.name.toLowerCase().includes('size') || 
                                            option.name.toLowerCase().includes('kích thước') ||
                                            option.name.toLowerCase().includes('kích thước') ||
                                            option.name.toLowerCase().includes('kích thước');
                              
                              let labelHtml = '<label class="variant__label" for="ProductSelect-bundle-' + product.id + '-option-' + option.index + '">' + option.name + ':';
                              // Always add variant label info for all options
                              labelHtml += '<span class="variant__label-info" data-index="' + option.index + '"><span data-variant-selected-label>' + option.values[0] + '</span></span>';
                              labelHtml += '</label>';
                                                            
                              // Add size lock note for non-first products
                              if (isSize && bundleState.currentProductIndex > 0 && bundleState.lockedSize) {
                                const firstProduct = config.bundleProducts[0];
                                const firstProductTitle = firstProduct ? firstProduct.title : 'Sản phẩm đầu tiên';
                                labelHtml += '<div class="size-lock-note" style="font-size: 12px; color: #6B7280; margin-top: 4px; font-style: italic;">Bạn đã chọn size <strong>' + bundleState.lockedSize + '</strong> ở ' + firstProductTitle + '</div>';
                              }

                              let fieldsetHtml = '<fieldset class="variant-input-wrap flex ai-center gap-x-md flex-wrap" name="' + option.name + '" data-index="option' + (option.index + 1) + '" data-handle="' + option.name.toLowerCase().replace(/\s+/g, '-') + '" data-option-count="' + option.values.length + '" id="ProductSelect-bundle-' + product.id + '-option-' + option.index + '"><legend class="hide">' + option.name + '</legend>';
                              fieldsetHtml += option.values.map((value, valueIndex) => {
                                const variant = product.variants.find(v => v.options[option.index] === value);
                                const isAvailable = variant && variant.available !== false;
                                const disabledClass = !isAvailable ? ' disabled' : '';
                                const checked = valueIndex === 0 ? 'checked="checked"' : '';
                                
                                if (isColor) {
                                  // Chuẩn hóa tên màu cho file PNG
                                  const colorValue = value.toLowerCase().replace(/\s+/g, '-');
                                  const colorFileName = colorValue + '_50x50.png';
                                  // Đường dẫn CDN đúng chuẩn Shopify theme (tự động lấy file nếu có, fallback nếu không)
                                  const colorImageUrl = `https://ru9.vn/cdn/shop/files/${colorFileName}`;
                                  // Fallback màu cuối cùng nếu không có ảnh
                                  const colorSwatchFallback = value.split(' ').pop().toLowerCase();
                                  
                                  return '<div class="variant-input" data-index="option' + (option.index + 1) + '" data-value="' + value + '">' +
                                    '<input type="radio" ' + checked + ' value="' + value + '" data-index="option' + (option.index + 1) + '" name="' + option.name + '-' + product.id + '" data-variant-input class="variant__input--color-swatch' + (!isAvailable ? ' disabled' : '') + '" data-color-name="' + value + '" data-color-index="' + option.index + '" id="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '">' +
                                    '<label for="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '" class="variant__button-label color-swatch color-swatch--' + colorValue + disabledClass + '" style="background-color: ' + colorSwatchFallback + '; background-image: url(' + colorImageUrl + ') !important;" title="' + value + '"></label></div>';
                                } else if (isSize) {
                                  // Parse size value to separate name and dimensions
                                  let sizeName = value;
                                  let sizeDimensions = '';
                                  
                                  // Check if value contains dimensions (e.g., "Single + 120 x 200cm")
                                  if (value.includes('+') || value.includes('x') || value.includes('cm')) {
                                    // Split by common separators
                                    const parts = value.split(/[\+\-\–]/);
                                    if (parts.length >= 2) {
                                      sizeName = parts[0].trim();
                                      sizeDimensions = parts.slice(1).join(' ').trim();
                                    } else if (value.includes('x') && value.includes('cm')) {
                                      // Try to extract dimensions from format like "120 x 200cm"
                                      const dimensionMatch = value.match(/(\d+\s*x\s*\d+cm)/);
                                      if (dimensionMatch) {
                                        sizeDimensions = dimensionMatch[1];
                                        sizeName = value.replace(dimensionMatch[1], '').trim();
                                      }
                                    }
                                  }
                                  
                                  return '<div class="variant-input" data-index="option' + (option.index + 1) + '" data-value="' + value + '">' +
                                    '<input type="radio" ' + checked + ' value="' + value + '" data-index="option' + (option.index + 1) + '" name="' + option.name + '" data-variant-input class="variant__input--pill' + (!isAvailable ? ' disabled' : '') + '" data-value-name="' + value + '" data-value-index="' + option.index + '" id="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '">' +
                                    '<label for="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '" class="variant__button-label t-center' + disabledClass + '">' +
                                    '<span class="label-head block text-sm f-smb">' + sizeName + '</span>' +
                                    (sizeDimensions ? '<span class="label-value block text-xs">' + sizeDimensions + '</span>' : '') +
                                    '</label></div>';
                                } else {
                                  return '<div class="variant-input" data-index="option' + (option.index + 1) + '" data-value="' + value + '">' +
                                    '<input type="radio" ' + checked + ' value="' + value + '" data-index="option' + (option.index + 1) + '" name="' + option.name + '" data-variant-input class="variant__input' + (!isAvailable ? ' disabled' : '') + '" id="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '">' +
                                    '<label for="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '" class="variant__button-label' + disabledClass + '">' + value + '</label></div>';
                                }
                              }).join('');
                              fieldsetHtml += '</fieldset>';
                              return '<div class="variant-wrapper js ' + option.name.toLowerCase().replace(/\s+/g, '-') + (isSize ? ' size' : '') + (isColor ? ' color' : '') + '" data-type="button">' + labelHtml + fieldsetHtml + '</div>';
                            }).join('');
                          })()}
                        </div>
                      ` : ''}

                      <!-- Navigation Buttons -->
                      <div class="product-block">
                        <div class="bundle-navigation">
                          <button type="button" class="btn btn--secondary bundle-back-btn">Quay lại</button>
                          <button type="button" class="btn btn--primary bundle-continue-btn">Tiếp tục</button>
                        </div>
                      </div>

                      <!-- Product Summary Block -->
                      <div class="product-block product-summary-block">
                        <div class="product-summary-content">
                          <!-- Description Accordion -->
                          <details class="product-accordion product-accordion--styled" open>
                            <summary>
                              <span>Mô tả sản phẩm</span>
                              <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </summary>
                            <div class="product-accordion-content rte">
                              ${product.description}
                            </div>
                          </details>

                          <!-- Store System Accordion -->
                          <details class="product-accordion product-accordion--styled">
                            <summary>
                              <span>Hệ thống cửa hàng</span>
                              <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </summary>
                            <div class="product-accordion-content">
                              <div class="showroom-list">
                                {%- if section.settings.showroom_1_name != blank -%}
                                <div class="showroom-item">
                                  <a href="{{ section.settings.showroom_1_map_link | default: '#' }}" target="_blank" rel="noopener" class="showroom-address">
                                    <strong>{{ section.settings.showroom_1_name }}</strong><br>
                                    {{ section.settings.showroom_1_address }}
                                  </a>
                                  <a class="phone-link" href="tel:{{ section.settings.showroom_1_phone | remove: ' ' }}">{{ section.settings.showroom_1_phone }}</a>
                                </div>
                                {%- endif -%}
                                {%- if section.settings.showroom_2_name != blank -%}
                                <div class="showroom-item">
                                  <a href="{{ section.settings.showroom_2_map_link | default: '#' }}" target="_blank" rel="noopener" class="showroom-address">
                                    <strong>{{ section.settings.showroom_2_name }}</strong><br>
                                    {{ section.settings.showroom_2_address }}
                                  </a>
                                  <a class="phone-link" href="tel:{{ section.settings.showroom_2_phone | remove: ' ' }}">{{ section.settings.showroom_2_phone }}</a>
                                </div>
                                {%- endif -%}
                                {%- if section.settings.showroom_3_name != blank -%}
                                <div class="showroom-item">
                                  <a href="{{ section.settings.showroom_3_map_link | default: '#' }}" target="_blank" rel="noopener" class="showroom-address">
                                    <strong>{{ section.settings.showroom_3_name }}</strong><br>
                                    {{ section.settings.showroom_3_address }}
                                  </a>
                                  <a class="phone-link" href="tel:{{ section.settings.showroom_3_phone | remove: ' ' }}">{{ section.settings.showroom_3_phone }}</a>
                                </div>
                                {%- endif -%}
                              </div>
                            </div>
                          </details>

                          <!-- Reviews Accordion -->
                          <details class="product-accordion product-accordion--styled">
                            <summary>
                              <span>Đánh giá</span>
                              <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </summary>
                            <div class="product-accordion-content">
                              <div class="product-reviews-summary">
                                <div class="product-rating">
                                  <div class="stars">
                                    <span class="star">★</span>
                                    <span class="star">★</span>
                                    <span class="star">★</span>
                                    <span class="star">★</span>
                                    <span class="star">★</span>
                                  </div>
                                  <span class="rating-value">{{ section.settings.review_rating | default: '4.8' }}</span>
                                </div>
                                <div class="reviews-count">
                                  <span class="reviews-number">({{ section.settings.review_count | default: '2025 đánh giá' }})</span>
                                </div>
                              </div>
                            </div>
                          </details>
                        </div>
                      </div>

                      <!-- Service Grid -->
                      <div class="product-block product-block--service-grid">
                        <div class="service-grid-wrapper">
                          <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="service-grid-item">
                              <div class="service-item">
                                <div class="service-item__icon">
                                  {%- if section.settings.service_icon_1 -%}
                                    <img src="{{ section.settings.service_icon_1 | image_url: width: 40 }}" alt="{{ section.settings.service_text_1 | default: '100 đêm ngủ thử' }}" width="40" height="40">
                                  {%- else -%}
                                    <img src="{{ 'Layer_1_3.svg' | asset_url }}" alt="{{ section.settings.service_text_1 | default: '100 đêm ngủ thử' }}" width="40" height="40">
                                  {%- endif -%}
                                </div>
                                <div class="service-item__text">
                                  <p>{{ section.settings.service_text_1 | default: "100 đêm ngủ thử" }}</p>
                                </div>
                              </div>
                            </div>
                            <div class="service-grid-item">
                              <div class="service-item">
                                <div class="service-item__icon">
                                  {%- if section.settings.service_icon_2 -%}
                                    <img src="{{ section.settings.service_icon_2 | image_url: width: 40 }}" alt="{{ section.settings.service_text_2 | default: 'Miễn phí vận chuyển' }}" width="40" height="40">
                                  {%- else -%}
                                    <img src="{{ 'Layer_1_4.svg' | asset_url }}" alt="{{ section.settings.service_text_2 | default: 'Miễn phí vận chuyển' }}" width="40" height="40">
                                  {%- endif -%}
                                </div>
                                <div class="service-item__text">
                                  <p>{{ section.settings.service_text_2 | default: "Miễn phí vận chuyển" }}</p>
                                </div>
                              </div>
                            </div>
                            <div class="service-grid-item">
                              <div class="service-item">
                                <div class="service-item__icon">
                                  {%- if section.settings.service_icon_3 -%}
                                    <img src="{{ section.settings.service_icon_3 | image_url: width: 40 }}" alt="{{ section.settings.service_text_3 | default: 'Bảo hành dài lâu' }}" width="40" height="40">
                                  {%- else -%}
                                    <img src="{{ 'Layer_1_5.svg' | asset_url }}" alt="{{ section.settings.service_text_3 | default: 'Bảo hành dài lâu' }}" width="40" height="40">
                                  {%- endif -%}
                                </div>
                                <div class="service-item__text">
                                  <p>{{ section.settings.service_text_3 | default: "Bảo hành dài lâu" }}</p>
                                </div>
                              </div>
                            </div>
                            <div class="service-grid-item">
                              <div class="service-item">
                                <div class="service-item__icon">
                                  {%- if section.settings.service_icon_4 -%}
                                    <img src="{{ section.settings.service_icon_4 | image_url: width: 40 }}" alt="{{ section.settings.service_text_4 | default: 'Thanh toán linh hoạt' }}" width="40" height="40">
                                  {%- else -%}
                                    <img src="{{ 'Layer_1_6.svg' | asset_url }}" alt="{{ section.settings.service_text_4 | default: 'Thanh toán linh hoạt' }}" width="40" height="40">
                                  {%- endif -%}
                                </div>
                                <div class="service-item__text">
                                  <p>{{ section.settings.service_text_4 | default: "Thanh toán linh hoạt" }}</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

            </div>
          </div>
        `;
        
        console.log('Generated HTML:', productHTML);
        productsGrid.innerHTML = productHTML;
        
        console.log('HTML set successfully. Products grid innerHTML length:', productsGrid.innerHTML.length);
        console.log('Products grid children count:', productsGrid.children.length);
        

        
        // Initialize variant picker
        const productContainer = productsGrid.querySelector('.bundle-product-item');
        if (productContainer) {
          initializeBundleProductVariantPicker(productContainer);
        }
    
        // Update progress
        updateBundleProgress();
      } catch (error) {
        console.error('Error loading bundle product:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          product: product
        });
        // Show error message
        productsGrid.innerHTML = `
          <div class="bundle-product-item" data-product-handle="${product.handle}">
            <div class="error-message" style="text-align: center; padding: 2rem; color: red;">
              <h3>Lỗi tải sản phẩm</h3>
              <p>Không thể tải thông tin sản phẩm: ${product.title}</p>
              <p>Lỗi: ${error.message}</p>
            </div>
          </div>
        `;
      }
    }
  }

  function updateBundleProgress() {
    const progressCurrent = container.querySelector('.bundle-progress-current');
    const progressTotal = container.querySelector('.bundle-progress-total');
    
    if (progressCurrent) {
      progressCurrent.textContent = bundleState.currentProductIndex + 1;
    }
    if (progressTotal) {
      progressTotal.textContent = config.bundleProducts.length;
    }
  }



  // Helper function to extract image URL from various formats
  function extractImageUrl(imageData) {
    if (!imageData) return '';
    
    // If it's already a string URL, return it
    if (typeof imageData === 'string') {
      return imageData;
    }
    
    // If it's an object, try to extract the URL
    if (typeof imageData === 'object') {
      // Try different possible properties
      return imageData.src || 
             imageData.url || 
             imageData.preview_image || 
             imageData.featured_image ||
             (imageData.media && imageData.media.length > 0 ? imageData.media[0].src : '') ||
             '';
    }
    
    return '';
  }

  function renderBundleSummary() {
    const summaryProducts = container.querySelector('.bundle-summary-products');
    const bundlePhotos = container.querySelector('#BundlePhotos-{{ section.id }}');
    
    console.log('=== RENDER BUNDLE SUMMARY DEBUG ===');
    console.log('summaryProducts found:', !!summaryProducts);
    console.log('bundlePhotos found:', !!bundlePhotos);
    
    if (!summaryProducts) return;

    let totalOriginal = 0;
    let totalFinal = 0;

    // Add main product - use selected variant if available
    console.log('=== MAIN PRODUCT DEBUG ===');
    console.log('bundleState.selectedProducts.main:', bundleState.selectedProducts.main);
    
    const mainProduct = {
      productTitle: {{ product.title | json }},
      variantTitle: bundleState.selectedProducts.main.variantTitle || {{ current_variant.title | json }},
      variantOptions: bundleState.selectedProducts.main.variantOptions || {{ current_variant.options | json }},
      quantity: bundleState.selectedProducts.main.quantity || 1,
      price: bundleState.selectedProducts.main.variantPrice || {{ current_variant.price | json }},
      image: extractImageUrl(bundleState.selectedProducts.main.image) || extractImageUrl({{ product.featured_image | json }})
    };
    
    console.log('=== MAIN PRODUCT PRICE DEBUG ===');
    console.log('bundleState.selectedProducts.main:', bundleState.selectedProducts.main);
    console.log('mainProduct.price:', mainProduct.price);
    console.log('mainProduct.price type:', typeof mainProduct.price);
    
    console.log('Final mainProduct:', mainProduct);

    // Add bundle products - ensure we use variantPrice for bundle products and extract image URL
    const bundleProductsWithCorrectPrice = bundleState.selectedProducts.bundle.map(product => ({
      ...product,
      price: product.variantPrice || product.price, // Use variantPrice if available
      image: extractImageUrl(product.image) // Extract proper image URL
    }));
    
    console.log('=== PRICE MAPPING DEBUG ===');
    bundleState.selectedProducts.bundle.forEach((originalProduct, index) => {
      const mappedProduct = bundleProductsWithCorrectPrice[index];
      console.log(`Product ${index} price mapping:`, {
        title: originalProduct.productTitle,
        originalPrice: originalProduct.price,
        variantPrice: originalProduct.variantPrice,
        finalPrice: mappedProduct.price,
        variantTitle: originalProduct.variantTitle
      });
    });
    
    // Chỉ tính các sản phẩm bundle được chọn từ step 2, không tính sản phẩm mặc định từ step 1
    const allProducts = [...bundleProductsWithCorrectPrice];
    
    console.log('=== ALL PRODUCTS DEBUG ===');
    console.log('mainProduct (không tính vào bundle):', mainProduct);
    console.log('bundleState.selectedProducts.bundle:', bundleState.selectedProducts.bundle);
    console.log('allProducts (chỉ sản phẩm bundle được chọn):', allProducts);
    console.log('allProducts length:', allProducts.length);
    
    // Debug each product's price
    allProducts.forEach((product, index) => {
      console.log(`Product ${index} price debug:`, {
        title: product.productTitle,
        price: product.price,
        priceType: typeof product.price,
        quantity: product.quantity,
        quantityType: typeof product.quantity,
        variantTitle: product.variantTitle,
        variantId: product.variantId
      });
    });
    
    // Debug bundle state specifically
    console.log('=== BUNDLE STATE PRICE DEBUG ===');
    bundleState.selectedProducts.bundle.forEach((product, index) => {
      console.log(`Bundle product ${index}:`, {
        title: product.productTitle,
        variantTitle: product.variantTitle,
        variantId: product.variantId,
        variantPrice: product.variantPrice,
        price: product.price,
        variantPriceType: typeof product.variantPrice,
        priceType: typeof product.price
      });
    });
    
    // Debug variant options for each product
    allProducts.forEach((product, index) => {
      console.log(`Product ${index} (${product.productTitle}):`, {
        variantTitle: product.variantTitle,
        variantOptions: product.variantOptions,
        hasVariantOptions: !!product.variantOptions,
        variantOptionsLength: product.variantOptions ? product.variantOptions.length : 0
      });
      
      // Debug the actual HTML generation for this product
      if (product.variantOptions && product.variantOptions.length > 0) {
        const generatedHTML = product.variantOptions.map((option, optionIndex) => {
          const optionName = optionIndex === 0 ? 'Kích thước' : 
                            optionIndex === 1 ? 'Màu sắc' : 
                            `Tùy chọn ${optionIndex + 1}`;
          return `${optionName}: ${option}`;
        }).join(', ');
        console.log(`  Generated HTML for product ${index}:`, generatedHTML);
      } else {
        console.log(`  Fallback HTML for product ${index}: Variant: ${product.variantTitle}`);
      }
    });
    
    // Calculate total original price - chỉ tính các sản phẩm bundle được chọn
    console.log('=== CALCULATING TOTAL ORIGINAL PRICE (BUNDLE PRODUCTS ONLY) ===');
    
    // Get bundle quantity (default to 1 if not set)
    const bundleQuantity = bundleState.bundleQuantity || 1;
    console.log('Bundle quantity:', bundleQuantity);
    
    allProducts.forEach((product, index) => {
      // Ensure price is a number
      const price = parseFloat(product.price) || 0;
      const quantity = parseInt(product.quantity) || 1;
      const productTotal = price * quantity * bundleQuantity;
      totalOriginal += productTotal;
      
      console.log(`Bundle Product ${index} (${product.productTitle}):`, {
        originalPrice: product.price,
        parsedPrice: price,
        originalQuantity: product.quantity,
        parsedQuantity: quantity,
        bundleQuantity: bundleQuantity,
        productTotal: productTotal,
        runningTotal: totalOriginal
      });
    });
    console.log('Final totalOriginal (bundle products only):', totalOriginal);
    
    // Update bundle summary products (right side) - chỉ hiển thị các sản phẩm bundle được chọn
    summaryProducts.innerHTML = allProducts.map((product, index) => {
      return `
        <div class="bundle-summary-product">
          <div class="bundle-product-number">${index + 1}.</div>
          <div class="bundle-product-content">
            <div class="bundle-product-info">
              <div class="bundle-product-title">${product.productTitle}</div>
              <div class="bundle-product-attributes">
                ${product.variantOptions && product.variantOptions.length > 0 ? 
                  product.variantOptions.map((option, optionIndex) => {
                    const optionName = optionIndex === 0 ? 'Kích thước' : 
                                      optionIndex === 1 ? 'Màu sắc' : 
                                      `Tùy chọn ${optionIndex + 1}`;
                    return `<div class="bundle-product-attribute">${optionName}: ${option}</div>`;
                  }).join('') : 
                  `<div class="bundle-product-attribute">Variant: ${product.variantTitle}</div>`
                }
              </div>
              <div class="bundle-product-price">
                ${formatMoney(product.price)}
                ${product.compareAtPrice && product.compareAtPrice > product.price ? 
                  `<span class="bundle-product-compare-price">${formatMoney(product.compareAtPrice)}</span>` : 
                  ''}
              </div>
              <div class="bundle-product-change-link" data-product-index="${index}">Thay đổi</div>
            </div>
            <div class="bundle-product-image">
              <img src="${product.image}" alt="${product.productTitle}" width="80" height="80">
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    // Wait a bit for DOM to update, then update photos and thumbnails
    setTimeout(() => {
      // Update bundle photos (left side) - Create only 1 main slide
      if (bundlePhotos) {
        // Create only 1 main slide that will change its image when thumbnails are clicked
        bundlePhotos.innerHTML = `
          <div class="product-main-slide" data-index="0">
            <img src="${mainProduct.image}" alt="${mainProduct.productTitle}" width="620" height="620" style="width: 100%; height: auto;">
          </div>
        `;
        console.log('✅ Created single main slide with main product image');
      }
      
      // Update thumbnails with selected bundle product images - Match Step 1 & 2 structure
      const thumbnailsContainer = container.querySelector('.bundle-step-3 [data-product-thumbs] .product__thumbs--scroller');
      if (thumbnailsContainer) {
        console.log('Updating thumbnails with selected bundle products...');
        const allImages = [mainProduct, ...allProducts];
        
        // Create thumbnails exactly like Step 1 & 2
        const thumbnailsHTML = allImages.map((product, index) => {
          return `
            <div class="product__thumb-item" data-index="${index}">
              <a href="${product.image}" data-product-thumb class="product__thumb" data-index="${index}" data-image-src="${product.image}">
                <div class="image-wrap image-wrap__thumbnail">
                  <img src="${product.image}" alt="${product.productTitle}" loading="lazy">
                </div>
              </a>
            </div>
          `;
        }).join('');
        
        thumbnailsContainer.innerHTML = thumbnailsHTML;
        console.log(`✅ Created ${allImages.length} thumbnails for step 3`);
        
        // Add click handlers to thumbnails
        const thumbLinks = thumbnailsContainer.querySelectorAll('[data-product-thumb]');
        thumbLinks.forEach((thumb, index) => {
          thumb.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Remove active class from all thumbs
            thumbLinks.forEach(t => t.classList.remove('active'));
            // Add active class to clicked thumb
            thumb.classList.add('active');
            
            // Update the single main slide image
            const mainSlideImg = container.querySelector('.bundle-step-3 .product-main-slide img');
            const imageSrc = thumb.getAttribute('data-image-src');
            const productTitle = thumb.querySelector('img').alt;
            
            if (mainSlideImg && imageSrc) {
              mainSlideImg.src = imageSrc;
              mainSlideImg.alt = productTitle;
              console.log(`Switched main image to: ${productTitle}`);
            }
          });
        });
        
        // Make first thumbnail active by default
        if (thumbLinks.length > 0) {
          thumbLinks[0].classList.add('active');
        }
      }

    }, 100); // Wait 100ms for DOM to update

    // Calculate totals
    console.log('=== PRICE CALCULATION DEBUG ===');
    console.log('totalOriginal:', totalOriginal);
    console.log('config:', config);
    console.log('config.discountPercentage:', config.discountPercentage);
    console.log('config.discountPercentage type:', typeof config.discountPercentage);
    
    // Ensure discountPercentage is a number
    const discountPercentage = parseFloat(config.discountPercentage) || 10;
    console.log('Using discountPercentage:', discountPercentage);
    
    const discountAmount = totalOriginal * (discountPercentage / 100);
    console.log('Discount amount:', discountAmount);
    totalFinal = totalOriginal - discountAmount;
    console.log('totalFinal:', totalFinal);

    // Update totals
    const originalTotalEl = container.querySelector('.bundle-original-total');
    const discountAmountEl = container.querySelector('.bundle-discount-amount');
    const finalTotalEl = container.querySelector('.bundle-final-total');
    
    console.log('Price elements found:', {
      originalTotal: !!originalTotalEl,
      discountAmount: !!discountAmountEl,
      finalTotal: !!finalTotalEl
    });
    
    if (originalTotalEl) {
      originalTotalEl.textContent = formatMoney(totalOriginal);
      console.log('✅ Updated original total:', formatMoney(totalOriginal));
    } else {
      console.log('❌ Original total element not found');
    }
    
    if (discountAmountEl) {
      discountAmountEl.textContent = formatMoney(discountAmount);
      console.log('✅ Updated discount amount:', formatMoney(discountAmount));
    } else {
      console.log('❌ Discount amount element not found');
    }
    
    if (finalTotalEl) {
      finalTotalEl.textContent = formatMoney(totalFinal);
      console.log('✅ Updated final total:', formatMoney(totalFinal));
    } else {
      console.log('❌ Final total element not found');
    }
    
    // Initialize thumbnail click events
    initializeBundleThumbnailEvents();
    
    // Initialize buy now button with direct event listener
    initializeBuyNowButton();
  }

  function initializeQuantitySelector() {
    console.log('=== INITIALIZING QUANTITY SELECTOR ===');
    
    const quantityDisplay = container.querySelector('.quantity-display');
    const quantityText = container.querySelector('.quantity-text');
    const quantityOptions = container.querySelectorAll('.quantity-option');
    
    if (quantityDisplay && quantityText) {
      // Set initial value
      const currentQuantity = bundleState.bundleQuantity || 1;
      quantityText.textContent = currentQuantity;
      quantityDisplay.setAttribute('data-quantity', currentQuantity);
      
      // Set selected state
      quantityOptions.forEach(option => {
        option.classList.remove('selected');
        if (parseInt(option.getAttribute('data-value')) === currentQuantity) {
          option.classList.add('selected');
        }
      });
      
      console.log('✅ Quantity selector initialized with value:', currentQuantity);
    } else {
      console.log('❌ Quantity selector elements not found');
    }
  }

  function initializeBuyNowButton() {
    console.log('=== INITIALIZING BUY NOW BUTTON ===');
    
    // Try multiple selectors to find the buy now button
    const buyNowBtn = container.querySelector('.bundle-buy-now-btn') || 
                     container.querySelector('.btn--primary.bundle-buy-now-btn') ||
                     container.querySelector('button.bundle-buy-now-btn');
    
    console.log('Buy now button found:', !!buyNowBtn);
    console.log('Buy now button element:', buyNowBtn);
    
    if (buyNowBtn) {
      // Remove any existing event listeners
      buyNowBtn.removeEventListener('click', handleBuyNowClick);
      
      // Add direct event listener
      buyNowBtn.addEventListener('click', handleBuyNowClick);
      console.log('✅ Buy now button event listener added');
      
      // Also add onclick attribute as fallback
      buyNowBtn.onclick = handleBuyNowClick;
      console.log('✅ Buy now button onclick attribute added');
    } else {
      console.log('❌ Buy now button not found');
    }
  }
  
  function handleBuyNowClick(e) {
    console.log('=== BUY NOW BUTTON CLICKED ===');
    e.preventDefault();
    e.stopPropagation();
    console.log('Event:', e);
    console.log('Target:', e.target);
    buyBundleNow();
  }

  function initializeBundleThumbnailEvents() {
    const thumbnails = container.querySelectorAll('.bundle-step-3 [data-product-thumb]');
    const mainSlides = container.querySelectorAll('.bundle-step-3 .product-main-slide');
    
    console.log('Initializing bundle thumbnail events');
    console.log('Found thumbnails:', thumbnails.length);
    console.log('Found main slides:', mainSlides.length);
    
    thumbnails.forEach((thumb, index) => {
      thumb.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Remove active class from all thumbnails
        thumbnails.forEach(t => {
          t.classList.remove('active', 'is-active');
          t.removeAttribute('aria-selected');
        });
        
        // Hide all main slides
        mainSlides.forEach(slide => {
          slide.style.display = 'none';
          slide.classList.remove('is-selected');
        });
        
        // Add active class to clicked thumbnail
        thumb.classList.add('active', 'is-active');
        thumb.setAttribute('aria-selected', 'true');
        
        // Show corresponding main slide
        const targetSlide = mainSlides[index];
        if (targetSlide) {
          targetSlide.style.display = 'block';
          targetSlide.classList.add('is-selected');
        }
        
        console.log(`Clicked thumbnail ${index}, showing slide ${index}`);
      });
    });
    
    // Set first thumbnail as active by default
    if (thumbnails.length > 0) {
      thumbnails[0].classList.add('active', 'is-active');
      thumbnails[0].setAttribute('aria-selected', 'true');
    }
    
    // Show first slide by default
    if (mainSlides.length > 0) {
      mainSlides[0].style.display = 'block';
      mainSlides[0].classList.add('is-selected');
    }
  }

  function changeProduct(productIndex) {
    console.log('Changing product at index:', productIndex);
    
    // If it's the main product (index 0), go back to step 1
    if (productIndex === 0) {
      showStep(1);
      return;
    }
    
    // If it's a bundle product, go back to step 2 with the specific product
    const bundleIndex = productIndex - 1; // Convert to bundle array index
    if (bundleIndex >= 0 && bundleIndex < bundleState.selectedProducts.bundle.length) {
      bundleState.currentProductIndex = bundleIndex;
      showStep(2);
      return;
    }
  }

  function addBundleToCart() {
    const items = [];
    const bundleQty = bundleState.bundleQuantity || 1;
    
    // Skip main product for now - only add bundle products
    // The main product might be the bundle itself, so we don't want to add it twice
    
    // Add bundle products
    bundleState.selectedProducts.bundle.forEach((product) => {
      if (product.variantId) {
        const bundleItem = {
          id: product.variantId,
          quantity: (product.quantity || 1) * bundleQty
        };
        items.push(bundleItem);
      }
    });

    if (items.length === 0) {
      return;
    }

    fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ items: items })
    })
    .then(response => {
      if (!response.ok) {
        return response.text().then(text => {
          throw new Error(`HTTP error! status: ${response.status}, details: ${text}`);
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.status && data.status !== 200) {
        throw new Error(`Cart API error: ${data.description || 'Unknown error'}`);
      }
      
      if (typeof updateCartCount === 'function') updateCartCount();
      
      // Refresh cart drawer immediately
      refreshCartDrawer();
    })
    .catch(error => {
      // Silent fail - no alert shown
    });
  }

  function refreshCartDrawer() {
    // Use the same method as cart-drawer.liquid
    if (typeof theme !== 'undefined' && typeof theme.CartForm === 'function') {
      const cartFormInstance = new theme.CartForm(document.getElementById('CartDrawerForm'));
      cartFormInstance.buildCart();
    } else {
      // Fallback: reload the page
      window.location.href = window.location.href;
    }
    
    // Open the cart drawer
    openCartDrawer();
  }

  function openCartDrawer() {
    // Try multiple methods to open the cart drawer
    
    // Method 1: Try theme.Drawer if it exists
    if (typeof theme !== 'undefined' && theme.Drawer) {
      if (typeof theme.Drawer.open === 'function') {
        theme.Drawer.open('CartDrawer');
        return;
      }
    }
    
    // Method 2: Try to trigger cart drawer open event
    const cartDrawer = document.getElementById('CartDrawer');
    if (cartDrawer) {
      // Add active class to show drawer
      cartDrawer.classList.add('drawer--open', 'active', 'is-open');
      document.body.classList.add('drawer-open', 'cart-open');
      
      // Dispatch custom event
      document.dispatchEvent(new CustomEvent('cart:open'));
      window.dispatchEvent(new CustomEvent('drawer:open', { detail: { id: 'CartDrawer' } }));
      return;
    }
    
    // Method 3: Try to click cart icon to open drawer
    const cartTrigger = document.querySelector('[data-cart-drawer-toggle], .js-drawer-open-cart, .cart-icon, [href="#CartDrawer"]');
    if (cartTrigger) {
      cartTrigger.click();
      return;
    }
    
    // Method 4: Try to find and click any element that opens cart
    const cartButton = document.querySelector('button[aria-controls="CartDrawer"], [data-drawer-target="CartDrawer"]');
    if (cartButton) {
      cartButton.click();
    }
  }

  function initializeVariantPicker() {
    console.log('=== INITIALIZE VARIANT PICKER FOR MAIN PRODUCT ===');
    
    // Listen for variant changes on main product
    container.addEventListener('change', function(event) {
      if (event.target.closest('.bundle-step-1') && event.target.hasAttribute('data-variant-input')) {
        console.log('Main product variant changed');
        
        // Get the selected variant
        const selectedVariant = event.target.closest('.bundle-step-1').querySelector('[data-variant-input]:checked');
        if (selectedVariant) {
          const variantId = selectedVariant.value;
          console.log('Selected variant ID:', variantId);
          
          // Find the variant data
          const variant = {{ product.variants | json }}.find(v => v.id.toString() === variantId);
          if (variant) {
            console.log('Found variant:', variant);
            
            // Update main product in bundle state
            bundleState.selectedProducts.main = {
              variantId: variant.id,
              variantTitle: variant.title,
              variantOptions: variant.options,
              variantPrice: variant.price,
              image: extractImageUrl(variant.featured_image) || extractImageUrl({{ product.featured_image | json }}),
              quantity: bundleState.selectedProducts.main.quantity
            };
            
            console.log('Updated main product in bundle state:', bundleState.selectedProducts.main);
          }
        }
      }
    });
  }



  function initializeBundleProductVariantPicker(container) {
    console.log('=== INITIALIZE BUNDLE PRODUCT VARIANT PICKER ===');
    
    const currentProduct = config.bundleProducts[bundleState.currentProductIndex];
    if (!currentProduct) {
      console.error('No current product found');
      return;
    }
    
    console.log('Initializing variant picker for product:', currentProduct.title);
    console.log('Product options:', currentProduct.options);
    console.log('Product variants:', currentProduct.variants);
    
    // Debug: Check if variants have correct structure
    if (currentProduct.variants && currentProduct.variants.length > 0) {
      console.log('First variant structure:', currentProduct.variants[0]);
      console.log('Variant options:', currentProduct.variants[0].options);
      
      // Debug all variants
      currentProduct.variants.forEach((variant, index) => {
        console.log(`Variant ${index}:`, {
          id: variant.id,
          title: variant.title,
          price: variant.price,
          options: variant.options,
          available: variant.available
        });
      });
    }
    
    // Use theme.js Variants class instead of custom logic
    const productSelect = container.querySelector(`#ProductSelect-bundle-${currentProduct.id}`);
    if (!productSelect) {
      console.error('ProductSelect not found');
      return;
    }
    
    // Initialize theme.js Variants class with correct parameters
    const variants = new theme.Variants({
      container: container,
      variants: currentProduct.variants,
      singleOptionSelector: '[data-variant-input]',
      originalSelectorId: `#ProductSelect-bundle-${currentProduct.id}`,
      originalSelectorIdSticky: `#ProductSelect-bundle-${currentProduct.id}-sticky`,
      enableHistoryState: false,
      dynamicVariantsEnabled: true
    });
    
    // Store variants instance for later use
    container.variantsInstance = variants;
    
    // Tự động chọn variant đầu tiên khi khởi tạo
    setTimeout(() => {
      console.log('=== AUTO-SELECTING FIRST VARIANT ===');
      
      // Tìm tất cả các option groups
      const optionGroups = container.querySelectorAll('.variant-wrapper');
      console.log('Found option groups:', optionGroups.length);
      
      optionGroups.forEach((optionGroup, groupIndex) => {
        // Check if this is a size option and we have a locked size
        const isSizeGroup = optionGroup.classList.contains('size') || 
                           optionGroup.querySelector('.variant__label')?.textContent.toLowerCase().includes('kích thước') ||
                           optionGroup.querySelector('.variant__label')?.textContent.toLowerCase().includes('size');
        
        if (isSizeGroup && bundleState.lockedSize && bundleState.currentProductIndex > 0) {
          // Auto-select the locked size for non-first products
          console.log(`🔒 Auto-selecting locked size: ${bundleState.lockedSize} for product ${bundleState.currentProductIndex + 1}`);
          
          const sizeInputs = optionGroup.querySelectorAll('[data-variant-input]');
          
          // Improved matching logic for size inputs
          const matchingInput = Array.from(sizeInputs).find(input => {
            const inputValue = input.value;
            
            // Direct match
            if (inputValue === bundleState.lockedSize) {
              return true;
            }
            
            // Extract dimensions from both sizes
            const extractDimensions = (sizeStr) => {
              const dimensions = sizeStr.match(/(\d+)\s*x\s*(\d+)/i);
              if (dimensions) {
                return {
                  width: parseInt(dimensions[1]),
                  height: parseInt(dimensions[2])
                };
              }
              return null;
            };
            
            const lockedDimensions = extractDimensions(bundleState.lockedSize);
            const inputDimensions = extractDimensions(inputValue);
            
            // If both have dimensions, compare them
            if (lockedDimensions && inputDimensions) {
              return lockedDimensions.width === inputDimensions.width && 
                     lockedDimensions.height === inputDimensions.height;
            }
            
            // Fallback: check if both contain same size keywords
            const sizeKeywords = ['single', 'full', 'queen', 'king', '150', '180', '200', '220', '250', '300'];
            const lockedHasKeyword = sizeKeywords.some(keyword => 
              bundleState.lockedSize.toLowerCase().includes(keyword)
            );
            const inputHasKeyword = sizeKeywords.some(keyword => 
              inputValue.toLowerCase().includes(keyword)
            );
            
            if (lockedHasKeyword && inputHasKeyword) {
              // Check if they share any size keyword
              return sizeKeywords.some(keyword => 
                bundleState.lockedSize.toLowerCase().includes(keyword) && 
                inputValue.toLowerCase().includes(keyword)
              );
            }
            
            return false;
          });
          
          if (matchingInput && !matchingInput.disabled) {
            console.log(`🔒 Found matching size input: ${matchingInput.value}`);
            matchingInput.checked = true;
            matchingInput.dispatchEvent(new Event('change', { bubbles: true }));
          } else {
            console.log(`⚠️ Locked size ${bundleState.lockedSize} not found or disabled, falling back to first available`);
            const firstInput = optionGroup.querySelector('[data-variant-input]:not([disabled])');
            if (firstInput) {
              firstInput.checked = true;
              firstInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        } else {
          // Tìm input đầu tiên trong mỗi group (default behavior)
          const firstInput = optionGroup.querySelector('[data-variant-input]');
          if (firstInput && !firstInput.disabled) {
            console.log(`Auto-selecting first input in group ${groupIndex}:`, firstInput.value);
            firstInput.checked = true;
            
            // Trigger change event để cập nhật variant
            firstInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }
      });
      
      console.log('✅ Auto-selection completed');
    }, 100); // Delay nhỏ để đảm bảo DOM đã sẵn sàng
    
    // Use event delegation for variant inputs (works with dynamically created elements)
    container.addEventListener('change', function(event) {
      if (event.target.hasAttribute('data-variant-input')) {
        console.log('=== VARIANT INPUT CHANGED ===');
        console.log('Input value:', event.target.value);
        console.log('Input name:', event.target.name);
        console.log('Input data-index:', event.target.dataset.index);
        
        // Get current product at the beginning to avoid reference error
        const currentProduct = config.bundleProducts[bundleState.currentProductIndex];
        console.log('Current product at start:', currentProduct);
        
        if (!currentProduct) {
          console.error('❌ No current product found for index:', bundleState.currentProductIndex);
          return;
        }
        
        // Get all selected options
        const selectedOptions = {};
        const checkedInputs = container.querySelectorAll('[data-variant-input]:checked');
        console.log('Total checked inputs:', checkedInputs.length);
        
        checkedInputs.forEach((input, index) => {
          console.log(`Checked input ${index}:`, {
            value: input.value,
            name: input.name,
            dataIndex: input.dataset.index,
            id: input.id
          });
          const optionIndex = parseInt(input.dataset.index.replace('option', '')) - 1;
          selectedOptions[optionIndex] = input.value;
          console.log('Selected option:', optionIndex, '=', input.value);
        });
        
        // Ensure at least one option is selected for each option group
        const allVariantInputs = container.querySelectorAll('[data-variant-input]');
        const optionGroups = {};
        
        // Group inputs by option
        allVariantInputs.forEach(input => {
          const optionIndex = parseInt(input.dataset.index.replace('option', '')) - 1;
          if (!optionGroups[optionIndex]) {
            optionGroups[optionIndex] = [];
          }
          optionGroups[optionIndex].push(input);
        });
        
        // For each option group, ensure at least one is selected
        Object.keys(optionGroups).forEach(optionIndex => {
          if (!selectedOptions[optionIndex]) {
            // Find the first checked input in this group, or the first available input
            const groupInputs = optionGroups[optionIndex];
            const checkedInput = groupInputs.find(input => input.checked);
            const firstAvailableInput = groupInputs.find(input => !input.disabled);
            
            const inputToUse = checkedInput || firstAvailableInput;
            if (inputToUse) {
              selectedOptions[optionIndex] = inputToUse.value;
              console.log('✅ Ensured option', optionIndex, '=', inputToUse.value);
            }
          }
        });
        
        console.log('Selected options:', selectedOptions);
        
        // Debug: Check all available inputs
        const debugInputs = container.querySelectorAll('[data-variant-input]');
        console.log('Total inputs available:', debugInputs.length);
        debugInputs.forEach((input, index) => {
          console.log(`Input ${index}:`, {
            value: input.value,
            name: input.name,
            dataIndex: input.dataset.index,
            checked: input.checked,
            id: input.id
          });
        });
        
        // Find matching variant - IMPROVED LOGIC
        console.log('=== VARIANT MATCHING DEBUG ===');
        console.log('Current product variants count:', currentProduct.variants.length);
        console.log('Selected options to match:', selectedOptions);
        console.log('Selected options keys:', Object.keys(selectedOptions));
        
        const matchingVariant = currentProduct.variants.find(variant => {
          console.log(`\n--- Checking variant: ${variant.title} ---`);
          console.log('Variant options:', variant.options);
          
          if (!variant.options) {
            console.log('❌ Variant has no options array');
            return false;
          }
          
          // Check if all selected options match this variant
          const matches = variant.options.every((option, index) => {
            const selectedOption = selectedOptions[index];
            const optionMatches = option === selectedOption;
            console.log(`  Option ${index}: variant="${option}" vs selected="${selectedOption}" = ${optionMatches}`);
            return optionMatches;
          });
          
          console.log(`Result for ${variant.title}:`, {
            variantOptions: variant.options,
            selectedOptions: selectedOptions,
            matches: matches
          });
          
          return matches;
        });
        
        console.log('Matching variant:', matchingVariant);
        
        // Fallback: If no matching variant found, use the first available variant
        let variantToUse = matchingVariant;
        if (!variantToUse) {
          console.log('❌ No matching variant found, using fallback...');
          console.log('Available variants:', currentProduct.variants.map(v => ({
            title: v.title,
            options: v.options
          })));
          
          // Try to find a variant that matches at least the first option (size)
          if (selectedOptions[0]) {
            variantToUse = currentProduct.variants.find(v => v.options && v.options[0] === selectedOptions[0]);
            console.log('Fallback variant found by size:', variantToUse ? variantToUse.title : 'none');
          }
          
          // If still no match, use the first available variant
          if (!variantToUse) {
            variantToUse = currentProduct.variants.find(v => v.available !== false) || currentProduct.variants[0];
            console.log('Using first available variant as final fallback:', variantToUse ? variantToUse.title : 'none');
          }
        }
        
        if (variantToUse) {
          console.log('✅ Using variant:', variantToUse.title);
          console.log('Variant price:', variantToUse.price);
          
          // Update product select
          const productSelect = container.querySelector(`#ProductSelect-bundle-${currentProduct.id}`);
          if (productSelect) {
            productSelect.value = variantToUse.id;
            productSelect.dispatchEvent(new Event('change'));
            console.log('✅ Updated product select to variant ID:', variantToUse.id);
          }
          
          // Check if price elements exist before updating
          const priceContainer = container.querySelector('.price-container-wrapper');
          console.log('Price container found:', !!priceContainer);
          if (priceContainer) {
            const mainPriceElement = priceContainer.querySelector('[data-product-price]');
            console.log('Main price element found:', !!mainPriceElement);
          }
          
          // Update price and labels
          console.log('=== UPDATING UI ===');
          console.log('Calling updateBundleProductPrice...');
          updateBundleProductPrice(variantToUse, container);
          console.log('Calling updateBundleVariantLabels...');
          updateBundleVariantLabels(variantToUse, container);
          console.log('UI update completed');
          
                  // Dispatch custom event
        container.dispatchEvent(new CustomEvent('variantChange', {
          detail: { variant: variantToUse }
        }));
        
        // Also update the bundle state immediately for this product
        console.log('=== BUNDLE STATE UPDATE DEBUG ===');
        console.log('currentProductIndex:', bundleState.currentProductIndex);
        console.log('currentProduct:', currentProduct);
        console.log('variantToUse:', variantToUse);
        
        if (currentProduct) {
          // Get variant image
          let variantImage = currentProduct.featured_image;
          if (variantToUse.featured_image) {
            variantImage = variantToUse.featured_image;
          } else if (currentProduct.media && currentProduct.media.length > 0) {
            const variantMedia = currentProduct.media.find(media => {
              const mediaAlt = (media.alt || '').toLowerCase();
              const mediaTitle = (media.title || '').toLowerCase();
              const variantTitle = variantToUse.title.toLowerCase();
              
              return mediaAlt.includes(variantTitle) || 
                     mediaTitle.includes(variantTitle) ||
                     variantToUse.options && variantToUse.options.some(option => {
                       const optionLower = option.toLowerCase();
                       return mediaAlt.includes(optionLower) || mediaTitle.includes(optionLower);
                     });
            });
            
            if (variantMedia) {
              variantImage = variantMedia.src;
            }
          }
          
          // Update bundle state immediately
          const existingIndex = bundleState.selectedProducts.bundle.findIndex(p => p.productId === currentProduct.id);
          if (existingIndex >= 0) {
            bundleState.selectedProducts.bundle[existingIndex].variantTitle = variantToUse.title;
            bundleState.selectedProducts.bundle[existingIndex].variantId = variantToUse.id;
            bundleState.selectedProducts.bundle[existingIndex].variantPrice = variantToUse.price;
            bundleState.selectedProducts.bundle[existingIndex].compareAtPrice = variantToUse.compare_at_price;
            bundleState.selectedProducts.bundle[existingIndex].variantOptions = variantToUse.options;
            bundleState.selectedProducts.bundle[existingIndex].image = extractImageUrl(variantImage);
            console.log('✅ Updated bundle state immediately for product:', currentProduct.title, 'variant:', variantToUse.title, 'image:', variantImage);
            console.log('✅ Bundle state updated:', bundleState.selectedProducts.bundle[existingIndex]);
            console.log('✅ Variant options saved:', variantToUse.options);
            console.log('✅ Variant options type:', typeof variantToUse.options);
            console.log('✅ Variant options is array:', Array.isArray(variantToUse.options));
            console.log('✅ Variant options length:', variantToUse.options ? variantToUse.options.length : 'undefined');
            
            // Check if this is the first product and has size variant
            if (bundleState.currentProductIndex === 0 && variantToUse.options && variantToUse.options.length > 0) {
              const firstOption = variantToUse.options[0];
              const isSizeOption = firstOption && (
                firstOption.toLowerCase().includes('single') || 
                firstOption.toLowerCase().includes('full') || 
                firstOption.toLowerCase().includes('queen') || 
                firstOption.toLowerCase().includes('king') ||
                firstOption.toLowerCase().includes('150') ||
                firstOption.toLowerCase().includes('180') ||
                firstOption.toLowerCase().includes('200') ||
                firstOption.toLowerCase().includes('220') ||
                firstOption.toLowerCase().includes('250') ||
                firstOption.toLowerCase().includes('300') ||
                firstOption.toLowerCase().includes('cm')
              );
              
              if (isSizeOption) {
                console.log('🎯 First product size selected:', firstOption);
                console.log('🔒 Locking size for all other products to:', firstOption);
                
                // Store the selected size for other products
                bundleState.lockedSize = firstOption;
                
                // Update all other products in bundle to use the same size
                bundleState.selectedProducts.bundle.forEach((product, index) => {
                  if (index > 0) { // Skip first product
                    const productData = config.bundleProducts.find(p => p.id === product.productId);
                    if (productData && productData.variants) {
                      // Find variant with matching size (improved logic)
                      const matchingVariant = productData.variants.find(variant => {
                        if (!variant.options || variant.options.length === 0) return false;
                        
                        const variantSize = variant.options[0];
                        
                        // Direct match
                        if (variantSize === firstOption) {
                          return true;
                        }
                        
                        // Extract dimensions from both sizes
                        const extractDimensions = (sizeStr) => {
                          const dimensions = sizeStr.match(/(\d+)\s*x\s*(\d+)/i);
                          if (dimensions) {
                            return {
                              width: parseInt(dimensions[1]),
                              height: parseInt(dimensions[2])
                            };
                          }
                          return null;
                        };
                        
                        const firstDimensions = extractDimensions(firstOption);
                        const variantDimensions = extractDimensions(variantSize);
                        
                        // If both have dimensions, compare them
                        if (firstDimensions && variantDimensions) {
                          return firstDimensions.width === variantDimensions.width && 
                                 firstDimensions.height === variantDimensions.height;
                        }
                        
                        // Fallback: check if both contain same size keywords
                        const sizeKeywords = ['single', 'full', 'queen', 'king', '150', '180', '200', '220', '250', '300'];
                        const firstHasKeyword = sizeKeywords.some(keyword => 
                          firstOption.toLowerCase().includes(keyword)
                        );
                        const variantHasKeyword = sizeKeywords.some(keyword => 
                          variantSize.toLowerCase().includes(keyword)
                        );
                        
                        if (firstHasKeyword && variantHasKeyword) {
                          // Check if they share any size keyword
                          return sizeKeywords.some(keyword => 
                            firstOption.toLowerCase().includes(keyword) && 
                            variantSize.toLowerCase().includes(keyword)
                          );
                        }
                        
                        return false;
                      });
                      
                      if (matchingVariant) {
                        console.log(`🔒 Auto-updating product ${index + 1} (${product.productTitle}) to size: ${firstOption}`);
                        product.variantId = matchingVariant.id;
                        product.variantTitle = matchingVariant.title;
                        product.variantPrice = matchingVariant.price;
                        product.compareAtPrice = matchingVariant.compare_at_price;
                        product.variantOptions = matchingVariant.options;
                      }
                    }
                  }
                });
              }
            }
            
            // If we have a locked size and this is not the first product, disable other size options
            if (bundleState.lockedSize && bundleState.currentProductIndex > 0) {
              const sizeInputs = container.querySelectorAll('.variant-wrapper.size [data-variant-input]');
              sizeInputs.forEach(input => {
                const inputValue = input.value;
                
                // Check if this input matches the locked size (using improved logic)
                const isMatchingSize = (() => {
                  // Direct match
                  if (inputValue === bundleState.lockedSize) {
                    return true;
                  }
                  
                  // Extract dimensions from both sizes
                  const extractDimensions = (sizeStr) => {
                    const dimensions = sizeStr.match(/(\d+)\s*x\s*(\d+)/i);
                    if (dimensions) {
                      return {
                        width: parseInt(dimensions[1]),
                        height: parseInt(dimensions[2])
                      };
                    }
                    return null;
                  };
                  
                  const lockedDimensions = extractDimensions(bundleState.lockedSize);
                  const inputDimensions = extractDimensions(inputValue);
                  
                  // If both have dimensions, compare them
                  if (lockedDimensions && inputDimensions) {
                    return lockedDimensions.width === inputDimensions.width && 
                           lockedDimensions.height === inputDimensions.height;
                  }
                  
                  // Fallback: check if both contain same size keywords
                  const sizeKeywords = ['single', 'full', 'queen', 'king', '150', '180', '200', '220', '250', '300'];
                  const lockedHasKeyword = sizeKeywords.some(keyword => 
                    bundleState.lockedSize.toLowerCase().includes(keyword)
                  );
                  const inputHasKeyword = sizeKeywords.some(keyword => 
                    inputValue.toLowerCase().includes(keyword)
                  );
                  
                  if (lockedHasKeyword && inputHasKeyword) {
                    // Check if they share any size keyword
                    return sizeKeywords.some(keyword => 
                      bundleState.lockedSize.toLowerCase().includes(keyword) && 
                      inputValue.toLowerCase().includes(keyword)
                    );
                  }
                  
                  return false;
                })();
                
                if (!isMatchingSize) {
                  input.disabled = true;
                  input.closest('.variant__button-label')?.classList.add('disabled');
                  console.log(`🔒 Disabled size option: ${input.value}`);
                } else {
                  input.disabled = false;
                  input.closest('.variant__button-label')?.classList.remove('disabled');
                  console.log(`🔒 Enabled matching size option: ${input.value}`);
                }
              });
            }
          } else {
            // Add new product to bundle state
            const newProduct = {
              productId: currentProduct.id,
              productHandle: currentProduct.handle,
              productTitle: currentProduct.title,
              image: variantImage,
              variantId: variantToUse.id,
              variantTitle: variantToUse.title,
              variantPrice: variantToUse.price,
              compareAtPrice: variantToUse.compare_at_price,
              variantOptions: variantToUse.options,
              quantity: 1
            };
            bundleState.selectedProducts.bundle.push(newProduct);
            console.log('✅ Added new product to bundle state:', newProduct);
            console.log('✅ Variant options saved:', variantToUse.options);
            console.log('✅ Variant options type:', typeof variantToUse.options);
            console.log('✅ Variant options is array:', Array.isArray(variantToUse.options));
            console.log('✅ Variant options length:', variantToUse.options ? variantToUse.options.length : 'undefined');
          }
        }
        } else {
          console.log('❌ No matching variant found for options:', selectedOptions);
          console.log('Available variants:', currentProduct.variants.map(v => ({
            title: v.title,
            options: v.options
          })));
        }
      }
    });
    
    // Listen to variant change events
    container.addEventListener('variantChange', function(evt) {
      console.log('Variant change event:', evt.detail);
      const variant = evt.detail.variant;
      
      if (variant) {
        updateBundleProductPrice(variant, container);
        updateBundleVariantLabels(variant, container);
      }
    });
    
    console.log('✅ Variant picker initialized successfully');
  }

  function updateBundleVariantLabels(variant, container) {
    console.log('=== UPDATE VARIANT LABELS ===');
    console.log('Function called with variant:', variant);
    console.log('Container:', container);
    console.log('Updating variant labels for variant:', variant.title);
    console.log('Variant options:', variant.options);
    
    // Find all variant__label-info elements with data-index attribute
    console.log('Container selector:', container);
    console.log('Container classList:', container.classList);
    console.log('Container children count:', container.children.length);
    
    const variantLabels = container.querySelectorAll('.variant__label-info[data-index]');
    console.log('Found variant labels with data-index:', variantLabels.length);
    
    // Also check for any variant__label-info elements
    const allVariantLabelInfo = container.querySelectorAll('.variant__label-info');
    console.log('Total variant__label-info elements found:', allVariantLabelInfo.length);
    
    // Also check for all variant__label-info elements
    const allLabelInfoElements = container.querySelectorAll('.variant__label-info');
    console.log('Total variant__label-info elements found:', allLabelInfoElements.length);
    
    // Debug: Log all variant__label-info elements
    allLabelInfoElements.forEach((labelInfo, index) => {
      console.log(`Label info ${index}:`, {
        innerHTML: labelInfo.innerHTML,
        textContent: labelInfo.textContent,
        className: labelInfo.className,
        children: labelInfo.children.length
      });
    });
    
    // Debug: Log all variant labels found
    variantLabels.forEach((label, index) => {
      console.log(`Variant label ${index}:`, {
        textContent: label.textContent,
        dataIndex: label.getAttribute('data-index'),
        className: label.className,
        id: label.id
      });
    });
    
    // Update labels based on data-index attribute
    variantLabels.forEach((label, index) => {
      const optionIndex = parseInt(label.getAttribute('data-index'));
      console.log(`Label ${index}: optionIndex = ${optionIndex}`);
      
      if (!isNaN(optionIndex) && variant.options && variant.options[optionIndex]) {
        const newText = variant.options[optionIndex];
        // Update the inner span with data-variant-selected-label
        const innerSpan = label.querySelector(' [data-variant-selected-label]');
        if (innerSpan) {
          innerSpan.textContent = newText;
          console.log('✅ Updated label index', optionIndex, 'from', innerSpan.getAttribute('data-original-text') || 'unknown', 'to:', newText);
        } else {
          // Fallback: update the container's text content
          label.textContent = newText;
          console.log('✅ Updated label container index', optionIndex, 'to:', newText);
        }
      }
    });
    
    // Update specific color and size labels if they exist
    const colorLabel = container.querySelector('[data-variant-color-label]');
    const sizeLabel = container.querySelector('[data-variant-selected-label]');
    
    console.log('Color label found:', !!colorLabel);
    console.log('Size label found:', !!sizeLabel);
    
    if (colorLabel && variant.options && variant.options[1]) {
      colorLabel.textContent = variant.options[1];
      console.log('✅ Updated color label to:', variant.options[1]);
    }
    
    if (sizeLabel && variant.options && variant.options[0]) {
      sizeLabel.textContent = variant.options[0];
      console.log('✅ Updated size label to:', variant.options[0]);
    }
    
    // Update all variant__label-info containers that have data-index
    const labelInfoContainers = container.querySelectorAll('.variant__label-info[data-index]');
    console.log('Found label info containers with data-index:', labelInfoContainers.length);
    
    labelInfoContainers.forEach((container, index) => {
      const optionIndex = parseInt(container.getAttribute('data-index'));
      console.log(`Container ${index}: optionIndex = ${optionIndex}`);
      
      if (!isNaN(optionIndex) && variant.options && variant.options[optionIndex]) {
        // Update the first span or text content
        const firstSpan = container.querySelector('span');
        if (firstSpan) {
          firstSpan.textContent = variant.options[optionIndex];
          console.log('✅ Updated label info container', index, 'to:', variant.options[optionIndex]);
        } else {
          // If no span, update the container's text content
          container.textContent = variant.options[optionIndex];
          console.log('✅ Updated label info container text', index, 'to:', variant.options[optionIndex]);
        }
      }
    });
    
    // Also update any variant__label-info that doesn't have data-index but contains spans
    const allLabelInfoSpans = container.querySelectorAll('.variant__label-info');
    console.log('Total variant__label-info found:', allLabelInfoSpans.length);
    
    allLabelInfoSpans.forEach((labelInfo, index) => {
      const spans = labelInfo.querySelectorAll('span');
      console.log(`Label info ${index} has ${spans.length} spans`);
      
      spans.forEach((span, spanIndex) => {
        const dataIndex = span.getAttribute('data-index');
        if (dataIndex) {
          const optionIndex = parseInt(dataIndex);
          if (!isNaN(optionIndex) && variant.options && variant.options[optionIndex]) {
            span.textContent = variant.options[optionIndex];
            console.log(`✅ Updated span ${spanIndex} in label info ${index} to:`, variant.options[optionIndex]);
          }
        }
      });
    });
    
    // Force update all variant__label-info text content based on variant title
    if (variantLabels.length === 0) {
      console.log('⚠️ No variant labels with data-index found, trying alternative approach...');
      
      // Try to update based on variant title
      allLabelInfoElements.forEach((labelInfo, index) => {
        const currentText = labelInfo.textContent.trim();
        console.log(`Label info ${index} current text: "${currentText}"`);
        
        // If this looks like a size option, update with the first option
        if (currentText.includes('Kích thước') || currentText.includes('Size')) {
          if (variant.options && variant.options[0]) {
            labelInfo.textContent = variant.options[0];
            console.log(`✅ Force updated size label to: ${variant.options[0]}`);
          }
        }
        // If this looks like a color option, update with the second option
        else if (currentText.includes('Màu') || currentText.includes('Color')) {
          if (variant.options && variant.options[1]) {
            labelInfo.textContent = variant.options[1];
            console.log(`✅ Force updated color label to: ${variant.options[1]}`);
          }
        }
        // Otherwise, try to update with the full variant title
        else {
          labelInfo.textContent = variant.title;
          console.log(`✅ Force updated label to variant title: ${variant.title}`);
        }
      });
    }
    
    // Update color swatch visual state
    updateColorSwatchState(variant, container);
  }

  function updateBundleProductPrice(variant, container) {
    console.log('=== UPDATE PRODUCT PRICE ===');
    console.log('Updating product price for variant:', variant.title);
    console.log('Variant price:', variant.price, 'Compare price:', variant.compare_at_price);
    
    // Update price elements
    const priceContainer = container.querySelector('.price-container-wrapper');
    console.log('Price container found:', !!priceContainer);
    
    if (priceContainer) {
      // Update main price
      const mainPriceElement = priceContainer.querySelector('[data-product-price]');
      console.log('Main price element found:', !!mainPriceElement);
      console.log('Main price element before update:', mainPriceElement ? mainPriceElement.textContent : 'not found');
      
      if (mainPriceElement) {
        const formattedPrice = formatMoney(variant.price);
        mainPriceElement.textContent = formattedPrice;
        console.log('✅ Updated main price from', mainPriceElement.getAttribute('data-product-price-base'), 'to:', formattedPrice);
        console.log('✅ Main price element after update:', mainPriceElement.textContent);
      }
      
      // Update compare price
      const comparePriceElement = priceContainer.querySelector('[data-compare-price]');
      console.log('Compare price element found:', !!comparePriceElement);
      console.log('Compare price element before update:', comparePriceElement ? comparePriceElement.textContent : 'not found');
      
      if (comparePriceElement) {
        if (variant.compare_at_price) {
          const formattedComparePrice = formatMoney(variant.compare_at_price);
          comparePriceElement.textContent = formattedComparePrice;
          comparePriceElement.style.display = 'inline';
          console.log('✅ Updated compare price to:', formattedComparePrice);
          console.log('✅ Compare price element after update:', comparePriceElement.textContent);
        } else {
          comparePriceElement.style.display = 'none';
          console.log('✅ Hiding compare price');
        }
      }
      
      // Update discount badge
      const discountBadge = priceContainer.querySelector('.product__discount-badge');
      console.log('Discount badge found:', !!discountBadge);
      console.log('Discount badge before update:', discountBadge ? discountBadge.textContent : 'not found');
      
      if (discountBadge) {
        if (variant.compare_at_price) {
          const discountPercent = Math.round((variant.compare_at_price - variant.price) / variant.compare_at_price * 100);
          discountBadge.textContent = `-${discountPercent}%`;
          discountBadge.style.display = 'inline';
          console.log('✅ Updated discount badge to:', `-${discountPercent}%`);
          console.log('✅ Discount badge after update:', discountBadge.textContent);
        } else {
          discountBadge.style.display = 'none';
          console.log('✅ Hiding discount badge');
        }
      }
    }
    
    // Update installment price
    const installmentPrice = container.querySelector('[data-installment-price]');
    if (installmentPrice) {
      const installmentAmount = Math.round(variant.price / 12);
      installmentPrice.textContent = formatMoney(installmentAmount);
      console.log('✅ Updated installment price to:', formatMoney(installmentAmount));
    }
    
    console.log('✅ Price update completed');
    
    // Update product image if variant has different image
    updateBundleProductImage(variant, container);
  }

  function updateBundleProductImage(variant, container) {
    console.log('=== UPDATE PRODUCT IMAGE ===');
    console.log('Updating product image for variant:', variant.title);
    
    const currentProduct = config.bundleProducts[bundleState.currentProductIndex];
    if (!currentProduct) return;
    
    // Get variant image if available
    let variantImage = currentProduct.featured_image;
    if (variant.featured_image) {
      variantImage = variant.featured_image;
    } else if (currentProduct.media && currentProduct.media.length > 0) {
      // Try to find media that matches the variant by checking multiple criteria
      const variantMedia = currentProduct.media.find(media => {
        const mediaAlt = (media.alt || '').toLowerCase();
        const mediaTitle = (media.title || '').toLowerCase();
        const variantTitle = variant.title.toLowerCase();
        
        // Check if media alt text or title contains variant info
        return mediaAlt.includes(variantTitle) || 
               mediaTitle.includes(variantTitle) ||
               // Also check for color names in variant title
               variant.options && variant.options.some(option => {
                 const optionLower = option.toLowerCase();
                 return mediaAlt.includes(optionLower) || mediaTitle.includes(optionLower);
               });
      });
      
      if (variantMedia) {
        variantImage = variantMedia.src;
      }
    }
    
    console.log('Selected variant image for', variant.title, ':', variantImage);
    
    // Update main product image
    const mainImage = container.querySelector('.product-main-slide img');
    if (mainImage && variantImage !== mainImage.src) {
      mainImage.src = variantImage;
      mainImage.alt = currentProduct.title + ' - ' + variant.title;
      console.log('✅ Updated main product image to:', variantImage);
    }
    
    // Update thumbnails if they exist
    const thumbnails = container.querySelectorAll('.product__thumb img');
    thumbnails.forEach((thumb, index) => {
      if (index === 0) { // First thumbnail should match main image
        thumb.src = variantImage;
        thumb.alt = currentProduct.title + ' - ' + variant.title;
      }
    });
  }

  function updateColorSwatchState(variant, container) {
    console.log('=== UPDATE COLOR SWATCH STATE ===');
    console.log('Updating color swatch state for variant:', variant.title);
    
    // Remove active state from all color swatches
    const allColorSwatches = container.querySelectorAll('.color-swatch');
    allColorSwatches.forEach(swatch => {
      swatch.classList.remove('active', 'selected');
    });
    
    // Add active state to the selected color swatch
    if (variant.options && variant.options[1]) { // Assuming option2 is color
      // Try multiple selectors to find the color swatch
      let selectedColorSwatch = container.querySelector(`.color-swatch[for*="${variant.options[1].replace(/\s+/g, '-')}"]`);
      
      if (!selectedColorSwatch) {
        // Try finding by data-color-name attribute
        const colorInput = container.querySelector(`[data-variant-input][data-color-name="${variant.options[1]}"]`);
        if (colorInput) {
          selectedColorSwatch = container.querySelector(`label[for="${colorInput.id}"]`);
        }
      }
      
      if (selectedColorSwatch) {
        selectedColorSwatch.classList.add('active', 'selected');
        console.log('✅ Updated color swatch state for:', variant.options[1]);
      } else {
        console.log('❌ Could not find color swatch for:', variant.options[1]);
        console.log('Available color swatches:', container.querySelectorAll('.color-swatch').length);
        console.log('Available color inputs:', container.querySelectorAll('[data-variant-input][data-color-name]').length);
      }
    }
    
    // Also update the input state
    const colorInputs = container.querySelectorAll('[data-variant-input][data-color-name]');
    colorInputs.forEach(input => {
      if (input.value === variant.options[1]) {
        input.checked = true;
        console.log('✅ Updated color input state for:', variant.options[1]);
      } else {
        input.checked = false;
      }
    });
  }



  function renderIconWithText(settings) {
    if (!config.iconWithTextSettings) {
              // Fallback to default icons if no settings
        return `
          <div class="product-block">
            <div class="icon-with-text">
              <div class="icon-with-text__grid">
                <div class="icon-with-text__item">
                  <div class="icon-with-text__icon">
                    <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    </svg>
                  </div>
                  <div class="icon-with-text__content">
                    <h3 class="icon-with-text__heading">Miễn phí vận chuyển *</h3>
                  </div>
                </div>
                
                <div class="icon-with-text__item">
                  <div class="icon-with-text__icon">
                    <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="icon-with-text__content">
                    <h3 class="icon-with-text__heading">Bảo hành dài lâu</h3>
                  </div>
                </div>
                
                <div class="icon-with-text__item">
                  <div class="icon-with-text__icon">
                    <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M8 5V3a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="icon-with-text__content">
                    <h3 class="icon-with-text__heading">Chất liệu Foam cao cấp</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
    }

    const iconSettings = config.iconWithTextSettings;
    const iconSize = iconSettings.icon_size || 25;
    const alignment = iconSettings.icon_alignment || 'center';
    const gridColumns = iconSettings.grid_columns || "2";
    const showIcon4 = iconSettings.show_icon_4 !== false; // Default to true
    
    let iconItems = [];
    
    // Icon 1
    if (iconSettings.icon_1_image || iconSettings.icon_1_heading) {
      const icon1Html = `
        <div class="icon-with-text__item">
          <div class="icon-with-text__icon">
            ${iconSettings.icon_1_image ? 
              `<img src="${iconSettings.icon_1_image}" 
                   alt="${iconSettings.icon_1_heading || 'Icon 1'}"
                   width="${iconSize}"
                   height="${iconSize}"
                   style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">` :
              `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
              </svg>`
            }
          </div>
          <div class="icon-with-text__content">
            <h3 class="icon-with-text__heading">${iconSettings.icon_1_heading || '100 đêm ngủ thử'}</h3>
          </div>
        </div>
      `;
      iconItems.push(icon1Html);
    }
    
    // Icon 2
    if (iconSettings.icon_2_image || iconSettings.icon_2_heading) {
      const icon2Html = `
        <div class="icon-with-text__item">
          <div class="icon-with-text__icon">
            ${iconSettings.icon_2_image ? 
              `<img src="${iconSettings.icon_2_image}" 
                   alt="${iconSettings.icon_2_heading || 'Icon 2'}"
                   width="${iconSize}"
                   height="${iconSize}"
                   style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">` :
              `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 5V3a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`
            }
          </div>
          <div class="icon-with-text__content">
            <h3 class="icon-with-text__heading">${iconSettings.icon_2_heading || 'Miễn phí vận chuyển *'}</h3>
          </div>
        </div>
      `;
      iconItems.push(icon2Html);
    }
    
    // Icon 3
    if (iconSettings.icon_3_image || iconSettings.icon_3_heading) {
      const icon3Html = `
        <div class="icon-with-text__item">
          <div class="icon-with-text__icon">
            ${iconSettings.icon_3_image ? 
              `<img src="${iconSettings.icon_3_image}" 
                   alt="${iconSettings.icon_3_heading || 'Icon 3'}"
                   width="${iconSize}"
                   height="${iconSize}"
                   style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">` :
              `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`
            }
          </div>
          <div class="icon-with-text__content">
            <h3 class="icon-with-text__heading">${iconSettings.icon_3_heading || 'Bảo hành dài lâu'}</h3>
          </div>
        </div>
      `;
      iconItems.push(icon3Html);
    }
    
    // Icon 4
    if (showIcon4 && (iconSettings.icon_4_image || iconSettings.icon_4_heading)) {
      const icon4Html = `
        <div class="icon-with-text__item">
          <div class="icon-with-text__icon">
            ${iconSettings.icon_4_image ? 
              `<img src="${iconSettings.icon_4_image}" 
                   alt="${iconSettings.icon_4_heading || 'Icon 4'}"
                   width="${iconSize}"
                   height="${iconSize}"
                   style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">` :
              `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 5V3a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`
            }
          </div>
          <div class="icon-with-text__content">
            <h3 class="icon-with-text__heading">${iconSettings.icon_4_heading || 'Chất liệu Foam cao cấp'}</h3>
          </div>
        </div>
      `;
      iconItems.push(icon4Html);
    }
    
    return `
      <div class="product-block">
        <div class="icon-with-text">
          <div class="icon-with-text__grid" style="text-align: ${alignment};" data-columns="${gridColumns}">
            ${iconItems.join('')}
          </div>
        </div>
      </div>
    `;
  }

  function formatMoney(cents) {
    // Shopify returns price in cents, so we need to divide by 100
    const amount = cents / 100;
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
      minimumFractionDigits: 0
    }).format(amount);
  }

});

// Carousel Navigation
document.addEventListener('DOMContentLoaded', function() {
  const carousels = document.querySelectorAll('[data-slideshow]');
  
  carousels.forEach(carousel => {
    const items = carousel.querySelectorAll('.carousel-item');
    const prevBtn = carousel.querySelector('.carousel-nav--prev');
    const nextBtn = carousel.querySelector('.carousel-nav--next');
    let currentIndex = 0;
    
    if (items.length <= 1) {
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
      return;
    }
    
    function showSlide(index) {
      items.forEach((item, i) => {
        item.style.display = i === index ? 'block' : 'none';
      });
      
      // Update navigation buttons
      if (prevBtn) prevBtn.disabled = index === 0;
      if (nextBtn) nextBtn.disabled = index === items.length - 1;
    }
    
    function nextSlide() {
      currentIndex = (currentIndex + 1) % items.length;
      showSlide(currentIndex);
    }
    
    function prevSlide() {
      currentIndex = (currentIndex - 1 + items.length) % items.length;
      showSlide(currentIndex);
    }
    
    if (prevBtn) {
      prevBtn.addEventListener('click', prevSlide);
    }
    
    if (nextBtn) {
      nextBtn.addEventListener('click', nextSlide);
    }
    
    // Initialize
    showSlide(0);
  });
});
</script>

<!-- Carousel Modal Dialogs -->
{%- for block in section.blocks -%}
  {%- if block.type == 'carousel_modal' -%}
    <modal-dialog
      id="PopupModal-{{ block.id }}"
      class="product-popup-modal popup-modal fixed top-0 left-0 w-full h-full m-auto"
      {{ block.shopify_attributes }}
    >
      <div
        role="dialog"
        aria-label="Dialog Modal"
        aria-modal="true"
        class="product-popup-modal__content popup-modal__content absolute w-full h-auto m-auto"
        tabindex="-1"
      >
        <div class="product-popup-modal__content-info relative mx-auto popup-modal__content-info">
          <button
            id="ModalClose-{{ block.id }}"
            type="button"
            class="product-popup-modal__toggle popup-modal__toggle block border-none rounded-circle absolute z-index-3 button--close"
            aria-label="{{ 'general.accessibility.close' | t }}"
          >
            <span class="i__close e-none block relative color-current w-full h-full"></span>
          </button>
          <div class="product-popup-modal__carousel" data-slideshow id="ModalCarousel-{{ block.id }}">
            {% for index in (1..4) %}
              {%- capture description_index -%}description_{{ index }}{%- endcapture -%}
              {%- capture image_index -%}picture_{{ index }}{%- endcapture -%}
              {%- capture title_index -%}title_{{ index }}{%- endcapture -%}
              {% liquid
                assign desc = product.metafields.custom.product_features.value[description_index].value
                assign img = product.metafields.custom.product_features.value[image_index].value
                assign title = product.metafields.custom.product_features.value[title_index].value
              %}
              {%- if img != blank and title != blank -%}
                <div class="carousel-item">
                  <div class="carousel-item--inner flex gap-x">
                    {%- if img != blank -%}
                      <div class="carousel-item--image shrink-0">
                        {% render 'image-element',
                          img: img,
                          classes: 'rounded-sm-large',
                          img_width: 450,
                          img_height: 450,
                          sizes: '450px'
                        %}
                      </div>
                    {%- endif -%}
                    <div class="carousel-item--content">
                      {%- if title != blank -%}
                        <div class="carousel-item--title text-lg f-bold">{{ title }}</div>
                      {%- endif -%}
                      {%- if desc != blank -%}
                        <div class="carousel-item--desc text-sm">{{ desc }}</div>
                      {%- endif -%}
                    </div>
                  </div>
                </div>
              {%- endif -%}
            {% endfor %}
            
            <!-- Carousel Navigation -->
            <div class="carousel-navigation">
              <button class="carousel-nav carousel-nav--prev" aria-label="Previous slide">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button class="carousel-nav carousel-nav--next" aria-label="Next slide">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </modal-dialog>
  {%- endif -%}
{%- endfor -%}

<script>
/**
 * Advanced Sticky Column Logic ("Koala" style)
 * This script dynamically makes the shorter of the two product columns sticky.
 */
function initAdvancedSticky(productSection) {
  if (!productSection) return;

  const gridContainer = productSection.querySelector('.grid');
  const imageColumn = productSection.querySelector('.product-grid__images');
  const infoColumn = productSection.querySelector('.product-grid__info');
  const infoColumnInner = infoColumn ? infoColumn.querySelector('.product-info-inner') : null;
  const imageColumnInner = imageColumn ? imageColumn.querySelector('.product-column-content') : null;
  const interactiveElements = productSection.querySelectorAll('details.product-accordion, .size-guide-text-trigger');

  if (!gridContainer || !imageColumn || !infoColumn || !infoColumnInner || !imageColumnInner) {
    return;
  }

  let scrollHandler = () => {};
  
  const setupStickyColumns = () => {
    // Clean up styles from previous calculations before re-running
    window.removeEventListener('scroll', scrollHandler);
    imageColumnInner.style.cssText = '';
    infoColumnInner.style.cssText = '';
    imageColumn.style.height = '';
    infoColumn.style.height = '';
    imageColumn.style.position = '';
    infoColumn.style.position = '';

    // This logic is for desktop viewports only
    if (window.innerWidth < 991) {
      return;
    }

    requestAnimationFrame(() => {
        // Measure the inner content elements, not the grid containers which are equal height.
        const imageColHeight = imageColumnInner.offsetHeight;
        const infoColHeight = infoColumnInner.offsetHeight;
        
        // Store original widths to maintain consistent sizing during sticky states
        let imageColOriginalWidth = imageColumnInner.offsetWidth;
        const infoColOriginalWidth = infoColumnInner.offsetWidth;
        
        // LOCK THE WIDTHS FOREVER - This prevents any sizing changes during sticky scrolling
        console.log('🔒 Locking image column width at:', imageColOriginalWidth);
        console.log('🔒 Locking info column width at:', infoColOriginalWidth);
        
        // Lock the image column width immediately
        imageColumn.style.width = `${imageColOriginalWidth}px`;
        imageColumn.style.maxWidth = `${imageColOriginalWidth}px`;
        imageColumn.style.minWidth = `${imageColOriginalWidth}px`;
        imageColumn.style.flexShrink = '0';
        imageColumn.style.flexGrow = '0';
        
        // Lock the info column width immediately  
        infoColumn.style.width = `${infoColOriginalWidth}px`;
        infoColumn.style.maxWidth = `${infoColOriginalWidth}px`;
        infoColumn.style.minWidth = `${infoColOriginalWidth}px`;
        infoColumn.style.flexShrink = '0';
        infoColumn.style.flexGrow = '0';
        
        // LOCK THE PHOTOS CONTAINER WIDTH - This is the key fix!
        const photosContainer = imageColumnInner.querySelector('.product__photos');
        if (photosContainer) {
          const photosWidth = photosContainer.offsetWidth;
          console.log('🔒 Locking photos container width at:', photosWidth);
          photosContainer.style.width = `${photosWidth}px`;
          photosContainer.style.maxWidth = `${photosWidth}px`;
          photosContainer.style.minWidth = `${photosWidth}px`;
          photosContainer.style.flexShrink = '0';
          photosContainer.style.flexGrow = '0';
        }
        
        // LOCK THE SLIDESHOW CONTAINER WIDTH
        const slideshowContainer = imageColumnInner.querySelector('.product-slideshow');
        if (slideshowContainer) {
          const slideshowWidth = slideshowContainer.offsetWidth;
          console.log('🔒 Locking slideshow container width at:', slideshowWidth);
          slideshowContainer.style.width = `${slideshowWidth}px`;
          slideshowContainer.style.maxWidth = `${slideshowWidth}px`;
          slideshowContainer.style.minWidth = `${slideshowWidth}px`;
          slideshowContainer.style.flexShrink = '0';
          slideshowContainer.style.flexGrow = '0';
        }
        
        // LOCK THE MAIN PHOTOS CONTAINER WIDTH
        const mainPhotosContainer = imageColumnInner.querySelector('.product__main-photos');
        if (mainPhotosContainer) {
          const mainPhotosWidth = mainPhotosContainer.offsetWidth;
          console.log('🔒 Locking main photos container width at:', mainPhotosWidth);
          mainPhotosContainer.style.width = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.maxWidth = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.minWidth = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.flexShrink = '0';
          mainPhotosContainer.style.flexGrow = '0';
        }
        
        // For carousel, get the actual rendered width from CSS computed styles
        const carouselContainer = imageColumnInner.querySelector('.product__photos--below') || 
                                 imageColumnInner.querySelector('.product-slideshow');
        if (carouselContainer) {
          // Get computed style to see the actual rendered width
          const computedStyle = window.getComputedStyle(carouselContainer);
          const computedWidth = parseFloat(computedStyle.width);
          
          // Debug: log the widths to console
          console.log('Carousel debug:', {
            offsetWidth: imageColumnInner.offsetWidth,
            computedWidth: computedWidth,
            carouselContainer: carouselContainer
          });
          
          // Use the actual computed width - this respects the responsive CSS max-width
          if (computedWidth && computedWidth > 0) {
            imageColOriginalWidth = computedWidth; // This already respects min(765px, 50vw)
            console.log('Using responsive carousel width:', computedWidth);
          } else {
            // Fallback: try to get width from the main image
            const mainImage = carouselContainer.querySelector('.product-main-slide img') || 
                             carouselContainer.querySelector('.product__photo img');
            if (mainImage) {
              const imageWidth = mainImage.naturalWidth || mainImage.offsetWidth;
              imageColOriginalWidth = Math.min(imageWidth, 765); // Apply reasonable max
            } else {
              // Last fallback: use container width with reasonable max
              imageColOriginalWidth = Math.min(imageColOriginalWidth, 765);
            }
          }
        }
            
        // Exit if columns are of similar height, as no sticky effect is needed.
        if (Math.abs(imageColHeight - infoColHeight) < 100) {
            return;
        }

        const shortCol = imageColHeight > infoColHeight ? infoColumn : imageColumn;
        const shortColInner = imageColHeight > infoColHeight ? infoColumnInner : imageColumnInner;
        const shortColOriginalWidth = imageColHeight > infoColHeight ? infoColOriginalWidth : imageColOriginalWidth;
        
        // **FIX**: Set position relative on the container of the element that will be docked.
        // This makes it the positioning context for its absolutely positioned child.
        shortCol.style.position = 'relative';
        // Set an explicit height on the short column's container to prevent the grid from collapsing
        // when its inner element is taken out of the document flow with `position: fixed`.
        shortCol.style.height = `${shortCol.offsetHeight}px`;

        const headerOffset = 120; // Adjust if your sticky header's height changes

        scrollHandler = () => {
            const scrollY = window.scrollY;
            const gridRect = gridContainer.getBoundingClientRect();
            const shortColInnerHeight = shortColInner.offsetHeight;
            const gridAbsoluteTop = gridRect.top + scrollY;
            const startPoint = gridAbsoluteTop - headerOffset;
            const stopPoint = gridAbsoluteTop + gridRect.height - shortColInnerHeight - headerOffset;
            const buffer = 2; // A small buffer to prevent jittering at the thresholds
            
            if (scrollY > startPoint + buffer && scrollY < stopPoint - buffer) {
                // State 1: STICKY. The element is fixed relative to the viewport.
                shortColInner.style.position = 'fixed';
                shortColInner.style.top = `${headerOffset}px`;
                shortColInner.style.bottom = 'auto';
                // Use the locked width - no calculations needed
                shortColInner.style.width = `${shortColOriginalWidth}px`;
                shortColInner.style.maxWidth = `${shortColOriginalWidth}px`;
            } else if (scrollY >= stopPoint - buffer) {
                // State 2: DOCKED. The element is positioned absolutely to the bottom of its parent container.
                shortColInner.style.position = 'absolute';
                shortColInner.style.top = 'auto';
                shortColInner.style.bottom = '0px';
                // Use the locked width - no calculations needed
                shortColInner.style.width = `${shortColOriginalWidth}px`;
                shortColInner.style.maxWidth = `${shortColOriginalWidth}px`;
            } else {
                // State 3: DEFAULT. The element is in its normal static position.
                shortColInner.style.position = '';
                shortColInner.style.top = '';
                shortColInner.style.bottom = '';
                shortColInner.style.width = '';
            }
        };
        
        window.addEventListener('scroll', scrollHandler, { passive: true });
        scrollHandler(); // Run once immediately on setup to get the initial state right
    });
  };
  
  const debounce = (func, delay) => {
      let timeout;
      return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
      };
  };

  const debouncedSetup = debounce(setupStickyColumns, 250);

  // --- Event Listeners ---

  // Run on initial load when all assets are ready
  window.addEventListener('load', debouncedSetup);
  // A fallback for DOMContentLoaded in case `load` is slow, e.g., with deferred scripts
  document.addEventListener('DOMContentLoaded', () => setTimeout(debouncedSetup, 500));
  
  // Re-run when the browser is resized
  window.addEventListener('resize', debouncedSetup);

  // Re-run whenever an interactive element (accordion/dropdown) is toggled
  interactiveElements.forEach(el => {
    const eventName = el.tagName.toLowerCase() === 'details' ? 'toggle' : 'click';
    el.addEventListener(eventName, debouncedSetup);
  });
}

// Initialize the script for the current section
const currentProductSection = document.querySelector('#ProductSection-{{ section.id }}-{{ product.id }}');
if (currentProductSection) {
  initAdvancedSticky(currentProductSection);
}

// Re-initialize if the section is reloaded by the theme editor
document.addEventListener('shopify:section:load', function(event) {
  if (event.detail.sectionId === '{{ section.id }}') {
    const reloadedSection = document.querySelector('#ProductSection-{{ section.id }}-{{ product.id }}');
    if (reloadedSection) {
      initAdvancedSticky(reloadedSection);
    }
  }
});

/**
 * Advanced Sticky Column Logic for Bundle Step 1
 * This script dynamically makes the shorter of the two product columns sticky.
 */
function initBundleSticky(productSection) {
  if (!productSection) return;

  const gridContainer = productSection.querySelector('.grid');
  const imageColumn = productSection.querySelector('.product-grid__images');
  const infoColumn = productSection.querySelector('.product-grid__info');
  const infoColumnInner = infoColumn ? infoColumn.querySelector('.product-info-inner') : null;
  const imageColumnInner = imageColumn ? imageColumn.querySelector('.product-column-content') : null;
  const interactiveElements = productSection.querySelectorAll('details.product-accordion, .size-guide-text-trigger');

  if (!gridContainer || !imageColumn || !infoColumn || !infoColumnInner || !imageColumnInner) {
    return;
  }

  let scrollHandler = () => {};
  
  const setupStickyColumns = () => {
    // Clean up styles from previous calculations before re-running
    window.removeEventListener('scroll', scrollHandler);
    imageColumnInner.style.cssText = '';
    infoColumnInner.style.cssText = '';
    imageColumn.style.height = '';
    infoColumn.style.height = '';
    imageColumn.style.position = '';
    infoColumn.style.position = '';

    // This logic is for desktop viewports only
    if (window.innerWidth < 991) {
      return;
    }

    requestAnimationFrame(() => {
        // Measure the inner content elements, not the grid containers which are equal height.
        const imageColHeight = imageColumnInner.offsetHeight;
        const infoColHeight = infoColumnInner.offsetHeight;
        
        // Store original widths to maintain consistent sizing during sticky states
        let imageColOriginalWidth = imageColumnInner.offsetWidth;
        const infoColOriginalWidth = infoColumnInner.offsetWidth;
        
        // LOCK THE WIDTHS FOREVER - This prevents any sizing changes during sticky scrolling
        console.log('🔒 Locking image column width at:', imageColOriginalWidth);
        console.log('🔒 Locking info column width at:', infoColOriginalWidth);
        
        // Lock the image column width immediately
        imageColumn.style.width = `${imageColOriginalWidth}px`;
        imageColumn.style.maxWidth = `${imageColOriginalWidth}px`;
        imageColumn.style.minWidth = `${imageColOriginalWidth}px`;
        imageColumn.style.flexShrink = '0';
        imageColumn.style.flexGrow = '0';
        
        // Lock the info column width immediately  
        infoColumn.style.width = `${infoColOriginalWidth}px`;
        infoColumn.style.maxWidth = `${infoColOriginalWidth}px`;
        infoColumn.style.minWidth = `${infoColOriginalWidth}px`;
        infoColumn.style.flexShrink = '0';
        infoColumn.style.flexGrow = '0';
        
        // LOCK THE PHOTOS CONTAINER WIDTH - This is the key fix!
        const photosContainer = imageColumnInner.querySelector('.product__photos');
        if (photosContainer) {
          const photosWidth = photosContainer.offsetWidth;
          console.log('🔒 Locking photos container width at:', photosWidth);
          photosContainer.style.width = `${photosWidth}px`;
          photosContainer.style.maxWidth = `${photosWidth}px`;
          photosContainer.style.minWidth = `${photosWidth}px`;
          photosContainer.style.flexShrink = '0';
          photosContainer.style.flexGrow = '0';
        }
        
        // LOCK THE SLIDESHOW CONTAINER WIDTH
        const slideshowContainer = imageColumnInner.querySelector('.product-slideshow');
        if (slideshowContainer) {
          const slideshowWidth = slideshowContainer.offsetWidth;
          console.log('🔒 Locking slideshow container width at:', slideshowWidth);
          slideshowContainer.style.width = `${slideshowWidth}px`;
          slideshowContainer.style.maxWidth = `${slideshowWidth}px`;
          slideshowContainer.style.minWidth = `${slideshowWidth}px`;
          slideshowContainer.style.flexShrink = '0';
          slideshowContainer.style.flexGrow = '0';
        }
        
        // LOCK THE MAIN PHOTOS CONTAINER WIDTH
        const mainPhotosContainer = imageColumnInner.querySelector('.product__main-photos');
        if (mainPhotosContainer) {
          const mainPhotosWidth = mainPhotosContainer.offsetWidth;
          console.log('🔒 Locking main photos container width at:', mainPhotosWidth);
          mainPhotosContainer.style.width = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.maxWidth = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.minWidth = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.flexShrink = '0';
          mainPhotosContainer.style.flexGrow = '0';
        }
        
        // For carousel, get the actual rendered width from CSS computed styles
        const carouselContainer = imageColumnInner.querySelector('.product__photos--below') || 
                                 imageColumnInner.querySelector('.product-slideshow');
        if (carouselContainer) {
          // Get computed style to see the actual rendered width
          const computedStyle = window.getComputedStyle(carouselContainer);
          const computedWidth = parseFloat(computedStyle.width);
          
          // Use the actual computed width - this respects the responsive CSS max-width
          if (computedWidth && computedWidth > 0) {
            imageColOriginalWidth = computedWidth; // This already respects min(765px, 50vw)
          } else {
            // Fallback: try to get width from the main image
            const mainImage = carouselContainer.querySelector('.product-main-slide img') || 
                             carouselContainer.querySelector('.product__photo img');
            if (mainImage) {
              const imageWidth = mainImage.naturalWidth || mainImage.offsetWidth;
              imageColOriginalWidth = Math.min(imageWidth, 765); // Apply reasonable max
            } else {
              // Last fallback: use container width with reasonable max
              imageColOriginalWidth = Math.min(imageColOriginalWidth, 765);
            }
          }
        }
            
        // Exit if columns are of similar height, as no sticky effect is needed.
        if (Math.abs(imageColHeight - infoColHeight) < 100) {
            return;
        }

        const shortCol = imageColHeight > infoColHeight ? infoColumn : imageColumn;
        const shortColInner = imageColHeight > infoColHeight ? infoColumnInner : imageColumnInner;
        const shortColOriginalWidth = imageColHeight > infoColHeight ? infoColOriginalWidth : imageColOriginalWidth;
        
        // **FIX**: Set position relative on the container of the element that will be docked.
        // This makes it the positioning context for its absolutely positioned child.
        shortCol.style.position = 'relative';
        // Set an explicit height on the short column's container to prevent the grid from collapsing
        // when its inner element is taken out of the document flow with `position: fixed`.
        shortCol.style.height = `${shortCol.offsetHeight}px`;

        const headerOffset = 120; // Adjust if your sticky header's height changes

        scrollHandler = () => {
            const scrollY = window.scrollY;
            const gridRect = gridContainer.getBoundingClientRect();
            const shortColInnerHeight = shortColInner.offsetHeight;
            const gridAbsoluteTop = gridRect.top + scrollY;
            const startPoint = gridAbsoluteTop - headerOffset;
            const stopPoint = gridAbsoluteTop + gridRect.height - shortColInnerHeight - headerOffset;
            const buffer = 2; // A small buffer to prevent jittering at the thresholds
            
            if (scrollY > startPoint + buffer && scrollY < stopPoint - buffer) {
                // State 1: STICKY. The element is fixed relative to the viewport.
                shortColInner.style.position = 'fixed';
                shortColInner.style.top = `${headerOffset}px`;
                shortColInner.style.bottom = 'auto';
                // Use the locked width - no calculations needed
                shortColInner.style.width = `${shortColOriginalWidth}px`;
                shortColInner.style.maxWidth = `${shortColOriginalWidth}px`;
            } else if (scrollY >= stopPoint - buffer) {
                // State 2: DOCKED. The element is positioned absolutely to the bottom of its parent container.
                shortColInner.style.position = 'absolute';
                shortColInner.style.top = 'auto';
                shortColInner.style.bottom = '0px';
                // Use the locked width - no calculations needed
                shortColInner.style.width = `${shortColOriginalWidth}px`;
                shortColInner.style.maxWidth = `${shortColOriginalWidth}px`;
            } else {
                // State 3: DEFAULT. The element is in its normal static position.
                shortColInner.style.position = '';
                shortColInner.style.top = '';
                shortColInner.style.bottom = '';
                shortColInner.style.width = '';
            }
        };
        
        window.addEventListener('scroll', scrollHandler, { passive: true });
        scrollHandler(); // Run once immediately on setup to get the initial state right
    });
  };
  
  const debounce = (func, delay) => {
      let timeout;
      return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
      };
  };

  const debouncedSetup = debounce(setupStickyColumns, 250);

  // --- Event Listeners ---

  // Run on initial load when all assets are ready
  window.addEventListener('load', debouncedSetup);
  // A fallback for DOMContentLoaded in case `load` is slow, e.g., with deferred scripts
  document.addEventListener('DOMContentLoaded', () => setTimeout(debouncedSetup, 500));
  
  // Re-run when the browser is resized
  window.addEventListener('resize', debouncedSetup);

  // Re-run whenever an interactive element (accordion/dropdown) is toggled
  interactiveElements.forEach(el => {
    const eventName = el.tagName.toLowerCase() === 'details' ? 'toggle' : 'click';
    el.addEventListener(eventName, debouncedSetup);
  });
}

// Initialize sticky columns for step 2
function initializeStep2StickyColumns() {
  const step2Element = container.querySelector('.bundle-step-2');
  if (!step2Element) return;
  
  const gridContainer = step2Element.querySelector('.grid');
  const imageColumn = step2Element.querySelector('.product-single__sticky');
  const infoColumn = step2Element.querySelector('.product-single__meta').parentElement;
  const imageColumnInner = imageColumn ? imageColumn.querySelector('.product-column-content') : null;
  const infoColumnInner = infoColumn ? infoColumn.querySelector('.product-single__meta') : null;
  
  if (!gridContainer || !imageColumn || !infoColumn || !imageColumnInner || !infoColumnInner) {
    console.log('Step 2 sticky elements not found');
    return;
  }
  
  console.log('Initializing step 2 sticky columns');
  
  const setupStickyColumns = () => {
    // Clean up styles from previous calculations before re-running
    window.removeEventListener('scroll', scrollHandler);
    imageColumnInner.style.cssText = '';
    infoColumnInner.style.cssText = '';
    imageColumn.style.height = '';
    infoColumn.style.height = '';
    imageColumn.style.position = '';
    infoColumn.style.position = '';

    // This logic is for desktop viewports only
    if (window.innerWidth < 991) {
      return;
    }

    requestAnimationFrame(() => {
      // Measure the inner content elements, not the grid containers which are equal height.
      const imageColHeight = imageColumnInner.offsetHeight;
      const infoColHeight = infoColumnInner.offsetHeight;
      
      // Store original widths to maintain consistent sizing during sticky states
      const imageColWidth = imageColumnInner.offsetWidth;
      const infoColWidth = infoColumnInner.offsetWidth;
      
      // Set the grid container height to the taller column
      const maxHeight = Math.max(imageColHeight, infoColHeight);
      gridContainer.style.height = maxHeight + 'px';
      
      // Make the image column sticky
      imageColumn.style.position = 'sticky';
      imageColumn.style.top = '120px';
      imageColumn.style.alignSelf = 'start';
      
      // Set up scroll handler for dynamic positioning
      let scrollHandler = () => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const containerRect = gridContainer.getBoundingClientRect();
        const containerTop = containerRect.top + scrollTop;
        const containerBottom = containerTop + gridContainer.offsetHeight;
        const viewportBottom = scrollTop + window.innerHeight;
        
        // Calculate sticky positioning
        if (scrollTop + 120 >= containerTop && scrollTop + 120 < containerBottom - imageColHeight) {
          imageColumnInner.style.position = 'sticky';
          imageColumnInner.style.top = '120px';
        } else if (scrollTop + 120 >= containerBottom - imageColHeight) {
          imageColumnInner.style.position = 'absolute';
          imageColumnInner.style.top = (containerBottom - imageColHeight - containerTop) + 'px';
        } else {
          imageColumnInner.style.position = 'static';
          imageColumnInner.style.top = 'auto';
        }
      };
      
      // Add scroll listener
      window.addEventListener('scroll', scrollHandler);
      
      // Initial call
      scrollHandler();
    });
  };
  
  // Debounce function
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };
  
  const debouncedSetup = debounce(setupStickyColumns, 250);
  
  // Run setup
  debouncedSetup();
  
  // Re-run when the browser is resized
  window.addEventListener('resize', debouncedSetup);
}

// Initialize the script for the current section
const currentBundleSection = document.querySelector('#MainProductBundle-{{ section.id }}');
if (currentBundleSection) {
  initBundleSticky(currentBundleSection);
}

// Re-initialize if the section is reloaded by the theme editor
document.addEventListener('shopify:section:load', function(event) {
  if (event.detail.sectionId === '{{ section.id }}') {
    const reloadedSection = document.querySelector('#MainProductBundle-{{ section.id }}');
    if (reloadedSection) {
      initBundleSticky(reloadedSection);
    }
  }
});
</script>

{% schema %}
{
  "name": "Product Bundle",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "customize_width",
          "label": "Customize width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "customize_width",
      "min": 800,
      "max": 2000,
      "step": 20,
      "unit": "px",
      "label": "Customize width",
      "default": 1800
    },
    {
      "type": "product_list",
      "id": "bundle_products",
      "label": "Bundle Products",
      "info": "Chọn các sản phẩm sẽ được hiển thị trong Step 2 của bundle builder",
      "limit": 10
    },
    {
      "type": "checkbox",
      "id": "sku_enable",
      "label": "Show SKU",
      "default": true
    },
    {
      "type": "header",
      "content": "Step 1 Content Settings"
    },
    {
      "type": "text",
      "id": "combo_title",
      "label": "Combo Products Title",
      "default": "Combo bao gồm các sản phẩm:"
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "CTA Button Text",
      "default": "BẮT ĐẦU TẠO COMBO"
    },
    {
      "type": "header",
      "content": "Service Grid Settings"
    },
    {
      "type": "image_picker",
      "id": "service_icon_1",
      "label": "Service Icon 1 (100 đêm ngủ thử)"
    },
    {
      "type": "text",
      "id": "service_text_1",
      "label": "Service Text 1",
      "default": "100 đêm ngủ thử"
    },
    {
      "type": "image_picker",
      "id": "service_icon_2",
      "label": "Service Icon 2 (Miễn phí vận chuyển)"
    },
    {
      "type": "text",
      "id": "service_text_2",
      "label": "Service Text 2",
      "default": "Miễn phí vận chuyển"
    },
    {
      "type": "image_picker",
      "id": "service_icon_3",
      "label": "Service Icon 3 (Bảo hành dài lâu)"
    },
    {
      "type": "text",
      "id": "service_text_3",
      "label": "Service Text 3",
      "default": "Bảo hành dài lâu"
    },
    {
      "type": "image_picker",
      "id": "service_icon_4",
      "label": "Service Icon 4 (Thanh toán linh hoạt)"
    },
    {
      "type": "text",
      "id": "service_text_4",
      "label": "Service Text 4",
      "default": "Thanh toán linh hoạt"
    },
    {
      "type": "select",
      "id": "image_position",
      "label": "Image position",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "right"
    },
    {
      "type": "checkbox",
      "id": "product_zoom_enable",
      "label": "Enable image zoom",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "product_carousel_enable",
      "label": "Enable product carousel",
      "default": false
    },
    {
      "type": "select",
      "id": "thumbnail_position",
      "label": "Thumbnail position",
      "options": [
        {
          "value": "beside",
          "label": "Beside main image"
        },
        {
          "value": "below",
          "label": "Below main image"
        }
      ],
      "default": "beside"
    },
    {
      "type": "range",
      "id": "thumbnail_height",
      "min": 60,
      "max": 120,
      "step": 10,
      "unit": "px",
      "label": "Thumbnail height",
      "default": 100
    },
    {
      "type": "checkbox",
      "id": "thumbnail_arrows",
      "label": "Show thumbnail arrows",
      "default": false
    },
    {
      "type": "select",
      "id": "mobile_layout",
      "label": "Mobile layout",
      "options": [
        {
          "value": "partial",
          "label": "Partial"
        },
        {
          "value": "stacked",
          "label": "Stacked"
        }
      ],
      "default": "partial"
    },
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "label": "Enable video looping",
      "default": false
    },
    {
      "type": "select",
      "id": "product_video_style",
      "label": "Video style",
      "options": [
        {
          "value": "muted",
          "label": "Muted"
        },
        {
          "value": "unmuted",
          "label": "Unmuted"
        }
      ],
      "default": "muted"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_add_to_cart",
      "label": "Enable sticky add to cart",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "hide_payment_button_mobile",
      "label": "Hide payment button on mobile",
      "default": false
    },
    {
      "type": "select",
      "id": "image_size",
      "label": "Image size",
      "default": "medium",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ]
    },
    {
      "type": "header",
      "content": "Showroom Settings"
    },
    {
      "type": "text",
      "id": "showroom_1_name",
      "label": "Showroom 1 Name",
      "default": "Showroom 1"
    },
    {
      "type": "text",
      "id": "showroom_1_address",
      "label": "Showroom 1 Address",
      "default": "Địa chỉ showroom"
    },
    {
      "type": "text",
      "id": "showroom_1_phone",
      "label": "Showroom 1 Phone",
      "default": "0964777910"
    },
    {
      "type": "url",
      "id": "showroom_1_map_link",
      "label": "Showroom 1 Map Link"
    },
    {
      "type": "text",
      "id": "showroom_2_name",
      "label": "Showroom 2 Name",
      "default": "Showroom 2"
    },
    {
      "type": "text",
      "id": "showroom_2_address",
      "label": "Showroom 2 Address",
      "default": "Địa chỉ showroom"
    },
    {
      "type": "text",
      "id": "showroom_2_phone",
      "label": "Showroom 2 Phone",
      "default": "0964777910"
    },
    {
      "type": "url",
      "id": "showroom_2_map_link",
      "label": "Showroom 2 Map Link"
    },
    {
      "type": "text",
      "id": "showroom_3_name",
      "label": "Showroom 3 Name",
      "default": "Showroom 3"
    },
    {
      "type": "text",
      "id": "showroom_3_address",
      "label": "Showroom 3 Address",
      "default": "Địa chỉ showroom"
    },
    {
      "type": "text",
      "id": "showroom_3_phone",
      "label": "Showroom 3 Phone",
      "default": "0964777940"
    },
    {
      "type": "url",
      "id": "showroom_3_map_link",
      "label": "Showroom 3 Map Link"
    },
    {
      "type": "header",
      "content": "Review Settings"
    },
    {
      "type": "text",
      "id": "review_rating",
      "label": "Review Rating",
      "default": "4.8"
    },
    {
      "type": "text",
      "id": "review_count",
      "label": "Review Count",
      "default": "2025 đánh giá"
    }
  ],
  "blocks": [
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "variant_labels",
          "label": "Show variant labels",
          "default": true
        },
        {
          "type": "select",
          "id": "picker_type",
          "label": "Picker type",
          "options": [
            {
              "value": "button",
              "label": "Buttons"
            },
            {
              "value": "dropdown",
              "label": "Dropdown"
            }
          ],
          "default": "button"
        },
        {
          "type": "checkbox",
          "id": "product_dynamic_variants_enable",
          "label": "Enable dynamic variants",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "color_swatches",
          "label": "Enable color swatches",
          "default": false
        }
      ]
    },
    {
      "type": "quantity_selector",
      "name": "Quantity selector",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "label": "Show dynamic checkout",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "surface_pickup_enable",
          "label": "Enable surface pickup",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_gift_card_recipient",
          "label": "Show gift card recipient",
          "default": false
        }
      ]
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1
    },
    {
      "type": "product_combo",
      "name": "Product Combo",
      "limit": 1,
      "settings": []
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "is_tab",
          "label": "Show as tab",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "collapse_content",
          "label": "Collapse content",
          "default": false
        }
      ]
    },
    {
      "type": "icon_with_text",
      "name": "Icon with Text",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "Icon 1"
        },
        {
          "type": "image_picker",
          "id": "icon_1_image",
          "label": "Icon 1 Image"
        },
        {
          "type": "text",
          "id": "icon_1_heading",
          "label": "Icon 1 Heading",
          "default": "100 đêm ngủ thử"
        },
        {
          "type": "header",
          "content": "Icon 2"
        },
        {
          "type": "image_picker",
          "id": "icon_2_image",
          "label": "Icon 2 Image"
        },
        {
          "type": "text",
          "id": "icon_2_heading",
          "label": "Icon 2 Heading",
          "default": "Miễn phí vận chuyển *"
        },
        {
          "type": "header",
          "content": "Icon 3"
        },
        {
          "type": "image_picker",
          "id": "icon_3_image",
          "label": "Icon 3 Image"
        },
        {
          "type": "text",
          "id": "icon_3_heading",
          "label": "Icon 3 Heading",
          "default": "Bảo hành dài lâu"
        },
        {
          "type": "header",
          "content": "Icon 4"
        },
        {
          "type": "image_picker",
          "id": "icon_4_image",
          "label": "Icon 4 Image"
        },
        {
          "type": "text",
          "id": "icon_4_heading",
          "label": "Icon 4 Heading",
          "default": "Chất liệu Foam cao cấp"
        },
        {
          "type": "header",
          "content": "Layout Settings"
        },
        {
          "type": "range",
          "id": "icon_size",
          "min": 20,
          "max": 60,
          "step": 5,
          "unit": "px",
          "label": "Icon Size",
          "default": 25
        },
        {
          "type": "select",
          "id": "icon_alignment",
          "label": "Icon Alignment",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "center"
        },
        {
          "type": "select",
          "id": "grid_columns",
          "label": "Layout Style",
          "options": [
            {
              "value": "1",
              "label": "1 cột"
            },
            {
              "value": "2",
              "label": "2 cột (2x2)"
            }
          ],
          "default": "2"
        },
        {
          "type": "checkbox",
          "id": "show_icon_4",
          "label": "Show Icon 4",
          "default": true
        }
      ]
    },
    {
      "type": "carousel_modal",
      "name": "Carousel modal",
      "limit": 1,
      "settings": []
    }
  ],
  "presets": [
    {
      "name": "Product Bundle",
      "blocks": [
        {
          "type": "variant_picker"
        },
        {
          "type": "quantity_selector"
        },
        {
          "type": "price"
        },
        {
          "type": "description"
        },
        {
          "type": "icon_with_text"
        }
      ]
    }
  ]
}
{% endschema %}