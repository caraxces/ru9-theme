{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  
  # Check section settings only - more robust check
  assign has_bundle_products = false
  assign bundle_products_list = blank
  
  if section.settings.bundle_products
    # Check if it's not empty by trying to access first element
    assign first_product = section.settings.bundle_products | first
    if first_product != blank
      assign has_bundle_products = true
      assign bundle_products_list = section.settings.bundle_products
    endif
  endif
-%}

{{ 'main-product-bundle.css' | asset_url | stylesheet_tag }}

{%- comment -%}
  BUNDLE PRICING CALCULATOR - Only visible in Theme Editor
{%- endcomment -%}
{%- if request.design_mode -%}
<div class="bundle-pricing-calculator" style="background: #FFF9E6; border: 2px solid #FFD700; border-radius: 8px; padding: 20px; margin: 20px auto; max-width: 800px;">
  <h3 style="color: #1C2C58; margin: 0 0 16px 0; font-size: 20px;">üí∞ Bundle Pricing Calculator</h3>
  
  <div class="calculator-info" style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <div style="margin-bottom: 12px;">
      <strong>üéØ Target Discount:</strong> 
      <span style="color: #234085; font-size: 24px; font-weight: bold;">{{ section.settings.target_discount_percentage | default: 15 }}%</span>
    </div>
    
    <div id="calculator-results" style="border-top: 1px solid #E0E0E0; padding-top: 12px; margin-top: 12px;">
      <p style="margin: 8px 0; color: #666; font-size: 14px;">
        ‚è≥ <em>Calculator s·∫Ω t·ª± ƒë·ªông t√≠nh khi c√≥ bundle products...</em>
      </p>
    </div>
  </div>
  
  <div style="background: #E3F2FD; padding: 12px; border-radius: 6px; font-size: 13px;">
    <strong>üìù L∆∞u √Ω:</strong> Calculator n√†y CH·ªà hi·ªÉn th·ªã trong Theme Editor. Kh√°ch h√†ng KH√îNG nh√¨n th·∫•y.
  </div>
</div>
{%- endif -%}

<div id="MainProductBundle-{{ section.id }}" class="bundle-main-container">
  <div class="bundle-loading-overlay">
    <div class="spinner"></div>
  </div>
  
  <div class="bundle-dynamic-content">
    <!-- Step 1: Default Product Display -->
    <div class="bundle-step bundle-step-1" data-step="1">
      {%- liquid
        assign product_zoom_size = '1800x1800'
        
        case section.settings.image_size
          when 'small'
            assign product_image_width = 'medium-up--two-fifths'
            assign product_description_width = 'medium-up--three-fifths'
          when 'medium'
            assign product_image_width = 'large-up--one-half'
            assign product_description_width = 'large-up--one-half'
          when 'large'
            assign product_image_width = 'large-up--three-fifths'
            assign product_description_width = 'large-up--two-fifths'
        endcase
      -%}

      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid{% unless section.settings.image_position == 'left' %} grid--product-images-right{% endunless %}{% if section.settings.mobile_layout == 'partial' %} grid--product-images--partial{% endif %}">
            {%- if section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                {%- render 'product-images',
                  section_id: section.id,
                  product: product,
                  product_zoom_enable: section.settings.product_zoom_enable,
                  product_zoom_size: product_zoom_size,
                  product_carousel_enable: section.settings.product_carousel_enable,
                  thumbnail_position: 'below',
                  thumbnail_height: section.settings.thumbnail_height,
                  thumbnail_arrows: section.settings.thumbnail_arrows,
                  mobile_layout: section.settings.mobile_layout,
                  blocks: section.blocks,
                  context: 'main-product',
                  sizes: sizes,
                  sizeVariable: product_image_width,
                  fallback: product_image_size,
                  video_looping: section.settings.enable_video_looping,
                  video_style: section.settings.video_style
                -%}
                <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            {%- endif -%}

            <div class="grid__item {{ product_description_width }} product-grid__info">
              <div class="product-single__meta product-info-inner">
                <div class="product-block product-block--header">
                  {%- if settings.vendor_enable -%}
                    <div class="product-single__vendor">
                      {%- assign vendor_handle = product.vendor | handleize -%}
                      {%- if collections[vendor_handle] != empty -%}
                        <a href="{{ routes.collections_url }}/{{ collections[vendor_handle].handle }}">
                          {{ collections[vendor_handle].title }}
                        </a>
                      {%- else -%}
                        {{ product.vendor | link_to_vendor }}
                      {%- endif -%}
                    </div>
                  {%- endif -%}

                  <!-- Product Reviews Section -->
                  {%- liquid
                    assign has_reviews = false
                    assign review_rating = 0
                    assign review_count = 0
                    
                    if product.metafields.reviews.rating.value != blank
                      assign has_reviews = true
                      assign review_rating = product.metafields.reviews.rating.value.rating
                      assign review_count = product.metafields.reviews.rating_count
                    elsif product.metafields.judgeme.rating != blank
                      assign has_reviews = true
                      assign review_rating = product.metafields.judgeme.rating
                      assign review_count = product.metafields.judgeme.review_count
                    endif
                  -%}
                  
                  <div class="product-reviews-summary">
                    <div class="product-rating">
                      {%- if has_reviews -%}
                        {%- liquid
                          assign rating_floor = review_rating | floor
                          assign rating_decimal = review_rating | modulo: 1
                          assign has_half_star = false
                          if rating_decimal >= 0.25 and rating_decimal < 0.75
                            assign has_half_star = true
                          elsif rating_decimal >= 0.75
                            assign rating_floor = rating_floor | plus: 1
                          endif
                        -%}
                      <div class="stars">
                          {%- for i in (1..5) -%}
                            {%- liquid
                              assign next_star = rating_floor | plus: 1
                              assign is_half_star = false
                              if i == next_star and has_half_star
                                assign is_half_star = true
                              endif
                            -%}
                            {%- if i <= rating_floor -%}
                              <span class="star star--filled">‚òÖ</span>
                            {%- elsif is_half_star -%}
                              <span class="star star--half">‚òÖ</span>
                            {%- else -%}
                              <span class="star star--empty">‚òÜ</span>
                            {%- endif -%}
                          {%- endfor -%}
                      </div>
                        <span class="rating-value">{{ review_rating | round: 1 }}</span>
                      {%- else -%}
                        <div class="stars">
                          <span class="star star--filled">‚òÖ</span>
                          <span class="star star--filled">‚òÖ</span>
                          <span class="star star--filled">‚òÖ</span>
                          <span class="star star--filled">‚òÖ</span>
                          <span class="star star--filled">‚òÖ</span>
                    </div>
                      {%- endif -%}
                    </div>
                    {%- if has_reviews and review_count > 0 -%}
                    <div class="reviews-count">
                        <span class="reviews-number">({{ review_count }} ƒë√°nh gi√°)</span>
                    </div>
                    {%- endif -%}
                  </div>

                  <h1 class="h2 product-single__title">
                    {%- unless product.empty? -%}
                      {{ product.title }}
                    {%- else -%}
                      {{ 'home_page.onboarding.product_title' | t }}
                    {%- endunless -%}
                  </h1>

                  {%- if section.settings.product_subtitle != blank -%}
                    <div class="product-single__subtitle">
                      {{ section.settings.product_subtitle }}
                    </div>
                  {%- endif -%}

                  {%- if section.settings.sku_enable -%}
                    <p data-sku class="product-single__sku">
                      {%- if current_variant.sku -%}
                        {{ current_variant.sku }}
                      {%- endif -%}
                    </p>
                  {%- endif -%}
                </div>

                <div data-product-blocks>
                  <!-- Price Block -->
                  <div class="product-block product-block--price">
                    <div class="price-container-wrapper">
                      <span class="product__price text-2xl f-smb">
                        {{ current_variant.price | money }}
                      </span>
                      {%- if current_variant.compare_at_price > current_variant.price -%}
                        <span class="product__price product__price--compare text-xl">
                          {{ current_variant.compare_at_price | money }}
                        </span>
                      {%- endif -%}
                      {%- if current_variant.compare_at_price > current_variant.price -%}
                        {%- capture discount_percentage -%}{{ current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round }}{%- endcapture -%}
                        <div class="product__discount-badge">-{{ discount_percentage }}%</div>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Combo Products List -->
                  <div class="product-block">
                      <h3 class="combo_title" style="background-color: #F5F9FF; padding: 10px; border-radius: 5px; margin: 0 0 0 0;">{{ section.settings.combo_title | default: "Combo bao g·ªìm c√°c s·∫£n ph·∫©m:" }}</h3>
                    <div class="combo-products-list">
                      {%- if has_bundle_products and bundle_products_list -%}
                        {%- for bundle_product in bundle_products_list -%}
                          {%- liquid
                            # Determine quantity for this product
                            assign product_quantity = 1
                            if forloop.index == 3 and section.settings.product_3_quantity
                              assign product_quantity = section.settings.product_3_quantity
                            endif
                            
                            # Calculate total variant options (nh√¢n t·∫•t c·∫£ options v·ªõi nhau)
                            assign total_variant_options = 1
                            for option in bundle_product.options_with_values
                              assign total_variant_options = total_variant_options | times: option.values.size
                            endfor
                          -%}
                          <div class="combo-product-item" data-product-index="{{ forloop.index }}" data-quantity="{{ product_quantity }}">
                            <div class="combo-product-image">
                              {%- if bundle_product.featured_media -%}
                                <img src="{{ bundle_product.featured_media | image_url: width: 440 }}" 
                                     alt="{{ bundle_product.title }}" 
                                     width="220" height="130"
                                     loading="lazy">
                              {%- endif -%}
                            </div>
                            <div class="combo-product-info">
                              <h4>{{ bundle_product.title }}</h4>
                              <div class="combo-product-attributes">
                                <span>S·ªë l∆∞·ª£ng: {{ product_quantity }}</span>
                                {% comment %} <span>{{ total_variant_options }} k√≠ch th∆∞·ªõc m√†u s·∫Øc</span> {% endcomment %}
                              </div>
                            </div>
                          </div>
                        {%- endfor -%}
                      {%- else -%}
                        <div class="combo-product-placeholder" style="text-align: center; padding: 2rem; color: #666;">
                          <p>Ch∆∞a c√≥ s·∫£n ph·∫©m trong combo</p>
                        </div>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Bundle CTA Button -->
                  <div class="product-block">
                    {%- if has_bundle_products -%}
                      <button
                        type="button"
                        name="bundle-cta"
                        data-bundle-cta
                        id="BundleCTAButton-{{ section.id }}-{{ product.id }}"
                        class="btn btn--full btn--primary bundle-cta-btn"
                        style="background: #FCE390; color: #1C2C58; font-weight: bold; font-size: 16px; padding: 15px; border-radius: 50px; border: none;"
                      >
                        <span data-bundle-cta-text>
                          {{ section.settings.cta_button_text | default: "B·∫ÆT ƒê·∫¶U T·∫†O COMBO" }}
                        </span>
                      </button>
                    {%- else -%}
                      <div class="bundle-setup-notice" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: center;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #856404;">‚ö†Ô∏è Bundle ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh</h4>
                        <p style="margin: 0; color: #856404; font-size: 1.15rem;">
                          ƒê·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng bundle, vui l√≤ng th√™m s·∫£n ph·∫©m v√†o bundle trong Theme Editor.
                        </p>
                        <div style="margin-top: 0.5rem;">
                          <button
                            type="button"
                            class="btn btn--secondary"
                            style="font-size: 1rem; padding: 0.5rem 1rem;"
                            onclick="alert('ƒê·ªÉ th√™m s·∫£n ph·∫©m v√†o bundle:\\n\\n1. V√†o Theme Editor\\n2. Ch·ªçn section Product Bundle\\n3. Trong settings, t√¨m Bundle Products\\n4. Click Change v√† ch·ªçn c√°c s·∫£n ph·∫©m mu·ªën th√™m v√†o bundle')"
                          >
                            H∆∞·ªõng d·∫´n c·∫•u h√¨nh
                          </button>
                        </div>
                      </div>
                    {%- endif -%}
                  </div>

                  <!-- Product Summary Block -->
                  <div class="product-block product-summary-block">
                    <div class="product-summary-content">
                      <!-- Description Accordion -->
                      <details class="product-accordion product-accordion--styled" open>
                        <summary>
                          <span>M√¥ t·∫£ s·∫£n ph·∫©m</span>
                          <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </summary>
                        <div class="product-accordion-content rte">
                          {{ product.description }}
                        </div>
                      </details>

                      <!-- Store System Accordion -->
                      {%- if section.settings.store_system_content != blank -%}
                      <details class="product-accordion product-accordion--styled">
                        <summary>
                          <span>H·ªá th·ªëng c·ª≠a h√†ng</span>
                          <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </summary>
                          <div class="product-accordion-content rte">
                            {{ section.settings.store_system_content }}
                        </div>
                      </details>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Service Grid -->
                  <div class="product-block product-block--service-grid">
                    <div class="service-grid-wrapper">
                      <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_1 -%}
                                <img src="{{ section.settings.service_icon_1 | image_url: width: 40 }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_3.svg' | asset_url }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_1 | default: "100 ƒë√™m ng·ªß th·ª≠" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_2 -%}
                                <img src="{{ section.settings.service_icon_2 | image_url: width: 40 }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_4.svg' | asset_url }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_2 | default: "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_3 -%}
                                <img src="{{ section.settings.service_icon_3 | image_url: width: 40 }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_5.svg' | asset_url }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_3 | default: "B·∫£o h√†nh d√†i l√¢u" }}</p>
                            </div>
                          </div>
                        </div>
                        <div class="service-grid-item">
                          <div class="service-item">
                            <div class="service-item__icon">
                              {%- if section.settings.service_icon_4 -%}
                                <img src="{{ section.settings.service_icon_4 | image_url: width: 40 }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                              {%- else -%}
                                <img src="{{ 'Layer_1_6.svg' | asset_url }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                              {%- endif -%}
                            </div>
                            <div class="service-item__text">
                              <p>{{ section.settings.service_text_4 | default: "Thanh to√°n linh ho·∫°t" }}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Render blocks from main-product.liquid -->
                  {%- for block in section.blocks -%}
                    {%- case block.type -%}
                      {%- when 'showroom_dropdown' -%}
                        {%- comment -%} Showroom dropdown block disabled - using hardcoded showroom info instead {%- endcomment -%}
                      {%- when 'service_grid' -%}
                        {%- liquid
                          assign services_count = 0
                          for i in (1..4)
                            assign icon_setting = 'icon_' | append: i
                            assign text_setting = 'text_' | append: i
                            assign show_setting = 'show_service_' | append: i
                            if block.settings[show_setting]
                            if block.settings[icon_setting] != blank or block.settings[text_setting] != blank
                              assign services_count = services_count | plus: 1
                              endif
                            endif
                          endfor
                        -%}
                        <div class="product-block product-block--service-grid" {{ block.shopify_attributes }}>
                          <div class="service-grid-wrapper">
                            <div class="service-grid" style="grid-template-columns: repeat({{ services_count }}, 1fr);">
                              {%- for i in (1..4) -%}
                                {%- liquid
                                  assign icon_setting = 'icon_' | append: i
                                  assign text_setting = 'text_' | append: i
                                  assign show_setting = 'show_service_' | append: i
                                  assign icon = block.settings[icon_setting]
                                  assign text = block.settings[text_setting]
                                  assign show_service = block.settings[show_setting]
                                -%}
                                {%- if show_service -%}
                                {%- if icon != blank or text != blank -%}
                                  <div class="service-grid-item">
                                    <div class="service-item">
                                      {%- if icon != blank -%}
                                        <div class="service-item__icon">
                                          <img src="{{ icon | image_url: 'master' }}" alt="{{ icon.alt | default: text }}" width="40" height="40">
                                        </div>
                                      {%- endif -%}
                                      {%- if text != blank -%}
                                        <div class="service-item__text">
                                          <p>{{ text }}</p>
                                        </div>
                                      {%- endif -%}
                                    </div>
                                  </div>
                                  {%- endif -%}
                                {%- endif -%}
                              {%- endfor -%}
                            </div>
                        </div>
                      </div>
                    {%- endcase -%}
                  {%- endfor -%}
                </div>
              </div>
            </div>

            {%- unless section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                {%- render 'product-images',
                  section_id: section.id,
                  product: product,
                  product_zoom_enable: section.settings.product_zoom_enable,
                  product_zoom_size: product_zoom_size,
                  product_carousel_enable: section.settings.product_carousel_enable,
                  thumbnail_position: 'below',
                  thumbnail_height: section.settings.thumbnail_height,
                  thumbnail_arrows: section.settings.thumbnail_arrows,
                  mobile_layout: section.settings.mobile_layout,
                  blocks: section.blocks,
                  context: 'main-product',
                  sizes: sizes,
                  sizeVariable: product_image_width,
                  fallback: product_image_size,
                  video_looping: section.settings.enable_video_looping,
                  video_style: section.settings.video_style
                -%}
                <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            {%- endunless -%}
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Bundle Products Selection -->
    <div class="bundle-step bundle-step-2" data-step="2" style="display: none;">
      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid grid--product-images-right">
            <div class="grid__item large-up--one-half product-single__sticky product-grid__images" id="Step2ImageColumn-{{ section.id }}" data-step2-images>
              <!-- Step 2 images will be dynamically loaded here via JavaScript using real Shopify product data -->
            </div>

            <!-- Bundle Product Info (Right) -->
            <div class="grid__item large-up--one-half product-grid__info">
              <div class="product-single__meta product-info-inner">
                <!-- Product Header with Bundle Step Header as subtitle -->
                <div class="product-block product-block--header">
                  <h1 class="h2 bundle-step-title">Ch·ªçn s·∫£n ph·∫©m cho bundle <span class="bundle-step-subtitle">(<span class="bundle-progress-current">1</span>/<span class="bundle-progress-total">{% if has_bundle_products and bundle_products_list %}{{ bundle_products_list.size }}{% else %}0{% endif %}</span>)</span></h1>
                </div>

                <!-- Bundle Product Content -->
          <div class="bundle-products-grid">
            <!-- Bundle products will be loaded here -->
            <div class="bundle-product-placeholder" style="text-align: center; padding: 2rem; color: #666;">
              <p>ƒêang t·∫£i s·∫£n ph·∫©m...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Bundle Summary -->
    <div class="bundle-step bundle-step-3" data-step="3" style="display: none;">
      <div class="page-content page-content--product">
        <div class="bundle-container">
          {%- if settings.show_breadcrumbs -%}
            {%- render 'breadcrumbs', classes: 'spacing-base' -%}
          {%- endif -%}
          <div class="grid grid--product-images-right">
            <div class="grid__item large-up--one-half product-single__sticky product-grid__images">
              {%- render 'product-images',
                section_id: section.id,
                product: product,
                product_zoom_enable: section.settings.product_zoom_enable,
                product_zoom_size: product_zoom_size,
                product_carousel_enable: section.settings.product_carousel_enable,
                thumbnail_position: 'below',
                thumbnail_height: section.settings.thumbnail_height,
                thumbnail_arrows: section.settings.thumbnail_arrows,
                mobile_layout: section.settings.mobile_layout,
                blocks: section.blocks,
                context: 'main-product',
                sizes: sizes,
                sizeVariable: 'large-up--one-half',
                fallback: product_image_size,
                video_looping: section.settings.enable_video_looping,
                video_style: section.settings.video_style
              -%}
              <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>

            <!-- Bundle Summary (Right) -->
            <div class="grid__item large-up--one-half product-grid__info">
              <div class="product-single__meta">
                <!-- Bundle Summary Title -->
                <div class="product-block product-block--summary-title">
                  <h2 class="bundle-summary-title">Ki·ªÉm tra l·∫°i bundle c·ªßa b·∫°n</h2>
                </div>
                
                <!-- Bundle Header -->
                <div class="product-block product-block--header">
                  <h1 class="h2 product-single__title">{{ product.title }}</h1>
                </div>

                <!-- Bundle Products List -->
                <div class="product-block">
                  <div class="bundle-summary-products">
                    <!-- Selected products will be listed here -->
                  </div>
                </div>

                <!-- Divider Line -->
                <div class="bundle-summary-divider"></div>

                <!-- Bundle Total -->
                <div class="product-block">
                  <div class="bundle-summary-total">
                    <!-- Voucher Code Display -->
                    {% comment %} {%- if section.settings.voucher_code != blank -%}
                      <div class="bundle-total-row bundle-voucher-code">
                      <span>M√£ gi·∫£m gi√°</span>
                        <span class="voucher-code-display">{{ section.settings.voucher_code }}</span>
                      </div>
                    {%- endif -%} {% endcomment %}
                    <!-- Final Total (Gi√° sau gi·∫£m - t·ªïng price) - HI·ªÇN TH·ªä TR∆Ø·ªöC -->
                    <div class="bundle-total-row bundle-final">
                      <span class="bundle-final-total">0ƒë</span>
                    </div>
                    <!-- Original Total (Gi√° g·ªëc - t·ªïng compare_at_price) + Discount Badge - HI·ªÇN TH·ªä SAU -->
                    <div class="bundle-total-row bundle-original">
                      <span class="bundle-original-total">0ƒë</span>
                      <span class="bundle-discount-badge">-0%</span>
                    </div>
                  </div>
                </div>

                <!-- Bundle Actions -->
                <div class="product-block">
                  <div class="bundle-summary-actions">
                    <div class="bundle-quantity-selector">
                      <label for="bundle-quantity">S·ªë l∆∞·ª£ng combo:</label>
                      <div class="quantity-dropdown">
                        <div class="quantity-display" data-quantity="1">
                          <span class="quantity-text">1</span>
                          <svg class="quantity-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </div>
                        <div class="quantity-options">
                          <div class="quantity-option" data-value="1">1</div>
                          <div class="quantity-option" data-value="2">2</div>
                          <div class="quantity-option" data-value="3">3</div>
                          <div class="quantity-option" data-value="4">4</div>
                          <div class="quantity-option" data-value="5">5</div>
                        </div>
                      </div>
                    </div>
                    <button type="button" class="btn btn--primary bundle-add-to-cart-btn">Th√™m v√†o gi·ªè</button>
                  </div>
                </div>

                <!-- Product Summary Block -->
                <div class="product-block product-summary-block">
                  <div class="product-summary-content">
                    <!-- Description Accordion -->
                    <details class="product-accordion product-accordion--styled" open>
                      <summary>
                        <span>M√¥ t·∫£ s·∫£n ph·∫©m</span>
                        <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </summary>
                      <div class="product-accordion-content rte">
                        {{ product.description }}
                      </div>
                    </details>

                    <!-- Store System Accordion -->
                    {%- if section.settings.store_system_content != blank -%}
                    <details class="product-accordion product-accordion--styled">
                      <summary>
                        <span>H·ªá th·ªëng c·ª≠a h√†ng</span>
                        <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </summary>
                        <div class="product-accordion-content rte">
                          {{ section.settings.store_system_content }}
                      </div>
                    </details>
                    {%- endif -%}
                  </div>
                </div>

                <!-- Service Grid -->
                <div class="product-block product-block--service-grid">
                  <div class="service-grid-wrapper">
                    <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_1 -%}
                              <img src="{{ section.settings.service_icon_1 | image_url: width: 40 }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_3.svg' | asset_url }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_1 | default: "100 ƒë√™m ng·ªß th·ª≠" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_2 -%}
                              <img src="{{ section.settings.service_icon_2 | image_url: width: 40 }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_4.svg' | asset_url }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_2 | default: "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_3 -%}
                              <img src="{{ section.settings.service_icon_3 | image_url: width: 40 }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_5.svg' | asset_url }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_3 | default: "B·∫£o h√†nh d√†i l√¢u" }}</p>
                          </div>
                        </div>
                      </div>
                      <div class="service-grid-item">
                        <div class="service-item">
                          <div class="service-item__icon">
                            {%- if section.settings.service_icon_4 -%}
                              <img src="{{ section.settings.service_icon_4 | image_url: width: 40 }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                            {%- else -%}
                              <img src="{{ 'Layer_1_6.svg' | asset_url }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                            {%- endif -%}
                          </div>
                          <div class="service-item__text">
                            <p>{{ section.settings.service_text_4 | default: "Thanh to√°n linh ho·∫°t" }}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            {%- unless section.settings.image_position == 'left' -%}
              <div class="grid__item {{ product_image_width }} product-single__sticky product-grid__images">
                {%- render 'product-images',
                  section_id: section.id,
                  product: product,
                  product_zoom_enable: section.settings.product_zoom_enable,
                  product_zoom_size: product_zoom_size,
                  product_carousel_enable: false,
                  thumbnail_position: 'below',
                  thumbnail_height: section.settings.thumbnail_height,
                  thumbnail_arrows: section.settings.thumbnail_arrows,
                  mobile_layout: section.settings.mobile_layout,
                  blocks: section.blocks
                -%}
                <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="custom-nav-button custom-nav-next" aria-label="Next image">
                  <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              </div>
            {%- endunless -%}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Debug Info -->
<!-- Has bundle products: {{ has_bundle_products }} -->
{%- if section.settings.bundle_products -%}
  <!-- Section settings bundle_products exists: true -->
  {%- assign first_product = section.settings.bundle_products | first -%}
  <!-- First product: {{ first_product }} -->
  {%- if first_product != blank -%}
    <!-- First product is not blank - bundle has products -->
    <!-- All products: {{ section.settings.bundle_products | join: ', ' }} -->
  {%- else -%}
    <!-- First product is blank - bundle is empty -->
  {%- endif -%}
{%- else -%}
  <!-- Section settings bundle_products exists: false -->
  <!-- Section settings bundle_products is blank -->
{%- endif -%}
{%- if bundle_products_list -%}
  <!-- Bundle products list count: {{ bundle_products_list.size }} -->
  <!-- Bundle products list: {{ bundle_products_list | join: ', ' }} -->
{%- else -%}
  <!-- Bundle products list is blank -->
{%- endif -%}

<!-- Raw section settings debug -->
<!-- Raw section.settings.bundle_products: {{ section.settings.bundle_products | json }} -->

<script id="BundleConfig-{{ section.id }}" type="application/json">
{
  "mainProductId": {{ product.id | json }},
  "mainProductHandle": {{ product.handle | json }},
  "moneyFormat": {{ shop.money_format | json }},
  "discountPercentage": {{ section.settings.discount_percentage | default: 10 }},
  "targetDiscountPercentage": {{ section.settings.target_discount_percentage | default: 15 }},
  "voucherCode": {{ section.settings.voucher_code | json }},
  "sectionId": {{ section.id | json }},
  "product3Quantity": {{ section.settings.product_3_quantity | default: 2 }},
  "sectionSettings": {
    "product_carousel_enable": {{ section.settings.product_carousel_enable | json }},
    "thumbnail_position": {{ section.settings.thumbnail_position | json }},
    "image_position": {{ section.settings.image_position | json }}
  },
  "iconWithTextSettings": {
    {%- assign icon_block_found = false -%}
    {%- for block in section.blocks -%}
      {%- if block.type == 'icon_with_text' -%}
        {%- assign icon_block_found = true -%}
        "icon_1_image": {{ block.settings.icon_1_image | image_url: '100x' | json }},
        "icon_1_heading": {{ block.settings.icon_1_heading | json }},
        "icon_2_image": {{ block.settings.icon_2_image | image_url: '100x' | json }},
        "icon_2_heading": {{ block.settings.icon_2_heading | json }},
        "icon_3_image": {{ block.settings.icon_3_image | image_url: '100x' | json }},
        "icon_3_heading": {{ block.settings.icon_3_heading | json }},
        "icon_4_image": {{ block.settings.icon_4_image | image_url: '100x' | json }},
        "icon_4_heading": {{ block.settings.icon_4_heading | json }},
        "icon_size": {{ block.settings.icon_size | default: 25 | json }},
        "icon_alignment": {{ block.settings.icon_alignment | default: 'center' | json }},
        "grid_columns": {{ block.settings.grid_columns | default: "2" | json }},
        "show_icon_4": {% if block.settings.show_icon_4 == false %}false{% else %}true{% endif %}
      {%- endif -%}
    {%- endfor -%}
    {%- unless icon_block_found -%}
      "icon_1_image": null,
      "icon_1_heading": "100 ƒë√™m ng·ªß th·ª≠",
      "icon_2_image": null,
      "icon_2_heading": "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn *",
      "icon_3_image": null,
      "icon_3_heading": "B·∫£o h√†nh d√†i l√¢u",
      "icon_4_image": null,
      "icon_4_heading": "Ch·∫•t li·ªáu Foam cao c·∫•p",
      "icon_size": 25,
      "icon_alignment": "center",
      "grid_columns": "2",
      "show_icon_4": true
    {%- endunless -%}
  },
  "debug": {
    "hasBundleProducts": {{ has_bundle_products | json }},
    "hasBundleProductsRaw": {{ has_bundle_products }},
    "bundleProductsListExists": {% if bundle_products_list %}true{% else %}false{% endif %},
    "sectionSettingsExists": {% if section.settings.bundle_products %}true{% else %}false{% endif %},
    "firstProduct": {{ section.settings.bundle_products | first | json }},
    "sectionSettingsRaw": {{ section.settings.bundle_products | json }}
  },
        "bundleProducts": [
        {%- if has_bundle_products and bundle_products_list -%}
          {%- for bundle_product in bundle_products_list -%}
            {%- if bundle_product -%}
            {
              "handle": {{ bundle_product.handle | json }},
              "title": {{ bundle_product.title | json }},
              "id": {{ bundle_product.id | json }},
              "featured_image": {{ bundle_product.featured_media | image_url: 'medium' | json }},
              "price": {{ bundle_product.price | json }},
              "compare_at_price": {{ bundle_product.compare_at_price | json }},
              "description": {{ bundle_product.description | json }},
              "options": [
                {%- for option in bundle_product.options_with_values -%}
                  {
                    "name": {{ option.name | json }},
                    "values": {{ option.values | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              "media": [
                {%- for media in bundle_product.media -%}
                  {
                    "id": {{ media.id | json }},
                    "media_type": {{ media.media_type | json }},
                    "src": {{ media | image_url: 'large' | json }},
                    "alt": {{ media.alt | json }},
                    "preview_image": {
                      "src": {{ media | image_url: 'large' | json }},
                      "aspect_ratio": {{ media.aspect_ratio | default: 1 | json }}
                    }
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ],
              "variants": [
                {%- for variant in bundle_product.variants -%}
                  {
                    "id": {{ variant.id | json }},
                    "title": {{ variant.title | json }},
                    "price": {{ variant.price | json }},
                    "compare_at_price": {{ variant.compare_at_price | json }},
                    "available": {{ variant.available | json }},
                    "featured_image": {{ variant.featured_media | image_url: 'medium' | json }},
                    "options": {{ variant.options | json }}
                  }{% unless forloop.last %},{% endunless %}
                {%- endfor -%}
              ]
            }{% unless forloop.last %},{% endunless %}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      ],
  "hasBundleProducts": {{ has_bundle_products | json }}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('MainProductBundle-{{ section.id }}');
  if (!container) return;

  // Cache for Shopify product data to avoid repeated API calls
  const productDataCache = {};

  // Helper function to fetch product data from Shopify with caching
  async function fetchShopifyProduct(handle) {
    // Check cache first
    if (productDataCache[handle]) {
      console.log('üì¶ Using cached data for:', handle);
      return productDataCache[handle];
    }

    console.log('üåê Fetching from Shopify:', handle);
    const response = await fetch(`/products/${handle}.js`);
    const shopifyProduct = await response.json();
    
    // Convert Shopify product format to our format
    const productData = {
      id: shopifyProduct.id,
      title: shopifyProduct.title,
      handle: shopifyProduct.handle,
      media: shopifyProduct.media || shopifyProduct.images.map(img => ({
        id: img.id,
        media_type: 'image',
        src: img.src,
        alt: img.alt,
        preview_image: {
          src: img.src,
          aspect_ratio: img.width / img.height
        }
      })),
      variants: shopifyProduct.variants
    };
    
    // Cache the result
    productDataCache[handle] = productData;
    return productData;
  }

  // Helper function to render product images HTML for Step 2 (thumbnails below)
  function renderProductImagesHTML(productData, sectionId, step) {
    console.log('üñºÔ∏è renderProductImagesHTML called:', {
      step,
      hasProductData: !!productData,
      hasMedia: !!(productData && productData.media),
      mediaLength: productData?.media?.length,
      productTitle: productData?.title
    });
    
    if (!productData || !productData.media || productData.media.length === 0) {
      console.warn('‚ùå No images to render:', productData);
      return '<div class="product__photos"><p>Kh√¥ng c√≥ h√¨nh ·∫£nh</p></div>';
    }
    
    const productCarouselEnable = {{ section.settings.product_carousel_enable | json }};
    const thumbnailArrows = {{ section.settings.thumbnail_arrows | json }};
    
    console.log('üñºÔ∏è Rendering', productData.media.length, 'images for', productData.title);
    
    // Main slideshow HTML
    let slideshowHTML = '';
    productData.media.forEach((media, index) => {
      const mediaUrl = media.preview_image?.src || media.src || '';
      const aspectRatio = media.preview_image?.aspect_ratio || 1;
      
      console.log(`  Image ${index}:`, {
        mediaUrl,
        aspectRatio,
        rawMedia: media,
        previewImage: media.preview_image,
        src: media.src
      });
      
      slideshowHTML += `
        <div class="product-main-slide ${index === 0 ? 'starting-slide' : 'secondary-slide'}" data-index="${index}">
          <div data-product-image-main class="product-image-main">
            <div class="image-wrap loaded" style="height: 0; padding-bottom: ${100 / aspectRatio}%;">
              <img src="${mediaUrl}" 
                   alt="${productData.title}" 
                   class="photoswipe__image lazyautosizes image-element lazyloaded" 
                   style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain;"
                   loading="${index === 0 ? 'eager' : 'lazy'}">
            </div>
          </div>
        </div>
      `;
    });
    
    // Thumbnails HTML (below)
    let thumbnailsHTML = '';
    if (productData.media.length > 1) {
      productData.media.forEach((media, index) => {
        const mediaUrl = media.preview_image?.src || media.src || '';
        const aspectRatio = media.preview_image?.aspect_ratio || 1;
        
        thumbnailsHTML += `
          <div class="product__thumb-item" data-index="${index}">
            <a href="${mediaUrl}" data-product-thumb class="product__thumb" data-index="${index}" data-id="${media.id || index}">
              <div class="image-wrap image-wrap__thumbnail" style="height: 0; padding-bottom: ${100 / aspectRatio}%;">
                <img src="${mediaUrl}" alt="${productData.title}" loading="lazy">
              </div>
            </a>
          </div>
        `;
      });
    }
    
    // Complete HTML structure with thumbnails below
    return `
      <div class="product-column-content" data-product-images>
        <div class="product__photos${productCarouselEnable ? '' : ' product__photos--stack'} product__photos-${sectionId} product__photos--below">
          <div class="product__main-photos" data-product-single-media-group>
            <div data-product-photos class="product-slideshow" id="ProductPhotos-${step}-${sectionId}">
              ${slideshowHTML}
            </div>
          </div>
          
          ${productData.media.length > 1 ? `
            <div data-product-thumbs class="product__thumbs product__thumbs--below">
              ${thumbnailArrows ? `
                <button type="button" class="product__thumb-arrow product__thumb-arrow--prev hide">
                  <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-chevron-left" viewBox="0 0 284.49 498.98">
                    <path d="M249.49 0a35 35 0 0 1 24.75 59.75L84.49 249.49l189.75 189.74a35.002 35.002 0 1 1-49.5 49.5L10.25 274.24a35 35 0 0 1 0-49.5L224.74 10.25A34.89 34.89 0 0 1 249.49 0Z"/>
                  </svg>
                </button>
              ` : ''}
              
              <div class="${productCarouselEnable ? 'huan-false' : ''} product__thumbs--scroller">
                ${thumbnailsHTML}
              </div>
              
              ${thumbnailArrows ? `
                <button type="button" class="product__thumb-arrow product__thumb-arrow--next">
                  <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-chevron-right" viewBox="0 0 284.49 498.98">
                    <path d="M35 498.98a35 35 0 0 1-24.75-59.75l189.74-189.74L10.25 59.75a35.002 35.002 0 0 1 49.5-49.5l214.49 214.49a35 35 0 0 1 0 49.5L59.75 488.73A34.89 34.89 0 0 1 35 498.98Z"/>
                  </svg>
                </button>
              ` : ''}
            </div>
          ` : ''}
        </div>
        <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">
          <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button class="custom-nav-button custom-nav-next" aria-label="Next image">
          <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    `;
  }
  
  // Helper function to initialize Flickity carousel
  function initializeFlickityForStep(container, step) {
    setTimeout(() => {
      const slideshow = container.querySelector('.product-slideshow');
      if (slideshow && window.Flickity) {
        new Flickity(slideshow, {
          cellAlign: 'left',
          contain: true,
          prevNextButtons: false,
          pageDots: false,
          wrapAround: true
        });
        
        // Connect custom nav buttons to Flickity
        const prevBtn = container.querySelector('.custom-nav-prev');
        const nextBtn = container.querySelector('.custom-nav-next');
        if (prevBtn && nextBtn) {
          const flkty = Flickity.data(slideshow);
          if (flkty) {
            prevBtn.addEventListener('click', () => flkty.previous());
            nextBtn.addEventListener('click', () => flkty.next());
          }
        }
      }
    }, 300);
  }

  const configElement = document.getElementById('BundleConfig-{{ section.id }}');
  if (!configElement) return;

  
  let config;
  try {
    config = JSON.parse(configElement.textContent);
  } catch (error) {
    return;
  }
  
  
  if (config.bundleProducts.length === 0) {
    
    // Try to load products from debug info if available
    if (config.debug && config.debug.sectionSettingsRaw && Array.isArray(config.debug.sectionSettingsRaw)) {
      config.bundleProducts = config.debug.sectionSettingsRaw.map(productHandle => {
        return {
          handle: productHandle,
          title: productHandle, // Fallback title
          id: 0, // Fallback ID
          featured_image: '', // Fallback image
          price: 0, // Fallback price
          description: '', // Fallback description
          variants: [] // Fallback variants
        };
      });
    }
  }
  
  const dynamicContent = container.querySelector('.bundle-dynamic-content');
  const loadingOverlay = container.querySelector('.bundle-loading-overlay');

  // Bundle state
  let bundleState = {
    currentStep: 1,
    currentProductIndex: 0,
    bundleQuantity: 1,
    selectedProducts: {
      main: {
        variantId: {{ current_variant.id | json }},
        quantity: 1
      },
      bundle: []
    }
  };

  // Initialize variant picker for main product
  initializeVariantPicker();

  // Event listeners
  container.addEventListener('click', handleBundleEvents);
  

                function handleBundleEvents(e) {
                
                // Add to cart button click
                if (e.target.closest('.bundle-add-to-cart-btn')) {
                  e.preventDefault();
                  addBundleToCart();
                }
                // CTA button click
                else if (e.target.closest('.bundle-cta-btn') || e.target.closest('[data-bundle-cta]')) {
                  e.preventDefault();
                  
                  // More robust check for bundle products
                  const hasProducts = config.hasBundleProducts === true || config.hasBundleProducts === 'true';
                  const productsArray = Array.isArray(config.bundleProducts) ? config.bundleProducts : [];
                  const hasValidProducts = productsArray.length > 0;
                  
                  // Alternative check using debug info
                  const debugHasProducts = config.debug && config.debug.hasBundleProducts === true;
                  const debugFirstProduct = config.debug && config.debug.firstProduct && config.debug.firstProduct !== '';
                  
                  
                  // Use multiple checks to ensure we have products
                  const shouldProceed = (hasProducts && hasValidProducts) || (debugHasProducts && debugFirstProduct);
                  
                  if (shouldProceed) {
                    showStep(2);
                    loadBundleProduct(0);
                  } else {
                    alert('Ch∆∞a c√≥ s·∫£n ph·∫©m bundle ƒë∆∞·ª£c c·∫•u h√¨nh!\n\nƒê·ªÉ th√™m s·∫£n ph·∫©m v√†o bundle:\n1. V√†o Theme Editor\n2. Ch·ªçn section "Product Bundle"\n3. Trong settings, t√¨m "Bundle Products"\n4. Click "Change" v√† ch·ªçn c√°c s·∫£n ph·∫©m mu·ªën th√™m v√†o bundle');
                  }
                }

    // Quantity selector
    if (e.target.closest('.quantity-display')) {
      e.preventDefault();
      const dropdown = e.target.closest('.quantity-dropdown');
      dropdown.classList.toggle('active');
    }
    
    if (e.target.closest('.quantity-option')) {
      e.preventDefault();
      const option = e.target.closest('.quantity-option');
      const newQuantity = parseInt(option.getAttribute('data-value'));
      const dropdown = option.closest('.quantity-dropdown');
      const display = dropdown.querySelector('.quantity-text');
      
      // Update display
      if (display) {
        display.textContent = newQuantity;
      }
      
      // Update data attribute
      dropdown.querySelector('.quantity-display').setAttribute('data-quantity', newQuantity);
      
      // Update selected state
      dropdown.querySelectorAll('.quantity-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      option.classList.add('selected');
      
      // Close dropdown
      dropdown.classList.remove('active');
      
      // Update bundle quantity
      bundleState.bundleQuantity = newQuantity;
      
      // Re-render bundle summary with new quantity
      if (bundleState.currentStep === 3) {
        renderBundleSummary();
      }
    }
    
    // Close dropdown when clicking outside
    if (!e.target.closest('.quantity-dropdown')) {
      container.querySelectorAll('.quantity-dropdown').forEach(dropdown => {
        dropdown.classList.remove('active');
      });
    }

    // Back button (only for step 2)
    if (e.target.closest('.bundle-back-btn')) {
      e.preventDefault();
      if (bundleState.currentStep === 2) {
        // Quay l·∫°i s·∫£n ph·∫©m tr∆∞·ªõc ƒë√≥ trong bundle
        if (bundleState.currentProductIndex > 0) {
          bundleState.currentProductIndex--;
          loadBundleProduct(bundleState.currentProductIndex);
        } else {
          // N·∫øu ƒëang ·ªü s·∫£n ph·∫©m ƒë·∫ßu ti√™n, quay l·∫°i step 1
          showStep(1);
        }
      } else if (bundleState.currentStep > 1) {
        showStep(bundleState.currentStep - 1);
      }
    }

    // Continue button
    if (e.target.closest('.bundle-continue-btn')) {
      e.preventDefault();
      
      if (bundleState.currentStep === 2) {
        console.log('=== CONTINUE BUTTON CLICKED ===');
        
        // CRITICAL: Save current product selection BEFORE moving to next product
        const currentProduct = config.bundleProducts[bundleState.currentProductIndex];
        if (currentProduct) {
          console.log('Saving current product selection:', currentProduct.title);
          
          // Get selected variant from ProductSelect
          const productSelect = container.querySelector(`#ProductSelect-bundle-${currentProduct.id}`);
          if (productSelect && productSelect.value) {
            const selectedVariantId = productSelect.value;
            const selectedVariant = currentProduct.variants.find(v => v.id.toString() === selectedVariantId.toString());
            
            console.log('Selected variant ID:', selectedVariantId);
            console.log('Selected variant:', selectedVariant);
            
            if (selectedVariant) {
              // Get variant image
              let variantImage = extractImageUrl(currentProduct.featured_image);
              if (selectedVariant.featured_image) {
                variantImage = extractImageUrl(selectedVariant.featured_image);
              }
              
              // Check if this product already exists in bundle state
              const existingIndex = bundleState.selectedProducts.bundle.findIndex(p => p.productId === currentProduct.id);
              
              // Determine quantity based on product index (0-based, so index 2 = product 3)
              const productQuantity = bundleState.currentProductIndex === 2 ? (config.product3Quantity || 2) : 1;
              
              const productData = {
                productId: currentProduct.id,
                productHandle: currentProduct.handle,
                productTitle: currentProduct.title,
                image: variantImage,
                variantId: selectedVariant.id,
                variantTitle: selectedVariant.title,
                variantPrice: selectedVariant.price,
                compareAtPrice: selectedVariant.compare_at_price,
                variantOptions: selectedVariant.options,
                quantity: productQuantity
              };
              
              if (existingIndex >= 0) {
                // Update existing product
                bundleState.selectedProducts.bundle[existingIndex] = productData;
                console.log('‚úÖ Updated existing product in bundle state');
              } else {
                // Add new product
                bundleState.selectedProducts.bundle.push(productData);
                console.log('‚úÖ Added new product to bundle state');
              }
              
              console.log('Current bundle state:', bundleState.selectedProducts.bundle);
            }
          }
        }
        
        // Now move to next product or step 3
        if (bundleState.currentProductIndex < config.bundleProducts.length - 1) {
          bundleState.currentProductIndex++;
          loadBundleProduct(bundleState.currentProductIndex);
        } else {
          console.log('All products selected, moving to step 3');
          console.log('Final bundle state:', bundleState.selectedProducts.bundle);
          showStep(3);
          renderBundleSummary();
        }
      }
    }

    // Buy now button
    if (e.target.closest('.bundle-buy-now-btn')) {
      e.preventDefault();
      buyBundleNow();
    }
    
    // Change product link
    if (e.target.closest('.bundle-product-change-link')) {
      e.preventDefault();
      const changeLink = e.target.closest('.bundle-product-change-link');
      const productIndex = parseInt(changeLink.getAttribute('data-product-index'));
      console.log('Change product clicked for index:', productIndex);
      changeProduct(productIndex);
    }
  }

  function showStep(step) {
    bundleState.currentStep = step;
    
    // Hide all steps
    container.querySelectorAll('.bundle-step').forEach(el => {
      el.style.display = 'none';
    });
    
    // Show current step
    const currentStepEl = container.querySelector(`[data-step="${step}"]`);
    if (currentStepEl) {
      currentStepEl.style.display = 'block';
    }
    
    // Initialize step 2 - t·ª± ƒë·ªông ch·ªçn s·∫£n ph·∫©m ƒë·∫ßu ti√™n
    if (step === 2) {
      console.log('=== INITIALIZING STEP 2 ===');
      
      // T·ª± ƒë·ªông ch·ªçn s·∫£n ph·∫©m ƒë·∫ßu ti√™n n·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn
      if (bundleState.selectedProducts.bundle.length === 0 && config.bundleProducts && config.bundleProducts.length > 0) {
        console.log('Auto-selecting first bundle product...');
        const firstProduct = config.bundleProducts[0];
        
        // T·∫°o s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh v·ªõi variant ƒë·∫ßu ti√™n
        const defaultVariant = firstProduct.variants && firstProduct.variants.length > 0 ? firstProduct.variants[0] : null;
        const defaultImage = extractImageUrl(firstProduct.featured_image) || 
                            (firstProduct.media && firstProduct.media.length > 0 ? extractImageUrl(firstProduct.media[0]) : '');
        
        // Determine quantity based on product index
        const productQuantity = bundleState.currentProductIndex === 2 ? (config.product3Quantity || 2) : 1;
        
        const autoSelectedProduct = {
          productId: firstProduct.id,
          productHandle: firstProduct.handle,
          productTitle: firstProduct.title,
          image: defaultImage,
          variantId: defaultVariant ? defaultVariant.id : null,
          variantTitle: defaultVariant ? defaultVariant.title : 'Default Title',
          variantPrice: defaultVariant ? defaultVariant.price : firstProduct.price,
          compareAtPrice: defaultVariant ? defaultVariant.compare_at_price : firstProduct.compare_at_price,
          variantOptions: defaultVariant ? defaultVariant.options : [],
          quantity: productQuantity
        };
        
        bundleState.selectedProducts.bundle.push(autoSelectedProduct);
        console.log('‚úÖ Auto-selected first product:', autoSelectedProduct);
      }
      
      // Load the first bundle product
      console.log('Loading first bundle product...');
      loadBundleProduct(0);
      
      // Initialize sticky columns for step 2
      setTimeout(() => {
        initializeStep2StickyColumns();
      }, 100);
    }
    
    // Initialize step 3 if needed
    if (step === 3) {
      console.log('=== INITIALIZING STEP 3 ===');
      
      // Initialize quantity selector
      initializeQuantitySelector();
      
      // Ensure first slide is visible
      const firstSlide = currentStepEl.querySelector('.product-main-slide');
      if (firstSlide) {
        firstSlide.style.display = 'block';
        console.log('‚úÖ First slide made visible');
      }
      
      // Ensure first thumbnail is active
      const firstThumb = currentStepEl.querySelector('[data-product-thumb]');
      if (firstThumb) {
        firstThumb.classList.add('active');
        console.log('‚úÖ First thumbnail made active');
      }
      
      // Check if thumbnails exist
      const thumbnails = currentStepEl.querySelectorAll('[data-product-thumb]');
      console.log('Found thumbnails in step 3:', thumbnails.length);
      
      // Check if product__thumbs--scroller exists
      const scroller = currentStepEl.querySelector('.product__thumbs--scroller');
      console.log('Found product__thumbs--scroller:', !!scroller);
      
      if (scroller) {
        console.log('Scroller innerHTML length:', scroller.innerHTML.length);
        console.log('Scroller children count:', scroller.children.length);
      }
    }
  }

  async function loadBundleProduct(index) {
    console.log('=== LOAD BUNDLE PRODUCT DEBUG ===');
    console.log('Index:', index);
    console.log('Config bundleProducts:', config.bundleProducts);
    console.log('Config bundleProducts length:', config.bundleProducts.length);
    console.log('Config bundleProducts type:', typeof config.bundleProducts);
    
    const product = config.bundleProducts[index];
    console.log('Product at index', index, ':', product);
    
    if (!product) {
      console.error('No product found at index:', index);
      return;
    }

    bundleState.currentProductIndex = index;
    
    // Update progress
    const progressCurrent = container.querySelector('.bundle-progress-current');
    const progressTotal = container.querySelector('.bundle-progress-total');
    if (progressCurrent) {
      progressCurrent.textContent = index + 1;
    }
    if (progressTotal) {
      progressTotal.textContent = config.bundleProducts.length;
    }

    // Step 2: Fetch real product data from Shopify and render images
    const step2ImageColumn = document.getElementById('Step2ImageColumn-{{ section.id }}');
    console.log('Step 2 Image Column found:', !!step2ImageColumn);
    console.log('Product handle:', product.handle);
    
    if (step2ImageColumn && product && product.handle) {
      // Fetch real product data from Shopify (with caching)
      fetchShopifyProduct(product.handle)
        .then(productData => {
          console.log('üéØ Product Data:', productData);
          console.log('üéØ Media:', productData.media);
          
          const imageHTML = renderProductImagesHTML(productData, '{{ section.id }}', 'step2');
          step2ImageColumn.innerHTML = imageHTML;
          console.log('‚úÖ Step 2 images rendered');
          
          // Debug CSS after rendering
          setTimeout(() => {
            const slides = step2ImageColumn.querySelectorAll('.product-main-slide');
            const images = step2ImageColumn.querySelectorAll('img');
            console.log('üîç Step 2 Debug - Slides found:', slides.length);
            console.log('üîç Step 2 Debug - Images found:', images.length);
            
            slides.forEach((slide, idx) => {
              const computedStyle = window.getComputedStyle(slide);
              console.log(`üîç Slide ${idx}:`, {
                display: computedStyle.display,
                visibility: computedStyle.visibility,
                opacity: computedStyle.opacity,
                classes: slide.className
              });
            });
            
            images.forEach((img, idx) => {
              const computedStyle = window.getComputedStyle(img);
              console.log(`üîç Image ${idx}:`, {
                display: computedStyle.display,
                visibility: computedStyle.visibility,
                opacity: computedStyle.opacity,
                src: img.src,
                loaded: img.complete
              });
            });
          }, 100);
          
          // Initialize Flickity if carousel is enabled
          if ({{ section.settings.product_carousel_enable | json }}) {
            initializeFlickityForStep(step2ImageColumn, 'step2');
            console.log('‚úÖ Flickity initialized for Step 2');
          }
        })
        .catch(error => {
          console.error('‚ùå Error fetching product data:', error);
          step2ImageColumn.innerHTML = '<p>Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh s·∫£n ph·∫©m</p>';
        });
    } else {
      console.error('‚ùå Cannot render Step 2 images:', {
        hasColumn: !!step2ImageColumn,
        hasProduct: !!product,
        hasHandle: !!(product && product.handle)
      });
    }

    // Render product info in the right column
    const productsGrid = container.querySelector('.bundle-products-grid');
    console.log('Products grid element:', productsGrid);
    
    if (productsGrid) {
      try {
            console.log('Loading bundle product:', product.handle);
    console.log('Product data:', {
      title: product.title,
      price: product.price,
      description: product.description,
      variants: product.variants,
      featured_image: product.featured_image
    });
    
    // Debug variant structure
    if (product.variants && product.variants.length > 0) {
      console.log('Product variants count:', product.variants.length);
      console.log('First variant:', product.variants[0]);
      console.log('First variant options:', product.variants[0].options);
      console.log('Product options:', product.options);
    }
        
        // Use simplified product template structure for right column only
        const productHTML = `
          <div class="bundle-product-item" data-product-handle="${product.handle}" data-section-id="${config.sectionId}" data-product-id="${product.id}">
                      <!-- Product Header -->
                      <div class="product-block product-block--header">
                        <h1 class="h2 product-single__title">${product.title}</h1>
                      </div>

                      <!-- Price Block -->
                      <div class="product-block product-block--price">
                        <div class="price-container-wrapper">
                          <span class="product__price text-2xl f-smb" data-product-price data-product-price-base="${product.price}">
                            ${formatMoney(product.price)}
                          </span>
                          ${product.compare_at_price ? `
                            <span class="product__price product__price--compare text-xl" data-compare-price>
                              ${formatMoney(product.compare_at_price)}
                            </span>
                            <div class="product__discount-badge">
                              -${Math.round((product.compare_at_price - product.price) / product.compare_at_price * 100)}%
                            </div>
                          ` : ''}
                        </div>
                        

                      </div>


                      <!-- Hidden ProductSelect for variant tracking -->
                      <select name="id" id="ProductSelect-bundle-${product.id}" class="product-single__variants" style="display: none;">
                        ${product.variants.map(variant => `
                          <option value="${variant.id}" ${variant.available ? '' : 'disabled'} data-variant-price="${variant.price}" data-variant-compare-price="${variant.compare_at_price || ''}">
                            ${variant.title}
                          </option>
                        `).join('')}
                      </select>
                      
                      <!-- Hidden Sticky ProductSelect for variant tracking -->
                      <select name="id" id="ProductSelect-bundle-${product.id}-sticky" class="product-single__variants" style="display: none;">
                        ${product.variants.map(variant => `
                          <option value="${variant.id}" ${variant.available ? '' : 'disabled'} data-variant-price="${variant.price}" data-variant-compare-price="${variant.compare_at_price || ''}">
                            ${variant.title}
                          </option>
                        `).join('')}
                      </select>

                      <!-- Variant Picker - Using existing structure -->
                      ${product.variants && product.variants.length > 1 ? `
                        <div class="product-block" data-dynamic-variants-enabled>
                          ${(() => {
                            const options = [];
                            if (product.options && product.options.length > 0) {
                              product.options.forEach((option, optionIndex) => {
                                options.push({
                                  name: option.name,
                                  values: option.values,
                                  index: optionIndex
                                });
                              });
                            }
                            return options.map(option => {
                              const isColor = option.name.toLowerCase().includes('color') || option.name.toLowerCase().includes('m√†u') || option.name.toLowerCase().includes('colour');
                              const isSize = option.name.toLowerCase().includes('size') || 
                                            option.name.toLowerCase().includes('k√≠ch th∆∞·ªõc') ||
                                            option.name.toLowerCase().includes('k√≠ch th∆∞·ªõc') ||
                                            option.name.toLowerCase().includes('k√≠ch th∆∞·ªõc');
                              
                              let labelHtml = '<label class="variant__label" for="ProductSelect-bundle-' + product.id + '-option-' + option.index + '">' + option.name + ':';
                              // Always add variant label info for all options
                              labelHtml += '<span class="variant__label-info" data-index="' + option.index + '"><span data-variant-selected-label>' + option.values[0] + '</span></span>';
                              labelHtml += '</label>';
                                                            
                              // Add size lock note for non-first products
                              if (isSize && bundleState.currentProductIndex > 0 && bundleState.lockedSize) {
                                const firstProduct = config.bundleProducts[0];
                                const firstProductTitle = firstProduct ? firstProduct.title : 'S·∫£n ph·∫©m ƒë·∫ßu ti√™n';
                                labelHtml += '<div class="size-lock-note" style="font-size: 12px; color: #6B7280; margin-top: 4px; font-style: italic;">B·∫°n ƒë√£ ch·ªçn size <strong>' + bundleState.lockedSize + '</strong> ·ªü ' + firstProductTitle + '</div>';
                              }

                              let fieldsetHtml = '<fieldset class="variant-input-wrap flex ai-center gap-x-md flex-wrap" name="' + option.name + '" data-index="option' + (option.index + 1) + '" data-handle="' + option.name.toLowerCase().replace(/\s+/g, '-') + '" data-option-count="' + option.values.length + '" id="ProductSelect-bundle-' + product.id + '-option-' + option.index + '"><legend class="hide">' + option.name + '</legend>';
                              fieldsetHtml += option.values.map((value, valueIndex) => {
                                const variant = product.variants.find(v => v.options[option.index] === value);
                                const isAvailable = variant && variant.available !== false;
                                const disabledClass = !isAvailable ? ' disabled' : '';
                                const checked = valueIndex === 0 ? 'checked="checked"' : '';
                                
                                if (isColor) {
                                  // Chu·∫©n h√≥a t√™n m√†u cho file PNG
                                  const colorValue = value.toLowerCase().replace(/\s+/g, '-');
                                  const colorFileName = colorValue + '_50x50.png';
                                  // ƒê∆∞·ªùng d·∫´n CDN ƒë√∫ng chu·∫©n Shopify theme (t·ª± ƒë·ªông l·∫•y file n·∫øu c√≥, fallback n·∫øu kh√¥ng)
                                  const colorImageUrl = `https://ru9.vn/cdn/shop/files/${colorFileName}`;
                                  // Fallback m√†u cu·ªëi c√πng n·∫øu kh√¥ng c√≥ ·∫£nh
                                  const colorSwatchFallback = value.split(' ').pop().toLowerCase();
                                  
                                  return '<div class="variant-input" data-index="option' + (option.index + 1) + '" data-value="' + value + '">' +
                                    '<input type="radio" ' + checked + ' value="' + value + '" data-index="option' + (option.index + 1) + '" name="' + option.name + '-' + product.id + '" data-variant-input class="variant__input--color-swatch' + (!isAvailable ? ' disabled' : '') + '" data-color-name="' + value + '" data-color-index="' + option.index + '" id="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '">' +
                                    '<label for="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '" class="variant__button-label color-swatch color-swatch--' + colorValue + disabledClass + '" style="background-color: ' + colorSwatchFallback + '; background-image: url(' + colorImageUrl + ') !important;" title="' + value + '"></label></div>';
                                } else if (isSize) {
                                  // Parse size value to separate name and dimensions
                                  let sizeName = value;
                                  let sizeDimensions = '';
                                  
                                  // Check if value contains dimensions (e.g., "Single + 120 x 200cm")
                                  if (value.includes('+') || value.includes('x') || value.includes('cm')) {
                                    // Split by common separators
                                    const parts = value.split(/[\+\-\‚Äì]/);
                                    if (parts.length >= 2) {
                                      sizeName = parts[0].trim();
                                      sizeDimensions = parts.slice(1).join(' ').trim();
                                    } else if (value.includes('x') && value.includes('cm')) {
                                      // Try to extract dimensions from format like "120 x 200cm"
                                      const dimensionMatch = value.match(/(\d+\s*x\s*\d+cm)/);
                                      if (dimensionMatch) {
                                        sizeDimensions = dimensionMatch[1];
                                        sizeName = value.replace(dimensionMatch[1], '').trim();
                                      }
                                    }
                                  }
                                  
                                  return '<div class="variant-input" data-index="option' + (option.index + 1) + '" data-value="' + value + '">' +
                                    '<input type="radio" ' + checked + ' value="' + value + '" data-index="option' + (option.index + 1) + '" name="' + option.name + '" data-variant-input class="variant__input--pill' + (!isAvailable ? ' disabled' : '') + '" data-value-name="' + value + '" data-value-index="' + option.index + '" id="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '">' +
                                    '<label for="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '" class="variant__button-label t-center' + disabledClass + '">' +
                                    '<span class="label-head block text-sm f-smb">' + sizeName + '</span>' +
                                    (sizeDimensions ? '<span class="label-value block text-xs">' + sizeDimensions + '</span>' : '') +
                                    '</label></div>';
                                } else {
                                  return '<div class="variant-input" data-index="option' + (option.index + 1) + '" data-value="' + value + '">' +
                                    '<input type="radio" ' + checked + ' value="' + value + '" data-index="option' + (option.index + 1) + '" name="' + option.name + '" data-variant-input class="variant__input' + (!isAvailable ? ' disabled' : '') + '" id="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '">' +
                                    '<label for="ProductSelect-bundle-' + product.id + '-option-' + option.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-') + '" class="variant__button-label' + disabledClass + '">' + value + '</label></div>';
                                }
                              }).join('');
                              fieldsetHtml += '</fieldset>';
                              return '<div class="variant-wrapper js ' + option.name.toLowerCase().replace(/\s+/g, '-') + (isSize ? ' size' : '') + (isColor ? ' color' : '') + '" data-type="button">' + labelHtml + fieldsetHtml + '</div>';
                            }).join('');
                          })()}
                        </div>
                      ` : ''}

                      <!-- Navigation Buttons -->
                      <div class="product-block">
                        <div class="bundle-navigation">
                          <button type="button" class="btn btn--secondary bundle-back-btn">Quay l·∫°i</button>
                          <button type="button" class="btn btn--primary bundle-continue-btn">Ti·∫øp t·ª•c</button>
                        </div>
                      </div>

                      <!-- Product Summary Block -->
                      <div class="product-block product-summary-block">
                        <div class="product-summary-content">
                          <!-- Description Accordion -->
                          <details class="product-accordion product-accordion--styled" open>
                            <summary>
                              <span>M√¥ t·∫£ s·∫£n ph·∫©m</span>
                              <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </summary>
                            <div class="product-accordion-content rte">
                              ${product.description}
                            </div>
                          </details>

                          <!-- Store System Accordion -->
                          {%- if section.settings.store_system_content != blank -%}
                          <details class="product-accordion product-accordion--styled">
                            <summary>
                              <span>H·ªá th·ªëng c·ª≠a h√†ng</span>
                              <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </summary>
                              <div class="product-accordion-content rte">
                                {{ section.settings.store_system_content }}
                                </div>
                            </details>
                                {%- endif -%}
                                </div>
                      </div>

                      <!-- Service Grid -->
                      <div class="product-block product-block--service-grid">
                        <div class="service-grid-wrapper">
                          <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="service-grid-item">
                              <div class="service-item">
                                <div class="service-item__icon">
                                  {%- if section.settings.service_icon_1 -%}
                                    <img src="{{ section.settings.service_icon_1 | image_url: width: 40 }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                                  {%- else -%}
                                    <img src="{{ 'Layer_1_3.svg' | asset_url }}" alt="{{ section.settings.service_text_1 | default: '100 ƒë√™m ng·ªß th·ª≠' }}" width="40" height="40">
                                  {%- endif -%}
                                </div>
                                <div class="service-item__text">
                                  <p>{{ section.settings.service_text_1 | default: "100 ƒë√™m ng·ªß th·ª≠" }}</p>
                                </div>
                              </div>
                            </div>
                            <div class="service-grid-item">
                              <div class="service-item">
                                <div class="service-item__icon">
                                  {%- if section.settings.service_icon_2 -%}
                                    <img src="{{ section.settings.service_icon_2 | image_url: width: 40 }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                                  {%- else -%}
                                    <img src="{{ 'Layer_1_4.svg' | asset_url }}" alt="{{ section.settings.service_text_2 | default: 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn' }}" width="40" height="40">
                                  {%- endif -%}
                                </div>
                                <div class="service-item__text">
                                  <p>{{ section.settings.service_text_2 | default: "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn" }}</p>
                                </div>
                              </div>
                            </div>
                            <div class="service-grid-item">
                              <div class="service-item">
                                <div class="service-item__icon">
                                  {%- if section.settings.service_icon_3 -%}
                                    <img src="{{ section.settings.service_icon_3 | image_url: width: 40 }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                                  {%- else -%}
                                    <img src="{{ 'Layer_1_5.svg' | asset_url }}" alt="{{ section.settings.service_text_3 | default: 'B·∫£o h√†nh d√†i l√¢u' }}" width="40" height="40">
                                  {%- endif -%}
                                </div>
                                <div class="service-item__text">
                                  <p>{{ section.settings.service_text_3 | default: "B·∫£o h√†nh d√†i l√¢u" }}</p>
                                </div>
                              </div>
                            </div>
                            <div class="service-grid-item">
                              <div class="service-item">
                                <div class="service-item__icon">
                                  {%- if section.settings.service_icon_4 -%}
                                    <img src="{{ section.settings.service_icon_4 | image_url: width: 40 }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                                  {%- else -%}
                                    <img src="{{ 'Layer_1_6.svg' | asset_url }}" alt="{{ section.settings.service_text_4 | default: 'Thanh to√°n linh ho·∫°t' }}" width="40" height="40">
                                  {%- endif -%}
                                </div>
                                <div class="service-item__text">
                                  <p>{{ section.settings.service_text_4 | default: "Thanh to√°n linh ho·∫°t" }}</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

            </div>
          </div>
        `;
        
        console.log('Generated HTML:', productHTML);
        productsGrid.innerHTML = productHTML;
        
        console.log('HTML set successfully. Products grid innerHTML length:', productsGrid.innerHTML.length);
        console.log('Products grid children count:', productsGrid.children.length);
        

        
        // Initialize variant picker
        const productContainer = productsGrid.querySelector('.bundle-product-item');
        if (productContainer) {
          initializeBundleProductVariantPicker(productContainer);
          
          // INITIAL SYNC: Update option2 availability based on default option1
          setTimeout(() => {
            const firstOption1Input = productContainer.querySelector('[data-variant-input][data-index="option1"]:checked');
            if (firstOption1Input) {
              console.log('üîÑ Initial sync: Triggering option1 change to update option2...');
              firstOption1Input.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }, 200);
        }
    
        // Update progress
        updateBundleProgress();
      } catch (error) {
        console.error('Error loading bundle product:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          product: product
        });
        // Show error message
        productsGrid.innerHTML = `
          <div class="bundle-product-item" data-product-handle="${product.handle}">
            <div class="error-message" style="text-align: center; padding: 2rem; color: red;">
              <h3>L·ªói t·∫£i s·∫£n ph·∫©m</h3>
              <p>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m: ${product.title}</p>
              <p>L·ªói: ${error.message}</p>
            </div>
          </div>
        `;
      }
    }
  }

  function updateBundleProgress() {
    const progressCurrent = container.querySelector('.bundle-progress-current');
    const progressTotal = container.querySelector('.bundle-progress-total');
    
    if (progressCurrent) {
      progressCurrent.textContent = bundleState.currentProductIndex + 1;
    }
    if (progressTotal) {
      progressTotal.textContent = config.bundleProducts.length;
    }
  }



  // Helper function to extract image URL from various formats
  function extractImageUrl(imageData) {
    if (!imageData) return '';
    
    // If it's already a string URL, return it
    if (typeof imageData === 'string') {
      return imageData;
    }
    
    // If it's an object, try to extract the URL
    if (typeof imageData === 'object') {
      // Try different possible properties
      return imageData.src || 
             imageData.url || 
             imageData.preview_image || 
             imageData.featured_image ||
             (imageData.media && imageData.media.length > 0 ? imageData.media[0].src : '') ||
             '';
    }
    
    return '';
  }

  function renderBundleSummary() {
    const summaryProducts = container.querySelector('.bundle-summary-products');
    const bundlePhotos = container.querySelector('#BundlePhotos-{{ section.id }}');
    
    console.log('=== RENDER BUNDLE SUMMARY DEBUG ===');
    console.log('summaryProducts found:', !!summaryProducts);
    console.log('bundlePhotos found:', !!bundlePhotos);
    
    if (!summaryProducts) return;

    let totalOriginal = 0;
    let totalFinal = 0;

    // Add main product - use selected variant if available
    console.log('=== MAIN PRODUCT DEBUG ===');
    console.log('bundleState.selectedProducts.main:', bundleState.selectedProducts.main);
    
    const mainProduct = {
      productTitle: {{ product.title | json }},
      variantTitle: bundleState.selectedProducts.main.variantTitle || {{ current_variant.title | json }},
      variantOptions: bundleState.selectedProducts.main.variantOptions || {{ current_variant.options | json }},
      quantity: bundleState.selectedProducts.main.quantity || 1,
      price: bundleState.selectedProducts.main.variantPrice || {{ current_variant.price | json }},
      image: extractImageUrl(bundleState.selectedProducts.main.image) || extractImageUrl({{ product.featured_image | json }})
    };
    
    console.log('=== MAIN PRODUCT PRICE DEBUG ===');
    console.log('bundleState.selectedProducts.main:', bundleState.selectedProducts.main);
    console.log('mainProduct.price:', mainProduct.price);
    console.log('mainProduct.price type:', typeof mainProduct.price);
    
    console.log('Final mainProduct:', mainProduct);

    // Add bundle products - ensure we use variantPrice and compareAtPrice
    const bundleProductsWithCorrectPrice = bundleState.selectedProducts.bundle.map(product => ({
      ...product,
      price: product.variantPrice || product.price, // Gi√° sau gi·∫£m (price)
      compareAtPrice: product.compareAtPrice || product.variantPrice || product.price, // Gi√° g·ªëc (compare_at_price)
      image: extractImageUrl(product.image) // Extract proper image URL
    }));
    
    console.log('=== PRICE MAPPING DEBUG ===');
    bundleState.selectedProducts.bundle.forEach((originalProduct, index) => {
      const mappedProduct = bundleProductsWithCorrectPrice[index];
      console.log(`Product ${index} price mapping:`, {
        title: originalProduct.productTitle,
        variantPrice: originalProduct.variantPrice,
        compareAtPrice: originalProduct.compareAtPrice,
        mappedPrice: mappedProduct.price,
        mappedCompareAtPrice: mappedProduct.compareAtPrice,
        variantTitle: originalProduct.variantTitle
      });
    });
    
    // Ch·ªâ t√≠nh c√°c s·∫£n ph·∫©m bundle ƒë∆∞·ª£c ch·ªçn t·ª´ step 2, kh√¥ng t√≠nh s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh t·ª´ step 1
    const allProducts = [...bundleProductsWithCorrectPrice];
    
    console.log('=== ALL PRODUCTS DEBUG ===');
    console.log('mainProduct (kh√¥ng t√≠nh v√†o bundle):', mainProduct);
    console.log('bundleState.selectedProducts.bundle:', bundleState.selectedProducts.bundle);
    console.log('allProducts (ch·ªâ s·∫£n ph·∫©m bundle ƒë∆∞·ª£c ch·ªçn):', allProducts);
    console.log('allProducts length:', allProducts.length);
    
    // Debug each product's price
    allProducts.forEach((product, index) => {
      console.log(`Product ${index} price debug:`, {
        title: product.productTitle,
        price: product.price,
        priceType: typeof product.price,
        quantity: product.quantity,
        quantityType: typeof product.quantity,
        variantTitle: product.variantTitle,
        variantId: product.variantId
      });
    });
    
    // Debug bundle state specifically
    console.log('=== BUNDLE STATE PRICE DEBUG ===');
    bundleState.selectedProducts.bundle.forEach((product, index) => {
      console.log(`Bundle product ${index}:`, {
        title: product.productTitle,
        variantTitle: product.variantTitle,
        variantId: product.variantId,
        variantPrice: product.variantPrice,
        price: product.price,
        variantPriceType: typeof product.variantPrice,
        priceType: typeof product.price
      });
    });
    
    // Debug variant options for each product
    allProducts.forEach((product, index) => {
      console.log(`Product ${index} (${product.productTitle}):`, {
        variantTitle: product.variantTitle,
        variantOptions: product.variantOptions,
        hasVariantOptions: !!product.variantOptions,
        variantOptionsLength: product.variantOptions ? product.variantOptions.length : 0
      });
      
      // Debug the actual HTML generation for this product
      if (product.variantOptions && product.variantOptions.length > 0) {
        const generatedHTML = product.variantOptions.map((option, optionIndex) => {
          const optionName = optionIndex === 0 ? 'K√≠ch th∆∞·ªõc' : 
                            optionIndex === 1 ? 'M√†u s·∫Øc' : 
                            `T√πy ch·ªçn ${optionIndex + 1}`;
          return `${optionName}: ${option}`;
        }).join(', ');
        console.log(`  Generated HTML for product ${index}:`, generatedHTML);
      } else {
        console.log(`  Fallback HTML for product ${index}: Variant: ${product.variantTitle}`);
      }
    });
    
    // Calculate totals - 2 T·∫¶NG GI·∫¢M GI√Å
    console.log('=== CALCULATING BUNDLE TOTALS (NEW LOGIC) ===');
    
    // Get bundle quantity (default to 1 if not set)
    const bundleQuantity = bundleState.bundleQuantity || 1;
    console.log('Bundle quantity:', bundleQuantity);
    
    // Get target discount from config
    const targetDiscount = config.targetDiscountPercentage || 15;
    console.log('Target discount percentage:', targetDiscount + '%');
    
    // --- NEW CALCULATION LOGIC ---
    // This logic is now a DIRECT COPY of the theme editor's "runPricingCalculator" function
    // to ensure 100% consistency.
    let newTotalOriginal = 0;
    let totalAfter1stDiscount = 0;

    allProducts.forEach((product, index) => {
      const compareAtPrice = parseFloat(product.compareAtPrice) || parseFloat(product.price) || 0;
      const price = parseFloat(product.price) || 0;
      const quantity = parseInt(product.quantity) || 1;
      
      newTotalOriginal += compareAtPrice * quantity;
      totalAfter1stDiscount += price * quantity;
    });
    
    // 1. Calculate the ideal target price
    const targetFinalPriceIdeal = newTotalOriginal * (1 - targetDiscount / 100);
    
    // 2. Calculate the exact voucher discount needed
    const neededVoucherDiscountExact = totalAfter1stDiscount > 0 ? 
      ((totalAfter1stDiscount - targetFinalPriceIdeal) / totalAfter1stDiscount) * 100 : 0;
      
    // 3. Round the voucher discount to the nearest whole number
    const neededVoucherDiscountRounded = Math.round(neededVoucherDiscountExact);
    
    // 4. Calculate the actual final price using the rounded voucher discount
    const newTotalFinal = totalAfter1stDiscount * (1 - neededVoucherDiscountRounded / 100);

    // Apply the overall bundle quantity to the totals
    newTotalOriginal *= bundleQuantity;
    // newTotalFinal is already calculated based on per-bundle logic, so we just multiply it.
    let finalPriceWithQuantity = newTotalFinal * bundleQuantity;
    
    // Update totals for display
    totalOriginal = newTotalOriginal;
    totalFinal = finalPriceWithQuantity;
    
    // Update the badge to show the target discount, as per user request
    const effectiveDiscount = targetDiscount;

    console.log('--- BUNDLE PRICING DEBUG (STEP 3) ---');
    console.log('Target Discount:', targetDiscount + '%');
    console.log('T·ªïng Compare-at Price (Original):', totalOriginal);
    console.log('T·ªïng sau gi·∫£m gi√° t·∫ßng 1 (Sum of Prices):', totalAfter1stDiscount * bundleQuantity);
    console.log('Ideal Target Price:', targetFinalPriceIdeal * bundleQuantity);
    console.log('Needed Voucher Discount % (Rounded):', neededVoucherDiscountRounded);
    console.log('Actual Final Price (sau chi·∫øt kh·∫•u t·∫ßng 2):', totalFinal);
    // --- END NEW CALCULATION LOGIC ---
    
    // Voucher code is now displayed directly from Liquid template
    // No need for JavaScript manipulation since it's rendered from section.settings.voucher_code

    // Update bundle summary products (right side) - ch·ªâ hi·ªÉn th·ªã c√°c s·∫£n ph·∫©m bundle ƒë∆∞·ª£c ch·ªçn
    summaryProducts.innerHTML = allProducts.map((product, index) => {
      const productQty = product.quantity || 1;
      const showQuantity = productQty > 1;
      
      return `
        <div class="bundle-summary-product">
          <div class="bundle-product-number">${index + 1}.</div>
          <div class="bundle-product-content">
            <div class="bundle-product-info">
              <div class="bundle-product-title">
                ${product.productTitle}
                ${showQuantity ? `<span style="color: #234085; font-weight: 600;"> √ó ${productQty}</span>` : ''}
              </div>
              <div class="bundle-product-attributes">
                ${showQuantity ? `<div class="bundle-product-attribute">S·ªë l∆∞·ª£ng: ${productQty}</div>` : ''}
                ${product.variantOptions && product.variantOptions.length > 0 ? 
                  product.variantOptions.map((option, optionIndex) => {
                    const optionName = optionIndex === 0 ? 'K√≠ch th∆∞·ªõc' : 
                                      optionIndex === 1 ? 'M√†u s·∫Øc' : 
                                      `T√πy ch·ªçn ${optionIndex + 1}`;
                    return `<div class="bundle-product-attribute">${optionName}: ${option}</div>`;
                  }).join('') : 
                  `<div class="bundle-product-attribute">Variant: ${product.variantTitle}</div>`
                }
              </div>
              {% comment %} <div class="bundle-product-price">
                ${formatMoney(product.price * productQty)}
                ${product.compareAtPrice && product.compareAtPrice > product.price ? 
                  `<span class="bundle-product-compare-price">${formatMoney(product.compareAtPrice * productQty)}</span>` : 
                  ''}
              </div> {% endcomment %}
              <div class="bundle-product-change-link" data-product-index="${index}">Thay ƒë·ªïi</div>
            </div>
            <div class="bundle-product-image">
              <img src="${product.image}" alt="${product.productTitle}" width="80" height="80">
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    // Display summary
    console.log('=== BUNDLE PRICE SUMMARY ===');
    console.log('Total Original (compare_at_price):', totalOriginal);
    console.log('Total Final (sau 2 t·∫ßng gi·∫£m):', totalFinal);
    console.log('Display discount percentage:', targetDiscount + '%');
    
    const discountAmount = totalOriginal - totalFinal;
    console.log('Discount amount:', discountAmount);

    // Update totals in UI
    const originalTotalEl = container.querySelector('.bundle-original-total');
    const discountBadgeEl = container.querySelector('.bundle-discount-badge');
    const finalTotalEl = container.querySelector('.bundle-final-total');
    
    console.log('Price elements found:', {
      originalTotal: !!originalTotalEl,
      discountBadge: !!discountBadgeEl,
      finalTotal: !!finalTotalEl
    });
    
    // Update bundle-original-total (t·ªïng compare_at_price)
    if (originalTotalEl) {
      originalTotalEl.textContent = formatMoney(totalOriginal);
      console.log('‚úÖ Updated original total (compare_at_price):', formatMoney(totalOriginal));
    } else {
      console.log('‚ùå Original total element not found');
    }
    
    // Update bundle-discount-badge to show the TARGET discount, not the effective one
    if (discountBadgeEl) {
      discountBadgeEl.textContent = `-${targetDiscount}%`;
      console.log('‚úÖ Updated discount badge to target discount:', `-${targetDiscount}%`);
    } else {
      console.log('‚ùå Discount badge element not found');
    }
    
    // Update bundle-final-total (t·ªïng price)
    if (finalTotalEl) {
      finalTotalEl.textContent = formatMoney(totalFinal);
      console.log('‚úÖ Updated final total (price):', formatMoney(totalFinal));
    } else {
      console.log('‚ùå Final total element not found');
    }
    
    // Initialize thumbnail click events
    initializeBundleThumbnailEvents();
    
    // Initialize buy now button with direct event listener
    initializeBuyNowButton();
  }

  function initializeQuantitySelector() {
    console.log('=== INITIALIZING QUANTITY SELECTOR ===');
    
    const quantityDisplay = container.querySelector('.quantity-display');
    const quantityText = container.querySelector('.quantity-text');
    const quantityOptions = container.querySelectorAll('.quantity-option');
    
    if (quantityDisplay && quantityText) {
      // Set initial value
      const currentQuantity = bundleState.bundleQuantity || 1;
      quantityText.textContent = currentQuantity;
      quantityDisplay.setAttribute('data-quantity', currentQuantity);
      
      // Set selected state
      quantityOptions.forEach(option => {
        option.classList.remove('selected');
        if (parseInt(option.getAttribute('data-value')) === currentQuantity) {
          option.classList.add('selected');
        }
      });
      
      console.log('‚úÖ Quantity selector initialized with value:', currentQuantity);
    } else {
      console.log('‚ùå Quantity selector elements not found');
    }
  }

  function initializeBuyNowButton() {
    console.log('=== INITIALIZING BUY NOW BUTTON ===');
    
    // Try multiple selectors to find the buy now button
    const buyNowBtn = container.querySelector('.bundle-buy-now-btn') || 
                     container.querySelector('.btn--primary.bundle-buy-now-btn') ||
                     container.querySelector('button.bundle-buy-now-btn');
    
    console.log('Buy now button found:', !!buyNowBtn);
    console.log('Buy now button element:', buyNowBtn);
    
    if (buyNowBtn) {
      // Remove any existing event listeners
      buyNowBtn.removeEventListener('click', handleBuyNowClick);
      
      // Add direct event listener
      buyNowBtn.addEventListener('click', handleBuyNowClick);
      console.log('‚úÖ Buy now button event listener added');
      
      // Also add onclick attribute as fallback
      buyNowBtn.onclick = handleBuyNowClick;
      console.log('‚úÖ Buy now button onclick attribute added');
    } else {
      console.log('‚ùå Buy now button not found');
    }
  }
  
  function handleBuyNowClick(e) {
    console.log('=== BUY NOW BUTTON CLICKED ===');
    e.preventDefault();
    e.stopPropagation();
    console.log('Event:', e);
    console.log('Target:', e.target);
    buyBundleNow();
  }

  // Step 3 uses product-images snippet, no custom events needed

  function changeProduct(productIndex) {
    console.log('Changing product at index:', productIndex);
    
    // If it's the main product (index 0), go back to step 1
    if (productIndex === 0) {
      showStep(1);
      return;
    }
    
    // If it's a bundle product, go back to step 2 with the specific product
    const bundleIndex = productIndex - 1; // Convert to bundle array index
    if (bundleIndex >= 0 && bundleIndex < bundleState.selectedProducts.bundle.length) {
      bundleState.currentProductIndex = bundleIndex;
      showStep(2);
      return;
    }
  }

  function addBundleToCart() {
    console.log('=== ADD BUNDLE TO CART ===');
    
    
    console.log('Bundle state:', bundleState);
    console.log('Selected products:', bundleState.selectedProducts);
    
    const items = [];
    const bundleQty = bundleState.bundleQuantity || 1;
    const bundleId = Date.now();
    const voucherCode = config.voucherCode;
    
    console.log('Bundle quantity:', bundleQty);
    console.log('Bundle ID:', bundleId);
    
    // Add all bundle products to cart
    bundleState.selectedProducts.bundle.forEach((product, index) => {
      console.log(`Processing bundle product ${index}:`, product);
      
      if (product.variantId) {
        let properties = {
          '_bundle_id': bundleId,
          '_bundle_title': '{{ product.title }}',
          '_product_title': product.productTitle,
          '_variant_title': product.variantTitle || 'Default'
        };
        
        // Attach the voucher code as a property if it exists
        if (voucherCode && voucherCode.trim() !== '') {
          properties['_bundle_voucher'] = voucherCode.trim();
        }

        const bundleItem = {
          id: product.variantId,
          quantity: (product.quantity || 1) * bundleQty,
          properties: properties
        };
        items.push(bundleItem);
        console.log('‚úÖ Added item to cart array:', bundleItem);
      } else {
        console.log('‚ùå Product missing variantId:', product);
      }
    });

    console.log('Total items to add:', items.length);
    console.log('Items array:', items);

    if (items.length === 0) {
      console.error('‚ùå No items to add to cart!');
      alert('Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ th√™m v√†o gi·ªè h√†ng!');
      return;
    }

    console.log('Sending request to /cart/add.js...');

    fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ items: items })
    })
    .then(response => {
      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);
      
      if (!response.ok) {
        return response.text().then(text => {
          console.error('Response error text:', text);
          throw new Error(`HTTP error! status: ${response.status}, details: ${text}`);
        });
      }
      return response.json();
    })
    .then(data => {
      console.log('Cart API response:', data);
      
      if (data.status && data.status !== 200) {
        throw new Error(`Cart API error: ${data.description || 'Unknown error'}`);
      }
      
      console.log('‚úÖ Successfully added to cart!');
      
      
      // Auto-apply voucher code if bundle is complete
      if (voucherCode && voucherCode.trim() !== '') {
        console.log('Auto-applying voucher code:', voucherCode);
        autoApplyVoucherCode(voucherCode.trim());
      } else {
        console.log('‚ùå Voucher code not found or empty:', voucherCode);
      }
      
      // Update cart count
      if (typeof updateCartCount === 'function') {
        updateCartCount();
      }
      
      // Refresh cart drawer immediately
      refreshCartDrawer();
      
      // Show success message
      {% comment %} alert(`‚úÖ ƒê√£ th√™m ${items.length} s·∫£n ph·∫©m v√†o gi·ªè h√†ng!`); {% endcomment %}
    })
    .catch(error => {
      console.error('‚ùå Error adding to cart:', error);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack
      });
      alert(`L·ªói khi th√™m v√†o gi·ªè h√†ng: ${error.message}`);
    });
  }

  function autoApplyVoucherCode(voucherCode) {
    console.log('=== AUTO APPLY VOUCHER CODE ===');
    console.log('Voucher code:', voucherCode);
    
    // Apply voucher and store in bundle items in one go
    fetch('/cart/update.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 'discount': voucherCode })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Voucher application response:', data);
      
      if (!data.status && voucherCode) {
        // Store voucher directly in bundle items
        const bundleItems = data.items.filter(item => 
          item.properties && item.properties._bundle_id
        );
        
        if (bundleItems.length > 0) {
          // Update each bundle item to include voucher
          const updatePromises = bundleItems.map(item => {
            const updatedProperties = {
              ...item.properties,
              '_bundle_voucher': voucherCode,
              '_voucher_applied': 'true'
            };
            
            return fetch('/cart/change.js', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                id: item.key,
                properties: updatedProperties
              })
            });
          });
          
          Promise.all(updatePromises)
            .then(responses => {
              console.log('‚úÖ Voucher stored in bundle items');
              // Refresh cart once after all updates
              setTimeout(() => refreshCartDrawer(), 500);
            })
            .catch(error => {
              console.error('‚ùå Error storing voucher in items:', error);
              setTimeout(() => refreshCartDrawer(), 500);
            });
        }
      } else {
        console.log('‚ùå Auto voucher application failed:', data.description);
        setTimeout(() => refreshCartDrawer(), 500);
      }
    })
    .catch(error => {
      console.error('‚ùå Error auto-applying voucher:', error);
      setTimeout(() => refreshCartDrawer(), 500);
    });
  }


  function forceUpdateCartPrices(cartData) {
    // Force update cart drawer prices immediately
    if (typeof theme !== 'undefined' && typeof theme.CartForm === 'function') {
      const cartFormInstance = new theme.CartForm(document.getElementById('CartDrawerForm'));
      if (cartFormInstance && cartFormInstance.buildCart) {
        cartFormInstance.buildCart();
      }
    }
    
    // Also fetch fresh cart data and update
    fetch('/cart.js')
      .then(response => response.json())
      .then(freshCartData => {
        // Update cart drawer with fresh data
        if (typeof theme !== 'undefined' && typeof theme.CartForm === 'function') {
          const cartFormInstance = new theme.CartForm(document.getElementById('CartDrawerForm'));
          if (cartFormInstance && cartFormInstance.buildCart) {
            cartFormInstance.buildCart();
          }
        }
      })
      .catch(error => {
        console.error('‚ùå Error fetching fresh cart data:', error);
      });
    
    // Trigger custom event to update prices
    const cartUpdateEvent = new CustomEvent('cart:force-update', {
      detail: { cartData: cartData }
    });
    document.dispatchEvent(cartUpdateEvent);
    
    // Direct DOM update for cart totals
    if (cartData.total_price && cartData.original_total_price) {
      const totalPriceEl = document.querySelector('.cart-drawer__total-price, .cart__total-price, [data-cart-total]');
      const subtotalEl = document.querySelector('.cart-drawer__subtotal, .cart__subtotal, [data-cart-subtotal]');
      
      if (totalPriceEl) {
        const formattedTotal = new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: 'VND'
        }).format(cartData.total_price / 100);
        totalPriceEl.textContent = formattedTotal;
      }
      
      if (subtotalEl) {
        const formattedSubtotal = new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: 'VND'
        }).format(cartData.original_total_price / 100);
        subtotalEl.textContent = formattedSubtotal;
      }
      
      // Force update savings display
      const savingsAmount = cartData.original_total_price - cartData.total_price;
      if (savingsAmount > 0) {
        const savingsEl = document.querySelector('.cart-drawer__savings, .cart__savings, [data-savings-display]');
        if (savingsEl) {
          const formattedSavings = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
          }).format(savingsAmount / 100);
          savingsEl.textContent = formattedSavings;
        }
      }
    }
    
  }

  function refreshCartDrawer() {
    console.log('=== REFRESH CART DRAWER ===');
    
    // Use the same method as cart-drawer.liquid
    if (typeof theme !== 'undefined' && typeof theme.CartForm === 'function') {
      const cartFormInstance = new theme.CartForm(document.getElementById('CartDrawerForm'));
      cartFormInstance.buildCart();
      
      // Wait for cart to rebuild, then check for stored vouchers
      setTimeout(() => {
        console.log('Triggering bundle headers display...');
        
        // Trigger bundle header display manually
        const event = new CustomEvent('cart:updated');
        document.dispatchEvent(event);
        
        // Also check for stored bundle vouchers
        if (typeof checkStoredBundleVoucher === 'function') {
          checkStoredBundleVoucher();
        }
        
      }, 500);
    } else {
      // Fallback: reload the page
      window.location.href = window.location.href;
    }
    
    // Open the cart drawer
    openCartDrawer();
  }

  function openCartDrawer() {
    // Try multiple methods to open the cart drawer
    
    // Method 1: Try theme.Drawer if it exists
    if (typeof theme !== 'undefined' && theme.Drawer) {
      if (typeof theme.Drawer.open === 'function') {
        theme.Drawer.open('CartDrawer');
        return;
      }
    }
    
    // Method 2: Try to trigger cart drawer open event
    const cartDrawer = document.getElementById('CartDrawer');
    if (cartDrawer) {
      // Add active class to show drawer
      cartDrawer.classList.add('drawer--open', 'active', 'is-open');
      document.body.classList.add('drawer-open', 'cart-open');
      
      // Dispatch custom event
      document.dispatchEvent(new CustomEvent('cart:open'));
      window.dispatchEvent(new CustomEvent('drawer:open', { detail: { id: 'CartDrawer' } }));
      return;
    }
    
    // Method 3: Try to click cart icon to open drawer
    const cartTrigger = document.querySelector('[data-cart-drawer-toggle], .js-drawer-open-cart, .cart-icon, [href="#CartDrawer"]');
    if (cartTrigger) {
      cartTrigger.click();
      return;
    }
    
    // Method 4: Try to find and click any element that opens cart
    const cartButton = document.querySelector('button[aria-controls="CartDrawer"], [data-drawer-target="CartDrawer"]');
    if (cartButton) {
      cartButton.click();
    }
  }

  function initializeVariantPicker() {
    console.log('=== INITIALIZE VARIANT PICKER FOR MAIN PRODUCT ===');
    
    // Listen for variant changes on main product
    container.addEventListener('change', function(event) {
      if (event.target.closest('.bundle-step-1') && event.target.hasAttribute('data-variant-input')) {
        console.log('üîç Main product variant changed');
        
        // Get the selected variant
        const selectedVariant = event.target.closest('.bundle-step-1').querySelector('[data-variant-input]:checked');
        if (selectedVariant) {
          const variantId = selectedVariant.value;
          console.log('üîç Selected variant ID:', variantId);
          
          // Find the variant data
          const variant = {{ product.variants | json }}.find(v => v.id.toString() === variantId);
          if (variant) {
            console.log('üîç Found variant:', variant);
            
            // Update main product in bundle state
            bundleState.selectedProducts.main = {
              variantId: variant.id,
              variantTitle: variant.title,
              variantOptions: variant.options,
              variantPrice: variant.price,
              image: extractImageUrl(variant.featured_image) || extractImageUrl({{ product.featured_image | json }}),
              quantity: bundleState.selectedProducts.main.quantity
            };
            
            console.log('üîç Updated main product in bundle state:', bundleState.selectedProducts.main);
          }
        }
      }
      
      // Listen for variant changes on Step 2 bundle products
      if (event.target.closest('.bundle-step-2') && event.target.hasAttribute('data-variant-input')) {
        console.log('üîç Step 2 bundle product variant changed');
        
        // Get the selected variant
        const selectedVariant = event.target.closest('.bundle-step-2').querySelector('[data-variant-input]:checked');
        if (selectedVariant) {
          const variantId = selectedVariant.value;
          console.log('üîç Step 2 - Selected variant ID:', variantId);
          
          // Find the current product being edited
          const productContainer = event.target.closest('.bundle-product-item');
          if (productContainer) {
            const productId = productContainer.getAttribute('data-product-id');
            console.log('üîç Step 2 - Product ID:', productId);
            
            // Find the variant data from the current product
            const productData = bundleState.selectedProducts.bundle.find(p => p.id.toString() === productId);
            if (productData && productData.variants) {
              const variant = productData.variants.find(v => v.id.toString() === variantId);
              if (variant) {
                console.log('üîç Step 2 - Found variant:', variant);
                
                // Update the product in bundle state
                productData.variantId = variant.id;
                productData.variantTitle = variant.title;
                productData.variantOptions = variant.options;
                productData.variantPrice = variant.price;
                productData.image = extractImageUrl(variant.featured_image) || productData.image;
                
                console.log('üîç Step 2 - Updated product in bundle state:', productData);
                
                // Update the image display
                updateProductImageForStep2(productData);
              }
            }
          }
        }
      }
    });
  }

  // Update Step 2 images when variant changes
  function updateProductImageForStep2(productData) {
    const step2ImageColumn = document.getElementById('Step2ImageColumn-{{ section.id }}');
    if (step2ImageColumn && productData && productData.handle) {
      // Fetch real product data from Shopify (with caching)
      fetchShopifyProduct(productData.handle)
        .then(updatedProductData => {
          console.log('üîÑ Updated Product Data:', updatedProductData);
          
          const imageHTML = renderProductImagesHTML(updatedProductData, '{{ section.id }}', 'step2');
          step2ImageColumn.innerHTML = imageHTML;
          
          // Re-initialize Flickity if carousel is enabled
          if ({{ section.settings.product_carousel_enable | json }}) {
            initializeFlickityForStep(step2ImageColumn, 'step2');
          }
        })
        .catch(error => {
          console.error('‚ùå Error updating product images:', error);
        });
    }
  }

  function initializeBundleProductVariantPicker(container) {
    console.log('=== INITIALIZE BUNDLE PRODUCT VARIANT PICKER ===');
    
    const currentProduct = config.bundleProducts[bundleState.currentProductIndex];
    if (!currentProduct) {
      console.error('No current product found');
      return;
    }
    
    console.log('Initializing variant picker for product:', currentProduct.title);
    console.log('Product options:', currentProduct.options);
    console.log('Product variants:', currentProduct.variants);
    
    // Debug: Check if variants have correct structure
    if (currentProduct.variants && currentProduct.variants.length > 0) {
      console.log('First variant structure:', currentProduct.variants[0]);
      console.log('Variant options:', currentProduct.variants[0].options);
      
      // Debug all variants
      currentProduct.variants.forEach((variant, index) => {
        console.log(`Variant ${index}:`, {
          id: variant.id,
          title: variant.title,
          price: variant.price,
          options: variant.options,
          available: variant.available
        });
      });
    }
    
    // Use theme.js Variants class instead of custom logic
    const productSelect = container.querySelector(`#ProductSelect-bundle-${currentProduct.id}`);
    if (!productSelect) {
      console.error('ProductSelect not found');
      return;
    }
    
    // Initialize theme.js Variants class with correct parameters
    const variants = new theme.Variants({
      container: container,
      variants: currentProduct.variants,
      singleOptionSelector: '[data-variant-input]',
      originalSelectorId: `#ProductSelect-bundle-${currentProduct.id}`,
      originalSelectorIdSticky: `#ProductSelect-bundle-${currentProduct.id}-sticky`,
      enableHistoryState: false,
      dynamicVariantsEnabled: true
    });
    
    // Store variants instance for later use
    container.variantsInstance = variants;
    
    function syncVariantAvailability() {
      const productVariants = currentProduct.variants;
      const singleOptionSelector = '[data-variant-input]';
      const optionsContainer = container.querySelector('.product-form__controls');
      if (!optionsContainer) return;

      const getCurrentOptions = () => {
        const result = [];
        optionsContainer.querySelectorAll(`${singleOptionSelector}:checked`).forEach((el) => {
          result.push({
            value: el.value,
            index: el.dataset.index,
          });
        });
        return result;
      };

      const currentlySelectedValues = getCurrentOptions();
      const allOptionInputs = optionsContainer.querySelectorAll(singleOptionSelector);
      const optionKeys = [...new Set(Array.from(allOptionInputs, input => input.dataset.index))];

      optionKeys.forEach(optionKey => {
        const otherSelectedValues = currentlySelectedValues.filter(
          (option) => option.index !== optionKey
        );

        const possibleVariants = productVariants.filter(variant => {
          return otherSelectedValues.every(option => {
            return variant[option.index] === option.value;
          });
        });

        const availableValuesForOption = [...new Set(possibleVariants
          .filter(variant => variant.available)
          .map(variant => variant[optionKey]))];

        optionsContainer.querySelectorAll(`${singleOptionSelector}[data-index="${optionKey}"]`).forEach(input => {
          const wrapper = input.closest('.variant-input');
          const label = wrapper ? wrapper.querySelector('label') : null;
          if (availableValuesForOption.includes(input.value)) {
            input.disabled = false;
            if (wrapper) wrapper.classList.remove('disabled');
            if (label) label.classList.remove('disabled');
          } else {
            input.disabled = true;
            if (wrapper) wrapper.classList.add('disabled');
            if (label) label.classList.add('disabled');
          }
        });
      });
    }

    // Listen for variant changes to update the state and UI
    container.addEventListener('variantChange', (event) => {
      const { variant } = event.detail;
      if (variant) {
        bundleState.selectedProducts.bundle[bundleState.currentProductIndex].variantId = variant.id;
        bundleState.selectedProducts.bundle[bundleState.currentProductIndex].variantOptions = variant.options;

        const sizeOptionIndex = currentProduct.options.findIndex(opt =>
          opt.name.toLowerCase() === 'size' || opt.name.toLowerCase() === 'k√≠ch th∆∞·ªõc'
        );
        
        if (sizeOptionIndex !== -1) {
          const newSize = variant[`option${sizeOptionIndex + 1}`];
          if (bundleState.lockedSize !== newSize) {
            bundleState.lockedSize = newSize;
          }
        }
      }
      syncVariantAvailability();
      updateSummary();
    });
    
    // T·ª± ƒë·ªông ch·ªçn variant ƒë·∫ßu ti√™n khi kh·ªüi t·∫°o
    setTimeout(() => {
      console.log('=== AUTO-SELECTING FIRST VARIANT ===');
      
      // T√¨m t·∫•t c·∫£ c√°c option groups
      const optionGroups = container.querySelectorAll('.variant-wrapper');
      console.log('Found option groups:', optionGroups.length);
      
      optionGroups.forEach((optionGroup, groupIndex) => {
        // Check if this is a size option and we have a locked size
        const isSizeGroup = optionGroup.classList.contains('size') || 
                           optionGroup.querySelector('.variant__label')?.textContent.toLowerCase().includes('k√≠ch th∆∞·ªõc') ||
                           optionGroup.querySelector('.variant__label')?.textContent.toLowerCase().includes('size');
        
        if (isSizeGroup && bundleState.lockedSize && bundleState.currentProductIndex > 0) {
          // Auto-select the locked size for non-first products
          console.log(`üîí Auto-selecting locked size: ${bundleState.lockedSize} for product ${bundleState.currentProductIndex + 1}`);
          
          const sizeInputs = optionGroup.querySelectorAll('[data-variant-input]');
          
          // Improved matching logic for size inputs
          const matchingInput = Array.from(sizeInputs).find(input => {
            const inputValue = input.value;
            
            // Direct match
            if (inputValue === bundleState.lockedSize) {
              return true;
            }
            
            // Extract dimensions from both sizes
            const extractDimensions = (sizeStr) => {
              const dimensions = sizeStr.match(/(\d+)\s*x\s*(\d+)/i);
              if (dimensions) {
                return {
                  width: parseInt(dimensions[1]),
                  height: parseInt(dimensions[2])
                };
              }
              return null;
            };
            
            const lockedDimensions = extractDimensions(bundleState.lockedSize);
            const inputDimensions = extractDimensions(inputValue);
            
            // If both have dimensions, compare them
            if (lockedDimensions && inputDimensions) {
              return lockedDimensions.width === inputDimensions.width && 
                     lockedDimensions.height === inputDimensions.height;
            }
            
            // Fallback: check if both contain same size keywords
            const sizeKeywords = ['single', 'full', 'queen', 'king', '150', '180', '200', '220', '250', '300'];
            const lockedHasKeyword = sizeKeywords.some(keyword => 
              bundleState.lockedSize.toLowerCase().includes(keyword)
            );
            const inputHasKeyword = sizeKeywords.some(keyword => 
              inputValue.toLowerCase().includes(keyword)
            );
            
            if (lockedHasKeyword && inputHasKeyword) {
              // Check if they share any size keyword
              return sizeKeywords.some(keyword => 
                bundleState.lockedSize.toLowerCase().includes(keyword) && 
                inputValue.toLowerCase().includes(keyword)
              );
            }
            
            return false;
          });
          
          if (matchingInput && !matchingInput.disabled) {
            console.log(`üîí Found matching size input: ${matchingInput.value}`);
            matchingInput.checked = true;
            matchingInput.dispatchEvent(new Event('change', { bubbles: true }));
          } else {
            console.log(`‚ö†Ô∏è Locked size ${bundleState.lockedSize} not found or disabled, falling back to first available`);
            const firstInput = optionGroup.querySelector('[data-variant-input]:not([disabled])');
            if (firstInput) {
              firstInput.checked = true;
              firstInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        } else {
          // T√¨m input ƒë·∫ßu ti√™n trong m·ªói group (default behavior)
          const firstInput = optionGroup.querySelector('[data-variant-input]');
          if (firstInput && !firstInput.disabled) {
            console.log(`Auto-selecting first input in group ${groupIndex}:`, firstInput.value);
            firstInput.checked = true;
            
            // Trigger change event ƒë·ªÉ c·∫≠p nh·∫≠t variant
            firstInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }
      });
      
      syncVariantAvailability(); // Initial sync
    }, 100); // Delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ s·∫µn s√†ng
    
    // Use event delegation for variant inputs (works with dynamically created elements)
    container.addEventListener('change', function(event) {
      if (event.target.hasAttribute('data-variant-input')) {
        console.log('=== VARIANT INPUT CHANGED ===');
        console.log('Input value:', event.target.value);
        console.log('Input name:', event.target.name);
        console.log('Input data-index:', event.target.dataset.index);
        
        // Get current product at the beginning to avoid reference error
        const currentProduct = config.bundleProducts[bundleState.currentProductIndex];
        console.log('Current product at start:', currentProduct);
        
        if (!currentProduct) {
          console.error('‚ùå No current product found for index:', bundleState.currentProductIndex);
          return;
        }
        
        // Get all selected options
        const selectedOptions = {};
        const checkedInputs = container.querySelectorAll('[data-variant-input]:checked');
        console.log('Total checked inputs:', checkedInputs.length);
        
        checkedInputs.forEach((input, index) => {
          console.log(`Checked input ${index}:`, {
            value: input.value,
            name: input.name,
            dataIndex: input.dataset.index,
            id: input.id
          });
          const optionIndex = parseInt(input.dataset.index.replace('option', '')) - 1;
          selectedOptions[optionIndex] = input.value;
          console.log('Selected option:', optionIndex, '=', input.value);
        });
        
        // Ensure at least one option is selected for each option group
        const allVariantInputs = container.querySelectorAll('[data-variant-input]');
        const optionGroups = {};
        
        // Group inputs by option
        allVariantInputs.forEach(input => {
          const optionIndex = parseInt(input.dataset.index.replace('option', '')) - 1;
          if (!optionGroups[optionIndex]) {
            optionGroups[optionIndex] = [];
          }
          optionGroups[optionIndex].push(input);
        });
        
        // For each option group, ensure at least one is selected
        Object.keys(optionGroups).forEach(optionIndex => {
          if (!selectedOptions[optionIndex]) {
            // Find the first checked input in this group, or the first available input
            const groupInputs = optionGroups[optionIndex];
            const checkedInput = groupInputs.find(input => input.checked);
            const firstAvailableInput = groupInputs.find(input => !input.disabled);
            
            const inputToUse = checkedInput || firstAvailableInput;
            if (inputToUse) {
              selectedOptions[optionIndex] = inputToUse.value;
              console.log('‚úÖ Ensured option', optionIndex, '=', inputToUse.value);
            }
          }
        });
        
        console.log('Selected options:', selectedOptions);
        
        // ===== SIMPLE SOLUTION: 2-Way Sync Between Option1 ‚Üî Option2 =====
        
        // When option1 (K√≠ch th∆∞·ªõc) changes ‚Üí update option2 (Comfort top)
        if (event.target.dataset.index === 'option1') {
          console.log('üîÑ Option1 changed, updating option2 availability...');
          
          const selectedOption1 = selectedOptions[0];
          if (selectedOption1) {
            // Find all variants that have this option1 value
            const variantsWithThisSize = currentProduct.variants.filter(v => 
              v.options && v.options[0] === selectedOption1
            );
            
            // Get available option2 values for this option1
            const availableOption2Values = [...new Set(
              variantsWithThisSize
                .filter(v => v.available)
                .map(v => v.options[1])
                .filter(val => val) // Remove undefined
            )];
            
            console.log('Available option2 values for', selectedOption1, ':', availableOption2Values);
            
            // Update option2 inputs
            const option2Inputs = container.querySelectorAll('[data-variant-input][data-index="option2"]');
            option2Inputs.forEach(input => {
              const wrapper = input.closest('.variant-input');
              const label = wrapper ? wrapper.querySelector('label') : null;
              
              if (availableOption2Values.includes(input.value)) {
                input.disabled = false;
                if (wrapper) wrapper.classList.remove('disabled');
                if (label) label.classList.remove('disabled');
                console.log('  ‚úÖ Enabled option2:', input.value);
              } else {
                input.disabled = true;
                if (wrapper) wrapper.classList.add('disabled');
                if (label) label.classList.add('disabled');
                console.log('  ‚ùå Disabled option2:', input.value);
              }
            });
          }
        }
        
        // When option2 (Comfort top) changes ‚Üí update option1 (K√≠ch th∆∞·ªõc)
        if (event.target.dataset.index === 'option2') {
          console.log('üîÑ Option2 changed, updating option1 availability...');
          
          const selectedOption2 = selectedOptions[1];
          if (selectedOption2) {
            // Find all variants that have this option2 value
            const variantsWithThisComfort = currentProduct.variants.filter(v => 
              v.options && v.options[1] === selectedOption2
            );
            
            // Get available option1 values for this option2
            const availableOption1Values = [...new Set(
              variantsWithThisComfort
                .filter(v => v.available)
                .map(v => v.options[0])
                .filter(val => val) // Remove undefined
            )];
            
            console.log('Available option1 values for', selectedOption2, ':', availableOption1Values);
            
            // Update option1 inputs
            const option1Inputs = container.querySelectorAll('[data-variant-input][data-index="option1"]');
            option1Inputs.forEach(input => {
              const wrapper = input.closest('.variant-input');
              const label = wrapper ? wrapper.querySelector('label') : null;
              
              if (availableOption1Values.includes(input.value)) {
                input.disabled = false;
                if (wrapper) wrapper.classList.remove('disabled');
                if (label) label.classList.remove('disabled');
                console.log('  ‚úÖ Enabled option1:', input.value);
              } else {
                input.disabled = true;
                if (wrapper) wrapper.classList.add('disabled');
                if (label) label.classList.add('disabled');
                console.log('  ‚ùå Disabled option1:', input.value);
              }
            });
          }
        }
        
        // Find matching variant - IMPROVED LOGIC
        console.log('=== VARIANT MATCHING DEBUG ===');
        console.log('Current product variants count:', currentProduct.variants.length);
        console.log('Selected options to match:', selectedOptions);
        console.log('Selected options keys:', Object.keys(selectedOptions));
        
        const matchingVariant = currentProduct.variants.find(variant => {
          console.log(`\n--- Checking variant: ${variant.title} ---`);
          console.log('Variant options:', variant.options);
          
          if (!variant.options) {
            console.log('‚ùå Variant has no options array');
            return false;
          }
          
          // Check if all selected options match this variant
          const matches = variant.options.every((option, index) => {
            const selectedOption = selectedOptions[index];
            const optionMatches = option === selectedOption;
            console.log(`  Option ${index}: variant="${option}" vs selected="${selectedOption}" = ${optionMatches}`);
            return optionMatches;
          });
          
          console.log(`Result for ${variant.title}:`, {
            variantOptions: variant.options,
            selectedOptions: selectedOptions,
            matches: matches
          });
          
          return matches;
        });
        
        console.log('Matching variant:', matchingVariant);
        
        // Fallback: If no matching variant found, use the first available variant
        let variantToUse = matchingVariant;
        if (!variantToUse) {
          console.log('‚ùå No matching variant found, using fallback...');
          console.log('Available variants:', currentProduct.variants.map(v => ({
            title: v.title,
            options: v.options
          })));
          
          // Try to find a variant that matches at least the first option (size)
          if (selectedOptions[0]) {
            variantToUse = currentProduct.variants.find(v => v.options && v.options[0] === selectedOptions[0]);
            console.log('Fallback variant found by size:', variantToUse ? variantToUse.title : 'none');
          }
          
          // If still no match, use the first available variant
          if (!variantToUse) {
            variantToUse = currentProduct.variants.find(v => v.available !== false) || currentProduct.variants[0];
            console.log('Using first available variant as final fallback:', variantToUse ? variantToUse.title : 'none');
          }
        }
        
        if (variantToUse) {
          console.log('‚úÖ Using variant:', variantToUse.title);
          console.log('Variant price:', variantToUse.price);
          
          // Update product select
          const productSelect = container.querySelector(`#ProductSelect-bundle-${currentProduct.id}`);
          if (productSelect) {
            productSelect.value = variantToUse.id;
            productSelect.dispatchEvent(new Event('change'));
            console.log('‚úÖ Updated product select to variant ID:', variantToUse.id);
          }
          
          // Check if price elements exist before updating
          const priceContainer = container.querySelector('.price-container-wrapper');
          console.log('Price container found:', !!priceContainer);
          if (priceContainer) {
            const mainPriceElement = priceContainer.querySelector('[data-product-price]');
            console.log('Main price element found:', !!mainPriceElement);
          }
          
          // Update price and labels
          console.log('=== UPDATING UI ===');
          console.log('Calling updateBundleProductPrice...');
          updateBundleProductPrice(variantToUse, container);
          console.log('Calling updateBundleVariantLabels...');
          updateBundleVariantLabels(variantToUse, container);
          console.log('UI update completed');
          
                  // Dispatch custom event
        container.dispatchEvent(new CustomEvent('variantChange', {
          detail: { variant: variantToUse }
        }));
        
        // Also update the bundle state immediately for this product
        console.log('=== BUNDLE STATE UPDATE DEBUG ===');
        console.log('currentProductIndex:', bundleState.currentProductIndex);
        console.log('currentProduct:', currentProduct);
        console.log('variantToUse:', variantToUse);
        
        if (currentProduct) {
          // Get variant image
          let variantImage = currentProduct.featured_image;
          if (variantToUse.featured_image) {
            variantImage = variantToUse.featured_image;
          } else if (currentProduct.media && currentProduct.media.length > 0) {
            const variantMedia = currentProduct.media.find(media => {
              const mediaAlt = (media.alt || '').toLowerCase();
              const mediaTitle = (media.title || '').toLowerCase();
              const variantTitle = variantToUse.title.toLowerCase();
              
              return mediaAlt.includes(variantTitle) || 
                     mediaTitle.includes(variantTitle) ||
                     variantToUse.options && variantToUse.options.some(option => {
                       const optionLower = option.toLowerCase();
                       return mediaAlt.includes(optionLower) || mediaTitle.includes(optionLower);
                     });
            });
            
            if (variantMedia) {
              variantImage = variantMedia.src;
            }
          }
          
          // Update bundle state immediately
          const existingIndex = bundleState.selectedProducts.bundle.findIndex(p => p.productId === currentProduct.id);
          if (existingIndex >= 0) {
            bundleState.selectedProducts.bundle[existingIndex].variantTitle = variantToUse.title;
            bundleState.selectedProducts.bundle[existingIndex].variantId = variantToUse.id;
            bundleState.selectedProducts.bundle[existingIndex].variantPrice = variantToUse.price;
            bundleState.selectedProducts.bundle[existingIndex].compareAtPrice = variantToUse.compare_at_price;
            bundleState.selectedProducts.bundle[existingIndex].variantOptions = variantToUse.options;
            bundleState.selectedProducts.bundle[existingIndex].image = extractImageUrl(variantImage);
            console.log('‚úÖ Updated bundle state immediately for product:', currentProduct.title, 'variant:', variantToUse.title, 'image:', variantImage);
            console.log('‚úÖ Bundle state updated:', bundleState.selectedProducts.bundle[existingIndex]);
            console.log('‚úÖ Variant options saved:', variantToUse.options);
            console.log('‚úÖ Variant options type:', typeof variantToUse.options);
            console.log('‚úÖ Variant options is array:', Array.isArray(variantToUse.options));
            console.log('‚úÖ Variant options length:', variantToUse.options ? variantToUse.options.length : 'undefined');
            
            // Check if this is the first product and has size variant
            if (bundleState.currentProductIndex === 0 && variantToUse.options && variantToUse.options.length > 0) {
              const firstOption = variantToUse.options[0];
              const isSizeOption = firstOption && (
                firstOption.toLowerCase().includes('single') || 
                firstOption.toLowerCase().includes('full') || 
                firstOption.toLowerCase().includes('queen') || 
                firstOption.toLowerCase().includes('king') ||
                firstOption.toLowerCase().includes('150') ||
                firstOption.toLowerCase().includes('180') ||
                firstOption.toLowerCase().includes('200') ||
                firstOption.toLowerCase().includes('220') ||
                firstOption.toLowerCase().includes('250') ||
                firstOption.toLowerCase().includes('300') ||
                firstOption.toLowerCase().includes('cm')
              );
              
              if (isSizeOption) {
                console.log('üéØ First product size selected:', firstOption);
                console.log('üîí Locking size for all other products to:', firstOption);
                
                // Store the selected size for other products
                bundleState.lockedSize = firstOption;
                
                // Update all other products in bundle to use the same size
                bundleState.selectedProducts.bundle.forEach((product, index) => {
                  if (index > 0) { // Skip first product
                    const productData = config.bundleProducts.find(p => p.id === product.productId);
                    if (productData && productData.variants) {
                      // Find variant with matching size (improved logic)
                      const matchingVariant = productData.variants.find(variant => {
                        if (!variant.options || variant.options.length === 0) return false;
                        
                        const variantSize = variant.options[0];
                        
                        // Direct match
                        if (variantSize === firstOption) {
                          return true;
                        }
                        
                        // Extract dimensions from both sizes
                        const extractDimensions = (sizeStr) => {
                          const dimensions = sizeStr.match(/(\d+)\s*x\s*(\d+)/i);
                          if (dimensions) {
                            return {
                              width: parseInt(dimensions[1]),
                              height: parseInt(dimensions[2])
                            };
                          }
                          return null;
                        };
                        
                        const firstDimensions = extractDimensions(firstOption);
                        const variantDimensions = extractDimensions(variantSize);
                        
                        // If both have dimensions, compare them
                        if (firstDimensions && variantDimensions) {
                          return firstDimensions.width === variantDimensions.width && 
                                 firstDimensions.height === variantDimensions.height;
                        }
                        
                        // Fallback: check if both contain same size keywords
                        const sizeKeywords = ['single', 'full', 'queen', 'king', '150', '180', '200', '220', '250', '300'];
                        const firstHasKeyword = sizeKeywords.some(keyword => 
                          firstOption.toLowerCase().includes(keyword)
                        );
                        const variantHasKeyword = sizeKeywords.some(keyword => 
                          variantSize.toLowerCase().includes(keyword)
                        );
                        
                        if (firstHasKeyword && variantHasKeyword) {
                          // Check if they share any size keyword
                          return sizeKeywords.some(keyword => 
                            firstOption.toLowerCase().includes(keyword) && 
                            variantSize.toLowerCase().includes(keyword)
                          );
                        }
                        
                        return false;
                      });
                      
                      if (matchingVariant) {
                        console.log(`üîí Auto-updating product ${bundleState.currentProductIndex + 1} (${product.productTitle}) to size: ${firstOption}`);
                        product.variantId = matchingVariant.id;
                        product.variantTitle = matchingVariant.title;
                        product.variantPrice = matchingVariant.price;
                        product.compareAtPrice = matchingVariant.compare_at_price;
                        product.variantOptions = matchingVariant.options;
                      }
                    }
                  }
                });
              }
            }
            
            // If we have a locked size and this is not the first product, disable other size options
            if (bundleState.lockedSize && bundleState.currentProductIndex > 0) {
              const sizeInputs = container.querySelectorAll('.variant-wrapper.size [data-variant-input]');
              sizeInputs.forEach(input => {
                const inputValue = input.value;
                
                // Check if this input matches the locked size (using improved logic)
                const isMatchingSize = (() => {
                  // Direct match
                  if (inputValue === bundleState.lockedSize) {
                    return true;
                  }
                  
                  // Extract dimensions from both sizes
                  const extractDimensions = (sizeStr) => {
                    const dimensions = sizeStr.match(/(\d+)\s*x\s*(\d+)/i);
                    if (dimensions) {
                      return {
                        width: parseInt(dimensions[1]),
                        height: parseInt(dimensions[2])
                      };
                    }
                    return null;
                  };
                  
                  const lockedDimensions = extractDimensions(bundleState.lockedSize);
                  const inputDimensions = extractDimensions(inputValue);
                  
                  // If both have dimensions, compare them
                  if (lockedDimensions && inputDimensions) {
                    return lockedDimensions.width === inputDimensions.width && 
                           lockedDimensions.height === inputDimensions.height;
                  }
                  
                  // Fallback: check if both contain same size keywords
                  const sizeKeywords = ['single', 'full', 'queen', 'king', '150', '180', '200', '220', '250', '300'];
                  const lockedHasKeyword = sizeKeywords.some(keyword => 
                    bundleState.lockedSize.toLowerCase().includes(keyword)
                  );
                  const inputHasKeyword = sizeKeywords.some(keyword => 
                    inputValue.toLowerCase().includes(keyword)
                  );
                  
                  if (lockedHasKeyword && inputHasKeyword) {
                    // Check if they share any size keyword
                    return sizeKeywords.some(keyword => 
                      bundleState.lockedSize.toLowerCase().includes(keyword) && 
                      inputValue.toLowerCase().includes(keyword)
                    );
                  }
                  
                  return false;
                })();
                
                if (!isMatchingSize) {
                  input.disabled = true;
                  input.closest('.variant__button-label')?.classList.add('disabled');
                  console.log(`üîí Disabled size option: ${input.value}`);
                } else {
                  input.disabled = false;
                  input.closest('.variant__button-label')?.classList.remove('disabled');
                  console.log(`üîí Enabled matching size option: ${input.value}`);
                }
              });
            }
          } else {
            // Add new product to bundle state
            // Determine quantity (index 2 = product 3)
            const productQuantity = bundleState.currentProductIndex === 2 ? (config.product3Quantity || 2) : 1;
            
            const newProduct = {
              productId: currentProduct.id,
              productHandle: currentProduct.handle,
              productTitle: currentProduct.title,
              image: variantImage,
              variantId: variantToUse.id,
              variantTitle: variantToUse.title,
              variantPrice: variantToUse.price,
              compareAtPrice: variantToUse.compare_at_price,
              variantOptions: variantToUse.options,
              quantity: productQuantity
            };
            bundleState.selectedProducts.bundle.push(newProduct);
            console.log('‚úÖ Added new product to bundle state:', newProduct);
            console.log('‚úÖ Variant options saved:', variantToUse.options);
            console.log('‚úÖ Variant options type:', typeof variantToUse.options);
            console.log('‚úÖ Variant options is array:', Array.isArray(variantToUse.options));
            console.log('‚úÖ Variant options length:', variantToUse.options ? variantToUse.options.length : 'undefined');
          }
        }
        } else {
          console.log('‚ùå No matching variant found for options:', selectedOptions);
          console.log('Available variants:', currentProduct.variants.map(v => ({
            title: v.title,
            options: v.options
          })));
        }
      }
    });
    
    // Listen to variant change events
    container.addEventListener('variantChange', function(evt) {
      console.log('Variant change event:', evt.detail);
      const variant = evt.detail.variant;
      
      if (variant) {
        updateBundleProductPrice(variant, container);
        updateBundleVariantLabels(variant, container);
      }
    });
    
    console.log('‚úÖ Variant picker initialized successfully');
  }

  function updateBundleVariantLabels(variant, container) {
    console.log('=== UPDATE VARIANT LABELS ===');
    console.log('Function called with variant:', variant);
    console.log('Container:', container);
    console.log('Updating variant labels for variant:', variant.title);
    console.log('Variant options:', variant.options);
    
    // Find all variant__label-info elements with data-index attribute
    console.log('Container selector:', container);
    console.log('Container classList:', container.classList);
    console.log('Container children count:', container.children.length);
    
    const variantLabels = container.querySelectorAll('.variant__label-info[data-index]');
    console.log('Found variant labels with data-index:', variantLabels.length);
    
    // Also check for any variant__label-info elements
    const allVariantLabelInfo = container.querySelectorAll('.variant__label-info');
    console.log('Total variant__label-info elements found:', allVariantLabelInfo.length);
    
    // Also check for all variant__label-info elements
    const allLabelInfoElements = container.querySelectorAll('.variant__label-info');
    console.log('Total variant__label-info elements found:', allLabelInfoElements.length);
    
    // Debug: Log all variant__label-info elements
    allLabelInfoElements.forEach((labelInfo, index) => {
      console.log(`Label info ${index}:`, {
        innerHTML: labelInfo.innerHTML,
        textContent: labelInfo.textContent,
        className: labelInfo.className,
        children: labelInfo.children.length
      });
    });
    
    // Debug: Log all variant labels found
    variantLabels.forEach((label, index) => {
      console.log(`Variant label ${index}:`, {
        textContent: label.textContent,
        dataIndex: label.getAttribute('data-index'),
        className: label.className,
        id: label.id
      });
    });
    
    // Update labels based on data-index attribute
    variantLabels.forEach((label, index) => {
      const optionIndex = parseInt(label.getAttribute('data-index'));
      console.log(`Label ${index}: optionIndex = ${optionIndex}`);
      
      if (!isNaN(optionIndex) && variant.options && variant.options[optionIndex]) {
        const newText = variant.options[optionIndex];
        // Update the inner span with data-variant-selected-label
        const innerSpan = label.querySelector(' [data-variant-selected-label]');
        if (innerSpan) {
          innerSpan.textContent = newText;
          console.log('‚úÖ Updated label index', optionIndex, 'from', innerSpan.getAttribute('data-original-text') || 'unknown', 'to:', newText);
        } else {
          // Fallback: update the container's text content
          label.textContent = newText;
          console.log('‚úÖ Updated label container index', optionIndex, 'to:', newText);
        }
      }
    });
    
    // Update specific color and size labels if they exist
    const colorLabel = container.querySelector('[data-variant-color-label]');
    const sizeLabel = container.querySelector('[data-variant-selected-label]');
    
    console.log('Color label found:', !!colorLabel);
    console.log('Size label found:', !!sizeLabel);
    
    if (colorLabel && variant.options && variant.options[1]) {
      colorLabel.textContent = variant.options[1];
      console.log('‚úÖ Updated color label to:', variant.options[1]);
    }
    
    if (sizeLabel && variant.options && variant.options[0]) {
      sizeLabel.textContent = variant.options[0];
      console.log('‚úÖ Updated size label to:', variant.options[0]);
    }
    
    // Update all variant__label-info containers that have data-index
    const labelInfoContainers = container.querySelectorAll('.variant__label-info[data-index]');
    console.log('Found label info containers with data-index:', labelInfoContainers.length);
    
    labelInfoContainers.forEach((container, index) => {
      const optionIndex = parseInt(container.getAttribute('data-index'));
      console.log(`Container ${index}: optionIndex = ${optionIndex}`);
      
      if (!isNaN(optionIndex) && variant.options && variant.options[optionIndex]) {
        // Update the first span or text content
        const firstSpan = container.querySelector('span');
        if (firstSpan) {
          firstSpan.textContent = variant.options[optionIndex];
          console.log('‚úÖ Updated label info container', index, 'to:', variant.options[optionIndex]);
        } else {
          // If no span, update the container's text content
          container.textContent = variant.options[optionIndex];
          console.log('‚úÖ Updated label info container text', index, 'to:', variant.options[optionIndex]);
        }
      }
    });
    
    // Also update any variant__label-info that doesn't have data-index but contains spans
    const allLabelInfoSpans = container.querySelectorAll('.variant__label-info');
    console.log('Total variant__label-info found:', allLabelInfoSpans.length);
    
    allLabelInfoSpans.forEach((labelInfo, index) => {
      const spans = labelInfo.querySelectorAll('span');
      console.log(`Label info ${index} has ${spans.length} spans`);
      
      spans.forEach((span, spanIndex) => {
        const dataIndex = span.getAttribute('data-index');
        if (dataIndex) {
          const optionIndex = parseInt(dataIndex);
          if (!isNaN(optionIndex) && variant.options && variant.options[optionIndex]) {
            span.textContent = variant.options[optionIndex];
            console.log(`‚úÖ Updated span ${spanIndex} in label info ${index} to:`, variant.options[optionIndex]);
          }
        }
      });
    });
    
    // Force update all variant__label-info text content based on variant title
    if (variantLabels.length === 0) {
      console.log('‚ö†Ô∏è No variant labels with data-index found, trying alternative approach...');
      
      // Try to update based on variant title
      allLabelInfoElements.forEach((labelInfo, index) => {
        const currentText = labelInfo.textContent.trim();
        console.log(`Label info ${index} current text: "${currentText}"`);
        
        // If this looks like a size option, update with the first option
        if (currentText.includes('K√≠ch th∆∞·ªõc') || currentText.includes('Size')) {
          if (variant.options && variant.options[0]) {
            labelInfo.textContent = variant.options[0];
            console.log(`‚úÖ Force updated size label to: ${variant.options[0]}`);
          }
        }
        // If this looks like a color option, update with the second option
        else if (currentText.includes('M√†u') || currentText.includes('Color')) {
          if (variant.options && variant.options[1]) {
            labelInfo.textContent = variant.options[1];
            console.log(`‚úÖ Force updated color label to: ${variant.options[1]}`);
          }
        }
        // Otherwise, try to update with the full variant title
        else {
          labelInfo.textContent = variant.title;
          console.log(`‚úÖ Force updated label to variant title: ${variant.title}`);
        }
      });
    }
    
    // Update color swatch visual state
    updateColorSwatchState(variant, container);
  }

  function updateBundleProductPrice(variant, container) {
    console.log('=== UPDATE PRODUCT PRICE ===');
    console.log('Updating product price for variant:', variant.title);
    console.log('Variant price:', variant.price, 'Compare price:', variant.compare_at_price);
    
    // Update price elements
    const priceContainer = container.querySelector('.price-container-wrapper');
    console.log('Price container found:', !!priceContainer);
    
    if (priceContainer) {
      // Update main price
      const mainPriceElement = priceContainer.querySelector('[data-product-price]');
      console.log('Main price element found:', !!mainPriceElement);
      console.log('Main price element before update:', mainPriceElement ? mainPriceElement.textContent : 'not found');
      
      if (mainPriceElement) {
        const formattedPrice = formatMoney(variant.price);
        mainPriceElement.textContent = formattedPrice;
        console.log('‚úÖ Updated main price from', mainPriceElement.getAttribute('data-product-price-base'), 'to:', formattedPrice);
        console.log('‚úÖ Main price element after update:', mainPriceElement.textContent);
      }
      
      // Update compare price
      const comparePriceElement = priceContainer.querySelector('[data-compare-price]');
      console.log('Compare price element found:', !!comparePriceElement);
      console.log('Compare price element before update:', comparePriceElement ? comparePriceElement.textContent : 'not found');
      
      if (comparePriceElement) {
        if (variant.compare_at_price) {
          const formattedComparePrice = formatMoney(variant.compare_at_price);
          comparePriceElement.textContent = formattedComparePrice;
          comparePriceElement.style.display = 'inline';
          console.log('‚úÖ Updated compare price to:', formattedComparePrice);
          console.log('‚úÖ Compare price element after update:', comparePriceElement.textContent);
        } else {
          comparePriceElement.style.display = 'none';
          console.log('‚úÖ Hiding compare price');
        }
      }
      
      // Update discount badge
      const discountBadge = priceContainer.querySelector('.product__discount-badge');
      console.log('Discount badge found:', !!discountBadge);
      console.log('Discount badge before update:', discountBadge ? discountBadge.textContent : 'not found');
      
      if (discountBadge) {
        if (variant.compare_at_price) {
          const discountPercent = Math.round((variant.compare_at_price - variant.price) / variant.compare_at_price * 100);
          discountBadge.textContent = `-${discountPercent}%`;
          discountBadge.style.display = 'inline';
          console.log('‚úÖ Updated discount badge to:', `-${discountPercent}%`);
          console.log('‚úÖ Discount badge after update:', discountBadge.textContent);
        } else {
          discountBadge.style.display = 'none';
          console.log('‚úÖ Hiding discount badge');
        }
      }
    }
    
    // Update installment price
    const installmentPrice = container.querySelector('[data-installment-price]');
    if (installmentPrice) {
      const installmentAmount = Math.round(variant.price / 12);
      installmentPrice.textContent = formatMoney(installmentAmount);
      console.log('‚úÖ Updated installment price to:', formatMoney(installmentAmount));
    }
    
    console.log('‚úÖ Price update completed');
    
    // Update product image if variant has different image
    updateBundleProductImage(variant, container);
  }

  // Update bundle product image handled by updateProductImageForStep2()

  function updateColorSwatchState(variant, container) {
    console.log('=== UPDATE COLOR SWATCH STATE ===');
    console.log('Updating color swatch state for variant:', variant.title);
    
    // Remove active state from all color swatches
    const allColorSwatches = container.querySelectorAll('.color-swatch');
    allColorSwatches.forEach(swatch => {
      swatch.classList.remove('active', 'selected');
    });
    
    // Add active state to the selected color swatch
    if (variant.options && variant.options[1]) { // Assuming option2 is color
      // Try multiple selectors to find the color swatch
      let selectedColorSwatch = container.querySelector(`.color-swatch[for*="${variant.options[1].replace(/\s+/g, '-')}"]`);
      
      if (!selectedColorSwatch) {
        // Try finding by data-color-name attribute
        const colorInput = container.querySelector(`[data-variant-input][data-color-name="${variant.options[1]}"]`);
        if (colorInput) {
          selectedColorSwatch = container.querySelector(`label[for="${colorInput.id}"]`);
        }
      }
      
      if (selectedColorSwatch) {
        selectedColorSwatch.classList.add('active', 'selected');
        console.log('‚úÖ Updated color swatch state for:', variant.options[1]);
      } else {
        console.log('‚ùå Could not find color swatch for:', variant.options[1]);
        console.log('Available color swatches:', container.querySelectorAll('.color-swatch').length);
        console.log('Available color inputs:', container.querySelectorAll('[data-variant-input][data-color-name]').length);
      }
    }
    
    // Also update the input state
    const colorInputs = container.querySelectorAll('[data-variant-input][data-color-name]');
    colorInputs.forEach(input => {
      if (input.value === variant.options[1]) {
        input.checked = true;
        console.log('‚úÖ Updated color input state for:', variant.options[1]);
      } else {
        input.checked = false;
      }
    });
  }



  function renderIconWithText(settings) {
    if (!config.iconWithTextSettings) {
              // Fallback to default icons if no settings
        return `
          <div class="product-block">
            <div class="icon-with-text">
              <div class="icon-with-text__grid">
                <div class="icon-with-text__item">
                  <div class="icon-with-text__icon">
                    <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
                    </svg>
                  </div>
                  <div class="icon-with-text__content">
                    <h3 class="icon-with-text__heading">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn *</h3>
                  </div>
                </div>
                
                <div class="icon-with-text__item">
                  <div class="icon-with-text__icon">
                    <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="icon-with-text__content">
                    <h3 class="icon-with-text__heading">B·∫£o h√†nh d√†i l√¢u</h3>
                  </div>
                </div>
                
                <div class="icon-with-text__item">
                  <div class="icon-with-text__icon">
                    <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M8 5V3a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="icon-with-text__content">
                    <h3 class="icon-with-text__heading">Ch·∫•t li·ªáu Foam cao c·∫•p</h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
    }

    const iconSettings = config.iconWithTextSettings;
    const iconSize = iconSettings.icon_size || 25;
    const alignment = iconSettings.icon_alignment || 'center';
    const gridColumns = iconSettings.grid_columns || "2";
    const showIcon4 = iconSettings.show_icon_4 !== false; // Default to true
    
    let iconItems = [];
    
    // Icon 1
    if (iconSettings.icon_1_image || iconSettings.icon_1_heading) {
      const icon1Html = `
        <div class="icon-with-text__item">
          <div class="icon-with-text__icon">
            ${iconSettings.icon_1_image ? 
              `<img src="${iconSettings.icon_1_image}" 
                   alt="${iconSettings.icon_1_heading || 'Icon 1'}"
                   width="${iconSize}"
                   height="${iconSize}"
                   style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">` :
              `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>
              </svg>`
            }
          </div>
          <div class="icon-with-text__content">
            <h3 class="icon-with-text__heading">${iconSettings.icon_1_heading || '100 ƒë√™m ng·ªß th·ª≠'}</h3>
          </div>
        </div>
      `;
      iconItems.push(icon1Html);
    }
    
    // Icon 2
    if (iconSettings.icon_2_image || iconSettings.icon_2_heading) {
      const icon2Html = `
        <div class="icon-with-text__item">
          <div class="icon-with-text__icon">
            ${iconSettings.icon_2_image ? 
              `<img src="${iconSettings.icon_2_image}" 
                   alt="${iconSettings.icon_2_heading || 'Icon 2'}"
                   width="${iconSize}"
                   height="${iconSize}"
                   style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">` :
              `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 5V3a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`
            }
          </div>
          <div class="icon-with-text__content">
            <h3 class="icon-with-text__heading">${iconSettings.icon_2_heading || 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn *'}</h3>
          </div>
        </div>
      `;
      iconItems.push(icon2Html);
    }
    
    // Icon 3
    if (iconSettings.icon_3_image || iconSettings.icon_3_heading) {
      const icon3Html = `
        <div class="icon-with-text__item">
          <div class="icon-with-text__icon">
            ${iconSettings.icon_3_image ? 
              `<img src="${iconSettings.icon_3_image}" 
                   alt="${iconSettings.icon_3_heading || 'Icon 3'}"
                   width="${iconSize}"
                   height="${iconSize}"
                   style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">` :
              `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`
            }
          </div>
          <div class="icon-with-text__content">
            <h3 class="icon-with-text__heading">${iconSettings.icon_3_heading || 'B·∫£o h√†nh d√†i l√¢u'}</h3>
          </div>
        </div>
      `;
      iconItems.push(icon3Html);
    }
    
    // Icon 4
    if (showIcon4 && (iconSettings.icon_4_image || iconSettings.icon_4_heading)) {
      const icon4Html = `
        <div class="icon-with-text__item">
          <div class="icon-with-text__icon">
            ${iconSettings.icon_4_image ? 
              `<img src="${iconSettings.icon_4_image}" 
                   alt="${iconSettings.icon_4_heading || 'Icon 4'}"
                   width="${iconSize}"
                   height="${iconSize}"
                   style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">` :
              `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 5V3a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`
            }
          </div>
          <div class="icon-with-text__content">
            <h3 class="icon-with-text__heading">${iconSettings.icon_4_heading || 'Ch·∫•t li·ªáu Foam cao c·∫•p'}</h3>
          </div>
        </div>
      `;
      iconItems.push(icon4Html);
    }
    
    return `
      <div class="product-block">
        <div class="icon-with-text">
          <div class="icon-with-text__grid" style="text-align: ${alignment};" data-columns="${gridColumns}">
            ${iconItems.join('')}
          </div>
        </div>
      </div>
    `;
  }

  function formatMoney(cents) {
    // Shopify returns price in cents, so we need to divide by 100
    const amount = cents / 100;
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
      minimumFractionDigits: 0
    }).format(amount);
  }
  
  // ===== BUNDLE PRICING CALCULATOR (Theme Editor Only) =====
  function runPricingCalculator() {
    const calculatorResults = document.getElementById('calculator-results');
    if (!calculatorResults) return; // Not in theme editor
    
    console.log('=== RUNNING PRICING CALCULATOR ===');
    
    if (!config.bundleProducts || config.bundleProducts.length === 0) {
      calculatorResults.innerHTML = `
        <p style="margin: 8px 0; color: #E53E3E; font-size: 14px;">
          ‚ö†Ô∏è <strong>Ch∆∞a c√≥ bundle products!</strong> Vui l√≤ng add products v√†o bundle tr∆∞·ªõc.
        </p>
      `;
      return;
    }
    
    const targetDiscount = config.targetDiscountPercentage || 15;
    
    // Calculate totals for all bundle products
    let totalPrice = 0;           // T·ªïng price hi·ªán t·∫°i
    let totalCompareAtPrice = 0;  // T·ªïng compare_at_price
    
    const productCalculations = config.bundleProducts.map((product, idx) => {
      // Get first variant or use product price
      const variant = product.variants && product.variants.length > 0 ? product.variants[0] : null;
      const price = variant ? variant.price : product.price;
      const compareAtPrice = variant ? (variant.compare_at_price || variant.price) : (product.compare_at_price || product.price);
      
      // Determine quantity (product index 2 = product th·ª© 3)
      const quantity = idx === 2 ? (config.product3Quantity || 2) : 1;
      
      totalPrice += price * quantity;
      totalCompareAtPrice += compareAtPrice * quantity;
      
      // Calculate current discount for this product
      const currentDiscount = compareAtPrice > 0 ? 
        Math.round(((compareAtPrice - price) / compareAtPrice) * 100) : 0;
      
      return {
        title: product.title,
        price: price,
        compareAtPrice: compareAtPrice,
        currentDiscount: currentDiscount,
        quantity: quantity
      };
    });
    
    // Calculate bundle-level metrics
    const currentBundleDiscount = totalCompareAtPrice > 0 ? 
      Math.round(((totalCompareAtPrice - totalPrice) / totalCompareAtPrice) * 100) : 0;
    
    // Calculate target final price (ideal)
    const targetFinalPriceIdeal = totalCompareAtPrice * (1 - targetDiscount / 100);
    
    // C√îNG TH·ª®C: Voucher % = (Current Price - Target Price) / Current Price √ó 100
    const neededVoucherDiscountExact = totalPrice > 0 ? 
      ((totalPrice - targetFinalPriceIdeal) / totalPrice) * 100 : 0;
    
    // Round voucher v·ªÅ s·ªë nguy√™n (Shopify kh√¥ng h·ªó tr·ª£ th·∫≠p ph√¢n)
    const neededVoucherDiscountRounded = Math.round(neededVoucherDiscountExact);
    
    // T√≠nh gi√° cu·ªëi TH·ª∞C T·∫æ sau 2 t·∫ßng gi·∫£m
    // = Compare-at Price √ó (1 - currentDiscount%) √ó (1 - voucherDiscount%)
    const actualFinalPrice = totalPrice * (1 - neededVoucherDiscountRounded / 100);
    
    // Generate HTML
    calculatorResults.innerHTML = `
      <div style="margin-bottom: 16px;">
        <h4 style="color: #234085; margin: 0 0 12px 0; font-size: 16px;">üìä Ph√¢n t√≠ch Bundle:</h4>
        ${productCalculations.map((product, idx) => `
          <div style="padding: 8px; background: #F9FAFB; border-radius: 4px; margin-bottom: 8px; font-size: 13px;">
            <strong>${idx + 1}. ${product.title}</strong>
            ${product.quantity > 1 ? `<span style="color: #234085; font-weight: 600;"> √ó ${product.quantity}</span>` : ''}<br>
            <span style="color: #888;">Price: ${formatMoney(product.price)}${product.quantity > 1 ? ` √ó ${product.quantity} = ${formatMoney(product.price * product.quantity)}` : ''}</span><br>
            <span style="color: #666;">Compare: ${formatMoney(product.compareAtPrice)}${product.quantity > 1 ? ` √ó ${product.quantity} = ${formatMoney(product.compareAtPrice * product.quantity)}` : ''}</span> | 
            <span style="color: ${product.currentDiscount > 0 ? '#16A34A' : '#888'};">
              Gi·∫£m: ${product.currentDiscount}%
            </span>
          </div>
        `).join('')}
      </div>
      
      <div style="background: #F0F9FF; padding: 16px; border-radius: 8px; border-left: 4px solid #234085;">
        <div style="margin-bottom: 12px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 4px;">T·ªïng Compare-at Price:</div>
          <div style="font-size: 20px; font-weight: bold; color: #1C2C58;">${formatMoney(totalCompareAtPrice)}</div>
        </div>
        
        <div style="margin-bottom: 12px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 4px;">T·ªïng Price hi·ªán t·∫°i:</div>
          <div style="font-size: 20px; font-weight: bold; color: #16A34A;">${formatMoney(totalPrice)}</div>
        </div>
        
        <div style="margin-bottom: 12px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 4px;">% Gi·∫£m hi·ªán t·∫°i:</div>
          <div style="font-size: 24px; font-weight: bold; color: ${currentBundleDiscount >= targetDiscount ? '#16A34A' : '#F59E0B'};">
            ${currentBundleDiscount}%
          </div>
        </div>
        
        <div style="border-top: 2px dashed #234085; margin: 16px 0; padding-top: 16px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 4px;">
            ${neededVoucherDiscountRounded > 0 ? '‚ö†Ô∏è C·∫¶N T·∫†O VOUCHER GI·∫¢M TH√äM:' : '‚úÖ ƒê√É ƒê·∫†T M·ª§C TI√äU:'}
          </div>
          <div style="font-size: 32px; font-weight: bold; color: ${neededVoucherDiscountRounded > 0 ? '#E53E3E' : '#16A34A'};">
            ${neededVoucherDiscountRounded}%
          </div>
          ${neededVoucherDiscountRounded > 0 ? `
            <div style="margin-top: 12px; padding: 12px; background: #FEF2F2; border-radius: 6px; font-size: 13px;">
              <strong>üé´ T·∫°o Discount Code trong Shopify Admin:</strong><br>
              ‚Ä¢ Type: <strong>Percentage</strong><br>
              ‚Ä¢ Value: <strong>${neededVoucherDiscountRounded}%</strong> (s·ªë nguy√™n)<br>
              ‚Ä¢ Applies to: <strong>All bundle products</strong><br>
              ‚Ä¢ Code example: <strong>BUNDLE${neededVoucherDiscountRounded}</strong>
            </div>
            <div style="margin-top: 8px; padding: 10px; background: #FFF9E6; border-radius: 6px; font-size: 12px;">
              <strong>üìê C√¥ng th·ª©c 2 t·∫ßng gi·∫£m:</strong><br>
              ‚Ä¢ Gi√° g·ªëc: ${formatMoney(totalCompareAtPrice)}<br>
              ‚Ä¢ Sau gi·∫£m ${currentBundleDiscount}%: ${formatMoney(totalPrice)}<br>
              ‚Ä¢ Sau voucher ${neededVoucherDiscountRounded}%: ${formatMoney(actualFinalPrice)}<br>
              ‚Ä¢ Target (${targetDiscount}%): ${formatMoney(targetFinalPriceIdeal)}<br>
              ‚Ä¢ Ch√™nh l·ªách: ${formatMoney(Math.abs(actualFinalPrice - targetFinalPriceIdeal))}
            </div>
          ` : ''}
        </div>
        
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #93C5FD;">
          <div style="font-size: 14px; color: #666; margin-bottom: 4px;">üíµ Gi√° cu·ªëi (sau 2 t·∫ßng gi·∫£m):</div>
          <div style="font-size: 28px; font-weight: bold; color: #234085;">${formatMoney(actualFinalPrice)}</div>
          <div style="font-size: 12px; color: #888; margin-top: 4px;">
            = ${formatMoney(totalCompareAtPrice)} √ó ${((100 - currentBundleDiscount)/100).toFixed(2)} √ó ${((100 - neededVoucherDiscountRounded)/100).toFixed(2)}
          </div>
        </div>
      </div>
    `;
    
    console.log('=== CALCULATOR RESULTS ===');
    console.log('Target Discount:', targetDiscount + '%');
    console.log('Total Compare-at Price:', formatMoney(totalCompareAtPrice));
    console.log('Total Current Price:', formatMoney(totalPrice));
    console.log('Current Discount %:', currentBundleDiscount + '%');
    console.log('Voucher Needed (exact):', neededVoucherDiscountExact.toFixed(2) + '%');
    console.log('Voucher Needed (rounded):', neededVoucherDiscountRounded + '%');
    console.log('Target Final (ideal):', formatMoney(targetFinalPriceIdeal));
    console.log('Actual Final (sau 2 t·∫ßng):', formatMoney(actualFinalPrice));
    console.log('Ch√™nh l·ªách:', formatMoney(Math.abs(actualFinalPrice - targetFinalPriceIdeal)));
  }
  
  // Run calculator in theme editor
  if (document.querySelector('.bundle-pricing-calculator')) {
    setTimeout(() => {
      runPricingCalculator();
    }, 500);
  }

  // Check for stored voucher on page load and re-apply if needed
  function checkAndReapplyVoucher() {
    console.log('=== CHECK AND REAPPLY VOUCHER ===');
    console.log('Current URL:', window.location.href);
    
    // Check if we're on checkout/cart page
    const isCheckoutPage = window.location.pathname.includes('/checkout') || 
                          window.location.pathname.includes('/cart');
    
    if (isCheckoutPage) {
      console.log('On checkout/cart page, checking for voucher...');
      
      // Check URL parameter first
      const urlParams = new URLSearchParams(window.location.search);
      const urlVoucher = urlParams.get('discount');
      
      if (urlVoucher && urlVoucher.trim() !== '') {
        console.log('Found voucher in URL:', urlVoucher);
        reapplyVoucher(urlVoucher);
        return;
      }
      
      // Check bundle items for voucher
      fetch('/cart.js')
        .then(response => response.json())
        .then(cartData => {
          const hasDiscount = cartData.cart_level_discount_applications && 
                             cartData.cart_level_discount_applications.length > 0;
          
          // Find voucher from bundle items
          let bundleVoucher = null;
          for (const item of cartData.items) {
            if (item.properties && item.properties._bundle_voucher) {
              bundleVoucher = item.properties._bundle_voucher;
              break;
            }
          }
          
          if (bundleVoucher && !hasDiscount) {
            console.log('Re-applying voucher from bundle items:', bundleVoucher);
            reapplyVoucher(bundleVoucher);
          } else if (bundleVoucher && hasDiscount) {
            console.log('Voucher already applied in cart');
          } else {
            console.log('No voucher found in bundle items');
          }
        })
        .catch(error => {
          console.error('Error checking cart for voucher:', error);
        });
    }
  }

  function reapplyVoucher(voucherCode) {
    console.log('=== REAPPLY VOUCHER ===');
    console.log('Re-applying voucher:', voucherCode);
    
    fetch('/cart/update.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 'discount': voucherCode })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Re-apply voucher response:', data);
      
      if (!data.status) {
        console.log('‚úÖ Voucher re-applied successfully');
        
        // Store voucher in bundle items for persistence
        const bundleItems = data.items.filter(item => 
          item.properties && item.properties._bundle_id
        );
        
        if (bundleItems.length > 0) {
          // Update each bundle item to include voucher
          const updatePromises = bundleItems.map(item => {
            const updatedProperties = {
              ...item.properties,
              '_bundle_voucher': voucherCode,
              '_voucher_applied': 'true'
            };
            
            return fetch('/cart/change.js', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                id: item.key,
                properties: updatedProperties
              })
            });
          });
          
          Promise.all(updatePromises)
            .then(responses => {
              console.log('‚úÖ Voucher stored in bundle items after re-apply');
              
              // Reload page to show updated prices
              if (window.location.pathname.includes('/checkout')) {
                console.log('Reloading checkout page to show updated prices');
                setTimeout(() => window.location.reload(), 500);
              }
            })
            .catch(error => {
              console.error('‚ùå Error storing voucher in items:', error);
              // Still reload page
              if (window.location.pathname.includes('/checkout')) {
                setTimeout(() => window.location.reload(), 500);
              }
            });
        } else {
          // No bundle items, just reload
          if (window.location.pathname.includes('/checkout')) {
            setTimeout(() => window.location.reload(), 500);
          }
        }
      } else {
        console.log('‚ùå Failed to re-apply voucher:', data.description);
        
        // Try alternative approach - redirect to checkout with voucher in URL
        if (window.location.pathname.includes('/checkout')) {
          console.log('Attempting alternative approach with URL parameter');
          const currentUrl = new URL(window.location.href);
          currentUrl.searchParams.set('discount', voucherCode);
          window.location.href = currentUrl.toString();
        }
      }
    })
    .catch(error => {
      console.error('‚ùå Error re-applying voucher:', error);
      
      // Fallback: redirect to checkout with voucher in URL
      if (window.location.pathname.includes('/checkout')) {
        console.log('Fallback: redirecting with voucher in URL');
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('discount', voucherCode);
        window.location.href = currentUrl.toString();
      }
    });
  }

  // Run check on page load
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      checkAndReapplyVoucher();
    }, 1000);
  });

});

// Carousel Navigation
document.addEventListener('DOMContentLoaded', function() {
  const carousels = document.querySelectorAll('[data-slideshow]');
  
  carousels.forEach(carousel => {
    const items = carousel.querySelectorAll('.carousel-item');
    const prevBtn = carousel.querySelector('.carousel-nav--prev');
    const nextBtn = carousel.querySelector('.carousel-nav--next');
    let currentIndex = 0;
    
    if (items.length <= 1) {
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
      return;
    }
    
    function showSlide(index) {
      items.forEach((item, i) => {
        item.style.display = i === index ? 'block' : 'none';
      });
      
      // Update navigation buttons
      if (prevBtn) prevBtn.disabled = index === 0;
      if (nextBtn) nextBtn.disabled = index === items.length - 1;
    }
    
    function nextSlide() {
      currentIndex = (currentIndex + 1) % items.length;
      showSlide(currentIndex);
    }
    
    function prevSlide() {
      currentIndex = (currentIndex - 1 + items.length) % items.length;
      showSlide(currentIndex);
    }
    
    if (prevBtn) {
      prevBtn.addEventListener('click', prevSlide);
    }
    
    if (nextBtn) {
      nextBtn.addEventListener('click', nextSlide);
    }
    
    // Initialize
    showSlide(0);
  });
});
</script>

<!-- Carousel Modal Dialogs -->
{%- for block in section.blocks -%}
  {%- if block.type == 'carousel_modal' -%}
    <modal-dialog
      id="PopupModal-{{ block.id }}"
      class="product-popup-modal popup-modal fixed top-0 left-0 w-full h-full m-auto"
      {{ block.shopify_attributes }}
    >
      <div
        role="dialog"
        aria-label="Dialog Modal"
        aria-modal="true"
        class="product-popup-modal__content popup-modal__content absolute w-full h-auto m-auto"
        tabindex="-1"
      >
        <div class="product-popup-modal__content-info relative mx-auto popup-modal__content-info">
          <button
            id="ModalClose-{{ block.id }}"
            type="button"
            class="product-popup-modal__toggle popup-modal__toggle block border-none rounded-circle absolute z-index-3 button--close"
            aria-label="{{ 'general.accessibility.close' | t }}"
          >
            <span class="i__close e-none block relative color-current w-full h-full"></span>
          </button>
          <div class="product-popup-modal__carousel" data-slideshow id="ModalCarousel-{{ block.id }}">
            {% for index in (1..4) %}
              {%- capture description_index -%}description_{{ index }}{%- endcapture -%}
              {%- capture image_index -%}picture_{{ index }}{%- endcapture -%}
              {%- capture title_index -%}title_{{ index }}{%- endcapture -%}
              {% liquid
                assign desc = product.metafields.custom.product_features.value[description_index].value
                assign img = product.metafields.custom.product_features.value[image_index].value
                assign title = product.metafields.custom.product_features.value[title_index].value
              %}
              {%- if img != blank and title != blank -%}
                <div class="carousel-item">
                  <div class="carousel-item--inner flex gap-x">
                    {%- if img != blank -%}
                      <div class="carousel-item--image shrink-0">
                        {% render 'image-element',
                          img: img,
                          classes: 'rounded-sm-large',
                          img_width: 450,
                          img_height: 450,
                          sizes: '450px'
                        %}
                      </div>
                    {%- endif -%}
                    <div class="carousel-item--content">
                      {%- if title != blank -%}
                        <div class="carousel-item--title text-lg f-bold">{{ title }}</div>
                      {%- endif -%}
                      {%- if desc != blank -%}
                        <div class="carousel-item--desc text-sm">{{ desc }}</div>
                      {%- endif -%}
                    </div>
                  </div>
                </div>
              {%- endif -%}
            {% endfor %}
            
            <!-- Carousel Navigation -->
            <div class="carousel-navigation">
              <button class="carousel-nav carousel-nav--prev" aria-label="Previous slide">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button class="carousel-nav carousel-nav--next" aria-label="Next slide">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </modal-dialog>
  {%- endif -%}
{%- endfor -%}

<script>
/**
 * Simple Fixed-Width Sticky for Step 1
 */
function initStep1Sticky(productSection) {
  if (!productSection) return;
  if (window.innerWidth < 991) return; // Desktop only

  const gridContainer = productSection.querySelector('.grid');
  const imageColumn = productSection.querySelector('.product-grid__images');
  const infoColumn = productSection.querySelector('.product-grid__info');

  if (!gridContainer || !imageColumn || !infoColumn) return;

  // Lock column widths immediately to prevent layout shifts
  const setupFixedWidths = () => {
    if (window.innerWidth < 991) return;

    requestAnimationFrame(() => {
      const imageColWidth = imageColumn.offsetWidth;
      const infoColWidth = infoColumn.offsetWidth;
      
      // Lock both columns at their current width
      imageColumn.style.width = `${imageColWidth}px`;
      imageColumn.style.minWidth = `${imageColWidth}px`;
      imageColumn.style.maxWidth = `${imageColWidth}px`;
        imageColumn.style.flexShrink = '0';
      
      infoColumn.style.width = `${infoColWidth}px`;
      infoColumn.style.minWidth = `${infoColWidth}px`;
      infoColumn.style.maxWidth = `${infoColWidth}px`;
        infoColumn.style.flexShrink = '0';
      
      // Make image column sticky
      imageColumn.style.position = 'sticky';
      imageColumn.style.top = '120px';
      imageColumn.style.alignSelf = 'start';
      
      console.log('‚úÖ Step 1 - Locked widths:', {
        imageWidth: imageColWidth,
        infoWidth: infoColWidth
      });
    });
  };
  
  setupFixedWidths();
  
  // Re-run on window resize
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      setupFixedWidths();
    }, 250);
  });
  
  // Re-run when accordions toggle
  const accordions = productSection.querySelectorAll('details.product-accordion');
  accordions.forEach(accordion => {
    accordion.addEventListener('toggle', () => {
      setTimeout(setupFixedWidths, 10);
    });
  });
}

// Initialize sticky for Step 1 only
const step1Section = document.querySelector('.bundle-step-1');
if (step1Section) {
  initStep1Sticky(step1Section);
}

// Re-initialize if section reloaded
document.addEventListener('shopify:section:load', function(event) {
  if (event.detail.sectionId === '{{ section.id }}') {
    const reloadedStep1 = document.querySelector('.bundle-step-1');
    if (reloadedStep1) {
      initStep1Sticky(reloadedStep1);
    }
  }
});

// Initialize sticky columns for step 2 - KEEP THIS
(function() {
  if (false) {
    requestAnimationFrame(() => {
        // Measure the inner content elements, not the grid containers which are equal height.
        const imageColHeight = imageColumnInner.offsetHeight;
        const infoColHeight = infoColumnInner.offsetHeight;
        
        // Store original widths to maintain consistent sizing during sticky states
        let imageColOriginalWidth = imageColumnInner.offsetWidth;
        const infoColOriginalWidth = infoColumnInner.offsetWidth;
        
        // LOCK THE WIDTHS FOREVER - This prevents any sizing changes during sticky scrolling
        console.log('üîí Locking image column width at:', imageColOriginalWidth);
        console.log('üîí Locking info column width at:', infoColOriginalWidth);
        
        // Lock the image column width immediately
        imageColumn.style.width = `${imageColOriginalWidth}px`;
        imageColumn.style.maxWidth = `${imageColOriginalWidth}px`;
        imageColumn.style.minWidth = `${imageColOriginalWidth}px`;
        imageColumn.style.flexShrink = '0';
        imageColumn.style.flexGrow = '0';
        
        // Lock the info column width immediately  
        infoColumn.style.width = `${infoColOriginalWidth}px`;
        infoColumn.style.maxWidth = `${infoColOriginalWidth}px`;
        infoColumn.style.minWidth = `${infoColOriginalWidth}px`;
        infoColumn.style.flexShrink = '0';
        infoColumn.style.flexGrow = '0';
        
        // LOCK THE PHOTOS CONTAINER WIDTH - This is the key fix!
        const photosContainer = imageColumnInner.querySelector('.product__photos');
        if (photosContainer) {
          const photosWidth = photosContainer.offsetWidth;
          console.log('üîí Locking photos container width at:', photosWidth);
          photosContainer.style.width = `${photosWidth}px`;
          photosContainer.style.maxWidth = `${photosWidth}px`;
          photosContainer.style.minWidth = `${photosWidth}px`;
          photosContainer.style.flexShrink = '0';
          photosContainer.style.flexGrow = '0';
        }
        
        // LOCK THE SLIDESHOW CONTAINER WIDTH
        const slideshowContainer = imageColumnInner.querySelector('.product-slideshow');
        if (slideshowContainer) {
          const slideshowWidth = slideshowContainer.offsetWidth;
          console.log('üîí Locking slideshow container width at:', slideshowWidth);
          slideshowContainer.style.width = `${slideshowWidth}px`;
          slideshowContainer.style.maxWidth = `${slideshowWidth}px`;
          slideshowContainer.style.minWidth = `${slideshowWidth}px`;
          slideshowContainer.style.flexShrink = '0';
          slideshowContainer.style.flexGrow = '0';
        }
        
        // LOCK THE MAIN PHOTOS CONTAINER WIDTH
        const mainPhotosContainer = imageColumnInner.querySelector('.product__main-photos');
        if (mainPhotosContainer) {
          const mainPhotosWidth = mainPhotosContainer.offsetWidth;
          console.log('üîí Locking main photos container width at:', mainPhotosWidth);
          mainPhotosContainer.style.width = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.maxWidth = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.minWidth = `${mainPhotosWidth}px`;
          mainPhotosContainer.style.flexShrink = '0';
          mainPhotosContainer.style.flexGrow = '0';
        }
        
        // For carousel, get the actual rendered width from CSS computed styles
        const carouselContainer = imageColumnInner.querySelector('.product__photos--below') || 
                                 imageColumnInner.querySelector('.product-slideshow');
        if (carouselContainer) {
          // Get computed style to see the actual rendered width
          const computedStyle = window.getComputedStyle(carouselContainer);
          const computedWidth = parseFloat(computedStyle.width);
          
          // Debug: log the widths to console
          console.log('Carousel debug:', {
            offsetWidth: imageColumnInner.offsetWidth,
            computedWidth: computedWidth,
            carouselContainer: carouselContainer
          });
          
          // Use the actual computed width - this respects the responsive CSS max-width
          if (computedWidth && computedWidth > 0) {
            imageColOriginalWidth = computedWidth; // This already respects min(765px, 50vw)
            console.log('Using responsive carousel width:', computedWidth);
          } else {
            // Fallback: try to get width from the main image
            const mainImage = carouselContainer.querySelector('.product-main-slide img') || 
                             carouselContainer.querySelector('.product__photo img');
            if (mainImage) {
              const imageWidth = mainImage.naturalWidth || mainImage.offsetWidth;
              imageColOriginalWidth = Math.min(imageWidth, 765); // Apply reasonable max
            } else {
              // Last fallback: use container width with reasonable max
              imageColOriginalWidth = Math.min(imageColOriginalWidth, 765);
            }
          }
        }
            
        // Exit if columns are of similar height, as no sticky effect is needed.
        if (Math.abs(imageColHeight - infoColHeight) < 100) {
            return;
        }

        const shortCol = imageColHeight > infoColHeight ? infoColumn : imageColumn;
        const shortColInner = imageColHeight > infoColHeight ? infoColumnInner : imageColumnInner;
        const shortColOriginalWidth = imageColHeight > infoColHeight ? infoColOriginalWidth : imageColOriginalWidth;
        
        // **FIX**: Set position relative on the container of the element that will be docked.
        // This makes it the positioning context for its absolutely positioned child.
        shortCol.style.position = 'relative';
        // Set an explicit height on the short column's container to prevent the grid from collapsing
        // when its inner element is taken out of the document flow with `position: fixed`.
        shortCol.style.height = `${shortCol.offsetHeight}px`;

        const headerOffset = 120; // Adjust if your sticky header's height changes

        scrollHandler = () => {
            const scrollY = window.scrollY;
            const gridRect = gridContainer.getBoundingClientRect();
            const shortColInnerHeight = shortColInner.offsetHeight;
            const gridAbsoluteTop = gridRect.top + scrollY;
            const startPoint = gridAbsoluteTop - headerOffset;
            const stopPoint = gridAbsoluteTop + gridRect.height - shortColInnerHeight - headerOffset;
            const buffer = 2; // A small buffer to prevent jittering at the thresholds
            
            if (scrollY > startPoint + buffer && scrollY < stopPoint - buffer) {
                // State 1: STICKY. The element is fixed relative to the viewport.
                shortColInner.style.position = 'fixed';
                shortColInner.style.top = `${headerOffset}px`;
                shortColInner.style.bottom = 'auto';
                // Use the locked width - no calculations needed
                shortColInner.style.width = `${shortColOriginalWidth}px`;
                shortColInner.style.maxWidth = `${shortColOriginalWidth}px`;
            } else if (scrollY >= stopPoint - buffer) {
                // State 2: DOCKED. The element is positioned absolutely to the bottom of its parent container.
                shortColInner.style.position = 'absolute';
                shortColInner.style.top = 'auto';
                shortColInner.style.bottom = '0px';
                // Use the locked width - no calculations needed
                shortColInner.style.width = `${shortColOriginalWidth}px`;
                shortColInner.style.maxWidth = `${shortColOriginalWidth}px`;
            } else {
                // State 3: DEFAULT. The element is in its normal static position.
                shortColInner.style.position = '';
                shortColInner.style.top = '';
                shortColInner.style.bottom = '';
                shortColInner.style.width = '';
            }
        };
        
        window.addEventListener('scroll', scrollHandler, { passive: true });
        scrollHandler(); // Run once immediately on setup to get the initial state right
    });
  };
  
  const debounce = (func, delay) => {
      let timeout;
      return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
      };
  };

  const debouncedSetup = debounce(setupStickyColumns, 250);

  // --- Event Listeners ---

  // Run on initial load when all assets are ready
  window.addEventListener('load', debouncedSetup);
  // A fallback for DOMContentLoaded in case `load` is slow, e.g., with deferred scripts
  document.addEventListener('DOMContentLoaded', () => setTimeout(debouncedSetup, 500));
  
  // Re-run when the browser is resized
  window.addEventListener('resize', debouncedSetup);

  // Re-run whenever an interactive element (accordion/dropdown) is toggled
  interactiveElements.forEach(el => {
    const eventName = el.tagName.toLowerCase() === 'details' ? 'toggle' : 'click';
    el.addEventListener(eventName, debouncedSetup);
  });
}

// Initialize sticky columns for step 2
function initializeStep2StickyColumns() {
  const step2Element = container.querySelector('.bundle-step-2');
  if (!step2Element) return;
  
  const gridContainer = step2Element.querySelector('.grid');
  const imageColumn = step2Element.querySelector('.product-single__sticky');
  const infoColumn = step2Element.querySelector('.product-single__meta').parentElement;
  const imageColumnInner = imageColumn ? imageColumn.querySelector('.product-column-content') : null;
  const infoColumnInner = infoColumn ? infoColumn.querySelector('.product-single__meta') : null;
  
  if (!gridContainer || !imageColumn || !infoColumn || !imageColumnInner || !infoColumnInner) {
    console.log('Step 2 sticky elements not found');
    return;
  }
  
  console.log('Initializing step 2 sticky columns');
  
  const setupStickyColumns = () => {
    // Clean up styles from previous calculations before re-running
    window.removeEventListener('scroll', scrollHandler);
    imageColumnInner.style.cssText = '';
    infoColumnInner.style.cssText = '';
    imageColumn.style.height = '';
    infoColumn.style.height = '';
    imageColumn.style.position = '';
    infoColumn.style.position = '';

    // This logic is for desktop viewports only
    if (window.innerWidth < 991) {
      return;
    }

    requestAnimationFrame(() => {
      // Measure the inner content elements, not the grid containers which are equal height.
      const imageColHeight = imageColumnInner.offsetHeight;
      const infoColHeight = infoColumnInner.offsetHeight;
      
      // Store original widths to maintain consistent sizing during sticky states
      const imageColWidth = imageColumnInner.offsetWidth;
      const infoColWidth = infoColumnInner.offsetWidth;
      
      // Set the grid container height to the taller column
      const maxHeight = Math.max(imageColHeight, infoColHeight);
      gridContainer.style.height = maxHeight + 'px';
      
      // Make the image column sticky
      imageColumn.style.position = 'sticky';
      imageColumn.style.top = '120px';
      imageColumn.style.alignSelf = 'start';
      
      // Set up scroll handler for dynamic positioning
      let scrollHandler = () => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const containerRect = gridContainer.getBoundingClientRect();
        const containerTop = containerRect.top + scrollTop;
        const containerBottom = containerTop + gridContainer.offsetHeight;
        const viewportBottom = scrollTop + window.innerHeight;
        
        // Calculate sticky positioning
        if (scrollTop + 120 >= containerTop && scrollTop + 120 < containerBottom - imageColHeight) {
          imageColumnInner.style.position = 'sticky';
          imageColumnInner.style.top = '120px';
        } else if (scrollTop + 120 >= containerBottom - imageColHeight) {
          imageColumnInner.style.position = 'absolute';
          imageColumnInner.style.top = (containerBottom - imageColHeight - containerTop) + 'px';
        } else {
          imageColumnInner.style.position = 'static';
          imageColumnInner.style.top = 'auto';
        }
      };
      
      // Add scroll listener
      window.addEventListener('scroll', scrollHandler);
      
      // Initial call
      scrollHandler();
    });
  };
  
  // Debounce function
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };
  
  const debouncedSetup = debounce(setupStickyColumns, 250);
  
  // Run setup
  debouncedSetup();
  
  // Re-run when the browser is resized
  window.addEventListener('resize', debouncedSetup);
}
</script>

{% style %}
  /* Showroom List Styling */
  .showroom-list {
    display: block;
    margin: 0;
    padding: 0;
  }

  .showroom-item {
    margin-bottom: 20px;
    padding: 0;
    line-height: 1.5;
  }

  .showroom-item:last-child {
    margin-bottom: 0;
  }

  .showroom-item strong {
    font-weight: 600;
    color: #1C2C58;
    display: block;
    margin-bottom: 5px;
  }

  .showroom-item span {
    display: block;
    margin-bottom: 5px;
    color: #666;
  }

  .showroom-item a {
    color: #1C2C58;
    text-decoration: none;
    font-weight: 500;
  }

  .showroom-item a:hover {
    text-decoration: underline;
  }

  /* Store System Accordion Content Styling */
  .product-accordion-content p {
    margin-bottom: 15px;
    line-height: 1.5;
  }

  .product-accordion-content p:last-child {
    margin-bottom: 0;
  }

  .product-accordion-content strong {
    font-weight: 600;
    color: #1C2C58;
  }

  .product-accordion-content a {
    color: #1C2C58;
    text-decoration: none;
    font-weight: 500;
  }

  .product-accordion-content a:hover {
    text-decoration: underline;
  }
{% endstyle %}

{% schema %}
{
  "name": "Product Bundle",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section width",
      "options": [
        {
          "value": "page-width",
          "label": "Page width"
        },
        {
          "value": "customize_width",
          "label": "Customize width"
        }
      ],
      "default": "page-width"
    },
    {
      "type": "range",
      "id": "customize_width",
      "min": 800,
      "max": 2000,
      "step": 20,
      "unit": "px",
      "label": "Customize width",
      "default": 1800
    },
    {
      "type": "product_list",
      "id": "bundle_products",
      "label": "Bundle Products",
      "info": "Ch·ªçn c√°c s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã trong Step 2 c·ªßa bundle builder",
      "limit": 10
    },
    {
      "type": "range",
      "id": "product_3_quantity",
      "min": 1,
      "max": 10,
      "step": 1,
      "label": "S·ªë l∆∞·ª£ng s·∫£n ph·∫©m th·ª© 3",
      "info": "N·∫øu s·∫£n ph·∫©m th·ª© 3 l√† g·ªëi/ph·ª• ki·ªán, c√≥ th·ªÉ set s·ªë l∆∞·ª£ng > 1",
      "default": 2
    },
    {
      "type": "checkbox",
      "id": "sku_enable",
      "label": "Show SKU",
      "default": true
    },
    {
      "type": "header",
      "content": "Step 1 Content Settings"
    },
    {
      "type": "text",
      "id": "combo_title",
      "label": "Combo Products Title",
      "default": "Combo bao g·ªìm c√°c s·∫£n ph·∫©m:"
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "CTA Button Text",
      "default": "B·∫ÆT ƒê·∫¶U T·∫†O COMBO"
    },
    {
      "type": "header",
      "content": "üí∞ Bundle Pricing Calculator"
    },
    {
      "type": "range",
      "id": "target_discount_percentage",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "%",
      "label": "üéØ Target Bundle Discount",
      "info": "M·ª©c gi·∫£m gi√° m·ª•c ti√™u b·∫°n mu·ªën kh√°ch h√†ng th·∫•y (so v·ªõi Compare-at price)",
      "default": 15
    },
    {
      "type": "paragraph",
      "content": "H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG CALCULATOR:\n\n1Ô∏è Nh·∫≠p % gi·∫£m gi√° m·ª•c ti√™u ·ªü tr√™n (VD: 15%)\n\n2Ô∏è Save v√† Preview theme ƒë·ªÉ xem calculator t·ª± ƒë·ªông t√≠nh\n\n3Ô∏è Calculator s·∫Ω hi·ªÉn th·ªã:\n   ‚Ä¢ % gi·∫£m hi·ªán t·∫°i c·ªßa products (t·ª´ Price vs Compare-at price)\n   ‚Ä¢ % voucher c·∫ßn t·∫°o th√™m\n   ‚Ä¢ Gi√° cu·ªëi c√πng kh√°ch h√†ng s·∫Ω th·∫•y\n\n4Ô∏è V√†o Shopify Admin ‚Üí Discounts ‚Üí Create discount v·ªõi % ƒë∆∞·ª£c g·ª£i √Ω"
    },
    {
      "type": "header",
      "content": "Service Grid Settings"
    },
    {
      "type": "image_picker",
      "id": "service_icon_1",
      "label": "Service Icon 1 (100 ƒë√™m ng·ªß th·ª≠)"
    },
    {
      "type": "text",
      "id": "service_text_1",
      "label": "Service Text 1",
      "default": "100 ƒë√™m ng·ªß th·ª≠"
    },
    {
      "type": "image_picker",
      "id": "service_icon_2",
      "label": "Service Icon 2 (Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn)"
    },
    {
      "type": "text",
      "id": "service_text_2",
      "label": "Service Text 2",
      "default": "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn"
    },
    {
      "type": "image_picker",
      "id": "service_icon_3",
      "label": "Service Icon 3 (B·∫£o h√†nh d√†i l√¢u)"
    },
    {
      "type": "text",
      "id": "service_text_3",
      "label": "Service Text 3",
      "default": "B·∫£o h√†nh d√†i l√¢u"
    },
    {
      "type": "image_picker",
      "id": "service_icon_4",
      "label": "Service Icon 4 (Thanh to√°n linh ho·∫°t)"
    },
    {
      "type": "text",
      "id": "service_text_4",
      "label": "Service Text 4",
      "default": "Thanh to√°n linh ho·∫°t"
    },
    {
      "type": "select",
      "id": "image_position",
      "label": "Image position",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "right"
    },
    {
      "type": "checkbox",
      "id": "product_zoom_enable",
      "label": "Enable image zoom",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "product_carousel_enable",
      "label": "Enable product carousel",
      "default": false
    },
    {
      "type": "select",
      "id": "thumbnail_position",
      "label": "Thumbnail position",
      "options": [
        {
          "value": "beside",
          "label": "Beside main image"
        },
        {
          "value": "below",
          "label": "Below main image"
        }
      ],
      "default": "beside"
    },
    {
      "type": "range",
      "id": "thumbnail_height",
      "min": 60,
      "max": 120,
      "step": 10,
      "unit": "px",
      "label": "Thumbnail height",
      "default": 100
    },
    {
      "type": "checkbox",
      "id": "thumbnail_arrows",
      "label": "Show thumbnail arrows",
      "default": false
    },
    {
      "type": "select",
      "id": "mobile_layout",
      "label": "Mobile layout",
      "options": [
        {
          "value": "partial",
          "label": "Partial"
        },
        {
          "value": "stacked",
          "label": "Stacked"
        }
      ],
      "default": "partial"
    },
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "label": "Enable video looping",
      "default": false
    },
    {
      "type": "select",
      "id": "product_video_style",
      "label": "Video style",
      "options": [
        {
          "value": "muted",
          "label": "Muted"
        },
        {
          "value": "unmuted",
          "label": "Unmuted"
        }
      ],
      "default": "muted"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_add_to_cart",
      "label": "Enable sticky add to cart",
      "default": false
    },
    {
      "type": "richtext",
      "id": "store_system_content",
      "label": "H·ªá th·ªëng c·ª≠a h√†ng",
      "info": "Nh·∫≠p th√¥ng tin h·ªá th·ªëng c·ª≠a h√†ng. C√≥ th·ªÉ s·ª≠ d·ª•ng HTML v√† links.",
      "default": "<p><strong>Q.2, TP.HCM:</strong><br>Shop 09, B2 Sarimi, Khu ƒê√¥ Th·ªã Sala, 72 Nguy·ªÖn C∆° Th·∫°ch, P. An L·ª£i ƒê√¥ng<br><a href=\"tel:0964777960\">0964777960</a></p><p><strong>Q.3, TP.HCM:</strong><br>283A Hai B√† Tr∆∞ng, Ph∆∞·ªùng Xu√¢n Ho√†<br><a href=\"tel:0964777910\">0964777910</a></p><p><strong>Q. C·∫ßu Gi·∫•y, HN:</strong><br>228 C·∫ßu Gi·∫•y, Quan Hoa<br><a href=\"tel:0964777940\">0964777940</a></p>"
    },
    {
      "type": "checkbox",
      "id": "hide_payment_button_mobile",
      "label": "Hide payment button on mobile",
      "default": false
    },
    {
      "type": "select",
      "id": "image_size",
      "label": "Image size",
      "default": "medium",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ]
    },
    {
      "type": "header",
      "content": "Showroom Settings"
    },
    {
      "type": "text",
      "id": "showroom_1_name",
      "label": "Showroom 1 Name",
      "default": "Showroom 1"
    },
    {
      "type": "text",
      "id": "showroom_1_address",
      "label": "Showroom 1 Address",
      "default": "ƒê·ªãa ch·ªâ showroom"
    },
    {
      "type": "text",
      "id": "showroom_1_phone",
      "label": "Showroom 1 Phone",
      "default": "0964777910"
    },
    {
      "type": "url",
      "id": "showroom_1_map_link",
      "label": "Showroom 1 Map Link"
    },
    {
      "type": "text",
      "id": "showroom_2_name",
      "label": "Showroom 2 Name",
      "default": "Showroom 2"
    },
    {
      "type": "text",
      "id": "showroom_2_address",
      "label": "Showroom 2 Address",
      "default": "ƒê·ªãa ch·ªâ showroom"
    },
    {
      "type": "text",
      "id": "showroom_2_phone",
      "label": "Showroom 2 Phone",
      "default": "0964777910"
    },
    {
      "type": "url",
      "id": "showroom_2_map_link",
      "label": "Showroom 2 Map Link"
    },
    {
      "type": "text",
      "id": "showroom_3_name",
      "label": "Showroom 3 Name",
      "default": "Showroom 3"
    },
    {
      "type": "text",
      "id": "showroom_3_address",
      "label": "Showroom 3 Address",
      "default": "ƒê·ªãa ch·ªâ showroom"
    },
    {
      "type": "text",
      "id": "showroom_3_phone",
      "label": "Showroom 3 Phone",
      "default": "0964777940"
    },
    {
      "type": "url",
      "id": "showroom_3_map_link",
      "label": "Showroom 3 Map Link"
    },
    {
      "type": "header",
      "content": "Review Settings"
    },
    {
      "type": "text",
      "id": "review_rating",
      "label": "Review Rating",
      "default": "4.8"
    },
    {
      "type": "text",
      "id": "review_count",
      "label": "Review Count",
      "default": "2025 ƒë√°nh gi√°"
    },
    {
      "type": "text",
      "id": "voucher_code",
      "label": "M√£ voucher cho bundle",
      "info": "Nh·∫≠p m√£ gi·∫£m gi√° s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông √°p d·ª•ng khi kh√°ch h√†ng th√™m bundle v√†o gi·ªè h√†ng. V√≠ d·ª•: BUNDLE15, BUNDLE20, etc. M√£ n√†y ph·∫£i ƒë∆∞·ª£c t·∫°o trong Shopify Admin ‚Üí Discounts tr∆∞·ªõc."
    }
  ],
  "blocks": [
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "variant_labels",
          "label": "Show variant labels",
          "default": true
        },
        {
          "type": "select",
          "id": "picker_type",
          "label": "Picker type",
          "options": [
            {
              "value": "button",
              "label": "Buttons"
            },
            {
              "value": "dropdown",
              "label": "Dropdown"
            }
          ],
          "default": "button"
        },
        {
          "type": "checkbox",
          "id": "product_dynamic_variants_enable",
          "label": "Enable dynamic variants",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "color_swatches",
          "label": "Enable color swatches",
          "default": false
        }
      ]
    },
    {
      "type": "quantity_selector",
      "name": "Quantity selector",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "label": "Show dynamic checkout",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "surface_pickup_enable",
          "label": "Enable surface pickup",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_gift_card_recipient",
          "label": "Show gift card recipient",
          "default": false
        }
      ]
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1
    },
    {
      "type": "product_combo",
      "name": "Product Combo",
      "limit": 1,
      "settings": []
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "is_tab",
          "label": "Show as tab",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "collapse_content",
          "label": "Collapse content",
          "default": false
        }
      ]
    },
    {
      "type": "icon_with_text",
      "name": "Icon with Text",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "Icon 1"
        },
        {
          "type": "image_picker",
          "id": "icon_1_image",
          "label": "Icon 1 Image"
        },
        {
          "type": "text",
          "id": "icon_1_heading",
          "label": "Icon 1 Heading",
          "default": "100 ƒë√™m ng·ªß th·ª≠"
        },
        {
          "type": "header",
          "content": "Icon 2"
        },
        {
          "type": "image_picker",
          "id": "icon_2_image",
          "label": "Icon 2 Image"
        },
        {
          "type": "text",
          "id": "icon_2_heading",
          "label": "Icon 2 Heading",
          "default": "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn *"
        },
        {
          "type": "header",
          "content": "Icon 3"
        },
        {
          "type": "image_picker",
          "id": "icon_3_image",
          "label": "Icon 3 Image"
        },
        {
          "type": "text",
          "id": "icon_3_heading",
          "label": "Icon 3 Heading",
          "default": "B·∫£o h√†nh d√†i l√¢u"
        },
        {
          "type": "header",
          "content": "Icon 4"
        },
        {
          "type": "image_picker",
          "id": "icon_4_image",
          "label": "Icon 4 Image"
        },
        {
          "type": "text",
          "id": "icon_4_heading",
          "label": "Icon 4 Heading",
          "default": "Ch·∫•t li·ªáu Foam cao c·∫•p"
        },
        {
          "type": "header",
          "content": "Layout Settings"
        },
        {
          "type": "range",
          "id": "icon_size",
          "min": 20,
          "max": 60,
          "step": 5,
          "unit": "px",
          "label": "Icon Size",
          "default": 25
        },
        {
          "type": "select",
          "id": "icon_alignment",
          "label": "Icon Alignment",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "center"
        },
        {
          "type": "select",
          "id": "grid_columns",
          "label": "Layout Style",
          "options": [
            {
              "value": "1",
              "label": "1 c·ªôt"
            },
            {
              "value": "2",
              "label": "2 c·ªôt (2x2)"
            }
          ],
          "default": "2"
        },
        {
          "type": "checkbox",
          "id": "show_icon_4",
          "label": "Show Icon 4",
          "default": true
        }
      ]
    },
    {
      "type": "carousel_modal",
      "name": "Carousel modal",
      "limit": 1,
      "settings": []
    }
  ],
  "presets": [
    {
      "name": "Product Bundle",
      "blocks": [
        {
          "type": "variant_picker"
        },
        {
          "type": "quantity_selector"
        },
        {
          "type": "price"
        },
        {
          "type": "description"
        },
        {
          "type": "icon_with_text"
        }
      ]
    }
  ]
}
{% endschema %}