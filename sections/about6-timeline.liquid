{%- comment -%} Include Design System CSS {%- endcomment -%}
{% render 'about-design-system' %}

<style>
/* Timeline Section */
.about-timeline {
  position: relative;
  padding: var(--space-5xl) 0;
}

.about-timeline__container {
  position: relative;
  max-width: 1594px;
  margin: 0 auto;
  padding: 0 var(--container-padding-desktop);
}

/* Vertical line - centered in container - MUST BE VISIBLE */
.about-timeline__line {
  position: absolute;
  left: 50%;
  top: 0;
  width: 2px !important;
  background: #1C2C58 !important;
  border-radius: 5px;
  transform: translateX(-50%);
  z-index: 1;
  height: calc(100% - 0px);
  min-height: 500px;
  pointer-events: none;
}

.about-timeline__steps {
  display: flex;
  flex-direction: column;
  gap: 0;
  position: relative;
  z-index: 2;
}

.about-timeline__step {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 40px;
  position: relative;
  align-items: center;
  padding-bottom: 100px;
  min-height: 400px;
  width: 100%;
}

.about-timeline__step:last-child {
  padding-bottom: 0;
}

/* Step với image bên trái đường kẻ, text bên phải đường kẻ */
.about-timeline__step--right {
  grid-template-columns: 1fr 1fr;
}

.about-timeline__step--right .about-timeline__step-image {
  grid-column: 1;
  justify-self: end;
  margin-right: 40px;
}

.about-timeline__step--right .about-timeline__step-content {
  grid-column: 2;
  text-align: left;
  padding-left: 40px;
}

/* Step với text bên trái đường kẻ, image bên phải đường kẻ */
.about-timeline__step--left {
  grid-template-columns: 1fr 1fr;
}

.about-timeline__step--left .about-timeline__step-content {
  grid-column: 1;
  text-align: right;
  padding-right: 40px;
}

.about-timeline__step--left .about-timeline__step-image {
  grid-column: 2;
  justify-self: start;
  margin-left: 40px;
}

.about-timeline__step-image {
  width: 630px;
  height: 400px;
  border: 7px solid #DBE8FF;
  border-radius: 5px;
  overflow: hidden;
  background: var(--color-background-light);
  position: relative;
  flex-shrink: 0;
}

.about-timeline__step-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.about-timeline__step-content {
  padding-top: 0;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.about-timeline__step-title {
  font-size: 27px;
  font-weight: var(--font-weight-bold);
  color: #1c2c58;
  margin-bottom: 24px;
  line-height: 1.4;
}

.about-timeline__step-description {
  font-size: var(--font-size-xl);
  line-height: 1.4;
  color: var(--color-text-primary);
}

/* SVG Circle positioned at center line, aligned with title */
.about-timeline__step-dot {
  position: absolute;
  left: 50%;
  top: 0;
  width: 31px;
  height: 31px;
  transform: translateX(-50%);
  z-index: 3;
  margin-top: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.about-timeline__step-dot svg {
  width: 31px;
  height: 31px;
  display: block;
}

/* Responsive */
@media (max-width: 749px) {
  .about-timeline {
    padding: 0;
  }
  
  .about-timeline__container {
    padding: 0 15px;
    position: relative;
  }
  
  .about-timeline__line {
    left: 50%; /* Ở giữa như desktop */
    transform: translateX(-50%);
    width: 2px;
    background: #1c2c58;
    border-radius: 5px;
    min-height: 667px;
  }
  
  .about-timeline__step {
    grid-template-columns: 1fr 1fr; /* Giữ nguyên như desktop */
    gap: 20px; /* Thu nhỏ gap từ 40px */
    min-height: auto;
    padding-bottom: 50px; /* Thu nhỏ padding từ 100px */
    align-items: center;
  }
  
  /* Giữ nguyên layout alternating như desktop */
  .about-timeline__step--right .about-timeline__step-image {
    grid-column: 1;
    justify-self: end;
    margin-right: 20px; /* Thu nhỏ margin từ 40px */
    padding-left: 15px; /* Padding trái để không sát viền */
  }
  
  .about-timeline__step--right .about-timeline__step-content {
    grid-column: 2;
    text-align: left;
    padding-left: 20px; /* Thu nhỏ padding từ 40px */
    padding-right: 15px; /* Padding phải để không sát viền */
  }
  
  .about-timeline__step--left .about-timeline__step-content {
    grid-column: 1;
    text-align: right;
    padding-right: 20px; /* Thu nhỏ padding từ 40px */
    padding-left: 15px; /* Padding trái để không sát viền */
  }
  
  .about-timeline__step--left .about-timeline__step-image {
    grid-column: 2;
    justify-self: start;
    margin-left: 20px; /* Thu nhỏ margin từ 40px */
    padding-right: 15px; /* Padding phải để không sát viền */
  }
  
  /* Thu nhỏ kích thước ảnh */
  .about-timeline__step-image {
    width: 100%;
    max-width: 315px; /* Thu nhỏ từ 630px xuống 50% */
    height: auto;
    aspect-ratio: 630 / 400; /* Giữ nguyên tỷ lệ */
    border: 3px solid #dbe8ff; /* Thu nhỏ border từ 7px */
    border-radius: 5px;
  }
  
  .about-timeline__step-title {
    font-size: 14px;
    font-weight: 700;
    color: #1c2c58;
    line-height: 1.4;
    margin-bottom: 8px;
  }
  
  .about-timeline__step-description {
    font-size: 14px; /* Đồng bộ với title */
    line-height: 1.4;
    color: #000;
  }
  
  .about-timeline__step-dot {
    left: 50%; /* Ở giữa như desktop */
    width: 8px;
    height: 8px;
    transform: translateX(-50%);
  }
  
  .about-timeline__step-dot svg {
    width: 8px;
    height: 8px;
  }
  
  .about-timeline__step-dot svg circle {
    r: 4;
    stroke-width: 0;
  }
}

@media (min-width: 750px) and (max-width: 1199px) {
  .about-timeline__container {
    padding: 0 var(--container-padding-tablet);
  }
  
  .about-timeline__step-image {
    width: 100%;
    max-width: 500px;
  }
}
</style>

<section class="about-section about-timeline">
  <div class="about-timeline__container">
    <div class="about-timeline__line"></div>
    <div class="about-timeline__steps">
      {%- for block in section.blocks -%}
        <div class="about-timeline__step about-timeline__step--{{ block.settings.position }}" {{ block.shopify_attributes }}>
          {%- if block.settings.position == 'right' -%}
            <div class="about-timeline__step-image">
              {%- if block.settings.image -%}
                <img 
                  src="{{ block.settings.image | img_url: '1260x800' }}" 
                  alt="{{ block.settings.image.alt | default: block.settings.title }}"
                  loading="lazy"
                >
              {%- endif -%}
            </div>
            <div class="about-timeline__step-content">
              {%- if block.settings.title != blank -%}
                <h3 class="about-timeline__step-title">{{ block.settings.title }}</h3>
              {%- endif -%}
              {%- if block.settings.description != blank -%}
                <p class="about-timeline__step-description">{{ block.settings.description }}</p>
              {%- endif -%}
            </div>
          {%- else -%}
            <div class="about-timeline__step-content">
              {%- if block.settings.title != blank -%}
                <h3 class="about-timeline__step-title">{{ block.settings.title }}</h3>
              {%- endif -%}
              {%- if block.settings.description != blank -%}
                <p class="about-timeline__step-description">{{ block.settings.description }}</p>
              {%- endif -%}
            </div>
            <div class="about-timeline__step-image">
              {%- if block.settings.image -%}
                <img 
                  src="{{ block.settings.image | img_url: '1260x800' }}" 
                  alt="{{ block.settings.image.alt | default: block.settings.title }}"
                  loading="lazy"
                >
              {%- endif -%}
            </div>
          {%- endif -%}
          <div class="about-timeline__step-dot">
            <svg xmlns="http://www.w3.org/2000/svg" width="31" height="31" viewBox="0 0 31 31" fill="none">
              <circle cx="15.5" cy="15.5" r="12" fill="#1C2C58" stroke="#FFF" stroke-width="7"/>
            </svg>
          </div>
        </div>
      {%- endfor -%}
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const timelineContainer = document.querySelector('.about-timeline__container');
  const timelineLine = document.querySelector('.about-timeline__line');
  const timelineSteps = document.querySelectorAll('.about-timeline__step');
  
  if (!timelineContainer || !timelineLine) {
    console.error('Timeline container or line not found');
    return;
  }
  
  // Update line height to match steps container
  const updateLineHeight = () => {
    const stepsContainer = timelineContainer.querySelector('.about-timeline__steps');
    if (stepsContainer && timelineLine) {
      const stepsHeight = stepsContainer.offsetHeight;
      if (stepsHeight > 0) {
        timelineLine.style.height = `${stepsHeight}px`;
        timelineLine.style.display = 'block';
        console.log('Timeline line height updated to:', stepsHeight);
      } else {
        // Fallback: calculate from steps
        let totalHeight = 0;
        timelineSteps.forEach((step, index) => {
          totalHeight += step.offsetHeight || 400;
        });
        if (totalHeight > 0) {
          timelineLine.style.height = `${totalHeight}px`;
          timelineLine.style.display = 'block';
        }
      }
    }
  };
  
  // Align SVG circles with titles and align content/image on mobile
  timelineSteps.forEach((step, stepIndex) => {
    const titleElement = step.querySelector('.about-timeline__step-title');
    const dotElement = step.querySelector('.about-timeline__step-dot');
    const contentElement = step.querySelector('.about-timeline__step-content');
    const imageElement = step.querySelector('.about-timeline__step-image');
    
    if (titleElement && dotElement) {
      // Align SVG circle with center of title
      const updateDotPosition = () => {
        const isMobile = window.innerWidth < 750;
        if (!isMobile) {
          const stepRect = step.getBoundingClientRect();
          const titleRect = titleElement.getBoundingClientRect();
          // Center of title minus half of dot height (15.5px)
          const dotTop = (titleRect.top + titleRect.height / 2) - stepRect.top - 15.5;
          dotElement.style.top = `${Math.max(0, dotTop)}px`;
        } else {
          // Mobile: align dot with title center
          const stepRect = step.getBoundingClientRect();
          const titleRect = titleElement.getBoundingClientRect();
          const titleCenterY = (titleRect.top + titleRect.height / 2) - stepRect.top;
          dotElement.style.top = `${Math.max(0, titleCenterY - 4)}px`; // 4px = half of 8px dot
        }
      };
      
      // Mobile: align content and image to same vertical center
      const updateMobileAlignment = () => {
        const isMobile = window.innerWidth < 750;
        if (!isMobile || !contentElement || !imageElement) {
          // Reset transforms on desktop
          if (contentElement) contentElement.style.transform = '';
          if (imageElement) imageElement.style.transform = '';
          return;
        }
        
        // Measure positions
        const stepRect = step.getBoundingClientRect();
        const contentRect = contentElement.getBoundingClientRect();
        const imageRect = imageElement.getBoundingClientRect();
        
        // Calculate centers relative to step
        const contentCenterY = (contentRect.top + contentRect.height / 2) - stepRect.top;
        const imageCenterY = (imageRect.top + imageRect.height / 2) - stepRect.top;
        
        // Calculate difference
        const centerDiff = Math.abs(contentCenterY - imageCenterY);
        
        // If not aligned, apply transform
        if (centerDiff > 2) { // 2px tolerance
          const avgCenterY = (contentCenterY + imageCenterY) / 2;
          const contentTransform = avgCenterY - contentCenterY;
          const imageTransform = avgCenterY - imageCenterY;
          
          // Apply transform - inline style has higher specificity than CSS
          contentElement.style.transform = `translateY(${contentTransform}px)`;
          imageElement.style.transform = `translateY(${imageTransform}px)`;
          
          // Force reflow to ensure transform is applied
          void contentElement.offsetHeight;
          void imageElement.offsetHeight;
        } else {
          // Reset if already aligned
          contentElement.style.transform = '';
          imageElement.style.transform = '';
        }
      };
      
      // Debounce function to prevent excessive updates
      let updateTimeout;
      let isUpdating = false;
      
      const updateAll = () => {
        if (isUpdating) return; // Prevent concurrent updates
        isUpdating = true;
        
        updateDotPosition();
        
        // Only update mobile alignment if on mobile
        if (window.innerWidth < 750) {
          // Use requestAnimationFrame to ensure layout is complete
          requestAnimationFrame(() => {
            updateMobileAlignment();
            isUpdating = false;
          });
        } else {
          isUpdating = false;
        }
      };
      
      // Debounced update function
      const debouncedUpdate = () => {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(updateAll, 150);
      };
      
      // Initial update - wait for DOM and images to be ready
      const initUpdate = () => {
        // Wait for all images to load
        if (imageElement) {
          const img = imageElement.querySelector('img');
          if (img && !img.complete) {
            img.addEventListener('load', () => {
              setTimeout(updateAll, 200);
            }, { once: true });
            img.addEventListener('error', () => {
              setTimeout(updateAll, 200);
            }, { once: true });
            return;
          }
        }
        // If images already loaded or no images, update after a delay
        setTimeout(updateAll, 200);
      };
      
      // Start initialization
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initUpdate, { once: true });
      } else {
        initUpdate();
      }
      
      // Update on resize with debouncing
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          debouncedUpdate();
          updateLineHeight();
        }, 250);
      }, { passive: true });
    }
  });
  
  // Debounced line height update
  let lineHeightTimeout;
  const debouncedUpdateLineHeight = () => {
    clearTimeout(lineHeightTimeout);
    lineHeightTimeout = setTimeout(updateLineHeight, 200);
  };
  
  // Initial line height update - single attempt after images load
  const initLineHeight = () => {
    const images = timelineContainer.querySelectorAll('img');
    if (images.length > 0) {
      let loadedImages = 0;
      const checkAllLoaded = () => {
        loadedImages++;
        if (loadedImages === images.length) {
          debouncedUpdateLineHeight();
        }
      };
      
      images.forEach(img => {
        if (img.complete) {
          checkAllLoaded();
        } else {
          img.addEventListener('load', checkAllLoaded, { once: true });
          img.addEventListener('error', checkAllLoaded, { once: true });
        }
      });
    } else {
      // No images, update after a delay
      debouncedUpdateLineHeight();
    }
  };
  
  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLineHeight, { once: true });
  } else {
    initLineHeight();
  }
});
</script>

{% schema %}
{
  "name": "About6 - Timeline",
  "tag": "section",
  "class": "about6-timeline-section",
  "settings": [],
  "blocks": [
    {
      "type": "about_timeline_step",
      "name": "Timeline Step",
      "settings": [
        {
          "type": "header",
          "content": "Content"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Timeline Step Title"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Timeline step description text"
        },
        {
          "type": "header",
          "content": "Image"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Recommended size: 630x400px"
        },
        {
          "type": "header",
          "content": "Layout"
        },
        {
          "type": "select",
          "id": "position",
          "label": "Position",
          "options": [
            {
              "value": "right",
              "label": "Image Left / Text Right"
            },
            {
              "value": "left",
              "label": "Text Left / Image Right"
            }
          ],
          "default": "right",
          "info": "Choose layout: Image on left side of timeline line or right side"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "About6 - Timeline",
      "blocks": [
        {
          "type": "about_timeline_step",
          "settings": {
            "title": "Nhà máy sản xuất hiện đại",
            "description": "Sản phẩm của Ru9 được nghiên cứu tỉ mỉ và sản xuất với công nghệ tiên tiến",
            "position": "right"
          }
        },
        {
          "type": "about_timeline_step",
          "settings": {
            "title": "Miễn phí lưu kho",
            "description": "Không gian lưu trữ đạt chuẩn, đảm bảo mỗi sản phẩm luôn được bảo quản tốt nhất trước khi giao đến khách hàng",
            "position": "left"
          }
        },
        {
          "type": "about_timeline_step",
          "settings": {
            "title": "Showroom ở Hà Nội và TP. Hồ Chí Minh",
            "description": "Điểm chạm trực tiếp để khách hàng trải nghiệm sản phẩm và được tư vấn một cách tận tâm, minh bạch",
            "position": "right"
          }
        },
        {
          "type": "about_timeline_step",
          "settings": {
            "title": "Giao hàng tận nơi",
            "description": "Sản phẩm đến tay khách hàng, mang theo lời hứa về một giấc ngủ ngon trọn vẹn",
            "position": "left"
          }
        }
      ]
    }
  ]
}
{% endschema %}

