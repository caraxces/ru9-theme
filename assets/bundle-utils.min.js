function formatMoney(e){const t=e/100;return new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0}).format(t)}function initStep1Sticky(e){if(!e)return;if(window.innerWidth<991)return;const t=e.querySelector(".grid"),o=e.querySelector(".product-grid__images"),n=e.querySelector(".product-grid__info");if(!t||!o||!n)return;const i=()=>{window.innerWidth<991||requestAnimationFrame(()=>{const e=o.offsetWidth,i=n.offsetWidth;if(e>0&&i>0){const l=t.offsetWidth,a=Math.floor(l/2);o.style.position="sticky",o.style.top="120px",o.style.alignSelf="start",o.style.flexShrink="0",n.style.flexShrink="0",console.log("‚úÖ Step 1 - Locked widths to 50%:",{containerWidth:l,targetWidth:a,imageWidth:e,infoWidth:i})}else console.warn("‚ö†Ô∏è Step 1 - Invalid column widths, skipping width lock:",{imageWidth:e,infoWidth:i})})};let l;i(),window.addEventListener("resize",()=>{clearTimeout(l),l=setTimeout(()=>{i()},250)});e.querySelectorAll("details.product-accordion").forEach(e=>{e.addEventListener("toggle",()=>{setTimeout(i,10)})})}function initializeStep2StickyColumns(e){if(!e)return void console.log("Container not provided to initializeStep2StickyColumns");const t=e.querySelector(".bundle-step-2");if(!t)return;const o=t.querySelector(".grid"),n=t.querySelector(".product-single__sticky"),i=t.querySelector(".product-single__meta").parentElement,l=n?n.querySelector(".product-column-content"):null,a=i?i.querySelector(".product-single__meta"):null;if(!(o&&n&&i&&l&&a))return void console.log("Step 2 sticky elements not found");console.log("Initializing step 2 sticky columns");const c=((e,t)=>{let o;return function(...n){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...n)},t)}})(()=>{let e=null;l.style.cssText="",a.style.cssText="",n.style.height="",i.style.height="",n.style.position="",i.style.position="",window.innerWidth<991||requestAnimationFrame(()=>{const t=l.offsetHeight,i=a.offsetHeight,c=(l.offsetWidth,a.offsetWidth,Math.max(t,i));o.style.height=c+"px",n.style.position="sticky",n.style.top="120px",n.style.alignSelf="start",e=()=>{const e=window.pageYOffset||document.documentElement.scrollTop,n=o.getBoundingClientRect().top+e,i=n+o.offsetHeight;window.innerHeight;e+120>=n&&e+120<i-t?(l.style.position="sticky",l.style.top="120px"):e+120>=i-t?(l.style.position="absolute",l.style.top=i-t-n+"px"):(l.style.position="static",l.style.top="auto")},window.addEventListener("scroll",e),e()})},250);c(),window.addEventListener("resize",c)}window.BundleUtils=window.BundleUtils||{},window.BundleUtils.formatMoney=formatMoney,document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".bundle-step-1");e&&setTimeout(()=>{initStep1Sticky(e)},100)}),document.addEventListener("shopify:section:load",function(e){const t=document.querySelector(".bundle-step-1");t&&initStep1Sticky(t)}),window.BundleUtils.initStep1Sticky=initStep1Sticky,window.BundleUtils.initializeStep2StickyColumns=initializeStep2StickyColumns,window.BundleUtils.updateBundleProductImage=function(e,t){if(window.bundleInstance&&window.bundleInstance.updateBundleProductImage)return window.bundleInstance.updateBundleProductImage(e,t);console.warn("Bundle instance not available for image update")},window.BundleUtils.initializeBundle=function(e,t,o,n,i){const l=document.getElementById(`MainProductBundle-${e}`);if(!l)return;const a={};async function c(e){if(a[e])return console.log("üì¶ Using cached data for:",e),a[e];console.log("üåê Fetching from Shopify:",e);const t=await fetch(`/products/${e}.js`),o=await t.json(),n={id:o.id,title:o.title,handle:o.handle,media:o.media||o.images.map(e=>({id:e.id,media_type:"image",src:e.src,alt:e.alt,preview_image:{src:e.src,aspect_ratio:e.width/e.height}})),variants:o.variants};return a[e]=n,n}function r(e,t,o){if(console.log("üñºÔ∏è renderProductImagesHTML called:",{step:o,hasProductData:!!e,hasMedia:!(!e||!e.media),mediaLength:e?.media?.length,productTitle:e?.title}),!e||!e.media||0===e.media.length)return console.warn("‚ùå No images to render:",e),'<div class="product__photos"><p>Kh√¥ng c√≥ h√¨nh ·∫£nh</p></div>';const n=window.bundleConfig?.productCarouselEnable||!1,i=window.bundleConfig?.thumbnailArrows||!1;console.log("üñºÔ∏è Rendering",e.media.length,"images for",e.title);let l="";e.media.forEach((t,o)=>{const n=t.preview_image?.src||t.src||"",i=t.preview_image?.aspect_ratio||1;console.log(`  Image ${o}:`,{mediaUrl:n,aspectRatio:i,rawMedia:t,previewImage:t.preview_image,src:t.src}),l+=`\n          <div class="product-main-slide ${0===o?"starting-slide":"secondary-slide"}" data-index="${o}" ${0===o?'style="display: block;"':'style="display: none;"'}>\n            <div data-product-image-main class="product-image-main">\n              <div class="image-wrap loaded" style="position: relative; width: 100%; height: auto;">\n                <img src="${n}" \n                     alt="${e.title}" \n                     class="product-featured-img lazyautosizes image-element lazyloaded" \n                     style="width: 100%; height: auto; object-fit: contain; display: block;"\n                     loading="${0===o?"eager":"lazy"}"\n                     data-index="${o}">\n              </div>\n            </div>\n          </div>\n        `});let a="";return e.media.length>1&&e.media.forEach((t,o)=>{const n=t.preview_image?.src||t.src||"",i=t.preview_image?.aspect_ratio||1;a+=`\n            <div class="product__thumb-item" data-index="${o}">\n              <a href="${n}" data-product-thumb class="product__thumb" data-index="${o}" data-id="${t.id||o}">\n                <div class="image-wrap image-wrap__thumbnail" style="height: 0; padding-bottom: ${100/i}%;">\n                  <img src="${n}" alt="${e.title}" loading="lazy">\n                </div>\n              </a>\n            </div>\n          `}),`\n        <div class="product-column-content" data-product-images>\n          <div class="product__photos${n?"":" product__photos--stack"} product__photos-${t} product__photos--below">\n            <div class="product__main-photos" data-product-single-media-group>\n              <div data-product-photos class="product-slideshow" id="ProductPhotos-${o}-${t}">\n                ${l}\n              </div>\n            </div>\n            \n            ${e.media.length>1?`\n              <div data-product-thumbs class="product__thumbs product__thumbs--below">\n                ${i?'\n                  <button type="button" class="product__thumb-arrow product__thumb-arrow--prev hide">\n                    <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-chevron-left" viewBox="0 0 284.49 498.98">\n                      <path d="M249.49 0a35 35 0 0 1 24.75 59.75L84.49 249.49l189.75 189.74a35.002 35.002 0 1 1-49.5 49.5L10.25 274.24a35 35 0 0 1 0-49.5L224.74 10.25A34.89 34.89 0 0 1 249.49 0Z"/>\n                    </svg>\n                  </button>\n                ':""}\n                \n                <div class="${n?"huan-false":""} product__thumbs--scroller">\n                  ${a}\n                </div>\n                \n                ${i?'\n                  <button type="button" class="product__thumb-arrow product__thumb-arrow--next">\n                    <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-chevron-right" viewBox="0 0 284.49 498.98">\n                      <path d="M35 498.98a35 35 0 0 1-24.75-59.75l189.74-189.74L10.25 59.75a35.002 35.002 0 0 1 49.5-49.5l214.49 214.49a35 35 0 0 1 0 49.5L59.75 488.73A34.89 34.89 0 0 1 35 498.98Z"/>\n                    </svg>\n                  </button>\n                ':""}\n              </div>\n            `:""}\n          </div>\n          <button class="custom-nav-button custom-nav-prev" aria-label="Previous image">\n            <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>\n          </button>\n          <button class="custom-nav-button custom-nav-next" aria-label="Next image">\n            <svg width="17" height="9" viewBox="0 0 17 9" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 1.5L8.5 7.5L15 1.5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>\n          </button>\n        </div>\n      `}function s(e,t){setTimeout(()=>{if(window.innerWidth>768)return void console.log("üíª Desktop mode: Skipping Flickity for",t);console.log("üì± Mobile mode: Initializing Flickity for",t);let o=e.querySelector(".product-slideshow, [data-product-photos], .product-main-slideshow");if(o||(o=e.querySelector(".product-images, .product-main-images, .product-main-slideshow")),!o)return void console.warn("‚ö†Ô∏è No slideshow element found for step:",t);if(!window.Flickity&&!window.theme?.Slideshow)return void console.warn("‚ö†Ô∏è Flickity library not loaded");console.log("üé† Initializing Flickity for",t,"- element:",o);const n=window.theme?.Slideshow||Flickity;try{const i=new n(o,{cellAlign:"left",contain:!0,prevNextButtons:!1,pageDots:!0,wrapAround:!0,adaptiveHeight:!0,draggable:!0,freeScroll:!1,dragThreshold:10});console.log("‚úÖ Flickity initialized for",t);const l=e.querySelector(".custom-nav-prev"),a=e.querySelector(".custom-nav-next");if(l&&a){const e=Flickity.data?Flickity.data(o):i;e&&(l.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.previous?e.previous():e.flickity?.previous&&e.flickity.previous()}),a.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.next?e.next():e.flickity?.next&&e.flickity.next()}),console.log("‚úÖ Nav buttons connected to Flickity"))}}catch(e){console.error("‚ùå Error initializing Flickity:",e)}},300)}const d=document.getElementById(`BundleConfig-${e}`);if(!d)return;let u;try{u=JSON.parse(d.textContent)}catch(e){return}0===u.bundleProducts.length&&u.debug&&u.debug.sectionSettingsRaw&&Array.isArray(u.debug.sectionSettingsRaw)&&(u.bundleProducts=u.debug.sectionSettingsRaw.map(e=>({handle:e,title:e,id:0,featured_image:"",price:0,description:"",variants:[]})));l.querySelector(".bundle-dynamic-content"),l.querySelector(".bundle-loading-overlay");let p={currentStep:1,currentProductIndex:0,bundleQuantity:1,selectedProducts:{main:{variantId:t,quantity:1},bundle:[]}};console.log("=== INITIALIZE VARIANT PICKER FOR MAIN PRODUCT ==="),l.addEventListener("change",function(t){if(t.target.closest(".bundle-step-1")&&t.target.hasAttribute("data-variant-input")){console.log("üîç Main product variant changed");const e=t.target.closest(".bundle-step-1").querySelector("[data-variant-input]:checked");if(e){const t=e.value;console.log("üîç Selected variant ID:",t);const o=n.find(e=>e.id.toString()===t);o&&(console.log("üîç Found variant:",o),p.selectedProducts.main={variantId:o.id,variantTitle:o.title,variantOptions:o.options,variantPrice:o.price,image:v(o.featured_image)||v(i),quantity:p.selectedProducts.main.quantity},console.log("üîç Updated main product in bundle state:",p.selectedProducts.main))}}if(t.target.closest(".bundle-step-2")&&t.target.hasAttribute("data-variant-input")){console.log("üîç Step 2 bundle product variant changed");const o=t.target.closest(".bundle-step-2").querySelector("[data-variant-input]:checked");if(o){const n=o.value;console.log("üîç Step 2 - Selected variant ID:",n);const i=t.target.closest(".bundle-product-item");if(i){const t=i.getAttribute("data-product-id");console.log("üîç Step 2 - Product ID:",t);const o=p.selectedProducts.bundle.find(e=>e.id.toString()===t);if(o&&o.variants){const t=o.variants.find(e=>e.id.toString()===n);t&&(console.log("üîç Step 2 - Found variant:",t),o.variantId=t.id,o.variantTitle=t.title,o.variantOptions=t.options,o.variantPrice=t.price,o.image=v(t.featured_image)||o.image,console.log("üîç Step 2 - Updated product in bundle state:",o),function(t){console.log("=== UPDATE PRODUCT IMAGE FOR STEP 2 ==="),console.log("Product data:",t);const o=document.getElementById(`Step2ImageColumn-${e}`);if(!o)return void console.warn("‚ùå Step 2 image column not found");const n=u.bundleProducts[p.currentProductIndex];if(!n)return void console.warn("‚ùå Current product not found");const i=document.querySelector(`#ProductSelect-bundle-${n.id}`);if(!i||!i.value)return void console.warn("‚ùå Product select not found or no value");const l=i.value,a=n.variants.find(e=>e.id.toString()===l.toString());a?(console.log("Selected variant for image update:",a),C(a,o),window.bundleConfig?.productCarouselEnable&&setTimeout(()=>{s(o,"step2")},100)):console.warn("‚ùå Selected variant not found")}(o))}}}}}),console.log("=== INITIALIZING STEP 0 (Main Product Page) ===");let g=document.querySelector(".bundle-step-0");if(g||(g=document.querySelector(".product-main-images")),g||(g=document.querySelector(".product-images")),g||(g=document.querySelector(".product-main-slideshow")),g||(g=document.querySelector("[data-section-id] .product-main-slideshow")),console.log("üîç Step 0 container found:",!!g),console.log("üîç Step 0 container:",g),console.log("üîç Step 0 container class:",g?g.className:"N/A"),g){const e=g.querySelector(".product-main-slide");e&&(e.style.display="block",console.log("‚úÖ Step 0: First slide made visible"));const t=g.querySelector("[data-product-thumb]");t&&(t.classList.add("active"),console.log("‚úÖ Step 0: First thumbnail made active"));const o=g.querySelectorAll("[data-product-thumb]");console.log("Found thumbnails in step 0:",o.length);const n=g.querySelector(".product-slideshow, [data-product-photos], .product-main-slideshow");if(console.log("üîç Step 0 slideshow found:",!!n),console.log("üîç Step 0 slideshow element:",n),n&&window.Flickity){const e=Flickity.data(n);console.log("üîç Step 0 existing Flickity:",!!e)}setTimeout(()=>{console.log("üîç Step 0: Initializing thumbnail clicks..."),initializeThumbnailClicks(g)},400),setTimeout(()=>{console.log("üé† Step 0: Force initializing Flickity..."),s(g,"step0")},800)}else console.warn("‚ö†Ô∏è Step 0: Container not found");function m(t){p.currentStep=t,l.querySelectorAll(".bundle-step").forEach(e=>{e.style.display="none"});const o=l.querySelector(`[data-step="${t}"]`);if(o&&(o.style.display="block"),3===t&&setTimeout(()=>{const e=document.querySelector(".bundle-step-3");if(e){console.log("üéØ Step 3: Initializing Flickity carousel for mobile swipe");const t=e.querySelector(".product-slideshow, [data-product-photos]");if(t){window.Flickity&&Flickity.data(t)?console.log("‚úÖ Step 3: Flickity already initialized"):(window.theme?.Slideshow||window.Flickity)&&(console.log("üé† Step 3: Manually initializing Flickity..."),s(e,"step3"))}setTimeout(()=>{initializeThumbnailClicks(e)},400)}},100),0===t){console.log("=== INITIALIZING STEP 0 (Main Product Page) ===");const e=o.querySelector(".product-main-slide");e&&(e.style.display="block",console.log("‚úÖ Step 0: First slide made visible"));const t=o.querySelector("[data-product-thumb]");t&&(t.classList.add("active"),console.log("‚úÖ Step 0: First thumbnail made active"));const n=o.querySelectorAll("[data-product-thumb]");console.log("Found thumbnails in step 0:",n.length);const i=o.querySelector(".product__thumbs--scroller");console.log("Found product__thumbs--scroller:",!!i),i&&(console.log("Scroller innerHTML length:",i.innerHTML.length),console.log("Scroller children count:",i.children.length)),setTimeout(()=>{console.log("üîç Step 0: Initializing thumbnail clicks..."),initializeThumbnailClicks(o)},400),setTimeout(()=>{console.log("üé† Step 0: Force initializing Flickity..."),s(o,"step0")},800)}if(2===t){if(console.log("=== INITIALIZING STEP 2 ==="),0===p.selectedProducts.bundle.length&&u.bundleProducts&&u.bundleProducts.length>0){console.log("Auto-selecting first bundle product...");const e=u.bundleProducts[0],t=e.variants&&e.variants.length>0?e.variants[0]:null,o=v(e.featured_image)||(e.media&&e.media.length>0?v(e.media[0]):"");console.log("üîç Auto-select debug:",{firstProduct:e,defaultVariant:t,firstProductPrice:e.price,defaultVariantPrice:t?t.price:"no variant"});const n=2===p.currentProductIndex?u.product3Quantity||2:1,i={productId:e.id,productHandle:e.handle,productTitle:e.title,image:o,variantId:t?t.id:null,variantTitle:t?t.title:"Default Title",variantPrice:t?t.price:e.price,compareAtPrice:t?t.compare_at_price:e.compare_at_price,variantOptions:t?t.options:[],quantity:n};p.selectedProducts.bundle.push(i),console.log("‚úÖ Auto-selected first product:",i)}console.log("=== INITIALIZING STEP 0 (Main Product Page) ===");let t=document.querySelector(".bundle-step-0");if(t||(t=document.querySelector(".product-main-images")),t||(t=document.querySelector(".product-images")),t||(t=document.querySelector(".product-main-slideshow")),t||(t=document.querySelector("[data-section-id] .product-main-slideshow")),console.log("üîç Step 0 container found:",!!t),console.log("üîç Step 0 container:",t),console.log("üîç Step 0 container class:",t?t.className:"N/A"),t){const e=t.querySelector(".product-main-slide");e&&(e.style.display="block",console.log("‚úÖ Step 0: First slide made visible"));const o=t.querySelector("[data-product-thumb]");o&&(o.classList.add("active"),console.log("‚úÖ Step 0: First thumbnail made active"));const n=t.querySelectorAll("[data-product-thumb]");console.log("Found thumbnails in step 0:",n.length);const i=t.querySelector(".product-slideshow, [data-product-photos], .product-main-slideshow");if(console.log("üîç Step 0 slideshow found:",!!i),console.log("üîç Step 0 slideshow element:",i),i&&window.Flickity){const e=Flickity.data(i);console.log("üîç Step 0 existing Flickity:",!!e)}setTimeout(()=>{console.log("üîç Step 0: Initializing thumbnail clicks..."),initializeThumbnailClicks(t)},400),setTimeout(()=>{console.log("üé† Step 0: Force initializing Flickity..."),s(t,"step0")},800)}else console.warn("‚ö†Ô∏è Step 0: Container not found");console.log("Loading first bundle product..."),h(0),setTimeout(()=>{console.log("=== INITIALIZING STEP 1 ===");const t=document.querySelector(".bundle-step-1");if(t){const o=t.querySelector(".product-main-slide");o&&(o.style.display="block",console.log("‚úÖ Step 1: First slide made visible"));const n=t.querySelector("[data-product-thumb]");n&&(n.classList.add("active"),console.log("‚úÖ Step 1: First thumbnail made active"));const i=t.querySelectorAll("[data-product-thumb]");console.log("Found thumbnails in step 1:",i.length);const l=t.querySelector(".product__thumbs--scroller");console.log("Found product__thumbs--scroller:",!!l),l&&(console.log("Scroller innerHTML length:",l.innerHTML.length),console.log("Scroller children count:",l.children.length)),setTimeout(()=>{console.log("üîç Step 1: Initializing thumbnail clicks..."),initializeThumbnailClicks(t)},400);const a=t.querySelector(`#ProductPhotos-${e}`);if(a&&window.Flickity){if(Flickity.data(a))console.log("‚úÖ Step 1: Flickity already initialized");else{new Flickity(a,{cellAlign:"left",contain:!0,prevNextButtons:!1,pageDots:window.innerWidth<=768,wrapAround:!0,draggable:!0,adaptiveHeight:!0,dragThreshold:10,selectedAttraction:.025,friction:.28});console.log("‚úÖ Step 1: Flickity initialized for swipe")}}else if(a&&window.theme?.Slideshow){new theme.Slideshow(a,{cellAlign:"left",contain:!0,prevNextButtons:!1,pageDots:window.innerWidth<=768,wrapAround:!0,draggable:!0,adaptiveHeight:!0,dragThreshold:10,selectedAttraction:.025,friction:.28});console.log("‚úÖ Step 1: Theme Slideshow initialized for swipe")}else console.warn("‚ö†Ô∏è Step 1: Neither Flickity nor theme.Slideshow available");setTimeout(()=>{if(console.log("üé† Step 1: Force initializing Flickity..."),s(t,"step1"),window.innerWidth<=768){console.log("üì± Step 1: Mobile-specific Flickity setup...");const o=t.querySelector(`#ProductPhotos-${e}`);if(o&&window.Flickity){const e=Flickity.data(o);e&&(e.resize(),e.reposition(),console.log("üì± Step 1: Mobile Flickity refreshed"))}}},800)}else console.warn("‚ö†Ô∏è Step 1: Container not found")},1500),setTimeout(()=>{window.BundleUtils&&window.BundleUtils.initializeStep2StickyColumns&&window.BundleUtils.initializeStep2StickyColumns(l)},100)}if(3===t){console.log("=== INITIALIZING STEP 3 ==="),function(){console.log("=== INITIALIZING QUANTITY SELECTOR ===");const e=l.querySelector(".quantity-display"),t=l.querySelector(".quantity-text"),o=l.querySelectorAll(".quantity-option");if(e&&t){const n=p.bundleQuantity||1;t.textContent=n,e.setAttribute("data-quantity",n),o.forEach(e=>{e.classList.remove("selected"),parseInt(e.getAttribute("data-value"))===n&&e.classList.add("selected")}),console.log("‚úÖ Quantity selector initialized with value:",n)}else console.log("‚ùå Quantity selector elements not found")}();const e=o.querySelector(".product-main-slide");e&&(e.style.display="block",console.log("‚úÖ First slide made visible"));const t=o.querySelector("[data-product-thumb]");t&&(t.classList.add("active"),console.log("‚úÖ First thumbnail made active"));const n=o.querySelectorAll("[data-product-thumb]");console.log("Found thumbnails in step 3:",n.length);const i=o.querySelector(".product__thumbs--scroller");console.log("Found product__thumbs--scroller:",!!i),i&&(console.log("Scroller innerHTML length:",i.innerHTML.length),console.log("Scroller children count:",i.children.length))}}async function h(t){console.log("=== LOAD BUNDLE PRODUCT DEBUG ==="),console.log("Index:",t),console.log("Config bundleProducts:",u.bundleProducts),console.log("Config bundleProducts length:",u.bundleProducts.length),console.log("Config bundleProducts type:",typeof u.bundleProducts);const o=u.bundleProducts[t];if(console.log("Product at index",t,":",o),!o)return void console.error("No product found at index:",t);p.currentProductIndex=t;const n=l.querySelector(".bundle-progress-current"),i=l.querySelector(".bundle-progress-total");n&&(n.textContent=t+1),i&&(i.textContent=u.bundleProducts.length);const a=document.getElementById(`Step2ImageColumn-${e}`);console.log("Step 2 Image Column found:",!!a),console.log("Product handle:",o.handle),a&&o&&o.handle?c(o.handle).then(t=>{console.log("üéØ Product Data:",t),console.log("üéØ Media:",t.media);const o=r(t,e,"step2");a.innerHTML=o,console.log("‚úÖ Step 2 images rendered"),setTimeout(()=>{const e=document.querySelector(".bundle-step-2");e&&(console.log("üéØ Step 2: Initializing Flickity carousel for mobile swipe"),s(e,"step2"),setTimeout(()=>{initializeThumbnailClicks(e)},400))},100),setTimeout(()=>{const e=a.querySelectorAll(".product-main-slide"),t=a.querySelectorAll("img");console.log("üîç Step 2 Debug - Slides found:",e.length),console.log("üîç Step 2 Debug - Images found:",t.length),e.forEach((e,t)=>{const o=window.getComputedStyle(e);console.log(`üîç Slide ${t}:`,{display:o.display,visibility:o.visibility,opacity:o.opacity,classes:e.className})}),t.forEach((e,t)=>{const o=window.getComputedStyle(e);console.log(`üîç Image ${t}:`,{display:o.display,visibility:o.visibility,opacity:o.opacity,src:e.src,loaded:e.complete})})},100)}).catch(e=>{console.error("‚ùå Error fetching product data:",e),a.innerHTML="<p>Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh s·∫£n ph·∫©m</p>"}):console.error("‚ùå Cannot render Step 2 images:",{hasColumn:!!a,hasProduct:!!o,hasHandle:!(!o||!o.handle)});const d=l.querySelector(".bundle-products-grid");if(console.log("Products grid element:",d),d)try{console.log("Loading bundle product:",o.handle),console.log("Product data:",{title:o.title,price:o.price,description:o.description,variants:o.variants,featured_image:o.featured_image}),o.variants&&o.variants.length>0&&(console.log("Product variants count:",o.variants.length),console.log("First variant:",o.variants[0]),console.log("First variant options:",o.variants[0].options),console.log("Product options:",o.options));const e=`\n            <div class="bundle-product-item" data-product-handle="${o.handle}" data-section-id="${u.sectionId}" data-product-id="${o.id}">\n                        \x3c!-- Product Header --\x3e\n                        <div class="product-block product-block--header">\n                          <h1 class="h2 product-single__title">${o.title}</h1>\n                        </div>\n  \n                        \x3c!-- Price Block --\x3e\n                        <div class="product-block product-block--price">\n                          <div class="price-container-wrapper">\n                            <span class="product__price text-2xl f-smb" data-product-price data-product-price-base="${o.price}">\n                              ${BundleUtils.formatMoney(o.price)}\n                            </span>\n                            ${o.compare_at_price&&o.compare_at_price>o.price?`\n                              <span class="product__price product__price--compare text-xl" data-compare-price>\n                                ${BundleUtils.formatMoney(o.compare_at_price)}\n                              </span>\n                              <div class="product__discount-badge">\n                                -${Math.round((o.compare_at_price-o.price)/o.compare_at_price*100)}%\n                              </div>\n                            `:""}\n                          </div>\n                          \n\n                        </div>\n  \n  \n                        \x3c!-- Hidden ProductSelect for variant tracking --\x3e\n                        <select name="id" id="ProductSelect-bundle-${o.id}" class="product-single__variants" style="display: none;">\n                          ${o.variants.map(e=>`\n                            <option value="${e.id}" ${e.available?"":"disabled"} data-variant-price="${e.price}" data-variant-compare-price="${e.compare_at_price||""}">\n                              ${e.title}\n                            </option>\n                          `).join("")}\n                        </select>\n                        \n                        \x3c!-- Hidden Sticky ProductSelect for variant tracking --\x3e\n                        <select name="id" id="ProductSelect-bundle-${o.id}-sticky" class="product-single__variants" style="display: none;">\n                          ${o.variants.map(e=>`\n                            <option value="${e.id}" ${e.available?"":"disabled"} data-variant-price="${e.price}" data-variant-compare-price="${e.compare_at_price||""}">\n                              ${e.title}\n                            </option>\n                          `).join("")}\n                        </select>\n  \n                        \x3c!-- Variant Picker - Using existing structure --\x3e\n                        ${o.variants&&o.variants.length>1?`\n                          <div class="product-block" data-dynamic-variants-enabled>\n                            ${(()=>{const e=[];return o.options&&o.options.length>0&&o.options.forEach((t,o)=>{e.push({name:t.name,values:t.values,index:o})}),e.map(e=>{const t=e.name.toLowerCase().includes("color")||e.name.toLowerCase().includes("m√†u")||e.name.toLowerCase().includes("colour"),n=e.name.toLowerCase().includes("size")||e.name.toLowerCase().includes("k√≠ch th∆∞·ªõc")||e.name.toLowerCase().includes("k√≠ch th∆∞·ªõc")||e.name.toLowerCase().includes("k√≠ch th∆∞·ªõc");let i='<label class="variant__label" for="ProductSelect-bundle-'+o.id+"-option-"+e.index+'">'+e.name+":";if(i+='<span class="variant__label-info" data-index="'+e.index+'"><span data-variant-selected-label>'+e.values[0]+"</span></span>",i+="</label>",n&&p.currentProductIndex>0&&p.lockedSize){const e=u.bundleProducts[0],t=e?e.title:"S·∫£n ph·∫©m ƒë·∫ßu ti√™n";i+='<div class="size-lock-note" style="font-size: 12px; color: #6B7280; margin-top: 4px; font-style: italic;">B·∫°n ƒë√£ ch·ªçn size <strong>'+p.lockedSize+"</strong> ·ªü "+t+"</div>"}let l='<fieldset class="variant-input-wrap flex ai-center gap-x-md flex-wrap" name="'+e.name+'" data-index="option'+(e.index+1)+'" data-handle="'+e.name.toLowerCase().replace(/\s+/g,"-")+'" data-option-count="'+e.values.length+'" id="ProductSelect-bundle-'+o.id+"-option-"+e.index+'"><legend class="hide">'+e.name+"</legend>";return l+=e.values.map((i,l)=>{const a=o.variants.find(t=>t.options[e.index]===i),c=a&&!1!==a.available,r=c?"":" disabled",s=0===l?'checked="checked"':"";if(t){const t=i.toLowerCase().replace(/\s+/g,"-"),n=`https://ru9.vn/cdn/shop/files/${t+"_50x50.png"}`,l=i.split(" ").pop().toLowerCase();return'<div class="variant-input" data-index="option'+(e.index+1)+'" data-value="'+i+'"><input type="radio" '+s+' value="'+i+'" data-index="option'+(e.index+1)+'" name="'+e.name+"-"+o.id+'" data-variant-input class="variant__input--color-swatch'+(c?"":" disabled")+'" data-color-name="'+i+'" data-color-index="'+e.index+'" id="ProductSelect-bundle-'+o.id+"-option-"+e.name.toLowerCase().replace(/\s+/g,"-")+"-"+i.replace(/\s+/g,"-")+'"><label for="ProductSelect-bundle-'+o.id+"-option-"+e.name.toLowerCase().replace(/\s+/g,"-")+"-"+i.replace(/\s+/g,"-")+'" class="variant__button-label color-swatch color-swatch--'+t+r+'" style="background-color: '+l+"; background-image: url("+n+') !important;" title="'+i+'"></label></div>'}if(n){let t=i,n="";if(i.includes("+")||i.includes("x")||i.includes("cm")){const e=i.split(/[\+\-‚Äì]/);if(e.length>=2)t=e[0].trim(),n=e.slice(1).join(" ").trim();else if(i.includes("x")&&i.includes("cm")){const e=i.match(/(\d+\s*x\s*\d+cm)/);e&&(n=e[1],t=i.replace(e[1],"").trim())}}return'<div class="variant-input" data-index="option'+(e.index+1)+'" data-value="'+i+'"><input type="radio" '+s+' value="'+i+'" data-index="option'+(e.index+1)+'" name="'+e.name+'" data-variant-input class="variant__input--pill'+(c?"":" disabled")+'" data-value-name="'+i+'" data-value-index="'+e.index+'" id="ProductSelect-bundle-'+o.id+"-option-"+e.name.toLowerCase().replace(/\s+/g,"-")+"-"+i.replace(/\s+/g,"-")+'"><label for="ProductSelect-bundle-'+o.id+"-option-"+e.name.toLowerCase().replace(/\s+/g,"-")+"-"+i.replace(/\s+/g,"-")+'" class="variant__button-label t-center'+r+'"><span class="label-head block text-sm f-smb">'+t+"</span>"+(n?'<span class="label-value block text-xs">'+n+"</span>":"")+"</label></div>"}return'<div class="variant-input" data-index="option'+(e.index+1)+'" data-value="'+i+'"><input type="radio" '+s+' value="'+i+'" data-index="option'+(e.index+1)+'" name="'+e.name+'" data-variant-input class="variant__input'+(c?"":" disabled")+'" id="ProductSelect-bundle-'+o.id+"-option-"+e.name.toLowerCase().replace(/\s+/g,"-")+"-"+i.replace(/\s+/g,"-")+'"><label for="ProductSelect-bundle-'+o.id+"-option-"+e.name.toLowerCase().replace(/\s+/g,"-")+"-"+i.replace(/\s+/g,"-")+'" class="variant__button-label'+r+'">'+i+"</label></div>"}).join(""),l+="</fieldset>",'<div class="variant-wrapper js '+e.name.toLowerCase().replace(/\s+/g,"-")+(n?" size":"")+(t?" color":"")+'" data-type="button">'+i+l+"</div>"}).join("")})()}\n                          </div>\n                        `:""}\n  \n                        \x3c!-- Navigation Buttons --\x3e\n                        <div class="product-block">\n                          <div class="bundle-navigation">\n                            <button type="button" class="btn btn--secondary bundle-back-btn">Quay l·∫°i</button>\n                            <button type="button" class="btn btn--primary bundle-continue-btn">Ti·∫øp t·ª•c</button>\n                          </div>\n                        </div>\n  \n                        \x3c!-- Product Summary Block --\x3e\n                        <div class="product-block product-summary-block">\n                          <div class="product-summary-content">\n                            \x3c!-- Description Accordion --\x3e\n                            <details class="product-accordion product-accordion--styled" open>\n                              <summary>\n                                <span>M√¥ t·∫£ s·∫£n ph·∫©m</span>\n                                <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\n                              </summary>\n                              <div class="product-accordion-content rte">\n                                ${o.description}\n                              </div>\n                            </details>\n  \n                             \x3c!-- Store System Accordion --\x3e\n                             ${window.bundleConfig?.storeSystemContent?`\n                             <details class="product-accordion product-accordion--styled">\n                               <summary>\n                                 <span>H·ªá th·ªëng c·ª≠a h√†ng</span>\n                                 <svg class="icon-toggle" width="18" height="10" viewBox="0 0 18 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L9 8.5L17 1.5" stroke="#1C2C58" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\n                               </summary>\n                                 <div class="product-accordion-content rte">\n                                   ${window.bundleConfig.storeSystemContent}\n                                   </div>\n                               </details>\n                             `:""}\n                                  </div>\n                        </div>\n  \n                        \x3c!-- Service Grid --\x3e\n                        <div class="product-block product-block--service-grid">\n                          <div class="service-grid-wrapper">\n                            <div class="service-grid" style="grid-template-columns: repeat(4, 1fr);">\n                              <div class="service-grid-item">\n                                <div class="service-item">\n                                   <div class="service-item__icon">\n                                     ${window.bundleConfig?.serviceIcon1?`<img src="${window.bundleConfig.serviceIcon1}" alt="${window.bundleConfig.serviceText1||"100 ƒë√™m ng·ªß th·ª≠"}" width="40" height="40">`:`<img src="/assets/Layer_1_3.svg" alt="${window.bundleConfig?.serviceText1||"100 ƒë√™m ng·ªß th·ª≠"}" width="40" height="40">`}\n                                   </div>\n                                   <div class="service-item__text">\n                                     <p>${window.bundleConfig?.serviceText1||"100 ƒë√™m ng·ªß th·ª≠"}</p>\n                                   </div>\n                                </div>\n                              </div>\n                              <div class="service-grid-item">\n                                <div class="service-item">\n                                  <div class="service-item__icon">\n                                    ${window.bundleConfig?.serviceIcon2?`<img src="${window.bundleConfig.serviceIcon2}" alt="${window.bundleConfig.serviceText2||"Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn"}" width="40" height="40">`:`<img src="/assets/Layer_1_4.svg" alt="${window.bundleConfig?.serviceText2||"Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn"}" width="40" height="40">`}\n                                  </div>\n                                  <div class="service-item__text">\n                                    <p>${window.bundleConfig?.serviceText2||"Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn"}</p>\n                                  </div>\n                                </div>\n                              </div>\n                              <div class="service-grid-item">\n                                <div class="service-item">\n                                  <div class="service-item__icon">\n                                    ${window.bundleConfig?.serviceIcon3?`<img src="${window.bundleConfig.serviceIcon3}" alt="${window.bundleConfig.serviceText3||"B·∫£o h√†nh d√†i l√¢u"}" width="40" height="40">`:`<img src="/assets/Layer_1_5.svg" alt="${window.bundleConfig?.serviceText3||"B·∫£o h√†nh d√†i l√¢u"}" width="40" height="40">`}\n                                  </div>\n                                  <div class="service-item__text">\n                                    <p>${window.bundleConfig?.serviceText3||"B·∫£o h√†nh d√†i l√¢u"}</p>\n                                  </div>\n                                </div>\n                              </div>\n                              <div class="service-grid-item">\n                                <div class="service-item">\n                                  <div class="service-item__icon">\n                                    ${window.bundleConfig?.serviceIcon4?`<img src="${window.bundleConfig.serviceIcon4}" alt="${window.bundleConfig.serviceText4||"Thanh to√°n linh ho·∫°t"}" width="40" height="40">`:`<img src="/assets/Layer_1_6.svg" alt="${window.bundleConfig?.serviceText4||"Thanh to√°n linh ho·∫°t"}" width="40" height="40">`}\n                                  </div>\n                                  <div class="service-item__text">\n                                    <p>${window.bundleConfig?.serviceText4||"Thanh to√°n linh ho·∫°t"}</p>\n                                  </div>\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n  \n              </div>\n            </div>\n          `;console.log("Generated HTML:",e),d.innerHTML=e,console.log("HTML set successfully. Products grid innerHTML length:",d.innerHTML.length),console.log("Products grid children count:",d.children.length);const t=d.querySelector(".bundle-product-item");t&&(S(t),setTimeout(()=>{const e=t.querySelector('[data-variant-input][data-index="option1"]:checked');e&&(console.log("üîÑ Initial sync: Triggering option1 change to update option2..."),e.dispatchEvent(new Event("change",{bubbles:!0})))},200)),function(){const e=l.querySelector(".bundle-progress-current"),t=l.querySelector(".bundle-progress-total");e&&(e.textContent=p.currentProductIndex+1);t&&(t.textContent=u.bundleProducts.length)}()}catch(e){console.error("Error loading bundle product:",e),console.error("Error details:",{message:e.message,stack:e.stack,product:o}),d.innerHTML=`\n            <div class="bundle-product-item" data-product-handle="${o.handle}">\n              <div class="error-message" style="text-align: center; padding: 2rem; color: red;">\n                <h3>L·ªói t·∫£i s·∫£n ph·∫©m</h3>\n                <p>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·∫£n ph·∫©m: ${o.title}</p>\n                <p>L·ªói: ${e.message}</p>\n              </div>\n            </div>\n          `}}function v(e){return e?"string"==typeof e?e:"object"==typeof e&&(e.src||e.url||e.preview_image||e.featured_image||(e.media&&e.media.length>0?e.media[0].src:""))||"":""}function f(){const t=l.querySelector(".bundle-summary-products"),n=l.querySelector(`#BundlePhotos-${e}`);if(console.log("=== RENDER BUNDLE SUMMARY DEBUG ==="),console.log("summaryProducts found:",!!t),console.log("bundlePhotos found:",!!n),console.log("bundleState:",p),console.log("bundleState.selectedProducts:",p.selectedProducts),console.log("bundleState.selectedProducts.bundle:",p.selectedProducts.bundle),console.log("bundleState.selectedProducts.bundle.length:",p.selectedProducts.bundle.length),!t)return void console.error("‚ùå Summary products element not found!");let a=0,c=0;console.log("=== MAIN PRODUCT DEBUG ==="),console.log("bundleState.selectedProducts.main:",p.selectedProducts.main);const r={productTitle:o,variantTitle:p.selectedProducts.main.variantTitle||"Default Title",variantOptions:p.selectedProducts.main.variantOptions||[],quantity:p.selectedProducts.main.quantity||1,price:p.selectedProducts.main.variantPrice||0,image:v(p.selectedProducts.main.image)||v(i)};console.log("=== MAIN PRODUCT PRICE DEBUG ==="),console.log("bundleState.selectedProducts.main:",p.selectedProducts.main),console.log("mainProduct.price:",r.price),console.log("mainProduct.price type:",typeof r.price),console.log("Final mainProduct:",r);const s=p.selectedProducts.bundle.map(e=>({...e,price:e.variantPrice||e.price,compareAtPrice:e.compareAtPrice||e.variantPrice||e.price,image:v(e.image)}));console.log("=== PRICE MAPPING DEBUG ==="),p.selectedProducts.bundle.forEach((e,t)=>{const o=s[t];console.log(`Product ${t} price mapping:`,{title:e.productTitle,variantPrice:e.variantPrice,compareAtPrice:e.compareAtPrice,mappedPrice:o.price,mappedCompareAtPrice:o.compareAtPrice,variantTitle:e.variantTitle})});const d=[...s];if(console.log("=== ALL PRODUCTS DEBUG ==="),console.log("mainProduct (kh√¥ng t√≠nh v√†o bundle):",r),console.log("bundleState.selectedProducts.bundle:",p.selectedProducts.bundle),console.log("bundleProductsWithCorrectPrice:",s),console.log("allProducts (ch·ªâ s·∫£n ph·∫©m bundle ƒë∆∞·ª£c ch·ªçn):",d),console.log("allProducts length:",d.length),0===d.length){if(console.warn("‚ö†Ô∏è No bundle products selected, trying to auto-select..."),!(u.bundleProducts&&u.bundleProducts.length>0))return console.error("‚ùå No bundle products available in config!"),void(t.innerHTML='<div class="error-message">Kh√¥ng c√≥ s·∫£n ph·∫©m bundle n√†o ƒë∆∞·ª£c c·∫•u h√¨nh.</div>');{const e=u.bundleProducts[0],t=e.variants&&e.variants.length>0?e.variants[0]:null,o={productId:e.id,productHandle:e.handle,productTitle:e.title,image:v(e.featured_image),variantId:t?t.id:null,variantTitle:t?t.title:"Default Title",variantPrice:t?t.price:e.price,compareAtPrice:t?t.compare_at_price:e.compare_at_price,variantOptions:t?t.options:[],quantity:1};d.push(o),console.log("‚úÖ Added fallback product:",o)}}d.forEach((e,t)=>{console.log(`Product ${t} price debug:`,{title:e.productTitle,price:e.price,priceType:typeof e.price,compareAtPrice:e.compareAtPrice,compareAtPriceType:typeof e.compareAtPrice,quantity:e.quantity,quantityType:typeof e.quantity,variantTitle:e.variantTitle,variantId:e.variantId})});const g=d.filter(e=>{const t=parseFloat(e.price)||0,o=parseFloat(e.compareAtPrice)||0;return t>0||o>0});if(console.log("Products with valid prices:",g.length,"out of",d.length),0===g.length)return console.error("‚ùå No products have valid prices!"),void(t.innerHTML='<div class="error-message">Kh√¥ng th·ªÉ t√≠nh to√°n gi√° v√¨ c√°c s·∫£n ph·∫©m kh√¥ng c√≥ gi√° h·ª£p l·ªá.</div>');console.log("=== BUNDLE STATE PRICE DEBUG ==="),p.selectedProducts.bundle.forEach((e,t)=>{console.log(`Bundle product ${t}:`,{title:e.productTitle,variantTitle:e.variantTitle,variantId:e.variantId,variantPrice:e.variantPrice,price:e.price,variantPriceType:typeof e.variantPrice,priceType:typeof e.price})}),d.forEach((e,t)=>{if(console.log(`Product ${t} (${e.productTitle}):`,{variantTitle:e.variantTitle,variantOptions:e.variantOptions,hasVariantOptions:!!e.variantOptions,variantOptionsLength:e.variantOptions?e.variantOptions.length:0}),e.variantOptions&&e.variantOptions.length>0){const o=e.variantOptions.map((e,t)=>`${0===t?"K√≠ch th∆∞·ªõc":1===t?"M√†u s·∫Øc":`T√πy ch·ªçn ${t+1}`}: ${e}`).join(", ");console.log(`  Generated HTML for product ${t}:`,o)}else console.log(`  Fallback HTML for product ${t}: Variant: ${e.variantTitle}`)}),console.log("=== CALCULATING BUNDLE TOTALS (NEW LOGIC) ===");const m=p.bundleQuantity||1;console.log("Bundle quantity:",m);const h=u.targetDiscountPercentage||15;console.log("Target discount percentage:",h+"%");let f=0,y=0;d.forEach((e,t)=>{const o=parseFloat(e.compareAtPrice)||parseFloat(e.price)||0,n=parseFloat(e.price)||0,i=parseInt(e.quantity)||1;console.log(`Product ${t} calculation:`,{title:e.productTitle,compareAtPrice:e.compareAtPrice,parsedCompareAtPrice:o,price:e.price,parsedPrice:n,quantity:i,compareAtPriceTotal:o*i,priceTotal:n*i}),f+=o*i,y+=n*i}),console.log("=== PRICE CALCULATION TOTALS ==="),console.log("newTotalOriginal:",f),console.log("totalAfter1stDiscount:",y);const w=f*(1-h/100),S=y>0?(y-w)/y*100:0,P=Math.round(S);f*=m,a=f,c=y*(1-P/100)*m;console.log("--- BUNDLE PRICING DEBUG (STEP 3) ---"),console.log("Target Discount:",h+"%"),console.log("T·ªïng Compare-at Price (Original):",a),console.log("T·ªïng sau gi·∫£m gi√° t·∫ßng 1 (Sum of Prices):",y*m),console.log("Ideal Target Price:",w*m),console.log("Needed Voucher Discount % (Rounded):",P),console.log("Actual Final Price (sau chi·∫øt kh·∫•u t·∫ßng 2):",c),t.innerHTML=d.map((e,t)=>{const o=e.quantity||1,n=o>1;return`\n          <div class="bundle-summary-product">\n            <div class="bundle-product-number">${t+1}.</div>\n            <div class="bundle-product-content">\n              <div class="bundle-product-info">\n                <div class="bundle-product-title">\n                  ${e.productTitle}\n                  ${n?`<span style="color: #234085; font-weight: 600;"> √ó ${o}</span>`:""}\n                </div>\n                <div class="bundle-product-attributes">\n                  ${n?`<div class="bundle-product-attribute">S·ªë l∆∞·ª£ng: ${o}</div>`:""}\n                  ${e.variantOptions&&e.variantOptions.length>0?e.variantOptions.map((e,t)=>`<div class="bundle-product-attribute">${0===t?"K√≠ch th∆∞·ªõc":1===t?"M√†u s·∫Øc":`T√πy ch·ªçn ${t+1}`}: ${e}</div>`).join(""):`<div class="bundle-product-attribute">Variant: ${e.variantTitle}</div>`}\n                </div>\n                <div class="bundle-product-change-link" data-product-index="${t}">Thay ƒë·ªïi</div>\n              </div>\n              <div class="bundle-product-image">\n                <img src="${e.image}" alt="${e.productTitle}" width="80" height="80">\n              </div>\n            </div>\n          </div>\n        `}).join(""),console.log("=== BUNDLE PRICE SUMMARY ==="),console.log("Total Original (compare_at_price):",a),console.log("Total Final (sau 2 t·∫ßng gi·∫£m):",c),console.log("Display discount percentage:",h+"%");const x=a-c;console.log("Discount amount:",x);const C=l.querySelector(".bundle-original-total"),T=l.querySelector(".bundle-discount-badge"),k=l.querySelector(".bundle-final-total");if(console.log("Price elements found:",{originalTotal:!!C,discountBadge:!!T,finalTotal:!!k}),C){const e=window.BundleUtils&&window.BundleUtils.formatMoney?window.BundleUtils.formatMoney(a):`${Math.round(a).toLocaleString("vi-VN")}ƒë`;C.textContent=e,console.log("‚úÖ Updated original total (compare_at_price):",e,"from value:",a)}else console.log("‚ùå Original total element not found");if(T?(T.textContent=`-${h}%`,console.log("‚úÖ Updated discount badge to target discount:",`-${h}%`)):console.log("‚ùå Discount badge element not found"),k){const e=window.BundleUtils&&window.BundleUtils.formatMoney?window.BundleUtils.formatMoney(c):`${Math.round(c).toLocaleString("vi-VN")}ƒë`;k.textContent=e,console.log("‚úÖ Updated final total (price):",e,"from value:",c)}else console.log("‚ùå Final total element not found");initializeBundleThumbnailEvents(),function(){console.log("=== INITIALIZING BUY NOW BUTTON ===");const e=l.querySelector(".bundle-buy-now-btn")||l.querySelector(".btn--primary.bundle-buy-now-btn")||l.querySelector("button.bundle-buy-now-btn");console.log("Buy now button found:",!!e),console.log("Buy now button element:",e),e?(e.removeEventListener("click",b),e.addEventListener("click",b),console.log("‚úÖ Buy now button event listener added"),e.onclick=b,console.log("‚úÖ Buy now button onclick attribute added")):console.log("‚ùå Buy now button not found")}()}function b(e){console.log("=== BUY NOW BUTTON CLICKED ==="),e.preventDefault(),e.stopPropagation(),console.log("Event:",e),console.log("Target:",e.target),buyBundleNow()}function y(){console.log("=== ADD BUNDLE TO CART ==="),console.log("Bundle state:",p),console.log("Selected products:",p.selectedProducts);const e=[],t=p.bundleQuantity||1,n=Date.now(),i=u.voucherCode;if(console.log("Bundle quantity:",t),console.log("Bundle ID:",n),p.selectedProducts.bundle.forEach((l,a)=>{if(console.log(`Processing bundle product ${a}:`,l),l.variantId){let a={_bundle_id:n,_bundle_title:o,_product_title:l.productTitle,_variant_title:l.variantTitle||"Default"};i&&""!==i.trim()&&(a._bundle_voucher=i.trim());const c={id:l.variantId,quantity:(l.quantity||1)*t,properties:a};e.push(c),console.log("‚úÖ Added item to cart array:",c)}else console.log("‚ùå Product missing variantId:",l)}),console.log("Total items to add:",e.length),console.log("Items array:",e),0===e.length)return console.error("‚ùå No items to add to cart!"),void alert("Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ th√™m v√†o gi·ªè h√†ng!");console.log("Sending request to /cart/add.js..."),fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({items:e})}).then(e=>(console.log("Response status:",e.status),console.log("Response ok:",e.ok),e.ok?e.json():e.text().then(t=>{throw console.error("Response error text:",t),new Error(`HTTP error! status: ${e.status}, details: ${t}`)}))).then(e=>{if(console.log("Cart API response:",e),e.status&&200!==e.status)throw new Error(`Cart API error: ${e.description||"Unknown error"}`);console.log("‚úÖ Successfully added to cart!"),i&&""!==i.trim()?(console.log("Auto-applying voucher code:",i),function(e){console.log("=== AUTO APPLY VOUCHER CODE ==="),console.log("Voucher code:",e),fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({discount:e})}).then(e=>e.json()).then(t=>{if(console.log("Voucher application response:",t),!t.status&&e){const o=t.items.filter(e=>e.properties&&e.properties._bundle_id);if(o.length>0){const t=o.map(t=>{const o={...t.properties,_bundle_voucher:e,_voucher_applied:"true"};return fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({id:t.key,properties:o})})});Promise.all(t).then(e=>{console.log("‚úÖ Voucher stored in bundle items"),setTimeout(()=>w(),500)}).catch(e=>{console.error("‚ùå Error storing voucher in items:",e),setTimeout(()=>w(),500)})}}else console.log("‚ùå Auto voucher application failed:",t.description),setTimeout(()=>w(),500)}).catch(e=>{console.error("‚ùå Error auto-applying voucher:",e),setTimeout(()=>w(),500)})}(i.trim())):console.log("‚ùå Voucher code not found or empty:",i),"function"==typeof updateCartCount&&updateCartCount(),w()}).catch(e=>{console.error("‚ùå Error adding to cart:",e),console.error("Error details:",{message:e.message,stack:e.stack}),alert(`L·ªói khi th√™m v√†o gi·ªè h√†ng: ${e.message}`)})}function w(){if(console.log("=== REFRESH CART DRAWER ==="),"undefined"!=typeof theme&&"function"==typeof theme.CartForm){new theme.CartForm(document.getElementById("CartDrawerForm")).buildCart(),setTimeout(()=>{console.log("Triggering bundle headers display...");const e=new CustomEvent("cart:updated");document.dispatchEvent(e),"function"==typeof checkStoredBundleVoucher&&checkStoredBundleVoucher()},500)}else window.location.href=window.location.href;!function(){if("undefined"!=typeof theme&&theme.Drawer&&"function"==typeof theme.Drawer.open)return void theme.Drawer.open("CartDrawer");const e=document.getElementById("CartDrawer");if(e)return e.classList.add("drawer--open","active","is-open"),document.body.classList.add("drawer-open","cart-open"),document.dispatchEvent(new CustomEvent("cart:open")),void window.dispatchEvent(new CustomEvent("drawer:open",{detail:{id:"CartDrawer"}}));const t=document.querySelector('[data-cart-drawer-toggle], .js-drawer-open-cart, .cart-icon, [href="#CartDrawer"]');if(t)return void t.click();const o=document.querySelector('button[aria-controls="CartDrawer"], [data-drawer-target="CartDrawer"]');o&&o.click()}()}function S(e){console.log("=== INITIALIZE BUNDLE PRODUCT VARIANT PICKER ===");const t=u.bundleProducts[p.currentProductIndex];if(!t)return void console.error("No current product found");console.log("Initializing variant picker for product:",t.title),console.log("Product options:",t.options),console.log("Product variants:",t.variants),t.variants&&t.variants.length>0&&(console.log("First variant structure:",t.variants[0]),console.log("Variant options:",t.variants[0].options),t.variants.forEach((e,t)=>{console.log(`Variant ${t}:`,{id:e.id,title:e.title,price:e.price,options:e.options,available:e.available})}));if(!e.querySelector(`#ProductSelect-bundle-${t.id}`))return void console.error("ProductSelect not found");const o=new theme.Variants({container:e,variants:t.variants,singleOptionSelector:"[data-variant-input]",originalSelectorId:`#ProductSelect-bundle-${t.id}`,originalSelectorIdSticky:`#ProductSelect-bundle-${t.id}-sticky`,enableHistoryState:!1,dynamicVariantsEnabled:!0});function n(){const o=t.variants,n="[data-variant-input]",i=e.querySelector(".product-form__controls");if(!i)return;const l=(()=>{const e=[];return i.querySelectorAll(`${n}:checked`).forEach(t=>{e.push({value:t.value,index:t.dataset.index})}),e})(),a=i.querySelectorAll(n);[...new Set(Array.from(a,e=>e.dataset.index))].forEach(e=>{const t=l.filter(t=>t.index!==e),a=o.filter(e=>t.every(t=>e[t.index]===t.value)),c=[...new Set(a.filter(e=>e.available).map(t=>t[e]))];i.querySelectorAll(`${n}[data-index="${e}"]`).forEach(e=>{const t=e.closest(".variant-input"),o=t?t.querySelector("label"):null;c.includes(e.value)?(e.disabled=!1,t&&t.classList.remove("disabled"),o&&o.classList.remove("disabled")):(e.disabled=!0,t&&t.classList.add("disabled"),o&&o.classList.add("disabled"))})})}e.variantsInstance=o,e.addEventListener("variantChange",e=>{const{variant:o}=e.detail;if(o){p.selectedProducts.bundle[p.currentProductIndex].variantId=o.id,p.selectedProducts.bundle[p.currentProductIndex].variantOptions=o.options;const e=t.options.findIndex(e=>"size"===e.name.toLowerCase()||"k√≠ch th∆∞·ªõc"===e.name.toLowerCase());if(-1!==e){const t=o[`option${e+1}`];p.lockedSize!==t&&(p.lockedSize=t)}}n(),updateSummary()}),setTimeout(()=>{console.log("=== AUTO-SELECTING FIRST VARIANT ===");const o=e.querySelectorAll(".variant-wrapper");console.log("Found option groups:",o.length),o.forEach((e,t)=>{if((e.classList.contains("size")||e.querySelector(".variant__label")?.textContent.toLowerCase().includes("k√≠ch th∆∞·ªõc")||e.querySelector(".variant__label")?.textContent.toLowerCase().includes("size"))&&p.lockedSize&&p.currentProductIndex>0){console.log(`üîí Auto-selecting locked size: ${p.lockedSize} for product ${p.currentProductIndex+1}`);const t=e.querySelectorAll("[data-variant-input]"),o=Array.from(t).find(e=>{const t=e.value;if(t===p.lockedSize)return!0;const o=e=>{const t=e.match(/(\d+)\s*x\s*(\d+)/i);return t?{width:parseInt(t[1]),height:parseInt(t[2])}:null},n=o(p.lockedSize),i=o(t);if(n&&i)return n.width===i.width&&n.height===i.height;const l=["single","full","queen","king","150","180","200","220","250","300"],a=l.some(e=>p.lockedSize.toLowerCase().includes(e)),c=l.some(e=>t.toLowerCase().includes(e));return!(!a||!c)&&l.some(e=>p.lockedSize.toLowerCase().includes(e)&&t.toLowerCase().includes(e))});if(o&&!o.disabled)console.log(`üîí Found matching size input: ${o.value}`),o.checked=!0,o.dispatchEvent(new Event("change",{bubbles:!0}));else{console.log(`‚ö†Ô∏è Locked size ${p.lockedSize} not found or disabled, falling back to first available`);const t=e.querySelector("[data-variant-input]:not([disabled])");t&&(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})))}}else{const o=e.querySelector("[data-variant-input]");o&&!o.disabled&&(console.log(`Auto-selecting first input in group ${t}:`,o.value),o.checked=!0,o.dispatchEvent(new Event("change",{bubbles:!0})))}}),n(),setTimeout(()=>{console.log("=== FORCE UPDATE VARIANT LABELS AFTER AUTO-SELECTION ===");const o=e.querySelector(`#ProductSelect-bundle-${t.id}`);if(o&&o.value){const n=o.value,i=t.variants.find(e=>e.id.toString()===n.toString());i&&(console.log("Force updating labels for auto-selected variant:",i.title),P(i,e))}},200)},100),e.addEventListener("change",function(t){if(t.target.hasAttribute("data-variant-input")){console.log("=== VARIANT INPUT CHANGED ==="),console.log("Input value:",t.target.value),console.log("Input name:",t.target.name),console.log("Input data-index:",t.target.dataset.index);const o=u.bundleProducts[p.currentProductIndex];if(console.log("Current product at start:",o),!o)return void console.error("‚ùå No current product found for index:",p.currentProductIndex);const n={},i=e.querySelectorAll("[data-variant-input]:checked");console.log("Total checked inputs:",i.length),i.forEach((e,t)=>{console.log(`Checked input ${t}:`,{value:e.value,name:e.name,dataIndex:e.dataset.index,id:e.id});const o=parseInt(e.dataset.index.replace("option",""))-1;n[o]=e.value,console.log("Selected option:",o,"=",e.value)});const l=e.querySelectorAll("[data-variant-input]"),a={};if(l.forEach(e=>{const t=parseInt(e.dataset.index.replace("option",""))-1;a[t]||(a[t]=[]),a[t].push(e)}),Object.keys(a).forEach(e=>{if(!n[e]){const t=a[e],o=t.find(e=>e.checked),i=t.find(e=>!e.disabled),l=o||i;l&&(n[e]=l.value,console.log("‚úÖ Ensured option",e,"=",l.value))}}),console.log("Selected options:",n),"option1"===t.target.dataset.index){console.log("üîÑ Option1 changed, updating option2 availability...");const t=n[0];if(t){const n=o.variants.filter(e=>e.options&&e.options[0]===t),i=[...new Set(n.filter(e=>e.available).map(e=>e.options[1]).filter(e=>e))];console.log("Available option2 values for",t,":",i);e.querySelectorAll('[data-variant-input][data-index="option2"]').forEach(e=>{const t=e.closest(".variant-input"),o=t?t.querySelector("label"):null;i.includes(e.value)?(e.disabled=!1,t&&t.classList.remove("disabled"),o&&o.classList.remove("disabled"),console.log("  ‚úÖ Enabled option2:",e.value)):(e.disabled=!0,t&&t.classList.add("disabled"),o&&o.classList.add("disabled"),console.log("  ‚ùå Disabled option2:",e.value))})}}if("option2"===t.target.dataset.index){console.log("üîÑ Option2 changed, updating option1 availability...");const t=n[1];if(t){const n=o.variants.filter(e=>e.options&&e.options[1]===t),i=[...new Set(n.filter(e=>e.available).map(e=>e.options[0]).filter(e=>e))];console.log("Available option1 values for",t,":",i);e.querySelectorAll('[data-variant-input][data-index="option1"]').forEach(e=>{const t=e.closest(".variant-input"),o=t?t.querySelector("label"):null;i.includes(e.value)?(e.disabled=!1,t&&t.classList.remove("disabled"),o&&o.classList.remove("disabled"),console.log("  ‚úÖ Enabled option1:",e.value)):(e.disabled=!0,t&&t.classList.add("disabled"),o&&o.classList.add("disabled"),console.log("  ‚ùå Disabled option1:",e.value))})}}console.log("=== VARIANT MATCHING DEBUG ==="),console.log("Current product variants count:",o.variants.length),console.log("Selected options to match:",n),console.log("Selected options keys:",Object.keys(n));const c=o.variants.find(e=>{if(console.log(`\n--- Checking variant: ${e.title} ---`),console.log("Variant options:",e.options),!e.options)return console.log("‚ùå Variant has no options array"),!1;const t=e.options.every((e,t)=>{const o=n[t],i=e===o;return console.log(`  Option ${t}: variant="${e}" vs selected="${o}" = ${i}`),i});return console.log(`Result for ${e.title}:`,{variantOptions:e.options,selectedOptions:n,matches:t}),t});console.log("=== IMMEDIATE VARIANT LABEL UPDATE ==="),c?(console.log("Found matching variant, updating labels immediately:",c.title),P(c,e)):console.log("No matching variant found yet, will update later"),console.log("Matching variant:",c);let r=c;if(r||(console.log("‚ùå No matching variant found, using fallback..."),console.log("Available variants:",o.variants.map(e=>({title:e.title,options:e.options}))),n[0]&&(r=o.variants.find(e=>e.options&&e.options[0]===n[0]),console.log("Fallback variant found by size:",r?r.title:"none")),r||(r=o.variants.find(e=>!1!==e.available)||o.variants[0],console.log("Using first available variant as final fallback:",r?r.title:"none"))),r){console.log("‚úÖ Using variant:",r.title),console.log("Variant price:",r.price);const t=e.querySelector(`#ProductSelect-bundle-${o.id}`);t&&(t.value=r.id,t.dispatchEvent(new Event("change")),console.log("‚úÖ Updated product select to variant ID:",r.id));const n=e.querySelector(".price-container-wrapper");if(console.log("Price container found:",!!n),n){const e=n.querySelector("[data-product-price]");console.log("Main price element found:",!!e)}if(console.log("=== UPDATING UI ==="),console.log("Calling updateBundleProductPrice..."),x(r,e),console.log("Calling updateBundleVariantLabels..."),P(r,e),console.log("UI update completed"),e.dispatchEvent(new CustomEvent("variantChange",{detail:{variant:r}})),console.log("=== BUNDLE STATE UPDATE DEBUG ==="),console.log("currentProductIndex:",p.currentProductIndex),console.log("currentProduct:",o),console.log("variantToUse:",r),o){let t=o.featured_image;if(r.featured_image)t=r.featured_image;else if(o.media&&o.media.length>0){const e=o.media.find(e=>{const t=(e.alt||"").toLowerCase(),o=(e.title||"").toLowerCase(),n=r.title.toLowerCase();return t.includes(n)||o.includes(n)||r.options&&r.options.some(e=>{const n=e.toLowerCase();return t.includes(n)||o.includes(n)})});e&&(t=e.src)}const n=p.selectedProducts.bundle.findIndex(e=>e.productId===o.id);if(n>=0){if(p.selectedProducts.bundle[n].variantTitle=r.title,p.selectedProducts.bundle[n].variantId=r.id,p.selectedProducts.bundle[n].variantPrice=r.price,p.selectedProducts.bundle[n].compareAtPrice=r.compare_at_price,p.selectedProducts.bundle[n].variantOptions=r.options,p.selectedProducts.bundle[n].image=v(t),console.log("‚úÖ Updated bundle state immediately for product:",o.title,"variant:",r.title,"image:",t),console.log("‚úÖ Bundle state updated:",p.selectedProducts.bundle[n]),console.log("‚úÖ Variant options saved:",r.options),console.log("‚úÖ Variant options type:",typeof r.options),console.log("‚úÖ Variant options is array:",Array.isArray(r.options)),console.log("‚úÖ Variant options length:",r.options?r.options.length:"undefined"),0===p.currentProductIndex&&r.options&&r.options.length>0){const e=r.options[0];e&&(e.toLowerCase().includes("single")||e.toLowerCase().includes("full")||e.toLowerCase().includes("queen")||e.toLowerCase().includes("king")||e.toLowerCase().includes("150")||e.toLowerCase().includes("180")||e.toLowerCase().includes("200")||e.toLowerCase().includes("220")||e.toLowerCase().includes("250")||e.toLowerCase().includes("300")||e.toLowerCase().includes("cm"))&&(console.log("üéØ First product size selected:",e),console.log("üîí Locking size for all other products to:",e),p.lockedSize=e,p.selectedProducts.bundle.forEach((t,o)=>{if(o>0){const o=u.bundleProducts.find(e=>e.id===t.productId);if(o&&o.variants){const n=o.variants.find(t=>{if(!t.options||0===t.options.length)return!1;const o=t.options[0];if(o===e)return!0;const n=e=>{const t=e.match(/(\d+)\s*x\s*(\d+)/i);return t?{width:parseInt(t[1]),height:parseInt(t[2])}:null},i=n(e),l=n(o);if(i&&l)return i.width===l.width&&i.height===l.height;const a=["single","full","queen","king","150","180","200","220","250","300"],c=a.some(t=>e.toLowerCase().includes(t)),r=a.some(e=>o.toLowerCase().includes(e));return!(!c||!r)&&a.some(t=>e.toLowerCase().includes(t)&&o.toLowerCase().includes(t))});n&&(console.log(`üîí Auto-updating product ${p.currentProductIndex+1} (${t.productTitle}) to size: ${e}`),t.variantId=n.id,t.variantTitle=n.title,t.variantPrice=n.price,t.compareAtPrice=n.compare_at_price,t.variantOptions=n.options)}}}))}if(p.lockedSize&&p.currentProductIndex>0){e.querySelectorAll(".variant-wrapper.size [data-variant-input]").forEach(e=>{const t=e.value;(()=>{if(t===p.lockedSize)return!0;const e=e=>{const t=e.match(/(\d+)\s*x\s*(\d+)/i);return t?{width:parseInt(t[1]),height:parseInt(t[2])}:null},o=e(p.lockedSize),n=e(t);if(o&&n)return o.width===n.width&&o.height===n.height;const i=["single","full","queen","king","150","180","200","220","250","300"],l=i.some(e=>p.lockedSize.toLowerCase().includes(e)),a=i.some(e=>t.toLowerCase().includes(e));return!(!l||!a)&&i.some(e=>p.lockedSize.toLowerCase().includes(e)&&t.toLowerCase().includes(e))})()?(e.disabled=!1,e.closest(".variant__button-label")?.classList.remove("disabled"),console.log(`üîí Enabled matching size option: ${e.value}`)):(e.disabled=!0,e.closest(".variant__button-label")?.classList.add("disabled"),console.log(`üîí Disabled size option: ${e.value}`))})}}else{const e=2===p.currentProductIndex?u.product3Quantity||2:1,n={productId:o.id,productHandle:o.handle,productTitle:o.title,image:t,variantId:r.id,variantTitle:r.title,variantPrice:r.price,compareAtPrice:r.compare_at_price,variantOptions:r.options,quantity:e};p.selectedProducts.bundle.push(n),console.log("‚úÖ Added new product to bundle state:",n),console.log("‚úÖ Variant options saved:",r.options),console.log("‚úÖ Variant options type:",typeof r.options),console.log("‚úÖ Variant options is array:",Array.isArray(r.options)),console.log("‚úÖ Variant options length:",r.options?r.options.length:"undefined")}}}else console.log("‚ùå No matching variant found for options:",n),console.log("Available variants:",o.variants.map(e=>({title:e.title,options:e.options})))}}),e.addEventListener("variantChange",function(t){console.log("Variant change event:",t.detail);const o=t.detail.variant;o&&(x(o,e),P(o,e))}),console.log("‚úÖ Variant picker initialized successfully")}function P(e,t){if(console.log("=== UPDATE VARIANT LABELS ==="),console.log("Function called with variant:",e),console.log("Updating variant labels for variant:",e.title),console.log("Variant options:",e.options),!e||!e.options||!t)return void console.warn("‚ùå Missing variant, options, or container");const o=t.querySelectorAll(".variant__label-info");console.log("Found variant__label-info elements:",o.length),o.forEach((t,o)=>{const n=t.getAttribute("data-index");if(console.log(`Label ${o}: data-index = ${n}`),null!==n){const i=parseInt(n);if(console.log(`Label ${o}: optionIndex = ${i}`),!isNaN(i)&&e.options&&e.options[i]){const n=e.options[i];console.log(`Updating label ${o} to: ${n}`);const l=t.querySelector("span[data-variant-selected-label]");l?(l.textContent=n,console.log("‚úÖ Updated inner span to:",n)):(t.textContent=n,console.log("‚úÖ Updated container text to:",n))}}else{console.log(`Label ${o} has no data-index, trying position-based update`);const n=t.closest(".variant__label");if(n){const o=n.textContent.toLowerCase();if(console.log(`Parent label text: ${o}`),o.includes("k√≠ch th∆∞·ªõc")||o.includes("size")){if(e.options&&e.options[0]){const o=t.querySelector("span[data-variant-selected-label]");o?o.textContent=e.options[0]:t.textContent=e.options[0],console.log("‚úÖ Updated size label to:",e.options[0])}}else if(o.includes("m√†u")||o.includes("color")||o.includes("m√†u s·∫Øc")){if(e.options&&e.options[1]){const o=t.querySelector("span[data-variant-selected-label]");o?o.textContent=e.options[1]:t.textContent=e.options[1],console.log("‚úÖ Updated color label to:",e.options[1])}}else if((o.includes("comfort")||o.includes("ƒë·ªô c·ª©ng"))&&e.options&&e.options[2]){const o=t.querySelector("span[data-variant-selected-label]");o?o.textContent=e.options[2]:t.textContent=e.options[2],console.log("‚úÖ Updated comfort label to:",e.options[2])}}}});const n=t.querySelectorAll("span[data-variant-selected-label]");console.log("Found data-variant-selected-label spans:",n.length),n.forEach((t,o)=>{const n=t.closest(".variant__label-info");if(n){const i=n.getAttribute("data-index");if(null!==i){const n=parseInt(i);!isNaN(n)&&e.options&&e.options[n]&&(t.textContent=e.options[n],console.log(`‚úÖ Updated selected label span ${o} to:`,e.options[n]))}}}),T(e,t),console.log("‚úÖ Variant labels update completed")}function x(e,t){console.log("=== UPDATE PRODUCT PRICE ==="),console.log("Updating product price for variant:",e.title),console.log("Variant price:",e.price,"Compare price:",e.compare_at_price);const o=t.querySelector(".price-container-wrapper");if(console.log("Price container found:",!!o),o){const t=o.querySelector("[data-product-price]");if(console.log("Main price element found:",!!t),console.log("Main price element before update:",t?t.textContent:"not found"),t){const o=BundleUtils.formatMoney(e.price);t.textContent=o,console.log("‚úÖ Updated main price from",t.getAttribute("data-product-price-base"),"to:",o),console.log("‚úÖ Main price element after update:",t.textContent)}const n=o.querySelector("[data-compare-price]");if(console.log("Compare price element found:",!!n),console.log("Compare price element before update:",n?n.textContent:"not found"),n)if(e.compare_at_price&&e.compare_at_price>e.price){const t=BundleUtils.formatMoney(e.compare_at_price);n.textContent=t,n.style.display="inline",console.log("‚úÖ Updated compare price to:",t),console.log("‚úÖ Compare price element after update:",n.textContent)}else n.style.display="none",console.log("‚úÖ Hiding compare price (no discount)");const i=o.querySelector(".product__discount-badge");if(console.log("Discount badge found:",!!i),console.log("Discount badge before update:",i?i.textContent:"not found"),i)if(e.compare_at_price&&e.compare_at_price>e.price){const t=Math.round((e.compare_at_price-e.price)/e.compare_at_price*100);t>0?(i.textContent=`-${t}%`,i.style.display="inline",console.log("‚úÖ Updated discount badge to:",`-${t}%`),console.log("‚úÖ Discount badge after update:",i.textContent)):(i.style.display="none",console.log("‚úÖ Hiding discount badge (0% discount)"))}else i.style.display="none",console.log("‚úÖ Hiding discount badge (no discount)")}const n=t.querySelector("[data-installment-price]");if(n){const t=Math.round(e.price/12);n.textContent=BundleUtils.formatMoney(t),console.log("‚úÖ Updated installment price to:",BundleUtils.formatMoney(t))}console.log("‚úÖ Price update completed"),C(e,t)}function C(t,o){if(console.log("=== UPDATE BUNDLE PRODUCT IMAGE ==="),console.log("Updating product image for variant:",t.title),console.log("Variant featured_image:",t.featured_image),!t||!o)return void console.warn("‚ùå Missing variant or container");const n=document.getElementById(`Step2ImageColumn-${e}`)||o;console.log("üîç Image container:",n),console.log("üîç Container class:",n?n.className:"N/A");const i=n.querySelectorAll(".product-featured-img, .product-image-main img, [data-product-image-main] img");console.log("Found main image elements:",i.length);const l=n.querySelectorAll(".product-main-slide");console.log("Found main slide elements:",l.length);let a="";if(t.featured_image)a=v(t.featured_image),console.log("Using variant featured_image:",a);else{const e=u.bundleProducts[p.currentProductIndex];if(e&&e.media&&e.media.length>0){const o=e.media.find(e=>{const o=(e.alt||"").toLowerCase(),n=(e.title||"").toLowerCase(),i=t.title.toLowerCase();return t.options&&t.options.some(e=>{const t=e.toLowerCase();return o.includes(t)||n.includes(t)})||o.includes(i)||n.includes(i)});o?(a=v(o),console.log("Found variant image from media:",a)):(a=v(e.featured_image),console.log("Using fallback product image:",a))}else{const e=u.bundleProducts[p.currentProductIndex];e&&(a=v(e.featured_image),console.log("Using product featured_image as fallback:",a))}}if(!a)return void console.warn("‚ùå No variant image URL found");console.log("Final variant image URL:",a);if(!(window.innerWidth<=768)){console.log("üíª Desktop mode: Updating main image (static, no carousel)");const e=n.querySelectorAll(".product-main-slide");if(console.log("Found slides:",e.length),e.length>0){e.forEach(e=>{e.style.display="none",e.classList.remove("starting-slide","is-selected"),e.classList.add("secondary-slide")});let t=-1;e.forEach((e,o)=>{const n=e.querySelector("img");if(n&&n.src){const e=e=>{if(!e)return"";const t=e.split("/");return t[t.length-1].split("?")[0].toLowerCase()};e(n.src)===e(a)&&(t=o,console.log(`‚úÖ Found matching slide at index ${o}`))}});const o=t>=0?e[t]:e[0];o.style.display="block",o.classList.add("starting-slide","is-selected"),o.classList.remove("secondary-slide"),console.log("‚úÖ Desktop: Showing slide at index",t>=0?t:0)}return void console.log("‚úÖ Desktop: Product image update completed")}console.log("üì± Mobile mode: Finding matching thumbnail");const c=n.querySelectorAll("[data-product-thumb], .product__thumb");console.log("Found thumbnails:",c.length);let r=-1,s=null;c.forEach((e,t)=>{const o=e.querySelector("img");if(o){const n=e=>{if(!e)return"";const t=e.split("/");return t[t.length-1].split("?")[0].toLowerCase()},i=n(o.src||o.getAttribute("data-src")||""),l=n(a);console.log(`üîç Thumbnail ${t}: "${i}" vs "${l}"`),i&&l&&i===l&&(r=t,s=e,console.log(`‚úÖ Found matching thumbnail at index ${t}`))}});const d=n.querySelector(".product-slideshow, [data-product-photos]");if(d&&window.Flickity){const e=Flickity.data(d);e&&(console.log("üîÑ Mobile: Syncing Flickity with variant image"),r>=0?(e.select(r,!1,!0),console.log(`‚úÖ Mobile: Flickity navigated to slide ${r}`)):(console.log("‚ö†Ô∏è Mobile: No matching thumbnail, keeping current slide"),e.resize(),e.reposition()))}if(s){c.forEach(e=>e.classList.remove("active","active-thumb")),s.classList.add("active","active-thumb"),console.log("‚úÖ Mobile: Activated matching thumbnail");n.querySelector(".product__thumbs--scroller")&&(s.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"}),console.log("‚úÖ Mobile: Scrolled thumbnail into view"))}else console.log("‚ö†Ô∏è Mobile: No matching thumbnail found");console.log("‚úÖ Product image update completed")}function T(e,t){console.log("=== UPDATE COLOR SWATCH STATE ==="),console.log("Updating color swatch state for variant:",e.title);if(t.querySelectorAll(".color-swatch").forEach(e=>{e.classList.remove("active","selected")}),e.options&&e.options[1]){let o=t.querySelector(`.color-swatch[for*="${e.options[1].replace(/\s+/g,"-")}"]`);if(!o){const n=t.querySelector(`[data-variant-input][data-color-name="${e.options[1]}"]`);n&&(o=t.querySelector(`label[for="${n.id}"]`))}o?(o.classList.add("active","selected"),console.log("‚úÖ Updated color swatch state for:",e.options[1])):(console.log("‚ùå Could not find color swatch for:",e.options[1]),console.log("Available color swatches:",t.querySelectorAll(".color-swatch").length),console.log("Available color inputs:",t.querySelectorAll("[data-variant-input][data-color-name]").length))}t.querySelectorAll("[data-variant-input][data-color-name]").forEach(t=>{t.value===e.options[1]?(t.checked=!0,console.log("‚úÖ Updated color input state for:",e.options[1])):t.checked=!1})}function k(e){console.log("=== REAPPLY VOUCHER ==="),console.log("Re-applying voucher:",e),fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({discount:e})}).then(e=>e.json()).then(t=>{if(console.log("Re-apply voucher response:",t),t.status){if(console.log("‚ùå Failed to re-apply voucher:",t.description),window.location.pathname.includes("/checkout")){console.log("Attempting alternative approach with URL parameter");const t=new URL(window.location.href);t.searchParams.set("discount",e),window.location.href=t.toString()}}else{console.log("‚úÖ Voucher re-applied successfully");const o=t.items.filter(e=>e.properties&&e.properties._bundle_id);if(o.length>0){const t=o.map(t=>{const o={...t.properties,_bundle_voucher:e,_voucher_applied:"true"};return fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({id:t.key,properties:o})})});Promise.all(t).then(e=>{console.log("‚úÖ Voucher stored in bundle items after re-apply"),window.location.pathname.includes("/checkout")&&(console.log("Reloading checkout page to show updated prices"),setTimeout(()=>window.location.reload(),500))}).catch(e=>{console.error("‚ùå Error storing voucher in items:",e),window.location.pathname.includes("/checkout")&&setTimeout(()=>window.location.reload(),500)})}else window.location.pathname.includes("/checkout")&&setTimeout(()=>window.location.reload(),500)}}).catch(t=>{if(console.error("‚ùå Error re-applying voucher:",t),window.location.pathname.includes("/checkout")){console.log("Fallback: redirecting with voucher in URL");const t=new URL(window.location.href);t.searchParams.set("discount",e),window.location.href=t.toString()}})}return l.addEventListener("click",function(e){if(e.target.closest(".bundle-add-to-cart-btn"))e.preventDefault(),y();else if(e.target.closest(".bundle-cta-btn")||e.target.closest("[data-bundle-cta]")){e.preventDefault();const t=!0===u.hasBundleProducts||"true"===u.hasBundleProducts,o=(Array.isArray(u.bundleProducts)?u.bundleProducts:[]).length>0,n=u.debug&&!0===u.debug.hasBundleProducts,i=u.debug&&u.debug.firstProduct&&""!==u.debug.firstProduct;t&&o||n&&i?(m(2),h(0)):alert('Ch∆∞a c√≥ s·∫£n ph·∫©m bundle ƒë∆∞·ª£c c·∫•u h√¨nh!\n\nƒê·ªÉ th√™m s·∫£n ph·∫©m v√†o bundle:\n1. V√†o Theme Editor\n2. Ch·ªçn section "Product Bundle"\n3. Trong settings, t√¨m "Bundle Products"\n4. Click "Change" v√† ch·ªçn c√°c s·∫£n ph·∫©m mu·ªën th√™m v√†o bundle')}if(e.target.closest(".quantity-display")){e.preventDefault();e.target.closest(".quantity-dropdown").classList.toggle("active")}if(e.target.closest(".quantity-option")){e.preventDefault();const t=e.target.closest(".quantity-option"),o=parseInt(t.getAttribute("data-value")),n=t.closest(".quantity-dropdown"),i=n.querySelector(".quantity-text");i&&(i.textContent=o),n.querySelector(".quantity-display").setAttribute("data-quantity",o),n.querySelectorAll(".quantity-option").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),n.classList.remove("active"),p.bundleQuantity=o,3===p.currentStep&&f()}e.target.closest(".quantity-dropdown")||l.querySelectorAll(".quantity-dropdown").forEach(e=>{e.classList.remove("active")});e.target.closest(".bundle-back-btn")&&(e.preventDefault(),2===p.currentStep?p.currentProductIndex>0?(p.currentProductIndex--,h(p.currentProductIndex)):m(1):p.currentStep>1&&m(p.currentStep-1));if(e.target.closest(".bundle-continue-btn")&&(e.preventDefault(),2===p.currentStep)){console.log("=== CONTINUE BUTTON CLICKED ===");const e=u.bundleProducts[p.currentProductIndex];if(e){console.log("Saving current product selection:",e.title);const t=l.querySelector(`#ProductSelect-bundle-${e.id}`);if(t&&t.value){const o=t.value,n=e.variants.find(e=>e.id.toString()===o.toString());if(console.log("Selected variant ID:",o),console.log("Selected variant:",n),n){let t=v(e.featured_image);n.featured_image&&(t=v(n.featured_image));const o=p.selectedProducts.bundle.findIndex(t=>t.productId===e.id),i=2===p.currentProductIndex?u.product3Quantity||2:1,l={productId:e.id,productHandle:e.handle,productTitle:e.title,image:t,variantId:n.id,variantTitle:n.title,variantPrice:n.price,compareAtPrice:n.compare_at_price,variantOptions:n.options,quantity:i};o>=0?(p.selectedProducts.bundle[o]=l,console.log("‚úÖ Updated existing product in bundle state")):(p.selectedProducts.bundle.push(l),console.log("‚úÖ Added new product to bundle state")),console.log("Current bundle state:",p.selectedProducts.bundle)}}}p.currentProductIndex<u.bundleProducts.length-1?(p.currentProductIndex++,h(p.currentProductIndex)):(console.log("All products selected, moving to step 3"),console.log("Final bundle state:",p.selectedProducts.bundle),m(3),f())}e.target.closest(".bundle-buy-now-btn")&&(e.preventDefault(),buyBundleNow());if(e.target.closest(".bundle-product-change-link")){e.preventDefault();const t=e.target.closest(".bundle-product-change-link"),o=parseInt(t.getAttribute("data-product-index"));console.log("Change product clicked for index:",o),function(e){if(console.log("Changing product at index:",e),0===e)return void m(1);const t=e-1;if(t>=0&&t<p.selectedProducts.bundle.length)p.currentProductIndex=t,m(2)}(o)}}),document.querySelector(".bundle-pricing-calculator")&&setTimeout(()=>{!function(){const e=document.getElementById("calculator-results");if(!e)return;if(console.log("=== RUNNING PRICING CALCULATOR ==="),!u.bundleProducts||0===u.bundleProducts.length)return void(e.innerHTML='\n          <p style="margin: 8px 0; color: #E53E3E; font-size: 14px;">\n            ‚ö†Ô∏è <strong>Ch∆∞a c√≥ bundle products!</strong> Vui l√≤ng add products v√†o bundle tr∆∞·ªõc.\n          </p>\n        ');const t=u.targetDiscountPercentage||15;let o=0,n=0;const i=u.bundleProducts.map((e,t)=>{const i=e.variants&&e.variants.length>0?e.variants[0]:null,l=i?i.price:e.price,a=i?i.compare_at_price||i.price:e.compare_at_price||e.price,c=2===t?u.product3Quantity||2:1;o+=l*c,n+=a*c;const r=a>0?Math.round((a-l)/a*100):0;return{title:e.title,price:l,compareAtPrice:a,currentDiscount:r,quantity:c}}),l=n>0?Math.round((n-o)/n*100):0,a=n*(1-t/100),c=o>0?(o-a)/o*100:0,r=Math.round(c),s=o*(1-r/100);e.innerHTML=`\n        <div style="margin-bottom: 16px;">\n          <h4 style="color: #234085; margin: 0 0 12px 0; font-size: 16px;">üìä Ph√¢n t√≠ch Bundle:</h4>\n          ${i.map((e,t)=>`\n            <div style="padding: 8px; background: #F9FAFB; border-radius: 4px; margin-bottom: 8px; font-size: 13px;">\n              <strong>${t+1}. ${e.title}</strong>\n              ${e.quantity>1?`<span style="color: #234085; font-weight: 600;"> √ó ${e.quantity}</span>`:""}<br>\n              <span style="color: #888;">Price: ${BundleUtils.formatMoney(e.price)}${e.quantity>1?` √ó ${e.quantity} = ${BundleUtils.formatMoney(e.price*e.quantity)}`:""}</span><br>\n              <span style="color: #666;">Compare: ${BundleUtils.formatMoney(e.compareAtPrice)}${e.quantity>1?` √ó ${e.quantity} = ${BundleUtils.formatMoney(e.compareAtPrice*e.quantity)}`:""}</span> | \n              <span style="color: ${e.currentDiscount>0?"#16A34A":"#888"};">\n                Gi·∫£m: ${e.currentDiscount}%\n              </span>\n            </div>\n          `).join("")}\n        </div>\n        \n        <div style="background: #F0F9FF; padding: 16px; border-radius: 8px; border-left: 4px solid #234085;">\n          <div style="margin-bottom: 12px;">\n            <div style="font-size: 14px; color: #666; margin-bottom: 4px;">T·ªïng Compare-at Price:</div>\n            <div style="font-size: 20px; font-weight: bold; color: #1C2C58;">${BundleUtils.formatMoney(n)}</div>\n          </div>\n          \n          <div style="margin-bottom: 12px;">\n            <div style="font-size: 14px; color: #666; margin-bottom: 4px;">T·ªïng Price hi·ªán t·∫°i:</div>\n            <div style="font-size: 20px; font-weight: bold; color: #16A34A;">${BundleUtils.formatMoney(o)}</div>\n          </div>\n          \n          <div style="margin-bottom: 12px;">\n            <div style="font-size: 14px; color: #666; margin-bottom: 4px;">% Gi·∫£m hi·ªán t·∫°i:</div>\n            <div style="font-size: 24px; font-weight: bold; color: ${l>=t?"#16A34A":"#F59E0B"};">\n              ${l}%\n            </div>\n          </div>\n          \n          <div style="border-top: 2px dashed #234085; margin: 16px 0; padding-top: 16px;">\n            <div style="font-size: 14px; color: #666; margin-bottom: 4px;">\n              ${r>0?"‚ö†Ô∏è C·∫¶N T·∫†O VOUCHER GI·∫¢M TH√äM:":"‚úÖ ƒê√É ƒê·∫†T M·ª§C TI√äU:"}\n            </div>\n            <div style="font-size: 32px; font-weight: bold; color: ${r>0?"#E53E3E":"#16A34A"};">\n              ${r}%\n            </div>\n            ${r>0?`\n              <div style="margin-top: 12px; padding: 12px; background: #FEF2F2; border-radius: 6px; font-size: 13px;">\n                <strong>üé´ T·∫°o Discount Code trong Shopify Admin:</strong><br>\n                ‚Ä¢ Type: <strong>Percentage</strong><br>\n                ‚Ä¢ Value: <strong>${r}%</strong> (s·ªë nguy√™n)<br>\n                ‚Ä¢ Applies to: <strong>All bundle products</strong><br>\n                ‚Ä¢ Code example: <strong>BUNDLE${r}</strong>\n              </div>\n              <div style="margin-top: 8px; padding: 10px; background: #FFF9E6; border-radius: 6px; font-size: 12px;">\n                <strong>üìê C√¥ng th·ª©c 2 t·∫ßng gi·∫£m:</strong><br>\n                ‚Ä¢ Gi√° g·ªëc: ${BundleUtils.formatMoney(n)}<br>\n                ‚Ä¢ Sau gi·∫£m ${l}%: ${BundleUtils.formatMoney(o)}<br>\n                ‚Ä¢ Sau voucher ${r}%: ${BundleUtils.formatMoney(s)}<br>\n                ‚Ä¢ Target (${t}%): ${BundleUtils.formatMoney(a)}<br>\n                ‚Ä¢ Ch√™nh l·ªách: ${BundleUtils.formatMoney(Math.abs(s-a))}\n              </div>\n            `:""}\n          </div>\n          \n          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #93C5FD;">\n            <div style="font-size: 14px; color: #666; margin-bottom: 4px;">üíµ Gi√° cu·ªëi (sau 2 t·∫ßng gi·∫£m):</div>\n            <div style="font-size: 28px; font-weight: bold; color: #234085;">${BundleUtils.formatMoney(s)}</div>\n            <div style="font-size: 12px; color: #888; margin-top: 4px;">\n              = ${BundleUtils.formatMoney(n)} √ó ${((100-l)/100).toFixed(2)} √ó ${((100-r)/100).toFixed(2)}\n            </div>\n          </div>\n        </div>\n      `,console.log("=== CALCULATOR RESULTS ==="),console.log("Target Discount:",t+"%"),console.log("Total Compare-at Price:",BundleUtils.formatMoney(n)),console.log("Total Current Price:",BundleUtils.formatMoney(o)),console.log("Current Discount %:",l+"%"),console.log("Voucher Needed (exact):",c.toFixed(2)+"%"),console.log("Voucher Needed (rounded):",r+"%"),console.log("Target Final (ideal):",BundleUtils.formatMoney(a)),console.log("Actual Final (sau 2 t·∫ßng):",BundleUtils.formatMoney(s)),console.log("Ch√™nh l·ªách:",BundleUtils.formatMoney(Math.abs(s-a)))}()},500),document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{!function(){if(console.log("=== CHECK AND REAPPLY VOUCHER ==="),console.log("Current URL:",window.location.href),window.location.pathname.includes("/checkout")||window.location.pathname.includes("/cart")){console.log("On checkout/cart page, checking for voucher...");const e=new URLSearchParams(window.location.search).get("discount");if(e&&""!==e.trim())return console.log("Found voucher in URL:",e),void k(e);fetch("/cart.js").then(e=>e.json()).then(e=>{const t=e.cart_level_discount_applications&&e.cart_level_discount_applications.length>0;let o=null;for(const t of e.items)if(t.properties&&t.properties._bundle_voucher){o=t.properties._bundle_voucher;break}o&&!t?(console.log("Re-applying voucher from bundle items:",o),k(o)):o&&t?console.log("Voucher already applied in cart"):console.log("No voucher found in bundle items")}).catch(e=>{console.error("Error checking cart for voucher:",e)})}}()},1e3)}),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("[data-slideshow]").forEach(e=>{const t=e.querySelectorAll(".carousel-item"),o=e.querySelector(".carousel-nav--prev"),n=e.querySelector(".carousel-nav--next");let i=0;if(t.length<=1)return o&&(o.style.display="none"),void(n&&(n.style.display="none"));function l(e){t.forEach((t,o)=>{t.style.display=o===e?"block":"none"}),o&&(o.disabled=0===e),n&&(n.disabled=e===t.length-1)}o&&o.addEventListener("click",function(){i=(i-1+t.length)%t.length,l(i)}),n&&n.addEventListener("click",function(){i=(i+1)%t.length,l(i)}),l(0)})}),document.addEventListener("DOMContentLoaded",function(){console.log("üîß Initializing main product page mobile swipe fix..."),setTimeout(()=>{const e=document.querySelector(".product-slideshow");if(e&&window.Flickity){console.log("üì± Main product slideshow found:",e);const t=Flickity.data(e);if(console.log("üîç Main product Flickity exists:",!!t),t){if(window.innerWidth<=768&&(console.log("üì± Refreshing main product Flickity for mobile..."),t.resize(),t.reposition(),!t.options.draggable)){console.log("‚ö†Ô∏è Main product Flickity draggable disabled, reinitializing..."),t.destroy();new Flickity(e,{cellAlign:"left",contain:!0,prevNextButtons:!1,pageDots:!0,wrapAround:!0,draggable:!0,adaptiveHeight:!0,dragThreshold:5,selectedAttraction:.025,friction:.28,touchVerticalScroll:!0});console.log("‚úÖ Main product Flickity reinitialized with swipe enabled")}}else{console.log("üé† Initializing main product Flickity...");new Flickity(e,{cellAlign:"left",contain:!0,prevNextButtons:!1,pageDots:window.innerWidth<=768,wrapAround:!0,draggable:!0,adaptiveHeight:!0,dragThreshold:5,selectedAttraction:.025,friction:.28,touchVerticalScroll:!0});console.log("‚úÖ Main product Flickity initialized")}}else console.warn("‚ö†Ô∏è Main product slideshow or Flickity not found")},1e3)}),{bundleState:p,config:u,container:l,fetchShopifyProduct:c,renderProductImagesHTML:r,initializeFlickityForStep:s,initializeThumbnailClicks:initializeThumbnailClicks,showStep:m,loadBundleProduct:h,renderBundleSummary:f,addBundleToCart:y,initializeBundleProductVariantPicker:S,updateBundleProductPrice:x,updateBundleVariantLabels:P,updateBundleProductImage:C,updateColorSwatchState:T,extractImageUrl:v}};